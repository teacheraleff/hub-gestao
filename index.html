<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hub SLAP</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749543469/SLAP_FAVICON_AMARELO_coilvj.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Palette: SLAP Brand Colors: #F1D24B (Yellow), #FF5C3D (Orange), #84C7DF (Blue), #8671D1 (Purple) -->
    <style>
        body {
            font-family: 'DM Sans', sans-serif;
            line-height: 1.25;
        }
        .nav-item.active {
            background-color: #FFFBEB; /* yellow-50 */
            color: #F1D24B;
            font-weight: 600;
        }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e7e5e4; padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-header h4 { font-size: 1.25rem; font-weight: 700; color: #44403c; }
        .modal-close-btn { background: none; border: none; cursor: pointer; color: #a8a29e; }
        
        .base-card { background-color: #ffffff; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e7e5e4; transition: all 0.2s; }
        .base-card:hover { border-color: #F1D24B; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .status-tag { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-aprovado, .status-presencial, .status-ativo { background-color: #D1FAE5; color: #065F46; }
        .status-online, .status-em-andamento, .status-inativo { background-color: #DBEAFE; color: #1E40AF; }
        .status-concluída { background-color: #F3F4F6; color: #4B5563; }
        .status-pendente, .status-em-espera { background-color: #FEF3C7; color: #92400E; }
        .status-rejeitado, .status-cancelado { background-color: #FEE2E2; color: #991B1B; }

        .status-financeiro { background-color: #D1FAE5; color: #065F46; }
        .status-pedagógico { background-color: #DBEAFE; color: #1E40AF; }
        .status-comercial { background-color: #FEF3C7; color: #92400E; }
        .status-marketing { background-color: #FEE2E2; color: #991B1B; }
        
        .sector-tag, .keyword-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            margin: 0.25rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1.5px solid #F1D24B;
            color: #44403c;
            background-color: transparent;
        }

        .task-card { background-color: #ffffff; border-radius: 0.75rem; padding: 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e7e5e4; transition: all 0.2s ease; }
        .task-card.completed { background-color: #f9fafb; border-color: #e5e7eb; }
        .task-card.completed p { text-decoration: line-through; color: #9ca3af; }
        .task-card:hover { border-color: #F1D24B; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .user-tag { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .tag-admin { background-color: #E5E7EB; color: #374151; }
        .tag-break { background-color: #374151; color: #FFFFFF; }
        .deadline-text { font-weight: 600; color: #57534e; }
        .deadline-overdue { color: #b91c1c; }
        .task-delete-btn { background: none; border: none; cursor: pointer; color: #9ca3af; transition: color 0.2s; }
        .task-delete-btn:hover { color: #ef4444; }
        
        .page-number-btn { padding: 0.25rem 0.75rem; border: 1px solid #d6d3d1; background-color: #ffffff; color: #44403c; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; }
        .page-number-btn:hover { background-color: #f5f5f4; border-color: #F1D24B; }
        .page-number-btn.active { background-color: #F1D24B; border-color: #F1D24B; color: #44403c; font-weight: 600; }

        .grade-select-container { margin-bottom: 1.5rem; max-width: 400px; }
        .grade-select { width: 100%; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #d6d3d1; background-color: #ffffff; font-weight: 600; color: #44403c; -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; cursor: pointer; }
        .schedule-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
        .day-column { background-color: #f9fafb; border-radius: 0.75rem; padding: 1rem; border: 1px solid #f3f4f6; }
        .day-column-header { font-weight: 700; color: #44403c; font-size: 1.25rem; padding-bottom: 0.75rem; margin-bottom: 0.75rem; border-bottom: 2px solid #F1D24B; }
        .class-entry { background-color: #ffffff; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
        .class-entry:hover { transform: translateY(-2px); box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
        .class-tag { font-size: 0.625rem; font-weight: 700; padding: 2px 8px; border-radius: 9999px; color: white; margin-bottom: 4px; display: inline-block; text-transform: uppercase; }
        .tag-turma { background-color: #FF5C3D; }
        .tag-vip { background-color: #8671D1; }
        
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .data-table th { font-weight: 600; font-size: 0.875rem; color: #6b7280; }
        .data-table tbody tr.paid { background-color: #f9fafb; color: #9ca3af; }
        .data-table tbody tr.paid .font-medium { text-decoration: line-through; }
        .data-table tbody tr:not(.paid):hover { background-color: #f9fafb; cursor: pointer; }
        .data-total { margin-top: 1.5rem; text-align: right; }
        .data-total p { font-size: 1.25rem; font-weight: 700; color: #1f2937; }

        .form-input { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; }
        .form-input:disabled { background-color: #f3f4f6; cursor: not-allowed; }
        .primary-btn { background-color: #F1D24B; color: #44403c; padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.2s; width: 100%; border: none; cursor: pointer; }
        .primary-btn:hover { background-color: #eab308; }
        .secondary-btn { background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s; }
        .secondary-btn:hover { background-color: #e5e7eb; }
        .secondary-btn.active { background-color: #F1D24B; color: #44403c; border-color: #F1D24B;}
        .danger-btn { background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.2s; border: none; cursor: pointer; }
        .danger-btn:hover { background-color: #dc2626; }

        /* --- CPs Styles --- */
        .cp-level-card { background-color: #fff; border-radius: 0.75rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e7e5e4; }
        .cp-level-header { padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .cp-level-content { padding: 0 1.5rem; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding-bottom 0.3s ease-out; }
        .cp-level-card.open .cp-level-content { max-height: 6000px; padding-bottom: 1.5rem; }
        .cp-lesson-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: 0.5rem; }
        .cp-lesson-item:nth-child(odd) { background-color: #f9fafb; }

        /* --- Banco de Fotos Styles --- */
        .folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1.5rem; }
        .folder-card { background-color: #fff; border-radius: 0.75rem; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s; border: 1px solid #e7e5e4; position: relative; }
        .folder-card:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-color: #F1D24B; }
        .folder-delete-btn { position: absolute; top: 0.5rem; right: 0.5rem; background: none; border: none; cursor: pointer; color: #d1d5db; padding: 0.25rem; border-radius: 9999px; }
        .folder-card:hover .folder-delete-btn { color: #9ca3af; }
        .folder-delete-btn:hover { color: #ef4444; background-color: #fef2f2; }
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
        .photo-card { background-color: #fff; border-radius: 0.75rem; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e7e5e4; }
        .photo-card img { width: 100%; height: 200px; object-fit: cover; }
        .photo-card-info { padding: 1rem; }

        /* --- PEF Styles (Integrated) --- */
        .pef-lesson-row { display: grid; grid-template-columns: 80px 150px 1fr; align-items: start; gap: 1rem; padding: 1rem 0.75rem; border-bottom: 1px solid #e5e7eb; }
        .pef-lesson-row:last-child { border-bottom: none; }
        .pef-student-attendance-row { display: flex; align-items: center; justify-content: space-between; margin-left: 1rem; padding: 0.5rem 0; }
        .pef-status-btn-group button { width: 2.5rem; height: 2.5rem; border-radius: 0.375rem; border: 1px solid #d1d5db; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s; background-color: #f9fafb; }
        .pef-status-btn-group button:hover { border-color: #a8a29e; }
        .pef-status-btn-group button.active.P { background-color: #10B981; color: white; border-color: #10B981; }
        .pef-status-btn-group button.active.F { background-color: #EF4444; color: white; border-color: #EF4444; }
        .pef-status-btn-group button.active.PP { background-color: #F59E0B; color: white; border-color: #F59E0B; }

        /* --- Calendar Styles --- */
        .calendar-container { max-width: 1200px; margin: 0 auto; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .calendar-nav-btn { background-color: #f3f4f6; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .calendar-nav-btn:hover { background-color: #e5e7eb; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
        .calendar-day-header { background-color: #f9fafb; padding: 1rem; text-align: center; font-weight: 700; color: #44403c; }
        .calendar-day { background-color: white; min-height: 120px; padding: 0.5rem; position: relative; cursor: pointer; transition: background-color 0.2s; }
        .calendar-day:hover { background-color: #fffbeb; }
        .calendar-day.other-month { background-color: #f9fafb; color: #9ca3af; }
        .calendar-day.today { background-color: #fef3c7; border: 2px solid #F1D24B; }
        .calendar-day-number { font-weight: 600; margin-bottom: 0.25rem; }
        .calendar-event { background-color: #F1D24B; color: #44403c; padding: 0.125rem 0.25rem; border-radius: 0.25rem; font-size: 0.75rem; margin-bottom: 0.125rem; cursor: pointer; display: block; }
        .calendar-event:hover { background-color: #eab308; }
        .calendar-event.gravacao { background-color: #10B981; color: white; }
        .calendar-event.lembrete { background-color: #F59E0B; color: white; }
        .calendar-event.evento { background-color: #8671D1; color: white; }
        .calendar-event.aula-extra { background-color: #FF5C3D; color: white; }
        .calendar-event.data-comemorativa { background-color: #84C7DF; color: white; }
        .calendar-event.reuniao { background-color: #6B7280; color: white; }

        /* --- Monthly Highlight Styles --- */
        .highlight-card { display: flex; gap: 1rem; align-items: center; }
        .highlight-photo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #F1D24B; }
        .highlight-info h5 { font-size: 1.125rem; font-weight: 700; color: #44403c; margin-bottom: 0.25rem; }
        .highlight-info p { color: #6b7280; font-size: 0.875rem; line-height: 1.4; }
        .highlight-award { color: #059669; font-size: 0.875rem; margin-top: 0.5rem; }
        .highlight-empty { text-align: center; padding: 2rem; color: #9ca3af; }

        /* --- Pedagogical Challenge Styles --- */
        .pedagogical-quiz-option {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 0.75rem;
            text-align: left;
            background-color: #f5f5f4;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .pedagogical-quiz-option:hover:not(:disabled) {
            background-color: #e7e5e4;
            border-color: #F1D24B;
        }
        .pedagogical-quiz-option:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }
        .pedagogical-quiz-option.correct {
            background-color: #D1FAE5;
            border-color: #34D399;
            color: #065F46;
            font-weight: 600;
        }
        .pedagogical-quiz-option.incorrect {
            background-color: #FEE2E2;
            border-color: #F87171;
            color: #991B1B;
            font-weight: 600;
        }
        .audio-player-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            max-width: 450px;
            background-color: #f5f5f4;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
        }
        .play-pause-button {
            background-color: #F1D24B;
            color: #44403c;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        .play-pause-button:hover { background-color: #eab308; }
        .play-pause-button svg { width: 20px; height: 20px; }
        .progress-bar { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: #e7e5e4; border-radius: 3px; outline: none; cursor: pointer; }
        .progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: #44403c; border-radius: 50%; cursor: pointer; }
        .progress-bar::-moz-range-thumb { width: 16px; height: 16px; background: #44403c; border-radius: 50%; cursor: pointer; }
        .time-display { font-size: 0.875rem; color: #57534e; min-width: 80px; text-align: center; }
        #certificate {
            background: linear-gradient(45deg, #fffbeb, #f0f9ff);
        }

        /* --- Guidelines Styles --- */
        .guidelines-search { width: 100%; max-width: 400px; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 2rem; }
        .guideline-card { background-color: #ffffff; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: all 0.2s; }
        .guideline-card.good-practice { border-left: 4px solid #10B981; }
        .guideline-card.prohibited { border-left: 4px solid #EF4444; }
        .guideline-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .guideline-icon { margin-right: 0.75rem; }
        .guideline-header { display: flex; align-items: center; margin-bottom: 0.75rem; }
        .guideline-title { font-size: 1.125rem; font-weight: 700; color: #44403c; }
        .guideline-description { color: #6b7280; line-height: 1.5; }
        .guideline-delete-btn { background: none; border: none; cursor: pointer; color: #9ca3af; margin-left: auto; padding: 0.25rem; }

        /* --- Pagination Styles --- */
        .pagination-controls { margin-top: 1rem; }
        .pagination-btn { 
            padding: 0.5rem; 
            border: 1px solid #d1d5db; 
            background: #ffffff; 
            border-radius: 0.375rem; 
            cursor: pointer; 
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pagination-btn:hover:not(.disabled) { 
            background: #f3f4f6; 
            border-color: #9ca3af; 
        }
        .pagination-btn.disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            background: #f9fafb;
        }
        .pagination-number { 
            padding: 0.5rem 0.75rem; 
            border: 1px solid #d1d5db; 
            background: #ffffff; 
            border-radius: 0.375rem; 
            cursor: pointer; 
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .pagination-number:hover { 
            background: #f3f4f6; 
            border-color: #9ca3af; 
        }
        .pagination-number.active { 
            background: #F1D24B; 
            border-color: #F1D24B; 
            color: #1f2937;
            font-weight: 700;
        }
        .guideline-delete-btn:hover { color: #ef4444; }

        /* --- BrainFlip Game Styles --- */

        /* BrainFlip Flashcard Styles */
        .flashcard-container {
            perspective: 1000px;
            width: 100%;
            max-width: 400px;
            height: 250px;
            margin: 0 auto;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            background-color: #ffffff;
            border: 2px solid #84C7DF;
        }
        .flashcard.flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
            border-radius: 12px;
            font-size: 1.25rem;
            font-weight: 600;
            color: #44403c;
            line-height: 1.4;
        }
        .flashcard-front {
            background: linear-gradient(135deg, #F1D24B 0%, #FF5C3D 100%);
        }
        .flashcard-back {
            background: linear-gradient(135deg, #84C7DF 0%, #8671D1 100%);
            transform: rotateY(180deg);
            color: white;
        }
        .navigation-button-game {
            background-color: #F1D24B;
            color: #44403c;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .navigation-button-game:hover {
            background-color: #eab308;
        }
        .navigation-button-game:disabled {
            background-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">

    <!-- Login, Pending, and Hub Views -->
    <div id="login-view" class="flex items-center justify-center min-h-screen">
        <!-- O conteúdo do login será gerado pelo JS -->
    </div>

    <div id="pending-view" class="hidden items-center justify-center min-h-screen">
        <div class="text-center p-8 bg-white rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold" style="color: #F1D24B;">Aguardando Aprovação</h2>
            <p class="text-stone-600 mt-2">Sua conta foi criada e está aguardando aprovação de um administrador.</p>
            <button id="pending-logout" class="mt-6 secondary-btn w-auto">Sair</button>
        </div>
    </div>

    <div id="hub-view" class="hidden">
        <div id="app-container" class="min-h-screen md:flex bg-stone-50">
            <aside class="md:w-64 bg-white md:border-r border-b border-stone-200 p-4 md:p-6 flex flex-col h-screen md:h-auto">
                <div class="mb-4 text-center">
                    <img id="profile-picture" src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg" alt="Foto de Perfil" class="w-24 h-24 mx-auto rounded-full object-cover border-4 border-stone-200">
                </div>
                <h1 class="text-xl font-bold text-stone-800 text-center">Hub SLAP</h1>
                <p id="welcome-message" class="text-center text-sm text-stone-600 mb-6"></p>
                <nav id="main-navigation" class="space-y-1 flex-1 overflow-y-auto">
                    <!-- Menu items are dynamically generated here -->
                </nav>
                <div class="pt-4 border-t border-stone-200 mt-4">
                    <button id="logout-button" class="nav-item w-full text-left px-4 py-2.5 rounded-lg text-stone-700 hover:bg-red-50 hover:text-red-600 transition-colors flex items-center font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        Sair
                    </button>
                </div>
            </aside>
        
            <main class="flex-1 relative">
                <div class="bg-[#F1D24B] block w-full p-4 sm:p-6 md:p-8 absolute top-0 left-0 right-0 z-10">
                    <div class="flex justify-between items-start">
                        <header id="main-header" class="flex items-center gap-4">
                            <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1751163691/SLAP_TIPO_PRETO_1_xarnpe.png" alt="SLAP Logo" class="h-12 w-auto">
                            <div>
                                <h2 id="main-title" class="text-3xl font-bold text-stone-800"></h2>
                                <p id="main-description" class="mt-1 text-stone-700"></p>
                            </div>
                        </header>
                        <div id="header-welcome-message" class="text-right text-stone-800">
                            <!-- Welcome message will be inserted here -->
                        </div>
                    </div>
                </div>
                <div id="content-area" class="pt-32 pb-4 px-4 sm:pt-36 sm:pb-6 sm:px-6 md:pt-40 md:pb-8 md:px-8"></div>
            </main>
        </div>
    </div>

    <!-- Modal -->
    <div id="form-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="modal-header-container" class="modal-header">
                <h4 id="form-modal-title"></h4>
                <button class="modal-close-btn" data-action="close-modal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="form-modal-content-area"></div>
        </div>
    </div>

    <!-- Monthly Highlight Modal -->
    <div id="monthly-highlight-modal" class="modal-overlay">
        <div class="modal-content max-w-md">
            <div class="modal-header">
                <h4>Editar Destaque do Mês</h4>
                <button data-action="close-highlight-modal" class="modal-close-btn">&times;</button>
            </div>
            <form id="monthly-highlight-form">
                <div class="space-y-4">
                    <div>
                        <label class="font-medium text-sm">Nome do Funcionário</label>
                        <input type="text" id="highlight-name" class="form-input" required>
                    </div>
                    <div>
                        <label class="font-medium text-sm">URL da Foto (Cloudinary)</label>
                        <input type="url" id="highlight-photo-url" class="form-input" placeholder="https://res.cloudinary.com/..." required>
                    </div>
                    <div>
                        <label class="font-medium text-sm">Descrição</label>
                        <textarea id="highlight-description" rows="4" class="form-input" placeholder="Descreva os méritos e conquistas..." required></textarea>
                    </div>
                    <div>
                        <label class="font-medium text-sm">Premiação</label>
                        <input type="text" id="highlight-award" class="form-input" placeholder="Ex: R$ 500 em vale-compras">
                    </div>
                    <div class="flex justify-end gap-2">
                        <button type="button" data-action="close-highlight-modal" class="secondary-btn">Cancelar</button>
                        <button type="submit" class="primary-btn w-auto">Salvar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        console.log('=== SCRIPT STARTED LOADING ===');
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, serverTimestamp, query, setDoc, getDoc, updateDoc, orderBy, limit, where, arrayUnion, arrayRemove, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";

        // --- GLOBAL VARIABLES ---
        const contentArea = document.getElementById('content-area');
        const mainHeader = document.getElementById('main-header');
        const loginView = document.getElementById('login-view');
        const hubView = document.getElementById('hub-view');
        const pendingView = document.getElementById('pending-view');
        
        let db, auth, storage, userId, currentUserName, currentUserRole;
        let usersData = [], students = [], turmas = [], vips = [], attendance = [], tasks = [], events = [], budgets = [], collaborators = [], schedules = [], expenses = [], cancellations = [], cps = [], dojoRanking = [], dojoMissions = [];
        let allUnsubscribers = [];
        const appId = 'hub-gestao-slap';
        
        // Pagination state
        let currentPage = 1;
        let itemsPerPage = 20;

        // --- DEVELOPMENT MODE FUNCTIONS ---
        function startAppInDevelopmentMode() {
            console.log('=== STARTING APP IN DEVELOPMENT MODE ===');
            window.isDevelopmentMode = true;
            // Set up basic user data for development
            currentUserName = "Admin SLAP";
            currentUserRole = "admin";
            userId = "demo-user";
            
            // Set profile picture
            document.getElementById('profile-picture').src = 'https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg';
            
            // Initialize with demo data
            loadDemoData();
            updateWelcomeMessages(currentUserName);
            showHubView();
            console.log('About to render inicio section and menu');
            renderInicioSection();
            renderMenu();
            console.log('App initialization completed successfully');
        }
        
        function loadDemoData() {
            // Load demo data from localStorage or create default data
            students = JSON.parse(localStorage.getItem('demo-students') || '[]');
            turmas = JSON.parse(localStorage.getItem('demo-turmas') || '[]');
            vips = JSON.parse(localStorage.getItem('demo-vips') || '[]');
            tasks = JSON.parse(localStorage.getItem('demo-tasks') || '[]');
            events = JSON.parse(localStorage.getItem('demo-events') || '[]');
            budgets = JSON.parse(localStorage.getItem('demo-budgets') || '[]');
            collaborators = JSON.parse(localStorage.getItem('demo-collaborators') || '[]');
            expenses = JSON.parse(localStorage.getItem('demo-expenses') || '[]');
            cancellations = JSON.parse(localStorage.getItem('demo-cancellations') || '[]');
            cps = JSON.parse(localStorage.getItem('demo-cps') || '[]');
            
            // Initialize with sample data if empty
            if (students.length === 0) {
                students = [
                    { id: '1', name: 'Maria Silva', email: 'maria@exemplo.com', phone: '(11) 98765-4321', status: 'ativo', setor: 'financeiro' },
                    { id: '2', name: 'João Santos', email: 'joao@exemplo.com', phone: '(11) 87654-3210', status: 'ativo', setor: 'pedagogico' }
                ];
                localStorage.setItem('demo-students', JSON.stringify(students));
            }
        }

        // --- FIREBASE INITIALIZATION ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config)
                    ? JSON.parse(__firebase_config)
                    : (typeof window.firebaseConfig !== 'undefined' ? window.firebaseConfig : {});

                if (!firebaseConfig.apiKey) {
                    console.log("=== FIREBASE CONFIG NOT FOUND - DEVELOPMENT MODE ===");
                    console.warn("Configuração do Firebase não encontrada. Executando em modo de desenvolvimento local.");
                    // Initialize in development mode with localStorage
                    window.isDevelopmentMode = true;
                    startAppInDevelopmentMode();
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user && !user.isAnonymous) {
                        await initializeAppWithUser(user);
                    } else {
                        showLoginView();
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }

        async function initializeAppWithUser(user) {
            userId = user.uid;
            const userDocRef = doc(db, "users", userId);
            const userDoc = await getDoc(userDocRef);
            
            if (userDoc.exists()) {
                const userData = userDoc.data();
                currentUserName = userData.name || user.displayName;
                currentUserRole = userData.role;
                document.getElementById('profile-picture').src = userData.photoURL || 'https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg';
                
                if (['admin', 'am', 'ap', 'pedagogico', 'financeiro', 'teacher'].includes(currentUserRole)) {
                    setupFirestoreListeners();
                    updateWelcomeMessages(currentUserName);
                    showHubView();
                } else {
                    showPendingView();
                }
            } else {
                showPendingView();
            }
        }
        
        // --- FIRESTORE LISTENERS ---
        function setupFirestoreListeners() {
            if (!db || !userId) return;
            allUnsubscribers.forEach(unsub => unsub && unsub());
            allUnsubscribers = [];

            const getCollectionListener = (collectionName, targetArray, renderFunc, q) => {
                const collRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
                const finalQuery = q ? q(collRef) : query(collRef);
                const unsubscribe = onSnapshot(finalQuery, (snapshot) => {
                    targetArray.length = 0;
                    snapshot.docs.forEach(doc => targetArray.push({ id: doc.id, ...doc.data() }));
                    
                    const activePageId = contentArea.firstElementChild?.id;
                    if (renderFunc && activePageId) {
                        const pageBaseName = activePageId.replace('-section', '');
                         if (pageBaseName.startsWith(collectionName.slice(0, -1).replace('_', '-').toLowerCase()) || pageBaseName === 'inicio') {
                            renderFunc();
                        }
                    }
                }, (error) => console.error(`Error on ${collectionName} listener:`, error));
                allUnsubscribers.push(unsubscribe);
            };
            
            getCollectionListener('users', usersData, null);
            getCollectionListener('students', students, () => {
                if (contentArea.firstElementChild?.id === 'alunos-section') {
                    resetPagination();
                    renderAlunosSection();
                }
                if (contentArea.firstElementChild?.id === 'turmas-section') renderTurmasSection();
                if (contentArea.firstElementChild?.id === 'vips-section') renderVipsSection();
            });
            getCollectionListener('turmas', turmas, renderTurmasSection);
            getCollectionListener('vips', vips, renderVipsSection);
            getCollectionListener('attendance', attendance, () => {
                const activeModal = document.querySelector('.modal-overlay.visible');
                if (activeModal && activeModal.querySelector('[data-pef-modal="true"]')) {
                    const pefType = activeModal.dataset.pefType;
                    const unitId = activeModal.dataset.unitId;
                    if (pefType === 'turma') {
                        openTurmaPefModal(unitId);
                    } else if (pefType === 'vip') {
                        openVipPefModal(unitId);
                    }
                }
            });
            getCollectionListener('tasks', tasks, renderTarefasSection);
            getCollectionListener('budgets', budgets, renderOrcamentosSection);
            getCollectionListener('collaborators', collaborators, () => {
                const activePageId = contentArea.firstElementChild?.id;
                if (activePageId === 'grade-section') renderGradeSection();
                if (activePageId === 'tasks-section') renderTarefasSection();
                if (activePageId === 'colaboradores-section') renderColaboradoresSection();

                if (activePageId === 'inicio-section') renderInicioSection();
            });
            getCollectionListener('events', events, () => {
                const activePageId = contentArea.firstElementChild?.id;
                if (activePageId === 'eventos-section') {
                    renderEventosSection();
                } else if (activePageId === 'calendario-section') {
                    // Update calendar events from events collection
                    calendarEvents = events.map(event => ({
                        id: event.id,
                        title: event.titulo,
                        date: event.dataEvento,
                        time: event.horario,
                        type: event.tipo || 'evento',
                        description: event.descricao
                    }));
                    renderCalendar();
                }
            });
            getCollectionListener('schedules', schedules, () => {
                 if (contentArea.firstElementChild?.id === 'grade-section') renderGradeSection();
            });
            getCollectionListener('expenses', expenses, renderFolhaPagamentoSection);
            getCollectionListener('cancellations', cancellations, renderCancelamentosSection);


            getCollectionListener('cps', cps, () => {
                const activePageId = contentArea.firstElementChild?.id;
                if (activePageId === 'cps-section') renderCPsSection();
                if (['alunos-section', 'turmas-section', 'vips-section', 'grade-section'].includes(activePageId)) {
                    document.querySelector(`#main-navigation [data-target="${activePageId.replace('-section', '')}"]`)?.click();
                }
            }, (ref) => query(ref, orderBy("order")));
            getCollectionListener('dojo_ranking', dojoRanking, renderDojoSection);
            getCollectionListener('dojo_missions', dojoMissions, renderDojoSection, (ref) => query(ref, orderBy("points", "desc")));
            
            // Setup monthly highlight listener
            setupMonthlyHighlightListener();
            
            // Setup guidelines listener
            setupGuidelinesListener();
            
            // Setup calendar events listener (uses existing events collection)
            // No need for separate listener since events are already handled by existing listener
        }

        // --- AUTH, VIEW, and MENU FUNCTIONS ---
        function showLoginView() {
            hubView.classList.add('hidden');
            pendingView.classList.add('hidden');
            pendingView.classList.remove('flex');
            loginView.classList.remove('hidden');
            loginView.classList.add('flex');
            loginView.innerHTML = `
                <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-xl shadow-lg">
                    <div class="text-center">
                        <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg" alt="Logo SLAP" class="w-24 h-auto mx-auto rounded-lg mb-4">
                        <h2 class="text-2xl font-bold text-stone-900">Acesse sua conta</h2>
                        <p class="mt-2 text-sm text-stone-600">Bem-vindo(a) de volta!</p>
                    </div>
                    <form id="login-form" class="mt-8 space-y-6">
                        <div>
                            <label for="login-email" class="sr-only">E-mail</label>
                            <input id="login-email" name="email" type="email" autocomplete="email" required class="form-input" placeholder="Endereço de e-mail">
                        </div>
                        <div>
                            <label for="login-password" class="sr-only">Senha</label>
                            <input id="login-password" name="password" type="password" autocomplete="current-password" required class="form-input" placeholder="Senha">
                        </div>
                        <p id="login-error" class="text-sm text-red-600 text-center"></p>
                        <div>
                            <button type="submit" class="primary-btn">Entrar</button>
                        </div>
                    </form>
                    <p class="text-sm text-center text-stone-600">
                        Não tem uma conta?
                        <button data-action="open-signup" class="font-medium" style="color: #F1D24B;">Cadastre-se</button>
                    </p>
                </div>
            `;
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        }

        function showHubView() { 
            loginView.classList.add('hidden');
            loginView.classList.remove('flex');
            pendingView.classList.add('hidden');
            pendingView.classList.remove('flex');
            hubView.classList.remove('hidden'); 
            const firstName = (currentUserName || '').split(' ')[0];
            document.getElementById('welcome-message').textContent = `Bem-vindo(a), ${firstName}`;
            renderMenu(); 
            renderInicioSection(); 
            setActiveNavItem(document.querySelector('[data-target="inicio"]')); 
        }
        function showPendingView() { 
            hubView.classList.add('hidden'); 
            loginView.classList.add('hidden');
            loginView.classList.remove('flex');
            pendingView.classList.remove('hidden'); 
            pendingView.classList.add('flex');
        }
        function setActiveNavItem(element) { document.querySelectorAll('#main-navigation .nav-item').forEach(item => item.classList.remove('active')); if (element) element.classList.add('active'); }
        async function handleLogin(event) {
            event.preventDefault();
            const email = event.target.email.value;
            const password = event.target.password.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                const errorElement = document.getElementById('login-error');
                if(errorElement) errorElement.textContent = "E-mail ou senha inválidos.";
            }
        }
        async function handleSignUp(event) { event.preventDefault(); const name = event.target.name.value; const email = event.target.email.value; const password = event.target.password.value; try { const cred = await createUserWithEmailAndPassword(auth, email, password); await updateProfile(cred.user, { displayName: name }); await setDoc(doc(db, "users", cred.user.uid), { name, email, role: "pending", createdAt: serverTimestamp() }); await signOut(auth); showSuccessMessage("Cadastro Concluído!", "Sua conta foi criada. Aguarde aprovação de um administrador para acessar."); } catch (error) { showErrorMessage("Erro", "Erro ao criar conta. Verifique o e-mail e a senha."); } }
        async function handleLogout() { 
            await signOut(auth);
        }

        // --- CONTENT RENDERING ---
        function renderInicioSection() {
            document.getElementById('main-title').textContent = 'Dashboard';
            document.getElementById('main-description').textContent = 'Visão geral das suas atividades e da equipe.';
            
            // Calculate statistics based on user role
            const isTeacher = currentUserRole === 'teacher';
            const totalStudents = students.length;
            const activeStudents = students.filter(s => s.status === 'Ativo').length;
            const totalTurmas = turmas.length;
            const totalRevenue = students.reduce((sum, s) => sum + (parseFloat(s.amountPaid) || 0), 0);
            
            // Check if user can see financial information
            const canViewFinancialInfo = !['teacher', 'pedagogico', 'ap', 'am'].includes(currentUserRole);
            
            contentArea.innerHTML = `
                <div id="inicio-section" class="space-y-6">
                    <!-- Welcome Header removed - now integrated in main header -->
                    
                    <!-- Compact Statistics -->
                    <div class="grid ${
                        isTeacher ? 'grid-cols-2' : 
                        canViewFinancialInfo ? 'grid-cols-2 md:grid-cols-4' : 'grid-cols-2 md:grid-cols-3'
                    } gap-4">
                        ${!isTeacher ? `
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-stone-200 text-center">
                            <p class="text-2xl font-bold" style="color: #84C7DF;">${totalStudents}</p>
                            <p class="text-sm text-stone-600">Total Alunos</p>
                        </div>` : ''}
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-stone-200 text-center">
                            <p class="text-2xl font-bold" style="color: #F1D24B;">${activeStudents}</p>
                            <p class="text-sm text-stone-600">Alunos Ativos</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-stone-200 text-center">
                            <p class="text-2xl font-bold" style="color: #8671D1;">${totalTurmas}</p>
                            <p class="text-sm text-stone-600">Turmas</p>
                        </div>
                        ${canViewFinancialInfo ? `
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-stone-200 text-center">
                            <p class="text-2xl font-bold" style="color: #FF5C3D;">R$ ${totalRevenue.toFixed(0)}</p>
                            <p class="text-sm text-stone-600">Receita</p>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Employee Highlight and Top 3 Dojo Section -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Employee Highlight Section - Compact -->
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-stone-200">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="text-base font-semibold text-stone-800">Destaque do Mês</h4>
                                ${currentUserRole === 'admin' ? `
                                <button class="text-stone-500 hover:text-stone-700 p-1" data-action="edit-monthly-highlight" title="Editar destaque">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002 2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                                ` : ''}
                            </div>
                            <div id="monthly-highlight-content" class="text-sm">
                                <!-- Monthly highlight content will be rendered here -->
                            </div>
                        </div>

                        <!-- Top 3 Dojo Section -->
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-stone-200">
                            <h4 class="text-base font-semibold text-stone-800 mb-3">Top 3 Dojo</h4>
                            <div class="space-y-2">
                                ${getTop3DojoRanking().map((item, index) => `
                                    <div class="flex items-center justify-between p-2 rounded-lg" style="background-color: ${
                                        index === 0 ? '#F1D24B20' : 
                                        index === 1 ? '#84C7DF20' : 
                                        '#FF5C3D20'
                                    }">
                                        <div class="flex items-center space-x-2">
                                            <span class="text-lg font-bold" style="color: ${
                                                index === 0 ? '#F1D24B' : 
                                                index === 1 ? '#84C7DF' : 
                                                '#FF5C3D'
                                            }">${
                                                index === 0 ? '🥇' : index === 1 ? '🥈' : '🥉'
                                            }</span>
                                            <span class="font-medium text-stone-700">${item.name}</span>
                                        </div>
                                        <span class="text-sm font-semibold text-stone-700">${item.points || 0} pts</span>
                                    </div>
                                `).join('')}
                                ${getTop3DojoRanking().length === 0 ? '<p class="text-sm text-stone-500 text-center py-4">Ainda não há ranking</p>' : ''}
                            </div>
                        </div>
                    </div>
                    


                    <!-- Teacher-specific Weekly Schedule Preview -->
                    ${isTeacher ? `
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-stone-800">Minha Grade da Semana</h3>
                            <button class="text-sm font-medium hover:underline nav-item" style="color: #F1D24B;" data-target="grade">Ver grade completa →</button>
                        </div>
                        <div class="grid grid-cols-5 gap-3">
                            ${["Segunda", "Terça", "Quarta", "Quinta", "Sexta"].map(day => `
                                <div class="text-center">
                                    <p class="text-sm font-semibold text-stone-700 mb-3">${day.substring(0, 3)}</p>
                                    <div class="space-y-2">
                                        ${getTeacherDaySchedule(day, currentUserName).slice(0, 2).map(schedule => `
                                            <div class="text-xs p-2 rounded-lg shadow-sm border" style="background-color: #F1D24B20; border-color: #F1D24B30; color: #8B6914;">
                                                <div class="font-medium">${schedule.startTime}</div>
                                                <div class="text-stone-600">${schedule.student}</div>
                                            </div>
                                        `).join('')}
                                        ${getTeacherDaySchedule(day, currentUserName).length > 2 ? `<div class="text-xs text-stone-500 font-medium">+${getTeacherDaySchedule(day, currentUserName).length - 2}</div>` : ''}
                                        ${getTeacherDaySchedule(day, currentUserName).length === 0 ? '<div class="text-xs text-stone-400 p-2 bg-stone-50 rounded-lg border border-stone-200">Livre</div>' : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>` : ''}

                    <!-- Redes SLAP -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                        <h4 class="text-lg font-bold text-stone-800 mb-4">Redes SLAP</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <a href="https://instagram.com/speakinglikeapro" target="_blank" class="p-3 rounded-lg text-center transition-colors" style="background-color: #FF5C3D20; color: #FF5C3D">
                                <svg class="w-6 h-6 mx-auto mb-1" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                                </svg>
                                <p class="text-xs font-medium">Instagram</p>
                            </a>
                            <a href="https://youtube.com/@speakinglikeapro" target="_blank" class="p-3 rounded-lg text-center transition-colors" style="background-color: #84C7DF20; color: #84C7DF">
                                <svg class="w-6 h-6 mx-auto mb-1" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                                </svg>
                                <p class="text-xs font-medium">YouTube</p>
                            </a>
                            <a href="https://tiktok.com/@speakinglikeapro" target="_blank" class="p-3 rounded-lg text-center transition-colors" style="background-color: #8671D120; color: #8671D1">
                                <svg class="w-6 h-6 mx-auto mb-1" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z"/>
                                </svg>
                                <p class="text-xs font-medium">TikTok</p>
                            </a>
                            <a href="https://linkedin.com/company/speaking-like-a-pro" target="_blank" class="p-3 rounded-lg text-center transition-colors" style="background-color: #F1D24B20; color: #F1D24B">
                                <svg class="w-6 h-6 mx-auto mb-1" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                </svg>
                                <p class="text-xs font-medium">LinkedIn</p>
                            </a>
                        </div>
                    </div>
                </div>
            `;
            
            // Initialize monthly highlight
            loadMonthlyHighlight();
        }

        // Dashboard helper functions
        function getPendingTasks() {
            return tasks.filter(task => !task.completed);
        }

        function getUpcomingEvents() {
            const today = new Date();
            const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            return events.filter(event => {
                const eventDate = new Date(event.dataEvento + 'T00:00:00');
                return eventDate >= today && eventDate <= nextWeek;
            }).sort((a, b) => new Date(a.dataEvento) - new Date(b.dataEvento));
        }

        function getTeacherDaySchedule(day, teacherName) {
            const actualTeacherName = findTeacherByName(teacherName) || teacherName;
            return schedules.filter(s => s.day === day && s.teacher === actualTeacherName && s.type !== 'break')
                           .sort((a, b) => a.startTime.localeCompare(b.startTime));
        }

        function getNewStudentsThisMonth() {
            const now = new Date();
            const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            return students.filter(student => {
                if (!student.createdAt) return false;
                const createdDate = new Date(student.createdAt);
                return createdDate >= firstDayOfMonth;
            }).length;
        }

        function getCancellationsThisMonth() {
            const now = new Date();
            const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            return cancellations.filter(cancellation => {
                const cancellationDate = new Date(cancellation.cancellationDate + 'T00:00:00');
                return cancellationDate >= firstDayOfMonth;
            }).length;
        }

        function getCompletedTasksThisWeek() {
            const now = new Date();
            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
            return tasks.filter(task => {
                if (!task.completed || !task.completedAt) return false;
                const completedDate = new Date(task.completedAt);
                return completedDate >= weekStart;
            }).length;
        }

        function getTotalTeachingHours() {
            return schedules.filter(s => s.type !== 'break').length;
        }

        function getTop3DojoRanking() {
            return dojoRanking.sort((a, b) => b.points - a.points).slice(0, 3);
        }

        function getCurrentMonthName() {
            const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            return months[new Date().getMonth()];
        }

        function getCurrentDayName() {
            const days = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 
                         'Quinta-feira', 'Sexta-feira', 'Sábado'];
            return days[new Date().getDay()];
        }
        
        function initializeChart() {
            const ctx = document.getElementById('studentsChart');
            if (!ctx) return;
            
            const statusCounts = students.reduce((acc, student) => {
                const status = student.status || 'Pendente';
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            '#10B981', // Green for Ativo
                            '#EF4444', // Red for Cancelado
                            '#F59E0B', // Yellow for Pendente
                            '#8B5CF6', // Purple for others
                            '#06B6D4'  // Cyan for others
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderAlunosSection() {
            document.getElementById('main-title').textContent = 'Gestão de Alunos';
            document.getElementById('main-description').textContent = 'Cadastre e gerencie todos os alunos da escola.';
            const canAdd = ['admin', 'financeiro', 'pedagogico', 'ap'].includes(currentUserRole);
            const canViewFinancialInfo = !['teacher', 'pedagogico', 'ap', 'am'].includes(currentUserRole);

            const totalCount = students.length;
            const activeCount = students.filter(s => s.status === 'Ativo').length;
            const cancelledCount = students.filter(s => s.status === 'Cancelado').length;

            contentArea.innerHTML = `
                <section id="alunos-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                        <div class="bg-stone-100 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-stone-800">${totalCount}</p>
                            <p class="text-sm text-stone-600">Total de Alunos</p>
                        </div>
                        <div class="bg-green-100 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-green-700">${activeCount}</p>
                            <p class="text-sm text-green-600">Alunos Ativos</p>
                        </div>
                        <div class="bg-red-100 p-4 rounded-lg text-center">
                            <p class="text-2xl font-bold text-red-700">${cancelledCount}</p>
                            <p class="text-sm text-red-600">Alunos Cancelados</p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <input type="search" id="aluno-search" placeholder="Pesquisar por nome..." class="form-input w-full sm:w-1/2">
                    </div>

                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                        <div class="flex gap-2" id="alunos-filter-buttons">
                            <button class="secondary-btn filter-btn active" data-filter="todos">Todos</button>
                            <button class="secondary-btn filter-btn" data-filter="ativo">Ativos</button>
                            <button class="secondary-btn filter-btn" data-filter="cancelado">Cancelados</button>
                        </div>
                        <div class="flex gap-2">
                            <button class="secondary-btn w-auto" data-action="export-alunos-doc">Exportar Documento</button>
                            ${canAdd ? `<button class="primary-btn w-auto" data-action="add-aluno">+ Adicionar Aluno</button>` : ''}
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table" id="alunos-table">
                            <thead>
                                <tr>
                                    <th>Nome do Aluno</th>
                                    <th>Status</th>
                                    ${canViewFinancialInfo ? '<th>Valor Pago</th>' : ''}
                                    <th>Responsável</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="alunos-list"></tbody>
                        </table>
                    </div>
                    
                    <!-- Controles de Paginação -->
                    <div id="pagination-controls" class="flex justify-between items-center mt-6 pt-4 border-t border-stone-200">
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-stone-600">Itens por página:</label>
                            <select id="items-per-page" class="form-input !py-1 !px-2 w-20">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                        
                        <div id="pagination-info" class="text-sm text-stone-600"></div>
                        
                        <div class="flex gap-1">
                            <button id="prev-page" class="secondary-btn !py-1 !px-3 disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                </svg>
                            </button>
                            <div id="page-numbers" class="flex gap-1"></div>
                            <button id="next-page" class="secondary-btn !py-1 !px-3 disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </section>
            `;
            
            const searchInput = document.getElementById('aluno-search');
            const filterButtons = document.querySelectorAll('#alunos-filter-buttons .filter-btn');

            const performUpdate = () => {
                const currentFilter = document.querySelector('#alunos-filter-buttons .filter-btn.active').dataset.filter;
                updateAlunosList(currentFilter);
            };

            searchInput.addEventListener('input', performUpdate);
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    performUpdate();
                });
            });

            // Configurar paginação
            const itemsPerPageSelect = document.getElementById('items-per-page');
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');
            
            itemsPerPageSelect.addEventListener('change', () => {
                itemsPerPage = parseInt(itemsPerPageSelect.value);
                currentPage = 1;
                performUpdate();
            });
            
            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    performUpdate();
                }
            });
            
            nextPageBtn.addEventListener('click', () => {
                const totalItems = getFilteredStudents().length;
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    performUpdate();
                }
            });

            updateAlunosList('todos');
        }
        
        function getFilteredStudents() {
            const filter = document.querySelector('#alunos-filter-buttons .filter-btn.active')?.dataset.filter || 'todos';
            const searchTerm = document.getElementById('aluno-search')?.value.toLowerCase() || '';
            
            let filteredStudents = students;
            if (filter !== 'todos') {
                filteredStudents = students.filter(s => s.status && s.status.toLowerCase() === filter);
            }
            
            if (searchTerm) {
                filteredStudents = filteredStudents.filter(s => s.name.toLowerCase().includes(searchTerm));
            }
            
            return filteredStudents.sort((a, b) => a.name.localeCompare(b.name));
        }

        function updateAlunosList(filter) {
            const listBody = document.getElementById('alunos-list');
            if (!listBody) return;
            const canEdit = ['admin', 'financeiro', 'pedagogico', 'ap'].includes(currentUserRole);
            const canViewFinancialInfo = !['teacher', 'pedagogico', 'ap', 'am'].includes(currentUserRole);

            const filteredStudents = getFilteredStudents();
            const totalItems = filteredStudents.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            
            // Reset to page 1 if current page is beyond total pages
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = 1;
            }

            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedStudents = filteredStudents.slice(startIndex, endIndex);

            if (filteredStudents.length === 0) {
                const colspanCount = canViewFinancialInfo ? 5 : 4;
                listBody.innerHTML = `<tr><td colspan="${colspanCount}" class="text-center py-10 text-stone-500">Nenhum aluno encontrado.</td></tr>`;
                updatePaginationControls(0, 0, 0);
                return;
            }

            listBody.innerHTML = paginatedStudents.map(student => `
                <tr data-action="view-aluno" data-id="${student.id}" class="cursor-pointer">
                    <td class="font-medium">${student.name}</td>
                    <td><span class="status-tag status-${(student.status || 'pendente').toLowerCase()}">${student.status || 'Pendente'}</span></td>
                    ${canViewFinancialInfo ? `<td class="font-mono">R$ ${parseFloat(student.amountPaid || 0).toFixed(2)}</td>` : ''}
                    <td>${student.responsibleName || 'N/A'}</td>
                    <td class="text-center">
                         ${canEdit ? `<button class="secondary-btn" data-action="edit-aluno" data-id="${student.id}" onclick="event.stopPropagation()">Editar</button>` : `<button class="secondary-btn" data-action="view-aluno" data-id="${student.id}" onclick="event.stopPropagation()">Ver</button>`}
                    </td>
                </tr>
            `).join('');
            
            updatePaginationControls(totalItems, totalPages, startIndex + 1, Math.min(endIndex, totalItems));
        }
        
        function updatePaginationControls(totalItems, totalPages, startItem, endItem) {
            const paginationInfo = document.getElementById('pagination-info');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            const pageNumbers = document.getElementById('page-numbers');
            
            if (totalItems === 0) {
                paginationInfo.textContent = 'Nenhum item encontrado';
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                pageNumbers.innerHTML = '';
                return;
            }
            
            paginationInfo.textContent = `Mostrando ${startItem}-${endItem} de ${totalItems} alunos`;
            
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;
            
            // Generate page numbers
            let pageNumbersHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentPage;
                pageNumbersHTML += `
                    <button class="page-number-btn ${isActive ? 'active' : ''}" data-page="${i}">
                        ${i}
                    </button>
                `;
            }
            
            pageNumbers.innerHTML = pageNumbersHTML;
            
            // Add click events to page number buttons
            document.querySelectorAll('.page-number-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentPage = parseInt(btn.dataset.page);
                    const filter = document.querySelector('#alunos-filter-buttons .filter-btn.active').dataset.filter;
                    updateAlunosList(filter);
                });
            });
        }
        
        // Reset pagination when switching sections
        function resetPagination() {
            currentPage = 1;
        }

        function renderTurmasSection() {
            document.getElementById('main-title').textContent = 'Gestão de Turmas';
            document.getElementById('main-description').textContent = 'Crie turmas, adicione alunos e registre as presenças.';
            
            const canManage = ['admin', 'pedagogico', 'ap'].includes(currentUserRole);
            let itemsToDisplay = turmas;
            if (currentUserRole === 'teacher') {
                itemsToDisplay = turmas.filter(t => t.teacherName === currentUserName);
            }

            contentArea.innerHTML = `
                <div id="turmas-section">
                    <div class="text-right mb-6">
                        ${canManage ? `<button class="primary-btn w-auto" data-action="add-turma">+ Adicionar Turma</button>` : ''}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${itemsToDisplay.map(t => `
                        <div class="base-card flex flex-col">
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="text-xl font-bold text-stone-800">${t.name}</h3>
                                    <span class="text-sm font-semibold text-stone-600">${(t.studentIds || []).length} aluno(s)</span>
                                </div>
                                <p class="text-sm text-stone-500 mb-2">Professor: ${t.teacherName}</p>
                                <p class="text-sm text-stone-600"><strong>Nível:</strong> ${t.level}</p>
                                <p class="text-sm text-stone-600"><strong>Semestre:</strong> ${t.semestre || 'N/A'}</p>
                            </div>
                            <div class="mt-auto pt-4 border-t border-stone-100 flex gap-2">
                                ${canManage ? `<button class="secondary-btn !text-sm flex-1" data-action="edit-turma" data-id="${t.id}">Editar</button>` : ''}
                                <button class="primary-btn !text-sm flex-1" data-action="open-turma-pef" data-id="${t.id}">PEF</button>
                            </div>
                        </div>`).join('') || '<p class="col-span-full text-center py-10 text-stone-500">Nenhuma turma encontrada.</p>'}
                    </div>
                </div>`;
        }

        function renderVipsSection() {
            document.getElementById('main-title').textContent = 'Gestão de VIPs';
            document.getElementById('main-description').textContent = 'Gerencie alunos VIP e registre suas presenças.';
            
            const canManage = ['admin', 'pedagogico', 'ap'].includes(currentUserRole);
            let itemsToDisplay = vips;
            if (currentUserRole === 'teacher') {
                itemsToDisplay = vips.filter(v => v.teacherName === currentUserName);
            }

            contentArea.innerHTML = `
                <div id="vips-section">
                    <div class="text-right mb-6">
                        ${canManage ? `<button class="primary-btn w-auto" data-action="add-vip">+ Adicionar VIP</button>` : ''}
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${itemsToDisplay.map(v => `
                        <div class="base-card flex flex-col">
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-2">
                                    <h3 class="text-xl font-bold text-stone-800">${v.studentName}</h3>
                                    <span class="status-tag tag-vip !text-white">VIP</span>
                                </div>
                                <p class="text-sm text-stone-500 mb-2">Professor: ${v.teacherName}</p>
                                <p class="text-sm text-stone-600"><strong>Nível:</strong> ${v.level}</p>
                                <p class="text-sm text-stone-600"><strong>Semestre:</strong> ${v.semestre || 'N/A'}</p>
                            </div>
                            <div class="mt-auto pt-4 border-t border-stone-100 flex gap-2">
                                ${canManage ? `<button class="secondary-btn !text-sm flex-1" data-action="edit-vip" data-id="${v.id}">Editar</button>` : ''}
                                <button class="primary-btn !text-sm flex-1" data-action="open-vip-pef" data-id="${v.id}">PEF</button>
                            </div>
                        </div>`).join('') || '<p class="col-span-full text-center py-10 text-stone-500">Nenhum aluno VIP encontrado.</p>'}
                    </div>
                </div>`;
        }

        function renderEventosSection() {
            document.getElementById('main-title').textContent = 'Gestor de Eventos';
            document.getElementById('main-description').textContent = 'Planeje e gerencie todos os eventos da marca.';
            contentArea.innerHTML = `
                <div id="events-section">
                    <div class="text-right mb-6">
                        <button class="primary-btn w-auto" data-action="add-event">+ Adicionar Evento</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${events.map(e => `
                        <div class="base-card cursor-pointer" data-action="view-event" data-id="${e.id}">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-bold text-stone-800">${e.nome}</h3>
                                ${e.setor ? `<span class="status-tag status-${e.setor.toLowerCase()}">${e.setor}</span>` : ''}
                            </div>
                            <p class="text-sm text-stone-500 mb-4">Data: ${new Date(e.data + 'T00:00:00').toLocaleDateString('pt-BR')} ${e.time ? `às ${e.time}`: ''}</p>
                            <p class="text-sm text-stone-600 truncate"><strong>Local:</strong> ${e.local}</p>
                        </div>`).join('') || '<p class="col-span-full text-center py-10 text-stone-500">Nenhum evento encontrado.</p>'}
                    </div>
                </div>`;
        }

        function renderOrcamentosSection() { document.getElementById('main-title').textContent = 'Gestor de Orçamentos'; document.getElementById('main-description').textContent = 'Registre e acompanhe todas as propostas e orçamentos.'; contentArea.innerHTML = `<div id="budgets-section"><div class="text-right mb-6"><button class="primary-btn w-auto" data-action="add-budget">+ Adicionar Orçamento</button></div><div class="space-y-4">${budgets.map(b => `<div class="base-card flex flex-wrap justify-between items-center gap-4 cursor-pointer" data-action="view-budget" data-id="${b.id}"><div class="flex-1"><h3 class="text-lg font-bold text-stone-800">${b.titulo}</h3><p class="text-sm text-stone-500">Feito por: ${b.criadoPor || 'N/A'} em ${b.dataCriacao ? new Date(b.dataCriacao).toLocaleDateString('pt-BR') : 'N/A'}</p></div><div class="text-right"><p class="text-xl font-bold text-stone-800">R$ ${parseFloat(b.valor || 0).toFixed(2)}</p><span class="status-tag status-${b.status.toLowerCase()}">${b.status}</span></div></div>`).join('') || '<p class="text-center py-10 text-stone-500">Nenhum orçamento encontrado.</p>'}</div></div>`; }
        
        function renderTarefasSection() { 
            document.getElementById('main-title').textContent = 'Lista de Tarefas'; 
            document.getElementById('main-description').textContent = 'Gerencie e acompanhe as tarefas da equipe.'; 
            
            const collaboratorOptions = collaborators.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

            contentArea.innerHTML = `
                <div id="tasks-section">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                        <div class="grade-select-container flex-grow">
                             <label for="task-filter" class="block text-sm font-medium text-stone-700 mb-1">Filtrar por colaborador:</label>
                             <select id="task-filter" class="grade-select">
                                <option value="all">Todos</option>
                                ${collaboratorOptions}
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button class="primary-btn w-auto" data-action="add-task">+ Adicionar Tarefa</button>
                        </div>
                    </div>
                    <div id="task-list-container" class="space-y-4"></div>
                </div>`; 
            document.getElementById('task-filter').addEventListener('change', () => updateTaskList());
            updateTaskList(); 
        }

        function updateTaskList() { 
            const container = document.getElementById('task-list-container'); 
            if (!container) return; 
            
            const filterValue = document.getElementById('task-filter')?.value || 'all';
            let filteredTasks = [...tasks]; 

            if (filterValue !== 'all') {
                filteredTasks = tasks.filter(task => task.assignedTo && task.assignedTo.includes(filterValue));
            }

            filteredTasks.sort((a, b) => a.completed - b.completed || new Date(a.deadline) - new Date(b.deadline)); 
            if (filteredTasks.length === 0) { container.innerHTML = `<div class="text-center p-8 bg-white rounded-lg"><p class="text-stone-500">Nenhuma tarefa encontrada para este filtro.</p></div>`; return; } 
            container.innerHTML = filteredTasks.map(task => { 
                const deadlineDate = new Date(task.deadline + 'T00:00:00'); 
                const isOverdue = !task.completed && deadlineDate < new Date(); 
                const deadlineClass = isOverdue ? 'deadline-overdue' : ''; 
                const formattedDate = deadlineDate.toLocaleDateString('pt-BR', { timeZone: 'UTC' }); 
                return `<div class="task-card flex items-start gap-4 ${task.completed ? 'completed' : ''}"><input type="checkbox" data-action="toggle-task" data-id="${task.id}" class="mt-1.5 h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-400" ${task.completed ? 'checked' : ''}><div class="flex-1"><p class="text-stone-800 font-medium">${task.description}</p><div class="mt-3 flex flex-wrap justify-between items-center gap-4"><div class="flex items-center gap-2 flex-wrap"><span class="text-xs text-stone-500">Para:</span>${(task.assignedTo || []).map(name => `<span class="user-tag" style="background-color: #e5e7eb; color: #374151;">${name}</span>`).join('')}</div><div class="text-right"><span class="text-xs text-stone-500">Prazo</span><p class="deadline-text ${deadlineClass}">${formattedDate}</p></div></div></div><button class="task-delete-btn" data-action="delete-item" data-collection="tasks" data-id="${task.id}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>`; 
            }).join(''); 
        }
        
        function renderGradeSection() {
            document.getElementById('main-title').textContent = 'Grade de Horários';
            document.getElementById('main-description').textContent = 'Visualize e gerencie a grade de aulas da equipe.';
            
            const isTeacher = currentUserRole === 'teacher';
            let filterHtml = '';
            
            if (!isTeacher) {
                const teacherOptions = collaborators.filter(c => c.sectors && c.sectors.includes('professor')).map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                filterHtml = `
                    <div class="grade-select-container flex-grow">
                        <label for="teacher-filter" class="block text-sm font-medium text-stone-700 mb-1">Filtrar por professor:</label>
                        <select id="teacher-filter" class="grade-select">
                            <option value="all">Todos</option>
                            ${teacherOptions}
                        </select>
                    </div>
                `;
            }

            const addAulaButton = ['admin', 'ap', 'pedagogico'].includes(currentUserRole)
                ? `<div class="flex gap-2">
                     <button class="primary-btn w-auto" data-action="add-schedule">+ Adicionar Aula</button>
                     <button class="secondary-btn w-auto" data-action="add-break">+ Adicionar Break</button>
                   </div>`
                : '';

            contentArea.innerHTML = `
                <section id="grade-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                        ${filterHtml}
                        <div class="flex gap-2 ml-auto">
                           ${addAulaButton}
                        </div>
                    </div>
                    <div id="weekly-hours-container" class="mb-6"></div>
                    <div id="schedule-grid-container"></div>
                </section>
            `;

            if (isTeacher) {
                // Find the teacher's name in collaborators to ensure correct mapping
                const teacherCollaborator = collaborators.find(c => 
                    c.sectors && c.sectors.includes('professor') && 
                    (c.name === currentUserName || c.email === currentUserName || c.id === userId)
                );
                const originalTeacherName = teacherCollaborator ? teacherCollaborator.name : currentUserName;
                
                // Use smart name matching to find the actual teacher name in schedules
                const teacherNameToFilter = findTeacherByName(originalTeacherName) || originalTeacherName;
                
                // Show debug info if teacher has no schedules
                const teacherSchedules = schedules.filter(s => s.teacher === teacherNameToFilter);
                if (teacherSchedules.length === 0) {
                    console.log('DEBUG: Teacher schedule mapping', {
                        currentUserName,
                        originalTeacherName,
                        teacherNameToFilter,
                        availableTeachersInSchedules: [...new Set(schedules.map(s => s.teacher))],
                        collaboratorTeachers: collaborators.filter(c => c.sectors && c.sectors.includes('professor')).map(c => c.name),
                        smartMappingResult: findTeacherByName(originalTeacherName)
                    });
                    
                    // Show helper message for teachers
                    const availableTeachers = [...new Set(schedules.map(s => s.teacher))];
                    if (availableTeachers.length > 0) {
                        document.getElementById('schedule-grid-container').innerHTML = `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                                <div class="mb-4">
                                    <svg class="w-16 h-16 mx-auto text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.662-.833-2.464 0L4.732 15.5c-.77.833.192 2.5 1.732 2.5z"/>
                                    </svg>
                                </div>
                                <h3 class="text-lg font-semibold text-yellow-800 mb-2">Grade não encontrada</h3>
                                <p class="text-yellow-700 mb-4">Não encontramos horários para o seu nome de usuário.</p>
                                <div class="bg-white rounded-lg p-4 mb-4">
                                    <p class="text-sm text-gray-600 mb-2"><strong>Seu nome no sistema:</strong> ${currentUserName}</p>
                                    <p class="text-sm text-gray-600 mb-2"><strong>Professores com horários cadastrados:</strong></p>
                                    <div class="text-sm text-gray-800 font-medium">${availableTeachers.join(', ')}</div>
                                </div>
                                <p class="text-yellow-700 text-sm">Entre em contato com o administrador para ajustar o mapeamento do seu nome.</p>
                            </div>
                        `;
                        return;
                    }
                }
                
                renderScheduleGrid(teacherNameToFilter);
            } else {
                const teacherFilter = document.getElementById('teacher-filter');
                if (teacherFilter) {
                    teacherFilter.addEventListener('change', () => renderScheduleGrid(teacherFilter.value));
                }
                renderScheduleGrid('all');
            }
        }

        // Helper function to find teacher by first name matching
        function findTeacherByName(searchName) {
            if (!searchName) return null;
            
            // First try exact match
            const exactMatch = schedules.find(s => s.teacher === searchName);
            if (exactMatch) return searchName;
            
            // Then try first name matching
            const searchFirstName = searchName.trim().split(' ')[0].toLowerCase();
            const teachers = [...new Set(schedules.map(s => s.teacher))];
            
            const firstNameMatch = teachers.find(teacher => {
                const teacherFirstName = teacher.trim().split(' ')[0].toLowerCase();
                return teacherFirstName === searchFirstName;
            });
            
            return firstNameMatch || null;
        }

        function calculateWeeklyHours(teacherName) {
            const actualTeacherName = findTeacherByName(teacherName) || teacherName;
            const teacherSchedules = schedules.filter(s => s.teacher === actualTeacherName && s.type !== 'break');
            
            let totalHours = 0;
            teacherSchedules.forEach(schedule => {
                const duration = calculateClassDuration(schedule.startTime, schedule.endTime);
                totalHours += duration;
            });
            
            return totalHours;
        }

        function calculateClassDuration(startTime, endTime) {
            // Convert time strings (HH:MM) to minutes
            const [startHour, startMinute] = startTime.split(':').map(Number);
            const [endHour, endMinute] = endTime.split(':').map(Number);
            
            const startTotalMinutes = startHour * 60 + startMinute;
            const endTotalMinutes = endHour * 60 + endMinute;
            
            // Calculate duration in hours
            const durationMinutes = endTotalMinutes - startTotalMinutes;
            const durationHours = durationMinutes / 60;
            
            return durationHours;
        }

        function checkTimeConflict(teacher, day, startTime, endTime, excludeId = null) {
            return schedules.some(s => 
                s.teacher === teacher && 
                s.day === day && 
                s.id !== excludeId &&
                ((startTime >= s.startTime && startTime < s.endTime) || 
                 (endTime > s.startTime && endTime <= s.endTime) ||
                 (startTime <= s.startTime && endTime >= s.endTime))
            );
        }

        function renderScheduleGrid(teacherFilter) {
            const gridContainer = document.getElementById('schedule-grid-container');
            const hoursContainer = document.getElementById('weekly-hours-container');
            if (!gridContainer) return;

            const days = ["Segunda", "Terça", "Quarta", "Quinta", "Sexta"];
            let filteredSchedules = [...schedules];

            if (teacherFilter !== 'all') {
                const actualTeacherName = findTeacherByName(teacherFilter) || teacherFilter;
                filteredSchedules = filteredSchedules.filter(s => s.teacher === actualTeacherName);
            }
            
            // Debug log for teachers to help identify mapping issues
            if (currentUserRole === 'teacher' && teacherFilter !== 'all') {
                console.log('DEBUG: Grade filtering for teacher', {
                    teacherFilter,
                    currentUserName,
                    currentUserRole,
                    filteredSchedulesCount: filteredSchedules.length,
                    allSchedulesCount: schedules.length,
                    uniqueTeachers: [...new Set(schedules.map(s => s.teacher))]
                });
            }

            // Show weekly hours for specific teacher or all teachers summary
            const canViewAllHours = ['admin', 'pedagogico', 'ap'].includes(currentUserRole);
            
            if (teacherFilter !== 'all' && hoursContainer) {
                const weeklyHours = calculateWeeklyHours(teacherFilter);
                hoursContainer.innerHTML = `
                    <div class="rounded-lg p-4 text-center border" style="background-color: #F1D24B20; border-color: #F1D24B40;">
                        <div class="text-sm font-medium uppercase tracking-wide text-stone-700">Carga Horária Semanal</div>
                        <div class="text-3xl font-bold mt-1 text-stone-800">${weeklyHours} horas</div>
                        <div class="text-xs mt-1 text-stone-600">${teacherFilter}</div>
                    </div>
                `;
            } else if (teacherFilter === 'all' && canViewAllHours && hoursContainer) {
                // Show summary of all teachers' hours
                const teacherHours = {};
                const teachers = collaborators.filter(c => c.sectors && c.sectors.includes('professor'));
                
                teachers.forEach(teacher => {
                    teacherHours[teacher.name] = calculateWeeklyHours(teacher.name);
                });
                
                const totalHours = Object.values(teacherHours).reduce((sum, hours) => sum + hours, 0);
                
                hoursContainer.innerHTML = `
                    <div class="rounded-lg p-4 border" style="background-color: #F1D24B20; border-color: #F1D24B40;">
                        <div class="text-sm font-medium text-stone-700 uppercase tracking-wide mb-3 text-center">Resumo da Carga Horária Semanal</div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 mb-3">
                            ${Object.entries(teacherHours).map(([name, hours]) => `
                                <div class="rounded-lg p-3 text-center border" style="background-color: #F1D24B20; border-color: #F1D24B40;">
                                    <div class="text-sm font-medium uppercase tracking-wide text-stone-700">Carga Semanal</div>
                                    <div class="text-2xl font-bold mt-1 text-stone-800">${hours} horas</div>
                                    <div class="text-xs mt-1 text-stone-600">${name}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="text-center pt-3" style="border-top: 1px solid #F1D24B40;">
                            <div class="text-sm text-stone-700">Total Geral</div>
                            <div class="text-2xl font-bold text-stone-800">${totalHours} horas</div>
                        </div>
                    </div>
                `;
            } else if (hoursContainer) {
                hoursContainer.innerHTML = '';
            }
            
            // Show message if no schedules found for teacher role
            if (currentUserRole === 'teacher' && filteredSchedules.length === 0) {
                return; // Already handled above
            }

            let gridHtml = `<div class="schedule-grid">`;
            days.forEach(day => {
                gridHtml += `<div class="day-column"><h3 class="day-column-header">${day}</h3>`;
                const dayClasses = filteredSchedules.filter(s => s.day === day).sort((a, b) => a.startTime.localeCompare(b.startTime));
                if (dayClasses.length > 0) {
                    dayClasses.forEach(c => {
                        let tagClass, tagText;
                        if (c.type === 'break') {
                            tagClass = 'tag-break';
                            tagText = 'BREAK';
                        } else if (c.type === 'vip') {
                            tagClass = 'tag-vip';
                            tagText = 'VIP';
                        } else {
                            tagClass = 'tag-turma';
                            tagText = 'TURMA';
                        }
                        
                        const teacherName = teacherFilter === 'all' ? `<p class="text-xs text-stone-500"><em>(${c.teacher})</em></p>` : '';
                        const studentInfo = c.type === 'break' ? 
                            `<p class="font-bold text-stone-600">Intervalo</p>` : 
                            `<p class="font-bold text-stone-800">${c.student}</p><p class="text-sm text-stone-700">${c.level}</p>`;
                        
                        gridHtml += `
                            <div class="class-entry" data-action="view-schedule" data-id="${c.id}">
                                <span class="class-tag ${tagClass}">${tagText}</span>
                                <p class="text-xs text-stone-600">${c.startTime} - ${c.endTime}</p>
                                ${studentInfo}
                                ${teacherName}
                            </div>`;
                    });
                } else {
                    gridHtml += `<p class="text-sm text-center text-stone-400 mt-4">Nenhuma aula</p>`;
                }
                gridHtml += `</div>`;
            });
            gridHtml += `</div>`;
            gridContainer.innerHTML = gridHtml;
        }

        function renderFolhaPagamentoSection() {
            document.getElementById('main-title').textContent = 'Folha de Pagamento';
            document.getElementById('main-description').textContent = 'Gerencie as despesas e contas a pagar do mês.';
            
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const monthName = now.toLocaleString('pt-BR', { month: 'long' });

            const monthlyExpenses = expenses.map(exp => {
                let dueDate;
                if (exp.isFixedSalary && exp.dueDay) {
                    const day = parseInt(exp.dueDay, 10);
                    if (day > 0 && day < 32) {
                       dueDate = new Date(currentYear, currentMonth, day);
                    }
                } else if (exp.dueDate) {
                    // Create date as UTC to avoid timezone issues with date-only strings
                    const parts = exp.dueDate.split('-');
                    dueDate = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
                }

                if (dueDate && dueDate.getUTCMonth() === currentMonth && dueDate.getUTCFullYear() === currentYear) {
                    return { ...exp, effectiveDueDate: dueDate };
                }
                return null;
            }).filter(Boolean).sort((a, b) => a.effectiveDueDate - b.effectiveDueDate);

            const totalToPay = monthlyExpenses
                .filter(exp => !exp.isPaid)
                .reduce((sum, exp) => sum + Number(exp.amount), 0);

            contentArea.innerHTML = `
                <section id="folha-pagamento-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                         <h3 class="text-xl font-bold text-stone-800">Despesas de ${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</h3>
                         <button class="primary-btn w-auto" data-action="add-expense">+ Nova Despesa</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Pago</th>
                                    <th>Descrição</th>
                                    <th>Vencimento</th>
                                    <th class="text-right">Valor (R$)</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="expenses-list">
                                ${monthlyExpenses.length > 0 ? monthlyExpenses.map(exp => `
                                    <tr class="${exp.isPaid ? 'paid' : ''}">
                                        <td class="text-center"><input type="checkbox" data-action="toggle-expense" data-id="${exp.id}" class="h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-400" ${exp.isPaid ? 'checked' : ''}></td>
                                        <td class="font-medium cursor-pointer" data-action="view-expense" data-id="${exp.id}">${exp.description} ${exp.isFixedSalary && exp.employeeRole ? `<span class="sector-tag">${exp.employeeRole}</span>` : ''}</td>
                                        <td class="cursor-pointer" data-action="view-expense" data-id="${exp.id}">${exp.effectiveDueDate.toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</td>
                                        <td class="text-right font-mono cursor-pointer" data-action="view-expense" data-id="${exp.id}">${Number(exp.amount).toFixed(2)}</td>
                                        <td class="text-center">
                                            <button class="task-delete-btn" data-action="delete-item" data-collection="expenses" data-id="${exp.id}">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('') : '<tr><td colspan="5" class="text-center py-8 text-stone-500">Nenhuma despesa para este mês.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                    <div class="data-total">
                        <p>Total a Pagar: ${totalToPay.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                    </div>
                </section>
            `;
        }
        
        function renderCancelamentosSection() {
            document.getElementById('main-title').textContent = 'Registro de Cancelamentos';
            document.getElementById('main-description').textContent = 'Gerencie todos os cancelamentos de matrículas.';
            const canAdd = ['admin', 'financeiro'].includes(currentUserRole);
            
            contentArea.innerHTML = `
                <section id="cancellations-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                     <div class="text-right mb-6">
                         ${canAdd ? `<button class="primary-btn w-auto" data-action="add-cancelamento">+ Adicionar Cancelamento</button>` : ''}
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Aluno</th>
                                    <th>Data do Cancelamento</th>
                                    <th>Motivo</th>
                                    <th>Processado Por</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${cancellations.map(c => `
                                <tr class="cursor-pointer" data-action="view-cancelamento" data-id="${c.id}">
                                    <td class="font-medium">${c.studentName}</td>
                                    <td>${new Date(c.cancellationDate + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                                    <td>${c.reason}</td>
                                    <td>${c.processedBy}</td>
                                </tr>
                                `).join('') || '<tr><td colspan="4" class="text-center py-10 text-stone-500">Nenhum cancelamento encontrado.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
        }
        
        function renderColaboradoresSection() {
            document.getElementById('main-title').textContent = 'Gestão de Colaboradores';
            document.getElementById('main-description').textContent = 'Adicione, edite e defina os setores de cada colaborador.';
            contentArea.innerHTML = `
                <section id="colaboradores-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="text-right mb-6">
                        <button class="primary-btn w-auto" data-action="add-collaborator">+ Adicionar Colaborador</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Setores</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${collaborators.map(c => `
                                    <tr>
                                        <td class="font-medium">${c.name}</td>
                                        <td>${(c.sectors || []).map(s => `<span class="sector-tag">${s}</span>`).join('')}</td>
                                        <td class="text-center">
                                            <button class="secondary-btn" data-action="edit-collaborator" data-id="${c.id}">Editar</button>
                                            <button class="danger-btn ml-2" data-action="delete-item" data-collection="collaborators" data-id="${c.id}">Excluir</button>
                                        </td>
                                    </tr>
                                `).join('') || '<tr><td colspan="3" class="text-center py-10 text-stone-500">Nenhum colaborador encontrado.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
        }



        function renderCPsSection() {
            document.getElementById('main-title').textContent = 'Cronogramas Pedagógicos (CPs)';
            document.getElementById('main-description').textContent = 'Gerencie os níveis e aulas dos cursos.';
            const canEdit = ['pedagogico', 'ap', 'admin'].includes(currentUserRole);
            const addNivelBtn = canEdit ? `<button class="primary-btn w-auto" data-action="add-nivel">+ Adicionar Nível</button>` : '';

            contentArea.innerHTML = `
                <section id="cps-section">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                        <h3 class="text-xl font-bold text-stone-800">Níveis do Curso</h3>
                        <div class="flex gap-2">
                           <button class="secondary-btn w-auto" data-action="export-cps-doc">Exportar CPs</button>
                           ${addNivelBtn}
                        </div>
                    </div>
                    <div id="cp-list-container">
                        ${cps.map((nivel, index) => `
                            <div class="cp-level-card" id="nivel-${nivel.id}">
                                <div class="cp-level-header" data-action="toggle-cp-level" data-id="${nivel.id}">
                                    <h4 class="text-lg font-bold text-stone-800">${nivel.title}</h4>
                                    <div class="flex items-center gap-2">
                                        ${canEdit ? `
                                        <button class="secondary-btn text-xs p-1" data-action="reorder-cp" data-id="${nivel.id}" data-direction="up" ${index === 0 ? 'disabled' : ''}>↑</button>
                                        <button class="secondary-btn text-xs p-1" data-action="reorder-cp" data-id="${nivel.id}" data-direction="down" ${index === cps.length - 1 ? 'disabled' : ''}>↓</button>
                                        <button class="secondary-btn text-xs" data-action="add-aula" data-nivel-id="${nivel.id}">+ Aula</button>
                                        <button class="secondary-btn text-xs" data-action="edit-nivel" data-id="${nivel.id}">Editar</button>
                                        <button class="danger-btn text-xs" data-action="delete-item" data-collection="cps" data-id="${nivel.id}">X</button>` : ''}
                                        <svg class="h-6 w-6 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                                    </div>
                                </div>
                                <div class="cp-level-content">
                                    ${(nivel.lessons && nivel.lessons.length > 0) ? nivel.lessons.map((aula, index) => `
                                        <div class="cp-lesson-item">
                                            <div>
                                                <p class="font-semibold">${index + 1}. ${aula.title}</p>
                                                <p class="text-sm text-stone-600">${aula.topic}</p>
                                                <div class="mt-2 flex flex-wrap">${(aula.keywords || []).map(k => `<span class="keyword-tag">${k}</span>`).join('')}</div>
                                            </div>
                                            ${canEdit ? `
                                            <div>
                                                <button class="secondary-btn text-xs" data-action="edit-aula" data-nivel-id="${nivel.id}" data-aula-index="${index}">Editar</button>
                                                <button class="danger-btn text-xs" data-action="delete-aula" data-nivel-id="${nivel.id}" data-aula-index="${index}">X</button>
                                            </div>
                                            ` : ''}
                                        </div>
                                    `).join('') : '<p class="text-center text-stone-500 py-4">Nenhuma aula adicionada.</p>'}
                                </div>
                            </div>
                        `).join('') || '<p class="text-center py-10 text-stone-500">Nenhum nível cadastrado.</p>'}
                    </div>
                </section>
            `;
        }
        
        function renderDojoSection() {
            document.getElementById('main-title').textContent = 'SLAP Dojo';
            document.getElementById('main-description').textContent = 'Gerencie a pontuação dos competidores e as missões ativas.';
            const canEdit = ['admin', 'ap'].includes(currentUserRole);
            const addCompetitorBtn = canEdit ? `<button class="primary-btn w-auto" data-action="add-dojo-competitor">+ Adicionar Competidor</button>` : '';
            const addMissionBtn = canEdit ? `<button class="primary-btn w-auto" data-action="add-dojo-mission">+ Adicionar Missão</button>` : '';

            const sortedRanking = [...dojoRanking].sort((a, b) => b.points - a.points);

            contentArea.innerHTML = `
                <section id="dojo-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="text-xl font-bold text-stone-800">Ranking de Competidores</h3>
                        ${addCompetitorBtn}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-10 text-center">
                        <div class="p-4 rounded-lg border-2 border-stone-300 bg-stone-50 order-2 md:order-1">
                            <h4 class="font-bold text-lg text-amber-500">🥈 2º Lugar</h4>
                            <p class="text-stone-600">Alexa Echo Dot + R$500 </p>
                        </div>
                        <div class="p-4 rounded-lg border-2 border-yellow-400 bg-yellow-50 transform md:scale-110 order-1 md:order-2">
                            <h4 class="font-bold text-lg text-yellow-500">🥇 1º Lugar</h4>
                            <p class="text-stone-700 font-semibold">R$1000 + jantar + folga</p>
                        </div>
                        <div class="p-4 rounded-lg border-2 border-amber-600 bg-stone-50 order-3 md:order-3">
                            <h4 class="font-bold text-lg text-amber-700">🥉 3º Lugar</h4>
                            <p class="text-stone-600">R$250 + mimo</p>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Pos.</th>
                                    <th>Competidor</th>
                                    <th class="text-right">Pontos</th>
                                    ${canEdit ? '<th class="text-center">Ações</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedRanking.map((c, index) => {
                                    const medals = ['🥇', '🥈', '🥉'];
                                    const medal = index < 3 ? `<span class="text-xl ml-2">${medals[index]}</span>` : '';
                                    return `
                                    <tr>
                                        <td class="font-bold text-stone-500 text-lg">#${index + 1}</td>
                                        <td class="flex items-center gap-3">
                                            <img src="${c.photo}" alt="${c.name}" class="w-10 h-10 rounded-full object-cover">
                                            <span class="font-medium">${c.name}</span>
                                            ${medal}
                                        </td>
                                        <td class="text-right font-mono font-semibold">${c.points || 0}</td>
                                        ${canEdit ? `
                                        <td class="text-center">
                                            <button class="secondary-btn" data-action="edit-dojo-points" data-id="${c.id}">Editar</button>
                                            <button class="danger-btn ml-2" data-action="delete-item" data-collection="dojo_ranking" data-id="${c.id}">X</button>
                                        </td>
                                        ` : ''}
                                    </tr>
                                `}).join('') || '<tr><td colspan="4" class="text-center py-10 text-stone-500">Nenhum competidor no Dojo.</td></tr>'}
                            </tbody>
                        </table>
                    </div>

                    <!-- Missões Ativas Section -->
                    <div class="mt-12 pt-8 border-t border-stone-200">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-stone-800">Missões Ativas</h3>
                            ${addMissionBtn}
                        </div>
                        <div id="dojo-missions-list" class="space-y-3">
                            ${dojoMissions.length > 0 ? dojoMissions.map(mission => `
                                <div class="base-card !p-4 flex justify-between items-center">
                                    <p class="font-medium text-stone-700 flex-1 pr-4">${mission.description}</p>
                                    <div class="flex items-center gap-4">
                                        <span class="font-bold text-lg text-yellow-500 whitespace-nowrap">${mission.points} pts</span>
                                        ${canEdit ? `<button class="danger-btn !text-xs !py-1 !px-2" data-action="delete-item" data-collection="dojo_missions" data-id="${mission.id}">Excluir</button>` : ''}
                                    </div>
                                </div>
                            `).join('') : '<div class="text-center p-8 bg-stone-50 rounded-lg"><p class="text-stone-500">Nenhuma missão ativa no momento.</p></div>'}
                        </div>
                    </div>
                </section>
            `;
        }


        // --- MODAL & FORM FUNCTIONS ---
        function clearModalHeaderButtons() {
            const header = document.getElementById('modal-header-container');
            const title = header.querySelector('#form-modal-title');
            const closeBtn = header.querySelector('.modal-close-btn');
            header.innerHTML = '';
            header.appendChild(title);
            header.appendChild(closeBtn);
        }
        function closeFormModal() { 
            const modal = document.getElementById('form-modal');
            modal.classList.remove('visible'); 
            clearModalHeaderButtons();
            // Clear attributes to prevent listener conflicts
            modal.removeAttribute('data-pef-modal');
            modal.removeAttribute('data-unit-id');
            modal.removeAttribute('data-pef-type');
            modal.removeAttribute('data-student-name');
        }
        function showSuccessMessage(title, message) { clearModalHeaderButtons(); const modalTitle = document.getElementById('form-modal-title'); const modalContentArea = document.getElementById('form-modal-content-area'); modalTitle.textContent = title; modalContentArea.innerHTML = `<div class="text-center"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="mt-4 text-stone-600">${message}</p><button data-action="close-modal" class="primary-btn mt-6 w-auto px-8">OK</button></div>`; document.getElementById('form-modal').classList.add('visible'); }
        function showErrorMessage(title, message) { clearModalHeaderButtons(); const modalTitle = document.getElementById('form-modal-title'); const modalContentArea = document.getElementById('form-modal-content-area'); modalTitle.textContent = title; modalContentArea.innerHTML = `<div class="text-center"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="mt-4 text-stone-600">${message}</p><button data-action="close-modal" class="primary-btn mt-6 w-auto px-8">OK</button></div>`; document.getElementById('form-modal').classList.add('visible'); }
        function showConfirmationModal(title, message, onConfirm) { clearModalHeaderButtons(); const modalTitle = document.getElementById('form-modal-title'); const modalContentArea = document.getElementById('form-modal-content-area'); modalTitle.textContent = title; modalContentArea.innerHTML = `<p class="text-stone-600">${message}</p><div class="mt-6 flex justify-end gap-4"><button class="secondary-btn" data-action="close-modal">Cancelar</button><button id="confirm-action-btn" class="danger-btn w-auto">Confirmar</button></div>`; document.getElementById('form-modal').classList.add('visible'); document.getElementById('confirm-action-btn').onclick = () => { onConfirm(); closeFormModal(); }; }
        
        function openSignUpModal() {
            clearModalHeaderButtons();
            const modalTitle = document.getElementById('form-modal-title');
            const modalContentArea = document.getElementById('form-modal-content-area');
            
            modalTitle.textContent = "Criar Nova Conta";
            modalContentArea.innerHTML = `
                <form id="signup-form" class="space-y-4">
                    <div><label for="signup-name" class="font-medium text-sm">Nome Completo</label><input type="text" id="signup-name" name="name" required class="form-input mt-1"></div>
                    <div><label for="signup-email" class="font-medium text-sm">E-mail</label><input type="email" id="signup-email" name="email" required class="form-input mt-1"></div>
                    <div><label for="signup-password" class="font-medium text-sm">Senha (mín. 6 caracteres)</label><input type="password" id="signup-password" name="password" required class="form-input mt-1"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Cadastrar</button></div>
                </form>
            `;
            document.getElementById('signup-form').addEventListener('submit', handleSignUp);
            document.getElementById('form-modal').classList.add('visible');
        }

        function openAlunoForm(alunoId = null) {
            clearModalHeaderButtons();
            const aluno = alunoId ? students.find(s => s.id === alunoId) : null;
            document.getElementById('form-modal-title').textContent = aluno ? "Editar Aluno" : "Adicionar Novo Aluno";
            
            const statusOptions = ['Ativo', 'Inativo', 'Cancelado', 'Pendente'].map(s => `<option value="${s}" ${aluno?.status === s ? 'selected' : ''}>${s}</option>`).join('');
            const paymentTypeOptions = ['Cartão', 'Boleto', 'Permuta', 'Bolsa'].map(p => `<option value="${p}" ${aluno?.paymentType === p ? 'selected' : ''}>${p}</option>`).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="aluno-id" value="${alunoId || ''}">
                    
                    <h4 class="text-lg font-semibold text-stone-700 border-b pb-2">Informações Básicas</h4>
                    <div><label class="font-medium text-sm">Nome Completo do Aluno</label><input type="text" id="aluno-name" class="form-input" required value="${aluno?.name || ''}"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="font-medium text-sm">Status</label><select id="aluno-status" class="form-input">${statusOptions}</select></div>
                        <div><label class="font-medium text-sm">Data de Início</label><input type="date" id="aluno-startDate" class="form-input" value="${aluno?.startDate || ''}"></div>
                    </div>
                    <div>
                        <label class="font-medium text-sm">Níveis Cursados</label>
                        <div id="aluno-levels-checkboxes" class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-y-2 gap-x-4 max-h-40 overflow-y-auto p-2 border rounded-md">
                            ${cps.map(cp => `
                                <div class="flex items-center">
                                    <input type="checkbox" id="level-${cp.id}" name="completedLevels" value="${cp.title}" class="h-4 w-4 rounded text-yellow-500 focus:ring-yellow-400" ${aluno?.completedLevels?.includes(cp.title) ? 'checked' : ''}>
                                    <label for="level-${cp.id}" class="ml-2 text-sm">${cp.title}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <h4 class="text-lg font-semibold text-stone-700 border-b pb-2 pt-4">Informações Financeiras</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="font-medium text-sm">Tipo de Pagamento</label><select id="aluno-paymentType" class="form-input">${paymentTypeOptions}</select></div>
                        <div><label class="font-medium text-sm">Valor Pago (R$)</label><input type="number" step="0.01" id="aluno-amountPaid" class="form-input" value="${aluno?.amountPaid || ''}"></div>
                        <div><label class="font-medium text-sm">Valor Recebido (R$)</label><input type="number" step="0.01" id="aluno-amountReceived" class="form-input" value="${aluno?.amountReceived || ''}"></div>
                    </div>

                    <h4 class="text-lg font-semibold text-stone-700 border-b pb-2 pt-4">Responsável</h4>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="aluno-isMinor" class="h-4 w-4 rounded" ${aluno?.isMinor ? 'checked' : ''}>
                        <label for="aluno-isMinor" class="text-sm font-medium">Menor de idade?</label>
                    </div>
                    <div id="responsible-fields" class="${aluno?.isMinor ? '' : 'hidden'} space-y-4">
                        <div><label class="font-medium text-sm">Nome do Responsável</label><input type="text" id="aluno-responsibleName" class="form-input" value="${aluno?.responsibleName || ''}"></div>
                        <div><label class="font-medium text-sm">Telefone do Responsável</label><input type="tel" id="aluno-responsiblePhone" class="form-input" value="${aluno?.responsiblePhone || ''}"></div>
                    </div>
                    
                    <h4 class="text-lg font-semibold text-stone-700 border-b pb-2 pt-4">Outras Informações</h4>
                    <div><label class="font-medium text-sm">Observações</label><textarea id="aluno-notes" rows="3" class="form-input">${aluno?.notes || ''}</textarea></div>
                    
                    <div class="text-right pt-4"><button type="submit" class="primary-btn w-auto">Salvar Aluno</button></div>
                </form>
            `;

            document.getElementById('aluno-isMinor').addEventListener('change', (e) => {
                document.getElementById('responsible-fields').classList.toggle('hidden', !e.target.checked);
            });

            document.getElementById('form-modal-body').onsubmit = saveAluno;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveAluno(event) {
            event.preventDefault();
            const alunoId = document.getElementById('aluno-id').value;
            const isMinor = document.getElementById('aluno-isMinor').checked;
            
            const completedLevels = Array.from(document.querySelectorAll('input[name="completedLevels"]:checked')).map(cb => cb.value);

            const data = {
                name: document.getElementById('aluno-name').value,
                status: document.getElementById('aluno-status').value,
                startDate: document.getElementById('aluno-startDate').value,
                completedLevels: completedLevels,
                paymentType: document.getElementById('aluno-paymentType').value,
                amountPaid: document.getElementById('aluno-amountPaid').value,
                amountReceived: document.getElementById('aluno-amountReceived').value,
                notes: document.getElementById('aluno-notes').value,
                isMinor: isMinor,
                responsibleName: isMinor ? document.getElementById('aluno-responsibleName').value : '',
                responsiblePhone: isMinor ? document.getElementById('aluno-responsiblePhone').value : '',
            };
            if (!data.name) { showErrorMessage("Erro", "O nome do aluno é obrigatório."); return; }

            try {
                if (alunoId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/students`, alunoId), data);
                    showSuccessMessage("Sucesso!", "Dados do aluno atualizados.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/students`), data);
                    showSuccessMessage("Sucesso!", "Novo aluno cadastrado.");
                }
            } catch (error) {
                console.error("Error saving student:", error);
                showErrorMessage("Erro", "Falha ao salvar os dados do aluno.");
            }
        }

        function openAlunoModal(alunoId) {
            clearModalHeaderButtons();
            const aluno = students.find(s => s.id === alunoId);
            if (!aluno) return;
            document.getElementById('form-modal-title').textContent = `Perfil de ${aluno.name}`;
            const canEdit = ['admin', 'financeiro', 'pedagogico', 'ap'].includes(currentUserRole);
            
            let responsibleHtml = '';
            if (aluno.isMinor && aluno.responsibleName) {
                responsibleHtml = `
                    <div class="mt-4 pt-4 border-t">
                        <h4 class="font-semibold text-stone-700">Dados do Responsável</h4>
                        <p class="text-sm text-stone-600 mt-1"><strong>Nome:</strong> ${aluno.responsibleName || 'N/A'}</p>
                        <p class="text-sm text-stone-600"><strong>Telefone:</strong> ${aluno.responsiblePhone || 'N/A'}</p>
                    </div>
                `;
            }

            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold text-stone-800">${aluno.name}</h3>
                        <span class="status-tag status-${(aluno.status || 'pendente').toLowerCase()}">${aluno.status || 'Pendente'}</span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-sm text-stone-600">
                        <p><strong>Início:</strong> ${aluno.startDate ? new Date(aluno.startDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</p>
                        <p><strong>Pagamento:</strong> ${aluno.paymentType || 'N/A'}</p>
                        <p><strong>Valor Pago:</strong> R$ ${parseFloat(aluno.amountPaid || 0).toFixed(2)}</p>
                        <p><strong>Valor Recebido:</strong> R$ ${parseFloat(aluno.amountReceived || 0).toFixed(2)}</p>
                    </div>

                    <div class="pt-2">
                        <p class="font-semibold text-sm text-stone-700">Níveis Cursados:</p>
                        <div class="flex flex-wrap gap-2 mt-1">
                            ${(aluno.completedLevels && aluno.completedLevels.length > 0) ? aluno.completedLevels.map(level => `<span class="keyword-tag !m-0">${level}</span>`).join('') : '<span class="text-sm text-stone-500">Nenhum</span>'}
                        </div>
                    </div>
                    
                    ${responsibleHtml}

                    ${aluno.notes ? `<div class="mt-4 pt-4 border-t"><strong>Observações:</strong><p class="mt-1 p-3 bg-stone-50 rounded-md whitespace-pre-wrap text-sm">${aluno.notes}</p></div>` : ''}
                    
                    <div class="border-t pt-4 flex justify-end gap-2">
                        ${canEdit ? `<button class="secondary-btn" data-action="edit-aluno" data-id="${aluno.id}">Editar</button>
                        <button class="danger-btn" data-action="delete-item" data-collection="students" data-id="${aluno.id}">Apagar</button>` : ''}
                    </div>
                </div>`;
            document.getElementById('form-modal').classList.add('visible');
        }

        function openTurmaForm(turmaId = null) {
            clearModalHeaderButtons();
            const turma = turmaId ? turmas.find(t => t.id === turmaId) : null;
            document.getElementById('form-modal-title').textContent = turma ? "Editar Turma" : "Adicionar Nova Turma";

            const teacherOptions = collaborators.filter(c => c.sectors?.includes('professor')).map(c => `<option value="${c.id}" data-name="${c.name}" ${turma?.teacherId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
            const levelOptions = cps.map(cp => `<option value="${cp.title}" ${turma?.level === cp.title ? 'selected' : ''}>${cp.title}</option>`).join('') + `<option value="outro">Outro (especificar)</option>`;
            
            const studentCheckboxes = students
                .filter(s => s.status === 'Ativo')
                .sort((a, b) => a.name.localeCompare(b.name))
                .map(s => `
                    <div class="flex items-center">
                        <input type="checkbox" id="student-${s.id}" value="${s.id}" name="turma-students" class="h-4 w-4 rounded" ${(turma?.studentIds || []).includes(s.id) ? 'checked' : ''}>
                        <label for="student-${s.id}" class="ml-2 text-sm">${s.name}</label>
                    </div>
                `).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="turma-id" value="${turmaId || ''}">
                    <div><label class="font-medium text-sm">Nome da Turma</label><input type="text" id="turma-name" class="form-input" required value="${turma?.name || ''}"></div>
                    <div><label class="font-medium text-sm">Professor</label><select id="turma-teacher" class="form-input" required>${teacherOptions}</select></div>
                    <div>
                        <label class="font-medium text-sm">Nível</label>
                        <select id="turma-level" class="form-input" required>${levelOptions}</select>
                        <input type="text" id="turma-level-custom" class="form-input mt-2 hidden" placeholder="Digite o nível personalizado">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div><label class="font-medium text-sm">Semestre</label><input type="text" id="turma-semestre" class="form-input" value="${turma?.semestre || ''}"></div>
                        <div><label class="font-medium text-sm">Data de Início</label><input type="date" id="turma-startDate" class="form-input" value="${turma?.startDate || ''}"></div>
                        <div><label class="font-medium text-sm">Data de Finalização</label><input type="date" id="turma-endDate" class="form-input" value="${turma?.endDate || ''}"></div>
                    </div>
                    <div>
                        <label class="font-medium text-sm">Alunos</label>
                        <div id="turma-students-checkboxes" class="mt-2 grid grid-cols-2 sm:grid-cols-3 gap-y-2 gap-x-4 max-h-48 overflow-y-auto p-3 border rounded-md bg-stone-50">
                            ${studentCheckboxes}
                        </div>
                    </div>
                    <div class="flex justify-end gap-2">
                        ${turmaId ? `<button type="button" class="danger-btn" data-action="delete-item" data-collection="turmas" data-id="${turmaId}">Excluir</button>` : ''}
                        <button type="submit" class="primary-btn w-auto">Salvar Turma</button>
                    </div>
                </form>
            `;
            const levelSelect = document.getElementById('turma-level');
            const levelCustomInput = document.getElementById('turma-level-custom');
            levelSelect.addEventListener('change', (e) => {
                levelCustomInput.classList.toggle('hidden', e.target.value !== 'outro');
            });
            document.getElementById('form-modal-body').onsubmit = saveTurma;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveTurma(event) {
            event.preventDefault();
            const turmaId = document.getElementById('turma-id').value;
            const teacherSelect = document.getElementById('turma-teacher');
            const selectedTeacherOption = teacherSelect.options[teacherSelect.selectedIndex];

            const levelSelect = document.getElementById('turma-level');
            const levelValue = levelSelect.value === 'outro'
                ? document.getElementById('turma-level-custom').value
                : levelSelect.value;

            const data = {
                name: document.getElementById('turma-name').value,
                teacherId: selectedTeacherOption.value,
                teacherName: selectedTeacherOption.getAttribute('data-name'),
                level: levelValue,
                studentIds: Array.from(document.querySelectorAll('input[name="turma-students"]:checked')).map(cb => cb.value),
                semestre: document.getElementById('turma-semestre').value,
                startDate: document.getElementById('turma-startDate').value,
                endDate: document.getElementById('turma-endDate').value,
            };

            if (!data.name || !data.teacherId) {
                showErrorMessage("Erro", "Nome da turma e professor são obrigatórios.");
                return;
            }

            try {
                if (turmaId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/turmas`, turmaId), data);
                    showSuccessMessage("Sucesso", "Turma atualizada.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/turmas`), data);
                    showSuccessMessage("Sucesso", "Nova turma criada.");
                }
            } catch (error) {
                console.error("Error saving turma:", error);
                showErrorMessage("Erro", "Não foi possível salvar a turma.");
            }
        }

        function openVipForm(vipId = null) {
            clearModalHeaderButtons();
            const vip = vipId ? vips.find(v => v.id === vipId) : null;
            document.getElementById('form-modal-title').textContent = vip ? "Editar VIP" : "Adicionar Novo VIP";

            const teacherOptions = collaborators.filter(c => c.sectors?.includes('professor')).map(c => `<option value="${c.id}" data-name="${c.name}" ${vip?.teacherId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
            const levelOptions = cps.map(cp => `<option value="${cp.title}" ${vip?.level === cp.title ? 'selected' : ''}>${cp.title}</option>`).join('') + `<option value="outro">Outro (especificar)</option>`;
            const studentOptions = students.filter(s => s.status === 'Ativo').map(s => `<option value="${s.id}" data-name="${s.name}" ${vip?.studentId === s.id ? 'selected' : ''}>${s.name}</option>`).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="vip-id" value="${vipId || ''}">
                    <div><label class="font-medium text-sm">Aluno</label><select id="vip-student" class="form-input" required>${studentOptions}</select></div>
                    <div><label class="font-medium text-sm">Professor</label><select id="vip-teacher" class="form-input" required>${teacherOptions}</select></div>
                    <div>
                        <label class="font-medium text-sm">Nível</label>
                        <select id="vip-level" class="form-input" required>${levelOptions}</select>
                        <input type="text" id="vip-level-custom" class="form-input mt-2 hidden" placeholder="Digite o nível personalizado">
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div><label class="font-medium text-sm">Semestre</label><input type="text" id="vip-semestre" class="form-input" value="${vip?.semestre || ''}"></div>
                        <div><label class="font-medium text-sm">Data de Início</label><input type="date" id="vip-startDate" class="form-input" value="${vip?.startDate || ''}"></div>
                        <div><label class="font-medium text-sm">Data de Finalização</label><input type="date" id="vip-endDate" class="form-input" value="${vip?.endDate || ''}"></div>
                    </div>
                    <div class="flex justify-end gap-2">
                        ${vipId ? `<button type="button" class="danger-btn" data-action="delete-item" data-collection="vips" data-id="${vipId}">Excluir</button>` : ''}
                        <button type="submit" class="primary-btn w-auto">Salvar VIP</button>
                    </div>
                </form>
            `;
            const levelSelect = document.getElementById('vip-level');
            const levelCustomInput = document.getElementById('vip-level-custom');
            levelSelect.addEventListener('change', (e) => {
                levelCustomInput.classList.toggle('hidden', e.target.value !== 'outro');
            });
            document.getElementById('form-modal-body').onsubmit = saveVip;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveVip(event) {
            event.preventDefault();
            const vipId = document.getElementById('vip-id').value;
            const teacherSelect = document.getElementById('vip-teacher');
            const selectedTeacherOption = teacherSelect.options[teacherSelect.selectedIndex];
            const studentSelect = document.getElementById('vip-student');
            const selectedStudentOption = studentSelect.options[studentSelect.selectedIndex];

            const levelSelect = document.getElementById('vip-level');
            const levelValue = levelSelect.value === 'outro'
                ? document.getElementById('vip-level-custom').value
                : levelSelect.value;

            const data = {
                studentId: selectedStudentOption.value,
                studentName: selectedStudentOption.getAttribute('data-name'),
                teacherId: selectedTeacherOption.value,
                teacherName: selectedTeacherOption.getAttribute('data-name'),
                level: levelValue,
                semestre: document.getElementById('vip-semestre').value,
                startDate: document.getElementById('vip-startDate').value,
                endDate: document.getElementById('vip-endDate').value,
            };

            if (!data.studentId || !data.teacherId) {
                showErrorMessage("Erro", "Aluno e professor são obrigatórios.");
                return;
            }

            try {
                if (vipId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/vips`, vipId), data);
                    showSuccessMessage("Sucesso", "VIP atualizado.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/vips`), data);
                    showSuccessMessage("Sucesso", "Novo VIP criado.");
                }
            } catch (error) {
                console.error("Error saving VIP:", error);
                showErrorMessage("Erro", "Não foi possível salvar o VIP.");
            }
        }

        function openTurmaPefModal(turmaId) {
            const turma = turmas.find(t => t.id === turmaId);
            if (!turma) { showErrorMessage("Erro", "Turma não encontrada."); return; }

            const modal = document.getElementById('form-modal');
            modal.dataset.pefModal = "true";
            modal.dataset.unitId = turmaId;
            modal.dataset.pefType = "turma";
            
            clearModalHeaderButtons();
            const modalHeader = document.getElementById('modal-header-container');
            const modalTitle = document.getElementById('form-modal-title');
            const modalContentArea = document.getElementById('form-modal-content-area');

            const exportButton = document.createElement('button');
            exportButton.className = 'secondary-btn w-auto';
            exportButton.textContent = 'Exportar PEF';
            exportButton.dataset.action = 'export-turma-pef';
            exportButton.dataset.id = turmaId;
            modalHeader.insertBefore(exportButton, modalHeader.querySelector('.modal-close-btn'));
            
            modalTitle.textContent = `PEF: ${turma.name}`;

            const turmaStudents = (turma.studentIds || []).map(id => students.find(s => s.id === id)).filter(Boolean);
            const unitAttendance = attendance.find(a => a.id === turmaId);

            let lessonsHtml = '';
            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance?.lessons?.[i];
                const lessonDate = lessonData?.date || '';
                
                const studentsHtml = turmaStudents.map(student => {
                    const studentStatus = lessonData?.students?.[student.id] || '';
                    return `
                        <div class="pef-student-attendance-row" data-student-id="${student.id}">
                            <span class="text-sm">${student.name}</span>
                            <div class="pef-status-btn-group flex gap-1">
                                <button data-action="mark-attendance" data-status="P" class="${studentStatus === 'P' ? 'active P' : ''}">P</button>
                                <button data-action="mark-attendance" data-status="F" class="${studentStatus === 'F' ? 'active F' : ''}">F</button>
                                <button data-action="mark-attendance" data-status="PP" class="${studentStatus === 'PP' ? 'active PP' : ''}">PP</button>
                            </div>
                        </div>
                    `;
                }).join('');

                lessonsHtml += `
                    <div class="pef-lesson-row" id="lesson-row-${turmaId}-${i}">
                        <div class="flex flex-col justify-center items-center gap-2">
                             <span class="font-bold text-stone-700">Aula ${i}</span>
                             <button class="secondary-btn !text-xs !py-1 !px-3" data-action="save-pef-lesson" data-unit-id="${turmaId}" data-lesson-number="${i}">Salvar</button>
                        </div>
                        <input type="date" class="form-input p-2 text-sm lesson-date self-center" value="${lessonDate}">
                        <div class="space-y-2">
                            <textarea class="form-input p-2 text-sm w-full lesson-topic" placeholder="Tema da aula">${lessonData?.topic || ''}</textarea>
                            <textarea class="form-input p-2 text-sm w-full lesson-notes mt-2" placeholder="Observações da aula">${lessonData?.notes || ''}</textarea>
                            ${studentsHtml}
                        </div>
                    </div>
                `;
            }
            
            modalContentArea.innerHTML = `<div>${lessonsHtml}</div>`;
            modal.classList.add('visible');
        }

        function openVipPefModal(vipId) {
            const vip = vips.find(v => v.id === vipId);
            if (!vip) { showErrorMessage("Erro", "Aluno VIP não encontrado."); return; }
            const student = students.find(s => s.id === vip.studentId);
            if (!student) { showErrorMessage("Erro", "Dados do aluno não encontrados."); return; }

            const modal = document.getElementById('form-modal');
            modal.dataset.pefModal = "true";
            modal.dataset.unitId = vipId;
            modal.dataset.pefType = "vip";

            clearModalHeaderButtons();
            const modalHeader = document.getElementById('modal-header-container');
            const modalTitle = document.getElementById('form-modal-title');
            const modalContentArea = document.getElementById('form-modal-content-area');
            
            const exportButton = document.createElement('button');
            exportButton.className = 'secondary-btn w-auto';
            exportButton.textContent = 'Exportar PEF';
            exportButton.dataset.action = 'export-vip-pef';
            exportButton.dataset.id = vipId;
            modalHeader.insertBefore(exportButton, modalHeader.querySelector('.modal-close-btn'));
            
            modalTitle.textContent = `PEF (VIP): ${vip.studentName}`;

            const unitAttendance = attendance.find(a => a.id === vipId);

            let lessonsHtml = '';
            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance?.lessons?.[i];
                const lessonDate = lessonData?.date || '';
                const lessonNotes = lessonData?.notes || '';
                const lessonTopic = lessonData?.topic || '';
                const studentStatus = lessonData?.students?.[student.id] || '';

                const studentHtml = `
                    <div class="pef-student-attendance-row" data-student-id="${student.id}">
                        <span class="text-sm font-semibold">${student.name}</span>
                        <div class="pef-status-btn-group flex gap-1">
                            <button data-action="mark-attendance" data-status="P" class="${studentStatus === 'P' ? 'active P' : ''}">P</button>
                            <button data-action="mark-attendance" data-status="F" class="${studentStatus === 'F' ? 'active F' : ''}">F</button>
                            <button data-action="mark-attendance" data-status="PP" class="${studentStatus === 'PP' ? 'active PP' : ''}">PP</button>
                        </div>
                    </div>
                `;

                lessonsHtml += `
                    <div class="pef-lesson-row" id="lesson-row-${vipId}-${i}">
                        <div class="flex flex-col justify-center items-center gap-2">
                             <span class="font-bold text-stone-700">Aula ${i}</span>
                             <button class="secondary-btn !text-xs !py-1 !px-3" data-action="save-pef-lesson" data-unit-id="${vipId}" data-lesson-number="${i}">Salvar</button>
                        </div>
                        <input type="date" class="form-input p-2 text-sm lesson-date self-center" value="${lessonDate}">
                        <div class="space-y-2">
                            <textarea class="form-input p-2 text-sm w-full lesson-topic" placeholder="Tema da aula">${lessonTopic}</textarea>
                            <textarea class="form-input p-2 text-sm w-full lesson-notes mt-2" placeholder="Observações da aula">${lessonNotes}</textarea>
                            ${studentHtml}
                        </div>
                    </div>
                `;
            }
            
            modalContentArea.innerHTML = `<div>${lessonsHtml}</div>`;
            modal.classList.add('visible');
        }

        async function savePefLesson(unitId, lessonNumber) {
            const lessonRow = document.getElementById(`lesson-row-${unitId}-${lessonNumber}`);
            if (!lessonRow) {
                console.error("Lesson row not found");
                return;
            }

            const date = lessonRow.querySelector('.lesson-date').value;
            const topic = lessonRow.querySelector('.lesson-topic').value;
            const notes = lessonRow.querySelector('.lesson-notes').value;

            const studentAttendance = {};
            const studentRows = lessonRow.querySelectorAll('.pef-student-attendance-row');
            studentRows.forEach(row => {
                const studentId = row.dataset.studentId;
                const activeButton = row.querySelector('.pef-status-btn-group button.active');
                const status = activeButton ? activeButton.dataset.status : '';
                if (studentId) {
                    studentAttendance[studentId] = status;
                }
            });

            if (!date) {
                showErrorMessage("Data Obrigatória", "Por favor, selecione a data da aula antes de salvar.");
                return;
            }

            const attendanceRef = doc(db, `artifacts/${appId}/public/data/attendance`, unitId);
            
            const lessonData = {
                date: date,
                students: studentAttendance,
                topic: topic,
                notes: notes,
            };

            try {
                await setDoc(attendanceRef, {
                    id: unitId,
                    lessons: {
                        [lessonNumber]: lessonData
                    }
                }, { merge: true });
                
                showSuccessMessage("Sucesso!", `Presença da Aula ${lessonNumber} foi salva.`);
            } catch (error) {
                console.error("Error saving attendance: ", error);
                showErrorMessage("Erro", "Falha ao salvar a presença. Tente novamente.");
            }
        }

        function openEventForm(eventId = null) {
            clearModalHeaderButtons();
            const event = eventId ? events.find(e => e.id === eventId) : null;
            document.getElementById('form-modal-title').textContent = event ? "Editar Evento" : "Adicionar Novo Evento";
            const sectorOptions = ["Financeiro", "Pedagógico", "Comercial", "Marketing"].map(s => `<option value="${s}" ${event?.setor === s ? 'selected' : ''}>${s}</option>`).join('');
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="event-id" value="${eventId || ''}">
                    <div><label class="font-medium text-sm">Nome do Evento</label><input type="text" id="event-name" class="form-input" required value="${event?.nome || ''}"></div>
                    <div><label class="font-medium text-sm">Setor</label><select id="event-sector" class="form-input" required>${sectorOptions}</select></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="font-medium text-sm">Data</label><input type="date" id="event-date" class="form-input" required value="${event?.data || ''}"></div>
                        <div><label class="font-medium text-sm">Horário</label><input type="time" id="event-time" class="form-input" value="${event?.time || ''}"></div>
                    </div>
                    <div><label class="font-medium text-sm">Local</label><input type="text" id="event-location" class="form-input" required value="${event?.local || ''}"></div>
                    <div><label class="font-medium text-sm">Descrição</label><textarea id="event-description" rows="4" class="form-input">${event?.descricao || ''}</textarea></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;
            document.getElementById('form-modal-body').onsubmit = saveEvent;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveEvent(event) {
            event.preventDefault();
            const eventId = document.getElementById('event-id').value;
            const data = {
                nome: document.getElementById('event-name').value,
                setor: document.getElementById('event-sector').value,
                data: document.getElementById('event-date').value,
                time: document.getElementById('event-time').value,
                local: document.getElementById('event-location').value,
                descricao: document.getElementById('event-description').value,
            };
            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            try {
                if (eventId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/events`, eventId), data);
                    showSuccessMessage("Sucesso!", "Evento atualizado.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/events`), data);
                    showSuccessMessage("Sucesso!", "Novo evento adicionado.");
                }
            } catch (error) { console.error("Error saving event:", error); showErrorMessage("Erro", "Falha ao salvar o evento."); }
        }

        function openEventModal(eventId) {
            clearModalHeaderButtons();
            
            // Look for event in both arrays
            let event = events.find(e => e.id === eventId);
            if (!event) {
                event = calendarEvents.find(e => e.id === eventId);
            }
            
            if (!event) return;
            
            // Handle different event structure formats
            const eventTitle = event.nome || event.title || 'Evento';
            const eventDate = event.data || event.date || '';
            const eventTime = event.time || '';
            const eventLocation = event.local || event.location || '';
            const eventSector = event.setor || event.sector || '';
            const eventDescription = event.descricao || event.description || '';
            
            // Check if user can edit/delete events (teachers cannot)
            const canEditEvents = currentUserRole !== 'teacher';
            
            document.getElementById('form-modal-title').textContent = eventTitle;
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-4">
                    <p><strong>Data:</strong> ${eventDate ? new Date(eventDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'Não informada'} ${eventTime ? `às ${eventTime}`: ''}</p>
                    <p><strong>Local:</strong> ${eventLocation || 'Não informado'}</p>
                    ${eventSector ? `<p><strong>Setor:</strong> <span class="status-tag status-${eventSector.toLowerCase()}">${eventSector}</span></p>` : ''}
                    ${eventDescription ? `<div><strong>Descrição:</strong><p class="mt-1 p-3 bg-stone-50 rounded-md whitespace-pre-wrap">${eventDescription}</p></div>` : ''}
                    <div class="border-t pt-4 flex justify-end gap-2">
                        ${canEditEvents ? `
                            <button class="secondary-btn" data-action="edit-calendar-event" data-id="${event.id}">Editar</button>
                            <button class="danger-btn" data-action="delete-calendar-event" data-id="${event.id}">Apagar</button>
                        ` : `
                            <button class="secondary-btn" data-action="close-form-modal">Fechar</button>
                        `}
                    </div>
                </div>`;
            document.getElementById('form-modal').classList.add('visible');
        }

        function openBudgetForm(budgetId = null) {
            clearModalHeaderButtons();
            const budget = budgetId ? budgets.find(b => b.id === budgetId) : null;
            const collaboratorOptions = collaborators.filter(c => c.sectors && c.sectors.includes('orcamentos')).map(c => `<option value="${c.name}" ${budget?.criadoPor === c.name ? 'selected' : ''}>${c.name}</option>`).join('');
            document.getElementById('form-modal-title').textContent = budget ? "Editar Orçamento" : "Adicionar Novo Orçamento";
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="budget-id" value="${budgetId || ''}">
                    <div><label class="font-medium text-sm">Título</label><input type="text" id="budget-title" class="form-input" required value="${budget?.titulo || ''}"></div>
                    <div><label class="font-medium text-sm">Fornecedor</label><input type="text" id="budget-provider" class="form-input" required value="${budget?.fornecedor || ''}"></div>
                    <div><label class="font-medium text-sm">Data do Orçamento</label><input type="date" id="budget-date" class="form-input" required value="${budget?.dataCriacao || ''}"></div>
                    <div><label class="font-medium text-sm">Criado por</label><select id="budget-owner" class="form-input" required>${collaboratorOptions}</select></div>
                    <div><label class="font-medium text-sm">Valor (R$)</label><input type="number" step="0.01" id="budget-value" class="form-input" required value="${budget?.valor || ''}"></div>
                    <div><label class="font-medium text-sm">Status</label><select id="budget-status" class="form-input" required><option>Pendente</option><option>Aprovado</option><option>Rejeitado</option></select></div>
                    <div><label class="font-medium text-sm">Descrição</label><textarea id="budget-description" rows="3" class="form-input">${budget?.descricao || ''}</textarea></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;
            if (budget) document.getElementById('budget-status').value = budget.status;
            document.getElementById('form-modal-body').onsubmit = saveBudget;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveBudget(event) {
            event.preventDefault();
            const budgetId = document.getElementById('budget-id').value;
            const data = {
                titulo: document.getElementById('budget-title').value,
                fornecedor: document.getElementById('budget-provider').value,
                dataCriacao: document.getElementById('budget-date').value,
                criadoPor: document.getElementById('budget-owner').value,
                valor: document.getElementById('budget-value').value,
                status: document.getElementById('budget-status').value,
                descricao: document.getElementById('budget-description').value,
            };
            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            try {
                if (budgetId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/budgets`, budgetId), data);
                    showSuccessMessage("Sucesso!", "Orçamento atualizado.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/budgets`), data);
                    showSuccessMessage("Sucesso!", "Novo orçamento adicionado.");
                }
            } catch (error) { console.error("Error saving budget:", error); showErrorMessage("Erro", "Falha ao salvar o orçamento."); }
        }

        function openBudgetModal(budgetId) {
            clearModalHeaderButtons();
            const budget = budgets.find(b => b.id === budgetId);
            if (!budget) return;
            document.getElementById('form-modal-title').textContent = budget.titulo;
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-4">
                    <p><strong>Fornecedor:</strong> ${budget.fornecedor}</p>
                    <p><strong>Data:</strong> ${budget.dataCriacao ? new Date(budget.dataCriacao + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</p>
                    <p><strong>Criado por:</strong> ${budget.criadoPor || 'N/A'}</p>
                    <p><strong>Valor:</strong> R$ ${parseFloat(budget.valor || 0).toFixed(2)}</p>
                    <p><strong>Status:</strong> <span class="status-tag status-${budget.status.toLowerCase()}">${budget.status}</span></p>
                    ${budget.descricao ? `<div><strong>Descrição:</strong><p class="mt-1 p-3 bg-stone-50 rounded-md">${budget.descricao}</p></div>` : ''}
                    <div class="border-t pt-4 flex justify-end gap-2">
                        <button class="secondary-btn" data-action="edit-budget" data-id="${budget.id}">Editar</button>
                        <button class="danger-btn" data-action="delete-item" data-collection="budgets" data-id="${budget.id}">Apagar</button>
                    </div>
                </div>`;
            document.getElementById('form-modal').classList.add('visible');
        }

        function openTaskForm() {
            clearModalHeaderButtons();
            document.getElementById('form-modal-title').textContent = "Adicionar Nova Tarefa";
            const collaboratorOptions = collaborators.filter(c => c.sectors && (c.sectors.includes('tarefas') || c.sectors.includes('professor'))).map(c => `<option value="${c.name}">${c.name}</option>`).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <div><label class="font-medium text-sm">Descrição</label><textarea id="task-description" rows="4" class="form-input" required></textarea></div>
                    <div><label class="font-medium text-sm">Prazo Final</label><input type="date" id="task-deadline" class="form-input" required></div>
                    <div><label class="font-medium text-sm">Atribuir para (selecione um ou mais)</label><select id="task-assignedTo" class="form-input" multiple required>${collaboratorOptions}</select></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar Tarefa</button></div>
                </form>`;
            document.getElementById('form-modal-body').onsubmit = saveTask;
            document.getElementById('form-modal').classList.add('visible');
        }
        async function saveTask(event) {
            event.preventDefault();
            const data = {
                description: document.getElementById('task-description').value,
                deadline: document.getElementById('task-deadline').value,
                assignedTo: Array.from(document.getElementById('task-assignedTo').selectedOptions).map(o => o.value),
                assignedBy: currentUserName || 'Admin',
                createdAt: serverTimestamp(),
                completed: false
            };
            if (!data.description || !data.deadline || data.assignedTo.length === 0) { showErrorMessage("Erro de Validação", "Por favor, preencha todos os campos obrigatórios."); return; }
            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), data);
                showSuccessMessage("Sucesso!", "Tarefa adicionada.");
            } catch (error) { console.error("Error saving task:", error); showErrorMessage("Erro", "Falha ao salvar a tarefa."); }
        }
        
        function openCollaboratorForm(collaboratorId = null) {
            clearModalHeaderButtons();
            const collaborator = collaboratorId ? collaborators.find(c => c.id === collaboratorId) : null;
            document.getElementById('form-modal-title').textContent = collaborator ? "Editar Colaborador" : "Adicionar Novo Colaborador";
            
            const sectors = ['professor', 'tarefas', 'cancelamentos', 'orcamentos', 'banco de fotos'];
            const sectorLabels = { professor: 'Professor (Grade)', tarefas: 'Tarefas', cancelamentos: 'Cancelamentos', orcamentos: 'Orçamentos', 'banco de fotos': 'Banco de Fotos' };
            
            const sectorCheckboxes = sectors.map(sector => {
                const isChecked = collaborator?.sectors?.includes(sector) ? 'checked' : '';
                return `
                    <div class="flex items-center">
                        <input type="checkbox" id="sector-${sector.replace(' ', '-')}" name="sectors" value="${sector}" class="h-4 w-4 rounded" ${isChecked}>
                        <label for="sector-${sector.replace(' ', '-')}" class="ml-2 text-sm">${sectorLabels[sector]}</label>
                    </div>
                `;
            }).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="collaborator-id" value="${collaboratorId || ''}">
                    <div><label class="font-medium text-sm">Nome do Colaborador</label><input type="text" id="collaborator-name" class="form-input" required value="${collaborator?.name || ''}"></div>
                    <div>
                        <label class="font-medium text-sm">Setores de Atuação</label>
                        <div class="mt-2 grid grid-cols-2 gap-2">${sectorCheckboxes}</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                         <div><label class="font-medium text-sm">Início do Turno</label><input type="time" id="collaborator-shift-start" class="form-input" value="${collaborator?.shiftStart || ''}"></div>
                         <div><label class="font-medium text-sm">Fim do Turno</label><input type="time" id="collaborator-shift-end" class="form-input" value="${collaborator?.shiftEnd || ''}"></div>
                    </div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;
            document.getElementById('form-modal-body').onsubmit = saveCollaborator;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveCollaborator(event) {
            event.preventDefault();
            const collaboratorId = document.getElementById('collaborator-id').value;
            const selectedSectors = Array.from(document.querySelectorAll('input[name="sectors"]:checked')).map(cb => cb.value);
            
            const data = {
                name: document.getElementById('collaborator-name').value,
                shiftStart: document.getElementById('collaborator-shift-start').value,
                shiftEnd: document.getElementById('collaborator-shift-end').value,
                sectors: selectedSectors
            };

            if (!data.name) { showErrorMessage("Erro", "O nome do colaborador é obrigatório."); return; }
            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            
            const oldCollaborator = collaboratorId ? collaborators.find(c => c.id === collaboratorId) : null;
            const hadFolderSector = oldCollaborator?.sectors?.includes('banco de fotos');
            const hasFolderSector = data.sectors.includes('banco de fotos');

            try {
                 if (collaboratorId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/collaborators`, collaboratorId), data);
                    showSuccessMessage("Sucesso!", "Colaborador atualizado.");
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/collaborators`), data);
                    showSuccessMessage("Sucesso!", "Colaborador adicionado.");
                }
                
                if(hasFolderSector && !hadFolderSector) {
                    const folderExists = photoFolders.some(f => f.name === data.name);
                    if (!folderExists) {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/photo_folders`), { name: data.name, createdAt: serverTimestamp() });
                    }
                }

            } catch (error) { console.error("Error saving collaborator:", error); showErrorMessage("Erro", "Falha ao salvar o colaborador."); }
        }

        function openBreakForm() {
            clearModalHeaderButtons();
            document.getElementById('form-modal-title').textContent = "Adicionar Break";
            
            const teacherOptions = collaborators.filter(c => c.sectors && c.sectors.includes('professor')).map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            const dayOptions = ["Segunda", "Terça", "Quarta", "Quinta", "Sexta"].map(d => `<option value="${d}">${d}</option>`).join('');
            
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <div><label class="font-medium text-sm">Professor</label><select id="break-teacher" class="form-input" required>${teacherOptions}</select></div>
                    <div><label class="font-medium text-sm">Dia da Semana</label><select id="break-day" class="form-input" required>${dayOptions}</select></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="font-medium text-sm">Horário de Início</label><input type="time" id="break-start" class="form-input" required></div>
                        <div><label class="font-medium text-sm">Horário de Fim</label><input type="time" id="break-end" class="form-input" required></div>
                    </div>
                    <div id="break-conflict-warning" class="hidden bg-red-50 border border-red-200 rounded-lg p-3 text-red-700">
                        <strong>⚠️ Conflito de horário detectado!</strong>
                        <p>Já existe uma aula ou break agendado para este professor neste horário.</p>
                    </div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Adicionar Break</button></div>
                </form>`;
            
            // Add conflict checking
            const teacherSelect = document.getElementById('break-teacher');
            const daySelect = document.getElementById('break-day');
            const startInput = document.getElementById('break-start');
            const endInput = document.getElementById('break-end');
            const conflictWarning = document.getElementById('break-conflict-warning');
            
            function checkBreakConflicts() {
                const teacher = teacherSelect.value;
                const day = daySelect.value;
                const startTime = startInput.value;
                const endTime = endInput.value;
                
                if (teacher && day && startTime && endTime) {
                    const hasConflict = checkTimeConflict(teacher, day, startTime, endTime);
                    conflictWarning.classList.toggle('hidden', !hasConflict);
                }
            }
            
            [teacherSelect, daySelect, startInput, endInput].forEach(element => {
                element.addEventListener('change', checkBreakConflicts);
            });
            
            document.getElementById('form-modal-body').onsubmit = saveBreak;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveBreak(event) {
            event.preventDefault();
            
            const teacher = document.getElementById('break-teacher').value;
            const day = document.getElementById('break-day').value;
            const startTime = document.getElementById('break-start').value;
            const endTime = document.getElementById('break-end').value;
            
            // Validate time
            if (startTime >= endTime) {
                showErrorMessage("Erro de Validação", "O horário de início deve ser anterior ao horário de fim.");
                return;
            }
            
            // Check for conflicts
            const hasConflict = checkTimeConflict(teacher, day, startTime, endTime);
            if (hasConflict) {
                showErrorMessage("Conflito de Horário", "Já existe uma aula ou break agendado para este professor neste horário.");
                return;
            }
            
            const data = {
                teacher: teacher,
                day: day,
                startTime: startTime,
                endTime: endTime,
                type: 'break',
                student: 'Intervalo',
                level: 'N/A',
                createdAt: serverTimestamp()
            };
            
            if (!db) { 
                console.warn("Offline mode."); 
                closeFormModal(); 
                return; 
            }
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/schedules`), data);
                showSuccessMessage("Sucesso!", "Break adicionado à grade.");
                closeFormModal();
            } catch (error) { 
                console.error("Error saving break:", error); 
                showErrorMessage("Erro", "Falha ao salvar o break."); 
            }
        }

        function openScheduleForm(scheduleId = null) {
            clearModalHeaderButtons();
            const schedule = scheduleId ? schedules.find(s => s.id === scheduleId) : null;
            document.getElementById('form-modal-title').textContent = schedule ? "Detalhes da Aula" : "Adicionar Nova Aula";
            const isTeacher = currentUserRole === 'teacher';

            const teacherOptions = collaborators.filter(c => c.sectors && c.sectors.includes('professor')).map(c => `<option value="${c.name}" ${schedule?.teacher === c.name ? 'selected' : ''}>${c.name}</option>`).join('');
            const dayOptions = ["Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Seg/Qua", "Ter/Qui"].map(d => `<option value="${d}" ${schedule?.day === d ? 'selected' : ''}>${d}</option>`).join('');
            const typeOptions = ["vip", "turma", "break"].map(t => `<option value="${t}" ${schedule?.type === t ? 'selected' : ''}>${t === 'break' ? 'BREAK' : t.toUpperCase()}</option>`).join('');
            const levelOptions = cps.map(cp => `<option value="${cp.title}" ${schedule?.level === cp.title ? 'selected' : ''}>${cp.title}</option>`).join('') + `<option value="outro">Outro (especificar)</option>`;
            
            let formHtml = `<form id="form-modal-body" class="space-y-4">
                <input type="hidden" id="schedule-id" value="${scheduleId || ''}">
                <div class="schedule-student-field"><label class="font-medium text-sm">Aluno/Turma</label><input type="text" id="schedule-student" class="form-input" required value="${schedule?.student || ''}" ${isTeacher ? 'disabled' : ''}></div>
                <div class="schedule-level-field">
                    <label class="font-medium text-sm">Nível</label>
                    <select id="schedule-level" class="form-input" required ${isTeacher ? 'disabled' : ''}>${levelOptions}</select>
                    <input type="text" id="schedule-level-custom" class="form-input mt-2 hidden" placeholder="Digite o nível personalizado" ${isTeacher ? 'disabled' : ''}>
                </div>
                <div><label class="font-medium text-sm">Professor</label><select id="schedule-teacher" class="form-input" required ${isTeacher ? 'disabled' : ''}>${teacherOptions}</select></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="font-medium text-sm">Dia</label><select id="schedule-day" class="form-input" required ${isTeacher ? 'disabled' : ''}>${dayOptions}</select></div>
                    <div><label class="font-medium text-sm">Tipo</label><select id="schedule-type" class="form-input" required ${isTeacher ? 'disabled' : ''}>${typeOptions}</select></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="font-medium text-sm">Início</label><input type="time" id="schedule-start" class="form-input" required value="${schedule?.startTime || ''}" ${isTeacher ? 'disabled' : ''}></div>
                    <div><label class="font-medium text-sm">Fim</label><input type="time" id="schedule-end" class="form-input" required value="${schedule?.endTime || ''}" ${isTeacher ? 'disabled' : ''}></div>
                </div>
                <div id="conflict-warning" class="hidden bg-red-50 border border-red-200 rounded-lg p-3 text-red-700">
                    <strong>⚠️ Conflito de horário detectado!</strong>
                    <p>Já existe uma aula agendada para este professor neste horário.</p>
                </div>
                ${!isTeacher ? `<div class="pt-4 flex justify-end gap-2">${scheduleId ? `<button type="button" class="danger-btn" data-action="delete-item" data-collection="schedules" data-id="${scheduleId}">Apagar</button>` : ''}<button type="submit" class="primary-btn w-auto">Salvar</button></div>` : ''}
            </form>`;
            document.getElementById('form-modal-content-area').innerHTML = formHtml;

            const levelSelect = document.getElementById('schedule-level');
            const levelCustomInput = document.getElementById('schedule-level-custom');
            levelSelect.addEventListener('change', (e) => {
                levelCustomInput.classList.toggle('hidden', e.target.value !== 'outro');
            });

            // Hide/show fields based on type selection
            function updateFormFields() {
                const type = document.getElementById('schedule-type').value;
                const studentField = document.querySelector('.schedule-student-field');
                const levelField = document.querySelector('.schedule-level-field');
                const studentInput = document.getElementById('schedule-student');
                const levelSelect = document.getElementById('schedule-level');
                
                if (type === 'break') {
                    studentField.style.display = 'none';
                    levelField.style.display = 'none';
                    studentInput.required = false;
                    levelSelect.required = false;
                } else {
                    studentField.style.display = 'block';
                    levelField.style.display = 'block';
                    studentInput.required = true;
                    levelSelect.required = true;
                }
            }

            // Check for time conflicts
            function checkConflicts() {
                const teacher = document.getElementById('schedule-teacher').value;
                const day = document.getElementById('schedule-day').value;
                const startTime = document.getElementById('schedule-start').value;
                const endTime = document.getElementById('schedule-end').value;
                const scheduleId = document.getElementById('schedule-id').value;
                const warning = document.getElementById('conflict-warning');
                
                if (teacher && day && startTime && endTime) {
                    const hasConflict = checkTimeConflict(teacher, day, startTime, endTime, scheduleId);
                    if (hasConflict) {
                        warning.classList.remove('hidden');
                    } else {
                        warning.classList.add('hidden');
                    }
                }
            }
            
            document.getElementById('schedule-type').addEventListener('change', updateFormFields);
            document.getElementById('schedule-teacher').addEventListener('change', checkConflicts);
            document.getElementById('schedule-day').addEventListener('change', checkConflicts);
            document.getElementById('schedule-start').addEventListener('change', checkConflicts);
            document.getElementById('schedule-end').addEventListener('change', checkConflicts);
            
            updateFormFields();

            document.getElementById('form-modal-body').onsubmit = saveScheduleEntry;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveScheduleEntry(event) {
            event.preventDefault();
            const teacherName = document.getElementById('schedule-teacher').value;
            const startTime = document.getElementById('schedule-start').value;
            
            const teacher = collaborators.find(c => c.name === teacherName);
            if (teacher && teacher.shiftStart && teacher.shiftEnd) {
                if (startTime < teacher.shiftStart || startTime > teacher.shiftEnd) {
                    showConfirmationModal(
                        "Aviso de Horário", 
                        `Este horário (${startTime}) está fora do turno do professor (${teacher.shiftStart} - ${teacher.shiftEnd}). Tem certeza que quer continuar?`,
                        () => proceedWithSaveSchedule()
                    );
                    return;
                }
            }
            proceedWithSaveSchedule();
        }

        async function proceedWithSaveSchedule() {
            const scheduleId = document.getElementById('schedule-id').value;
            const daySelection = document.getElementById('schedule-day').value;
            const daysToCreate = [];
            if (daySelection === 'Seg/Qua') daysToCreate.push('Segunda', 'Quarta');
            else if (daySelection === 'Ter/Qui') daysToCreate.push('Terça', 'Quinta');
            else daysToCreate.push(daySelection);

            const levelSelect = document.getElementById('schedule-level');
            const levelValue = levelSelect.value === 'outro'
                ? document.getElementById('schedule-level-custom').value
                : levelSelect.value;

            const scheduleType = document.getElementById('schedule-type').value;
            const baseData = { 
                student: scheduleType === 'break' ? 'Break' : document.getElementById('schedule-student').value, 
                level: scheduleType === 'break' ? 'N/A' : levelValue, 
                teacher: document.getElementById('schedule-teacher').value, 
                type: scheduleType, 
                startTime: document.getElementById('schedule-start').value, 
                endTime: document.getElementById('schedule-end').value 
            };
            
            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            try {
                if (scheduleId) { 
                    const data = {...baseData, day: daySelection };
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/schedules`, scheduleId), data); 
                    showSuccessMessage("Sucesso!", "Aula atualizada.");
                } else { 
                    for (const day of daysToCreate) {
                        const data = {...baseData, day: day, createdAt: serverTimestamp() };
                        await addDoc(collection(db, `artifacts/${appId}/public/data/schedules`), data); 
                    }
                    showSuccessMessage("Sucesso!", "Aula(s) adicionada(s).");
                }
            } catch (error) { console.error("Error saving schedule:", error); showErrorMessage("Erro", "Falha ao salvar a aula."); }
        }

        function openExpenseForm(expenseId = null) {
            clearModalHeaderButtons();
            const expense = expenseId ? expenses.find(e => e.id === expenseId) : null;
            document.getElementById('form-modal-title').textContent = expense ? "Editar Despesa" : "Adicionar Nova Despesa";
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="expense-id" value="${expenseId || ''}">
                    <div><label class="font-medium text-sm">Descrição</label><input type="text" id="expense-description" class="form-input" required value="${expense?.description || ''}"></div>
                    
                    <div id="due-date-container" class="${expense?.isFixedSalary ? 'hidden' : ''}">
                        <label class="font-medium text-sm">Vencimento</label>
                        <input type="date" id="expense-dueDate" class="form-input" value="${expense?.dueDate || ''}">
                    </div>
                    
                    <div id="due-day-container" class="${expense?.isFixedSalary ? '' : 'hidden'}">
                        <label class="font-medium text-sm">Dia do Vencimento</label>
                        <input type="number" min="1" max="31" id="expense-dueDay" class="form-input" value="${expense?.dueDay || ''}">
                    </div>

                    <div><label class="font-medium text-sm">Valor (R$)</label><input type="number" step="0.01" id="expense-amount" class="form-input" required value="${expense?.amount || ''}"></div>
                    
                    <div class="flex items-center gap-2"><input type="checkbox" id="expense-isFixedSalary" class="h-4 w-4 rounded" ${expense?.isFixedSalary ? 'checked' : ''}><label for="expense-isFixedSalary" class="text-sm">É salário fixo?</label></div>
                    <div id="employee-role-container" class="${expense?.isFixedSalary ? '' : 'hidden'}"><label class="font-medium text-sm">Cargo</label><input type="text" id="expense-employeeRole" class="form-input" value="${expense?.employeeRole || ''}"></div>
                    <div class="pt-4 flex justify-end gap-2">${expenseId ? `<button type="button" class="danger-btn" data-action="delete-item" data-collection="expenses" data-id="${expenseId}">Apagar</button>` : ''}<button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;
            
            const isFixedSalaryCheckbox = document.getElementById('expense-isFixedSalary');
            isFixedSalaryCheckbox.onchange = () => {
                const isChecked = isFixedSalaryCheckbox.checked;
                document.getElementById('employee-role-container').classList.toggle('hidden', !isChecked);
                document.getElementById('due-date-container').classList.toggle('hidden', isChecked);
                document.getElementById('due-day-container').classList.toggle('hidden', !isChecked);
            };
            
            document.getElementById('form-modal-body').onsubmit = saveExpense;
            document.getElementById('form-modal').classList.add('visible');
        }
        async function saveExpense(event) {
            event.preventDefault();
            const expenseId = document.getElementById('expense-id').value;
            const isFixedSalary = document.getElementById('expense-isFixedSalary').checked;
            const data = {
                description: document.getElementById('expense-description').value,
                amount: document.getElementById('expense-amount').value,
                isPaid: false,
                isFixedSalary: isFixedSalary,
                employeeRole: isFixedSalary ? document.getElementById('expense-employeeRole').value : '',
            };

            if (isFixedSalary) {
                data.dueDay = document.getElementById('expense-dueDay').value;
                data.dueDate = null;
            } else {
                data.dueDate = document.getElementById('expense-dueDate').value;
                data.dueDay = null;
            }

            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            try {
                if (expenseId) {
                    const existingExpense = expenses.find(e => e.id === expenseId);
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/expenses`, expenseId), {...existingExpense, ...data});
                    showSuccessMessage("Sucesso!", "Despesa atualizada.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/expenses`), data);
                    showSuccessMessage("Sucesso!", "Nova despesa adicionada.");
                }
            } catch (error) { console.error("Error saving expense:", error); showErrorMessage("Erro", "Falha ao salvar despesa."); }
        }
        async function toggleExpensePaid(expenseId, isPaid) { if (!db) return; const expenseRef = doc(db, `artifacts/${appId}/public/data/expenses`, expenseId); try { await updateDoc(expenseRef, { isPaid: isPaid }); } catch (error) { console.error("Error updating expense status:", error); } }

        function openCancelamentoForm(cancelamentoId = null) {
            clearModalHeaderButtons();
            const cancelamento = cancelamentoId ? cancellations.find(c => c.id === cancelamentoId) : null;
            const collaboratorOptions = collaborators.filter(c => c.sectors && c.sectors.includes('cancelamentos')).map(c => `<option value="${c.name}" ${cancelamento?.processedBy === c.name ? 'selected' : ''}>${c.name}</option>`).join('');
            
            let studentFieldHtml = '';
            if (cancelamentoId) {
                studentFieldHtml = `<div><label class="font-medium text-sm">Aluno</label><p class="form-input bg-stone-100">${cancelamento.studentName}</p></div>`;
            } else {
                const activeStudents = students.filter(s => s.status === 'Ativo');
                const studentOptions = activeStudents.map(s => `<option value="${s.id}" data-name="${s.name}">${s.name}</option>`).join('');
                studentFieldHtml = `<div><label class="font-medium text-sm">Aluno a Cancelar</label><select id="cancelamento-studentId" class="form-input" required><option value="">Selecione um aluno...</option>${studentOptions}</select></div>`;
            }

            document.getElementById('form-modal-title').textContent = cancelamento ? "Editar Cancelamento" : "Registrar Novo Cancelamento";
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="cancelamento-id" value="${cancelamentoId || ''}">
                    ${studentFieldHtml}
                    <div><label class="font-medium text-sm">Data do Cancelamento</label><input type="date" id="cancelamento-date" class="form-input" required value="${cancelamento?.cancellationDate || ''}"></div>
                    <div><label class="font-medium text-sm">Motivo</label><textarea id="cancelamento-reason" rows="3" class="form-input" required>${cancelamento?.reason || ''}</textarea></div>
                    <div><label class="font-medium text-sm">Processado por</label><select id="cancelamento-processedBy" class="form-input" required>${collaboratorOptions}</select></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;
            document.getElementById('form-modal-body').onsubmit = saveCancelamento;
            document.getElementById('form-modal').classList.add('visible');
        }
        async function saveCancelamento(event) {
            event.preventDefault();
            const cancelamentoId = document.getElementById('cancelamento-id').value;
            if (!db) { console.warn("Offline mode."); return; }

            try {
                if (cancelamentoId) {
                    // Logic to update an existing cancellation record
                    const data = {
                        cancellationDate: document.getElementById('cancelamento-date').value,
                        reason: document.getElementById('cancelamento-reason').value,
                        processedBy: document.getElementById('cancelamento-processedBy').value,
                    };
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/cancellations`, cancelamentoId), data);
                    showSuccessMessage("Sucesso!", "Registro de cancelamento atualizado.");
                } else {
                    // Logic to create a new cancellation and update student status
                    const studentSelect = document.getElementById('cancelamento-studentId');
                    if (!studentSelect.value) {
                        showErrorMessage("Erro", "Por favor, selecione um aluno.");
                        return;
                    }
                    const selectedOption = studentSelect.options[studentSelect.selectedIndex];
                    const studentId = selectedOption.value;
                    const studentName = selectedOption.getAttribute('data-name');

                    const data = {
                        studentId: studentId,
                        studentName: studentName,
                        cancellationDate: document.getElementById('cancelamento-date').value,
                        reason: document.getElementById('cancelamento-reason').value,
                        processedBy: document.getElementById('cancelamento-processedBy').value,
                        createdAt: serverTimestamp()
                    };

                    // 1. Add cancellation record
                    await addDoc(collection(db, `artifacts/${appId}/public/data/cancellations`), data);
                    
                    // 2. Update student status
                    const studentRef = doc(db, `artifacts/${appId}/public/data/students`, studentId);
                    await updateDoc(studentRef, { status: 'Cancelado' });

                    showSuccessMessage("Sucesso!", `Cancelamento registrado e status do aluno ${studentName} atualizado.`);
                }
            } catch (error) {
                console.error("Error saving cancellation:", error);
                showErrorMessage("Erro", "Falha ao salvar o cancelamento.");
            }
        }
        function openCancelamentoModal(cancelamentoId) {
            clearModalHeaderButtons();
            const cancelamento = cancellations.find(c => c.id === cancelamentoId);
            if (!cancelamento) return;
            const canEdit = ['admin', 'financeiro'].includes(currentUserRole);
            document.getElementById('form-modal-title').textContent = `Cancelamento de ${cancelamento.studentName}`;
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-4">
                    <p><strong>Aluno:</strong> ${cancelamento.studentName}</p>
                    <p><strong>Data:</strong> ${new Date(cancelamento.cancellationDate + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                    <p><strong>Processado por:</strong> ${cancelamento.processedBy}</p>
                    <div><strong>Motivo:</strong><p class="mt-1 p-3 bg-stone-50 rounded-md">${cancelamento.reason}</p></div>
                    <div class="border-t pt-4 flex justify-end gap-2">
                        ${canEdit ? `<button class="secondary-btn" data-action="edit-cancelamento" data-id="${cancelamento.id}">Editar</button>
                        <button class="danger-btn" data-action="delete-item" data-collection="cancellations" data-id="${cancelamento.id}">Apagar</button>` : ''}
                    </div>
                </div>`;
            document.getElementById('form-modal').classList.add('visible');
        }
        


        function openNivelForm(nivelId = null) {
            clearModalHeaderButtons();
            const nivel = nivelId ? cps.find(n => n.id === nivelId) : null;
            document.getElementById('form-modal-title').textContent = nivel ? 'Editar Nível' : 'Adicionar Novo Nível';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="nivel-id" value="${nivelId || ''}">
                    <div><label class="font-medium text-sm">Título do Nível</label><input type="text" id="nivel-title" class="form-input" required value="${nivel?.title || ''}"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveNivel;
            document.getElementById('form-modal').classList.add('visible');
        }
        
        async function saveNivel(event) {
            event.preventDefault();
            const nivelId = document.getElementById('nivel-id').value;
            const title = document.getElementById('nivel-title').value;
            if (!title) { showErrorMessage("Erro", "O título é obrigatório."); return; }
            
            try {
                if (nivelId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/cps`, nivelId), { title });
                    showSuccessMessage("Sucesso", "Nível atualizado.");
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/cps`), { title, lessons: [], order: cps.length });
                    showSuccessMessage("Sucesso", "Nível adicionado.");
                }
            } catch(e) { console.error(e); showErrorMessage("Erro", "Não foi possível salvar o nível."); }
        }
        
        function openAulaForm(nivelId, aulaIndex = null) {
            clearModalHeaderButtons();
            const nivel = cps.find(n => n.id === nivelId);
            const aula = (aulaIndex !== null && nivel && nivel.lessons) ? nivel.lessons[aulaIndex] : null;
            document.getElementById('form-modal-title').textContent = aula ? 'Editar Aula' : 'Adicionar Nova Aula';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="aula-nivel-id" value="${nivelId}">
                    <input type="hidden" id="aula-index" value="${aulaIndex !== null ? aulaIndex : ''}">
                    <div><label class="font-medium text-sm">Título da Aula</label><input type="text" id="aula-title" class="form-input" required value="${aula?.title || ''}"></div>
                    <div><label class="font-medium text-sm">Tema/Descrição</label><textarea id="aula-topic" class="form-input" rows="3" required>${aula?.topic || ''}</textarea></div>
                    <div><label class="font-medium text-sm">Palavras-chave (separadas por vírgula)</label><input type="text" id="aula-keywords" class="form-input" value="${(aula?.keywords || []).join(', ')}"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveAula;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveAula(event) {
            event.preventDefault();
            const nivelId = document.getElementById('aula-nivel-id').value;
            const aulaIndex = document.getElementById('aula-index').value;
            const nivelRef = doc(db, `artifacts/${appId}/public/data/cps`, nivelId);
            
            const keywordsString = document.getElementById('aula-keywords').value;
            const keywords = keywordsString.split(',').map(k => k.trim()).filter(Boolean);

            const novaAula = {
                title: document.getElementById('aula-title').value,
                topic: document.getElementById('aula-topic').value,
                keywords: keywords
            };

            try {
                if (aulaIndex) { // Edit existing lesson
                    const nivelDoc = await getDoc(nivelRef);
                    const lessons = nivelDoc.data().lessons;
                    lessons[aulaIndex] = novaAula;
                    await updateDoc(nivelRef, { lessons });
                } else { // Add new lesson
                    await updateDoc(nivelRef, { lessons: arrayUnion(novaAula) });
                }
                showSuccessMessage("Sucesso", "Aula salva.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "Não foi possível salvar a aula."); }
        }

        async function deleteAula(nivelId, aulaIndex) {
            const nivelRef = doc(db, `artifacts/${appId}/public/data/cps`, nivelId);
            const nivel = cps.find(n => n.id === nivelId);
            const aulaParaRemover = nivel.lessons[aulaIndex];
            try {
                await updateDoc(nivelRef, { lessons: arrayRemove(aulaParaRemover) });
                showSuccessMessage("Sucesso", "Aula removida.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "Não foi possível remover a aula."); }
        }
        
        async function reorderCPLevel(levelId, direction) {
            const currentIndex = cps.findIndex(c => c.id === levelId);
            if (currentIndex === -1) return;

            const otherIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;
            if (otherIndex < 0 || otherIndex >= cps.length) return;

            const currentLevel = cps[currentIndex];
            const otherLevel = cps[otherIndex];

            const batch = writeBatch(db);
            const currentRef = doc(db, `artifacts/${appId}/public/data/cps`, currentLevel.id);
            const otherRef = doc(db, `artifacts/${appId}/public/data/cps`, otherLevel.id);

            batch.update(currentRef, { order: otherLevel.order });
            batch.update(otherRef, { order: currentLevel.order });

            try {
                await batch.commit();
            } catch (error) {
                console.error("Error reordering levels:", error);
                showErrorMessage("Erro", "Falha ao reordenar os níveis.");
            }
        }
        
        function openDojoCompetitorForm(competitorId = null) {
            clearModalHeaderButtons();
            const competitor = competitorId ? dojoRanking.find(c => c.id === competitorId) : null;
            document.getElementById('form-modal-title').textContent = competitor ? 'Editar Competidor' : 'Adicionar Competidor';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="dojo-id" value="${competitorId || ''}">
                    <div><label class="font-medium text-sm">Nome do Competidor</label><input type="text" id="dojo-name" class="form-input" required value="${competitor?.name || ''}"></div>
                    <div><label class="font-medium text-sm">URL da Foto</label><input type="url" id="dojo-photo" class="form-input" required value="${competitor?.photo || ''}"></div>
                    <div><label class="font-medium text-sm">Pontos</label><input type="number" id="dojo-points" class="form-input" required value="${competitor?.points || 0}"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveDojoCompetitor;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveDojoCompetitor(event) {
            event.preventDefault();
            const competitorId = document.getElementById('dojo-id').value;
            const data = {
                name: document.getElementById('dojo-name').value,
                photo: document.getElementById('dojo-photo').value,
                points: Number(document.getElementById('dojo-points').value)
            };
            if (!data.name || !data.photo) { showErrorMessage("Erro", "Nome e foto são obrigatórios."); return; }
            try {
                if (competitorId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/dojo_ranking`, competitorId), data);
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/dojo_ranking`), data);
                }
                showSuccessMessage("Sucesso", "Competidor do Dojo salvo.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "Não foi possível salvar o competidor."); }
        }

        function openDojoPointsForm(competitorId) {
            clearModalHeaderButtons();
            const competitor = dojoRanking.find(c => c.id === competitorId);
            if (!competitor) return;
            document.getElementById('form-modal-title').textContent = `Editar Pontos de ${competitor.name}`;
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="dojo-id" value="${competitorId}">
                    <div><label class="font-medium text-sm">Pontos</label><input type="number" id="dojo-points" class="form-input" required value="${competitor.points || 0}"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar Pontos</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveDojoPoints;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveDojoPoints(event) {
            event.preventDefault();
            const competitorId = document.getElementById('dojo-id').value;
            const points = Number(document.getElementById('dojo-points').value);
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/dojo_ranking`, competitorId), { points });
                showSuccessMessage("Sucesso", "Pontuação atualizada.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "Não foi possível atualizar a pontuação."); }
        }

        function openDojoMissionForm() {
            clearModalHeaderButtons();
            document.getElementById('form-modal-title').textContent = 'Adicionar Nova Missão';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <div><label class="font-medium text-sm">Descrição da Missão</label><input type="text" id="mission-description" class="form-input" required></div>
                    <div><label class="font-medium text-sm">Pontos</label><input type="number" id="mission-points" class="form-input" required value="0"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar Missão</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveDojoMission;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveDojoMission(event) {
            event.preventDefault();
            const data = {
                description: document.getElementById('mission-description').value,
                points: Number(document.getElementById('mission-points').value)
            };
            if (!data.description) { showErrorMessage("Erro", "A descrição é obrigatória."); return; }
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/dojo_missions`), data);
                showSuccessMessage("Sucesso", "Nova missão do Dojo adicionada.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "Não foi possível salvar a missão."); }
        }


        async function toggleTaskCompletion(taskId, isCompleted) { if (!db) return; const taskRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskId); try { await updateDoc(taskRef, { completed: isCompleted }); } catch (error) { console.error("Error updating task status:", error); } }

        async function deleteItem(collectionName, itemId) {
            if (!db) { console.warn("Offline mode."); return; }
            showConfirmationModal(
                "Confirmar Exclusão",
                "Tem certeza que deseja apagar este item? Esta ação não pode ser desfeita.",
                async () => {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/${collectionName}`, itemId));
                        showSuccessMessage("Sucesso", "Item apagado com sucesso.");
                        closeFormModal();
                    } catch (error) { 
                        console.error(`Error deleting item from ${collectionName}:`, error); 
                        showErrorMessage("Erro", "Falha ao apagar o item.");
                    }
                }
            );
        }
        
        // --- EXPORT FUNCTIONS ---
        function openHtmlInNewWindow(title, htmlContent) {
            const newWindow = window.open();
            newWindow.document.write(htmlContent);
            newWindow.document.title = title;
            newWindow.document.close();
        }
        


        function exportVipPef(vipId) {
            const vip = vips.find(v => v.id === vipId);
            const student = students.find(s => s.id === vip.studentId);
            const unitAttendance = attendance.find(a => a.id === vipId);
            if (!vip || !student) {
                showErrorMessage("Erro", "Não foi possível encontrar os dados para exportação.");
                return;
            }

            const statusMap = { 'P': 'Presente', 'F': 'Falta', 'PP': 'Presença Parcial', '': 'Não Registrado' };
            let tableRows = '';
            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance?.lessons?.[i] || {};
                const studentStatus = lessonData.students?.[student.id] || '';
                tableRows += `
                    <tr>
                        <td>${i}</td>
                        <td>${lessonData.date || ''}</td>
                        <td>${statusMap[studentStatus]}</td>
                        <td>${lessonData.topic || ''}</td>
                        <td>${lessonData.notes || ''}</td>
                    </tr>
                `;
            }

            const docHtml = `
                <html>
                <head>
                    <title>PEF - ${student.name}</title>
                    <style>
                        body { font-family: sans-serif; margin: 2rem; }
                        h1, h2 { color: #333; }
                        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
                        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .header-info p { margin: 4px 0; }
                    </style>
                </head>
                <body>
                    <h1>Relatório de Presença e Frequência (PEF)</h1>
                    <div class="header-info">
                        <p><strong>Aluno:</strong> ${student.name}</p>
                        <p><strong>Professor:</strong> ${vip.teacherName}</p>
                        <p><strong>Nível:</strong> ${vip.level}</p>
                        <p><strong>Semestre:</strong> ${vip.semestre || 'N/A'}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Aula</th>
                                <th>Data</th>
                                <th>Status</th>
                                <th>Tema da Aula</th>
                                <th>Observações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            openHtmlInNewWindow(`PEF - ${student.name}`, docHtml);
        }
        
        function exportTurmaPef(turmaId) {
            const turma = turmas.find(t => t.id === turmaId);
            if (!turma) { showErrorMessage("Erro", "Turma não encontrada."); return; }
            
            const turmaStudents = (turma.studentIds || []).map(id => students.find(s => s.id === id)).filter(Boolean);
            const unitAttendance = attendance.find(a => a.id === turmaId);
            if (!turmaStudents.length) { showErrorMessage("Erro", "Nenhum aluno na turma para exportar."); return; }

            const statusMap = { 'P': 'Presente', 'F': 'Falta', 'PP': 'Presença Parcial', '': 'Não Registrado' };
            let lessonsHtml = '';

            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance?.lessons?.[i] || {};
                const studentStatusesHtml = turmaStudents.map(s => {
                    const status = lessonData?.students?.[s.id] || '';
                    return `<li><strong>${s.name}:</strong> ${statusMap[status]}</li>`;
                }).join('');

                lessonsHtml += `
                    <div class="lesson-block">
                        <h3>Aula ${i} - Data: ${lessonData.date || 'Não definida'}</h3>
                        <p><strong>Tema:</strong> ${lessonData.topic || 'N/A'}</p>
                        <p><strong>Observações:</strong> ${lessonData.notes || 'N/A'}</p>
                        <h4>Presenças:</h4>
                        <ul>${studentStatusesHtml}</ul>
                    </div>
                `;
            }

            const docHtml = `
                <html>
                <head>
                    <title>PEF - Turma ${turma.name}</title>
                    <style>
                        body { font-family: sans-serif; margin: 2rem; }
                        h1, h2, h3, h4 { color: #333; }
                        .header-info p { margin: 4px 0; }
                        .lesson-block { border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; }
                        .lesson-block ul { list-style: none; padding-left: 0; }
                        .lesson-block li { padding: 4px 0; border-bottom: 1px dotted #eee; }
                        .lesson-block li:last-child { border-bottom: none; }
                    </style>
                </head>
                <body>
                    <h1>Relatório de Presença e Frequência (PEF)</h1>
                    <div class="header-info">
                        <h2>Turma: ${turma.name}</h2>
                        <p><strong>Professor:</strong> ${turma.teacherName}</p>
                        <p><strong>Nível:</strong> ${turma.level}</p>
                        <p><strong>Semestre:</strong> ${turma.semestre || 'N/A'}</p>
                    </div>
                    ${lessonsHtml}
                </body>
                </html>
            `;

            openHtmlInNewWindow(`PEF - Turma ${turma.name}`, docHtml);
        }

        function exportCPsDoc() {
            if (cps.length === 0) {
                showErrorMessage("Exportação Falhou", "Não há Cronogramas Pedagógicos para exportar.");
                return;
            }

            let CPsHtml = '';
            cps.forEach(nivel => {
                CPsHtml += `<h2>Nível: ${nivel.title}</h2>`;
                const lessonsHtml = (nivel.lessons && nivel.lessons.length > 0)
                    ? nivel.lessons.map((aula, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${aula.title}</td>
                            <td>${aula.topic}</td>
                            <td>${(aula.keywords || []).join(', ')}</td>
                        </tr>
                    `).join('')
                    : '<tr><td colspan="4">Nenhuma aula cadastrada.</td></tr>';

                CPsHtml += `
                    <table>
                        <thead>
                            <tr>
                                <th style="width:5%;">#</th>
                                <th style="width:25%;">Título da Aula</th>
                                <th>Tema/Descrição</th>
                                <th style="width:20%;">Palavras-chave</th>
                            </tr>
                        </thead>
                        <tbody>${lessonsHtml}</tbody>
                    </table>
                `;
            });

             const docHtml = `
                <html>
                <head>
                    <title>Cronogramas Pedagógicos (CPs) - SLAP</title>
                    <style>
                        body { font-family: sans-serif; margin: 2rem; }
                        h1 { color: #333; border-bottom: 2px solid #F1D24B; padding-bottom: 0.5rem; }
                        h2 { color: #444; margin-top: 2.5rem; border-bottom: 1px solid #ddd; padding-bottom: 0.25rem; }
                        table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
                        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    <h1>Cronogramas Pedagógicos (CPs) - SLAP</h1>
                    ${CPsHtml}
                </body>
                </html>
            `;
            
            openHtmlInNewWindow("Cronogramas Pedagógicos (CPs)", docHtml);
        }

        // --- Debug Functions ---
        function debugSyncStatus() {
            if (currentUserRole !== 'admin') return;
            
            const syncInfo = {
                isDevelopmentMode: window.isDevelopmentMode,
                hasFirebase: !!db,
                currentUser: currentUserName,
                currentRole: currentUserRole,
                challengeContent: challengeContent,
                localStorage: localStorage.getItem('slap-challenge-content'),
                timestamp: new Date().toISOString()
            };
            
            document.getElementById('form-modal-title').textContent = 'Debug: Status de Sincronização';
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-semibold text-blue-800 mb-2">Modo de Execução</h4>
                            <div class="text-sm">
                                <div class="flex justify-between">
                                    <span>Modo:</span>
                                    <span class="font-medium ${window.isDevelopmentMode ? 'text-orange-600' : 'text-green-600'}">
                                        ${window.isDevelopmentMode ? 'Desenvolvimento (Local)' : 'Produção (Firebase)'}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Firebase:</span>
                                    <span class="font-medium ${db ? 'text-green-600' : 'text-red-600'}">
                                        ${db ? 'Conectado' : 'Desconectado'}
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-semibold text-green-800 mb-2">Usuário Atual</h4>
                            <div class="text-sm">
                                <div class="flex justify-between">
                                    <span>Nome:</span>
                                    <span class="font-medium">${currentUserName}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Papel:</span>
                                    <span class="font-medium">${currentUserRole}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-stone-800 mb-3">Conteúdo Atual do Desafio</h4>
                        <div class="bg-stone-50 border border-stone-200 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <span class="font-medium">Mês:</span> ${challengeContent.month || 'N/A'}
                                </div>
                                <div>
                                    <span class="font-medium">Subtítulo:</span> ${challengeContent.subtitle || 'N/A'}
                                </div>
                                <div>
                                    <span class="font-medium">Vídeo:</span> ${challengeContent.videoUrl ? 'Definido' : 'Não definido'}
                                </div>
                                <div>
                                    <span class="font-medium">Deadline:</span> ${challengeContent.deadline ? new Date(challengeContent.deadline).toLocaleString('pt-BR') : 'N/A'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h5 class="font-medium text-yellow-800 mb-2">Diagnóstico:</h5>
                        <div class="text-sm text-yellow-700 space-y-1">
                            ${window.isDevelopmentMode ? 
                                '<p>⚠️ <strong>Modo Desenvolvimento:</strong> Mudanças são salvas apenas localmente (localStorage). Para testar sincronização, use o modo produção com Firebase.</p>' :
                                '<p>✅ <strong>Modo Produção:</strong> Mudanças são compartilhadas entre todos os usuários via Firebase em tempo real.</p>'
                            }
                            ${!db && !window.isDevelopmentMode ? 
                                '<p>❌ <strong>Firebase desconectado:</strong> Sistema está usando localStorage como fallback.</p>' : ''
                            }
                            <p>🔄 <strong>Sincronização:</strong> ${window.isDevelopmentMode ? 'Desabilitada (modo local)' : 'Ativa para todos os usuários'}</p>
                        </div>
                    </div>
                    
                    <div class="text-right">
                        <button type="button" data-action="close-form-modal" class="secondary-btn">Fechar</button>
                    </div>
                </div>
            `;
            document.getElementById('form-modal').classList.add('visible');
            
            console.log('SYNC DEBUG INFO:', syncInfo);
        }
        

        
        // --- Calendar Functions ---
        async function deleteCalendarEvent(eventId) {
            // Check if user has permission to delete events
            if (currentUserRole === 'teacher') {
                showErrorMessage("Acesso Negado", "Usuários com role 'teacher' não podem apagar eventos.");
                return;
            }
            
            if (!confirm('Tem certeza que deseja apagar este evento?')) {
                return;
            }
            
            if (window.isDevelopmentMode) {
                // Remove from local array and localStorage
                events = events.filter(e => e.id !== eventId);
                localStorage.setItem('demo-events', JSON.stringify(events));
                
                // Close modal and refresh calendar
                document.getElementById('form-modal').classList.remove('visible');
                renderCalendarioSection();
                showSuccessMessage("Sucesso!", "Evento apagado com sucesso.");
            } else if (db) {
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/events`, eventId));
                    document.getElementById('form-modal').classList.remove('visible');
                    showSuccessMessage("Sucesso!", "Evento apagado com sucesso.");
                } catch (error) {
                    console.error("Error deleting event:", error);
                    showErrorMessage("Erro", "Falha ao apagar o evento.");
                }
            }
        }
        
        function renderCalendarioSection() {
            document.getElementById('main-title').textContent = 'Calendário de Eventos';
            const contentArea = document.getElementById('content-area');
            
            contentArea.innerHTML = `
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="flex items-center gap-4">
                            <button class="calendar-nav-btn" onclick="changeMonth(-1)">« Anterior</button>
                            <h2 id="calendar-month-year" class="text-2xl font-bold text-stone-800"></h2>
                            <button class="calendar-nav-btn" onclick="changeMonth(1)">Próximo »</button>
                        </div>
                        ${currentUserRole === 'admin' ? `
                        <button class="primary-btn w-auto" data-action="add-calendar-event">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            Adicionar Evento
                        </button>
                        ` : ''}
                    </div>
                    <div class="calendar-grid" id="calendar-grid">
                        <!-- Calendar will be rendered here -->
                    </div>
                </div>
                
                <!-- Event Modal -->
                <div id="calendar-event-modal" class="modal-overlay">
                    <div class="modal-content max-w-md">
                        <div class="modal-header">
                            <h4 id="event-modal-title">Evento</h4>
                            <button data-action="close-calendar-modal" class="modal-close-btn">&times;</button>
                        </div>
                        <form id="calendar-event-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="font-medium text-sm">Título</label>
                                    <input type="text" id="event-title" class="form-input" required>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Data</label>
                                    <input type="date" id="event-date" class="form-input" required>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Horário</label>
                                    <input type="time" id="event-time" class="form-input">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Tipo</label>
                                    <select id="event-type" class="form-input" required>
                                        <option value="evento">Evento Geral</option>
                                        <option value="gravacao">Gravação</option>
                                        <option value="lembrete">Lembrete</option>
                                        <option value="aula-extra">Aula Extra</option>
                                        <option value="data-comemorativa">Data Comemorativa</option>
                                        <option value="reuniao">Reunião</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Descrição</label>
                                    <textarea id="event-description" rows="3" class="form-input"></textarea>
                                </div>
                                <div class="flex justify-end gap-2">
                                    <button type="button" data-action="close-calendar-modal" class="secondary-btn">Cancelar</button>
                                    <button type="submit" class="primary-btn w-auto">Salvar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            initializeCalendar();
        }

        let currentCalendarDate = new Date();
        let calendarEvents = [];

        function initializeCalendar() {
            loadCalendarEvents().then(() => renderCalendar());
        }

        function changeMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderCalendar();
        }

        function renderCalendar() {
            const monthYear = document.getElementById('calendar-month-year');
            const calendarGrid = document.getElementById('calendar-grid');
            
            const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            
            monthYear.textContent = `${months[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
            
            const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            let html = days.map(day => `<div class="calendar-day-header">${day}</div>`).join('');
            
            for (let i = 0; i < 42; i++) {
                const currentDay = new Date(startDate);
                currentDay.setDate(startDate.getDate() + i);
                
                const isCurrentMonth = currentDay.getMonth() === currentCalendarDate.getMonth();
                const isToday = currentDay.toDateString() === new Date().toDateString();
                const dayEvents = getEventsForDate(currentDay);
                
                html += `
                    <div class="calendar-day ${!isCurrentMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}" 
                         data-date="${currentDay.toISOString().split('T')[0]}">
                        <div class="calendar-day-number">${currentDay.getDate()}</div>
                        ${dayEvents.map(event => 
                            `<div class="calendar-event ${event.type}" onclick="viewCalendarEvent('${event.id}')">${event.title}</div>`
                        ).join('')}
                    </div>
                `;
            }
            
            calendarGrid.innerHTML = html;
        }

        function getEventsForDate(date) {
            const dateString = date.toISOString().split('T')[0];
            return calendarEvents.filter(event => event.date === dateString);
        }

        async function loadCalendarEvents() {
            if (window.isDevelopmentMode) {
                // Development mode - use localStorage
                const savedEvents = localStorage.getItem('calendar-events');
                if (savedEvents) {
                    calendarEvents = JSON.parse(savedEvents);
                } else {
                    calendarEvents = [
                        { id: '1', title: 'Reunião Pedagógica', date: '2025-01-15', time: '09:00', type: 'reuniao', description: 'Reunião mensal da equipe pedagógica' },
                        { id: '2', title: 'Gravação Aula', date: '2025-01-20', time: '14:00', type: 'gravacao', description: 'Gravação da aula de pronunciação avançada' }
                    ];
                    saveCalendarEvents();
                }
                renderCalendar();
            } else if (db) {
                // Production mode - use Firebase (read from events collection)
                try {
                    const eventsSnapshot = await getDocs(collection(db, `artifacts/${appId}/public/data/events`));
                    calendarEvents = [];
                    eventsSnapshot.forEach(doc => {
                        const eventData = doc.data();
                        calendarEvents.push({
                            id: doc.id,
                            title: eventData.titulo || eventData.title,
                            date: eventData.dataEvento || eventData.date,
                            time: eventData.horario || eventData.time,
                            type: eventData.tipo || eventData.type || 'evento',
                            description: eventData.descricao || eventData.description
                        });
                    });
                } catch (error) {
                    console.error('Error loading calendar events:', error);
                    // Fallback to localStorage
                    const savedEvents = localStorage.getItem('calendar-events');
                    if (savedEvents) {
                        calendarEvents = JSON.parse(savedEvents);
                    } else {
                        calendarEvents = [];
                    }
                }
                renderCalendar();
            }
        }

        async function saveCalendarEvents() {
            if (window.isDevelopmentMode) {
                // Development mode - save to localStorage
                localStorage.setItem('calendar-events', JSON.stringify(calendarEvents));
            }
            // Note: In production, calendar events are saved via the events collection which is already Firebase-synced
        }

        // --- Pedagogical Challenge Functions ---
        function renderDesafioPedagogicoSection() {
            document.getElementById('main-title').textContent = 'Desafio Pedagógico';
            const contentArea = document.getElementById('content-area');
            
            contentArea.innerHTML = `
                <div class="bg-[#F1D24B] p-6 rounded-xl shadow-lg mb-8">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex-grow text-center">
                            <h1 class="text-2xl sm:text-3xl font-bold text-stone-800">Pedagogical Challenge</h1>
                            <p id="challenge-subtitle-display" class="text-md sm:text-lg text-stone-700 mt-1">A new topic every month to sharpen your skills.</p>
                        </div>
                        <div class="bg-white text-stone-800 px-4 py-2 rounded-lg shadow-inner text-center flex-shrink-0">
                            <span id="challenge-month-display" class="font-bold text-xl">MONTHLY MODULE</span>
                        </div>
                        ${['admin', 'ap'].includes(currentUserRole) ? `
                        <button class="secondary-btn w-auto" data-action="edit-challenge-content">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                            Editar Conteúdo
                        </button>
                        ` : ''}

                    </div>
                    
                    <div class="mt-6 bg-stone-800 text-white p-6 rounded-lg shadow-lg">
                        <div class="flex flex-col md:flex-row items-center justify-center md:justify-around gap-6 md:gap-12">
                            <div class="text-center">
                                <h3 class="font-semibold text-base uppercase tracking-wider text-yellow-300">Deadline to Complete</h3>
                                <div id="countdown" class="flex justify-center gap-4 sm:gap-6 text-2xl sm:text-4xl mt-2">
                                    <div><span id="days" class="font-bold">00</span><span class="block text-xs sm:text-sm font-normal text-stone-300">Days</span></div>
                                    <div><span id="hours" class="font-bold">00</span><span class="block text-xs sm:text-sm font-normal text-stone-300">Hours</span></div>
                                    <div><span id="minutes" class="font-bold">00</span><span class="block text-xs sm:text-sm font-normal text-stone-300">Minutes</span></div>
                                    <div><span id="seconds" class="font-bold">00</span><span class="block text-xs sm:text-sm font-normal text-stone-300">Seconds</span></div>
                                </div>
                            </div>
                            <div class="hidden md:block w-px h-16 bg-stone-600"></div>
                            <div class="text-center flex items-center gap-4">
                                <svg class="w-12 h-12 text-yellow-300 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div class="text-left">
                                     <p class="text-lg font-bold text-white">1000 Points</p>
                                     <p class="text-sm text-stone-300">in the SLAP Dojo</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg border-2 border-stone-200">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-10">
                        <!-- Left Column: Materials -->
                        <div class="space-y-8">
                            <div>
                                <h4 class="text-xl font-semibold mb-3 flex items-center">
                                    <svg class="w-6 h-6 mr-2 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M8 5v14l11-7z"/>
                                    </svg>
                                    Video Materials
                                </h4>
                                <div id="challenge-video-container">
                                    <!-- Video content will be rendered here -->
                                </div>
                            </div>

                            <div>
                                <h4 class="text-xl font-semibold mb-3 flex items-center">
                                    <svg class="w-6 h-6 mr-2 text-sky-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 14.142M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                                    </svg>
                                    Audio Materials
                                </h4>
                                <div id="challenge-audio-container">
                                    <!-- Audio content will be rendered here -->
                                </div>
                            </div>
                        </div>

                        <!-- Right Column: Quiz -->
                        <div class="flex flex-col">
                            <h4 class="text-xl font-semibold mb-3 flex items-center">
                                <svg class="w-6 h-6 mr-2 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                                </svg>
                                The Challenge Quiz
                            </h4>
                            <div id="quiz-container" class="bg-stone-50 p-6 rounded-lg border border-stone-200 flex-grow min-h-[400px]">
                                <!-- Quiz content will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Challenge Content Edit Modal -->
                <div id="challenge-edit-modal" class="modal-overlay">
                    <div class="modal-content max-w-2xl">
                        <div class="modal-header">
                            <h4>Editar Conteúdo do Desafio</h4>
                            <button data-action="close-challenge-modal" class="modal-close-btn">&times;</button>
                        </div>
                        <form id="challenge-content-form">
                            <div class="space-y-6">
                                <div>
                                    <label class="font-medium text-sm">URL do Vídeo (Cloudinary)</label>
                                    <input type="url" id="challenge-video-url" class="form-input" placeholder="https://res.cloudinary.com/...">
                                    <p class="text-xs text-stone-500 mt-1">Deixe em branco para remover o vídeo</p>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">URL do Áudio 1 (Cloudinary)</label>
                                    <input type="url" id="challenge-audio1-url" class="form-input" placeholder="https://res.cloudinary.com/...">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">URL do Áudio 2 (Cloudinary)</label>
                                    <input type="url" id="challenge-audio2-url" class="form-input" placeholder="https://res.cloudinary.com/...">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Mês do Módulo</label>
                                    <input type="text" id="challenge-month" class="form-input" placeholder="Ex: JANEIRO 2025">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Tema do Mês (Subtítulo)</label>
                                    <input type="text" id="challenge-subtitle" class="form-input" placeholder="Ex: A new topic every month to sharpen your skills.">
                                    <p class="text-xs text-stone-500 mt-1">Texto que aparece abaixo do título principal</p>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Data Limite (Deadline)</label>
                                    <input type="datetime-local" id="challenge-deadline" class="form-input">
                                </div>
                                <div class="flex justify-end gap-2">
                                    <button type="button" data-action="close-challenge-modal" class="secondary-btn">Cancelar</button>
                                    <button type="submit" class="primary-btn w-auto">Salvar Conteúdo</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            initializePedagogicalChallenge().catch(console.error);
        }

        // --- Pedagogical Challenge Implementation ---
        let challengeContent = {
            videoUrl: '',
            audio1Url: '',
            audio2Url: '',
            month: 'MONTHLY MODULE',
            deadline: null
        };

        let teacherName = '';
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let correctStreak = 0;
        let totalAttempts = 0;
        const questionsNeededForSuccess = 20;
        const questionsInChallenge = 20;

        const fullQuizData = [
            // Dogme ELT Questions (25 questions)
            { q: "According to Thornbury, what is the main role of the teacher in a Dogme-based classroom?", o: ["To follow the coursebook closely", "To correct all grammar errors immediately", "To facilitate and respond to emergent language*", "To deliver pre-planned grammar presentations"], a: 2, e: "In Dogme ELT, teachers act as facilitators who respond to language that emerges naturally from student interaction rather than following rigid lesson plans." },
            { q: "What does 'noticing' primarily help with in advanced learners?", o: ["Expanding vocabulary rapidly", "Developing listening skills", "Identifying fossilized errors*", "Memorizing phrasal verbs"], a: 2, e: "Noticing helps advanced learners become aware of persistent language errors that have become fossilized in their production." },
            { q: "Dogme ELT emphasizes:", o: ["Heavy reliance on multimedia resources", "Teaching fixed grammar structures", "Predefined learning outcomes", "Conversation-driven instruction*"], a: 3, e: "Dogme prioritizes natural conversation and interaction over predetermined curricula and materials." },
            { q: "What is a common challenge advanced learners face, according to Thornbury?", o: ["Lack of interest in grammar", "Inability to understand basic tenses", "Repetition of fossilized errors*", "Low vocabulary range"], a: 2, e: "Advanced learners often struggle with persistent errors that have become automatic and require conscious attention to correct." },
            { q: "Emergent language refers to:", o: ["Vocabulary from the syllabus", "Language that arises spontaneously during interaction*", "Language from previous homework", "Phrases taken from authentic texts"], a: 1, e: "Emergent language is the language that naturally emerges from student interaction and communication needs in the moment." },
            { q: "Which of the following best represents Thornbury's view of the coursebook in Dogme?", o: ["A non-negotiable part of every lesson", "A helpful supplementary tool", "An optional, secondary resource", "Often an obstacle to genuine interaction*"], a: 3, e: "Thornbury views coursebooks as potentially limiting authentic interaction and emergent learning opportunities." },
            { q: "What is one core principle of Dogme teaching?", o: ["Silence is golden", "Grammar translation is key", "Learner output drives learning*", "Drilling ensures retention"], a: 2, e: "Dogme believes that learning is most effective when driven by what learners actually produce and need to communicate." },
            { q: "Why is noticing especially important for advanced learners?", o: ["They are preparing for tests", "They don't need explicit grammar", "Their language awareness needs refining*", "They need more input than output"], a: 2, e: "Advanced learners benefit from refined language awareness to identify and correct subtle errors in their production." },
            { q: "Which of the following is most aligned with emergent language pedagogy?", o: ["Ignoring student errors", "Focusing on accuracy before fluency", "Using language produced by learners as teaching material*", "Teaching only from the textbook"], a: 2, e: "Emergent pedagogy uses actual student language production as the primary source of teaching content and focus." },
            { q: "A key benefit of emergent language instruction is:", o: ["It reduces lesson planning time", "It creates mechanical practice", "It fosters personalized learning experiences*", "It removes the need for assessment"], a: 2, e: "Emergent instruction creates highly personalized learning experiences based on individual student needs and output." },
            { q: "Which teacher behavior best fits the noticing framework?", o: ["Allowing errors to persist unaddressed", "Reformulating student sentences in real-time*", "Avoiding correction to preserve fluency", "Testing students on isolated grammar points"], a: 1, e: "Reformulation helps students notice the difference between their production and more target-like forms." },
            { q: "What type of flexibility does Dogme require from teachers?", o: ["Willingness to change jobs", "Ability to switch between coursebooks", "Adapting plans based on learner interaction*", "Using technology to change lesson pace"], a: 2, e: "Dogme teachers must be flexible enough to adapt their teaching based on what emerges from student interaction." },
            { q: "According to Thornbury, language should be taught:", o: ["Before it is produced", "From student-generated content*", "With strict grammatical accuracy", "Only after assessment"], a: 1, e: "Thornbury advocates for using language that students actually produce as the basis for teaching and learning." },
            { q: "What is the ultimate goal of noticing in advanced learners?", o: ["To prepare them for native-level conversation", "To memorize fixed expressions", "To activate conscious reflection about language use*", "To eliminate fluency gaps"], a: 2, e: "Noticing aims to develop conscious awareness and reflection about language patterns and usage." },
            { q: "Thornbury advocates for:", o: ["Content-heavy PowerPoint lessons", "Structured grammar drills", "Spontaneous language-focused sessions*", "Coursebook-led speaking exercises"], a: 2, e: "Thornbury prefers spontaneous, language-focused sessions that emerge from student interaction." },
            { q: "Which technique aligns most with Thornbury's approach?", o: ["Present–Practice–Produce", "Reformulation and guided noticing*", "Translation and dictation", "Grammar gap-fills"], a: 1, e: "Reformulation and guided noticing are key techniques in helping students become aware of language patterns." },
            { q: "What type of classroom activity would Thornbury likely support?", o: ["Role-play with unpredictable outcomes*", "Reading comprehension from textbooks", "Silent reading sessions", "Grammar quizzes"], a: 0, e: "Unpredictable role-plays create opportunities for genuine emergent language that can be worked with pedagogically." },
            { q: "How can teachers track emergent language?", o: ["Ignore it and continue the lesson", "Record and revisit student errors*", "Focus only on written accuracy", "Use ready-made worksheets"], a: 1, e: "Teachers should record emergent language issues to revisit and work on them pedagogically." },
            { q: "What is a typical issue in fossilization?", o: ["Teachers overcorrect mistakes", "Learners are unaware of persistent errors*", "Materials are too advanced", "Students memorize too quickly"], a: 1, e: "Fossilization occurs when learners are unaware of persistent errors that have become automatic." },
            { q: "Why might coursebooks be counterproductive in advanced classes, according to Thornbury?", o: ["They are too expensive", "They lack spontaneity and authentic interaction*", "They overuse listening activities", "They don't include enough homework"], a: 1, e: "Coursebooks can limit the spontaneous, authentic interaction that advanced learners need for continued development." },
            { q: "Noticing can be enhanced through:", o: ["Multiple-choice questions", "Grammar translation", "Contrasting learner and native-like output*", "Ignoring errors for fluency"], a: 2, e: "Contrasting student output with more target-like versions helps enhance noticing and awareness." },
            { q: "What is a sign that a learner needs more noticing?", o: ["They hesitate when speaking", "They produce frequent but subtle errors*", "They ask too many questions", "They refuse to write"], a: 1, e: "Frequent subtle errors indicate that learners have fossilized patterns that need conscious attention and noticing to correct." },
            { q: "Which of the following best describes Dogme's view on input?", o: ["Authentic input must always come from native speakers", "All input should be teacher-generated", "Learners themselves generate the most relevant input*", "Input should be controlled and limited"], a: 2, e: "In Dogme, learners' own language production becomes the primary source of meaningful and relevant input for further learning." },
            { q: "Which mindset should a teacher adopt for emergent language teaching?", o: ["Control and delivery", "Observation and responsiveness*", "Correction and drilling", "Silence and monitoring"], a: 1, e: "Emergent language teaching requires teachers to be observant and responsive to learning opportunities as they arise naturally." },
            { q: "Which of the following best reflects Thornbury's philosophy?", o: ["Language is best acquired through repeated testing", "Learning occurs most effectively through structured tasks", "Language awareness must be developed through active engagement*", "Students need more input than output"], a: 2, e: "Thornbury believes that conscious engagement with language, particularly through noticing and reflection, is key to language development." },
            
            // Michael Lewis Lexical Approach Questions (25 questions)
            { q: "According to Michael Lewis, what is the primary component of language?", o: ["Grammar rules", "Phonological systems", "Lexical chunks*", "Discrete vocabulary words"], a: 2, e: "Lewis argues that language is primarily made up of prefabricated chunks or collocations rather than individual words and grammar rules." },
            { q: "What does Lewis mean by 'language consists of grammaticalized lexis'?", o: ["Grammar should be taught before vocabulary", "Vocabulary should be organized by parts of speech", "Grammar emerges from lexical patterns*", "Lexis must be learned through grammar"], a: 2, e: "Lewis believes that grammar patterns emerge naturally from how words combine in chunks, rather than being separate rules to memorize." },
            { q: "Which of the following is an example of a lexical chunk?", o: ["Verb + ing", "Present perfect", "Make a mistake*", "A noun in plural"], a: 2, e: "A lexical chunk is a group of words that commonly appear together, like 'make a mistake', 'strong coffee', or 'by the way'." },
            { q: "The Lexical Approach argues against:", o: ["Teaching collocations", "Learning isolated grammar structures*", "Using authentic texts", "Encouraging fluency"], a: 1, e: "The Lexical Approach opposes teaching grammar as isolated rules separate from meaningful chunks of language." },
            { q: "According to Schmitt (2000), why does the brain prefer chunks?", o: ["They are easier to spell", "They activate the visual cortex", "They reduce cognitive load*", "They follow textbook logic"], a: 2, e: "Processing prefabricated chunks requires less cognitive effort than constructing language from individual elements each time." },
            { q: "What replaces the traditional PPP model in Lewis's approach?", o: ["Explain–Drill–Repeat", "Present–Produce–Perfect", "Observe–Hypothesise–Experiment*", "Input–Output–Feedback"], a: 2, e: "Lewis proposes OHE (Observe–Hypothesise–Experiment) as a more natural way to acquire language through discovery rather than presentation." },
            { q: "In the 'Observe' phase, students:", o: ["Take grammar notes from rules", "Memorize irregular verbs", "Identify lexical patterns in authentic texts*", "Translate texts word for word"], a: 2, e: "Students observe how language naturally occurs in authentic contexts to notice chunks and patterns." },
            { q: "During the 'Hypothesise' phase, students:", o: ["Guess meanings and usage of chunks*", "Correct grammar in sentences", "Write essays from memory", "Identify parts of speech"], a: 0, e: "Students form hypotheses about how chunks work and their meanings based on observed patterns." },
            { q: "The 'Experiment' stage encourages students to:", o: ["Avoid errors", "Use chunks in creative, real tasks*", "Fill in grammar worksheets", "Learn from the teacher's corrections"], a: 1, e: "Students experiment with using chunks in authentic, meaningful communication tasks." },
            { q: "What is the ultimate goal of the Lexical Approach?", o: ["Perfect grammar use", "Fluent and natural communication*", "Memorizing academic vocabulary", "Mastering verb conjugation"], a: 1, e: "The Lexical Approach aims for natural, fluent communication through mastery of lexical chunks." },
            { q: "Lewis views grammar as something that should be:", o: ["Taught in isolation", "Memorized before speaking", "Avoided completely", "Acquired implicitly through chunks*"], a: 3, e: "Grammar should be acquired naturally through exposure to and use of lexical chunks rather than explicit teaching." },
            { q: "What kind of input does the Lexical Approach favor?", o: ["Artificially simplified sentences", "Authentic and real-life language*", "Grammatical drills", "Repetition of isolated verbs"], a: 1, e: "Authentic, real-life language provides natural examples of how chunks are used in context." },
            { q: "What kind of classroom activity best aligns with the Lexical Approach?", o: ["Gap-fills using collocations*", "Timed grammar quizzes", "Phoneme dictation", "Silent reading of lists"], a: 0, e: "Activities that focus on collocations and chunks help students notice and practice lexical patterns." },
            { q: "Which of the following would NOT be typical in a lexical classroom?", o: ["Chunk identification in authentic audio", "Creative rewriting using collocations", "Translation of entire paragraphs", "Teaching grammar in isolation*"], a: 3, e: "Teaching grammar in isolation goes against the lexical approach principle of learning grammar through chunks." },
            { q: "What is a 'collocation box' used for?", o: ["Listing irregular verbs", "Tracking spelling mistakes", "Organizing common word pairings*", "Highlighting past participles"], a: 2, e: "Collocation boxes help organize and learn common word combinations and lexical patterns." },
            { q: "A teacher using the Lexical Approach might ask students to:", o: ["List all prepositions", "Identify and reuse useful chunks in conversation*", "Avoid idioms in writing", "Conjugate all modal verbs"], a: 1, e: "Students are encouraged to notice useful chunks and then actively use them in their own communication." },
            { q: "Lewis's methodology emphasizes:", o: ["Structured grammar presentations", "Contextualized exposure to real language*", "Memorizing dictionaries", "Monolingual definitions"], a: 1, e: "Real, contextualized language exposure helps students see how chunks function naturally." },
            { q: "Repetition and recycling of chunks is used to:", o: ["Teach phonology", "Improve pronunciation accuracy", "Enhance retention and fluency*", "Promote grammar mastery"], a: 2, e: "Repeated exposure and use of chunks helps students internalize them for fluent, automatic use." },
            { q: "Which phrase best summarizes Lewis's belief?", o: ["Grammar creates vocabulary", "Lexis is secondary to form", "Grammar is the foundation of all speech", "Lexis drives grammar, not the other way around*"], a: 3, e: "Lewis believes that lexical patterns drive grammatical understanding, reversing traditional priorities." },
            { q: "Chunk-for-chunk translation helps learners:", o: ["Understand isolated grammar rules", "Focus on equivalent lexical patterns*", "Translate word-by-word", "Ignore pragmatic meaning"], a: 1, e: "Chunk-for-chunk translation helps learners see equivalent patterns between languages rather than word-by-word correspondence." },
            { q: "How can the Lexical Approach be integrated into CLT or TBL?", o: ["Through drills after reading", "By teaching grammar first, then activating it", "By highlighting useful chunks and encouraging use in tasks*", "Through rote learning of textbook dialogues"], a: 2, e: "Integration involves identifying useful chunks in communicative tasks and encouraging their active use." },
            { q: "What does 'noticing lexical patterns' mean in this context?", o: ["Memorizing vocabulary lists", "Focusing on how language is built through fixed expressions*", "Avoiding grammar at all times", "Creating new words from roots"], a: 1, e: "Noticing lexical patterns involves recognizing how language is constructed through recurring combinations of words." },
            { q: "According to Lewis, grammar is best learned:", o: ["After lexis is fully mastered", "Through explicit drills", "Within lexical chunks and meaningful context*", "Through native-speaker imitation"], a: 2, e: "Grammar is most effectively learned when encountered within meaningful lexical chunks rather than as isolated rules." },
            { q: "Why are authentic texts important in the Lexical Approach?", o: ["They test reading speed", "They illustrate textbook rules", "They provide real examples of chunk usage*", "They contain simpler grammar"], a: 2, e: "Authentic texts show how chunks are actually used in real communication contexts." },
            { q: "What kind of outcome does Lewis's approach aim for?", o: ["Native-like pronunciation", "Controlled accuracy", "Spontaneous and meaningful fluency*", "Structured writing skills"], a: 2, e: "The goal is natural, spontaneous fluency through mastery of lexical chunks rather than perfect formal accuracy." }
        ];

        async function initializePedagogicalChallenge() {
            await loadChallengeContent();
            renderChallengeContent();
            initializeCountdown();
            showQuizWelcome();
            
            // Set up real-time listener for Firebase updates
            if (!window.isDevelopmentMode && db) {
                const docRef = doc(db, `artifacts/${appId}/public/data/challenge-content`, 'current');
                onSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        const newContent = {
                            videoUrl: data.videoUrl || '',
                            audio1Url: data.audio1Url || '',
                            audio2Url: data.audio2Url || '',
                            month: data.month || 'MONTHLY MODULE',
                            subtitle: data.subtitle || 'A new topic every month to sharpen your skills.',
                            deadline: data.deadline || null
                        };
                        
                        // Only update if content changed to avoid infinite loops
                        if (JSON.stringify(newContent) !== JSON.stringify(challengeContent)) {
                            challengeContent = newContent;
                            renderChallengeContent();
                            
                            // Restart countdown with new deadline
                            if (countdownInterval) {
                                clearInterval(countdownInterval);
                            }
                            initializeCountdown();
                            
                            // Show notification that content was updated
                            if (data.updatedBy && data.updatedBy !== currentUserName) {
                                showSuccessMessage("Atualização!", `Conteúdo atualizado por ${data.updatedBy}`);
                            }
                        }
                    }
                }, (error) => {
                    console.error("Error listening to challenge content updates:", error);
                });
            }
        }

        async function loadChallengeContent() {
            if (window.isDevelopmentMode) {
                // In development mode, load from localStorage
                const saved = localStorage.getItem('slap-challenge-content');
                if (saved) {
                    challengeContent = JSON.parse(saved);
                } else {
                    setDefaultChallengeContent();
                }
            } else if (db) {
                // In production, load from Firebase so it's shared across all users
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/challenge-content`, 'current');
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        challengeContent = {
                            videoUrl: data.videoUrl || '',
                            audio1Url: data.audio1Url || '',
                            audio2Url: data.audio2Url || '',
                            month: data.month || 'MONTHLY MODULE',
                            subtitle: data.subtitle || 'A new topic every month to sharpen your skills.',
                            deadline: data.deadline || null
                        };
                    } else {
                        setDefaultChallengeContent();
                    }
                } catch (error) {
                    console.error("Error loading challenge content:", error);
                    // Fallback to localStorage
                    const saved = localStorage.getItem('slap-challenge-content');
                    if (saved) {
                        challengeContent = JSON.parse(saved);
                    } else {
                        setDefaultChallengeContent();
                    }
                }
            } else {
                // Fallback to localStorage
                const saved = localStorage.getItem('slap-challenge-content');
                if (saved) {
                    challengeContent = JSON.parse(saved);
                } else {
                    setDefaultChallengeContent();
                }
            }
        }
        
        function setDefaultChallengeContent() {
            const now = new Date();
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
            
            challengeContent = {
                videoUrl: 'https://res.cloudinary.com/dqfi22uz0/video/upload/v1751160446/Vygotksy_s_Zone_of_Proximal_Development_Explained_in_4_minutes_n3dmpt.mp4',
                audio1Url: 'https://res.cloudinary.com/dqfi22uz0/video/upload/v1751161824/zdp1_yldo65.mp3',
                audio2Url: 'https://res.cloudinary.com/dqfi22uz0/video/upload/v1751162058/ZDP2_jfyspg.mp3',
                month: 'JANEIRO 2025',
                subtitle: 'A new topic every month to sharpen your skills.',
                deadline: endOfMonth.toISOString()
            };
            saveChallengeContent();
        }

        async function saveChallengeContent() {
            if (window.isDevelopmentMode) {
                // In development mode, save to localStorage
                localStorage.setItem('slap-challenge-content', JSON.stringify(challengeContent));
            } else if (db) {
                // In production, save to Firebase so it's shared across all users
                try {
                    await setDoc(doc(db, `artifacts/${appId}/public/data/challenge-content`, 'current'), {
                        ...challengeContent,
                        updatedAt: serverTimestamp(),
                        updatedBy: currentUserName
                    });
                } catch (error) {
                    console.error("Error saving challenge content:", error);
                    // Fallback to localStorage if Firebase fails
                    localStorage.setItem('slap-challenge-content', JSON.stringify(challengeContent));
                }
            } else {
                // Fallback to localStorage
                localStorage.setItem('slap-challenge-content', JSON.stringify(challengeContent));
            }
        }

        function renderChallengeContent() {
            console.log('Rendering challenge content:', challengeContent);
            renderVideoContent();
            renderAudioContent();
            updateChallengeHeader();
        }

        function updateChallengeHeader() {
            const monthDisplay = document.getElementById('challenge-month-display');
            const subtitleDisplay = document.getElementById('challenge-subtitle-display');
            
            if (monthDisplay && challengeContent.month) {
                monthDisplay.textContent = challengeContent.month;
            }
            
            if (subtitleDisplay && challengeContent.subtitle) {
                subtitleDisplay.textContent = challengeContent.subtitle;
            }
        }

        function renderVideoContent() {
            const container = document.getElementById('challenge-video-container');
            console.log('Rendering video content. URL:', challengeContent.videoUrl);
            if (challengeContent.videoUrl) {
                container.innerHTML = `
                    <div class="mb-4">
                        <div class="aspect-video bg-stone-200 rounded-lg overflow-hidden">
                            <video controls class="w-full h-full">
                                <source src="${challengeContent.videoUrl}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="text-center py-8 text-stone-500">
                        <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m2-10a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p>Nenhum vídeo configurado</p>
                        ${['admin', 'ap'].includes(currentUserRole) ? '<p class="text-xs mt-1">Configure um vídeo através do botão "Editar Conteúdo"</p>' : ''}
                    </div>
                `;
            }
        }

        function renderAudioContent() {
            const container = document.getElementById('challenge-audio-container');
            console.log('Rendering audio content. Audio1:', challengeContent.audio1Url, 'Audio2:', challengeContent.audio2Url);
            let audioHtml = '';

            if (challengeContent.audio1Url) {
                audioHtml += `
                    <div class="mb-4">
                        <p class="font-medium text-stone-700 mb-2">Audio 1</p>
                        ${createAudioPlayer(challengeContent.audio1Url, 'audio1')}
                    </div>
                `;
            }

            if (challengeContent.audio2Url) {
                audioHtml += `
                    <div class="mb-4">
                        <p class="font-medium text-stone-700 mb-2">Audio 2</p>
                        ${createAudioPlayer(challengeContent.audio2Url, 'audio2')}
                    </div>
                `;
            }

            if (!challengeContent.audio1Url && !challengeContent.audio2Url) {
                audioHtml = `
                    <div class="text-center py-8 text-stone-500">
                        <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 14.142M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                        </svg>
                        <p>Nenhum áudio configurado</p>
                        ${['admin', 'ap'].includes(currentUserRole) ? '<p class="text-xs mt-1">Configure áudios através do botão "Editar Conteúdo"</p>' : ''}
                    </div>
                `;
            }

            container.innerHTML = audioHtml;
            
            // Use setTimeout to ensure DOM is ready before initializing players
            setTimeout(() => {
                initializeAudioPlayers();
            }, 100);
        }

        function createAudioPlayer(audioUrl, playerId) {
            // Add timestamp to avoid cache issues with Cloudinary
            const cacheBustedUrl = audioUrl.includes('?') ? `${audioUrl}&t=${Date.now()}` : `${audioUrl}?t=${Date.now()}`;
            
            return `
                <div class="audio-player-container" data-player="${playerId}">
                    <button class="play-pause-button">
                        <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>
                        <svg class="pause-icon hidden" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
                    </button>
                    <span class="time-display">0:00 / 0:00</span>
                    <input type="range" class="progress-bar" value="0" step="1">
                    <audio class="audio-element" preload="metadata" src="${cacheBustedUrl}"></audio>
                </div>
            `;
        }

        function cleanupAudioPlayers() {
            // Stop and cleanup existing audio players
            const existingPlayers = document.querySelectorAll('.audio-player-container');
            existingPlayers.forEach(container => {
                const audio = container.querySelector('.audio-element');
                if (audio) {
                    audio.pause();
                    audio.currentTime = 0;
                    // Remove event listeners to prevent memory leaks
                    audio.removeEventListener('loadedmetadata', () => {});
                    audio.removeEventListener('timeupdate', () => {});
                    audio.removeEventListener('error', () => {});
                }
            });
        }

        function initializeAudioPlayers() {
            // Clean up any existing audio players first
            cleanupAudioPlayers();
            
            const players = document.querySelectorAll('.audio-player-container');
            console.log('Initializing audio players. Found:', players.length, 'players');
            
            players.forEach((container, index) => {
                const audio = container.querySelector('.audio-element');
                const playButton = container.querySelector('.play-pause-button');
                const playIcon = container.querySelector('.play-icon');
                const pauseIcon = container.querySelector('.pause-icon');
                const progressBar = container.querySelector('.progress-bar');
                const timeDisplay = container.querySelector('.time-display');
                
                if (!audio || !playButton || !playIcon || !pauseIcon || !progressBar || !timeDisplay) {
                    console.error('Missing audio player elements for player', index);
                    return;
                }
                
                console.log('Setting up audio player', index, 'for:', audio.src);
                
                // Ensure audio element is properly configured
                audio.preload = 'metadata';
                audio.crossOrigin = 'anonymous';
                
                // Force reload audio element to clear cache
                if (audio.src) {
                    audio.load();
                }

                const loadedMetadataHandler = () => {
                    if (audio.duration && !isNaN(audio.duration) && audio.duration !== Infinity) {
                        progressBar.max = audio.duration;
                        updateTimeDisplay();
                        console.log('Audio', index, 'metadata loaded, duration:', audio.duration);
                    }
                };

                const timeUpdateHandler = () => {
                    if (audio.duration && !isNaN(audio.duration)) {
                        progressBar.value = audio.currentTime;
                        updateTimeDisplay();
                    }
                };

                const errorHandler = (e) => {
                    console.error('Audio', index, 'loading error:', e);
                    timeDisplay.textContent = 'Error loading audio';
                };

                const endedHandler = () => {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                    audio.currentTime = 0;
                    progressBar.value = 0;
                    updateTimeDisplay();
                };

                // Add event listeners
                audio.addEventListener('loadedmetadata', loadedMetadataHandler);
                audio.addEventListener('timeupdate', timeUpdateHandler);
                audio.addEventListener('error', errorHandler);
                audio.addEventListener('ended', endedHandler);

                playButton.addEventListener('click', () => {
                    console.log('Play button clicked for audio', index, ', paused:', audio.paused);
                    if (audio.paused) {
                        // Pause all other audio players first
                        const allAudioElements = document.querySelectorAll('.audio-element');
                        allAudioElements.forEach(otherAudio => {
                            if (otherAudio !== audio && !otherAudio.paused) {
                                otherAudio.pause();
                                const otherContainer = otherAudio.closest('.audio-player-container');
                                if (otherContainer) {
                                    const otherPlayIcon = otherContainer.querySelector('.play-icon');
                                    const otherPauseIcon = otherContainer.querySelector('.pause-icon');
                                    if (otherPlayIcon && otherPauseIcon) {
                                        otherPlayIcon.classList.remove('hidden');
                                        otherPauseIcon.classList.add('hidden');
                                    }
                                }
                            }
                        });
                        
                        audio.play().then(() => {
                            playIcon.classList.add('hidden');
                            pauseIcon.classList.remove('hidden');
                            console.log('Audio', index, 'started playing');
                        }).catch(e => {
                            console.error('Error playing audio', index, ':', e);
                            alert('Erro ao reproduzir áudio. Verifique se a URL está funcionando.');
                        });
                    } else {
                        audio.pause();
                        playIcon.classList.remove('hidden');
                        pauseIcon.classList.add('hidden');
                        console.log('Audio', index, 'paused');
                    }
                });

                progressBar.addEventListener('input', () => {
                    if (audio.duration && !isNaN(audio.duration)) {
                        audio.currentTime = progressBar.value;
                    }
                });

                function updateTimeDisplay() {
                    const current = formatTime(audio.currentTime || 0);
                    const duration = formatTime(audio.duration || 0);
                    timeDisplay.textContent = `${current} / ${duration}`;
                }

                function formatTime(seconds) {
                    if (isNaN(seconds) || seconds === Infinity) return '0:00';
                    const minutes = Math.floor(seconds / 60);
                    const secs = Math.floor(seconds % 60);
                    return `${minutes}:${secs.toString().padStart(2, '0')}`;
                }
                
                // Initialize display
                updateTimeDisplay();
            });
        }

        function openChallengeContentForm() {
            const modal = document.getElementById('challenge-edit-modal');
            const form = document.getElementById('challenge-content-form');
            
            // Pre-fill form
            document.getElementById('challenge-video-url').value = challengeContent.videoUrl || '';
            document.getElementById('challenge-audio1-url').value = challengeContent.audio1Url || '';
            document.getElementById('challenge-audio2-url').value = challengeContent.audio2Url || '';
            document.getElementById('challenge-month').value = challengeContent.month || '';
            document.getElementById('challenge-subtitle').value = challengeContent.subtitle || '';
            
            // Pre-fill deadline
            if (challengeContent.deadline) {
                let date;
                if (typeof challengeContent.deadline === 'number') {
                    date = new Date(challengeContent.deadline);
                } else {
                    date = new Date(challengeContent.deadline);
                }
                
                // Ensure the date is valid before formatting
                if (!isNaN(date.getTime())) {
                    const formattedDate = date.toISOString().slice(0, 16);
                    document.getElementById('challenge-deadline').value = formattedDate;
                }
            }
            
            modal.classList.add('visible');
            
            form.onsubmit = (e) => {
                e.preventDefault();
                saveChallengeContentForm();
                modal.classList.remove('visible');
            };
        }

        async function saveChallengeContentForm() {
            const deadlineValue = document.getElementById('challenge-deadline').value;
            
            let deadline = null;
            if (deadlineValue) {
                const deadlineDate = new Date(deadlineValue);
                if (!isNaN(deadlineDate.getTime())) {
                    deadline = deadlineDate.toISOString(); // Store as ISO string for consistency
                }
            }
            
            challengeContent = {
                videoUrl: document.getElementById('challenge-video-url').value.trim(),
                audio1Url: document.getElementById('challenge-audio1-url').value.trim(),
                audio2Url: document.getElementById('challenge-audio2-url').value.trim(),
                month: document.getElementById('challenge-month').value.trim() || 'MONTHLY MODULE',
                subtitle: document.getElementById('challenge-subtitle').value.trim() || 'A new topic every month to sharpen your skills.',
                deadline: deadline
            };
            
            await saveChallengeContent();
            renderChallengeContent();
            
            // Restart countdown with new deadline
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            initializeCountdown();
            
            // Reset form safely
            const form = document.getElementById('challenge-content-form');
            if (form) {
                form.reset();
            }
        }

        let countdownInterval = null;

        function initializeCountdown() {
            // Use custom deadline or default to end of current month
            let deadline;
            if (challengeContent.deadline) {
                // Handle both timestamp and date string formats
                if (typeof challengeContent.deadline === 'number') {
                    deadline = new Date(challengeContent.deadline);
                } else {
                    deadline = new Date(challengeContent.deadline);
                }
            } else {
                const now = new Date();
                deadline = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
            }
            
            function updateCountdown() {
                const now = new Date().getTime();
                const distance = deadline.getTime() - now;
                
                const daysEl = document.getElementById('days');
                const hoursEl = document.getElementById('hours');
                const minutesEl = document.getElementById('minutes');
                const secondsEl = document.getElementById('seconds');
                
                if (distance > 0) {
                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    
                    if (daysEl) daysEl.textContent = days.toString().padStart(2, '0');
                    if (hoursEl) hoursEl.textContent = hours.toString().padStart(2, '0');
                    if (minutesEl) minutesEl.textContent = minutes.toString().padStart(2, '0');
                    if (secondsEl) secondsEl.textContent = seconds.toString().padStart(2, '0');
                } else {
                    if (daysEl) daysEl.textContent = '00';
                    if (hoursEl) hoursEl.textContent = '00';
                    if (minutesEl) minutesEl.textContent = '00';
                    if (secondsEl) secondsEl.textContent = '00';
                }
            }
            
            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
        }

        function showQuizWelcome() {
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.innerHTML = `
                <div class="text-center h-full flex flex-col justify-center">
                    <svg class="w-16 h-16 mx-auto mb-4 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                    <h3 class="text-xl font-bold mb-2 text-violet-600">🎯 Desafio Pedagógico</h3>
                    <p class="text-stone-600 mb-4">Estude o conteúdo acima e depois faça o desafio para testar seu conhecimento!</p>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 max-w-md mx-auto">
                        <p class="text-sm text-blue-800">
                            <strong>🏆 Desafio:</strong> Acerte 20 perguntas consecutivas<br>
                            <strong>⚠️ Regra:</strong> Uma pergunta errada reinicia tudo<br>
                            <strong>🔀 Sistema:</strong> Perguntas sempre em ordem aleatória
                        </p>
                    </div>
                    <button onclick="window.startQuiz()" class="primary-btn w-auto mx-auto">🚀 Iniciar Desafio</button>
                </div>
            `;
        }

        window.startQuiz = function() {
            // Reset streak variables
            correctStreak = 0;
            totalAttempts = 0;
            currentQuestionIndex = 0;
            
            // Shuffle all questions to ensure randomness every time
            const shuffled = [...fullQuizData].sort(() => Math.random() - 0.5);
            quizQuestions = shuffled.map(question => {
                // Find correct answer by asterisk (*) and clean options
                let correctIndex = -1;
                const cleanedOptions = question.o.map((option, index) => {
                    if (option.includes('*')) {
                        correctIndex = index;
                        return option.replace('*', ''); // Remove asterisk for display
                    }
                    return option;
                });
                
                // If no asterisk found, use the original 'a' property
                if (correctIndex === -1) {
                    correctIndex = question.a;
                }
                
                // Create shuffled options with correct answer tracking
                const optionsWithIndices = cleanedOptions.map((option, index) => ({
                    text: option,
                    originalIndex: index
                }));
                
                // Shuffle the options
                const shuffledOptions = optionsWithIndices.sort(() => Math.random() - 0.5);
                
                // Find new correct answer index after shuffling
                const newCorrectIndex = shuffledOptions.findIndex(opt => opt.originalIndex === correctIndex);
                
                return {
                    ...question,
                    o: shuffledOptions.map(opt => opt.text),
                    a: newCorrectIndex
                };
            });
            
            showNameInput();
        }

        function showNameInput() {
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.innerHTML = `
                <div class="text-center h-full flex flex-col justify-center">
                    <h3 class="text-xl font-bold mb-4 text-violet-600">🎯 Desafio Pedagógico - Streak Challenge</h3>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                        <p class="text-stone-700 mb-2"><strong>Objetivo:</strong> Acerte 20 perguntas consecutivas para completar o desafio!</p>
                        <p class="text-red-600 text-sm font-medium">⚠️ Se errar uma pergunta, o desafio reinicia do zero!</p>
                        <p class="text-blue-600 text-sm mt-2">💡 As perguntas sempre aparecem em ordem aleatória</p>
                    </div>
                    <input type="text" id="teacher-name-input" class="form-input mb-4 max-w-sm mx-auto" placeholder="Seu nome completo" required>
                    <button onclick="window.submitName()" class="primary-btn w-auto mx-auto">🚀 Iniciar Desafio</button>
                </div>
            `;
        }

        window.submitName = function() {
            const nameInput = document.getElementById('teacher-name-input');
            teacherName = nameInput.value.trim();
            
            if (teacherName) {
                showQuestion();
            } else {
                alert('Please enter your name to continue.');
            }
        }

        function showQuestion() {
            // Get current question from shuffled pool
            if (currentQuestionIndex >= quizQuestions.length) {
                // Reshuffle if we've gone through all questions
                const shuffled = [...fullQuizData].sort(() => Math.random() - 0.5);
                quizQuestions = shuffled.map(question => {
                    let correctIndex = -1;
                    const cleanedOptions = question.o.map((option, index) => {
                        if (option.includes('*')) {
                            correctIndex = index;
                            return option.replace('*', '');
                        }
                        return option;
                    });
                    
                    if (correctIndex === -1) {
                        correctIndex = question.a;
                    }
                    
                    const optionsWithIndices = cleanedOptions.map((option, index) => ({
                        text: option,
                        originalIndex: index
                    }));
                    
                    const shuffledOptions = optionsWithIndices.sort(() => Math.random() - 0.5);
                    const newCorrectIndex = shuffledOptions.findIndex(opt => opt.originalIndex === correctIndex);
                    
                    return {
                        ...question,
                        o: shuffledOptions.map(opt => opt.text),
                        a: newCorrectIndex
                    };
                });
                currentQuestionIndex = 0;
            }
            
            const question = quizQuestions[currentQuestionIndex];
            if (!question) {
                console.error('Question not found at index:', currentQuestionIndex);
                return;
            }
            
            const quizContainer = document.getElementById('quiz-container');
            
            quizContainer.innerHTML = `
                <div class="h-full flex flex-col">
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm font-medium text-stone-600">Streak: ${correctStreak}/${questionsNeededForSuccess}</span>
                            <span class="text-sm font-medium text-violet-600">Tentativas: ${totalAttempts + 1}</span>
                        </div>
                        <div class="w-full bg-stone-200 rounded-full h-3">
                            <div class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full transition-all duration-500" style="width: ${(correctStreak / questionsNeededForSuccess) * 100}%"></div>
                        </div>
                        <p class="text-xs text-center mt-1 text-stone-500">
                            ${correctStreak === 0 ? 'Comece seu streak!' : `${questionsNeededForSuccess - correctStreak} restantes para completar!`}
                        </p>
                    </div>
                    
                    <div class="flex-grow flex flex-col justify-center">
                        <h3 class="text-lg font-semibold mb-6">${question.q}</h3>
                        <div id="quiz-options" class="space-y-2">
                            ${question.o.map((option, index) => `
                                <button class="pedagogical-quiz-option" onclick="window.selectAnswer(${index})">
                                    ${option}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div id="explanation" class="hidden mt-4 p-4 rounded-lg">
                        <p class="text-sm"></p>
                    </div>
                    
                    <div class="mt-6 flex justify-center">
                        <button id="next-btn" onclick="window.nextQuestion()" class="primary-btn w-auto hidden">Próxima Pergunta</button>
                    </div>
                </div>
            `;
        }

        window.selectAnswer = function(selectedIndex) {
            const question = quizQuestions[currentQuestionIndex];
            if (!question) {
                console.error('Question not found at index:', currentQuestionIndex);
                return;
            }
            
            const options = document.querySelectorAll('.pedagogical-quiz-option');
            const explanation = document.getElementById('explanation');
            const nextBtn = document.getElementById('next-btn');
            
            // Disable all options
            options.forEach(option => option.disabled = true);
            
            const isCorrect = selectedIndex === question.a;
            
            // Show correct/incorrect
            options.forEach((option, index) => {
                if (index === question.a) {
                    option.classList.add('correct');
                } else if (index === selectedIndex && !isCorrect) {
                    option.classList.add('incorrect');
                }
            });
            
            // Update streak logic
            if (isCorrect) {
                correctStreak++;
                explanation.className = 'mt-4 p-4 bg-green-50 border border-green-200 rounded-lg';
                explanation.querySelector('p').className = 'text-sm text-green-800';
                explanation.querySelector('p').innerHTML = `<strong>✅ Correto!</strong> ${question.e}`;
                
                // Check if challenge is completed
                if (correctStreak >= questionsNeededForSuccess) {
                    setTimeout(() => {
                        showSuccessResult();
                    }, 2000);
                    explanation.classList.remove('hidden');
                    return;
                }
            } else {
                // Reset streak on wrong answer
                correctStreak = 0;
                totalAttempts++;
                explanation.className = 'mt-4 p-4 bg-red-50 border border-red-200 rounded-lg';
                explanation.querySelector('p').className = 'text-sm text-red-800';
                explanation.querySelector('p').innerHTML = `<strong>❌ Incorreto!</strong> Seu streak reiniciou. ${question.e}`;
                
                // Show restart message
                setTimeout(() => {
                    showRestartMessage();
                }, 3000);
                explanation.classList.remove('hidden');
                return;
            }
            
            // Show explanation and next button
            explanation.classList.remove('hidden');
            nextBtn.classList.remove('hidden');
            
            // Track answer
            quizQuestions[currentQuestionIndex].userAnswer = selectedIndex;
        }

        window.nextQuestion = function() {
            currentQuestionIndex++;
            showQuestion();
        }

        function showRestartMessage() {
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.innerHTML = `
                <div class="text-center h-full flex flex-col justify-center">
                    <div class="mb-6">
                        <svg class="w-20 h-20 mx-auto mb-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.314 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                        </svg>
                        <h2 class="text-2xl font-bold mb-2 text-red-600">Streak Reiniciado!</h2>
                        <p class="text-stone-600 mb-4">Você errou uma pergunta. O desafio vai recomeçar do zero.</p>
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6 max-w-md mx-auto">
                            <p class="text-sm text-stone-700">
                                <strong>Tentativas:</strong> ${totalAttempts}<br>
                                <strong>Streak anterior:</strong> Foi resetado para 0<br>
                                <strong>Meta:</strong> 20 perguntas consecutivas corretas
                            </p>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <button onclick="window.startQuiz()" class="primary-btn w-auto mx-auto">🔄 Tentar Novamente</button>
                        <button onclick="showQuizWelcome()" class="secondary-btn w-auto mx-auto">📚 Voltar ao Início</button>
                    </div>
                </div>
            `;
        }

        function showSuccessResult() {
            const quizContainer = document.getElementById('quiz-container');
            quizContainer.innerHTML = `
                <div class="text-center h-full flex flex-col justify-center">
                    <div class="mb-6">
                        <svg class="w-24 h-24 mx-auto mb-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <h2 class="text-3xl font-bold mb-2 text-green-600">🎉 Parabéns, ${teacherName}!</h2>
                        <p class="text-stone-600 mb-4">Você completou o Desafio Pedagógico com sucesso!</p>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-6 max-w-md mx-auto">
                            <h3 class="text-lg font-semibold text-green-800 mb-3">🏆 Resultado Final</h3>
                            <div class="text-sm text-green-700 space-y-1">
                                <p><strong>✅ Streak Final:</strong> ${correctStreak}/${questionsNeededForSuccess}</p>
                                <p><strong>🎯 Tentativas Total:</strong> ${totalAttempts + 1}</p>
                                <p><strong>📊 Status:</strong> <span class="text-green-600 font-bold">APROVADO</span></p>
                            </div>
                        </div>
                        <p class="text-green-600 font-medium mb-6">
                            Você demonstrou excelente conhecimento sobre Dogme ELT e Lexical Approach!
                        </p>
                    </div>
                    
                    <div class="space-y-2">
                        <button onclick="showQuizWelcome()" class="primary-btn w-auto mx-auto">🏠 Voltar ao Início</button>
                        <button onclick="window.startQuiz()" class="secondary-btn w-auto mx-auto">🔄 Fazer Novamente</button>
                    </div>
                </div>
            `;
        }



        // --- Guidelines Functions ---
        function renderDiretrizesSection() {
            document.getElementById('main-title').textContent = 'Diretrizes SLAP';
            const contentArea = document.getElementById('content-area');
            
            contentArea.innerHTML = `
                <div class="max-w-6xl mx-auto">
                    <div class="mb-6 flex justify-between items-center">
                        <input type="text" id="guidelines-search" class="guidelines-search" 
                               placeholder="Buscar diretrizes..." 
                               oninput="filterGuidelines(this.value)">
                        ${currentUserRole === 'admin' ? `
                        <button class="primary-btn w-auto ml-4" data-action="add-guideline">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            Adicionar Diretriz
                        </button>
                        ` : ''}
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <h2 class="text-xl font-bold text-green-600 mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Boas Práticas
                            </h2>
                            <div id="good-practices-container">
                                <!-- Good practices will be rendered here -->
                            </div>
                            <div id="good-practices-pagination" class="pagination-controls mt-4">
                                <!-- Pagination controls will be rendered here -->
                            </div>
                        </div>
                        
                        <div>
                            <h2 class="text-xl font-bold text-red-600 mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                                Itens Proibidos
                            </h2>
                            <div id="prohibited-items-container">
                                <!-- Prohibited items will be rendered here -->
                            </div>
                            <div id="prohibited-items-pagination" class="pagination-controls mt-4">
                                <!-- Pagination controls will be rendered here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Guideline Modal -->
                    <div id="guideline-modal" class="modal-overlay">
                        <div class="modal-content max-w-md">
                            <div class="modal-header">
                                <h4 id="guideline-modal-title">Nova Diretriz</h4>
                                <button data-action="close-guideline-modal" class="modal-close-btn">&times;</button>
                            </div>
                            <form id="guideline-form">
                                <div class="space-y-4">
                                    <div>
                                        <label class="font-medium text-sm">Tipo</label>
                                        <select id="guideline-type" class="form-input" required>
                                            <option value="good-practice">Boa Prática</option>
                                            <option value="prohibited">Item Proibido</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="font-medium text-sm">Título</label>
                                        <input type="text" id="guideline-title" class="form-input" required>
                                    </div>
                                    <div>
                                        <label class="font-medium text-sm">Descrição</label>
                                        <textarea id="guideline-description" rows="4" class="form-input" required></textarea>
                                    </div>
                                    <div class="flex justify-end gap-2">
                                        <button type="button" data-action="close-guideline-modal" class="secondary-btn">Cancelar</button>
                                        <button type="submit" class="primary-btn w-auto">Salvar</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                

            `;
            
            loadGuidelines();
        }

        let guidelines = {
            goodPractices: [],
            prohibitedItems: []
        };

        // Pagination variables for guidelines
        let guidelinesPagination = {
            goodPractices: { currentPage: 1, itemsPerPage: 6 },
            prohibitedItems: { currentPage: 1, itemsPerPage: 6 }
        };

        async function loadGuidelines() {
            if (window.isDevelopmentMode) {
                // Development mode - use localStorage
                const savedGuidelines = localStorage.getItem('slap-guidelines');
                if (savedGuidelines) {
                    guidelines = JSON.parse(savedGuidelines);
                } else {
                    guidelines = {
                        goodPractices: [
                            { id: '1', title: 'Pontualidade nas Aulas', description: 'Sempre chegue às aulas com pelo menos 5 minutos de antecedência para preparar o ambiente e receber os alunos adequadamente.' },
                            { id: '2', title: 'Feedback Construtivo', description: 'Ofereça feedback específico e encorajador aos alunos, focando em aspectos que podem ser melhorados.' },
                            { id: '3', title: 'Material Organizado', description: 'Mantenha todos os materiais didáticos organizados e facilmente acessíveis durante as aulas.' },
                            { id: '4', title: 'Comunicação Clara', description: 'Use linguagem simples e clara, adaptando a complexidade ao nível dos alunos.' }
                        ],
                        prohibitedItems: [
                            { id: '1', title: 'Uso de Celular Durante Aulas', description: 'É proibido o uso de dispositivos móveis para fins pessoais durante o período de aula.' },
                            { id: '2', title: 'Linguagem Inadequada', description: 'Evite o uso de gírias excessivas ou linguagem informal que possa prejudicar o aprendizado.' },
                            { id: '3', title: 'Atraso Frequente', description: 'Atrasos constantes são inaceitáveis e prejudicam o andamento das atividades pedagógicas.' },
                            { id: '4', title: 'Material Não Aprovado', description: 'Não utilize materiais didáticos que não tenham sido aprovado pela coordenação pedagógica.' }
                        ]
                    };
                    saveGuidelines();
                }
                renderGuidelines();
            } else if (db) {
                // Production mode - use Firebase
                try {
                    const guidelinesDoc = await getDoc(doc(db, `artifacts/${appId}/public/settings/guidelines`));
                    if (guidelinesDoc.exists()) {
                        guidelines = guidelinesDoc.data();
                    } else {
                        guidelines = { goodPractices: [], prohibitedItems: [] };
                    }
                } catch (error) {
                    console.error('Error loading guidelines:', error);
                    // Fallback to localStorage
                    const savedGuidelines = localStorage.getItem('slap-guidelines');
                    if (savedGuidelines) {
                        guidelines = JSON.parse(savedGuidelines);
                    } else {
                        guidelines = { goodPractices: [], prohibitedItems: [] };
                    }
                }
                renderGuidelines();
            }
        }

        function renderGuidelines(filter = '') {
            const goodPracticesContainer = document.getElementById('good-practices-container');
            const prohibitedItemsContainer = document.getElementById('prohibited-items-container');
            
            const filteredGoodPractices = guidelines.goodPractices.filter(item => 
                item.title.toLowerCase().includes(filter.toLowerCase()) || 
                item.description.toLowerCase().includes(filter.toLowerCase())
            );
            
            const filteredProhibitedItems = guidelines.prohibitedItems.filter(item => 
                item.title.toLowerCase().includes(filter.toLowerCase()) || 
                item.description.toLowerCase().includes(filter.toLowerCase())
            );
            
            // When filtering, reset pagination to page 1
            if (filter) {
                guidelinesPagination.goodPractices.currentPage = 1;
                guidelinesPagination.prohibitedItems.currentPage = 1;
            }
            
            // Render Good Practices with pagination
            renderGuidelineSection(
                'goodPractices', 
                filteredGoodPractices, 
                goodPracticesContainer, 
                document.getElementById('good-practices-pagination'),
                'good-practice',
                'text-green-600'
            );
            
            // Render Prohibited Items with pagination
            renderGuidelineSection(
                'prohibitedItems', 
                filteredProhibitedItems, 
                prohibitedItemsContainer, 
                document.getElementById('prohibited-items-pagination'),
                'prohibited',
                'text-red-600'
            );
            
            // Show/hide sections based on search results
            const goodPracticesSection = document.querySelector('.grid > div:first-child');
            const prohibitedSection = document.querySelector('.grid > div:last-child');
            
            if (filter && filteredGoodPractices.length === 0) {
                goodPracticesSection.style.display = 'none';
            } else {
                goodPracticesSection.style.display = 'block';
            }
            
            if (filter && filteredProhibitedItems.length === 0) {
                prohibitedSection.style.display = 'none';
            } else {
                prohibitedSection.style.display = 'block';
            }
        }

        function renderGuidelineSection(type, items, container, paginationContainer, cardClass, iconColorClass) {
            const pagination = guidelinesPagination[type];
            const startIndex = (pagination.currentPage - 1) * pagination.itemsPerPage;
            const endIndex = startIndex + pagination.itemsPerPage;
            const itemsToShow = items.slice(startIndex, endIndex);
            const totalPages = Math.ceil(items.length / pagination.itemsPerPage);
            
            // Render items
            container.innerHTML = itemsToShow.map((item, index) => {
                const realIndex = startIndex + index;
                const iconPath = type === 'goodPractices' ? 'M5 13l4 4L19 7' : 'M6 18L18 6M6 6l12 12';
                
                return `
                    <div class="guideline-card ${cardClass}">
                        <div class="guideline-header">
                            <svg class="guideline-icon w-6 h-6 ${iconColorClass}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"></path>
                            </svg>
                            <div class="flex-1">
                                <h3 class="guideline-title">${item.title}</h3>
                            </div>
                            ${currentUserRole === 'admin' ? `
                            <button class="danger-btn !text-xs !py-1 !px-2 ml-2" onclick="deleteGuidelineItem('${type}', ${realIndex})">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                            ` : ''}
                        </div>
                        <p class="guideline-description">${item.description}</p>
                    </div>
                `;
            }).join('');
            
            // Render pagination controls
            if (totalPages > 1) {
                paginationContainer.innerHTML = `
                    <div class="flex justify-center items-center gap-2">
                        <button 
                            class="pagination-btn ${pagination.currentPage === 1 ? 'disabled' : ''}" 
                            onclick="changeGuidelinePage('${type}', ${pagination.currentPage - 1})"
                            ${pagination.currentPage === 1 ? 'disabled' : ''}>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>
                        
                        <div class="flex gap-1">
                            ${Array.from({length: totalPages}, (_, i) => i + 1).map(page => `
                                <button 
                                    class="pagination-number ${page === pagination.currentPage ? 'active' : ''}"
                                    onclick="changeGuidelinePage('${type}', ${page})">
                                    ${page}
                                </button>
                            `).join('')}
                        </div>
                        
                        <button 
                            class="pagination-btn ${pagination.currentPage === totalPages ? 'disabled' : ''}" 
                            onclick="changeGuidelinePage('${type}', ${pagination.currentPage + 1})"
                            ${pagination.currentPage === totalPages ? 'disabled' : ''}>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="text-center text-sm text-stone-500 mt-2">
                        Mostrando ${Math.min(startIndex + 1, items.length)}-${Math.min(endIndex, items.length)} de ${items.length} itens
                    </div>
                `;
            } else {
                paginationContainer.innerHTML = '';
            }
        }

        function changeGuidelinePage(type, newPage) {
            const pagination = guidelinesPagination[type];
            const filteredItems = type === 'goodPractices' ? 
                guidelines.goodPractices.filter(item => 
                    item.title.toLowerCase().includes(document.getElementById('guidelines-search').value.toLowerCase()) || 
                    item.description.toLowerCase().includes(document.getElementById('guidelines-search').value.toLowerCase())
                ) :
                guidelines.prohibitedItems.filter(item => 
                    item.title.toLowerCase().includes(document.getElementById('guidelines-search').value.toLowerCase()) || 
                    item.description.toLowerCase().includes(document.getElementById('guidelines-search').value.toLowerCase())
                );
            
            const totalPages = Math.ceil(filteredItems.length / pagination.itemsPerPage);
            
            if (newPage >= 1 && newPage <= totalPages) {
                pagination.currentPage = newPage;
                renderGuidelines(document.getElementById('guidelines-search').value);
            }
        }

        function deleteGuidelineItem(type, realIndex) {
            const itemTitle = guidelines[type][realIndex].title;
            
            if (confirm(`Tem certeza que deseja excluir "${itemTitle}"?`)) {
                guidelines[type].splice(realIndex, 1);
                saveGuidelines();
                
                // Adjust current page if necessary
                const pagination = guidelinesPagination[type];
                const totalPages = Math.ceil(guidelines[type].length / pagination.itemsPerPage);
                if (pagination.currentPage > totalPages && totalPages > 0) {
                    pagination.currentPage = totalPages;
                }
                
                renderGuidelines(document.getElementById('guidelines-search').value);
            }
        }

        function filterGuidelines(searchTerm) {
            renderGuidelines(searchTerm);
        }
        
        function openGuidelineForm() {
            const modal = document.getElementById('guideline-modal');
            const form = document.getElementById('guideline-form');
            
            // Add submit event listener
            form.onsubmit = (e) => {
                e.preventDefault();
                saveGuideline(e);
            };
            
            modal.classList.add('visible');
        }

        // Legacy function kept for compatibility - redirects to new function
        function deleteGuideline(type, index) {
            deleteGuidelineItem(type, index);
        }





        // --- BRAINFLIP GAME SECTION ---
        const flashcardsData = [
            { front: "Teacher Talking Time (TTT)", back: "O tempo que o professor fala durante a aula. O ideal é minimizá-lo para maximizar o STT." },
            { front: "Student Talking Time (STT)", back: "O tempo que os alunos falam durante a aula. Um indicador chave de engajamento e prática." },
            { front: "Lexical Approach", back: "Metodologia que foca no ensino de 'chunks' de linguagem (collocations, fixed expressions) em vez de palavras isoladas." },
            { front: "Comprehensible Input", back: "Linguagem que os alunos conseguem entender, mesmo que contenha estruturas novas (i + 1, segundo Krashen)." },
            { front: "Teoria de Krashen", back: "Cinco hipóteses sobre a aquisição de segunda língua: Aquisição-Aprendizagem, Monitor, Ordem Natural, Input e Filtro Afetivo." },
            { front: "Scaffolding", back: "Suporte temporário dado pelo professor para ajudar o aluno a realizar uma tarefa que ele não faria sozinho, removido gradualmente." },
            { front: "Error Correction", back: "Estratégias para corrigir erros dos alunos, que podem ser diretas, indiretas, recasts, elicitation, etc., dependendo do estágio do erro." },
            { front: "CEFR (Common European Framework of Reference)", back: "Padrão internacional para descrever habilidades linguísticas, com níveis de A1 a C2 (Básico, Independente, Proficiente)." },
            { front: "PPP vs. TBL", back: "PPP é uma abordagem linear (apresenta, pratica, produz). TBL é mais comunicativa, focando em tarefas com um objetivo real." },
            { front: "Task-Based Learning (TBL)", back: "Abordagem onde a aprendizagem ocorre através da realização de tarefas significativas que envolvem a comunicação real da língua." },
            { front: "Dogme", back: "Abordagem de ensino 'unplugged', que minimiza materiais pré-fabricados e foca na linguagem emergente dos alunos." },
            { front: "Formative Assessment", back: "Avaliação contínua realizada durante o processo de aprendizagem para monitorar o progresso e fornecer feedback." },
            { front: "Andragogia", back: "Princípios da educação de adultos, que se diferenciam da pedagogia (educação de crianças) pela autonomia e experiência do aprendiz." },
            { front: "Metodologia ativa", back: "Abordagens de ensino que colocam o aluno no centro do processo, tornando-o protagonista da sua aprendizagem (ex: Aprendizagem Baseada em Projetos)." },
            { front: "Ensino híbrido (Blended Learning)", back: "Combinação de ensino presencial e online, utilizando diferentes modalidades para otimizar a aprendizagem." },
            { front: "CLIL (Content and Language Integrated Learning)", back: "Ensino de uma disciplina (ex: história, ciências) através de uma língua estrangeira, desenvolvendo conteúdo e habilidades linguísticas simultaneamente." },
            { front: "Warm-ups", back: "Atividades curtas no início da aula para engajar os alunos, ativar conhecimentos prévios e prepará-los para o tema." },
            { front: "Cool downs", back: "Atividades no final da aula para revisar o conteúdo, consolidar a aprendizagem ou relaxar e refletir." },
            { front: "ICQs / CCQs", back: "Perguntas curtas para verificar se os alunos entenderam as instruções (ICQs) ou o conceito (CCQs) apresentado." },
            { front: "Autonomy in Learning", back: "Capacidade do aluno de tomar controle de sua própria aprendizagem, definindo metas e escolhendo métodos." }
        ];

        let currentCardIndex = 0;
        let isFlipped = false;

        function renderBrainFlipSection() {
            document.getElementById('main-title').textContent = 'BrainFlip';
            document.getElementById('main-description').textContent = 'Flashcards pedagógicos para professores de inglês. Clique nas cartas para virar e aprender!';

            contentArea.innerHTML = `
                <section class="bg-white p-6 rounded-xl shadow-sm border border-stone-200 flex flex-col items-center justify-center min-h-[70vh]">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-blue-700 mb-8 mt-4 text-center">BrainFlip</h1>
                    <p class="text-lg text-stone-700 mb-8 text-center max-w-2xl">
                        Um jogo interativo de flashcards pedagógicos para professores de inglês. Clique nas cartas para virar e aprender!
                    </p>

                    <div class="flashcard-container mb-8">
                        <div id="flashcard" class="flashcard cursor-pointer" onclick="flipCard()">
                            <div id="flashcard-front" class="flashcard-face flashcard-front"></div>
                            <div id="flashcard-back" class="flashcard-face flashcard-back"></div>
                        </div>
                    </div>

                    <div class="flex items-center justify-center space-x-4 mb-8">
                        <button id="prev-btn" class="navigation-button-game" onclick="previousCard()">
                            Anterior
                        </button>
                        <span id="card-counter" class="text-xl font-semibold text-stone-800">1 / ${flashcardsData.length}</span>
                        <button id="next-btn" class="navigation-button-game" onclick="nextCard()">
                            Próximo
                        </button>
                    </div>
                </section>
            `;

            loadCard(0);
        }

        function loadCard(index) {
            currentCardIndex = index;
            isFlipped = false;
            
            const flashcard = document.getElementById('flashcard');
            const front = document.getElementById('flashcard-front');
            const back = document.getElementById('flashcard-back');
            const counter = document.getElementById('card-counter');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            // Reset flip state
            flashcard.classList.remove('flipped');
            
            // Load content
            front.textContent = flashcardsData[index].front;
            back.textContent = flashcardsData[index].back;
            
            // Update counter
            counter.textContent = `${index + 1} / ${flashcardsData.length}`;
            
            // Update button states
            prevBtn.disabled = index === 0;
            nextBtn.disabled = index === flashcardsData.length - 1;
        }

        function flipCard() {
            const flashcard = document.getElementById('flashcard');
            flashcard.classList.toggle('flipped');
            isFlipped = !isFlipped;
        }

        function nextCard() {
            if (currentCardIndex < flashcardsData.length - 1) {
                loadCard(currentCardIndex + 1);
            }
        }

        function previousCard() {
            if (currentCardIndex > 0) {
                loadCard(currentCardIndex - 1);
            }
        }
        
        function saveGuideline(event) {
            event.preventDefault();
            
            const type = document.getElementById('guideline-type').value;
            const title = document.getElementById('guideline-title').value;
            const description = document.getElementById('guideline-description').value;
            
            const newGuideline = {
                id: Date.now().toString(),
                title: title,
                description: description
            };
            
            if (type === 'good-practice') {
                guidelines.goodPractices.push(newGuideline);
            } else {
                guidelines.prohibitedItems.push(newGuideline);
            }
            
            saveGuidelines();
            renderGuidelines();
            
            // Close modal and reset form
            document.getElementById('guideline-modal').classList.remove('visible');
            document.getElementById('guideline-form').reset();
        }

        function exportAlunosDoc() {
            let studentsList = '';
            const activeStudents = students.filter(s => s.status === 'Ativo');
            studentsList = activeStudents.map(s => `
                <tr>
                    <td>${s.name}</td>
                    <td>${s.status}</td>
                    <td>R$ ${parseFloat(s.amountPaid || 0).toFixed(2)}</td>
                    <td>${s.responsibleName || 'N/A'}</td>
                    <td>${s.responsibleEmail || 'N/A'}</td>
                    <td>${s.responsiblePhone || 'N/A'}</td>
                    <td>${s.emergencyContact || 'N/A'}</td>
                    <td>${s.emergencyPhone || 'N/A'}</td>
                    <td>${s.level || 'N/A'}</td>
                    <td>${s.birthDate || 'N/A'}</td>
                    <td>${s.address || 'N/A'}</td>
                    <td>${s.observations || 'N/A'}</td>
                </tr>
            `).join('');
            
            if (!studentsList) { studentsList = '<tr><td colspan="12">Nenhum aluno ativo encontrado.</td></tr>'; }
            
            const docHtml = `
                <!DOCTYPE html>
                <html lang="pt-br">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Lista Completa de Alunos - SLAP</title>
                    <style>
                        body { font-family: 'Arial', sans-serif; margin: 20px; }
                        h1 { color: #333; text-align: center; margin-bottom: 30px; }
                        .header-info { text-align: center; margin-bottom: 20px; color: #666; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
                        th, td { border: 1px solid #ccc; padding: 6px; text-align: left; vertical-align: top; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .student-name { font-weight: bold; }
                        @media print {
                            body { margin: 10px; }
                            table { font-size: 10px; }
                            th, td { padding: 4px; }
                        }
                    </style>
                </head>
                <body>
                    <h1>Lista Completa de Alunos Ativos - SLAP</h1>
                    <div class="header-info">
                        <p>Data de Exportação: ${new Date().toLocaleDateString('pt-BR')}</p>
                        <p>Total de Alunos Ativos: ${activeStudents.length}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Nome do Aluno</th>
                                <th>Status</th>
                                <th>Valor Pago</th>
                                <th>Responsável</th>
                                <th>Email Responsável</th>
                                <th>Telefone Responsável</th>
                                <th>Contato Emergência</th>
                                <th>Tel. Emergência</th>
                                <th>Nível</th>
                                <th>Data Nascimento</th>
                                <th>Endereço</th>
                                <th>Observações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${studentsList}
                        </tbody>
                    </table>
                    <div style="margin-top: 30px; text-align: center; color: #666; font-size: 12px;">
                        <p>Documento gerado pelo Hub SLAP - Speaking Like a Pro</p>
                    </div>
                </body>
                </html>
            `;
            
            openHtmlInNewWindow("Lista Completa de Alunos", docHtml);
        }

        // Make functions globally accessible
        window.filterGuidelines = filterGuidelines;
        window.changeMonth = changeMonth;
        window.viewCalendarEvent = viewCalendarEvent;
        window.openCalendarEventForm = openCalendarEventForm;
        window.openGuidelineForm = openGuidelineForm;
        window.saveGuideline = saveGuideline;
        window.deleteGuideline = deleteGuideline;
        window.deleteGuidelineItem = deleteGuidelineItem;
        window.changeGuidelinePage = changeGuidelinePage;
        window.exportAlunosDoc = exportAlunosDoc;
        window.selectAnswer = selectAnswer;
        window.nextQuestion = nextQuestion;
        window.startQuiz = startQuiz;
        window.checkTimeConflict = checkTimeConflict;
        window.showSection = function(sectionName) {
            const navItem = document.querySelector(`[data-target="${sectionName}"]`);
            if (navItem) navItem.click();
        };

        async function saveGuidelines() {
            if (window.isDevelopmentMode) {
                // Development mode - save to localStorage
                localStorage.setItem('slap-guidelines', JSON.stringify(guidelines));
            } else if (db) {
                // Production mode - save to Firebase
                try {
                    await setDoc(doc(db, `artifacts/${appId}/public/settings/guidelines`), guidelines);
                    console.log('Guidelines saved to Firebase');
                } catch (error) {
                    console.error('Error saving guidelines to Firebase:', error);
                    // Fallback to localStorage
                    localStorage.setItem('slap-guidelines', JSON.stringify(guidelines));
                    showErrorMessage('Aviso', 'Diretrizes salvas localmente. Sincronização com servidor falhou.');
                }
            }
        }

        // --- Monthly Highlight Functions ---
        let monthlyHighlight = null;

        function renderMonthlyHighlight() {
            const container = document.getElementById('monthly-highlight-content');
            
            if (monthlyHighlight && monthlyHighlight.name) {
                container.innerHTML = `
                    <div class="highlight-card">
                        <img src="${monthlyHighlight.photoUrl}" alt="${monthlyHighlight.name}" class="highlight-photo" onerror="this.src='https://via.placeholder.com/80x80/F1D24B/44403c?text=${monthlyHighlight.name.charAt(0)}'">
                        <div class="highlight-info">
                            <h5>${monthlyHighlight.name}</h5>
                            <p>${monthlyHighlight.description}</p>
                            ${monthlyHighlight.award ? `<div class="highlight-award"><strong>Premiação:</strong> ${monthlyHighlight.award}</div>` : ''}
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="highlight-empty">
                        <svg class="w-12 h-12 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                        </svg>
                        <p>Nenhum funcionário em destaque este mês</p>
                        ${currentUserRole === 'admin' ? '<p class="text-xs mt-1">Clique em "Editar" para adicionar</p>' : ''}
                    </div>
                `;
            }
        }

        // Load monthly highlight from Firebase or localStorage
        async function loadMonthlyHighlight() {
            if (window.isDevelopmentMode) {
                // Development mode - use localStorage
                const savedHighlight = localStorage.getItem('slap-monthly-highlight');
                if (savedHighlight) {
                    monthlyHighlight = JSON.parse(savedHighlight);
                }
                renderMonthlyHighlight();
            } else if (db) {
                // Production mode - use Firebase
                try {
                    const highlightDoc = await getDoc(doc(db, `artifacts/${appId}/public/settings/monthly-highlight`));
                    if (highlightDoc.exists()) {
                        monthlyHighlight = highlightDoc.data();
                    } else {
                        monthlyHighlight = null;
                    }
                } catch (error) {
                    console.error('Error loading monthly highlight:', error);
                    // Fallback to localStorage
                    const savedHighlight = localStorage.getItem('slap-monthly-highlight');
                    if (savedHighlight) {
                        monthlyHighlight = JSON.parse(savedHighlight);
                    }
                }
                renderMonthlyHighlight();
            }
        }

        // Setup monthly highlight listener for real-time updates
        function setupMonthlyHighlightListener() {
            if (!window.isDevelopmentMode && db) {
                const highlightDocRef = doc(db, `artifacts/${appId}/public/settings/monthly-highlight`);
                const unsubscribe = onSnapshot(highlightDocRef, (doc) => {
                    if (doc.exists()) {
                        monthlyHighlight = doc.data();
                    } else {
                        monthlyHighlight = null;
                    }
                    
                    // Only re-render if we're on the home page
                    const activePageId = contentArea.firstElementChild?.id;
                    if (activePageId === 'inicio-section') {
                        renderMonthlyHighlight();
                    }
                }, (error) => {
                    console.error('Error listening to monthly highlight:', error);
                });
                
                allUnsubscribers.push(unsubscribe);
            }
        }

        // Setup guidelines listener for real-time updates
        function setupGuidelinesListener() {
            if (!window.isDevelopmentMode && db) {
                const guidelinesDocRef = doc(db, `artifacts/${appId}/public/settings/guidelines`);
                const unsubscribe = onSnapshot(guidelinesDocRef, (doc) => {
                    if (doc.exists()) {
                        guidelines = doc.data();
                    } else {
                        guidelines = { goodPractices: [], prohibitedItems: [] };
                    }
                    
                    // Only re-render if we're on the guidelines page
                    const activePageId = contentArea.firstElementChild?.id;
                    if (activePageId === 'diretrizes-section') {
                        renderGuidelines();
                    }
                }, (error) => {
                    console.error('Error listening to guidelines:', error);
                });
                
                allUnsubscribers.push(unsubscribe);
            }
        }

        function openMonthlyHighlightForm() {
            const modal = document.getElementById('monthly-highlight-modal');
            const form = document.getElementById('monthly-highlight-form');
            
            if (!modal) {
                console.error('Modal monthly-highlight-modal not found');
                return;
            }
            
            // Pre-fill form if there's existing data
            if (monthlyHighlight) {
                const nameField = document.getElementById('highlight-name');
                const photoField = document.getElementById('highlight-photo-url');
                const descField = document.getElementById('highlight-description');
                const awardField = document.getElementById('highlight-award');
                
                if (nameField) nameField.value = monthlyHighlight.name || '';
                if (photoField) photoField.value = monthlyHighlight.photoUrl || '';
                if (descField) descField.value = monthlyHighlight.description || '';
                if (awardField) awardField.value = monthlyHighlight.award || '';
            } else if (form) {
                form.reset();
            }
            
            modal.classList.add('visible');
            
            if (form) {
                form.onsubmit = (e) => {
                    e.preventDefault();
                    saveMonthlyHighlight();
                    modal.classList.remove('visible');
                };
            }
        }

        async function saveMonthlyHighlight() {
            const name = document.getElementById('highlight-name').value;
            const photoUrl = document.getElementById('highlight-photo-url').value;
            const description = document.getElementById('highlight-description').value;
            const award = document.getElementById('highlight-award').value;
            
            monthlyHighlight = {
                name: name,
                photoUrl: photoUrl,
                description: description,
                award: award,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUserName || 'Admin'
            };
            
            if (window.isDevelopmentMode) {
                // Development mode - save to localStorage
                localStorage.setItem('slap-monthly-highlight', JSON.stringify(monthlyHighlight));
                renderMonthlyHighlight();
            } else if (db) {
                // Production mode - save to Firebase
                try {
                    await setDoc(doc(db, `artifacts/${appId}/public/settings/monthly-highlight`), monthlyHighlight);
                    console.log('Monthly highlight saved to Firebase');
                } catch (error) {
                    console.error('Error saving monthly highlight to Firebase:', error);
                    // Fallback to localStorage
                    localStorage.setItem('slap-monthly-highlight', JSON.stringify(monthlyHighlight));
                    renderMonthlyHighlight();
                    showErrorMessage('Aviso', 'Dados salvos localmente. Sincronização com servidor falhhou.');
                }
            }
            
            // Reset form safely
            const form = document.getElementById('monthly-highlight-form');
            if (form) {
                form.reset();
            }
        }

        // --- Welcome Message Functions ---
        function extractNameFromEmail(email) {
            if (!email) return 'Usuário';
            const name = email.split('@')[0];
            return name.split('.').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join(' ');
        }

        function updateWelcomeMessages(name) {
            // Wait for DOM to be fully ready
            function tryUpdate() {
                const firstName = (name || '').split(' ')[0];
                const welcomeMsg = document.getElementById('welcome-message');
                if (welcomeMsg) {
                    welcomeMsg.textContent = `Bem-vindo(a), ${firstName}`;
                }
                const headerWelcome = document.getElementById('header-welcome-message');
                if (headerWelcome) {
                    headerWelcome.innerHTML = `
                        <div class="text-sm font-medium">Bem-vindo(a),</div>
                        <div class="text-lg font-bold">${firstName}</div>
                    `;
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', tryUpdate);
            } else {
                tryUpdate();
            }
        }

        // --- Calendar Event Functions ---
        function openCalendarEventForm(eventId = null) {
            // Check if user has permission to create/edit events
            if (currentUserRole === 'teacher') {
                showErrorMessage("Acesso Negado", "Usuários com role 'teacher' não podem criar ou editar eventos.");
                return;
            }
            
            const modal = document.getElementById('calendar-event-modal');
            const form = document.getElementById('calendar-event-form');
            const title = document.getElementById('event-modal-title');
            
            title.textContent = eventId ? 'Editar Evento' : 'Novo Evento';
            
            if (eventId) {
                const event = calendarEvents.find(e => e.id === eventId);
                if (event) {
                    document.getElementById('event-title').value = event.title;
                    document.getElementById('event-date').value = event.date;
                    document.getElementById('event-time').value = event.time || '';
                    document.getElementById('event-type').value = event.type;
                    document.getElementById('event-description').value = event.description || '';
                }
            } else {
                form.reset();
            }
            
            modal.classList.add('visible');
            
            form.onsubmit = (e) => {
                e.preventDefault();
                saveCalendarEvent(eventId);
                modal.classList.remove('visible');
            };
        }

        function saveCalendarEvent(eventId = null) {
            const title = document.getElementById('event-title').value;
            const date = document.getElementById('event-date').value;
            const time = document.getElementById('event-time').value;
            const type = document.getElementById('event-type').value;
            const description = document.getElementById('event-description').value;
            
            if (eventId) {
                const eventIndex = calendarEvents.findIndex(e => e.id === eventId);
                if (eventIndex !== -1) {
                    calendarEvents[eventIndex] = { id: eventId, title, date, time, type, description };
                }
            } else {
                const newEvent = {
                    id: Date.now().toString(),
                    title,
                    date,
                    time,
                    type,
                    description
                };
                calendarEvents.push(newEvent);
            }
            
            saveCalendarEvents();
            renderCalendar();
        }

        function viewCalendarEvent(eventId) {
            // First check calendarEvents, then check events array
            let event = calendarEvents.find(e => e.id === eventId);
            if (!event) {
                event = events.find(e => e.id === eventId);
            }
            
            if (event) {
                // Use openEventModal to show view with delete option
                openEventModal(eventId);
            }
        }

        function renderMenu() {
            const mainNav = document.getElementById('main-navigation');
            const menuItems = [
                { key: 'inicio', label: 'Início', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>', roles: null },
                { key: 'dojo', label: 'Dojo', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>', roles: null },
                { key: 'alunos', label: 'Alunos', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>', roles: ['admin', 'pedagogico', 'financeiro', 'ap'] },
                { key: 'turmas', label: 'Turmas', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>', roles: ['admin', 'pedagogico', 'teacher', 'ap'] },
                { key: 'vips', label: 'VIPs', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>', roles: ['admin', 'pedagogico', 'teacher', 'ap'] },
                { key: 'grade', label: 'Grade', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg>', roles: ['admin', 'ap', 'pedagogico', 'financeiro', 'teacher'] },
                { key: 'calendario', label: 'Calendário', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>', roles: ['admin', 'ap', 'pedagogico', 'financeiro', 'teacher', 'am'] },
                { key: 'desafio-pedagogico', label: 'Desafio Pedagógico', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>', roles: ['admin', 'pedagogico', 'teacher', 'ap'] },
                { key: 'diretrizes', label: 'Diretrizes', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14,2 14,8 20,8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10,9 9,9 8,9"></polyline></svg>', roles: ['admin', 'teacher'] },
                { key: 'tarefas', label: 'Tarefas', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>', roles: ['admin', 'am', 'ap', 'pedagogico', 'financeiro', 'teacher'] },
                { key: 'cps', label: 'CPs', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>', roles: ['admin', 'pedagogico', 'ap'] },
                { key: 'eventos', label: 'Eventos', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3z"/><path d="M12.44 8.917a4 4 0 0 0-4.88 0C4.965 10.685 3 13.982 3 17.5V22h18v-4.5c0-3.518-1.965-6.815-4.56-8.583z"/></svg>', roles: ['admin', 'am', 'ap', 'pedagogico'] },
                { key: 'orcamentos', label: 'Orçamentos', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>', roles: ['admin', 'am', 'financeiro'] },
                { key: 'banco-de-fotos', label: 'Banco de Fotos', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>', roles: ['admin', 'am'] },
                { key: 'colaboradores', label: 'Colaboradores', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>', roles: ['admin', 'pedagogico', 'financeiro'] },
                { key: 'cancelamentos', label: 'Cancelamentos', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="23" y1="18" x2="17" y2="12"/><line x1="17" y1="18" x2="23" y2="12"/></svg>', roles: ['admin', 'pedagogico', 'financeiro'] },
                { key: 'folha-pagamento', label: 'Folha de Pag.', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>', roles: ['admin', 'financeiro'] }
            ];

            const menuItemsHTML = menuItems
                .filter(item => !item.roles || item.roles.includes(currentUserRole))
                .map(item => `<button data-target="${item.key}" class="nav-item w-full text-left px-4 py-2.5 rounded-lg flex items-center font-semibold">${item.icon}${item.label}</button>`)
                .join('');
            
            mainNav.innerHTML = menuItemsHTML;
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded event fired - starting initialization');
            const pageRenderers = { 
                'inicio': renderInicioSection, 
                'alunos': renderAlunosSection, 
                'turmas': renderTurmasSection, 
                'vips': renderVipsSection, 
                'eventos': renderEventosSection, 
                'orcamentos': renderOrcamentosSection, 
                'tarefas': renderTarefasSection, 
                'grade': renderGradeSection, 
                'folha-pagamento': renderFolhaPagamentoSection, 
                'cancelamentos': renderCancelamentosSection, 
                'colaboradores': renderColaboradoresSection, 
                'cps': renderCPsSection, 
                'dojo': renderDojoSection, 
                'calendario': renderCalendarioSection, 
                'desafio-pedagogico': renderDesafioPedagogicoSection, 
                'diretrizes': renderDiretrizesSection 
            };
            
            document.body.addEventListener('click', (event) => {
                // Close modals when clicking overlay or close button
                if (event.target.matches('.modal-overlay') || event.target.matches('[data-action="close-calendar-modal"]')) {
                    document.getElementById('calendar-event-modal').classList.remove('visible');
                }
                if (event.target.matches('.modal-overlay') || event.target.matches('[data-action="close-guideline-modal"]')) {
                    document.getElementById('guideline-modal').classList.remove('visible');
                }
                if (event.target.matches('.modal-overlay') || event.target.matches('[data-action="close-highlight-modal"]')) {
                    document.getElementById('monthly-highlight-modal').classList.remove('visible');
                }
                if (event.target.matches('.modal-overlay') || event.target.matches('[data-action="close-challenge-modal"]')) {
                    document.getElementById('challenge-edit-modal').classList.remove('visible');
                }
                
                const navTarget = event.target.closest('.nav-item');
                if (navTarget && !navTarget.disabled) {
                    const pageKey = navTarget.dataset.target;
                    if (pageKey && pageRenderers[pageKey]) {
                        resetPagination();
                        pageRenderers[pageKey]();
                        setActiveNavItem(navTarget);
                    }
                }
                
                const actionTarget = event.target.closest('[data-action]');
                if (actionTarget) {
                    if(actionTarget.closest('.modal-content') && !['close-modal', 'export-vip-pef', 'export-turma-pef'].includes(actionTarget.dataset.action)) event.stopPropagation();
                    
                    const { action, id, collection, folderName, nivelId, aulaIndex, direction, unitId, lessonNumber, status } = actionTarget.dataset;
                    const actionHandlers = {
                        'open-signup': openSignUpModal,
                        'add-aluno': () => openAlunoForm(),
                        'view-aluno': () => openAlunoModal(id),
                        'edit-aluno': () => openAlunoForm(id),
                        'add-turma': () => openTurmaForm(),
                        'open-turma-pef': () => openTurmaPefModal(id),
                        'edit-turma': () => openTurmaForm(id),
                        'add-vip': () => openVipForm(),
                        'edit-vip': () => openVipForm(id),
                        'open-vip-pef': () => openVipPefModal(id),
                        'mark-attendance': () => {
                            const button = actionTarget;
                            const group = button.closest('.pef-status-btn-group');
                            if (!group) return;

                            if (button.classList.contains('active')) {
                                button.classList.remove('active', 'P', 'F', 'PP');
                            } else {
                                group.querySelectorAll('button').forEach(btn => btn.classList.remove('active', 'P', 'F', 'PP'));
                                button.classList.add('active', status);
                            }
                        },
                        'save-pef-lesson': () => savePefLesson(unitId, lessonNumber),
                        'add-event': openEventForm,
                        'view-event': () => openEventModal(id),
                        'edit-event': () => openEventForm(id),
                        'add-budget': openBudgetForm,
                        'view-budget': () => openBudgetModal(id),
                        'edit-budget': () => openBudgetForm(id),
                        'add-task': openTaskForm,
                        'add-collaborator': () => openCollaboratorForm(),
                        'edit-collaborator': () => openCollaboratorForm(id),
                        'add-schedule': openScheduleForm,
                        'add-break': openBreakForm,
                        'view-schedule': () => openScheduleForm(id),
                        'add-expense': openExpenseForm,
                        'view-expense': () => openExpenseForm(id),
                        'add-cancelamento': openCancelamentoForm,
                        'view-cancelamento': () => openCancelamentoModal(id),
                        'edit-cancelamento': () => openCancelamentoForm(id),
                        'delete-item': () => deleteItem(collection, id),
                        'close-modal': closeFormModal,

                        'toggle-cp-level': () => { const card = document.getElementById(`nivel-${id}`); if(card) { card.classList.toggle('open'); const icon = card.querySelector('svg'); icon.style.transform = card.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)'; } },
                        'add-nivel': () => openNivelForm(),
                        'edit-nivel': () => openNivelForm(id),
                        'reorder-cp': () => reorderCPLevel(id, direction),
                        'add-aula': () => openAulaForm(nivelId),
                        'edit-aula': () => openAulaForm(nivelId, aulaIndex),
                        'delete-aula': () => deleteAula(nivelId, aulaIndex),
                        'add-dojo-competitor': () => openDojoCompetitorForm(),
                        'edit-dojo-points': () => openDojoPointsForm(id),
                        'add-dojo-mission': openDojoMissionForm,
                        'export-alunos-doc': exportAlunosDoc,
                        'export-vip-pef': () => exportVipPef(id),
                        'export-turma-pef': () => exportTurmaPef(id),
                        'export-cps-doc': exportCPsDoc,
                        'add-calendar-event': openCalendarEventForm,
                        'view-calendar-event': () => viewCalendarEvent(id),
                        'edit-calendar-event': () => {
                            if (currentUserRole === 'teacher') {
                                showErrorMessage("Acesso Negado", "Usuários com role 'teacher' não podem editar eventos.");
                                return;
                            }
                            openCalendarEventForm(id);
                        },
                        'add-guideline': openGuidelineForm,
                        'edit-monthly-highlight': openMonthlyHighlightForm,
                        'edit-challenge-content': openChallengeContentForm,
                        'delete-calendar-event': () => {
                            if (id) {
                                deleteCalendarEvent(id);
                            } else {
                                console.error('Event ID not found for deletion');
                                showErrorMessage("Erro", "ID do evento não encontrado.");
                            }
                        },

                        'debug-sync-status': debugSyncStatus,
                    };
                    if (actionHandlers[action]) {
                        actionHandlers[action]();
                    }
                }

                if(event.target.matches('input[type="checkbox"][data-action="toggle-task"]')) {
                    const taskId = event.target.dataset.id;
                    const isCompleted = event.target.checked;
                    toggleTaskCompletion(taskId, isCompleted);
                }
                 if(event.target.matches('input[type="checkbox"][data-action="toggle-expense"]')) {
                    const expenseId = event.target.dataset.id;
                    const isPaid = event.target.checked;
                    toggleExpensePaid(expenseId, isPaid);
                }
            });

            document.getElementById('logout-button').addEventListener('click', handleLogout);
            document.getElementById('pending-logout').addEventListener('click', handleLogout);
            console.log('About to initialize Firebase');
            initializeFirebase();
        });
    </script>
</body>
</html>
