<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hub Gestão | SLAP</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749543469/SLAP_FAVICON_AMARELO_coilvj.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Palette: SLAP Brand Colors: #F1D24B (Yellow), #FF5C3D (Orange), #84C7DF (Blue), #8671D1 (Purple) -->
    <style>
        body {
            font-family: 'DM Sans', sans-serif;
            line-height: 1.25;
        }
        .nav-item.active {
            background-color: #FFFBEB; /* yellow-50 */
            color: #F1D24B;
            font-weight: 600;
        }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e7e5e4; padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-header h4 { font-size: 1.25rem; font-weight: 700; color: #44403c; }
        .modal-close-btn { background: none; border: none; cursor: pointer; color: #a8a29e; }
        
        .base-card { background-color: #ffffff; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e7e5e4; transition: all 0.2s; }
        .base-card:hover { border-color: #F1D24B; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        .status-tag { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-aprovado, .status-presencial, .status-ativo { background-color: #D1FAE5; color: #065F46; }
        .status-online, .status-em-andamento, .status-inativo { background-color: #DBEAFE; color: #1E40AF; }
        .status-concluída { background-color: #F3F4F6; color: #4B5563; }
        .status-pendente, .status-em-espera { background-color: #FEF3C7; color: #92400E; }
        .status-rejeitado, .status-cancelado { background-color: #FEE2E2; color: #991B1B; }

        .status-financeiro { background-color: #D1FAE5; color: #065F46; }
        .status-pedagógico { background-color: #DBEAFE; color: #1E40AF; }
        .status-comercial { background-color: #FEF3C7; color: #92400E; }
        .status-marketing { background-color: #FEE2E2; color: #991B1B; }
        
        .sector-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            margin: 0.25rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1.5px solid #F1D24B;
            color: #44403c;
            background-color: transparent;
        }

        .task-card { background-color: #ffffff; border-radius: 0.75rem; padding: 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e7e5e4; transition: all 0.2s ease; }
        .task-card.completed { background-color: #f9fafb; border-color: #e5e7eb; }
        .task-card.completed p { text-decoration: line-through; color: #9ca3af; }
        .task-card:hover { border-color: #F1D24B; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .user-tag { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .tag-admin { background-color: #E5E7EB; color: #374151; }
        .deadline-text { font-weight: 600; color: #57534e; }
        .deadline-overdue { color: #b91c1c; }
        .task-delete-btn { background: none; border: none; cursor: pointer; color: #9ca3af; transition: color 0.2s; }
        .task-delete-btn:hover { color: #ef4444; }

        .grade-select-container { margin-bottom: 1.5rem; max-width: 400px; }
        .grade-select { width: 100%; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #d6d3d1; background-color: #ffffff; font-weight: 600; color: #44403c; -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; cursor: pointer; }
        .schedule-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
        .day-column { background-color: #f9fafb; border-radius: 0.75rem; padding: 1rem; border: 1px solid #f3f4f6; }
        .day-column-header { font-weight: 700; color: #44403c; font-size: 1.25rem; padding-bottom: 0.75rem; margin-bottom: 0.75rem; border-bottom: 2px solid #F1D24B; }
        .class-entry { background-color: #ffffff; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .class-entry:hover { transform: translateY(-2px); box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
        .class-tag { font-size: 0.625rem; font-weight: 700; padding: 2px 8px; border-radius: 9999px; color: white; margin-bottom: 4px; display: inline-block; text-transform: uppercase; }
        .tag-turma { background-color: #FF5C3D; }
        .tag-vip { background-color: #8671D1; }
        
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .data-table th { font-weight: 600; font-size: 0.875rem; color: #6b7280; }
        .data-table tbody tr.paid { background-color: #f9fafb; color: #9ca3af; }
        .data-table tbody tr.paid .font-medium { text-decoration: line-through; }
        .data-table tbody tr:not(.paid):hover { background-color: #f9fafb; cursor: pointer; }
        .data-total { margin-top: 1.5rem; text-align: right; }
        .data-total p { font-size: 1.25rem; font-weight: 700; color: #1f2937; }

        .form-input { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; }
        .primary-btn { background-color: #F1D24B; color: #44403c; padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.2s; width: 100%; border: none; cursor: pointer; }
        .primary-btn:hover { background-color: #eab308; }
        .secondary-btn { background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s; }
        .secondary-btn:hover { background-color: #e5e7eb; }
        .secondary-btn.active { background-color: #F1D24B; color: #44403c; border-color: #F1D24B;}
        .danger-btn { background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.2s; border: none; cursor: pointer; }
        .danger-btn:hover { background-color: #dc2626; }

        /* --- CPs Styles --- */
        .cp-level-card { background-color: #fff; border-radius: 0.75rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e7e5e4; }
        .cp-level-header { padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .cp-level-content { padding: 0 1.5rem; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding-bottom 0.3s ease-out; }
        .cp-level-card.open .cp-level-content { max-height: 1000px; padding-bottom: 1.5rem; }
        .cp-lesson-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: 0.5rem; }
        .cp-lesson-item:nth-child(odd) { background-color: #f9fafb; }

        /* --- Sala de Reunião Styles --- */
        .reuniao-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; }
        .reuniao-card { background-color: #fff; border-radius: 0.75rem; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s; border: 1px solid #e7e5e4; }
        .reuniao-card:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-color: #F1D24B; }
        .reuniao-card img { width: 80px; height: 80px; border-radius: 9999px; object-fit: cover; margin: 0 auto 1rem; border: 3px solid #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
        .profile-modal-item { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; }
        .profile-modal-item svg { color: #F1D24B; }

        /* --- Banco de Fotos Styles --- */
        .folder-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 1.5rem; }
        .folder-card { background-color: #fff; border-radius: 0.75rem; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s; border: 1px solid #e7e5e4; position: relative; }
        .folder-card:hover { transform: translateY(-4px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-color: #F1D24B; }
        .folder-delete-btn { position: absolute; top: 0.5rem; right: 0.5rem; background: none; border: none; cursor: pointer; color: #d1d5db; padding: 0.25rem; border-radius: 9999px; }
        .folder-card:hover .folder-delete-btn { color: #9ca3af; }
        .folder-delete-btn:hover { color: #ef4444; background-color: #fef2f2; }
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
        .photo-card { background-color: #fff; border-radius: 0.75rem; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e7e5e4; }
        .photo-card img { width: 100%; height: 200px; object-fit: cover; }
        .photo-card-info { padding: 1rem; }

        /* --- PEF Styles --- */
        .pef-grid { display: grid; grid-template-columns: 150px repeat(31, 1fr); gap: 0.5rem; }
        .pef-header { font-weight: 600; text-align: center; padding: 0.5rem; background-color: #f9fafb; border-radius: 0.25rem; }
        .pef-student-name { font-weight: 600; padding: 0.5rem; text-align: left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .pef-day-cell { display: flex; justify-content: center; align-items: center; }
        .pef-status-btn { width: 2rem; height: 2rem; border-radius: 9999px; border: 1px solid #d1d5db; font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .pef-status-btn.P { background-color: #D1FAE5; color: #065F46; border-color: #6EE7B7; }
        .pef-status-btn.F { background-color: #FEE2E2; color: #991B1B; border-color: #FCA5A5; }
        .pef-status-btn.PP { background-color: #FEF3C7; color: #92400E; border-color: #FCD34D; }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">

    <!-- Login, Pending, and Hub Views -->
    <div id="login-view" class="flex items-center justify-center min-h-screen">
        <!-- O conteúdo do login será gerado pelo JS -->
    </div>

    <div id="pending-view" class="hidden items-center justify-center min-h-screen">
        <div class="text-center p-8 bg-white rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-yellow-500">Aguardando Aprovação</h2>
            <p class="text-stone-600 mt-2">A sua conta foi criada e está a aguardar aprovação de um administrador.</p>
            <button id="pending-logout" class="mt-6 secondary-btn w-auto">Sair</button>
        </div>
    </div>

    <div id="hub-view" class="hidden">
        <div id="app-container" class="min-h-screen md:flex bg-stone-50">
            <aside class="md:w-64 bg-white md:border-r border-b border-stone-200 p-4 md:p-6 flex flex-col">
                <div class="mb-4 text-center relative">
                    <label for="profile-picture-upload" class="cursor-pointer group">
                        <img id="profile-picture" src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg" alt="Foto de Perfil" class="w-24 h-24 mx-auto rounded-full object-cover border-4 border-transparent group-hover:border-yellow-200 transition-all">
                        <div id="profile-picture-loader" class="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center rounded-full hidden">
                            <svg class="animate-spin h-8 w-8 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        </div>
                    </label>
                    <input type="file" id="profile-picture-upload" class="hidden" accept="image/*">
                </div>
                <h1 class="text-xl font-bold text-stone-800 text-center">Hub Gestão</h1>
                <p id="welcome-message" class="text-center text-sm text-stone-600 mb-6"></p>
                <nav id="main-navigation" class="space-y-1 flex-1">
                    <!-- Menu items are dynamically generated here -->
                </nav>
                <div class="mt-auto pt-4">
                    <button id="logout-button" class="nav-item w-full text-left px-4 py-2.5 rounded-lg text-stone-700 hover:bg-red-50 hover:text-red-600 transition-colors flex items-center font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        Sair
                    </button>
                </div>
            </aside>
        
            <main class="flex-1 p-4 sm:p-6 md:p-8">
                <div class="flex justify-between items-start mb-8">
                    <header id="main-header">
                        <h2 id="main-title" class="text-3xl font-bold text-[#F1D24B]"></h2>
                        <p id="main-description" class="mt-2 text-stone-600"></p>
                    </header>
                    <div class="relative ml-auto">
                        <button id="notification-button" class="relative p-2 text-stone-500 hover:text-stone-700 focus:outline-none">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6 6 0 10-12 0v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                            <span id="notification-badge" class="absolute top-1 right-1 block h-2 w-2 rounded-full bg-red-500 ring-2 ring-white hidden"></span>
                        </button>
                        <div id="notification-panel" class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl overflow-hidden z-20 hidden">
                            <div class="py-2 px-4 text-sm font-semibold text-stone-700 border-b">Notificações</div>
                            <div id="notification-list" class="divide-y max-h-96 overflow-y-auto">
                                <!-- Notifications will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div id="content-area"></div>
            </main>
        </div>
    </div>

    <!-- Modal -->
    <div id="form-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="form-modal-title"></h4>
                <button class="modal-close-btn" data-action="close-modal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="form-modal-content-area"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, serverTimestamp, query, setDoc, getDoc, updateDoc, orderBy, limit, where, arrayUnion, arrayRemove, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";

        // --- GLOBAL VARIABLES ---
        const contentArea = document.getElementById('content-area');
        const mainHeader = document.getElementById('main-header');
        const loginView = document.getElementById('login-view');
        const hubView = document.getElementById('hub-view');
        const pendingView = document.getElementById('pending-view');
        
        let db, auth, storage, userId, currentUserName, currentUserRole;
        let usersData = [], students = [], turmas = [], attendance = [], tasks = [], events = [], budgets = [], collaborators = [], schedules = [], expenses = [], cancellations = [], notifications = [], photos = [], photoFolders = [], cps = [], dojoRanking = [];
        let allUnsubscribers = [];
        const appId = 'hub-gestao-slap';

        const courseLevels = [
            "Beginner 1 (Basic 1)", "Beginner 2 (Basic 2)", 
            "Freshman 1 (Pre-inter 1)", "Freshman 2 (Pre-inter 2)",
            "Sophomore 1 (Inter 1)", "Sophomore 2 (Inter 2)",
            "Junior 1 (Pre-advanced 1)", "Junior 2 (Pre-advanced 2)",
            "Senior 1 (Advanced 1)", "Senior 2 (Advanced 2)"
        ];

        // --- FIREBASE INITIALIZATION ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config)
                    ? JSON.parse(__firebase_config)
                    : (typeof window.firebaseConfig !== 'undefined' ? window.firebaseConfig : {});

                if (!firebaseConfig.apiKey) {
                    console.error("Configuração do Firebase não encontrada. A aplicação não pode iniciar.");
                    document.body.innerHTML = `<div class="min-h-screen flex items-center justify-center bg-stone-100"><div class="text-center p-8 bg-white rounded-xl shadow-lg"><h2 class="text-2xl font-bold text-red-600">Erro de Configuração</h2><p class="text-stone-600 mt-2">A aplicação não pode ser carregada. Por favor, contacte o suporte.</p></div></div>`;
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user && !user.isAnonymous) {
                        await initializeAppWithUser(user);
                    } else {
                        showLoginView();
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }

        async function initializeAppWithUser(user) {
            userId = user.uid;
            const userDocRef = doc(db, "users", userId);
            const userDoc = await getDoc(userDocRef);
            
            if (userDoc.exists()) {
                const userData = userDoc.data();
                currentUserName = userData.name || user.displayName;
                currentUserRole = userData.role;
                document.getElementById('profile-picture').src = userData.photoURL || 'https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg';
                
                if (['admin', 'am', 'ap', 'pedagogico', 'financeiro', 'teacher'].includes(currentUserRole)) {
                    setupFirestoreListeners();
                    showHubView();
                } else {
                    showPendingView();
                }
            } else {
                showPendingView();
            }
        }
        
        // --- FIRESTORE LISTENERS ---
        function setupFirestoreListeners() {
            if (!db || !userId) return;
            allUnsubscribers.forEach(unsub => unsub && unsub());
            allUnsubscribers = [];

            const getCollectionListener = (collectionName, targetArray, renderFunc, q) => {
                const collRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
                const finalQuery = q ? q(collRef) : query(collRef);
                const unsubscribe = onSnapshot(finalQuery, (snapshot) => {
                    targetArray.length = 0;
                    snapshot.docs.forEach(doc => targetArray.push({ id: doc.id, ...doc.data() }));
                    
                    if (collectionName === 'notifications') {
                        updateNotificationBadge();
                        return;
                    }

                    const activePageId = contentArea.firstElementChild?.id;
                    if (renderFunc && activePageId) {
                        const pageBaseName = activePageId.replace('-section', '');
                         if (pageBaseName.startsWith(collectionName.slice(0, -1).replace('_', '-').toLowerCase()) || pageBaseName === 'inicio' || (collectionName === 'users' && pageBaseName === 'sala-de-reuniao')) {
                            renderFunc();
                        }
                    }
                }, (error) => console.error(`Error on ${collectionName} listener:`, error));
                allUnsubscribers.push(unsubscribe);
            };
            
            getCollectionListener('users', usersData, null);
            getCollectionListener('students', students, () => {
                if (contentArea.firstElementChild?.id === 'alunos-section') renderAlunosSection();
                if (contentArea.firstElementChild?.id === 'turmas-section') renderTurmasSection();
            });
            getCollectionListener('turmas', turmas, renderTurmasSection);
            getCollectionListener('attendance', attendance, () => {
                if (contentArea.firstElementChild?.id === 'pef-section') {
                    const pefSection = document.getElementById('pef-section');
                    if(pefSection) renderPEFGrid(pefSection.dataset.teacher, pefSection.dataset.month, pefSection.dataset.year);
                }
            });
            getCollectionListener('tasks', tasks, renderTarefasSection);
            getCollectionListener('budgets', budgets, renderOrcamentosSection);
            getCollectionListener('collaborators', collaborators, () => {
                const activePageId = contentArea.firstElementChild?.id;
                if (activePageId === 'grade-section') renderGradeSection();
                if (activePageId === 'tasks-section') renderTarefasSection();
                if (activePageId === 'colaboradores-section') renderColaboradoresSection();
                if (activePageId === 'banco-de-fotos-section') renderBancoDeFotosSection();
                if (activePageId === 'inicio-section') renderInicioSection();
                if (activePageId === 'pef-section') renderPEFSection();
            });
            getCollectionListener('events', events, renderEventosSection);
            getCollectionListener('schedules', schedules, () => {
                 if (contentArea.firstElementChild?.id === 'grade-section') renderGradeSection();
                 if (contentArea.firstElementChild?.id === 'pef-section') renderPEFSection();
            });
            getCollectionListener('expenses', expenses, renderFolhaPagamentoSection);
            getCollectionListener('cancellations', cancellations, renderCancelamentosSection);
            getCollectionListener('photo_bank', photos, () => renderBancoDeFotosSection(document.getElementById('banco-de-fotos-section')?.dataset.currentFolder));
            getCollectionListener('photo_folders', photoFolders, () => renderBancoDeFotosSection());
            getCollectionListener('cps', cps, renderCPsSection);
            getCollectionListener('dojo_ranking', dojoRanking, renderDojoSection);
            getCollectionListener('notifications', notifications, null, (ref) => query(ref, orderBy('createdAt', 'desc'), limit(30)));
        }

        // --- AUTH, VIEW, and MENU FUNCTIONS ---
        function showLoginView() {
            hubView.classList.add('hidden');
            pendingView.classList.add('hidden');
            pendingView.classList.remove('flex');
            loginView.classList.remove('hidden');
            loginView.classList.add('flex');
            loginView.innerHTML = `
                <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-xl shadow-lg">
                    <div class="text-center">
                        <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg" alt="Logo SLAP" class="w-24 h-auto mx-auto rounded-lg mb-4">
                        <h2 class="text-2xl font-bold text-stone-900">Aceda à sua conta</h2>
                        <p class="mt-2 text-sm text-stone-600">Bem-vindo de volta!</p>
                    </div>
                    <form id="login-form" class="mt-8 space-y-6">
                        <div>
                            <label for="login-email" class="sr-only">Email</label>
                            <input id="login-email" name="email" type="email" autocomplete="email" required class="form-input" placeholder="Endereço de email">
                        </div>
                        <div>
                            <label for="login-password" class="sr-only">Palavra-passe</label>
                            <input id="login-password" name="password" type="password" autocomplete="current-password" required class="form-input" placeholder="Palavra-passe">
                        </div>
                        <p id="login-error" class="text-sm text-red-600 text-center"></p>
                        <div>
                            <button type="submit" class="primary-btn">Entrar</button>
                        </div>
                    </form>
                    <p class="text-sm text-center text-stone-600">
                        Não tem uma conta?
                        <button data-action="open-signup" class="font-medium text-yellow-600 hover:text-yellow-500">Registe-se</button>
                    </p>
                </div>
            `;
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        }

        function showHubView() { 
            loginView.classList.add('hidden');
            loginView.classList.remove('flex');
            pendingView.classList.add('hidden');
            pendingView.classList.remove('flex');
            hubView.classList.remove('hidden'); 
            const firstName = (currentUserName || '').split(' ')[0];
            document.getElementById('welcome-message').textContent = `Bem-vindo, ${firstName}`;
            renderMenu(); 
            renderInicioSection(); 
            setActiveNavItem(document.querySelector('[data-target="inicio"]')); 
        }
        function showPendingView() { 
            hubView.classList.add('hidden'); 
            loginView.classList.add('hidden');
            loginView.classList.remove('flex');
            pendingView.classList.remove('hidden'); 
            pendingView.classList.add('flex');
        }
        function setActiveNavItem(element) { document.querySelectorAll('#main-navigation .nav-item').forEach(item => item.classList.remove('active')); if (element) element.classList.add('active'); }
        async function handleLogin(event) {
            event.preventDefault();
            const email = event.target.email.value;
            const password = event.target.password.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                const errorElement = document.getElementById('login-error');
                if(errorElement) errorElement.textContent = "Email ou palavra-passe inválidos.";
            }
        }
        async function handleSignUp(event) { event.preventDefault(); const name = event.target.name.value; const email = event.target.email.value; const password = event.target.password.value; try { const cred = await createUserWithEmailAndPassword(auth, email, password); await updateProfile(cred.user, { displayName: name }); await setDoc(doc(db, "users", cred.user.uid), { name, email, role: "pending", createdAt: serverTimestamp() }); await signOut(auth); showSuccessMessage("Registo Concluído!", "A sua conta foi criada. Aguarde aprovação de um administrador para aceder."); } catch (error) { showErrorMessage("Erro", "Erro ao criar conta. Verifique o email e a palavra-passe."); } }
        async function handleLogout() { 
            await signOut(auth);
        }
        
        // --- PROFILE PICTURE UPLOAD ---
        async function handleProfilePictureUpload(event) {
            const file = event.target.files[0];
            if (!file || !userId) return;
            
            const loader = document.getElementById('profile-picture-loader');
            loader.classList.remove('hidden');

            const storageRef = ref(storage, `profile-pictures/${userId}/${file.name}`);
            try {
                await uploadBytes(storageRef, file);
                const photoURL = await getDownloadURL(storageRef);
                
                const userDocRef = doc(db, "users", userId);
                await updateDoc(userDocRef, { photoURL: photoURL });

                document.getElementById('profile-picture').src = photoURL;
                showSuccessMessage("Sucesso!", "A sua foto de perfil foi atualizada.");
            } catch (error) {
                console.error("Error uploading profile picture: ", error);
                showErrorMessage("Erro", "Falha ao carregar a imagem. Verifique as permissões do Firebase Storage.");
            } finally {
                loader.classList.add('hidden');
            }
        }

        // --- CONTENT RENDERING ---
        function renderInicioSection() {
            document.getElementById('main-title').textContent = 'Dashboard';
            document.getElementById('main-description').textContent = 'Visão geral das suas atividades e da equipa.';
            contentArea.innerHTML = `<div id="inicio-section" class="bg-white p-8 rounded-lg shadow-sm text-center">
                <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg" alt="Logo SLAP" class="w-32 h-auto mx-auto rounded-lg mb-6">
                <h3 class="text-2xl font-bold text-stone-800">Bem-vindo ao Hub de Gestão</h3>
                <p class="mt-2 text-stone-600 max-w-2xl mx-auto">Selecione uma opção no menu à esquerda para começar a gerir as suas operações.</p>
            </div>`;
        }

        function renderAlunosSection() {
            document.getElementById('main-title').textContent = 'Gestão de Alunos';
            document.getElementById('main-description').textContent = 'Cadastre e gerencie todos os alunos da escola.';

            contentArea.innerHTML = `
                <section id="alunos-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                        <div class="flex gap-2" id="alunos-filter-buttons">
                            <button class="secondary-btn filter-btn active" data-filter="todos">Todos</button>
                            <button class="secondary-btn filter-btn" data-filter="ativo">Ativos</button>
                            <button class="secondary-btn filter-btn" data-filter="cancelado">Cancelados</button>
                        </div>
                        <button class="primary-btn w-auto" data-action="add-aluno">+ Adicionar Aluno</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nome do Aluno</th>
                                    <th>Status</th>
                                    <th>Curso/Nível</th>
                                    <th>Responsável</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="alunos-list">
                                <!-- Student rows will be rendered here by JS -->
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
            updateAlunosList('todos');
        }

        function updateAlunosList(filter) {
            const listBody = document.getElementById('alunos-list');
            if (!listBody) return;

            let filteredStudents = students;
            if (filter !== 'todos') {
                filteredStudents = students.filter(s => s.status && s.status.toLowerCase() === filter);
            }

            if (filteredStudents.length === 0) {
                listBody.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-stone-500">Nenhum aluno encontrado.</td></tr>';
                return;
            }

            listBody.innerHTML = filteredStudents.map(student => `
                <tr data-action="view-aluno" data-id="${student.id}" class="cursor-pointer">
                    <td class="font-medium">${student.name}</td>
                    <td><span class="status-tag status-${(student.status || 'pendente').toLowerCase()}">${student.status || 'Pendente'}</span></td>
                    <td>${student.course || 'N/A'}</td>
                    <td>${student.responsibleName || 'N/A'}</td>
                    <td class="text-center">
                         <button class="secondary-btn" data-action="edit-aluno" data-id="${student.id}" onclick="event.stopPropagation()">Editar</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderTurmasSection() {
            document.getElementById('main-title').textContent = 'Gestão de Turmas';
            document.getElementById('main-description').textContent = 'Crie turmas e adicione alunos.';
            contentArea.innerHTML = `
                <div id="turmas-section">
                    <div class="text-right mb-6">
                        <button class="primary-btn w-auto" data-action="add-turma">+ Adicionar Turma</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${turmas.map(t => `
                        <div class="base-card cursor-pointer" data-action="view-turma" data-id="${t.id}">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-bold text-stone-800">${t.name}</h3>
                                <span class="text-sm font-semibold text-stone-600">${(t.studentIds || []).length} aluno(s)</span>
                            </div>
                            <p class="text-sm text-stone-500 mb-4">Professor: ${t.teacherName}</p>
                            <p class="text-sm text-stone-600"><strong>Nível:</strong> ${t.level}</p>
                        </div>`).join('') || '<p class="col-span-full text-center py-10 text-stone-500">Nenhuma turma encontrada.</p>'}
                    </div>
                </div>`;
        }

        function renderPEFSection() {
            document.getElementById('main-title').textContent = 'Presença e Faltas (PEF)';
            document.getElementById('main-description').textContent = 'Registe a frequência dos alunos nas aulas.';
            
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            let teacherFilterHtml = '';
            let teacherToDisplay = userId;

            if (['admin', 'ap', 'pedagogico'].includes(currentUserRole)) {
                 const teacherOptions = collaborators.filter(c => c.sectors && c.sectors.includes('professor')).map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                 teacherFilterHtml = `
                    <div class="grade-select-container">
                         <label for="pef-teacher-filter" class="block text-sm font-medium text-stone-700 mb-1">Ver presenças de:</label>
                         <select id="pef-teacher-filter" class="grade-select">
                            <option value="">Selecione um professor</option>
                            ${teacherOptions}
                        </select>
                    </div>
                 `;
                 teacherToDisplay = ''; // Don't show anything until a teacher is selected
            }
            
            contentArea.innerHTML = `
                <section id="pef-section" data-teacher="${teacherToDisplay}" data-month="${currentMonth}" data-year="${currentYear}">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4 bg-white p-4 rounded-xl shadow-sm">
                        ${teacherFilterHtml}
                        <div class="flex items-center gap-2 ml-auto">
                            <button id="pef-prev-month" class="secondary-btn">‹</button>
                            <span id="pef-month-year" class="font-bold text-lg w-48 text-center">${new Date(currentYear, currentMonth).toLocaleString('pt-BR', { month: 'long', year: 'numeric' })}</span>
                            <button id="pef-next-month" class="secondary-btn">›</button>
                        </div>
                    </div>
                    <div id="pef-grid-container" class="overflow-x-auto"></div>
                </section>
            `;

            if (teacherToDisplay) {
                renderPEFGrid(teacherToDisplay, currentMonth, currentYear);
            }

            document.getElementById('pef-prev-month').addEventListener('click', navigatePEFMonth);
            document.getElementById('pef-next-month').addEventListener('click', navigatePEFMonth);
            if(document.getElementById('pef-teacher-filter')) {
                document.getElementById('pef-teacher-filter').addEventListener('change', (e) => {
                    const section = document.getElementById('pef-section');
                    section.dataset.teacher = e.target.value;
                    renderPEFGrid(e.target.value, section.dataset.month, section.dataset.year);
                });
            }
        }

        function navigatePEFMonth(event) {
            const section = document.getElementById('pef-section');
            let month = parseInt(section.dataset.month);
            let year = parseInt(section.dataset.year);

            if (event.target.id === 'pef-prev-month') {
                month--;
                if (month < 0) {
                    month = 11;
                    year--;
                }
            } else {
                month++;
                if (month > 11) {
                    month = 0;
                    year++;
                }
            }
            
            section.dataset.month = month;
            section.dataset.year = year;
            document.getElementById('pef-month-year').textContent = new Date(year, month).toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
            renderPEFGrid(section.dataset.teacher, month, year);
        }

        async function renderPEFGrid(teacherId, month, year) {
            const container = document.getElementById('pef-grid-container');
            if (!container) return;
            if (!teacherId) {
                container.innerHTML = `<div class="text-center p-8 bg-white rounded-lg"><p class="text-stone-500">Selecione um professor para ver os registos de presença.</p></div>`;
                return;
            }

            const teacher = collaborators.find(c => c.id === teacherId);
            if (!teacher) {
                container.innerHTML = `<div class="text-center p-8 bg-white rounded-lg"><p class="text-stone-500">Professor não encontrado.</p></div>`;
                return;
            }

            // Get all classes and VIPs for this teacher from the schedule
            const teacherSchedules = schedules.filter(s => s.teacher === teacher.name);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Fetch attendance data for this month
            const attendanceRecords = {}; // Process the flat array into a usable map

            let gridHtml = `<div class="pef-grid">`;
            // Header
            gridHtml += `<div class="pef-header">Aluno/Turma</div>`;
            for (let day = 1; day <= daysInMonth; day++) {
                gridHtml += `<div class="pef-header">${day}</div>`;
            }

            // Rows for each class/student
            teacherSchedules.forEach(schedule => {
                gridHtml += `<div class="pef-student-name">${schedule.student}</div>`;
                for (let day = 1; day <= daysInMonth; day++) {
                    // This logic is simplified. A real implementation would check if the day is a class day.
                    gridHtml += `<div class="pef-day-cell">
                        <button class="pef-status-btn" data-status="P">P</button>
                        <button class="pef-status-btn" data-status="F">F</button>
                        <button class="pef-status-btn" data-status="PP">PP</button>
                    </div>`;
                }
            });
            
            gridHtml += `</div>`;
            container.innerHTML = gridHtml;
        }

        function renderEventosSection() {
            document.getElementById('main-title').textContent = 'Gestor de Eventos';
            document.getElementById('main-description').textContent = 'Planeje e gerencie todos os eventos da marca.';
            contentArea.innerHTML = `
                <div id="events-section">
                    <div class="text-right mb-6">
                        <button class="primary-btn w-auto" data-action="add-event">+ Adicionar Evento</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${events.map(e => `
                        <div class="base-card cursor-pointer" data-action="view-event" data-id="${e.id}">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-xl font-bold text-stone-800">${e.nome}</h3>
                                ${e.setor ? `<span class="status-tag status-${e.setor.toLowerCase()}">${e.setor}</span>` : ''}
                            </div>
                            <p class="text-sm text-stone-500 mb-4">Data: ${new Date(e.data + 'T00:00:00').toLocaleDateString('pt-BR')} ${e.time ? `às ${e.time}`: ''}</p>
                            <p class="text-sm text-stone-600 truncate"><strong>Local:</strong> ${e.local}</p>
                        </div>`).join('') || '<p class="col-span-full text-center py-10 text-stone-500">Nenhum evento encontrado.</p>'}
                    </div>
                </div>`;
        }

        function renderOrcamentosSection() { document.getElementById('main-title').textContent = 'Gestor de Orçamentos'; document.getElementById('main-description').textContent = 'Registre e acompanhe todas as propostas e orçamentos.'; contentArea.innerHTML = `<div id="budgets-section"><div class="text-right mb-6"><button class="primary-btn w-auto" data-action="add-budget">+ Adicionar Orçamento</button></div><div class="space-y-4">${budgets.map(b => `<div class="base-card flex flex-wrap justify-between items-center gap-4 cursor-pointer" data-action="view-budget" data-id="${b.id}"><div class="flex-1"><h3 class="text-lg font-bold text-stone-800">${b.titulo}</h3><p class="text-sm text-stone-500">Feito por: ${b.criadoPor || 'N/A'} em ${b.dataCriacao ? new Date(b.dataCriacao).toLocaleDateString('pt-BR') : 'N/A'}</p></div><div class="text-right"><p class="text-xl font-bold text-stone-800">R$ ${parseFloat(b.valor || 0).toFixed(2)}</p><span class="status-tag status-${b.status.toLowerCase()}">${b.status}</span></div></div>`).join('') || '<p class="text-center py-10 text-stone-500">Nenhum orçamento encontrado.</p>'}</div></div>`; }
        
        function renderTarefasSection() { 
            document.getElementById('main-title').textContent = 'Lista de Tarefas'; 
            document.getElementById('main-description').textContent = 'Gerencie e acompanhe as tarefas da equipa.'; 
            
            const collaboratorOptions = collaborators.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

            contentArea.innerHTML = `
                <div id="tasks-section">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                        <div class="grade-select-container flex-grow">
                             <label for="task-filter" class="block text-sm font-medium text-stone-700 mb-1">Filtrar por colaborador:</label>
                             <select id="task-filter" class="grade-select">
                                <option value="all">Todos</option>
                                ${collaboratorOptions}
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <button class="primary-btn w-auto" data-action="add-task">+ Adicionar Tarefa</button>
                        </div>
                    </div>
                    <div id="task-list-container" class="space-y-4"></div>
                </div>`; 
            document.getElementById('task-filter').addEventListener('change', () => updateTaskList());
            updateTaskList(); 
        }

        function updateTaskList() { 
            const container = document.getElementById('task-list-container'); 
            if (!container) return; 
            
            const filterValue = document.getElementById('task-filter')?.value || 'all';
            let filteredTasks = [...tasks]; 

            if (filterValue !== 'all') {
                filteredTasks = tasks.filter(task => task.assignedTo && task.assignedTo.includes(filterValue));
            }

            filteredTasks.sort((a, b) => a.completed - b.completed || new Date(a.deadline) - new Date(b.deadline)); 
            if (filteredTasks.length === 0) { container.innerHTML = `<div class="text-center p-8 bg-white rounded-lg"><p class="text-stone-500">Nenhuma tarefa encontrada para este filtro.</p></div>`; return; } 
            container.innerHTML = filteredTasks.map(task => { 
                const deadlineDate = new Date(task.deadline + 'T00:00:00'); 
                const isOverdue = !task.completed && deadlineDate < new Date(); 
                const deadlineClass = isOverdue ? 'deadline-overdue' : ''; 
                const formattedDate = deadlineDate.toLocaleDateString('pt-BR', { timeZone: 'UTC' }); 
                return `<div class="task-card flex items-start gap-4 ${task.completed ? 'completed' : ''}"><input type="checkbox" data-action="toggle-task" data-id="${task.id}" class="mt-1.5 h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-400" ${task.completed ? 'checked' : ''}><div class="flex-1"><p class="text-stone-800 font-medium">${task.description}</p><div class="mt-3 flex flex-wrap justify-between items-center gap-4"><div class="flex items-center gap-2 flex-wrap"><span class="text-xs text-stone-500">Para:</span>${(task.assignedTo || []).map(name => `<span class="user-tag" style="background-color: #e5e7eb; color: #374151;">${name}</span>`).join('')}</div><div class="text-right"><span class="text-xs text-stone-500">Prazo</span><p class="deadline-text ${deadlineClass}">${formattedDate}</p></div></div></div><button class="task-delete-btn" data-action="delete-item" data-collection="tasks" data-id="${task.id}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>`; 
            }).join(''); 
        }
        
        function renderGradeSection() {
            document.getElementById('main-title').textContent = 'Grade de Horários';
            document.getElementById('main-description').textContent = 'Visualize e gerencie a grade de aulas da equipa.';
            
            const isTeacher = currentUserRole === 'teacher';
            let filterHtml = '';
            
            if (!isTeacher) {
                const teacherOptions = collaborators.filter(c => c.sectors && c.sectors.includes('professor')).map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                filterHtml = `
                    <div class="grade-select-container flex-grow">
                        <label for="teacher-filter" class="block text-sm font-medium text-stone-700 mb-1">Filtrar por professor:</label>
                        <select id="teacher-filter" class="grade-select">
                            <option value="all">Todos</option>
                            ${teacherOptions}
                        </select>
                    </div>
                `;
            }

            const addAulaButton = ['admin', 'ap', 'pedagogico'].includes(currentUserRole)
                ? `<button class="primary-btn w-auto" data-action="add-schedule">+ Adicionar Aula</button>`
                : '';

            contentArea.innerHTML = `
                <section id="grade-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                        ${filterHtml}
                        <div class="flex gap-2 ml-auto">
                           ${addAulaButton}
                        </div>
                    </div>
                    <div id="schedule-grid-container"></div>
                </section>
            `;

            if (isTeacher) {
                renderScheduleGrid(currentUserName);
            } else {
                document.getElementById('teacher-filter').addEventListener('change', () => renderScheduleGrid(document.getElementById('teacher-filter').value));
                renderScheduleGrid('all');
            }
        }

        function renderScheduleGrid(teacherFilter) {
            const gridContainer = document.getElementById('schedule-grid-container');
            if (!gridContainer) return;

            const days = ["Segunda", "Terça", "Quarta", "Quinta", "Sexta"];
            let filteredSchedules = [...schedules];

            if (teacherFilter !== 'all') {
                filteredSchedules = filteredSchedules.filter(s => s.teacher === teacherFilter);
            }

            let gridHtml = `<div class="schedule-grid">`;
            days.forEach(day => {
                gridHtml += `<div class="day-column"><h3 class="day-column-header">${day}</h3>`;
                const dayClasses = filteredSchedules.filter(s => s.day === day).sort((a, b) => a.startTime.localeCompare(b.startTime));
                if (dayClasses.length > 0) {
                    dayClasses.forEach(c => {
                        const tagClass = c.type === 'vip' ? 'tag-vip' : 'tag-turma';
                        const tagText = c.type === 'vip' ? 'VIP' : 'TURMA';
                        const teacherName = teacherFilter === 'all' ? `<p class="text-xs text-stone-500"><em>(${c.teacher})</em></p>` : '';
                        gridHtml += `<div class="class-entry" data-action="view-schedule" data-id="${c.id}"><span class="class-tag ${tagClass}">${tagText}</span><p class="text-xs text-stone-600">${c.startTime} - ${c.endTime}</p><p class="font-bold text-stone-800">${c.student}</p><p class="text-sm text-stone-700">${c.level}</p>${teacherName}</div>`;
                    });
                } else {
                    gridHtml += `<p class="text-sm text-center text-stone-400 mt-4">Nenhuma aula</p>`;
                }
                gridHtml += `</div>`;
            });
            gridHtml += `</div>`;
            gridContainer.innerHTML = gridHtml;
        }

        function renderFolhaPagamentoSection() {
            document.getElementById('main-title').textContent = 'Folha de Pagamento';
            document.getElementById('main-description').textContent = 'Gerencie as despesas e contas a pagar do mês.';
            
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const monthName = now.toLocaleString('pt-BR', { month: 'long' });

            const monthlyExpenses = expenses.map(exp => {
                let dueDate;
                if (exp.isFixedSalary && exp.dueDay) {
                    const day = parseInt(exp.dueDay, 10);
                    if (day > 0 && day < 32) {
                       dueDate = new Date(currentYear, currentMonth, day);
                    }
                } else if (exp.dueDate) {
                    // Create date as UTC to avoid timezone issues with date-only strings
                    const parts = exp.dueDate.split('-');
                    dueDate = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
                }

                if (dueDate && dueDate.getUTCMonth() === currentMonth && dueDate.getUTCFullYear() === currentYear) {
                    return { ...exp, effectiveDueDate: dueDate };
                }
                return null;
            }).filter(Boolean).sort((a, b) => a.effectiveDueDate - b.effectiveDueDate);

            const totalToPay = monthlyExpenses
                .filter(exp => !exp.isPaid)
                .reduce((sum, exp) => sum + Number(exp.amount), 0);

            contentArea.innerHTML = `
                <section id="folha-pagamento-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                         <h3 class="text-xl font-bold text-stone-800">Despesas de ${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</h3>
                         <button class="primary-btn w-auto" data-action="add-expense">+ Nova Despesa</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Pago</th>
                                    <th>Descrição</th>
                                    <th>Vencimento</th>
                                    <th class="text-right">Valor (R$)</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="expenses-list">
                                ${monthlyExpenses.length > 0 ? monthlyExpenses.map(exp => `
                                    <tr class="${exp.isPaid ? 'paid' : ''}">
                                        <td class="text-center"><input type="checkbox" data-action="toggle-expense" data-id="${exp.id}" class="h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-400" ${exp.isPaid ? 'checked' : ''}></td>
                                        <td class="font-medium cursor-pointer" data-action="view-expense" data-id="${exp.id}">${exp.description} ${exp.isFixedSalary ? `<span class="text-xs text-stone-500">(${exp.employeeRole || 'Salário Fixo'})</span>` : ''}</td>
                                        <td class="cursor-pointer" data-action="view-expense" data-id="${exp.id}">${exp.effectiveDueDate.toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</td>
                                        <td class="text-right font-mono cursor-pointer" data-action="view-expense" data-id="${exp.id}">${Number(exp.amount).toFixed(2)}</td>
                                        <td class="text-center">
                                            <button class="task-delete-btn" data-action="delete-item" data-collection="expenses" data-id="${exp.id}">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('') : '<tr><td colspan="5" class="text-center py-8 text-stone-500">Nenhuma despesa para este mês.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                    <div class="data-total">
                        <p>Total a Pagar: R$ ${totalToPay.toFixed(2)}</p>
                    </div>
                </section>
            `;
        }
        
        function renderCancelamentosSection() {
            document.getElementById('main-title').textContent = 'Registo de Cancelamentos';
            document.getElementById('main-description').textContent = 'Gerencie todos os cancelamentos de matrículas.';
            const addCancelamentoButton = ['admin', 'financeiro', 'pedagogico'].includes(currentUserRole)
                ? `<button class="primary-btn w-auto" data-action="add-cancelamento">+ Adicionar Cancelamento</button>`
                : '';

            contentArea.innerHTML = `
                <section id="cancellations-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                     <div class="text-right mb-6">
                         ${addCancelamentoButton}
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Aluno</th>
                                    <th>Data do Cancelamento</th>
                                    <th>Motivo</th>
                                    <th>Processado Por</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${cancellations.map(c => `
                                <tr class="cursor-pointer" data-action="view-cancelamento" data-id="${c.id}">
                                    <td class="font-medium">${c.studentName}</td>
                                    <td>${new Date(c.cancellationDate + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                                    <td>${c.reason}</td>
                                    <td>${c.processedBy}</td>
                                </tr>
                                `).join('') || '<tr><td colspan="4" class="text-center py-10 text-stone-500">Nenhum cancelamento encontrado.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
        }
        
        function renderColaboradoresSection() {
            document.getElementById('main-title').textContent = 'Gestão de Colaboradores';
            document.getElementById('main-description').textContent = 'Adicione, edite e defina os setores de cada colaborador.';
            contentArea.innerHTML = `
                <section id="colaboradores-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="text-right mb-6">
                        <button class="primary-btn w-auto" data-action="add-collaborator">+ Adicionar Colaborador</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Setores</th>
                                    <th class="text-center">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${collaborators.map(c => `
                                    <tr>
                                        <td class="font-medium">${c.name}</td>
                                        <td>${(c.sectors || []).map(s => `<span class="sector-tag">${s}</span>`).join('')}</td>
                                        <td class="text-center">
                                            <button class="secondary-btn" data-action="edit-collaborator" data-id="${c.id}">Editar</button>
                                            <button class="danger-btn ml-2" data-action="delete-item" data-collection="collaborators" data-id="${c.id}">Excluir</button>
                                        </td>
                                    </tr>
                                `).join('') || '<tr><td colspan="3" class="text-center py-10 text-stone-500">Nenhum colaborador encontrado.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
        }

        function renderBancoDeFotosSection(folderNameToOpen = null) {
            document.getElementById('main-title').textContent = 'Banco de Fotos';
            document.getElementById('main-description').textContent = 'Gerencie os recursos visuais para marketing e divulgação.';
            
            if (folderNameToOpen) {
                renderPhotoGallery(folderNameToOpen);
                return;
            }

            contentArea.innerHTML = `
                <section id="banco-de-fotos-section">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-stone-800">Pastas</h3>
                        <div class="flex gap-2">
                           <button class="secondary-btn w-auto" data-action="add-folder">+ Nova Pasta</button>
                           <button class="primary-btn w-auto" data-action="add-photo">+ Adicionar Foto</button>
                        </div>
                    </div>
                    <div class="folder-grid">
                        ${photoFolders.map(folder => `
                            <div class="folder-card" data-action="open-folder" data-folder-name="${folder.name}">
                                <button class="folder-delete-btn" data-action="delete-folder" data-id="${folder.id}" data-folder-name="${folder.name}">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </button>
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-3 text-yellow-400"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path></svg>
                                <p class="font-semibold text-stone-700">${folder.name}</p>
                            </div>
                        `).join('')}
                    </div>
                </section>
            `;
        }

        function renderPhotoGallery(folderName) {
             const photosInFolder = photos.filter(p => p.folder === folderName);
             contentArea.innerHTML = `
                <section id="banco-de-fotos-section" data-current-folder="${folderName}">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <button class="secondary-btn mb-2" data-action="back-to-folders">← Voltar para Pastas</button>
                            <h3 class="text-2xl font-bold text-stone-800">Pasta: ${folderName}</h3>
                        </div>
                        <button class="primary-btn w-auto" data-action="add-photo">+ Adicionar Foto</button>
                    </div>
                    <div class="photo-grid">
                        ${photosInFolder.length > 0 ? photosInFolder.map(photo => `
                            <div class="photo-card">
                                <img src="${photo.url}" alt="${photo.title}" class="bg-stone-100">
                                <div class="photo-card-info">
                                    <p class="font-semibold text-stone-800 truncate">${photo.title}</p>
                                    <div class="mt-4 flex gap-2">
                                        <a href="${photo.url}" download="${photo.title.replace(/\s+/g, '_')}.jpg" class="primary-btn text-center text-sm py-2">Download</a>
                                        <button class="danger-btn text-sm py-2" data-action="delete-item" data-collection="photo_bank" data-id="${photo.id}">Excluir</button>
                                    </div>
                                </div>
                            </div>
                        `).join('') : '<p class="text-stone-500 col-span-full text-center py-10">Nenhuma foto nesta pasta.</p>'}
                    </div>
                </section>
             `;
        }

        function renderCPsSection() {
            document.getElementById('main-title').textContent = 'Cronogramas Pedagógicos (CPs)';
            document.getElementById('main-description').textContent = 'Gerencie os níveis e aulas dos cursos.';
            const canEdit = ['pedagogico', 'ap', 'admin'].includes(currentUserRole);
            const addNivelBtn = canEdit ? `<button class="primary-btn w-auto" data-action="add-nivel">+ Adicionar Nível</button>` : '';

            contentArea.innerHTML = `
                <section id="cps-section">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-stone-800">Níveis do Curso</h3>
                        ${addNivelBtn}
                    </div>
                    <div id="cp-list-container">
                        ${cps.length > 0 ? cps.map(nivel => `
                            <div class="cp-level-card" id="nivel-${nivel.id}">
                                <div class="cp-level-header" data-action="toggle-cp-level" data-id="${nivel.id}">
                                    <h4 class="text-lg font-bold text-stone-800">${nivel.title}</h4>
                                    <div class="flex items-center gap-2">
                                        ${canEdit ? `<button class="secondary-btn text-xs" data-action="add-aula" data-nivel-id="${nivel.id}">+ Aula</button><button class="secondary-btn text-xs" data-action="edit-nivel" data-id="${nivel.id}">Editar</button><button class="danger-btn text-xs" data-action="delete-item" data-collection="cps" data-id="${nivel.id}">X</button>` : ''}
                                        <svg class="h-6 w-6 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                                    </div>
                                </div>
                                <div class="cp-level-content">
                                    ${(nivel.lessons && nivel.lessons.length > 0) ? nivel.lessons.map((aula, index) => `
                                        <div class="cp-lesson-item">
                                            <div>
                                                <p class="font-semibold">${index + 1}. ${aula.title}</p>
                                                <p class="text-sm text-stone-600">${aula.topic}</p>
                                            </div>
                                            ${canEdit ? `
                                            <div>
                                                <button class="secondary-btn text-xs" data-action="edit-aula" data-nivel-id="${nivel.id}" data-aula-index="${index}">Editar</button>
                                                <button class="danger-btn text-xs" data-action="delete-aula" data-nivel-id="${nivel.id}" data-aula-index="${index}">X</button>
                                            </div>
                                            ` : ''}
                                        </div>
                                    `).join('') : '<p class="text-center text-stone-500 py-4">Nenhuma aula adicionada.</p>'}
                                </div>
                            </div>
                        `).join('') : '<p class="text-center py-10 text-stone-500">Nenhum nível cadastrado.</p>'}
                    </div>
                </section>
            `;
        }
        
        function renderDojoSection() {
            document.getElementById('main-title').textContent = 'SLAP Dojo';
            document.getElementById('main-description').textContent = 'Gerencie a pontuação dos competidores.';
            const canEdit = ['admin', 'ap'].includes(currentUserRole);
            const addCompetitorBtn = canEdit ? `<button class="primary-btn w-auto" data-action="add-dojo-competitor">+ Adicionar Competidor</button>` : '';

            const sortedRanking = [...dojoRanking].sort((a, b) => b.points - a.points);

            contentArea.innerHTML = `
                <section id="dojo-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="text-xl font-bold text-stone-800">Ranking de Competidores</h3>
                        ${addCompetitorBtn}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-10 text-center">
                        <div class="p-4 rounded-lg border-2 border-stone-300 bg-stone-50 order-2 md:order-1">
                            <h4 class="font-bold text-lg text-amber-500">🥈 2º Lugar</h4>
                            <p class="text-stone-600">Prémio de Segundo Lugar</p>
                        </div>
                        <div class="p-4 rounded-lg border-2 border-yellow-400 bg-yellow-50 transform md:scale-110 order-1 md:order-2">
                            <h4 class="font-bold text-lg text-yellow-500">🥇 1º Lugar</h4>
                            <p class="text-stone-700 font-semibold">Prémio Principal</p>
                        </div>
                        <div class="p-4 rounded-lg border-2 border-amber-600 bg-stone-50 order-3 md:order-3">
                            <h4 class="font-bold text-lg text-amber-700">🥉 3º Lugar</h4>
                            <p class="text-stone-600">Prémio de Terceiro Lugar</p>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Pos.</th>
                                    <th>Competidor</th>
                                    <th class="text-right">Pontos</th>
                                    ${canEdit ? '<th class="text-center">Ações</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedRanking.map((c, index) => {
                                    const medals = ['🥇', '🥈', '🥉'];
                                    const medal = index < 3 ? `<span class="text-xl ml-2">${medals[index]}</span>` : '';
                                    return `
                                    <tr>
                                        <td class="font-bold text-stone-500 text-lg">#${index + 1}</td>
                                        <td class="flex items-center gap-3">
                                            <img src="${c.photo}" alt="${c.name}" class="w-10 h-10 rounded-full object-cover">
                                            <span class="font-medium">${c.name}</span>
                                            ${medal}
                                        </td>
                                        <td class="text-right font-mono font-semibold">${c.points || 0}</td>
                                        ${canEdit ? `
                                        <td class="text-center">
                                            <button class="secondary-btn" data-action="edit-dojo-points" data-id="${c.id}">Editar</button>
                                            <button class="danger-btn ml-2" data-action="delete-item" data-collection="dojo_ranking" data-id="${c.id}">X</button>
                                        </td>
                                        ` : ''}
                                    </tr>
                                `}).join('') || '<tr><td colspan="4" class="text-center py-10 text-stone-500">Nenhum competidor no Dojo.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
        }


        // --- MODAL & FORM FUNCTIONS ---
        function closeFormModal() { document.getElementById('form-modal').classList.remove('visible'); }
        function showSuccessMessage(title, message) { const modalTitle = document.getElementById('form-modal-title'); const modalContentArea = document.getElementById('form-modal-content-area'); modalTitle.textContent = title; modalContentArea.innerHTML = `<div class="text-center"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="mt-4 text-stone-600">${message}</p><button data-action="close-modal" class="primary-btn mt-6 w-auto px-8">OK</button></div>`; document.getElementById('form-modal').classList.add('visible'); }
        function showErrorMessage(title, message) { const modalTitle = document.getElementById('form-modal-title'); const modalContentArea = document.getElementById('form-modal-content-area'); modalTitle.textContent = title; modalContentArea.innerHTML = `<div class="text-center"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="mt-4 text-stone-600">${message}</p><button data-action="close-modal" class="primary-btn mt-6 w-auto px-8">OK</button></div>`; document.getElementById('form-modal').classList.add('visible'); }
        function showConfirmationModal(title, message, onConfirm) { const modalTitle = document.getElementById('form-modal-title'); const modalContentArea = document.getElementById('form-modal-content-area'); modalTitle.textContent = title; modalContentArea.innerHTML = `<p class="text-stone-600">${message}</p><div class="mt-6 flex justify-end gap-4"><button class="secondary-btn" data-action="close-modal">Cancelar</button><button id="confirm-action-btn" class="danger-btn w-auto">Confirmar</button></div>`; document.getElementById('form-modal').classList.add('visible'); document.getElementById('confirm-action-btn').onclick = () => { onConfirm(); closeFormModal(); }; }
        
        function openSignUpModal() {
            const modalTitle = document.getElementById('form-modal-title');
            const modalContentArea = document.getElementById('form-modal-content-area');
            
            modalTitle.textContent = "Criar Nova Conta";
            modalContentArea.innerHTML = `
                <form id="signup-form" class="space-y-4">
                    <div><label for="signup-name" class="font-medium text-sm">Nome Completo</label><input type="text" id="signup-name" name="name" required class="form-input mt-1"></div>
                    <div><label for="signup-email" class="font-medium text-sm">Email</label><input type="email" id="signup-email" name="email" required class="form-input mt-1"></div>
                    <div><label for="signup-password" class="font-medium text-sm">Palavra-passe (mín. 6 caracteres)</label><input type="password" id="signup-password" name="password" required class="form-input mt-1"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Registar</button></div>
                </form>
            `;
            document.getElementById('signup-form').addEventListener('submit', handleSignUp);
            document.getElementById('form-modal').classList.add('visible');
        }

        function openAlunoForm(alunoId = null) {
            const aluno = alunoId ? students.find(s => s.id === alunoId) : null;
            document.getElementById('form-modal-title').textContent = aluno ? "Editar Aluno" : "Adicionar Novo Aluno";
            
            const statusOptions = ['Ativo', 'Inativo', 'Cancelado', 'Pendente'].map(s => `<option value="${s}" ${aluno?.status === s ? 'selected' : ''}>${s}</option>`).join('');
            const levelOptions = courseLevels.map(level => `<option value="${level}" ${aluno?.course === level ? 'selected' : ''}>${level}</option>`).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="aluno-id" value="${alunoId || ''}">
                    <div><label class="font-medium text-sm">Nome Completo do Aluno</label><input type="text" id="aluno-name" class="form-input" required value="${aluno?.name || ''}"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="font-medium text-sm">Status</label><select id="aluno-status" class="form-input">${statusOptions}</select></div>
                        <div><label class="font-medium text-sm">Data de Início</label><input type="date" id="aluno-startDate" class="form-input" value="${aluno?.startDate || ''}"></div>
                    </div>
                    <div><label class="font-medium text-sm">Curso / Nível</label><select id="aluno-course" class="form-input">${levelOptions}</select></div>
                    <hr/>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="aluno-isMinor" class="h-4 w-4 rounded" ${aluno?.isMinor ? 'checked' : ''}>
                        <label for="aluno-isMinor" class="text-sm font-medium">Menor de idade?</label>
                    </div>
                    <div id="responsible-fields" class="${aluno?.isMinor ? '' : 'hidden'} space-y-4">
                        <div><label class="font-medium text-sm">Nome do Responsável</label><input type="text" id="aluno-responsibleName" class="form-input" value="${aluno?.responsibleName || ''}"></div>
                        <div><label class="font-medium text-sm">Telefone do Responsável</label><input type="tel" id="aluno-responsiblePhone" class="form-input" value="${aluno?.responsiblePhone || ''}"></div>
                    </div>
                    <hr/>
                    <div><label class="font-medium text-sm">Observações</label><textarea id="aluno-notes" rows="3" class="form-input">${aluno?.notes || ''}</textarea></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar Aluno</button></div>
                </form>
            `;

            document.getElementById('aluno-isMinor').addEventListener('change', (e) => {
                document.getElementById('responsible-fields').classList.toggle('hidden', !e.target.checked);
            });

            document.getElementById('form-modal-body').onsubmit = saveAluno;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveAluno(event) {
            event.preventDefault();
            const alunoId = document.getElementById('aluno-id').value;
            const isMinor = document.getElementById('aluno-isMinor').checked;
            const data = {
                name: document.getElementById('aluno-name').value,
                status: document.getElementById('aluno-status').value,
                startDate: document.getElementById('aluno-startDate').value,
                course: document.getElementById('aluno-course').value,
                notes: document.getElementById('aluno-notes').value,
                isMinor: isMinor,
                responsibleName: isMinor ? document.getElementById('aluno-responsibleName').value : '',
                responsiblePhone: isMinor ? document.getElementById('aluno-responsiblePhone').value : '',
            };
            if (!data.name) { showErrorMessage("Erro", "O nome do aluno é obrigatório."); return; }

            try {
                if (alunoId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/students`, alunoId), data);
                    showSuccessMessage("Sucesso!", "Dados do aluno atualizados.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/students`), data);
                    await createNotification(`Novo aluno cadastrado: ${data.name}`);
                    showSuccessMessage("Sucesso!", "Novo aluno cadastrado.");
                }
            } catch (error) {
                console.error("Error saving student:", error);
                showErrorMessage("Erro", "Falha ao salvar os dados do aluno.");
            }
        }

        function openAlunoModal(alunoId) {
            const aluno = students.find(s => s.id === alunoId);
            if (!aluno) return;
            document.getElementById('form-modal-title').textContent = `Perfil de ${aluno.name}`;
            
            let responsibleHtml = '';
            if (aluno.isMinor && aluno.responsibleName) {
                responsibleHtml = `
                    <hr/>
                    <h4 class="font-semibold">Dados do Responsável</h4>
                    <p><strong>Nome:</strong> ${aluno.responsibleName || 'N/A'}</p>
                    <p><strong>Telefone:</strong> ${aluno.responsiblePhone || 'N/A'}</p>
                `;
            }

            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-4">
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold text-stone-800">${aluno.name}</h3>
                        <span class="status-tag status-${(aluno.status || 'pendente').toLowerCase()}">${aluno.status || 'Pendente'}</span>
                    </div>
                    <p><strong>Curso/Nível:</strong> ${aluno.course || 'N/A'}</p>
                    <p><strong>Data de Início:</strong> ${aluno.startDate ? new Date(aluno.startDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</p>
                    ${responsibleHtml}
                    ${aluno.notes ? `<div><strong>Observações:</strong><p class="mt-1 p-3 bg-stone-50 rounded-md whitespace-pre-wrap">${aluno.notes}</p></div>` : ''}
                    <div class="border-t pt-4 flex justify-end gap-2">
                        <button class="secondary-btn" data-action="edit-aluno" data-id="${aluno.id}">Editar</button>
                        <button class="danger-btn" data-action="delete-item" data-collection="students" data-id="${aluno.id}">Apagar</button>
                    </div>
                </div>`;
            document.getElementById('form-modal').classList.add('visible');
        }

        function openTurmaForm(turmaId = null) {
            const turma = turmaId ? turmas.find(t => t.id === turmaId) : null;
            document.getElementById('form-modal-title').textContent = turma ? "Editar Turma" : "Adicionar Nova Turma";

            const teacherOptions = collaborators.filter(c => c.sectors?.includes('professor')).map(c => `<option value="${c.id}" data-name="${c.name}" ${turma?.teacherId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
            const levelOptions = courseLevels.map(level => `<option value="${level}" ${turma?.level === level ? 'selected' : ''}>${level}</option>`).join('');
            const studentOptions = students.filter(s => s.status === 'Ativo').map(s => `<option value="${s.id}" ${(turma?.studentIds || []).includes(s.id) ? 'selected' : ''}>${s.name}</option>`).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="turma-id" value="${turmaId || ''}">
                    <div><label class="font-medium text-sm">Nome da Turma</label><input type="text" id="turma-name" class="form-input" required value="${turma?.name || ''}"></div>
                    <div><label class="font-medium text-sm">Professor</label><select id="turma-teacher" class="form-input" required>${teacherOptions}</select></div>
                    <div><label class="font-medium text-sm">Nível</label><select id="turma-level" class="form-input" required>${levelOptions}</select></div>
                    <div><label class="font-medium text-sm">Alunos (selecione um ou mais)</label><select id="turma-students" class="form-input" multiple required style="height: 150px;">${studentOptions}</select></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar Turma</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveTurma;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveTurma(event) {
            event.preventDefault();
            const turmaId = document.getElementById('turma-id').value;
            const teacherSelect = document.getElementById('turma-teacher');
            const selectedTeacherOption = teacherSelect.options[teacherSelect.selectedIndex];

            const data = {
                name: document.getElementById('turma-name').value,
                teacherId: selectedTeacherOption.value,
                teacherName: selectedTeacherOption.getAttribute('data-name'),
                level: document.getElementById('turma-level').value,
                studentIds: Array.from(document.getElementById('turma-students').selectedOptions).map(o => o.value),
            };

            if (!data.name || !data.teacherId) {
                showErrorMessage("Erro", "Nome da turma e professor são obrigatórios.");
                return;
            }

            try {
                if (turmaId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/turmas`, turmaId), data);
                    showSuccessMessage("Sucesso", "Turma atualizada.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/turmas`), data);
                    showSuccessMessage("Sucesso", "Nova turma criada.");
                }
            } catch (error) {
                console.error("Error saving turma:", error);
                showErrorMessage("Erro", "Não foi possível salvar a turma.");
            }
        }

        function openTurmaModal(turmaId) {
            const turma = turmas.find(t => t.id === turmaId);
            if (!turma) return;

            const studentNames = (turma.studentIds || []).map(id => students.find(s => s.id === id)?.name || 'Aluno não encontrado').join(', ');

            document.getElementById('form-modal-title').textContent = turma.name;
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-4">
                    <p><strong>Professor:</strong> ${turma.teacherName}</p>
                    <p><strong>Nível:</strong> ${turma.level}</p>
                    <div><strong>Alunos:</strong><p class="mt-1 p-3 bg-stone-50 rounded-md">${studentNames || 'Nenhum aluno na turma.'}</p></div>
                    <div class="border-t pt-4 flex justify-end gap-2">
                        <button class="secondary-btn" data-action="edit-turma" data-id="${turma.id}">Editar</button>
                        <button class="danger-btn" data-action="delete-item" data-collection="turmas" data-id="${turma.id}">Apagar</button>
                    </div>
                </div>
            `;
            document.getElementById('form-modal').classList.add('visible');
        }

        function openEventForm(eventId = null) {
            const event = eventId ? events.find(e => e.id === eventId) : null;
            document.getElementById('form-modal-title').textContent = event ? "Editar Evento" : "Adicionar Novo Evento";
            const sectorOptions = ["Financeiro", "Pedagógico", "Comercial", "Marketing"].map(s => `<option value="${s}" ${event?.setor === s ? 'selected' : ''}>${s}</option>`).join('');
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="event-id" value="${eventId || ''}">
                    <div><label class="font-medium text-sm">Nome do Evento</label><input type="text" id="event-name" class="form-input" required value="${event?.nome || ''}"></div>
                    <div><label class="font-medium text-sm">Setor</label><select id="event-sector" class="form-input" required>${sectorOptions}</select></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="font-medium text-sm">Data</label><input type="date" id="event-date" class="form-input" required value="${event?.data || ''}"></div>
                        <div><label class="font-medium text-sm">Horário</label><input type="time" id="event-time" class="form-input" value="${event?.time || ''}"></div>
                    </div>
                    <div><label class="font-medium text-sm">Local</label><input type="text" id="event-location" class="form-input" required value="${event?.local || ''}"></div>
                    <div><label class="font-medium text-sm">Descrição</label><textarea id="event-description" rows="4" class="form-input">${event?.descricao || ''}</textarea></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;
            document.getElementById('form-modal-body').onsubmit = saveEvent;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveEvent(event) {
            event.preventDefault();
            const eventId = document.getElementById('event-id').value;
            const data = {
                nome: document.getElementById('event-name').value,
                setor: document.getElementById('event-sector').value,
                data: document.getElementById('event-date').value,
                time: document.getElementById('event-time').value,
                local: document.getElementById('event-location').value,
                descricao: document.getElementById('event-description').value,
            };
            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            try {
                if (eventId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/events`, eventId), data);
                    showSuccessMessage("Sucesso!", "Evento atualizado.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/events`), data);
                    await createNotification(`Novo evento adicionado: ${data.nome}`);
                    showSuccessMessage("Sucesso!", "Novo evento adicionado.");
                }
            } catch (error) { console.error("Error saving event:", error); showErrorMessage("Erro", "Falha ao salvar o evento."); }
        }

        function openEventModal(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event) return;
            document.getElementById('form-modal-title').textContent = event.nome;
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-4">
                    <p><strong>Data:</strong> ${new Date(event.data + 'T00:00:00').toLocaleDateString('pt-BR')} ${event.time ? `às ${event.time}`: ''}</p>
                    <p><strong>Local:</strong> ${event.local}</p>
                    ${event.setor ? `<p><strong>Setor:</strong> <span class="status-tag status-${event.setor.toLowerCase()}">${event.setor}</span></p>` : ''}
                    ${event.descricao ? `<div><strong>Descrição:</strong><p class="mt-1 p-3 bg-stone-50 rounded-md whitespace-pre-wrap">${event.descricao}</p></div>` : ''}
                    <div class="border-t pt-4 flex justify-end gap-2">
                        <button class="secondary-btn" data-action="edit-event" data-id="${event.id}">Editar</button>
                        <button class="danger-btn" data-action="delete-item" data-collection="events" data-id="${event.id}">Apagar</button>
                    </div>
                </div>`;
            document.getElementById('form-modal').classList.add('visible');
        }

        function openBudgetForm(budgetId = null) {
            const budget = budgetId ? budgets.find(b => b.id === budgetId) : null;
            const collaboratorOptions = collaborators.filter(c => c.sectors && c.sectors.includes('orcamentos')).map(c => `<option value="${c.name}" ${budget?.criadoPor === c.name ? 'selected' : ''}>${c.name}</option>`).join('');
            document.getElementById('form-modal-title').textContent = budget ? "Editar Orçamento" : "Adicionar Novo Orçamento";
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="budget-id" value="${budgetId || ''}">
                    <div><label class="font-medium text-sm">Título</label><input type="text" id="budget-title" class="form-input" required value="${budget?.titulo || ''}"></div>
                    <div><label class="font-medium text-sm">Fornecedor</label><input type="text" id="budget-provider" class="form-input" required value="${budget?.fornecedor || ''}"></div>
                    <div><label class="font-medium text-sm">Data do Orçamento</label><input type="date" id="budget-date" class="form-input" required value="${budget?.dataCriacao || ''}"></div>
                    <div><label class="font-medium text-sm">Criado por</label><select id="budget-owner" class="form-input" required>${collaboratorOptions}</select></div>
                    <div><label class="font-medium text-sm">Valor (R$)</label><input type="number" step="0.01" id="budget-value" class="form-input" required value="${budget?.valor || ''}"></div>
                    <div><label class="font-medium text-sm">Status</label><select id="budget-status" class="form-input" required><option>Pendente</option><option>Aprovado</option><option>Rejeitado</option></select></div>
                    <div><label class="font-medium text-sm">Descrição</label><textarea id="budget-description" rows="3" class="form-input">${budget?.descricao || ''}</textarea></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;
            if (budget) document.getElementById('budget-status').value = budget.status;
            document.getElementById('form-modal-body').onsubmit = saveBudget;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveBudget(event) {
            event.preventDefault();
            const budgetId = document.getElementById('budget-id').value;
            const data = {
                titulo: document.getElementById('budget-title').value,
                fornecedor: document.getElementById('budget-provider').value,
                dataCriacao: document.getElementById('budget-date').value,
                criadoPor: document.getElementById('budget-owner').value,
                valor: document.getElementById('budget-value').value,
                status: document.getElementById('budget-status').value,
                descricao: document.getElementById('budget-description').value,
            };
            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            try {
                if (budgetId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/budgets`, budgetId), data);
                    showSuccessMessage("Sucesso!", "Orçamento atualizado.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/budgets`), data);
                    await createNotification(`Novo orçamento criado: ${data.titulo}`);
                    showSuccessMessage("Sucesso!", "Novo orçamento adicionado.");
                }
            } catch (error) { console.error("Error saving budget:", error); showErrorMessage("Erro", "Falha ao salvar o orçamento."); }
        }

        function openBudgetModal(budgetId) {
            const budget = budgets.find(b => b.id === budgetId);
            if (!budget) return;
            document.getElementById('form-modal-title').textContent = budget.titulo;
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-4">
                    <p><strong>Fornecedor:</strong> ${budget.fornecedor}</p>
                    <p><strong>Data:</strong> ${budget.dataCriacao ? new Date(budget.dataCriacao + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'}</p>
                    <p><strong>Criado por:</strong> ${budget.criadoPor || 'N/A'}</p>
                    <p><strong>Valor:</strong> R$ ${parseFloat(budget.valor || 0).toFixed(2)}</p>
                    <p><strong>Status:</strong> <span class="status-tag status-${budget.status.toLowerCase()}">${budget.status}</span></p>
                    ${budget.descricao ? `<div><strong>Descrição:</strong><p class="mt-1 p-3 bg-stone-50 rounded-md">${budget.descricao}</p></div>` : ''}
                    <div class="border-t pt-4 flex justify-end gap-2">
                        <button class="secondary-btn" data-action="edit-budget" data-id="${budget.id}">Editar</button>
                        <button class="danger-btn" data-action="delete-item" data-collection="budgets" data-id="${budget.id}">Apagar</button>
                    </div>
                </div>`;
            document.getElementById('form-modal').classList.add('visible');
        }

        function openTaskForm() {
            document.getElementById('form-modal-title').textContent = "Adicionar Nova Tarefa";
            const collaboratorOptions = collaborators.filter(c => c.sectors && (c.sectors.includes('tarefas') || c.sectors.includes('professor'))).map(c => `<option value="${c.name}">${c.name}</option>`).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <div><label class="font-medium text-sm">Descrição</label><textarea id="task-description" rows="4" class="form-input" required></textarea></div>
                    <div><label class="font-medium text-sm">Prazo Final</label><input type="date" id="task-deadline" class="form-input" required></div>
                    <div><label class="font-medium text-sm">Atribuir para (selecione um ou mais)</label><select id="task-assignedTo" class="form-input" multiple required>${collaboratorOptions}</select></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar Tarefa</button></div>
                </form>`;
            document.getElementById('form-modal-body').onsubmit = saveTask;
            document.getElementById('form-modal').classList.add('visible');
        }
        async function saveTask(event) {
            event.preventDefault();
            const data = {
                description: document.getElementById('task-description').value,
                deadline: document.getElementById('task-deadline').value,
                assignedTo: Array.from(document.getElementById('task-assignedTo').selectedOptions).map(o => o.value),
                assignedBy: currentUserName || 'Admin',
                createdAt: serverTimestamp(),
                completed: false
            };
            if (!data.description || !data.deadline || data.assignedTo.length === 0) { showErrorMessage("Erro de Validação", "Por favor, preencha todos os campos obrigatórios."); return; }
            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), data);
                await createNotification(`Nova tarefa para ${data.assignedTo.join(', ')}: ${data.description}`);
                showSuccessMessage("Sucesso!", "Tarefa adicionada.");
            } catch (error) { console.error("Error saving task:", error); showErrorMessage("Erro", "Falha ao salvar a tarefa."); }
        }
        
        function openCollaboratorForm(collaboratorId = null) {
            const collaborator = collaboratorId ? collaborators.find(c => c.id === collaboratorId) : null;
            document.getElementById('form-modal-title').textContent = collaborator ? "Editar Colaborador" : "Adicionar Novo Colaborador";
            
            const sectors = ['professor', 'tarefas', 'cancelamentos', 'orcamentos', 'banco de fotos'];
            const sectorLabels = { professor: 'Professor (Grade)', tarefas: 'Tarefas', cancelamentos: 'Cancelamentos', orcamentos: 'Orçamentos', 'banco de fotos': 'Banco de Fotos' };
            
            const sectorCheckboxes = sectors.map(sector => {
                const isChecked = collaborator?.sectors?.includes(sector) ? 'checked' : '';
                return `
                    <div class="flex items-center">
                        <input type="checkbox" id="sector-${sector.replace(' ', '-')}" name="sectors" value="${sector}" class="h-4 w-4 rounded" ${isChecked}>
                        <label for="sector-${sector.replace(' ', '-')}" class="ml-2 text-sm">${sectorLabels[sector]}</label>
                    </div>
                `;
            }).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="collaborator-id" value="${collaboratorId || ''}">
                    <div><label class="font-medium text-sm">Nome do Colaborador</label><input type="text" id="collaborator-name" class="form-input" required value="${collaborator?.name || ''}"></div>
                    <div>
                        <label class="font-medium text-sm">Setores de Atuação</label>
                        <div class="mt-2 grid grid-cols-2 gap-2">${sectorCheckboxes}</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                         <div><label class="font-medium text-sm">Início do Turno</label><input type="time" id="collaborator-shift-start" class="form-input" value="${collaborator?.shiftStart || ''}"></div>
                         <div><label class="font-medium text-sm">Fim do Turno</label><input type="time" id="collaborator-shift-end" class="form-input" value="${collaborator?.shiftEnd || ''}"></div>
                    </div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;
            document.getElementById('form-modal-body').onsubmit = saveCollaborator;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveCollaborator(event) {
            event.preventDefault();
            const collaboratorId = document.getElementById('collaborator-id').value;
            const selectedSectors = Array.from(document.querySelectorAll('input[name="sectors"]:checked')).map(cb => cb.value);
            
            const data = {
                name: document.getElementById('collaborator-name').value,
                shiftStart: document.getElementById('collaborator-shift-start').value,
                shiftEnd: document.getElementById('collaborator-shift-end').value,
                sectors: selectedSectors
            };

            if (!data.name) { showErrorMessage("Erro", "O nome do colaborador é obrigatório."); return; }
            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            
            const oldCollaborator = collaboratorId ? collaborators.find(c => c.id === collaboratorId) : null;
            const hadFolderSector = oldCollaborator?.sectors?.includes('banco de fotos');
            const hasFolderSector = data.sectors.includes('banco de fotos');

            try {
                 if (collaboratorId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/collaborators`, collaboratorId), data);
                    showSuccessMessage("Sucesso!", "Colaborador atualizado.");
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/collaborators`), data);
                    await createNotification(`Novo colaborador adicionado: ${data.name}`);
                    showSuccessMessage("Sucesso!", "Colaborador adicionado.");
                }
                
                if(hasFolderSector && !hadFolderSector) {
                    const folderExists = photoFolders.some(f => f.name === data.name);
                    if (!folderExists) {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/photo_folders`), { name: data.name, createdAt: serverTimestamp() });
                    }
                }

            } catch (error) { console.error("Error saving collaborator:", error); showErrorMessage("Erro", "Falha ao salvar o colaborador."); }
        }

        function openScheduleForm(scheduleId = null) {
            const schedule = scheduleId ? schedules.find(s => s.id === scheduleId) : null;
            document.getElementById('form-modal-title').textContent = schedule ? "Editar Aula" : "Adicionar Nova Aula";
            const teacherOptions = collaborators.filter(c => c.sectors && c.sectors.includes('professor')).map(c => `<option value="${c.name}" ${schedule?.teacher === c.name ? 'selected' : ''}>${c.name}</option>`).join('');
            const dayOptions = ["Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Seg/Qua", "Ter/Qui"].map(d => `<option value="${d}" ${schedule?.day === d ? 'selected' : ''}>${d}</option>`).join('');
            const typeOptions = ["vip", "turma"].map(t => `<option value="${t}" ${schedule?.type === t ? 'selected' : ''}>${t.toUpperCase()}</option>`).join('');
            const levelOptions = courseLevels.map(level => `<option value="${level}" ${schedule?.level === level ? 'selected' : ''}>${level}</option>`).join('');

            let formHtml = `<form id="form-modal-body" class="space-y-4"><input type="hidden" id="schedule-id" value="${scheduleId || ''}"><div><label class="font-medium text-sm">Aluno/Turma</label><input type="text" id="schedule-student" class="form-input" required value="${schedule?.student || ''}"></div><div><label class="font-medium text-sm">Nível</label><select id="schedule-level" class="form-input" required>${levelOptions}</select></div><div><label class="font-medium text-sm">Professor</label><select id="schedule-teacher" class="form-input" required>${teacherOptions}</select></div><div class="grid grid-cols-2 gap-4"><div><label class="font-medium text-sm">Dia</label><select id="schedule-day" class="form-input" required>${dayOptions}</select></div><div><label class="font-medium text-sm">Tipo</label><select id="schedule-type" class="form-input" required>${typeOptions}</select></div></div><div class="grid grid-cols-2 gap-4"><div><label class="font-medium text-sm">Início</label><input type="time" id="schedule-start" class="form-input" required value="${schedule?.startTime || ''}"></div><div><label class="font-medium text-sm">Fim</label><input type="time" id="schedule-end" class="form-input" required value="${schedule?.endTime || ''}"></div></div><div class="pt-4 flex justify-end gap-2">${scheduleId ? `<button type="button" class="danger-btn" data-action="delete-item" data-collection="schedules" data-id="${scheduleId}">Apagar</button>` : ''}<button type="submit" class="primary-btn w-auto">Salvar</button></div></form>`;
            document.getElementById('form-modal-content-area').innerHTML = formHtml;
            document.getElementById('form-modal-body').onsubmit = saveScheduleEntry;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveScheduleEntry(event) {
            event.preventDefault();
            const teacherName = document.getElementById('schedule-teacher').value;
            const startTime = document.getElementById('schedule-start').value;
            
            const teacher = collaborators.find(c => c.name === teacherName);
            if (teacher && teacher.shiftStart && teacher.shiftEnd) {
                if (startTime < teacher.shiftStart || startTime > teacher.shiftEnd) {
                    showConfirmationModal(
                        "Aviso de Horário", 
                        `Este horário (${startTime}) está fora do turno do professor (${teacher.shiftStart} - ${teacher.shiftEnd}). Tem a certeza que quer continuar?`,
                        () => proceedWithSaveSchedule()
                    );
                    return;
                }
            }
            proceedWithSaveSchedule();
        }

        async function proceedWithSaveSchedule() {
            const scheduleId = document.getElementById('schedule-id').value;
            const daySelection = document.getElementById('schedule-day').value;
            const daysToCreate = [];
            if (daySelection === 'Seg/Qua') daysToCreate.push('Segunda', 'Quarta');
            else if (daySelection === 'Ter/Qui') daysToCreate.push('Terça', 'Quinta');
            else daysToCreate.push(daySelection);

            const baseData = { 
                student: document.getElementById('schedule-student').value, 
                level: document.getElementById('schedule-level').value, 
                teacher: document.getElementById('schedule-teacher').value, 
                type: document.getElementById('schedule-type').value, 
                startTime: document.getElementById('schedule-start').value, 
                endTime: document.getElementById('schedule-end').value 
            };
            
            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            try {
                if (scheduleId) { 
                    const data = {...baseData, day: daySelection };
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/schedules`, scheduleId), data); 
                    showSuccessMessage("Sucesso!", "Aula atualizada.");
                } else { 
                    for (const day of daysToCreate) {
                        const data = {...baseData, day: day, createdAt: serverTimestamp() };
                        await addDoc(collection(db, `artifacts/${appId}/public/data/schedules`), data); 
                    }
                    showSuccessMessage("Sucesso!", "Aula(s) adicionada(s).");
                }
            } catch (error) { console.error("Error saving schedule:", error); showErrorMessage("Erro", "Falha ao salvar a aula."); }
        }

        function openExpenseForm(expenseId = null) {
            const expense = expenseId ? expenses.find(e => e.id === expenseId) : null;
            document.getElementById('form-modal-title').textContent = expense ? "Editar Despesa" : "Adicionar Nova Despesa";
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="expense-id" value="${expenseId || ''}">
                    <div><label class="font-medium text-sm">Descrição</label><input type="text" id="expense-description" class="form-input" required value="${expense?.description || ''}"></div>
                    
                    <div id="due-date-container" class="${expense?.isFixedSalary ? 'hidden' : ''}">
                        <label class="font-medium text-sm">Vencimento</label>
                        <input type="date" id="expense-dueDate" class="form-input" value="${expense?.dueDate || ''}">
                    </div>
                    
                    <div id="due-day-container" class="${expense?.isFixedSalary ? '' : 'hidden'}">
                        <label class="font-medium text-sm">Dia do Vencimento</label>
                        <input type="number" min="1" max="31" id="expense-dueDay" class="form-input" value="${expense?.dueDay || ''}">
                    </div>

                    <div><label class="font-medium text-sm">Valor (R$)</label><input type="number" step="0.01" id="expense-amount" class="form-input" required value="${expense?.amount || ''}"></div>
                    
                    <div class="flex items-center gap-2"><input type="checkbox" id="expense-isFixedSalary" class="h-4 w-4 rounded" ${expense?.isFixedSalary ? 'checked' : ''}><label for="expense-isFixedSalary" class="text-sm">É salário fixo?</label></div>
                    <div id="employee-role-container" class="${expense?.isFixedSalary ? '' : 'hidden'}"><label class="font-medium text-sm">Cargo</label><input type="text" id="expense-employeeRole" class="form-input" value="${expense?.employeeRole || ''}"></div>
                    <div class="pt-4 flex justify-end gap-2">${expenseId ? `<button type="button" class="danger-btn" data-action="delete-item" data-collection="expenses" data-id="${expenseId}">Apagar</button>` : ''}<button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;
            
            const isFixedSalaryCheckbox = document.getElementById('expense-isFixedSalary');
            isFixedSalaryCheckbox.onchange = () => {
                const isChecked = isFixedSalaryCheckbox.checked;
                document.getElementById('employee-role-container').classList.toggle('hidden', !isChecked);
                document.getElementById('due-date-container').classList.toggle('hidden', isChecked);
                document.getElementById('due-day-container').classList.toggle('hidden', !isChecked);
            };
            
            document.getElementById('form-modal-body').onsubmit = saveExpense;
            document.getElementById('form-modal').classList.add('visible');
        }
        async function saveExpense(event) {
            event.preventDefault();
            const expenseId = document.getElementById('expense-id').value;
            const isFixedSalary = document.getElementById('expense-isFixedSalary').checked;
            const data = {
                description: document.getElementById('expense-description').value,
                amount: document.getElementById('expense-amount').value,
                isPaid: false,
                isFixedSalary: isFixedSalary,
                employeeRole: isFixedSalary ? document.getElementById('expense-employeeRole').value : '',
            };

            if (isFixedSalary) {
                data.dueDay = document.getElementById('expense-dueDay').value;
                data.dueDate = null;
            } else {
                data.dueDate = document.getElementById('expense-dueDate').value;
                data.dueDay = null;
            }

            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            try {
                if (expenseId) {
                    const existingExpense = expenses.find(e => e.id === expenseId);
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/expenses`, expenseId), {...existingExpense, ...data});
                    showSuccessMessage("Sucesso!", "Despesa atualizada.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/expenses`), data);
                    showSuccessMessage("Sucesso!", "Nova despesa adicionada.");
                }
            } catch (error) { console.error("Error saving expense:", error); showErrorMessage("Erro", "Falha ao salvar despesa."); }
        }
        async function toggleExpensePaid(expenseId, isPaid) { if (!db) return; const expenseRef = doc(db, `artifacts/${appId}/public/data/expenses`, expenseId); try { await updateDoc(expenseRef, { isPaid: isPaid }); } catch (error) { console.error("Error updating expense status:", error); } }

        function openCancelamentoForm(cancelamentoId = null) {
            const cancelamento = cancelamentoId ? cancellations.find(c => c.id === cancelamentoId) : null;
            const collaboratorOptions = collaborators.filter(c => c.sectors && c.sectors.includes('cancelamentos')).map(c => `<option value="${c.name}" ${cancelamento?.processedBy === c.name ? 'selected' : ''}>${c.name}</option>`).join('');
            
            let studentFieldHtml = '';
            if (cancelamentoId) {
                studentFieldHtml = `<div><label class="font-medium text-sm">Aluno</label><p class="form-input bg-stone-100">${cancelamento.studentName}</p></div>`;
            } else {
                const activeStudents = students.filter(s => s.status === 'Ativo');
                const studentOptions = activeStudents.map(s => `<option value="${s.id}" data-name="${s.name}">${s.name}</option>`).join('');
                studentFieldHtml = `<div><label class="font-medium text-sm">Aluno a Cancelar</label><select id="cancelamento-studentId" class="form-input" required><option value="">Selecione um aluno...</option>${studentOptions}</select></div>`;
            }

            document.getElementById('form-modal-title').textContent = cancelamento ? "Editar Cancelamento" : "Registar Novo Cancelamento";
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="cancelamento-id" value="${cancelamentoId || ''}">
                    ${studentFieldHtml}
                    <div><label class="font-medium text-sm">Data do Cancelamento</label><input type="date" id="cancelamento-date" class="form-input" required value="${cancelamento?.cancellationDate || ''}"></div>
                    <div><label class="font-medium text-sm">Motivo</label><textarea id="cancelamento-reason" rows="3" class="form-input" required>${cancelamento?.reason || ''}</textarea></div>
                    <div><label class="font-medium text-sm">Processado por</label><select id="cancelamento-processedBy" class="form-input" required>${collaboratorOptions}</select></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;
            document.getElementById('form-modal-body').onsubmit = saveCancelamento;
            document.getElementById('form-modal').classList.add('visible');
        }
        async function saveCancelamento(event) {
            event.preventDefault();
            const cancelamentoId = document.getElementById('cancelamento-id').value;
            if (!db) { console.warn("Offline mode."); return; }

            try {
                if (cancelamentoId) {
                    // Logic to update an existing cancellation record
                    const data = {
                        cancellationDate: document.getElementById('cancelamento-date').value,
                        reason: document.getElementById('cancelamento-reason').value,
                        processedBy: document.getElementById('cancelamento-processedBy').value,
                    };
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/cancellations`, cancelamentoId), data);
                    showSuccessMessage("Sucesso!", "Registo de cancelamento atualizado.");
                } else {
                    // Logic to create a new cancellation and update student status
                    const studentSelect = document.getElementById('cancelamento-studentId');
                    if (!studentSelect.value) {
                        showErrorMessage("Erro", "Por favor, selecione um aluno.");
                        return;
                    }
                    const selectedOption = studentSelect.options[studentSelect.selectedIndex];
                    const studentId = selectedOption.value;
                    const studentName = selectedOption.getAttribute('data-name');

                    const data = {
                        studentId: studentId,
                        studentName: studentName,
                        cancellationDate: document.getElementById('cancelamento-date').value,
                        reason: document.getElementById('cancelamento-reason').value,
                        processedBy: document.getElementById('cancelamento-processedBy').value,
                        createdAt: serverTimestamp()
                    };

                    // 1. Add cancellation record
                    await addDoc(collection(db, `artifacts/${appId}/public/data/cancellations`), data);
                    
                    // 2. Update student status
                    const studentRef = doc(db, `artifacts/${appId}/public/data/students`, studentId);
                    await updateDoc(studentRef, { status: 'Cancelado' });

                    showSuccessMessage("Sucesso!", `Cancelamento registado e status do aluno ${studentName} atualizado.`);
                }
            } catch (error) {
                console.error("Error saving cancellation:", error);
                showErrorMessage("Erro", "Falha ao salvar o cancelamento.");
            }
        }
        function openCancelamentoModal(cancelamentoId) {
            const cancelamento = cancellations.find(c => c.id === cancelamentoId);
            if (!cancelamento) return;
            document.getElementById('form-modal-title').textContent = `Cancelamento de ${cancelamento.studentName}`;
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-4">
                    <p><strong>Aluno:</strong> ${cancelamento.studentName}</p>
                    <p><strong>Data:</strong> ${new Date(cancelamento.cancellationDate + 'T00:00:00').toLocaleDateString('pt-BR')}</p>
                    <p><strong>Processado por:</strong> ${cancelamento.processedBy}</p>
                    <div><strong>Motivo:</strong><p class="mt-1 p-3 bg-stone-50 rounded-md">${cancelamento.reason}</p></div>
                    <div class="border-t pt-4 flex justify-end gap-2">
                        <button class="secondary-btn" data-action="edit-cancelamento" data-id="${cancelamento.id}">Editar</button>
                        <button class="danger-btn" data-action="delete-item" data-collection="cancellations" data-id="${cancelamento.id}">Apagar</button>
                    </div>
                </div>`;
            document.getElementById('form-modal').classList.add('visible');
        }
        
        function openPhotoFormModal() {
            const currentFolder = document.getElementById('banco-de-fotos-section')?.dataset.currentFolder || 'Geral';
            document.getElementById('form-modal-title').textContent = "Adicionar Nova Foto";
            
            const folderOptions = photoFolders.map(f => `<option value="${f.name}" ${f.name === currentFolder ? 'selected' : ''}>${f.name}</option>`).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <div><label class="font-medium text-sm">Título da Foto</label><input type="text" id="photo-title" class="form-input" required></div>
                    <div><label class="font-medium text-sm">URL da Imagem (Cloudinary)</label><input type="url" id="photo-url" class="form-input" required placeholder="https://res.cloudinary.com/..."></div>
                    <div><label class="font-medium text-sm">Pasta</label><select id="photo-folder" class="form-input" required>${folderOptions}</select></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar Foto</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = savePhoto;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function savePhoto(event) {
            event.preventDefault();
            const data = {
                title: document.getElementById('photo-title').value,
                url: document.getElementById('photo-url').value,
                folder: document.getElementById('photo-folder').value,
                uploadedBy: currentUserName,
                createdAt: serverTimestamp()
            };

            if (!data.title || !data.url || !data.folder) {
                showErrorMessage("Erro", "Todos os campos são obrigatórios.");
                return;
            }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/photo_bank`), data);
                await createNotification(`Nova foto adicionada em ${data.folder}: ${data.title}`);
                showSuccessMessage("Sucesso!", "Foto adicionada ao banco.");
            } catch (error) {
                console.error("Error saving photo:", error);
                showErrorMessage("Erro", "Não foi possível salvar a foto.");
            }
        }
        
        function openFolderFormModal() {
            document.getElementById('form-modal-title').textContent = "Adicionar Nova Pasta";
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <div><label class="font-medium text-sm">Nome da Pasta</label><input type="text" id="folder-name" class="form-input" required></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar Pasta</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveFolder;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveFolder(event) {
            event.preventDefault();
            const name = document.getElementById('folder-name').value;
            if (!name) { showErrorMessage("Erro", "O nome da pasta é obrigatório."); return; }
            const folderExists = photoFolders.some(f => f.name.toLowerCase() === name.toLowerCase());
            if (folderExists) { showErrorMessage("Erro", "Uma pasta com este nome já existe."); return; }

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/photo_folders`), { name, createdAt: serverTimestamp() });
                showSuccessMessage("Sucesso!", "Pasta criada.");
            } catch (error) {
                console.error("Error saving folder:", error);
                showErrorMessage("Erro", "Não foi possível criar a pasta.");
            }
        }

        async function deleteFolder(folderId, folderName) {
            if (!db) return;
            showConfirmationModal(
                "Excluir Pasta?",
                `Tem certeza que deseja excluir a pasta "${folderName}"? TODAS as fotos dentro dela serão apagadas permanentemente.`,
                async () => {
                    try {
                        // Batch delete photos in the folder
                        const photosQuery = query(collection(db, `artifacts/${appId}/public/data/photo_bank`), where("folder", "==", folderName));
                        const photosSnapshot = await getDocs(photosQuery);
                        const batch = writeBatch(db);
                        photosSnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();

                        // Delete the folder document itself
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/photo_folders`, folderId));
                        
                        showSuccessMessage("Sucesso", `Pasta "${folderName}" e todas as suas fotos foram excluídas.`);
                    } catch (error) {
                        console.error("Error deleting folder and its contents:", error);
                        showErrorMessage("Erro", "Falha ao excluir a pasta.");
                    }
                }
            );
        }

        function openNivelForm(nivelId = null) {
            const nivel = nivelId ? cps.find(n => n.id === nivelId) : null;
            document.getElementById('form-modal-title').textContent = nivel ? 'Editar Nível' : 'Adicionar Novo Nível';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="nivel-id" value="${nivelId || ''}">
                    <div><label class="font-medium text-sm">Título do Nível</label><input type="text" id="nivel-title" class="form-input" required value="${nivel?.title || ''}"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveNivel;
            document.getElementById('form-modal').classList.add('visible');
        }
        
        async function saveNivel(event) {
            event.preventDefault();
            const nivelId = document.getElementById('nivel-id').value;
            const title = document.getElementById('nivel-title').value;
            if (!title) { showErrorMessage("Erro", "O título é obrigatório."); return; }
            
            try {
                if (nivelId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/cps`, nivelId), { title });
                    showSuccessMessage("Sucesso", "Nível atualizado.");
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/cps`), { title, lessons: [] });
                    showSuccessMessage("Sucesso", "Nível adicionado.");
                }
            } catch(e) { console.error(e); showErrorMessage("Erro", "Não foi possível salvar o nível."); }
        }
        
        function openAulaForm(nivelId, aulaIndex = null) {
            const nivel = cps.find(n => n.id === nivelId);
            const aula = (aulaIndex !== null && nivel && nivel.lessons) ? nivel.lessons[aulaIndex] : null;
            document.getElementById('form-modal-title').textContent = aula ? 'Editar Aula' : 'Adicionar Nova Aula';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="aula-nivel-id" value="${nivelId}">
                    <input type="hidden" id="aula-index" value="${aulaIndex !== null ? aulaIndex : ''}">
                    <div><label class="font-medium text-sm">Título da Aula</label><input type="text" id="aula-title" class="form-input" required value="${aula?.title || ''}"></div>
                    <div><label class="font-medium text-sm">Tema/Descrição</label><textarea id="aula-topic" class="form-input" rows="3" required>${aula?.topic || ''}</textarea></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveAula;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveAula(event) {
            event.preventDefault();
            const nivelId = document.getElementById('aula-nivel-id').value;
            const aulaIndex = document.getElementById('aula-index').value;
            const nivelRef = doc(db, `artifacts/${appId}/public/data/cps`, nivelId);
            const novaAula = {
                title: document.getElementById('aula-title').value,
                topic: document.getElementById('aula-topic').value
            };

            try {
                if (aulaIndex) { // Edit existing lesson
                    const nivelDoc = await getDoc(nivelRef);
                    const lessons = nivelDoc.data().lessons;
                    lessons[aulaIndex] = novaAula;
                    await updateDoc(nivelRef, { lessons });
                } else { // Add new lesson
                    await updateDoc(nivelRef, { lessons: arrayUnion(novaAula) });
                }
                showSuccessMessage("Sucesso", "Aula salva.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "Não foi possível salvar a aula."); }
        }

        async function deleteAula(nivelId, aulaIndex) {
            const nivelRef = doc(db, `artifacts/${appId}/public/data/cps`, nivelId);
            const nivel = cps.find(n => n.id === nivelId);
            const aulaParaRemover = nivel.lessons[aulaIndex];
            try {
                await updateDoc(nivelRef, { lessons: arrayRemove(aulaParaRemover) });
                showSuccessMessage("Sucesso", "Aula removida.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "Não foi possível remover a aula."); }
        }
        
        function openProfileModal(profileUserId) {
            const user = usersData.find(u => u.id === profileUserId);
            if(!user) return;
            
            const canEdit = currentUserRole === 'admin' || userId === profileUserId;
            const editButton = canEdit ? `<button class="secondary-btn" data-action="edit-profile" data-id="${user.id}">Editar Perfil</button>` : '';

            document.getElementById('form-modal-title').textContent = user.name;
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-3">
                    <img src="${user.photoURL || 'https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg'}" alt="Foto de ${user.name}" class="w-32 h-32 mx-auto rounded-full object-cover border-4 border-yellow-200">
                    <div class="profile-modal-item"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg> <span class="font-semibold">${user.role || 'Colaborador'}</span></div>
                    <div class="profile-modal-item"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg> <span>${user.city || 'Não informado'}</span></div>
                    <div class="profile-modal-item"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg> <span>${user.favoriteSong || 'Não informado'}</span></div>
                    <div class="profile-modal-item"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg> <span>${user.favoriteFood || 'Não informado'}</span></div>
                    <div class="border-t pt-4 flex justify-end gap-2">${editButton}</div>
                </div>
            `;
            document.getElementById('form-modal').classList.add('visible');
        }
        
        function openProfileForm(profileUserId) {
            const user = usersData.find(u => u.id === profileUserId);
            if(!user) return;
            
            document.getElementById('form-modal-title').textContent = 'Editar Perfil';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="profile-id" value="${user.id}">
                    <div><label class="font-medium text-sm">Onde mora?</label><input type="text" id="profile-city" class="form-input" value="${user.city || ''}"></div>
                    <div><label class="font-medium text-sm">Música favorita</label><input type="text" id="profile-song" class="form-input" value="${user.favoriteSong || ''}"></div>
                    <div><label class="font-medium text-sm">Comida favorita</label><input type="text" id="profile-food" class="form-input" value="${user.favoriteFood || ''}"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar Alterações</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveProfile;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveProfile(event) {
            event.preventDefault();
            const profileId = document.getElementById('profile-id').value;
            const data = {
                city: document.getElementById('profile-city').value,
                favoriteSong: document.getElementById('profile-song').value,
                favoriteFood: document.getElementById('profile-food').value,
            };
            try {
                await updateDoc(doc(db, "users", profileId), data);
                showSuccessMessage("Sucesso!", "Perfil atualizado.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "Não foi possível atualizar o perfil."); }
        }
        
        function openDojoCompetitorForm(competitorId = null) {
            const competitor = competitorId ? dojoRanking.find(c => c.id === competitorId) : null;
            document.getElementById('form-modal-title').textContent = competitor ? 'Editar Competidor' : 'Adicionar Competidor';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="dojo-id" value="${competitorId || ''}">
                    <div><label class="font-medium text-sm">Nome do Competidor</label><input type="text" id="dojo-name" class="form-input" required value="${competitor?.name || ''}"></div>
                    <div><label class="font-medium text-sm">URL da Foto</label><input type="url" id="dojo-photo" class="form-input" required value="${competitor?.photo || ''}"></div>
                    <div><label class="font-medium text-sm">Pontos</label><input type="number" id="dojo-points" class="form-input" required value="${competitor?.points || 0}"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveDojoCompetitor;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveDojoCompetitor(event) {
            event.preventDefault();
            const competitorId = document.getElementById('dojo-id').value;
            const data = {
                name: document.getElementById('dojo-name').value,
                photo: document.getElementById('dojo-photo').value,
                points: Number(document.getElementById('dojo-points').value)
            };
            if (!data.name || !data.photo) { showErrorMessage("Erro", "Nome e foto são obrigatórios."); return; }
            try {
                if (competitorId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/dojo_ranking`, competitorId), data);
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/dojo_ranking`), data);
                }
                showSuccessMessage("Sucesso", "Competidor do Dojo salvo.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "Não foi possível salvar o competidor."); }
        }

        function openDojoPointsForm(competitorId) {
            const competitor = dojoRanking.find(c => c.id === competitorId);
            if (!competitor) return;
            document.getElementById('form-modal-title').textContent = `Editar Pontos de ${competitor.name}`;
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="dojo-id" value="${competitorId}">
                    <div><label class="font-medium text-sm">Pontos</label><input type="number" id="dojo-points" class="form-input" required value="${competitor.points || 0}"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar Pontos</button></div>
                </form>
            `;
            document.getElementById('form-modal-body').onsubmit = saveDojoPoints;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveDojoPoints(event) {
            event.preventDefault();
            const competitorId = document.getElementById('dojo-id').value;
            const points = Number(document.getElementById('dojo-points').value);
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/dojo_ranking`, competitorId), { points });
                showSuccessMessage("Sucesso", "Pontuação atualizada.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "Não foi possível atualizar a pontuação."); }
        }


        async function toggleTaskCompletion(taskId, isCompleted) { if (!db) return; const taskRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskId); try { await updateDoc(taskRef, { completed: isCompleted }); } catch (error) { console.error("Error updating task status:", error); } }

        async function deleteItem(collectionName, itemId) {
            if (!db) { console.warn("Offline mode."); return; }
            showConfirmationModal(
                "Confirmar Exclusão",
                "Tem a certeza que deseja apagar este item? Esta ação não pode ser desfeita.",
                async () => {
                    try {
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/${collectionName}`, itemId));
                        showSuccessMessage("Sucesso", "Item apagado com sucesso.");
                        closeFormModal();
                    } catch (error) { 
                        console.error(`Error deleting item from ${collectionName}:`, error); 
                        showErrorMessage("Erro", "Falha ao apagar o item.");
                    }
                }
            );
        }
        
        // --- NOTIFICATION FUNCTIONS ---
        async function createNotification(message) {
            if (!db) return;
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/notifications`), {
                    message: message,
                    createdAt: serverTimestamp(),
                    createdBy: currentUserName || 'Sistema'
                });
            } catch (error) {
                console.error("Error creating notification:", error);
            }
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notification-badge');
            if (!badge) return;
            const lastCheck = localStorage.getItem('lastNotificationCheck');
            if (!lastCheck || notifications.length === 0) {
                badge.classList.toggle('hidden', notifications.length === 0);
                return;
            }
            const lastCheckDate = new Date(lastCheck);
            const unreadCount = notifications.filter(n => n.createdAt && n.createdAt.toDate() > lastCheckDate).length;
            badge.classList.toggle('hidden', unreadCount === 0);
        }

        function renderNotificationList() {
            const listEl = document.getElementById('notification-list');
            if (!listEl) return;
            if (notifications.length === 0) {
                listEl.innerHTML = `<p class="p-4 text-sm text-stone-500 text-center">Nenhuma notificação.</p>`;
                return;
            }
            listEl.innerHTML = notifications.map(n => {
                const time = n.createdAt ? timeAgo(n.createdAt.toDate()) : '';
                return `
                    <div class="p-3 hover:bg-stone-50">
                        <p class="text-sm text-stone-700">${n.message}</p>
                        <p class="text-xs text-stone-400 mt-1">${time}</p>
                    </div>
                `;
            }).join('');
        }

        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " anos atrás";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " meses atrás";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " dias atrás";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " horas atrás";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutos atrás";
            return "agora mesmo";
        }


        function renderMenu() {
            const mainNav = document.getElementById('main-navigation');
            const menuItems = [
                { key: 'inicio', label: 'Início', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>', roles: null },
                { key: 'dojo', label: 'Dojo', icon: '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M6.5 12.5h11"/><path d="M12 6.5v11"/><path d="M17.5 17.5 19 19"/><path d="M6.5 6.5 5 5"/><path d="M17.5 6.5 19 5"/><path d="M6.5 17.5 5 19"/><path d="M2 12C2 6.5 6.5 2 12 2s10 4.5 10 10-4.5 10-10 10S2 17.5 2 12Z"/><path d="M16 8h2"/><path d="M6 16H4"/></svg>', roles: null },
                { key: 'alunos', label: 'Alunos', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>', roles: ['admin', 'pedagogico', 'financeiro', 'ap'] },
                { key: 'turmas', label: 'Turmas', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>', roles: ['admin', 'pedagogico', 'ap'] },
                { key: 'pef', label: 'PEF', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="m9 16 2 2 4-4"/></svg>', roles: ['admin', 'pedagogico', 'ap', 'teacher'] },
                { key: 'grade', label: 'Grade', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg>', roles: ['admin', 'ap', 'pedagogico', 'financeiro', 'teacher'] },
                { key: 'tarefas', label: 'Tarefas', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>', roles: ['admin', 'am', 'ap', 'pedagogico', 'financeiro', 'teacher'] },
                { key: 'cps', label: 'CPs', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>', roles: ['admin', 'pedagogico', 'ap'] },
                { key: 'eventos', label: 'Eventos', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 8c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3z"/><path d="M12.44 8.917a4 4 0 0 0-4.88 0C4.965 10.685 3 13.982 3 17.5V22h18v-4.5c0-3.518-1.965-6.815-4.56-8.583z"/></svg>', roles: ['admin', 'am', 'ap', 'pedagogico'] },
                { key: 'orcamentos', label: 'Orçamentos', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>', roles: ['admin', 'am', 'financeiro'] },
                { key: 'banco-de-fotos', label: 'Banco de Fotos', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>', roles: ['admin', 'am'] },
                { key: 'colaboradores', label: 'Colaboradores', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>', roles: ['admin', 'pedagogico', 'financeiro'] },
                { key: 'cancelamentos', label: 'Cancelamentos', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="23" y1="18" x2="17" y2="12"/><line x1="17" y1="18" x2="23" y2="12"/></svg>', roles: ['admin', 'pedagogico', 'financeiro'] },
                { key: 'folha-pagamento', label: 'Folha de Pgto.', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>', roles: ['admin', 'financeiro'] }
            ];

            const lockIcon = `<svg class="ml-auto h-4 w-4 text-stone-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>`;

            let menuItemsHTML = menuItems.map(item => {
                const hasAccess = !item.roles || item.roles.includes(currentUserRole);
                if (hasAccess) {
                    return `<button data-target="${item.key}" class="nav-item w-full text-left px-4 py-2.5 rounded-lg flex items-center font-semibold">${item.icon}${item.label}</button>`;
                } else {
                    return `<button disabled class="nav-item w-full text-left px-4 py-2.5 rounded-lg flex items-center font-semibold opacity-50 cursor-not-allowed">${item.icon}${item.label}${lockIcon}</button>`;
                }
            }).join('');
            
            mainNav.innerHTML = menuItemsHTML;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const pageRenderers = { 'inicio': renderInicioSection, 'alunos': renderAlunosSection, 'turmas': renderTurmasSection, 'pef': renderPEFSection, 'eventos': renderEventosSection, 'orcamentos': renderOrcamentosSection, 'tarefas': renderTarefasSection, 'grade': renderGradeSection, 'folha-pagamento': renderFolhaPagamentoSection, 'cancelamentos': renderCancelamentosSection, 'colaboradores': renderColaboradoresSection, 'banco-de-fotos': renderBancoDeFotosSection, 'cps': renderCPsSection, 'dojo': renderDojoSection };
            
            document.body.addEventListener('click', (event) => {
                const navTarget = event.target.closest('.nav-item');
                if (navTarget && !navTarget.disabled) {
                    const pageKey = navTarget.dataset.target;
                    if (pageKey && pageRenderers[pageKey]) {
                        pageRenderers[pageKey]();
                        setActiveNavItem(navTarget);
                    }
                }

                if (event.target.closest('#alunos-filter-buttons')) {
                    const filterBtn = event.target.closest('.filter-btn');
                    if(filterBtn) {
                        document.querySelectorAll('#alunos-filter-buttons .filter-btn').forEach(b => b.classList.remove('active'));
                        filterBtn.classList.add('active');
                        updateAlunosList(filterBtn.dataset.filter);
                    }
                }
                
                const actionTarget = event.target.closest('[data-action]');
                if (actionTarget) {
                    // Prevent modal from closing if the action is inside the modal content
                    if(actionTarget.closest('.modal-content')) event.stopPropagation();
                    
                    const { action, id, collection, folderName, nivelId, aulaIndex } = actionTarget.dataset;
                    const actionHandlers = {
                        'open-signup': openSignUpModal,
                        'add-aluno': () => openAlunoForm(),
                        'view-aluno': () => openAlunoModal(id),
                        'edit-aluno': () => openAlunoForm(id),
                        'add-turma': () => openTurmaForm(),
                        'view-turma': () => openTurmaModal(id),
                        'edit-turma': () => openTurmaForm(id),
                        'add-event': openEventForm,
                        'view-event': () => openEventModal(id),
                        'edit-event': () => openEventForm(id),
                        'add-budget': openBudgetForm,
                        'view-budget': () => openBudgetModal(id),
                        'edit-budget': () => openBudgetForm(id),
                        'add-task': openTaskForm,
                        'add-collaborator': () => openCollaboratorForm(),
                        'edit-collaborator': () => openCollaboratorForm(id),
                        'add-schedule': openScheduleForm,
                        'view-schedule': () => openScheduleForm(id),
                        'add-expense': openExpenseForm,
                        'view-expense': () => openExpenseForm(id),
                        'add-cancelamento': openCancelamentoForm,
                        'view-cancelamento': () => openCancelamentoModal(id),
                        'edit-cancelamento': () => openCancelamentoForm(id),
                        'delete-item': () => deleteItem(collection, id),
                        'close-modal': closeFormModal,
                        'add-photo': openPhotoFormModal,
                        'add-folder': openFolderFormModal,
                        'delete-folder': () => deleteFolder(id, folderName),
                        'open-folder': () => renderPhotoGallery(folderName),
                        'back-to-folders': renderBancoDeFotosSection,
                        'toggle-cp-level': () => { const card = document.getElementById(`nivel-${id}`); if(card) { card.classList.toggle('open'); const icon = card.querySelector('svg'); icon.style.transform = card.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)'; } },
                        'add-nivel': () => openNivelForm(),
                        'edit-nivel': () => openNivelForm(id),
                        'add-aula': () => openAulaForm(nivelId),
                        'edit-aula': () => openAulaForm(nivelId, aulaIndex),
                        'delete-aula': () => deleteAula(nivelId, aulaIndex),
                        'view-profile': () => openProfileModal(id),
                        'edit-profile': () => openProfileForm(id),
                        'add-dojo-competitor': () => openDojoCompetitorForm(),
                        'edit-dojo-points': () => openDojoPointsForm(id),
                    };
                    if (actionHandlers[action]) {
                        actionHandlers[action]();
                    }
                }

                if(event.target.matches('input[type="checkbox"][data-action="toggle-task"]')) {
                    const taskId = event.target.dataset.id;
                    const isCompleted = event.target.checked;
                    toggleTaskCompletion(taskId, isCompleted);
                }
                 if(event.target.matches('input[type="checkbox"][data-action="toggle-expense"]')) {
                    const expenseId = event.target.dataset.id;
                    const isPaid = event.target.checked;
                    toggleExpensePaid(expenseId, isPaid);
                }
            });

            const notificationButton = document.getElementById('notification-button');
            const notificationPanel = document.getElementById('notification-panel');

            notificationButton.addEventListener('click', (event) => {
                event.stopPropagation();
                const isHidden = notificationPanel.classList.toggle('hidden');
                if (!isHidden) {
                    renderNotificationList();
                    localStorage.setItem('lastNotificationCheck', new Date().toISOString());
                    updateNotificationBadge();
                }
            });

            document.addEventListener('click', (event) => {
                if (!notificationPanel.classList.contains('hidden') && !notificationButton.contains(event.target) && !notificationPanel.contains(event.target)) {
                    notificationPanel.classList.add('hidden');
                }
            });

            document.getElementById('logout-button').addEventListener('click', handleLogout);
            document.getElementById('pending-logout').addEventListener('click', handleLogout);
            document.getElementById('profile-picture-upload').addEventListener('change', handleProfilePictureUpload);
            initializeFirebase();
        });
    </script>
</body>
</html>
