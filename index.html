<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hub SLAP</title>
    <link rel="icon" type="image/png" href="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749543469/SLAP_FAVICON_AMARELO_coilvj.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Palette: SLAP Brand Colors: #F1D24B (Yellow), #FF5C3D (Orange), #84C7DF (Blue), #8671D1 (Purple) -->
    <style>
        body {
            font-family: 'DM Sans', sans-serif;
            line-height: 1.25;
        }
        .nav-item.active {
            background-color: #FFFBEB; /* yellow-50 */
            color: #F1D24B;
            font-weight: 600;
        }
        .tab-btn {
            padding: 8px 16px;
            border: 2px solid #e5e7eb;
            background-color: #f9fafb;
            color: #6b7280;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-btn:hover {
            background-color: #f3f4f6;
            border-color: #d1d5db;
        }
        .tab-btn.active {
            background-color: #F1D24B;
            color: #44403c;
            border-color: #F1D24B;
            font-weight: 600;
        }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e7e5e4; padding-bottom: 1rem; margin-bottom: 1rem; }
        .modal-header h4 { font-size: 1.25rem; font-weight: 700; color: #44403c; }
        .modal-close-btn { 
            background: none; 
            border: none; 
            cursor: pointer; 
            color: #a8a29e; 
            font-size: 2rem; 
            width: 2.5rem; 
            height: 2.5rem; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            transition: all 0.2s;
            border-radius: 0.5rem;
        }
        .modal-close-btn:hover { 
            background-color: #f5f5f4; 
            color: #57534e; 
        }

        .base-card { background-color: #ffffff; border-radius: 0.75rem; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e7e5e4; transition: all 0.2s; }
        .base-card:hover { border-color: #F1D24B; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }

        .status-tag { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .status-aprovado, .status-presencial, .status-ativo { background-color: #D1FAE5; color: #065F46; }
        .status-online, .status-em-andamento, .status-inativo { background-color: #DBEAFE; color: #1E40AF; }
        .status-conclu√≠da { background-color: #F3F4F6; color: #4B5563; }
        .status-pendente, .status-em-espera { background-color: #FEF3C7; color: #92400E; }
        .status-vip { background-color: #F1D24B; color: #1f2937; font-weight: 700; }
        .status-turma { background-color: #84C7DF; color: #1f2937; font-weight: 700; }
        .status-dupla { background-color: #8671D1; color: #ffffff; font-weight: 700; }
        .status-rejeitado, .status-cancelado { background-color: #FEE2E2; color: #991B1B; }

        .status-financeiro { background-color: #D1FAE5; color: #065F46; }
        .status-pedag√≥gico { background-color: #DBEAFE; color: #1E40AF; }
        .status-comercial { background-color: #FEF3C7; color: #92400E; }
        .status-marketing { background-color: #FEE2E2; color: #991B1B; }

        .sector-tag, .keyword-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            margin: 0.25rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1.5px solid #F1D24B;
            color: #44403c;
            background-color: transparent;
        }

        .task-card { background-color: #ffffff; border-radius: 0.75rem; padding: 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); border: 1px solid #e7e5e4; transition: all 0.2s ease; }
        .task-card.completed { background-color: #f9fafb; border-color: #e5e7eb; }
        .task-card.completed p { text-decoration: line-through; color: #9ca3af; }
        .task-card:hover { border-color: #F1D24B; box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .user-tag { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .tag-admin { background-color: #E5E7EB; color: #374151; }
        .tag-break { background-color: #374151; color: #FFFFFF; }
        .deadline-text { font-weight: 600; color: #57534e; }
        .deadline-overdue { color: #b91c1c; }
        .task-delete-btn { background: none; border: none; cursor: pointer; color: #9ca3af; transition: color 0.2s; }
        .task-delete-btn:hover { color: #ef4444; }

        .page-number-btn { padding: 0.25rem 0.75rem; border: 1px solid #d6d3d1; background-color: #ffffff; color: #44403c; border-radius: 0.375rem; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; }
        .page-number-btn:hover { background-color: #f5f5f4; border-color: #F1D24B; }
        .page-number-btn.active { background-color: #F1D24B; border-color: #F1D24B; color: #44403c; font-weight: 600; }

        .grade-select-container { margin-bottom: 1.5rem; max-width: 400px; }
        .grade-select { width: 100%; padding: 0.75rem 1rem; border-radius: 0.5rem; border: 1px solid #d6d3d1; background-color: #ffffff; font-weight: 600; color: #44403c; -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; cursor: pointer; }
        .schedule-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; }
        .day-column { background-color: #f9fafb; border-radius: 0.75rem; padding: 1rem; border: 1px solid #f3f4f6; }
        .day-column-header { font-weight: 700; color: #44403c; font-size: 1.25rem; padding-bottom: 0.75rem; margin-bottom: 0.75rem; border-bottom: 2px solid #F1D24B; }
        .class-entry { background-color: #ffffff; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
        .class-entry:hover { transform: translateY(-2px); box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
        .class-tag { font-size: 0.625rem; font-weight: 700; padding: 2px 8px; border-radius: 9999px; color: white; margin-bottom: 4px; display: inline-block; text-transform: uppercase; }
        .tag-turma { background-color: #FF5C3D; }
        .tag-vip { background-color: #8671D1; }
        .tag-dupla { background-color: #F1D24B; color: #1f2937; }

        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .data-table th { font-weight: 600; font-size: 0.875rem; color: #6b7280; }
        .data-table tbody tr.paid { background-color: #f9fafb; color: #9ca3af; }
        .data-table tbody tr.paid .font-medium { text-decoration: line-through; }
        .data-table tbody tr:not(.paid):hover { background-color: #f9fafb; cursor: pointer; }
        .data-total { margin-top: 1.5rem; text-align: right; }
        .data-total p { font-size: 1.25rem; font-weight: 700; color: #1f2937; }

        .form-input { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; }
        .form-input select, select.form-input { 
            -webkit-appearance: none; 
            appearance: none; 
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); 
            background-position: right 1rem center; 
            background-repeat: no-repeat; 
            background-size: 1.25em 1.25em; 
            padding-right: 3rem; 
            cursor: pointer; 
        }
        .form-input:disabled { background-color: #f3f4f6; cursor: not-allowed; }
        .primary-btn { background-color: #F1D24B; color: #44403c; padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.2s; border: none; cursor: pointer; display: inline-flex; align-items: center; white-space: nowrap; }
        .primary-btn:hover { background-color: #eab308; }
        .primary-btn.full-width { width: 100%; justify-content: center; }
        .secondary-btn { background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s; }
        .secondary-btn:hover { background-color: #e5e7eb; }
        .secondary-btn.active { background-color: #F1D24B; color: #44403c; border-color: #F1D24B;}
        .danger-btn { background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: background-color 0.2s; border: none; cursor: pointer; }
        .danger-btn:hover { background-color: #dc2626; }

        .cp-level-header { padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .cp-level-content { padding: 0 1.5rem; max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding-bottom 0.3s ease-out; }
        .cp-level-card.open .cp-level-content { max-height: 6000px; padding-bottom: 1.5rem; }
        .cp-lesson-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: 0.5rem; }
        .cp-lesson-item:nth-child(odd) { background-color: #f9fafb; }



        /* --- PEF Styles (Integrated) --- */
        .pef-student-attendance-row { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; background-color: #f9fafb; }
        .pef-status-btn-group button { width: 2.5rem; height: 2.5rem; border-radius: 0.375rem; border: 1px solid #d1d5db; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.2s; background-color: #f9fafb; }
        .pef-status-btn-group button:hover { border-color: #a8a29e; }
        .pef-status-btn-group button.active.P { background-color: #10B981; color: white; border-color: #10B981; }
        .pef-status-btn-group button.active.F { background-color: #EF4444; color: white; border-color: #EF4444; }
        .pef-status-btn-group button.active.PP { background-color: #F59E0B; color: white; border-color: #F59E0B; }

        /* --- Calendar Styles --- */
        .calendar-container { max-width: 1200px; margin: 0 auto; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .calendar-nav-btn { background-color: #f3f4f6; border: 1px solid #d1d5db; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .calendar-nav-btn:hover { background-color: #e5e7eb; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background-color: #e5e7eb; border-radius: 0.5rem; overflow: hidden; }
        .calendar-day-header { background-color: #f9fafb; padding: 1rem; text-align: center; font-weight: 700; color: #44403c; }
        .calendar-day { background-color: white; min-height: 120px; padding: 0.5rem; position: relative; cursor: pointer; transition: background-color 0.2s; }
        .calendar-day:hover { background-color: #fffbeb; }
        .calendar-day.other-month { background-color: #f9fafb; color: #9ca3af; }
        .calendar-day.today { background-color: #fef3c7; border: 2px solid #F1D24B; }
        .calendar-day-number { font-weight: 600; margin-bottom: 0.25rem; }
        .calendar-event { background-color: #F1D24B; color: #44403c; padding: 0.125rem 0.25rem; border-radius: 0.25rem; font-size: 0.75rem; margin-bottom: 0.125rem; cursor: pointer; display: block; }
        .calendar-event:hover { background-color: #eab308; }
        .calendar-event.gravacao { background-color: #10B981; color: white; }
        .calendar-event.lembrete { background-color: #F59E0B; color: white; }
        .calendar-event.evento { background-color: #8671D1; color: white; }
        .calendar-event.aula-extra { background-color: #FF5C3D; color: white; }
        .calendar-event.data-comemorativa { background-color: #84C7DF; color: white; }
        .calendar-event.reuniao { background-color: #6B7280; color: white; }
        .marketing-event { background-color: #84C7DF !important; color: white !important; }
        .marketing-event:hover { background-color: #6ba3c7 !important; }
        .marketing-event .event-tipos { display: block; font-size: 0.65rem; opacity: 0.9; margin-top: 2px; }
        
        .holiday-event { 
            background-color: #8671D1 !important;
            color: white !important;
            cursor: default !important;
            border: 1px solid #a855f7;
        }
        .holiday-event:hover { 
            background-color: #7c3aed !important;
            transform: none !important;
        }
        .event-country {
            background: rgba(255,255,255,0.2);
            padding: 1px 3px;
            border-radius: 2px;
            font-size: 8px;
            margin-left: 2px;
        }

        /* --- Monthly Highlight Styles --- */
        .highlight-card { display: flex; gap: 1rem; align-items: center; }
        .highlight-photo { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #F1D24B; }
        .highlight-info h5 { font-size: 1.125rem; font-weight: 700; color: #44403c; margin-bottom: 0.25rem; }
        .highlight-info p { color: #6b7280; font-size: 0.875rem; line-height: 1.4; }
        .highlight-award { color: #059669; font-size: 0.875rem; margin-top: 0.5rem; }
        .highlight-empty { text-align: center; padding: 2rem; color: #9ca3af; }

        .audio-player-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            max-width: 450px;
            background-color: #f5f5f4;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
        }
        .play-pause-button {
            background-color: #F1D24B;
            color: #44403c;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        .play-pause-button:hover { background-color: #eab308; }
        .play-pause-button svg { width: 20px; height: 20px; }
        .progress-bar { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: #e7e5e4; border-radius: 3px; outline: none; cursor: pointer; }
        .progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: #44403c; border-radius: 50%; cursor: pointer; }
        .progress-bar::-moz-range-thumb { width: 16px; height: 16px; background: #44403c; border-radius: 50%; cursor: pointer; }
        .time-display { font-size: 0.875rem; color: #57534e; min-width: 80px; text-align: center; }
        #certificate {
            background: linear-gradient(45deg, #fffbeb, #f0f9ff);
        }

        /* --- Guidelines Styles --- */
        .guidelines-search { width: 100%; max-width: 400px; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.375rem; margin-bottom: 2rem; }
        .guideline-card { background-color: #ffffff; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.06); transition: all 0.2s; }
        .guideline-card.good-practice { border-left: 4px solid #10B981; }
        .guideline-card.prohibited { border-left: 4px solid #EF4444; }
        .guideline-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .guideline-icon { margin-right: 0.75rem; }
        .guideline-header { display: flex; align-items: center; margin-bottom: 0.75rem; }
        .guideline-title { font-size: 1.125rem; font-weight: 700; color: #44403c; }
        .guideline-description { color: #6b7280; line-height: 1.5; }
        .guideline-delete-btn { background: none; border: none; cursor: pointer; color: #9ca3af; margin-left: auto; padding: 0.25rem; }

        /* --- Pagination Styles --- */
        .pagination-controls { margin-top: 1rem; }
        .pagination-btn { 
            padding: 0.5rem; 
            border: 1px solid #d1d5db; 
            background: #ffffff; 
            border-radius: 0.375rem; 
            cursor: pointer; 
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .pagination-btn:hover:not(.disabled) { 
            background: #f3f4f6; 
            border-color: #9ca3af; 
        }
        .pagination-btn.disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            background: #f9fafb;
        }
        .pagination-number { 
            padding: 0.5rem 0.75rem; 
            border: 1px solid #d1d5db; 
            background: #ffffff; 
            border-radius: 0.375rem; 
            cursor: pointer; 
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .pagination-number:hover { 
            background: #f3f4f6; 
            border-color: #9ca3af; 
        }
        .pagination-number.active { 
            background: #F1D24B; 
            border-color: #F1D24B; 
            color: #1f2937;
            font-weight: 700;
        }
        .guideline-delete-btn:hover { color: #ef4444; }

        /* --- BrainFlip Game Styles --- */

        /* BrainFlip Flashcard Styles */
        .flashcard-container {
            perspective: 1000px;
            width: 100%;
            max-width: 400px;
            height: 250px;
            margin: 0 auto;
        }
        .flashcard {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            background-color: #ffffff;
            border: 2px solid #84C7DF;
        }
        .flashcard.flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
            border-radius: 12px;
            font-size: 1.25rem;
            font-weight: 600;
            color: #44403c;
            line-height: 1.4;
        }
        .flashcard-front {
            background: linear-gradient(135deg, #F1D24B 0%, #FF5C3D 100%);
        }
        .flashcard-back {
            background: linear-gradient(135deg, #84C7DF 0%, #8671D1 100%);
            transform: rotateY(180deg);
            color: white;
        }
        .navigation-button-game {
            background-color: #F1D24B;
            color: #44403c;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .navigation-button-game:hover {
            background-color: #eab308;
        }
        .navigation-button-game:disabled {
            background-color: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">

    <!-- Login, Pending, and Hub Views -->
    <div id="login-view" class="flex items-center justify-center min-h-screen">
        <!-- O conte√∫do do login ser√° gerado pelo JS -->
    </div>

    <div id="pending-view" class="hidden items-center justify-center min-h-screen">
        <div class="text-center p-8 bg-white rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold" style="color: #F1D24B;">Aguardando Aprova√ß√£o</h2>
            <p class="text-stone-600 mt-2">Sua conta foi criada e est√° aguardando aprova√ß√£o de um administrador.</p>
            <button id="pending-logout" class="mt-6 secondary-btn w-auto">Sair</button>
        </div>
    </div>

    <div id="hub-view" class="hidden">
        <div id="app-container" class="min-h-screen md:flex bg-stone-50">
            <aside class="md:w-64 bg-white md:border-r border-b border-stone-200 p-4 md:p-6 flex flex-col h-screen md:fixed md:top-0 md:left-0 md:overflow-y-auto">
                <div class="mb-4 text-center">
                    <div>
                        <img id="profile-picture" src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg" alt="Foto de Perfil" class="w-24 h-24 mx-auto rounded-full object-cover border-4 border-stone-200">
                    </div>
                </div>
                <h1 class="text-xl font-bold text-stone-800 text-center">Hub SLAP</h1>
                <p id="welcome-message" class="text-center text-sm text-stone-600 mb-6"></p>
                <nav id="main-navigation" class="space-y-1 flex-1 overflow-y-auto">
                    <!-- Menu items are dynamically generated here -->
                </nav>
                <div class="pt-4 border-t border-stone-200 mt-4">
                    <button id="logout-button" class="nav-item w-full text-left px-4 py-2.5 rounded-lg text-stone-700 hover:bg-red-50 hover:text-red-600 transition-colors flex items-center font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                        Sair
                    </button>
                </div>
            </aside>

            <main class="flex-1 relative md:ml-64">
                <div class="bg-[#F1D24B] block w-full p-4 sm:p-6 md:p-8 absolute top-0 left-0 right-0 z-10">
                    <div class="flex justify-between items-start">
                        <header id="main-header" class="flex items-center gap-4">
                            <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1751163691/SLAP_TIPO_PRETO_1_xarnpe.png" alt="SLAP Logo" class="h-12 w-auto">
                            <div>
                                <h2 id="main-title" class="text-3xl font-bold text-stone-800"></h2>
                                <p id="main-description" class="mt-1 text-stone-700"></p>
                            </div>
                        </header>
                        <div id="header-welcome-message" class="text-right text-stone-800">
                            <!-- Welcome message will be inserted here -->
                        </div>
                    </div>
                </div>
                <div id="content-area" class="pt-32 pb-4 px-4 sm:pt-36 sm:pb-6 sm:px-6 md:pt-40 md:pb-8 md:px-8"></div>
            </main>
        </div>
    </div>

    <!-- Modal -->
    <div id="form-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="modal-header-container" class="modal-header">
                <h4 id="form-modal-title"></h4>
                <button class="modal-close-btn" data-action="close-modal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            <div id="form-modal-content-area"></div>
        </div>
    </div>

    <!-- Fortune Cookie section - no modal needed -->

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, deleteDoc, serverTimestamp, query, setDoc, getDoc, updateDoc, orderBy, limit, where, arrayUnion, arrayRemove, getDocs, writeBatch, deleteField } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";

        // --- GLOBAL VARIABLES ---
        const contentArea = document.getElementById('content-area');
        const mainHeader = document.getElementById('main-header');
        const loginView = document.getElementById('login-view');
        const hubView = document.getElementById('hub-view');
        const pendingView = document.getElementById('pending-view');

        let db, auth, storage, userId, currentUserName, currentUserRole;
        let usersData = [], students = [], turmas = [], vips = [], attendance = [], tasks = [], events = [], collaborators = [], schedules = [], expenses = [], dojoRanking = [], dojoMissions = [], activityLogs = [], rechamadas = [], linksUteis = [];
        let userProfiles = {};
        let monthlyHighlight = {
            name: 'Jo√£o Silva',
            photo: 'https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg',
            description: 'Parab√©ns ao Jo√£o pelo excelente desempenho este m√™s! Destaque em dedica√ß√£o e resultados excepcionais.',
            award: 'Voucher de R$ 200 para compras'
        };
        let allUnsubscribers = [];
        const appId = 'hub-gestao-slap';

        // Standardized levels across all system
        const STANDARD_LEVELS = ['Starter 1', 'Starter 2', 'Freshman 1', 'Freshman 2', 'Sophomore 1', 'Sophomore 2', 'Junior 1', 'Junior 2', 'Senior 1', 'Senior 2', 'ACC'];

        // Pagination state
        let currentPage = 1;
        let itemsPerPage = 20;
        
        // Filter state for turmas and VIPs
        let currentTurmasFilter = 'todos';
        let currentVipsFilter = 'ativos';
        
        // --- PERMISSION REGISTRY SYSTEM ---
        const PermissionRegistry = {
            sections: {
                'inicio': {
                    label: 'In√≠cio',
                    actions: {
                        'edit_employee_month': { label: 'Pode editar funcion√°rio do m√™s', default: false }
                    }
                },
                'dojo': {
                    label: 'Dojo',
                    actions: {
                        'view_only': { label: 'Apenas visualizar (teacher view)', default: false },
                        'add_competitor': { label: 'Pode adicionar competidor', default: false },
                        'edit_points': { label: 'Pode editar pontos', default: false },
                        'delete_competitor': { label: 'Pode excluir competidor', default: false },
                        'add_active_mission': { label: 'Pode adicionar miss√£o ativa', default: false }
                    }
                },
                'alunos': {
                    label: 'Alunos',
                    actions: {
                        'full_access': { label: 'Acesso total', default: false },
                        'access_no_financials': { label: 'Acesso total, exceto informa√ß√µes financeiras', default: false }
                    }
                },
                'turmas': {
                    label: 'Turmas',
                    actions: {
                        'full_access': { label: 'Acesso total', default: false },
                        'teacher_view_only': { label: 'Se for teacher pode ver apenas as suas turmas e n√£o pode ter o bot√£o de EDITAR', default: false }
                    }
                },
                'vips': {
                    label: 'VIPs',
                    actions: {
                        'full_access': { label: 'Acesso total', default: false },
                        'teacher_view_only': { label: 'Se for teacher pode ver apenas seus VIPs e n√£o pode ter o bot√£o de CONFIGURAR', default: false }
                    }
                },
                'grade': {
                    label: 'Grade',
                    actions: {
                        'full_access': { label: 'Acesso total', default: false },
                        'teacher_own_only': { label: 'Se for teacher ver apenas a sua grade individual', default: false }
                    }
                },
                'calendario': {
                    label: 'Calend√°rio',
                    actions: {
                        'edit_fixed_periods': { label: 'Pode editar per√≠odos fixos', default: false },
                        'add_event': { label: 'Pode adicionar evento no calend√°rio', default: false },
                        'edit_event': { label: 'Pode editar eventos no calend√°rio', default: false },
                        'delete_event': { label: 'Pode excluir evento no calend√°rio', default: false }
                    }
                },
                'links-uteis': {
                    label: 'Links √öteis',
                    actions: {
                        'view_only': { label: 'Apenas visualizar (teacher view)', default: false },
                        'full_access': { label: 'Acesso total', default: false },
                        'add_link': { label: 'Pode adicionar links', default: false },
                        'edit_link': { label: 'Pode editar links', default: false },
                        'delete_link': { label: 'Pode excluir links', default: false }
                    }
                },
                'tasks-prazos': {
                    label: 'Tasks & Prazos',
                    actions: {
                        'view_all': { label: 'Ver todas as tasks', default: true },
                        'complete_own': { label: 'Marcar apenas suas tasks como conclu√≠das', default: true },
                        'complete_all': { label: 'Marcar todas as tasks como conclu√≠das', default: false },
                        'add_task': { label: 'Adicionar tasks', default: false },
                        'edit_task': { label: 'Editar tasks', default: false },
                        'delete_task': { label: 'Excluir tasks', default: false },
                        'add_person': { label: 'Adicionar pessoas/colaboradores', default: false },
                        'edit_person': { label: 'Editar pessoas', default: false },
                        'delete_person': { label: 'Excluir pessoas', default: false }
                    }
                },
                'gestao-tns': {
                    label: 'Gest√£o TNs',
                    actions: {
                        'full_access': { label: 'Acesso total', default: false }
                    }
                },
                'rechamada': {
                    label: 'Rechamada',
                    actions: {
                        'full_access': { label: 'Acesso total', default: false },
                        'teacher_own_students': { label: 'Se for teacher ver apenas seus alunos', default: false }
                    }
                },
                'kpis-pedagogico': {
                    label: 'KPIs pedag√≥gicos',
                    actions: {
                        'full_access': { label: 'Acesso total', default: false }
                    }
                },
                'logs-atividades': {
                    label: 'Logs de Atividades',
                    actions: {
                        'full_access': { label: 'Acesso total', default: false }
                    }
                },
                'colaboradores': {
                    label: 'Colaboradores',
                    actions: {
                        'full_access': { label: 'Acesso total', default: false }
                    }
                },
                'financeiro': {
                    label: 'Financeiro',
                    actions: {
                        'full_access': { label: 'Acesso total', default: false }
                    }
                }
            },
            
            // Presets de permiss√µes por role (templates que preenchem automaticamente)
            presets: {
                'admin': {
                    label: 'Administrador',
                    description: 'Acesso total ao sistema',
                    permissions: {} // Ser√° preenchido automaticamente com todas as permiss√µes
                },
                'teacher': {
                    label: 'Professor',
                    description: 'Acesso √†s suas pr√≥prias turmas, VIPs e grade',
                    permissions: {
                        'dojo.view_only': true,
                        'alunos.access_no_financials': true,
                        'turmas.teacher_view_only': true,
                        'vips.teacher_view_only': true,
                        'grade.teacher_own_only': true,
                        'links-uteis.view_only': true,
                        'tasks-prazos.view_all': true,
                        'rechamada.teacher_own_students': true
                    }
                },
                'pedagogico': {
                    label: 'Pedag√≥gico',
                    description: 'Acesso total pedag√≥gico sem informa√ß√µes financeiras',
                    permissions: {
                        'inicio.edit_employee_month': true,
                        'dojo.add_competitor': true,
                        'dojo.edit_points': true,
                        'dojo.delete_competitor': true,
                        'dojo.add_active_mission': true,
                        'alunos.access_no_financials': true,
                        'turmas.full_access': true,
                        'vips.full_access': true,
                        'grade.full_access': true,
                        'calendario.edit_fixed_periods': true,
                        'calendario.add_event': true,
                        'calendario.edit_event': true,
                        'calendario.delete_event': true,
                        'links-uteis.full_access': true,
                        'tasks-prazos.view_all': true,
                        'tasks-prazos.complete_own': true,
                        'tasks-prazos.complete_all': true,
                        'tasks-prazos.add_task': true,
                        'tasks-prazos.edit_task': true,
                        'tasks-prazos.delete_task': true,
                        'tasks-prazos.add_person': true,
                        'tasks-prazos.edit_person': true,
                        'tasks-prazos.delete_person': true,
                        'gestao-tns.full_access': true,
                        'rechamada.full_access': true,
                        'kpis-pedagogico.full_access': true,
                        'logs-atividades.full_access': true
                    }
                },
                'financeiro': {
                    label: 'Financeiro',
                    description: 'Acesso a todas as informa√ß√µes financeiras',
                    permissions: {
                        'alunos.full_access': true,
                        'turmas.full_access': true,
                        'vips.full_access': true,
                        'financeiro.full_access': true,
                        'tasks-prazos.view_all': true,
                        'tasks-prazos.complete_own': true,
                        'tasks-prazos.complete_all': true,
                        'tasks-prazos.add_task': true,
                        'tasks-prazos.edit_task': true,
                        'tasks-prazos.delete_task': true,
                        'tasks-prazos.add_person': true,
                        'tasks-prazos.edit_person': true,
                        'tasks-prazos.delete_person': true,
                        'kpis-pedagogico.full_access': true,
                        'logs-atividades.full_access': true
                    }
                },
                'ap': {
                    label: 'Assistente Pedag√≥gico',
                    description: 'Suporte pedag√≥gico sem acesso financeiro',
                    permissions: {
                        'alunos.access_no_financials': true,
                        'turmas.full_access': true,
                        'vips.full_access': true,
                        'grade.full_access': true,
                        'calendario.add_event': true,
                        'calendario.edit_event': true,
                        'tasks-prazos.view_all': true,
                        'tasks-prazos.complete_own': true,
                        'tasks-prazos.complete_all': true,
                        'tasks-prazos.add_task': true,
                        'tasks-prazos.edit_task': true,
                        'tasks-prazos.delete_task': true,
                        'tasks-prazos.add_person': true,
                        'tasks-prazos.edit_person': true,
                        'tasks-prazos.delete_person': true,
                        'rechamada.full_access': true,
                        'kpis-pedagogico.full_access': true
                    }
                },
                'am': {
                    label: 'Assistente de Marketing',
                    description: 'Acesso a eventos, calend√°rio e marketing',
                    permissions: {
                        'dojo.view_only': true,
                        'calendario.edit_fixed_periods': true,
                        'calendario.add_event': true,
                        'calendario.edit_event': true,
                        'calendario.delete_event': true,
                        'links-uteis.view_only': true,
                        'tasks-prazos.view_all': true,
                        'tasks-prazos.add_task': true
                    }
                }
            }
        };
        
        // Inicializar permiss√µes do admin (todas = true)
        function initializeAdminPermissions() {
            const adminPerms = {};
            Object.keys(PermissionRegistry.sections).forEach(sectionKey => {
                Object.keys(PermissionRegistry.sections[sectionKey].actions).forEach(actionKey => {
                    adminPerms[`${sectionKey}.${actionKey}`] = true;
                });
            });
            PermissionRegistry.presets.admin.permissions = adminPerms;
            console.log('‚úÖ Admin permissions initialized:', Object.keys(adminPerms).length, 'permissions');
        }
        
        // Executar inicializa√ß√£o
        initializeAdminPermissions();
        
        // Vari√°vel para armazenar colaborador atual
        let currentCollaborator = null;
        
        // Fun√ß√£o helper centralizada para verificar permiss√µes
        function can(permissionKey) {
            // Admin SEMPRE tem acesso total - verifica√ß√£o dupla de seguran√ßa
            if (currentUserRole === 'admin') return true;
            
            // Se n√£o tem colaborador logado, usar fallback baseado em role
            if (!currentCollaborator || !currentCollaborator.permissions) {
                // Usar preset da role se existir
                const preset = PermissionRegistry.presets[currentUserRole];
                if (preset && preset.permissions) {
                    return preset.permissions[permissionKey] === true;
                }
                return false;
            }
            
            // Usar permiss√µes customizadas do colaborador
            return currentCollaborator.permissions[permissionKey] === true;
        }
        
        // Fun√ß√µes helper espec√≠ficas para o novo sistema
        function canEditEmployeeOfMonth() {
            return can('inicio.edit_employee_month');
        }
        
        function canViewStudentFinancials() {
            // Retorna true se tem acesso total OU se tem acesso exceto financeiro = false
            return can('alunos.full_access');
        }
        
        function hasStudentAccessNoFinancials() {
            return can('alunos.access_no_financials');
        }
        

        // --- DEVELOPMENT MODE FUNCTIONS ---
        function startAppInDevelopmentMode() {
            window.isDevelopmentMode = true;
            // Set up basic user data for development
            currentUserName = "Admin SLAP";
            currentUserRole = "admin";
            userId = "demo-user";

            // Set profile picture
            document.getElementById('profile-picture').src = 'https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg';

            // Initialize with demo data
            updateWelcomeMessages(currentUserName);
            showHubView();
            renderInicioSection();
            renderMenu();
        }


        // --- ACTIVITY LOGGING SYSTEM ---
        async function logActivity(action, targetType, targetName, details = {}) {
            if (!db || !currentUserName) return;
            
            try {
                const logData = {
                    action, // 'criar', 'editar', 'deletar', 'finalizar', 'reativar'
                    targetType, // 'aluno', 'turma', 'vip', 'colaborador', 'aula', 'tarefa', etc
                    targetName, // Nome do item afetado
                    userName: currentUserName,
                    userRole: currentUserRole || 'unknown',
                    timestamp: serverTimestamp(),
                    details: details // Objeto com informa√ß√µes adicionais
                };
                
                await addDoc(collection(db, `artifacts/${appId}/public/data/activity-logs`), logData);
            } catch (error) {
                console.error('Erro ao registrar atividade:', error);
            }
        }
        
        // Fun√ß√£o para limpar logs antigos (> 5 dias)
        async function cleanOldActivityLogs() {
            if (!db) return;
            
            try {
                const fiveDaysAgo = new Date();
                fiveDaysAgo.setHours(fiveDaysAgo.getHours() - 120); // 5 dias = 120 horas
                
                const logsRef = collection(db, `artifacts/${appId}/public/data/activity-logs`);
                const oldLogsQuery = query(logsRef, where('timestamp', '<', fiveDaysAgo));
                const snapshot = await getDocs(oldLogsQuery);
                
                const batch = writeBatch(db);
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                console.log(`Limpeza autom√°tica: ${snapshot.docs.length} logs antigos removidos`);
            } catch (error) {
                console.error('Erro ao limpar logs antigos:', error);
            }
        }

        function safeDeleteItem(collection, id, itemName = 'item') {
            
            // Continuar com a opera√ß√£o de deletar
            deleteItem(collection, id);
        }



        // --- FIREBASE INITIALIZATION ---
        async function initializeFirebase() {
            try {
                const firebaseConfig = (typeof __firebase_config !== 'undefined' && __firebase_config)
                    ? JSON.parse(__firebase_config)
                    : (typeof window.firebaseConfig !== 'undefined' ? window.firebaseConfig : {});

                if (!firebaseConfig.apiKey) {
                    console.warn("Configura√ß√£o do Firebase n√£o encontrada. Executando em modo de desenvolvimento local.");
                    // Initialize in development mode with localStorage
                    window.isDevelopmentMode = true;
                    startAppInDevelopmentMode();
                    return;
                }

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user && !user.isAnonymous) {
                        await initializeAppWithUser(user);
                    } else {
                        showLoginView();
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
            }
        }

        async function initializeAppWithUser(user) {
            userId = user.uid;
            const userDocRef = doc(db, "users", userId);
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {
                const userData = userDoc.data();
                currentUserName = userData.name || user.displayName;
                currentUserRole = userData.role;

                if (['admin', 'am', 'ap', 'pedagogico', 'financeiro', 'teacher'].includes(currentUserRole)) {
                    setupFirestoreListeners();
                    // Carregar colaborador e suas permiss√µes
                    await loadCurrentCollaborator();
                    updateWelcomeMessages(currentUserName);
                    showHubView();
                } else {
                    showPendingView();
                }
            } else {
                showPendingView();
            }
        }
        
        // Fun√ß√£o para carregar o colaborador atual e suas permiss√µes
        async function loadCurrentCollaborator() {
            if (!db || !userId) return;
            
            try {
                // Buscar colaborador pelo Firebase UID
                const collaboratorsRef = collection(db, `artifacts/${appId}/public/data/collaborators`);
                const q = query(collaboratorsRef, where('firebaseUid', '==', userId));
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    const collabDoc = snapshot.docs[0];
                    window.currentCollaborator = { id: collabDoc.id, ...collabDoc.data() };
                    console.log('‚úÖ Colaborador carregado:', window.currentCollaborator.name);
                    console.log('üîë Permiss√µes:', window.currentCollaborator.permissions ? 'Customizadas' : 'Usando preset da role');
                    console.log('üìÑ P√°ginas permitidas:', window.currentCollaborator.allowedPages || 'Nenhuma configurada');
                } else {
                    console.log('‚ö†Ô∏è Colaborador n√£o encontrado no banco. Usando preset da role:', currentUserRole);
                    window.currentCollaborator = null;
                }
            } catch (error) {
                console.error('Erro ao carregar colaborador:', error);
                window.currentCollaborator = null;
            }
        }

        // --- FIRESTORE LISTENERS ---
        function setupFirestoreListeners() {
            if (!db || !userId) return;
            allUnsubscribers.forEach(unsub => unsub && unsub());
            allUnsubscribers = [];

            const getCollectionListener = (collectionName, targetArray, renderFunc, q) => {
                const collRef = collection(db, `artifacts/${appId}/public/data/${collectionName}`);
                const finalQuery = q ? q(collRef) : query(collRef);
                const unsubscribe = onSnapshot(finalQuery, (snapshot) => {
                    targetArray.length = 0;
                    snapshot.docs.forEach(doc => targetArray.push({ id: doc.id, ...doc.data() }));

                    const activePageId = contentArea.firstElementChild?.id;
                    if (renderFunc && activePageId) {
                        const pageBaseName = activePageId.replace('-section', '');
                         if (pageBaseName.startsWith(collectionName.slice(0, -1).replace('_', '-').toLowerCase()) || pageBaseName === 'inicio') {
                            renderFunc();
                        }
                    }
                }, (error) => console.error(`Error on ${collectionName} listener:`, error));
                allUnsubscribers.push(unsubscribe);
            };

            getCollectionListener('users', usersData, () => {
                syncFirebaseUsersWithCollaborators();
            });
            getCollectionListener('students', students, () => {
                if (contentArea.firstElementChild?.id === 'alunos-section') {
                    resetPagination();
                    renderAlunosSection();
                }
                if (contentArea.firstElementChild?.id === 'turmas-section') renderTurmasSection();
                if (contentArea.firstElementChild?.id === 'vips-section') renderVipsSection();
            });
            getCollectionListener('turmas', turmas, () => {
                if (contentArea.firstElementChild?.id === 'turmas-section') renderTurmasSection();
            });
            getCollectionListener('vips', vips, () => {
                if (contentArea.firstElementChild?.id === 'vips-section') renderVipsSection();
            });
            getCollectionListener('attendance', attendance, () => {
                const activeModal = document.querySelector('.modal-overlay.visible');
                if (activeModal && activeModal.querySelector('[data-pef-modal="true"]')) {
                    const pefType = activeModal.dataset.pefType;
                    const unitId = activeModal.dataset.unitId;
                    if (pefType === 'turma') {
                        openTurmaPefModal(unitId);
                    } else if (pefType === 'vip') {
                        openVipPefModal(unitId);
                    }
                }
            });
            getCollectionListener('collaborators', collaborators, () => {
                syncFirebaseUsersWithCollaborators();
                const activePageId = contentArea.firstElementChild?.id;
                if (activePageId === 'grade-section') renderGradeSection();
                if (activePageId === 'colaboradores-section') renderColaboradoresSection();
                if (activePageId === 'inicio-section') renderInicioSection();
                
                // Mark collaborators as ready for migration
                if (!migrationDataReady.collaborators) {
                    migrationDataReady.collaborators = true;
                    console.log('‚úÖ Collaborators data loaded for migration');
                    migrateTasksToPersonSystem();
                }
            });
            getCollectionListener('events', events, () => {
                const activePageId = contentArea.firstElementChild?.id;
            });
            getCollectionListener('schedules', schedules, () => {
                 if (contentArea.firstElementChild?.id === 'grade-section') renderGradeSection();
            });
            getCollectionListener('expenses', expenses, () => {
                const activePageId = contentArea.firstElementChild?.id;
                if (activePageId === 'folha-pagamento-section') renderFolhaPagamentoSection();
            });




            getCollectionListener('dojo_ranking', dojoRanking, renderDojoSection);
            getCollectionListener('dojo_missions', dojoMissions, renderDojoSection, (ref) => query(ref, orderBy("points", "desc")));
            
            // Activity logs listener (√∫ltimos 5 dias)
            getCollectionListener('activity-logs', activityLogs, null, (ref) => {
                const fiveDaysAgo = new Date();
                fiveDaysAgo.setHours(fiveDaysAgo.getHours() - 120); // 5 dias = 120 horas
                return query(ref, where('timestamp', '>=', fiveDaysAgo), orderBy('timestamp', 'desc'), limit(500));
            });
            
            // Rechamadas listener
            getCollectionListener('rechamadas', rechamadas);
            
            // Links √öteis listener
            getCollectionListener('links-uteis', linksUteis, renderLinksUteisSection);
            
            // Tasks & Prazos listener
            getCollectionListener('tasks', tasks, () => {
                const activePageId = contentArea.firstElementChild?.id;
                if (activePageId === 'tasks-prazos-section') renderPeopleTasksCards();
                
                // Mark tasks as ready for migration
                if (!migrationDataReady.tasks) {
                    migrationDataReady.tasks = true;
                    console.log('‚úÖ Tasks data loaded for migration');
                    migrateTasksToPersonSystem();
                }
            });
            
            // Task People listener
            getCollectionListener('task-people', taskPeople, () => {
                const activePageId = contentArea.firstElementChild?.id;
                if (activePageId === 'tasks-prazos-section') renderPeopleTasksCards();
                
                // Check for orphaned tasks after data loads
                if (tasks.length > 0 && taskPeople.length > 0) {
                    checkAndFixOrphanedTasks();
                }
            });
            
            // Testes de N√≠vel listener
            getCollectionListener('testes-nivel', testesNivel, () => {
                const activePageId = contentArea.firstElementChild?.id;
                if (activePageId === 'gestao-tns-section') renderTNsList();
            });
            
            // Executar limpeza autom√°tica de logs antigos ao iniciar
            cleanOldActivityLogs();
            
            // Limpar logs antigos a cada 6 horas
            setInterval(cleanOldActivityLogs, 6 * 60 * 60 * 1000);

            
            // Load monthly highlight with real-time updates
            if (db) {
                const highlightRef = doc(db, `artifacts/${appId}/public/data/monthly-highlight`, 'current');
                const unsubscribeHighlight = onSnapshot(highlightRef, (docSnap) => {
                    console.log('Monthly highlight snapshot received:', docSnap.exists());
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        console.log('Monthly highlight data:', data);
                        monthlyHighlight = data;
                        
                        // Re-render if we're on the dashboard
                        const activePageId = contentArea.firstElementChild?.id;
                        if (activePageId === 'inicio-section') {
                            renderMonthlyHighlight();
                        }
                    } else {
                        console.log('No monthly highlight document found');
                    }
                }, (error) => {
                    console.error('Error listening to monthly highlight:', error);
                });
                allUnsubscribers.push(unsubscribeHighlight);
            }
        }

        // --- TASKS MIGRATION TO PERSON-BASED SYSTEM ---
        let isMigrating = false;
        let migrationDataReady = { tasks: false, collaborators: false };
        
        async function migrateTasksToPersonSystem() {
            if (isMigrating || !db) return;
            
            // Check if migration already ran (stored in localStorage)
            const migrationKey = `tasks_migration_${appId}_completed`;
            if (localStorage.getItem(migrationKey) === 'true') {
                console.log('‚úÖ Tasks migration already completed');
                return;
            }
            
            // Wait for both tasks and collaborators to be loaded
            if (!migrationDataReady.tasks || !migrationDataReady.collaborators) {
                console.log('‚è≥ Waiting for tasks and collaborators data to load before migration');
                return;
            }
            
            isMigrating = true;
            console.log('üîÑ Starting tasks migration to person-based system...');
            
            try {
                // Find all tasks with collaboratorId but no personId
                const legacyTasks = tasks.filter(t => t.collaboratorId && !t.personId);
                
                if (legacyTasks.length === 0) {
                    console.log('‚úÖ No legacy tasks to migrate');
                    localStorage.setItem(migrationKey, 'true');
                    isMigrating = false;
                    return;
                }
                
                console.log(`üìã Found ${legacyTasks.length} legacy tasks to migrate`);
                
                // Map to store collaboratorId -> personId mappings
                const collabToPersonMap = new Map();
                
                for (const task of legacyTasks) {
                    const collaboratorId = task.collaboratorId;
                    
                    // Check if we already created a person for this collaborator
                    if (collabToPersonMap.has(collaboratorId)) {
                        // Update task with existing person
                        const personId = collabToPersonMap.get(collaboratorId);
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, task.id), {
                            personId: personId,
                            collaboratorId: deleteField()
                        });
                        console.log(`‚úÖ Migrated task "${task.title}" to person ${personId}`);
                        continue;
                    }
                    
                    // Find the collaborator
                    const collaborator = collaborators.find(c => c.id === collaboratorId);
                    
                    if (collaborator) {
                        // Create a person record for this collaborator
                        const personData = {
                            name: collaborator.name,
                            role: collaborator.role || '',
                            photoUrl: collaborator.photoUrl || '',
                            createdAt: new Date().toISOString(),
                            migratedFromCollaboratorId: collaboratorId, // For reference
                            firebaseUid: collaborator.firebaseUid || null // For secure permission checks
                        };
                        
                        const personRef = await addDoc(collection(db, `artifacts/${appId}/public/data/task-people`), personData);
                        collabToPersonMap.set(collaboratorId, personRef.id);
                        
                        // Update task to use personId
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, task.id), {
                            personId: personRef.id,
                            collaboratorId: deleteField()
                        });
                        
                        console.log(`‚úÖ Migrated collaborator "${collaborator.name}" to person and updated task "${task.title}"`);
                    } else {
                        // Collaborator not found - create "Unknown" person
                        const unknownPersonData = {
                            name: 'Colaborador Desconhecido',
                            role: 'Migrado',
                            photoUrl: '',
                            createdAt: new Date().toISOString(),
                            migratedFromCollaboratorId: collaboratorId,
                            isOrphaned: true
                        };
                        
                        const personRef = await addDoc(collection(db, `artifacts/${appId}/public/data/task-people`), unknownPersonData);
                        collabToPersonMap.set(collaboratorId, personRef.id);
                        
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, task.id), {
                            personId: personRef.id,
                            collaboratorId: deleteField()
                        });
                        
                        console.log(`‚ö†Ô∏è Migrated orphaned task "${task.title}" to "Unknown" person`);
                    }
                }
                
                console.log(`‚úÖ Migration completed! Migrated ${legacyTasks.length} tasks to ${collabToPersonMap.size} people`);
                localStorage.setItem(migrationKey, 'true');
                await logActivity('Sistema migrou tasks antigas para o novo formato', 'system', `${legacyTasks.length} tasks migradas`);
                
            } catch (error) {
                console.error('‚ùå Error during migration:', error);
            } finally {
                isMigrating = false;
            }
        }

        // --- ORPHANED TASKS SAFEGUARD ---
        async function checkAndFixOrphanedTasks() {
            if (!db || tasks.length === 0 || taskPeople.length === 0) return;
            
            const orphanedTasks = tasks.filter(task => {
                // Task has personId but person doesn't exist
                return task.personId && !taskPeople.find(p => p.id === task.personId);
            });
            
            if (orphanedTasks.length === 0) {
                return;
            }
            
            console.log(`‚ö†Ô∏è Found ${orphanedTasks.length} orphaned tasks (personId points to non-existent person)`);
            
            // Create a single "Unknown Person" record for all orphaned tasks
            let unknownPersonId = taskPeople.find(p => p.isOrphaned === true)?.id;
            
            if (!unknownPersonId) {
                const unknownPersonData = {
                    name: 'Pessoa Desconhecida',
                    role: 'Tasks √ìrf√£s',
                    photoUrl: '',
                    createdAt: new Date().toISOString(),
                    isOrphaned: true
                };
                
                try {
                    const personRef = await addDoc(collection(db, `artifacts/${appId}/public/data/task-people`), unknownPersonData);
                    unknownPersonId = personRef.id;
                    console.log('‚úÖ Created "Unknown Person" record for orphaned tasks');
                } catch (error) {
                    console.error('Error creating unknown person:', error);
                    return;
                }
            }
            
            // Reassign all orphaned tasks to the unknown person
            for (const task of orphanedTasks) {
                try {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, task.id), {
                        personId: unknownPersonId
                    });
                    console.log(`‚úÖ Reassigned orphaned task "${task.title}" to Unknown Person`);
                } catch (error) {
                    console.error(`Error reassigning task ${task.id}:`, error);
                }
            }
            
            await logActivity('Sistema corrigiu tasks √≥rf√£s', 'system', `${orphanedTasks.length} tasks atribu√≠das para Pessoa Desconhecida`);
        }

        // --- FIREBASE USERS SYNC ---
        let isSyncing = false;
        async function syncFirebaseUsersWithCollaborators(forceSync = false) {
            // Evitar m√∫ltiplas sincroniza√ß√µes simult√¢neas (exceto se for√ßada)
            if (!forceSync && isSyncing) return;
            if (!db || !usersData || !collaborators) {
                console.warn('Sincroniza√ß√£o adiada: dados ainda n√£o carregados');
                return;
            }
            if (usersData.length === 0) {
                console.warn('Sincroniza√ß√£o adiada: nenhum usu√°rio Firebase encontrado');
                return;
            }
            
            isSyncing = true;
            let syncCount = 0;
            
            try {
                // Para cada usu√°rio Firebase, verificar se existe colaborador correspondente
                for (const user of usersData) {
                    const hasCollaborator = collaborators.some(c => c.firebaseUid === user.id);
                    
                    if (!hasCollaborator) {
                        // Criar colaborador automaticamente para esse usu√°rio Firebase
                        const collaboratorData = {
                            name: user.name || user.email || 'Usu√°rio sem nome',
                            email: user.email || '',
                            role: user.role || 'teacher',
                            allowedPages: [],
                            firebaseUid: user.id,
                            cpf: '',
                            birthdate: '',
                            address: '',
                            photoUrl: '',
                            createdAt: new Date()
                        };
                        
                        console.log('Sincronizando usu√°rio Firebase com colaboradores:', collaboratorData.name);
                        
                        await addDoc(collection(db, `artifacts/${appId}/public/data/collaborators`), collaboratorData);
                        syncCount++;
                    }
                }
                
                if (syncCount > 0) {
                    console.log(`Sincroniza√ß√£o completa: ${syncCount} colaborador(es) adicionado(s)`);
                } else {
                    console.log('Sincroniza√ß√£o completa: todos os usu√°rios j√° possuem colaboradores');
                }
            } catch (error) {
                console.error('Erro ao sincronizar usu√°rios Firebase:', error);
                throw error; // Propagar erro para o bot√£o de sincroniza√ß√£o mostrar mensagem
            } finally {
                isSyncing = false;
            }
        }

        // --- AUTH, VIEW, and MENU FUNCTIONS ---
        function showLoginView() {
            hubView.classList.add('hidden');
            pendingView.classList.add('hidden');
            pendingView.classList.remove('flex');
            loginView.classList.remove('hidden');
            loginView.classList.add('flex');
            loginView.innerHTML = `
                <div class="w-full max-w-md p-8 space-y-8 bg-white rounded-xl shadow-lg">
                    <div class="text-center">
                        <img src="https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg" alt="Logo SLAP" class="w-24 h-auto mx-auto rounded-lg mb-4">
                        <h2 class="text-2xl font-bold text-stone-900">Acesse sua conta</h2>
                        <p class="mt-2 text-sm text-stone-600">Bem-vindo(a) de volta!</p>
                    </div>
                    <form id="login-form" class="mt-8 space-y-6">
                        <div>
                            <label for="login-email" class="sr-only">E-mail</label>
                            <input id="login-email" name="email" type="email" autocomplete="email" required class="form-input" placeholder="Endere√ßo de e-mail">
                        </div>
                        <div>
                            <label for="login-password" class="sr-only">Senha</label>
                            <input id="login-password" name="password" type="password" autocomplete="current-password" required class="form-input" placeholder="Senha">
                        </div>
                        <p id="login-error" class="text-sm text-red-600 text-center"></p>
                        <div>
                            <button type="submit" class="primary-btn full-width">Entrar</button>
                        </div>
                    </form>
                    <p class="text-sm text-center text-stone-600">
                        N√£o tem uma conta?
                        <button data-action="open-signup" class="font-medium" style="color: #F1D24B;">Cadastre-se</button>
                    </p>
                </div>
            `;
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        }

        function showHubView() { 
            loginView.classList.add('hidden');
            loginView.classList.remove('flex');
            pendingView.classList.add('hidden');
            pendingView.classList.remove('flex');
            hubView.classList.remove('hidden'); 
            const firstName = (currentUserName || '').split(' ')[0];
            document.getElementById('welcome-message').textContent = `Bem-vindo(a), ${firstName}`;
            renderMenu(); 
            
            // FORCE dashboard load and prevent interference from Firebase listeners
            setTimeout(() => {
                renderInicioSection(); 
                setActiveNavItem(document.querySelector('[data-target="inicio"]')); 
            }, 50);
            
            // Additional safeguard - force dashboard after Firebase data loads
            setTimeout(() => {
                renderInicioSection(); 
                setActiveNavItem(document.querySelector('[data-target="inicio"]')); 
            }, 500);
        }
        function showPendingView() { 
            hubView.classList.add('hidden'); 
            loginView.classList.add('hidden');
            loginView.classList.remove('flex');
            pendingView.classList.remove('hidden'); 
            pendingView.classList.add('flex');
        }
        function setActiveNavItem(element) {
            document.querySelectorAll('#main-navigation .nav-item').forEach(item => {
                item.classList.remove('active');
                item.style.backgroundColor = '';
                item.style.color = '';
            }); 
            if (element) {
                element.classList.add('active');
                element.style.backgroundColor = '#FFFBEB';
                element.style.color = '#F1D24B';
            }
        }
        async function handleLogin(event) {
            event.preventDefault();
            const email = event.target.email.value;
            const password = event.target.password.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                const errorElement = document.getElementById('login-error');
                if(errorElement) errorElement.textContent = "E-mail ou senha inv√°lidos.";
            }
        }
        async function handleSignUp(event) { event.preventDefault(); const name = event.target.name.value; const email = event.target.email.value; const password = event.target.password.value; try { const cred = await createUserWithEmailAndPassword(auth, email, password); await updateProfile(cred.user, { displayName: name }); await setDoc(doc(db, "users", cred.user.uid), { name, email, role: "pending", createdAt: serverTimestamp() }); await signOut(auth); showSuccessMessage("Cadastro Conclu√≠do!", "Sua conta foi criada. Aguarde aprova√ß√£o de um administrador para acessar."); } catch (error) { showErrorMessage("Erro", "Erro ao criar conta. Verifique o e-mail e a senha."); } }
        async function handleLogout() { 
            await signOut(auth);
        }

        // --- LOCATION TOGGLE FUNCTION ---
        function toggleLocationFields() {
            const foraBrasilCheckbox = document.getElementById('aluno-fora-brasil');
            const estadoSelect = document.getElementById('aluno-estado');
            const continenteSelect = document.getElementById('aluno-continente');
            const locationLabel = document.getElementById('location-label');
            
            if (foraBrasilCheckbox.checked) {
                estadoSelect.style.display = 'none';
                continenteSelect.style.display = 'block';
                locationLabel.textContent = 'Continente';
                estadoSelect.value = ''; // Clear estado value
            } else {
                estadoSelect.style.display = 'block';
                continenteSelect.style.display = 'none';
                locationLabel.textContent = 'Estado';
                continenteSelect.value = ''; // Clear continente value
            }
        }

        // Initialize location fields when modal opens
        window.initializeLocationFields = function() {
            const foraBrasilCheckbox = document.getElementById('aluno-fora-brasil');
            if (foraBrasilCheckbox) {
                toggleLocationFields();
            }
        };

        // --- CONTENT RENDERING ---
        function renderInicioSection() {
            document.getElementById('main-title').textContent = 'Dashboard';
            document.getElementById('main-description').textContent = 'Vis√£o geral das suas atividades e da equipe.';

            // Calculate statistics based on user role
            const isTeacher = currentUserRole === 'teacher';
            const totalStudents = students.length;
            const activeStudents = students.filter(s => s.status === 'Ativo').length;
            const totalTurmas = turmas.length;
            const totalRevenue = students.reduce((sum, s) => sum + (parseFloat(s.amountReceived || s.amountPaid) || 0), 0);

            // Check if user can see financial information
            const canViewFinancialInfo = canViewStudentFinancials();

            contentArea.innerHTML = `
                <div id="inicio-section" class="space-y-6">
                    <!-- Employee Highlight and Top 3 Dojo Section -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Fortune Cookie Section - Compact -->
                        <div class="bg-gray-800 p-4 rounded-lg shadow-sm border border-gray-600">
                            <div class="mb-3">
                                <h4 class="text-base font-semibold text-white">ü•† Biscoito da Sorte</h4>
                            </div>
                            <div id="fortune-cookie-content" class="text-sm">
                                <!-- Fortune cookie content will be rendered here -->
                            </div>
                        </div>

                        <!-- Top 3 Dojo Section -->
                        <div class="bg-white p-4 rounded-lg shadow-sm border border-stone-200">
                            <h4 class="text-base font-semibold text-stone-800 mb-3">Top 3 Dojo</h4>
                            <div class="space-y-2">
                                ${getTop3DojoRanking().map((item, index) => `
                                    <div class="flex items-center justify-between p-2 rounded-lg" style="background-color: ${
                                        index === 0 ? '#F1D24B20' : 
                                        index === 1 ? '#84C7DF20' : 
                                        '#FF5C3D20'
                                    }">
                                        <div class="flex items-center space-x-2">
                                            <span class="text-lg font-bold" style="color: ${
                                                index === 0 ? '#F1D24B' : 
                                                index === 1 ? '#84C7DF' : 
                                                '#FF5C3D'
                                            }">${
                                                index === 0 ? 
                                                    `<svg class="inline-block w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <circle cx="12" cy="8" r="6" fill="#FFD700" stroke="#DAA520" stroke-width="2"/>
                                                        <rect x="10" y="14" width="4" height="8" fill="#DAA520"/>
                                                        <text x="12" y="10" text-anchor="middle" fill="#DAA520" font-size="8" font-weight="bold">1</text>
                                                    </svg>` : 
                                                index === 1 ? 
                                                    `<svg class="inline-block w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <circle cx="12" cy="8" r="6" fill="#C0C0C0" stroke="#A8A8A8" stroke-width="2"/>
                                                        <rect x="10" y="14" width="4" height="8" fill="#A8A8A8"/>
                                                        <text x="12" y="10" text-anchor="middle" fill="#666666" font-size="8" font-weight="bold">2</text>
                                                    </svg>` : 
                                                    `<svg class="inline-block w-5 h-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <circle cx="12" cy="8" r="6" fill="#CD7F32" stroke="#8B4513" stroke-width="2"/>
                                                        <rect x="10" y="14" width="4" height="8" fill="#8B4513"/>
                                                        <text x="12" y="10" text-anchor="middle" fill="#654321" font-size="8" font-weight="bold">3</text>
                                                    </svg>`
                                            }</span>
                                            <span class="font-medium text-stone-700">${item.name}</span>
                                        </div>
                                        <span class="text-sm font-semibold text-stone-700">${item.points || 0} pts</span>
                                    </div>
                                `).join('')}
                                ${getTop3DojoRanking().length === 0 ? '<p class="text-sm text-stone-500 text-center py-4">Ainda n√£o h√° ranking</p>' : ''}
                            </div>
                        </div>
                    </div>



                    <!-- Teacher-specific Weekly Schedule Preview -->
                    ${isTeacher ? `
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-stone-800">Minha Grade da Semana</h3>
                            <button class="text-sm font-medium hover:underline nav-item" style="color: #F1D24B;" data-target="grade">Ver grade completa ‚Üí</button>
                        </div>
                        <div class="grid grid-cols-5 gap-3">
                            ${["Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta"].map(day => `
                                <div class="text-center">
                                    <p class="text-sm font-semibold text-stone-700 mb-3">${day.substring(0, 3)}</p>
                                    <div class="space-y-2">
                                        ${getTeacherDaySchedule(day, currentUserName).slice(0, 2).map(schedule => `
                                            <div class="text-xs p-2 rounded-lg shadow-sm border" style="background-color: #F1D24B20; border-color: #F1D24B30; color: #8B6914;">
                                                <div class="font-medium">${schedule.startTime}</div>
                                                <div class="text-stone-600">${schedule.student}</div>
                                            </div>
                                        `).join('')}
                                        ${getTeacherDaySchedule(day, currentUserName).length > 2 ? `<div class="text-xs text-stone-500 font-medium">+${getTeacherDaySchedule(day, currentUserName).length - 2}</div>` : ''}
                                        ${getTeacherDaySchedule(day, currentUserName).length === 0 ? '<div class="text-xs text-stone-400 p-2 bg-stone-50 rounded-lg border border-stone-200">Livre</div>' : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>` : ''}

                    <!-- Redes SLAP & Destaque do M√™s -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Redes SLAP -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                            <h4 class="text-lg font-bold text-black mb-4">Redes SLAP</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <a href="https://instagram.com/speakinglikeapro" target="_blank" class="p-3 rounded-lg text-center transition-colors text-black" style="background-color: #F1D24B;">
                                    <svg class="w-6 h-6 mx-auto mb-1" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                                    </svg>
                                    <p class="text-xs font-medium">Instagram</p>
                                </a>
                                <a href="https://youtube.com/@speakinglikeapro" target="_blank" class="p-3 rounded-lg text-center transition-colors text-black" style="background-color: #F1D24B;">
                                    <svg class="w-6 h-6 mx-auto mb-1" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                                    </svg>
                                    <p class="text-xs font-medium">YouTube</p>
                                </a>
                                <a href="https://tiktok.com/@speakinglikeapro" target="_blank" class="p-3 rounded-lg text-center transition-colors text-black" style="background-color: #F1D24B;">
                                    <svg class="w-6 h-6 mx-auto mb-1" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z"/>
                                    </svg>
                                    <p class="text-xs font-medium">TikTok</p>
                                </a>
                                <a href="https://linkedin.com/company/speaking-like-a-pro" target="_blank" class="p-3 rounded-lg text-center transition-colors text-black" style="background-color: #F1D24B;">
                                    <svg class="w-6 h-6 mx-auto mb-1" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                    </svg>
                                    <p class="text-xs font-medium">LinkedIn</p>
                                </a>
                            </div>
                        </div>

                        <!-- Destaque do M√™s -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-lg font-bold text-stone-800">Destaque do M√™s</h4>
                                ${currentUserRole === 'admin' ? `
                                    <button class="text-sm" style="color: #F1D24B;" data-action="edit-monthly-highlight">
                                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                        Editar
                                    </button>
                                ` : ''}
                            </div>
                            <div id="monthly-highlight-content">
                                <!-- Monthly highlight content will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Initialize monthly highlight and fortune cookie
            renderMonthlyHighlight();
            renderFortuneCookie();
        }

        // Monthly Highlight functions
        function renderMonthlyHighlight() {
            const content = document.getElementById('monthly-highlight-content');
            if (!content) return;

            content.innerHTML = `
                <div class="flex items-center space-x-4">
                    <img src="${monthlyHighlight.photo}" alt="${monthlyHighlight.name}" class="w-16 h-16 rounded-full object-cover border-2 border-stone-200">
                    <div class="flex-1">
                        <h5 class="font-semibold text-stone-800 text-lg">${monthlyHighlight.name}</h5>
                        <p class="text-sm text-stone-600 mt-1 leading-relaxed">${monthlyHighlight.description}</p>
                        ${monthlyHighlight.award ? `<div class="mt-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium" style="background-color: #F1D24B20; color: #B45309;">
                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                            ${monthlyHighlight.award}
                        </div>` : ''}
                    </div>
                </div>
            `;
        }

        function openMonthlyHighlightForm() {
            clearModalHeaderButtons();
            document.getElementById('form-modal-title').textContent = "Editar Destaque do M√™s";
            
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="monthly-highlight-form" class="space-y-4">
                    <div>
                        <label class="font-medium text-sm">Nome do Funcion√°rio</label>
                        <input type="text" id="highlight-name" class="form-input" required value="${monthlyHighlight.name}">
                    </div>
                    
                    <div>
                        <label class="font-medium text-sm">Link da Foto (Cloudinary)</label>
                        <input type="url" id="highlight-photo" class="form-input" required value="${monthlyHighlight.photo}" placeholder="https://res.cloudinary.com/...">
                    </div>
                    
                    <div>
                        <label class="font-medium text-sm">Descri√ß√£o</label>
                        <textarea id="highlight-description" class="form-input" rows="4" required placeholder="Descreva os motivos do destaque...">${monthlyHighlight.description}</textarea>
                    </div>
                    
                    <div>
                        <label class="font-medium text-sm">Premia√ß√£o (Opcional)</label>
                        <input type="text" id="highlight-award" class="form-input" value="${monthlyHighlight.award || ''}" placeholder="Ex: Voucher de R$ 200, Dia de folga, etc.">
                    </div>
                    
                    <div class="flex justify-end gap-2">
                        <button type="button" data-action="close-modal" class="secondary-btn">Cancelar</button>
                        <button type="submit" class="primary-btn w-auto">Salvar Destaque</button>
                    </div>
                </form>
            `;

            document.getElementById('monthly-highlight-form').onsubmit = saveMonthlyHighlight;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveMonthlyHighlight(event) {
            event.preventDefault();
            
            const data = {
                name: document.getElementById('highlight-name').value,
                photo: document.getElementById('highlight-photo').value,
                description: document.getElementById('highlight-description').value,
                award: document.getElementById('highlight-award').value
            };

            if (!data.name || !data.photo || !data.description) {
                showErrorMessage("Erro", "Todos os campos s√£o obrigat√≥rios.");
                return;
            }

            try {
                if (!db) {
                    // Development mode - update local variable only
                    console.log('Development mode: updating local monthly highlight');
                    monthlyHighlight = data;
                    renderMonthlyHighlight();
                    document.getElementById('form-modal').classList.remove('visible');
                    showSuccessMessage("Sucesso!", "Destaque do m√™s atualizado localmente (modo desenvolvimento).");
                    return;
                }

                console.log('Saving monthly highlight to Firebase:', data);
                const highlightRef = doc(db, `artifacts/${appId}/public/data/monthly-highlight`, 'current');
                
                // Add timestamp for better tracking
                const dataWithTimestamp = {
                    ...data,
                    updatedAt: serverTimestamp(),
                    updatedBy: currentUserName || 'Admin'
                };
                
                await setDoc(highlightRef, dataWithTimestamp);
                console.log('Monthly highlight saved successfully to Firebase');
                
                document.getElementById('form-modal').classList.remove('visible');
                showSuccessMessage("Sucesso!", "Destaque do m√™s atualizado para todos os usu√°rios!");
                
                // Note: renderMonthlyHighlight will be called automatically by the onSnapshot listener
            } catch (error) {
                console.error("Error saving monthly highlight:", error);
                showErrorMessage("Erro", "Erro ao salvar destaque: " + error.message);
            }
        }













        // Dashboard helper functions
        function getPendingTasks() {
            return tasks.filter(task => !task.completed);
        }

        function getUpcomingEvents() {
            const today = new Date();
            const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            return events.filter(event => {
                const eventDate = new Date(event.dataEvento + 'T00:00:00');
                return eventDate >= today && eventDate <= nextWeek;
            }).sort((a, b) => new Date(a.dataEvento) - new Date(b.dataEvento));
        }

        function getTeacherDaySchedule(day, teacherName) {
            const actualTeacherName = findTeacherByName(teacherName) || teacherName;
            const normalizedTeacherName = normalizeTeacherName(actualTeacherName);
            // ROBUST FILTERING: Use normalized comparison
            return schedules.filter(s => {
                if (s.day !== day || s.type === 'break') return false;
                const normalizedScheduleTeacher = normalizeTeacherName(s.teacher || '');
                return normalizedScheduleTeacher === normalizedTeacherName;
            }).sort((a, b) => a.startTime.localeCompare(b.startTime));
        }

        function getNewStudentsThisMonth() {
            const now = new Date();
            const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            return students.filter(student => {
                if (!student.createdAt) return false;
                const createdDate = new Date(student.createdAt);
                return createdDate >= firstDayOfMonth;
            }).length;
        }

        function getCancellationsThisMonth() {
            const now = new Date();
            const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            return cancellations.filter(cancellation => {
                const cancellationDate = new Date(cancellation.cancellationDate + 'T00:00:00');
                return cancellationDate >= firstDayOfMonth;
            }).length;
        }

        function getCompletedTasksThisWeek() {
            const now = new Date();
            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
            return tasks.filter(task => {
                if (!task.completed || !task.completedAt) return false;
                const completedDate = new Date(task.completedAt);
                return completedDate >= weekStart;
            }).length;
        }

        function getTotalTeachingHours() {
            return schedules.filter(s => s.type !== 'break').length;
        }

        function getTop3DojoRanking() {
            return dojoRanking.sort((a, b) => b.points - a.points).slice(0, 3);
        }

        function getCurrentMonthName() {
            const months = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            return months[new Date().getMonth()];
        }

        function getCurrentDayName() {
            const days = ['Domingo', 'Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 
                         'Quinta-feira', 'Sexta-feira', 'S√°bado'];
            return days[new Date().getDay()];
        }

        function initializeChart() {
            const ctx = document.getElementById('studentsChart');
            if (!ctx) return;

            const statusCounts = students.reduce((acc, student) => {
                const status = student.status || 'Pendente';
                acc[status] = (acc[status] || 0) + 1;
                return acc;
            }, {});

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: [
                            '#10B981', // Green for Ativo
                            '#EF4444', // Red for Cancelado
                            '#F59E0B', // Yellow for Pendente
                            '#8B5CF6', // Purple for others
                            '#06B6D4'  // Cyan for others
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderAlunosSection() {
            document.getElementById('main-title').textContent = 'Gest√£o de Alunos';
            document.getElementById('main-description').textContent = 'Cadastre e gerencie todos os alunos da escola.';
            const canAdd = ['admin', 'financeiro', 'pedagogico', 'ap'].includes(currentUserRole);
            const canViewFinancialInfo = canViewStudentFinancials();

            const totalCount = students.length;
            const activeCount = students.filter(s => s.status === 'Ativo').length;
            const pendingCount = students.filter(s => s.status === 'Pendente').length;
            const canceledCount = students.filter(s => s.status === 'Cancelado').length;
            const vipCount = students.filter(s => s.modalidade === 'VIP' || s.modalidade === 'DUPLA').length;
            const turmaCount = students.filter(s => s.modalidade === 'TURMA').length;
            const totalRevenue = students.reduce((sum, student) => {
                return sum + parseFloat(student.amountReceived || student.amountPaid || 0);
            }, 0);
            
            // Calcular ticket m√©dio mensal
            const studentsWithPayment = students.filter(s => parseFloat(s.amountPaid || 0) > 0);
            const totalPayments = studentsWithPayment.reduce((sum, student) => {
                return sum + parseFloat(student.amountPaid || 0);
            }, 0);
            const averageTicket = studentsWithPayment.length > 0 ? totalPayments / studentsWithPayment.length : 0;

            contentArea.innerHTML = `
                <section id="alunos-section" class="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-6">
                        <div class="bg-gradient-to-br from-stone-50 to-stone-100 p-6 rounded-lg border border-stone-200" id="stat-card-total-alunos">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-stone-700 uppercase tracking-wide">Total de Alunos</h3>
                                <div class="flex gap-2 items-center">
                                    <button onclick="toggleCardVisibility('stat-card-total-alunos')" class="text-stone-400 hover:text-stone-600 transition-colors p-1" title="Ocultar/Mostrar informa√ß√µes">
                                        <svg class="w-4 h-4 eye-icon-open" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                        <svg class="w-4 h-4 eye-icon-closed hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                                        </svg>
                                    </button>
                                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-4xl font-bold text-stone-800 card-content">${totalCount}</p>
                            <p class="text-xs text-stone-600 mt-1">Total cadastrado</p>
                        </div>
                        <div class="bg-gradient-to-br from-stone-50 to-stone-100 p-6 rounded-lg border border-stone-200" id="stat-card-alunos-ativos">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-stone-700 uppercase tracking-wide">Alunos Ativos</h3>
                                <div class="flex gap-2 items-center">
                                    <button onclick="toggleCardVisibility('stat-card-alunos-ativos')" class="text-stone-400 hover:text-stone-600 transition-colors p-1" title="Ocultar/Mostrar informa√ß√µes">
                                        <svg class="w-4 h-4 eye-icon-open" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                        <svg class="w-4 h-4 eye-icon-closed hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                                        </svg>
                                    </button>
                                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-4xl font-bold text-stone-800 card-content">${activeCount}</p>
                            <p class="text-xs text-stone-600 mt-1">Estudando atualmente</p>
                        </div>
                        <div class="bg-gradient-to-br from-stone-50 to-stone-100 p-6 rounded-lg border border-stone-200" id="stat-card-alunos-pendentes">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-stone-700 uppercase tracking-wide">Alunos Pendentes</h3>
                                <div class="flex gap-2 items-center">
                                    <button onclick="toggleCardVisibility('stat-card-alunos-pendentes')" class="text-stone-400 hover:text-stone-600 transition-colors p-1" title="Ocultar/Mostrar informa√ß√µes">
                                        <svg class="w-4 h-4 eye-icon-open" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                        <svg class="w-4 h-4 eye-icon-closed hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                                        </svg>
                                    </button>
                                    <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-4xl font-bold text-stone-800 card-content">${pendingCount}</p>
                            <p class="text-xs text-stone-600 mt-1">Aguardando in√≠cio</p>
                        </div>
                        <div class="bg-gradient-to-br from-stone-50 to-stone-100 p-6 rounded-lg border border-stone-200" id="stat-card-alunos-cancelados">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-stone-700 uppercase tracking-wide">Alunos Cancelados</h3>
                                <div class="flex gap-2 items-center">
                                    <button onclick="toggleCardVisibility('stat-card-alunos-cancelados')" class="text-stone-400 hover:text-stone-600 transition-colors p-1" title="Ocultar/Mostrar informa√ß√µes">
                                        <svg class="w-4 h-4 eye-icon-open" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                        </svg>
                                        <svg class="w-4 h-4 eye-icon-closed hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                                        </svg>
                                    </button>
                                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                            </div>
                            <p class="text-4xl font-bold text-stone-800 card-content">${canceledCount}</p>
                            <p class="text-xs text-stone-600 mt-1">Contratos cancelados</p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <input type="search" id="aluno-search" placeholder="Pesquisar por nome..." class="form-input w-full sm:w-1/2">
                    </div>

                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                        <div class="flex gap-2 flex-wrap" id="alunos-filter-buttons">
                            <button class="secondary-btn filter-btn active" data-filter="todos">Todos</button>
                            <button class="secondary-btn filter-btn" data-filter="ativo">Ativos</button>
                            <button class="secondary-btn filter-btn" data-filter="pendente">Pendentes</button>
                            <button class="secondary-btn filter-btn" data-filter="cancelado">Cancelados</button>
                            <button class="secondary-btn filter-btn" data-filter="ficha-incompleta" style="background-color: #FEF3C7; color: #92400E; font-weight: 600;">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                Ficha Incompleta
                            </button>
                        </div>
                        <div class="flex gap-2">
                            <button class="secondary-btn w-auto" data-action="export-alunos-doc">Exportar Documento</button>
                            ${canAdd ? `<button class="primary-btn w-auto" data-action="add-aluno">+ Adicionar Aluno</button>` : ''}
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table" id="alunos-table">
                            <thead>
                                <tr>
                                    <th>Nome do Aluno</th>
                                    <th>Status</th>
                                    <th>Ficha</th>
                                    ${canViewFinancialInfo ? '<th>Valor Pago</th>' : ''}
                                    ${canViewFinancialInfo ? '<th>Valor Recebido</th>' : '<th>Respons√°vel</th>'}
                                </tr>
                            </thead>
                            <tbody id="alunos-list"></tbody>
                        </table>
                    </div>

                    <!-- Controles de Pagina√ß√£o -->
                    <div id="pagination-controls" class="flex justify-between items-center mt-6 pt-4 border-t border-stone-200">
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-stone-600">Itens por p√°gina:</label>
                            <select id="items-per-page" class="form-input !py-1 !px-2 w-20">
                                <option value="10">10</option>
                                <option value="20" selected>20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>

                        <div id="pagination-info" class="text-sm text-stone-600"></div>

                        <div class="flex gap-1">
                            <button id="prev-page" class="secondary-btn !py-1 !px-3 disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                </svg>
                            </button>
                            <div id="page-numbers" class="flex gap-1"></div>
                            <button id="next-page" class="secondary-btn !py-1 !px-3 disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </section>
            `;

            const searchInput = document.getElementById('aluno-search');
            const filterButtons = document.querySelectorAll('#alunos-filter-buttons .filter-btn');

            const performUpdate = () => {
                const currentFilter = document.querySelector('#alunos-filter-buttons .filter-btn.active').dataset.filter;
                updateAlunosList(currentFilter);
            };

            searchInput.addEventListener('input', performUpdate);
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    performUpdate();
                });
            });

            // Configurar pagina√ß√£o
            const itemsPerPageSelect = document.getElementById('items-per-page');
            const prevPageBtn = document.getElementById('prev-page');
            const nextPageBtn = document.getElementById('next-page');

            itemsPerPageSelect.addEventListener('change', () => {
                itemsPerPage = parseInt(itemsPerPageSelect.value);
                currentPage = 1;
                performUpdate();
            });

            prevPageBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    performUpdate();
                }
            });

            nextPageBtn.addEventListener('click', () => {
                const totalItems = getFilteredStudents().length;
                const totalPages = Math.ceil(totalItems / itemsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    performUpdate();
                }
            });

            updateAlunosList('todos');
        }

        // Fun√ß√£o para verificar se a ficha do aluno est√° completa
        function checkStudentProfileCompleteness(student) {
            const missing = [];
            const canViewFinancialInfo = canViewStudentFinancials();
            const isActiveStudent = student.status === 'Ativo' || student.status === 'Pendente';
            
            // Informa√ß√µes Pessoais
            if (!student.birthDate) missing.push('Data de Nascimento');
            if (!student.gender) missing.push('G√™nero');
            if (!student.cpf) missing.push('CPF');
            if (!student.endereco) missing.push('Endere√ßo');
            if (!student.estadoCivil) missing.push('Estado Civil');
            
            // Informa√ß√µes Pedag√≥gicas (apenas para alunos ativos ou pendentes)
            if (isActiveStudent && !student.currentLevel) missing.push('N√≠vel Atual');
            // N√£o exigimos n√≠veis cursados pois alunos iniciantes n√£o t√™m hist√≥rico
            
            // Informa√ß√µes Financeiras (apenas se o usu√°rio tem permiss√£o para ver E aluno est√° ativo/pendente)
            if (canViewFinancialInfo && isActiveStudent) {
                if (!student.paymentType) missing.push('Forma de Pagamento');
                // S√≥ exigir valor pago se N√ÉO for bolsista ou permuta
                if (student.paymentType !== 'Bolsa' && student.paymentType !== 'Permuta' && (!student.amountPaid || parseFloat(student.amountPaid) === 0)) {
                    missing.push('Valor Pago');
                }
            }
            
            // Informa√ß√µes do Respons√°vel (se for menor)
            if (student.isMinor) {
                if (!student.responsibleName) missing.push('Nome do Respons√°vel');
                if (!student.responsiblePhone) missing.push('Telefone do Respons√°vel');
            }
            
            return {
                isComplete: missing.length === 0,
                missing: missing
            };
        }

        function getFilteredStudents() {
            const filter = document.querySelector('#alunos-filter-buttons .filter-btn.active')?.dataset.filter || 'todos';
            const searchTerm = document.getElementById('aluno-search')?.value.toLowerCase() || '';

            let filteredStudents = students;
            if (filter === 'ficha-incompleta') {
                // Filtrar apenas alunos com ficha incompleta
                filteredStudents = students.filter(s => !checkStudentProfileCompleteness(s).isComplete);
            } else if (filter !== 'todos') {
                filteredStudents = students.filter(s => s.status && s.status.toLowerCase() === filter);
            }

            if (searchTerm) {
                filteredStudents = filteredStudents.filter(s => s.name.toLowerCase().includes(searchTerm));
            }

            return filteredStudents.sort((a, b) => a.name.localeCompare(b.name));
        }

        function getFilteredTurmas() {
            const searchTerm = document.getElementById('turma-search')?.value.toLowerCase() || '';
            const teacherFilter = document.getElementById('turma-teacher-filter')?.value || '';
            const statusFilter = currentTurmasFilter;
            let filteredTurmas = turmas;

            if (currentUserRole === 'teacher') {
                // Find the teacher's name in collaborators to ensure correct mapping
                const teacherCollaborator = collaborators.find(c => 
                    c.sectors && c.sectors.includes('professor') && 
                    (c.name === currentUserName || c.email === currentUserName || c.id === userId)
                );
                const originalTeacherName = teacherCollaborator ? teacherCollaborator.name : currentUserName;
                
                // Use smart name matching to find the actual teacher name in turmas
                const teacherNames = [...new Set(turmas.map(t => t.teacherName))];
                const exactMatch = teacherNames.find(name => name === originalTeacherName);
                let teacherNameToFilter = exactMatch;
                
                if (!exactMatch && originalTeacherName) {
                    // Try first name matching
                    const searchFirstName = originalTeacherName.trim().split(' ')[0].toLowerCase();
                    const firstNameMatch = teacherNames.find(name => {
                        const nameFirstName = name.trim().split(' ')[0].toLowerCase();
                        return nameFirstName === searchFirstName;
                    });
                    teacherNameToFilter = firstNameMatch;
                }
                
                teacherNameToFilter = teacherNameToFilter || originalTeacherName;
                // For teachers, only show turmas assigned to them and exclude finalizadas
                filteredTurmas = turmas.filter(t => t.teacherName === teacherNameToFilter && t.finalizada !== true);
            } else if (teacherFilter) {
                // Apply teacher filter for non-teacher users
                filteredTurmas = turmas.filter(t => t.teacherName === teacherFilter);
            }

            // Apply status filter
            if (statusFilter === 'ativas') {
                filteredTurmas = filteredTurmas.filter(t => t.finalizada !== true);
            } else if (statusFilter === 'finalizadas') {
                filteredTurmas = filteredTurmas.filter(t => t.finalizada === true);
            }

            if (searchTerm) {
                filteredTurmas = filteredTurmas.filter(t => 
                    t.name.toLowerCase().includes(searchTerm) ||
                    t.teacherName.toLowerCase().includes(searchTerm) ||
                    t.level.toLowerCase().includes(searchTerm)
                );
            }

            return filteredTurmas.sort((a, b) => a.name.localeCompare(b.name));
        }

        function getFilteredVips() {
            const searchTerm = document.getElementById('vip-search')?.value.toLowerCase() || '';
            const teacherFilter = document.getElementById('vip-teacher-filter')?.value || '';
            const statusFilter = currentVipsFilter;
            
            // Only show students who have actual VIP records, not just VIP modality
            const vipStudents = students.filter(s => {
                const hasVipRecord = vips.find(v => v.studentId === s.id);
                return (s.modalidade === 'VIP' || s.modalidade === 'DUPLA') && hasVipRecord;
            });
            let filteredVips = vipStudents;

            // Apply role-based filtering first
            if (currentUserRole === 'teacher') {
                // Find the teacher's name in collaborators to ensure correct mapping
                const teacherCollaborator = collaborators.find(c => 
                    c.sectors && c.sectors.includes('professor') && 
                    (c.name === currentUserName || c.email === currentUserName || c.id === userId)
                );
                const originalTeacherName = teacherCollaborator ? teacherCollaborator.name : currentUserName;
                
                // Use smart name matching to find the actual teacher name in VIPs
                const teacherNames = [...new Set(vips.map(v => v.teacherName).filter(name => name))];
                const exactMatch = teacherNames.find(name => name === originalTeacherName);
                let teacherNameToFilter = exactMatch;
                
                if (!exactMatch && originalTeacherName) {
                    // Try first name matching
                    const searchFirstName = originalTeacherName.trim().split(' ')[0].toLowerCase();
                    const firstNameMatch = teacherNames.find(name => {
                        const nameFirstName = name.trim().split(' ')[0].toLowerCase();
                        return nameFirstName === searchFirstName;
                    });
                    teacherNameToFilter = firstNameMatch;
                }
                
                teacherNameToFilter = teacherNameToFilter || originalTeacherName;
                
                // For teachers, only show VIPs assigned to them and exclude finalizados
                filteredVips = vipStudents.filter(student => {
                    const vipRecord = vips.find(v => v.studentId === student.id);
                    return vipRecord && vipRecord.teacherName === teacherNameToFilter && vipRecord.finalizado !== true;
                });
            } else if (teacherFilter) {
                // Apply teacher filter for non-teacher users
                filteredVips = vipStudents.filter(student => {
                    const vipRecord = vips.find(v => v.studentId === student.id);
                    return vipRecord && vipRecord.teacherName === teacherFilter;
                });
            }

            // Apply status filter for "Ativos" - VIPs that are not finalized
            if (statusFilter === 'ativos') {
                filteredVips = filteredVips.filter(student => {
                    const vipRecord = vips.find(v => v.studentId === student.id);
                    return vipRecord && vipRecord.finalizado !== true;
                });
            }
            
            // Apply status filter for "A Finalizar" - VIPs with 30 days or less to end
            if (statusFilter === 'a-finalizar') {
                const today = new Date();
                const thirtyDaysFromNow = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
                
                filteredVips = filteredVips.filter(student => {
                    const vipRecord = vips.find(v => v.studentId === student.id);
                    if (!vipRecord || !vipRecord.endDate || vipRecord.finalizado === true) return false;
                    
                    const endDate = new Date(vipRecord.endDate);
                    return endDate <= thirtyDaysFromNow && endDate >= today;
                });
            }
            
            // Apply status filter for "Expirados" - VIPs with contracts that have passed the end date
            if (statusFilter === 'expirados') {
                const today = new Date();
                
                filteredVips = filteredVips.filter(student => {
                    const vipRecord = vips.find(v => v.studentId === student.id);
                    if (!vipRecord || !vipRecord.endDate || vipRecord.finalizado === true) return false;
                    
                    const endDate = new Date(vipRecord.endDate);
                    return endDate < today;
                });
            }
            
            // Apply status filter for "Finalizados" - VIPs that are finalized
            if (statusFilter === 'finalizados') {
                filteredVips = filteredVips.filter(student => {
                    const vipRecord = vips.find(v => v.studentId === student.id);
                    return vipRecord && vipRecord.finalizado === true;
                });
            }

            if (searchTerm) {
                filteredVips = filteredVips.filter(student => {
                    const vipRecord = vips.find(v => v.studentId === student.id);
                    const teacher = vipRecord ? collaborators.find(c => c.id === vipRecord.teacherId) : null;
                    return student.name.toLowerCase().includes(searchTerm) ||
                           (teacher && teacher.name.toLowerCase().includes(searchTerm)) ||
                           (vipRecord && vipRecord.level && vipRecord.level.toLowerCase().includes(searchTerm));
                });
            }

            return filteredVips.sort((a, b) => a.name.localeCompare(b.name));
        }

        function updateTurmasList() {
            const filteredTurmas = getFilteredTurmas();
            const turmasGrid = document.getElementById('turmas-grid');
            
            if (!turmasGrid) return;

            const canManage = ['admin', 'pedagogico', 'ap'].includes(currentUserRole);

            turmasGrid.innerHTML = filteredTurmas.map(t => {
                // Count only TURMA modality students in the class
                const turmaStudents = students.filter(s => 
                    (t.studentIds || []).includes(s.id) && s.modalidade === 'TURMA'
                );
                
                // Check if turma is finalized
                const isFinalizada = t.finalizada === true;
                const cardBg = isFinalizada ? 'bg-stone-100' : 'bg-white';
                const opacity = isFinalizada ? 'opacity-75' : '';
                const textColor = isFinalizada ? 'text-stone-600' : 'text-stone-800';
                
                return `
                <div class="base-card flex flex-col ${cardBg} ${opacity} border ${isFinalizada ? 'border-stone-300' : ''}">
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="text-xl font-bold ${textColor}">${t.name}</h3>
                            ${isFinalizada ? `<span class="px-2 py-1 text-xs font-semibold bg-stone-300 text-stone-700 rounded">FINALIZADA</span>` : ''}
                        </div>
                        <div class="space-y-2 mb-3">
                            <p class="text-sm ${isFinalizada ? 'text-stone-500' : 'text-stone-600'}">
                                <strong>Professor:</strong> 
                                <span class="status-tag" style="background-color: ${isFinalizada ? '#D1D5DB' : '#E0E7FF'}; color: ${isFinalizada ? '#4B5563' : '#3730A3'}; font-weight: 500;">${t.teacherName}</span>
                            </p>
                            <p class="text-sm ${isFinalizada ? 'text-stone-500' : 'text-stone-600'}">
                                <strong>Alunos:</strong> 
                                <span class="status-tag" style="background-color: ${isFinalizada ? '#D1D5DB' : '#D1FAE5'}; color: ${isFinalizada ? '#4B5563' : '#065F46'}; font-weight: 500;">${turmaStudents.length}</span>
                            </p>
                            <p class="text-sm ${isFinalizada ? 'text-stone-500' : 'text-stone-600'}"><strong>N√≠vel:</strong> ${t.level}</p>
                            <p class="text-sm ${isFinalizada ? 'text-stone-500' : 'text-stone-600'}"><strong>Semestre:</strong> ${t.semestre || 'N/A'}</p>
                            ${(() => {
                                const lastPefDate = getLastPefDate(t.id);
                                if (lastPefDate) {
                                    return `<div class="mt-2"><span class="status-tag" style="background-color: ${isFinalizada ? '#D1D5DB' : '#DBEAFE'}; color: ${isFinalizada ? '#4B5563' : '#1E40AF'}; font-weight: 500;">√öltima PEF: ${formatDateBR(lastPefDate)}</span></div>`;
                                }
                                return '';
                            })()}
                        </div>
                    </div>
                    <div class="mt-auto pt-4 border-t ${isFinalizada ? 'border-stone-200' : 'border-stone-100'} flex flex-wrap gap-2">
                        ${canManage ? `<button class="secondary-btn !text-sm flex-1 ${isFinalizada ? 'opacity-50 cursor-not-allowed' : ''}" data-action="${isFinalizada ? 'turma-finalizada' : 'edit-turma'}" data-id="${t.id}" ${isFinalizada ? 'disabled' : ''}>Editar</button>` : ''}
                        <button class="primary-btn !text-sm flex-1 flex items-center justify-center ${isFinalizada ? 'opacity-50' : ''}" data-action="${isFinalizada ? 'turma-finalizada' : 'open-turma-pef'}" data-id="${t.id}">PEF</button>
                        <button class="secondary-btn !text-sm flex-1 flex items-center justify-center ${isFinalizada ? 'opacity-50' : ''}" data-action="${isFinalizada ? 'turma-finalizada' : 'open-turma-notas'}" data-id="${t.id}">Notas</button>
                        ${isFinalizada && canManage ? `<button class="secondary-btn !text-sm flex-1 min-w-[120px]" style="background-color: #10B981; color: white;" data-action="reativar-turma" data-id="${t.id}">Reativar</button>` : ''}
                    </div>
                </div>`}).join('') || '<p class="col-span-full text-center py-10 text-stone-500">Nenhuma turma encontrada.</p>';
        }

        // Function to calculate VIP status tags based on contract dates
        function getVipStatusTag(vipRecord) {
            if (!vipRecord || !vipRecord.endDate) return '';
            
            const today = new Date();
            const endDate = new Date(vipRecord.endDate);
            const diffTime = endDate.getTime() - today.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                // Contract expired
                const expiredDays = Math.abs(diffDays);
                return `<div class="mt-2"><span class="status-tag" style="background-color: #FEE2E2; color: #991B1B; font-weight: 600;">Contrato expirado h√° ${expiredDays} dia${expiredDays !== 1 ? 's' : ''}</span></div>`;
            } else if (diffDays <= 30) {
                // Contract ending within 30 days
                return `<div class="mt-2"><span class="status-tag" style="background-color: #FEF3C7; color: #92400E; font-weight: 600;">${diffDays} dia${diffDays !== 1 ? 's' : ''} para finalizar</span></div>`;
            }
            
            return '';
        }

        let currentVipPage = 1;
        let vipsPerPage = 6;

        function updateVipsList() {
            const allFilteredVips = getFilteredVips();
            const vipsGrid = document.getElementById('vips-grid');
            
            if (!vipsGrid) return;

            // Pagination logic
            const totalVips = allFilteredVips.length;
            const totalPages = Math.ceil(totalVips / vipsPerPage);
            
            // Reset to page 1 if current page is beyond total pages
            if (currentVipPage > totalPages && totalPages > 0) {
                currentVipPage = 1;
            }
            
            // Calculate pagination
            const startIndex = (currentVipPage - 1) * vipsPerPage;
            const endIndex = startIndex + vipsPerPage;
            const paginatedVips = allFilteredVips.slice(startIndex, endIndex);

            vipsGrid.innerHTML = paginatedVips.map(student => {
                const vipRecord = vips.find(v => v.studentId === student.id);
                const teacher = vipRecord ? collaborators.find(c => c.id === vipRecord.teacherId) : null;
                const canManage = ['admin', 'pedagogico', 'ap', 'financeiro', 'teacher'].includes(currentUserRole);
                
                // Can show PEF if user is admin/pedagogico/ap/financeiro OR if user is the assigned teacher
                const canShowPef = ['admin', 'pedagogico', 'ap', 'financeiro'].includes(currentUserRole) || 
                    (currentUserRole === 'teacher' && vipRecord && vipRecord.teacherName === currentUserName);
                
                // Get status tag for contract expiration/ending
                const statusTag = getVipStatusTag(vipRecord);
                
                // Check if VIP is finalized
                const isFinalizado = vipRecord?.finalizado === true;
                const cardBg = isFinalizado ? 'bg-stone-100' : 'bg-white';
                const opacity = isFinalizado ? 'opacity-75' : '';
                const textColor = isFinalizado ? 'text-stone-600' : 'text-stone-800';
                const textColorLight = isFinalizado ? 'text-stone-500' : 'text-stone-600';
                const borderColor = isFinalizado ? 'border-stone-200' : 'border-stone-100';
                
                return `
                <div class="base-card flex flex-col ${cardBg} ${opacity} border ${isFinalizado ? 'border-stone-300' : ''}" id="vip-card-${student.id}">
                    <div class="flex-1">
                        <div class="mb-2 flex justify-between items-start">
                            <h3 class="text-xl font-bold ${textColor}">${student.name}</h3>
                            ${isFinalizado ? `<span class="px-2 py-1 text-xs font-semibold bg-stone-300 text-stone-700 rounded">FINALIZADO</span>` : ''}
                        </div>
                        <div class="card-content">
                            <p class="text-sm ${textColorLight} mb-2"><strong>Status:</strong> <span class="status-tag" style="background-color: ${isFinalizado ? '#D1D5DB' : (student.status === 'Ativo' ? '#D1FAE5' : student.status === 'Inativo' ? '#DBEAFE' : student.status === 'Pendente' ? '#FEF3C7' : '#F3F4F6')}; color: ${isFinalizado ? '#4B5563' : (student.status === 'Ativo' ? '#065F46' : student.status === 'Inativo' ? '#1E40AF' : student.status === 'Pendente' ? '#92400E' : '#4B5563')};">${student.status || 'Pendente'}</span></p>
                            ${vipRecord ? `<p class="text-sm ${textColorLight} mb-2">Professor: ${teacher?.name || 'N/A'}</p>` : ''}
                            ${vipRecord ? `<p class="text-sm ${textColorLight}"><strong>N√≠vel:</strong> ${vipRecord.level || 'N/A'}</p>` : ''}
                            ${vipRecord && vipRecord.endDate ? `<p class="text-sm ${textColorLight}"><strong>Finaliza em:</strong> ${formatDateBR(vipRecord.endDate)}</p>` : ''}
                            ${student.indicacao ? `<p class="text-sm ${textColorLight}"><strong>Indica√ß√£o:</strong> ${student.indicacao}</p>` : ''}
                            ${vipRecord && vipRecord.observacoes ? `
                                <div class="mt-3 pt-2 border-t ${borderColor}">
                                    <p class="text-sm ${textColorLight}"><strong>Observa√ß√µes:</strong></p>
                                    <p class="text-sm text-stone-500 mt-1 italic">${vipRecord.observacoes}</p>
                                </div>
                            ` : ''}
                            ${vipRecord ? (() => {
                                const lastPefDate = getLastPefDate(vipRecord.id);
                                if (lastPefDate) {
                                    return `<div class="mt-2"><span class="status-tag" style="background-color: ${isFinalizado ? '#D1D5DB' : '#DBEAFE'}; color: ${isFinalizado ? '#4B5563' : '#1E40AF'}; font-weight: 500;">√öltima PEF: ${formatDateBR(lastPefDate)}</span></div>`;
                                }
                                return '';
                            })() : ''}
                            ${!isFinalizado ? statusTag : ''}
                        </div>
                    </div>
                    <div class="mt-auto pt-4 border-t ${borderColor} flex flex-wrap gap-2">
                        ${vipRecord ? `
                            <button class="primary-btn !text-sm flex-1 flex items-center justify-center ${isFinalizado ? 'opacity-50' : ''}" data-action="${isFinalizado ? 'vip-finalizado' : 'open-vip-pef'}" data-id="${vipRecord.id}">PEF</button>
                            <button class="secondary-btn !text-sm flex-1 flex items-center justify-center ${isFinalizado ? 'opacity-50' : ''}" data-action="${isFinalizado ? 'vip-finalizado' : 'open-vip-notas'}" data-id="${vipRecord.id}">Notas</button>
                            ${currentUserRole !== 'teacher' ? `<button class="secondary-btn !text-sm flex-1 ${isFinalizado ? 'opacity-50 cursor-not-allowed' : ''}" data-action="${isFinalizado ? 'vip-finalizado' : 'edit-vip'}" data-id="${vipRecord.id}" ${isFinalizado ? 'disabled' : ''}>Configurar</button>` : ''}
                            ${isFinalizado && currentUserRole !== 'teacher' ? `<button class="secondary-btn !text-sm flex-1 min-w-[120px]" style="background-color: #10B981; color: white;" data-action="reativar-vip" data-id="${vipRecord.id}">Reativar</button>` : ''}
                        ` : ''}
                    </div>
                </div>`}).join('') || '<p class="col-span-full text-center py-10 text-stone-500">Nenhum aluno VIP encontrado.</p>';
            
            // Update pagination controls
            updateVipsPaginationControls(totalVips, totalPages, startIndex, endIndex);
        }

        function updateAlunosList(filter) {
            const listBody = document.getElementById('alunos-list');
            if (!listBody) return;
            const canEdit = ['admin', 'financeiro', 'pedagogico', 'ap'].includes(currentUserRole);
            const canViewFinancialInfo = canViewStudentFinancials();

            const filteredStudents = getFilteredStudents();
            const totalItems = filteredStudents.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);

            // Reset to page 1 if current page is beyond total pages
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = 1;
            }

            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedStudents = filteredStudents.slice(startIndex, endIndex);

            if (filteredStudents.length === 0) {
                const colspanCount = canViewFinancialInfo ? 5 : 4;
                listBody.innerHTML = `<tr><td colspan="${colspanCount}" class="text-center py-10 text-stone-500">Nenhum aluno encontrado.</td></tr>`;
                updatePaginationControls(0, 0, 0);
                return;
            }

            listBody.innerHTML = paginatedStudents.map(student => {
                const vipRecord = (student.modalidade === 'VIP' || student.modalidade === 'DUPLA') ? vips.find(v => v.studentId === student.id) : null;
                const profileCheck = checkStudentProfileCompleteness(student);
                const fichaStatus = profileCheck.isComplete 
                    ? '<span class="status-tag" style="background-color: #D1FAE5; color: #065F46; border-color: #6EE7B7;">Completa</span>' 
                    : `<div class="relative group">
                        <span class="status-tag cursor-help" style="background-color: #FEE2E2; color: #991B1B; border-color: #FCA5A5;">Incompleta</span>
                        <div class="absolute left-0 top-full mt-1 hidden group-hover:block bg-stone-800 text-white text-xs rounded-lg p-3 z-50 shadow-lg min-w-[200px]">
                            <p class="font-bold mb-2">Faltam:</p>
                            <ul class="list-disc list-inside space-y-1">
                                ${profileCheck.missing.map(item => `<li>${item}</li>`).join('')}
                            </ul>
                        </div>
                       </div>`;
                
                return `
                <tr id="student-row-${student.id}" class="cursor-pointer">
                    <td class="font-medium" data-action="view-aluno" data-id="${student.id}">
                        <div class="flex items-center">
                            <div class="flex flex-col flex-1">
                                <div>${student.name}</div>
                                <div class="mt-1">
                                    <span class="status-tag status-${(student.modalidade || 'turma').toLowerCase()} text-xs">${student.modalidade || 'TURMA'}</span>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td data-action="view-aluno" data-id="${student.id}"><span class="status-tag status-${(student.status || 'pendente').toLowerCase()}">${student.status || 'Pendente'}</span></td>
                    <td>${fichaStatus}</td>
                    ${canViewFinancialInfo ? `<td class="font-mono" data-action="view-aluno" data-id="${student.id}">R$ ${parseFloat(student.amountPaid || 0).toFixed(2)}</td>` : ''}
                    ${canViewFinancialInfo ? `<td class="font-mono" data-action="view-aluno" data-id="${student.id}">R$ ${parseFloat(student.amountReceived || student.amountPaid || 0).toFixed(2)}</td>` : `<td data-action="view-aluno" data-id="${student.id}">${student.responsibleName || 'N/A'}</td>`}
                </tr>
                `;
            }).join('');

            updatePaginationControls(totalItems, totalPages, startIndex + 1, Math.min(endIndex, totalItems));
        }

        function updatePaginationControls(totalItems, totalPages, startItem, endItem) {
            const paginationInfo = document.getElementById('pagination-info');
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            const pageNumbers = document.getElementById('page-numbers');

            if (totalItems === 0) {
                paginationInfo.textContent = 'Nenhum item encontrado';
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                pageNumbers.innerHTML = '';
                return;
            }

            paginationInfo.textContent = `Mostrando ${startItem}-${endItem} de ${totalItems} alunos`;

            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;

            // Generate page numbers
            let pageNumbersHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentPage;
                pageNumbersHTML += `
                    <button class="page-number-btn ${isActive ? 'active' : ''}" data-page="${i}">
                        ${i}
                    </button>
                `;
            }

            pageNumbers.innerHTML = pageNumbersHTML;

            // Add click events to page number buttons
            document.querySelectorAll('.page-number-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentPage = parseInt(btn.dataset.page);
                    const filter = document.querySelector('#alunos-filter-buttons .filter-btn.active').dataset.filter;
                    updateAlunosList(filter);
                });
            });
        }

        // Reset pagination when switching sections
        function resetPagination() {
            currentPage = 1;
        }

        function renderTurmasSection() {
            document.getElementById('main-title').textContent = 'Gest√£o de Turmas';
            document.getElementById('main-description').textContent = 'Crie turmas, adicione alunos e registre as presen√ßas.';

            const canManage = ['admin', 'pedagogico', 'ap'].includes(currentUserRole);
            let itemsToDisplay = getFilteredTurmas();


            contentArea.innerHTML = `
                <div id="turmas-section">
                    <div class="flex justify-between items-center mb-6 gap-4">
                        <div class="flex gap-4 flex-1">
                            <div class="flex-1 max-w-md relative">
                                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                <input type="text" id="turma-search" placeholder="Pesquisar turmas..." class="form-input pl-10" oninput="updateTurmasList()">
                            </div>
                            ${currentUserRole !== 'teacher' ? `
                            <div class="min-w-48">
                                <select id="turma-teacher-filter" class="form-input" onchange="updateTurmasList()">
                                    <option value="">Todos os professores</option>
                                    ${[...new Set(turmas.map(t => t.teacherName))].sort().map(teacher => 
                                        `<option value="${teacher}">${teacher}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            ` : ''}
                        </div>
                        <div class="text-right">
                            ${canManage ? `<button class="primary-btn w-auto" data-action="add-turma">+ Adicionar Turma</button>` : ''}
                        </div>
                    </div>
                    
                    <div class="flex gap-2 mb-6" id="turmas-filter-buttons">
                        <button class="secondary-btn filter-btn ${currentTurmasFilter === 'todos' ? 'active' : ''}" data-filter="todos">Todos</button>
                        <button class="secondary-btn filter-btn ${currentTurmasFilter === 'ativas' ? 'active' : ''}" data-filter="ativas">Ativas</button>
                        <button class="secondary-btn filter-btn ${currentTurmasFilter === 'finalizadas' ? 'active' : ''}" data-filter="finalizadas">Finalizadas</button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="turmas-grid">
                        ${itemsToDisplay.map(t => {
                            // Count only TURMA modality students in the class
                            const turmaStudents = students.filter(s => 
                                (t.studentIds || []).includes(s.id) && s.modalidade === 'TURMA'
                            );
                            
                            // Check if turma is finalized
                            const isFinalizada = t.finalizada === true;
                            const cardBg = isFinalizada ? 'bg-stone-100' : 'bg-white';
                            const opacity = isFinalizada ? 'opacity-75' : '';
                            const textColor = isFinalizada ? 'text-stone-600' : 'text-stone-800';
                            
                            return `
                        <div class="base-card flex flex-col ${cardBg} ${opacity} border ${isFinalizada ? 'border-stone-300' : ''}">
                            <div class="flex-1">
                                <div class="flex justify-between items-start mb-3">
                                    <h3 class="text-xl font-bold ${textColor}">${t.name}</h3>
                                    ${isFinalizada ? `<span class="px-2 py-1 text-xs font-semibold bg-stone-300 text-stone-700 rounded">FINALIZADA</span>` : ''}
                                </div>
                                <div class="space-y-2 mb-3">
                                    <p class="text-sm ${isFinalizada ? 'text-stone-500' : 'text-stone-600'}">
                                        <strong>Professor:</strong> 
                                        <span class="status-tag" style="background-color: ${isFinalizada ? '#D1D5DB' : '#E0E7FF'}; color: ${isFinalizada ? '#4B5563' : '#3730A3'}; font-weight: 500;">${t.teacherName}</span>
                                    </p>
                                    <p class="text-sm ${isFinalizada ? 'text-stone-500' : 'text-stone-600'}">
                                        <strong>Alunos:</strong> 
                                        <span class="status-tag" style="background-color: ${isFinalizada ? '#D1D5DB' : '#D1FAE5'}; color: ${isFinalizada ? '#4B5563' : '#065F46'}; font-weight: 500;">${turmaStudents.length}</span>
                                    </p>
                                    <p class="text-sm ${isFinalizada ? 'text-stone-500' : 'text-stone-600'}"><strong>N√≠vel:</strong> ${t.level}</p>
                                    <p class="text-sm ${isFinalizada ? 'text-stone-500' : 'text-stone-600'}"><strong>Semestre:</strong> ${t.semestre || 'N/A'}</p>
                                    ${(() => {
                                        const lastPefDate = getLastPefDate(t.id);
                                        if (lastPefDate) {
                                            return `<div class="mt-2"><span class="status-tag" style="background-color: ${isFinalizada ? '#D1D5DB' : '#DBEAFE'}; color: ${isFinalizada ? '#4B5563' : '#1E40AF'}; font-weight: 500;">√öltima PEF: ${formatDateBR(lastPefDate)}</span></div>`;
                                        }
                                        return '';
                                    })()}
                                </div>
                            </div>
                            <div class="mt-auto pt-4 border-t ${isFinalizada ? 'border-stone-200' : 'border-stone-100'} flex flex-wrap gap-2">
                                ${canManage ? `<button class="secondary-btn !text-sm flex-1 ${isFinalizada ? 'opacity-50 cursor-not-allowed' : ''}" data-action="${isFinalizada ? 'turma-finalizada' : 'edit-turma'}" data-id="${t.id}" ${isFinalizada ? 'disabled' : ''}>Editar</button>` : ''}
                                <button class="primary-btn !text-sm flex-1 flex items-center justify-center ${isFinalizada ? 'opacity-50' : ''}" data-action="${isFinalizada ? 'turma-finalizada' : 'open-turma-pef'}" data-id="${t.id}">PEF</button>
                                <button class="secondary-btn !text-sm flex-1 flex items-center justify-center ${isFinalizada ? 'opacity-50' : ''}" data-action="${isFinalizada ? 'turma-finalizada' : 'open-turma-notas'}" data-id="${t.id}">Notas</button>
                                ${isFinalizada && canManage ? `<button class="secondary-btn !text-sm flex-1 min-w-[120px]" style="background-color: #10B981; color: white;" data-action="reativar-turma" data-id="${t.id}">Reativar</button>` : ''}
                            </div>
                        </div>`}).join('') || '<p class="col-span-full text-center py-10 text-stone-500">Nenhuma turma encontrada.</p>'}
                    </div>
                </div>`;
            
            // Add event listeners to filter buttons
            const filterButtons = document.querySelectorAll('#turmas-filter-buttons .filter-btn');
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    currentTurmasFilter = btn.dataset.filter;
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateTurmasList();
                });
            });
        }

        function renderVipsSection() {
            document.getElementById('main-title').textContent = 'Alunos VIP';
            document.getElementById('main-description').textContent = 'Gerencie alunos VIP e registre suas presen√ßas.';

            const canManage = ['admin', 'pedagogico', 'ap', 'financeiro'].includes(currentUserRole);
            
            let itemsToDisplay = getFilteredVips();
            


            contentArea.innerHTML = `
                <div id="vips-section">
                    <div class="flex justify-between items-center mb-6 gap-4">
                        <div class="flex gap-4 flex-1">
                            <div class="flex-1 max-w-md relative">
                                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                                <input type="text" id="vip-search" placeholder="Pesquisar VIPs..." class="form-input pl-10" oninput="updateVipsList()">
                            </div>
                            ${currentUserRole !== 'teacher' ? `
                            <div class="min-w-48">
                                <select id="vip-teacher-filter" class="form-input" onchange="updateVipsList()">
                                    <option value="">Todos os professores</option>
                                    ${[...new Set(vips.map(v => v.teacherName).filter(name => name))].sort().map(teacher => 
                                        `<option value="${teacher}">${teacher}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            ` : ''}
                        </div>
                        <div class="text-right">
                            ${canManage ? `<button class="primary-btn w-auto" data-action="add-vip">+ Adicionar VIP</button>` : ''}
                        </div>
                    </div>

                    ${canManage || currentUserRole === 'teacher' ? `
                    <div class="flex gap-2 mb-6" id="vips-filter-buttons">
                        <button class="secondary-btn filter-btn ${currentVipsFilter === 'todos' ? 'active' : ''}" data-filter="todos">Todos</button>
                        <button class="secondary-btn filter-btn ${currentVipsFilter === 'ativos' ? 'active' : ''}" data-filter="ativos">Ativos</button>
                        <button class="secondary-btn filter-btn ${currentVipsFilter === 'a-finalizar' ? 'active' : ''}" data-filter="a-finalizar">A Finalizar</button>
                        <button class="secondary-btn filter-btn ${currentVipsFilter === 'expirados' ? 'active' : ''}" data-filter="expirados">Expirados</button>
                        <button class="secondary-btn filter-btn ${currentVipsFilter === 'finalizados' ? 'active' : ''}" data-filter="finalizados">Finalizados</button>
                    </div>
                    ` : ''}
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="vips-grid">
                        <!-- Content will be populated by updateVipsList() -->
                    </div>
                    
                    <!-- VIPs Pagination -->
                    <div class="mt-8 flex flex-col sm:flex-row justify-between items-center gap-4" id="vips-pagination">
                        <div class="flex items-center gap-2">
                            <label class="text-sm text-stone-600">VIPs por p√°gina:</label>
                            <select id="vips-per-page" class="form-input !py-1 !px-2 text-sm w-auto">
                                <option value="6">6</option>
                                <option value="12">12</option>
                                <option value="24">24</option>
                                <option value="48">48</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-sm text-stone-600" id="vips-info">Mostrando 0 de 0</span>
                            <div class="flex items-center gap-2">
                                <button id="vips-prev-page" class="pagination-btn" disabled>Anterior</button>
                                <div class="flex gap-1" id="vips-page-numbers"></div>
                                <button id="vips-next-page" class="pagination-btn" disabled>Pr√≥ximo</button>
                            </div>
                        </div>
                    </div>
                </div>`;

            // Add event listeners for filter buttons
            if (canManage || currentUserRole === 'teacher') {
                const filterButtons = document.querySelectorAll('#vips-filter-buttons .filter-btn');
                filterButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        currentVipsFilter = btn.dataset.filter;
                        filterButtons.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        updateVipsList();
                    });
                });
            }

            // Set up VIPs pagination controls
            const vipsPerPageSelect = document.getElementById('vips-per-page');
            const vipsPrevPageBtn = document.getElementById('vips-prev-page');
            const vipsNextPageBtn = document.getElementById('vips-next-page');

            if (vipsPerPageSelect) {
                vipsPerPageSelect.addEventListener('change', () => {
                    vipsPerPage = parseInt(vipsPerPageSelect.value);
                    currentVipPage = 1;
                    updateVipsList();
                });
            }

            if (vipsPrevPageBtn) {
                vipsPrevPageBtn.addEventListener('click', () => {
                    if (currentVipPage > 1) {
                        currentVipPage--;
                        updateVipsList();
                    }
                });
            }

            if (vipsNextPageBtn) {
                vipsNextPageBtn.addEventListener('click', () => {
                    const totalVips = getFilteredVips().length;
                    const totalPages = Math.ceil(totalVips / vipsPerPage);
                    if (currentVipPage < totalPages) {
                        currentVipPage++;
                        updateVipsList();
                    }
                });
            }

            // Initial population of VIPs list
            updateVipsList();
        }

        function updateVipsPaginationControls(totalItems, totalPages, startIndex, endIndex) {
            const vipsInfo = document.getElementById('vips-info');
            const vipsPrevPageBtn = document.getElementById('vips-prev-page');
            const vipsNextPageBtn = document.getElementById('vips-next-page');
            const vipsPageNumbers = document.getElementById('vips-page-numbers');

            if (!vipsInfo || !vipsPrevPageBtn || !vipsNextPageBtn || !vipsPageNumbers) return;

            // Update info text
            const showingEnd = Math.min(endIndex, totalItems);
            vipsInfo.textContent = totalItems > 0 ? 
                `Mostrando ${startIndex + 1}-${showingEnd} de ${totalItems}` : 
                'Mostrando 0 de 0';

            // Update buttons
            vipsPrevPageBtn.disabled = currentVipPage <= 1;
            vipsNextPageBtn.disabled = currentVipPage >= totalPages;

            // Generate page numbers
            let pageNumbersHTML = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentVipPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const isActive = i === currentVipPage;
                pageNumbersHTML += `
                    <button class="page-number-btn ${isActive ? 'active' : ''}" data-vip-page="${i}">
                        ${i}
                    </button>
                `;
            }

            vipsPageNumbers.innerHTML = pageNumbersHTML;

            // Add click events to VIPs page number buttons
            document.querySelectorAll('[data-vip-page]').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentVipPage = parseInt(btn.dataset.vipPage);
                    updateVipsList();
                });
            });
        }




        // DEPRECATED: Se√ß√£o de Tarefas removida - redireciona para Dashboard
        function renderTarefasSection() { 
            console.log('Se√ß√£o de Tarefas foi removida. Redirecionando para Dashboard...');
            renderInicioSection();
            const navItem = document.querySelector('[data-target="inicio"]');
            if (navItem) setActiveNavItem(navItem);
        }

        // DEPRECATED: Fun√ß√µes auxiliares de tarefas removidas
        function switchTaskTab(tabType) { /* Deprecated */ }
        function updateTaskList() { /* Deprecated */ }

        function renderGradeSection() {
            document.getElementById('main-title').textContent = 'Grade de Hor√°rios';
            document.getElementById('main-description').textContent = 'Visualize e gerencie a grade de aulas da equipe.';

            const isTeacher = currentUserRole === 'teacher';
            let filterHtml = '';

            if (!isTeacher) {
                const teacherOptions = collaborators.filter(c => c.role === 'teacher').map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                filterHtml = `
                    <div class="grade-select-container flex-grow">
                        <label for="teacher-filter" class="block text-sm font-medium text-stone-700 mb-1">Filtrar por professor:</label>
                        <select id="teacher-filter" class="grade-select">
                            <option value="all">Todos</option>
                            ${teacherOptions}
                        </select>
                    </div>
                `;
            }

            const addAulaButton = ['admin', 'ap', 'pedagogico'].includes(currentUserRole)
                ? `<button class="primary-btn w-auto" data-action="add-schedule">+ Adicionar Aula</button>`
                : '';

            contentArea.innerHTML = `
                <section id="grade-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                        ${filterHtml}
                        <div class="flex gap-2 ml-auto">
                           ${addAulaButton}
                        </div>
                    </div>
                    <div id="weekly-hours-container" class="mb-6"></div>
                    <div id="schedule-grid-container"></div>
                </section>
            `;

            if (isTeacher) {
                // Find the teacher's name in collaborators to ensure correct mapping
                const teacherCollaborator = collaborators.find(c => 
                    c.role === 'teacher' && 
                    (c.name === currentUserName || c.email === currentUserName || c.id === userId)
                );
                const originalTeacherName = teacherCollaborator ? teacherCollaborator.name : currentUserName;

                // Use smart name matching to find the actual teacher name in schedules
                const teacherNameToFilter = findTeacherByName(originalTeacherName) || originalTeacherName;

                // Show debug info if teacher has no schedules
                const teacherSchedules = schedules.filter(s => s.teacher === teacherNameToFilter);
                if (teacherSchedules.length === 0) {
                    console.log('DEBUG: Teacher schedule mapping', {
                        currentUserName,
                        originalTeacherName,
                        teacherNameToFilter,
                        availableTeachersInSchedules: [...new Set(schedules.map(s => s.teacher))],
                        collaboratorTeachers: collaborators.filter(c => c.role === 'teacher').map(c => c.name),
                        smartMappingResult: findTeacherByName(originalTeacherName)
                    });

                    // Show helper message for teachers
                    const availableTeachers = [...new Set(schedules.map(s => s.teacher))];
                    if (availableTeachers.length > 0) {
                        document.getElementById('schedule-grid-container').innerHTML = `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                                <div class="mb-4">
                                    <svg class="w-16 h-16 mx-auto text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.662-.833-2.464 0L4.732 15.5c-.77.833.192 2.5 1.732 2.5z"/>
                                    </svg>
                                </div>
                                <h3 class="text-lg font-semibold text-yellow-800 mb-2">Grade n√£o encontrada</h3>
                                <p class="text-yellow-700 mb-4">N√£o encontramos hor√°rios para o seu nome de usu√°rio.</p>
                                <div class="bg-white rounded-lg p-4 mb-4">
                                    <p class="text-sm text-gray-600 mb-2"><strong>Seu nome no sistema:</strong> ${currentUserName}</p>
                                    <p class="text-sm text-gray-600 mb-2"><strong>Professores com hor√°rios cadastrados:</strong></p>
                                    <div class="text-sm text-gray-800 font-medium">${availableTeachers.join(', ')}</div>
                                </div>
                                <p class="text-yellow-700 text-sm">Entre em contato com o administrador para ajustar o mapeamento do seu nome.</p>
                            </div>
                        `;
                        return;
                    }
                }

                renderScheduleGrid(teacherNameToFilter);
            } else {
                const teacherFilter = document.getElementById('teacher-filter');
                if (teacherFilter) {
                    teacherFilter.addEventListener('change', () => renderScheduleGrid(teacherFilter.value));
                }
                renderScheduleGrid('all');
            }
        }

        // ROBUST NAME NORMALIZATION - Central function to ensure consistent teacher name matching
        function normalizeTeacherName(name) {
            if (!name) return '';
            // Remove extra spaces, convert to lowercase, remove special invisible chars
            return name.trim().replace(/\s+/g, ' ').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        // Helper function to find teacher by name with ROBUST matching
        function findTeacherByName(searchName) {
            if (!searchName) return null;

            const normalizedSearch = normalizeTeacherName(searchName);
            
            // Build a map of normalized names to original names
            const teacherMap = new Map();
            schedules.forEach(s => {
                if (s.teacher) {
                    const normalized = normalizeTeacherName(s.teacher);
                    if (!teacherMap.has(normalized)) {
                        teacherMap.set(normalized, s.teacher);
                    }
                }
            });

            // First try exact normalized match (most reliable)
            if (teacherMap.has(normalizedSearch)) {
                return teacherMap.get(normalizedSearch);
            }

            // Then try first name matching as fallback
            const searchFirstName = normalizedSearch.split(' ')[0];
            for (const [normalizedName, originalName] of teacherMap.entries()) {
                const teacherFirstName = normalizedName.split(' ')[0];
                if (teacherFirstName === searchFirstName) {
                    return originalName;
                }
            }

            return null;
        }

        function calculateWeeklyHours(teacherName) {
            // Use robust name matching to find the actual teacher name
            const actualTeacherName = findTeacherByName(teacherName) || teacherName;
            
            // ROBUST FILTERING: Use normalized comparison to catch ALL schedules for this teacher
            const normalizedTeacherName = normalizeTeacherName(actualTeacherName);
            const teacherSchedules = schedules.filter(s => {
                if (s.type === 'break') return false;
                const normalizedScheduleTeacher = normalizeTeacherName(s.teacher || '');
                return normalizedScheduleTeacher === normalizedTeacherName;
            });

            console.log(`üìä CALCULANDO HORAS - Professor: ${teacherName}`);
            console.log(`  Nome original: ${teacherName}`);
            console.log(`  Nome encontrado na grade: ${actualTeacherName}`);
            console.log(`  Nome normalizado para busca: ${normalizedTeacherName}`);
            console.log(`  Total de hor√°rios encontrados: ${teacherSchedules.length}`);

            let totalHours = 0;
            
            teacherSchedules.forEach(schedule => {
                const duration = calculateClassDuration(schedule.startTime, schedule.endTime);
                totalHours += duration;
                console.log(`  ‚úÖ ${schedule.day} ${schedule.startTime}-${schedule.endTime} | ${schedule.type.toUpperCase()}: ${schedule.student} | ${duration}h`);
            });

            console.log(`  üìä TOTAL: ${totalHours} horas semanais\n`);

            return totalHours;
        }

        function calculateClassDuration(startTime, endTime) {
            // Convert time strings (HH:MM) to minutes
            const [startHour, startMinute] = startTime.split(':').map(Number);
            const [endHour, endMinute] = endTime.split(':').map(Number);

            const startTotalMinutes = startHour * 60 + startMinute;
            const endTotalMinutes = endHour * 60 + endMinute;

            // Calculate duration in hours
            const durationMinutes = endTotalMinutes - startTotalMinutes;
            const durationHours = durationMinutes / 60;

            return durationHours;
        }

        function checkTimeConflict(teacher, day, startTime, endTime, excludeId = null) {
            const normalizedTeacher = normalizeTeacherName(teacher);
            // ROBUST FILTERING: Use normalized comparison for conflict checking
            return schedules.some(s => {
                const normalizedScheduleTeacher = normalizeTeacherName(s.teacher || '');
                return normalizedScheduleTeacher === normalizedTeacher && 
                    s.day === day && 
                    s.id !== excludeId &&
                    ((startTime >= s.startTime && startTime < s.endTime) || 
                     (endTime > s.startTime && endTime <= s.endTime) ||
                     (startTime <= s.startTime && endTime >= s.endTime));
            });
        }

        function renderScheduleGrid(teacherFilter) {
            const gridContainer = document.getElementById('schedule-grid-container');
            const hoursContainer = document.getElementById('weekly-hours-container');
            if (!gridContainer) return;

            const days = ["Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta"];
            let filteredSchedules = [...schedules];

            if (teacherFilter !== 'all') {
                const actualTeacherName = findTeacherByName(teacherFilter) || teacherFilter;
                const normalizedTeacherName = normalizeTeacherName(actualTeacherName);
                // ROBUST FILTERING: Use normalized comparison
                filteredSchedules = filteredSchedules.filter(s => {
                    const normalizedScheduleTeacher = normalizeTeacherName(s.teacher || '');
                    return normalizedScheduleTeacher === normalizedTeacherName;
                });
            }

            // Debug log for teachers to help identify mapping issues
            if (currentUserRole === 'teacher' && teacherFilter !== 'all') {
                console.log('DEBUG: Grade filtering for teacher', {
                    teacherFilter,
                    currentUserName,
                    currentUserRole,
                    filteredSchedulesCount: filteredSchedules.length,
                    allSchedulesCount: schedules.length,
                    uniqueTeachers: [...new Set(schedules.map(s => s.teacher))]
                });
            }

            // Show weekly hours for specific teacher or all teachers summary
            const canViewAllHours = ['admin', 'pedagogico', 'ap'].includes(currentUserRole);

            if (teacherFilter !== 'all' && hoursContainer) {
                const weeklyHours = calculateWeeklyHours(teacherFilter);
                hoursContainer.innerHTML = `
                    <div class="rounded-lg p-4 text-center border" style="background-color: #F1D24B20; border-color: #F1D24B40;">
                        <div class="text-sm font-medium uppercase tracking-wide text-stone-700">Carga Hor√°ria Semanal</div>
                        <div class="text-3xl font-bold mt-1 text-stone-800">${weeklyHours} horas</div>
                        <div class="text-xs mt-1 text-stone-600">${teacherFilter}</div>
                    </div>
                `;
            } else if (teacherFilter === 'all' && canViewAllHours && hoursContainer) {
                // Show summary of all teachers' hours
                const teacherHours = {};
                const teachers = collaborators.filter(c => c.role === 'teacher');

                teachers.forEach(teacher => {
                    teacherHours[teacher.name] = calculateWeeklyHours(teacher.name);
                });

                const totalHours = Object.values(teacherHours).reduce((sum, hours) => sum + hours, 0);

                hoursContainer.innerHTML = `
                    <div class="rounded-lg p-4 border" style="background-color: #F1D24B20; border-color: #F1D24B40;">
                        <div class="text-sm font-medium text-stone-700 uppercase tracking-wide mb-3 text-center">Resumo da Carga Hor√°ria Semanal</div>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 mb-3">
                            ${Object.entries(teacherHours).map(([name, hours]) => `
                                <div class="rounded-lg p-3 text-center border" style="background-color: #F1D24B20; border-color: #F1D24B40;">
                                    <div class="text-sm font-medium uppercase tracking-wide text-stone-700">Carga Semanal</div>
                                    <div class="text-2xl font-bold mt-1 text-stone-800">${hours} horas</div>
                                    <div class="text-xs mt-1 text-stone-600">${name}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="text-center pt-3" style="border-top: 1px solid #F1D24B40;">
                            <div class="text-sm text-stone-700">Total Geral</div>
                            <div class="text-2xl font-bold text-stone-800">${totalHours} horas</div>
                        </div>
                    </div>
                `;
            } else if (hoursContainer) {
                hoursContainer.innerHTML = '';
            }

            // Show message if no schedules found for teacher role
            if (currentUserRole === 'teacher' && filteredSchedules.length === 0) {
                return; // Already handled above
            }

            let gridHtml = `<div class="schedule-grid">`;
            days.forEach(day => {
                gridHtml += `<div class="day-column"><h3 class="day-column-header">${day}</h3>`;
                const dayClasses = filteredSchedules.filter(s => s.day === day).sort((a, b) => a.startTime.localeCompare(b.startTime));
                if (dayClasses.length > 0) {
                    dayClasses.forEach(c => {
                        let tagClass, tagText;
                        if (c.type === 'break') {
                            tagClass = 'tag-break';
                            tagText = 'BREAK';
                        } else if (c.type === 'vip') {
                            tagClass = 'tag-vip';
                            tagText = 'VIP';
                        } else {
                            tagClass = 'tag-turma';
                            tagText = 'TURMA';
                        }

                        const teacherName = teacherFilter === 'all' ? `<p class="text-xs text-stone-500"><em>(${c.teacher})</em></p>` : '';
                        const studentInfo = c.type === 'break' ? 
                            `<p class="font-bold text-stone-600">Intervalo</p>` : 
                            `<p class="font-bold text-stone-800">${c.student}</p><p class="text-sm text-stone-700">${c.level}</p>`;

                        gridHtml += `
                            <div class="class-entry" data-action="view-schedule" data-id="${c.id}">
                                <span class="class-tag ${tagClass}">${tagText}</span>
                                <p class="text-xs text-stone-600">${c.startTime} - ${c.endTime}</p>
                                ${studentInfo}
                                ${teacherName}
                            </div>`;
                    });
                } else {
                    gridHtml += `<p class="text-sm text-center text-stone-400 mt-4">Nenhuma aula</p>`;
                }
                gridHtml += `</div>`;
            });
            gridHtml += `</div>`;
            gridContainer.innerHTML = gridHtml;
        }

        function renderFolhaPagamentoSection() {
            document.getElementById('main-title').textContent = 'Setor Financeiro';
            document.getElementById('main-description').textContent = 'Gerencie as despesas e contas a pagar do m√™s.';

            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            const monthName = now.toLocaleString('pt-BR', { month: 'long' });

            const monthlyExpenses = expenses.map(exp => {
                let dueDate;
                if (exp.isFixedSalary && exp.dueDay) {
                    const day = parseInt(exp.dueDay, 10);
                    if (day > 0 && day < 32) {
                       dueDate = new Date(currentYear, currentMonth, day);
                    }
                } else if (exp.dueDate) {
                    // Create date as UTC to avoid timezone issues with date-only strings
                    const parts = exp.dueDate.split('-');
                    dueDate = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
                }

                if (dueDate && dueDate.getUTCMonth() === currentMonth && dueDate.getUTCFullYear() === currentYear) {
                    return { ...exp, effectiveDueDate: dueDate };
                }
                return null;
            }).filter(Boolean).sort((a, b) => a.effectiveDueDate - b.effectiveDueDate);

            // Calcular valor total de todas as despesas
            const totalExpensesBase = monthlyExpenses
                .reduce((sum, exp) => sum + Number(exp.amount) + Number(exp.extraAmount || 0), 0);

            // Calcular todos os valores pagos (incluindo valores parciais digitados)
            const totalPaidValues = monthlyExpenses
                .reduce((sum, exp) => {
                    if (exp.paidAmount && exp.paidAmount > 0) {
                        return sum + Number(exp.paidAmount);
                    }
                    return sum;
                }, 0);

            // Total a pagar = Total das despesas - Valores j√° pagos
            const totalToPay = totalExpensesBase - totalPaidValues;
            
            // Total despesas pendentes (apenas n√£o pagas) - para exibi√ß√£o no card
            const totalExpenses = monthlyExpenses
                .filter(exp => !exp.isPaid)
                .reduce((sum, exp) => sum + Number(exp.amount) + Number(exp.extraAmount || 0), 0);

            const totalPaid = monthlyExpenses
                .filter(exp => exp.isPaid)
                .reduce((sum, exp) => sum + Number(exp.paidAmount || exp.amount), 0);

            // Calcular receita total usando o mesmo m√©todo da se√ß√£o de alunos
            const totalRevenue = students.reduce((sum, student) => {
                return sum + parseFloat(student.amountReceived || student.amountPaid || 0);
            }, 0);

            // CORRE√á√ÉO: Lucro real = Receita - TODAS as despesas efetivas (pagas + valores pagos parciais + despesas pendentes)
            const totalEffectiveExpenses = totalPaidValues + totalExpenses;
            const profit = totalRevenue - totalEffectiveExpenses;

            // Load financial profit settings from localStorage
            const profitSettings = financialProfitSettings;
            
            // Calculate ticket m√©dio mensal (m√©dia dos valores pagos pelos alunos)
            const totalAmountPaid = students.reduce((sum, student) => {
                return sum + parseFloat(student.amountPaid || 0);
            }, 0);
            const ticketMedio = students.length > 0 ? totalAmountPaid / students.length : 0;
            
            // Calculate VIP profit per VIP (not total, just per 1 VIP average)
            const vipSchoolProfit = profitSettings.vipMonthlyPayment - profitSettings.vipTeacherPayment;
            
            // Calculate Turma profit per class (average of 5 students per class)
            const exampleStudentsPerClass = 5;
            const turmaRevenuePerClass = exampleStudentsPerClass * profitSettings.turmaStudentPayment;
            const turmaSchoolProfit = turmaRevenuePerClass - profitSettings.turmaTeacherPayment;

            contentArea.innerHTML = `
                <!-- Cards de Resumo Financeiro -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-stone-50 to-stone-100 p-6 rounded-lg border border-stone-200" id="expense-card-receita">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-stone-700 uppercase tracking-wide">Receita Total</h3>
                            <div class="flex gap-2 items-center">
                                <button onclick="toggleCardVisibility('expense-card-receita')" class="text-stone-400 hover:text-stone-600 transition-colors p-1" title="Ocultar/Mostrar informa√ß√µes">
                                    <svg class="w-4 h-4 eye-icon-open" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                    <svg class="w-4 h-4 eye-icon-closed hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                                    </svg>
                                </button>
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <p class="text-4xl font-bold text-stone-800 card-content">${totalRevenue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                        <p class="text-xs text-stone-600 mt-1">Entrada de receita</p>
                    </div>
                    <div class="bg-gradient-to-br from-stone-50 to-stone-100 p-6 rounded-lg border border-stone-200" id="expense-card-pendentes">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-stone-700 uppercase tracking-wide">Despesas Pendentes</h3>
                            <div class="flex gap-2 items-center">
                                <button onclick="toggleCardVisibility('expense-card-pendentes')" class="text-stone-400 hover:text-stone-600 transition-colors p-1" title="Ocultar/Mostrar informa√ß√µes">
                                    <svg class="w-4 h-4 eye-icon-open" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                    <svg class="w-4 h-4 eye-icon-closed hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                                    </svg>
                                </button>
                                <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                        <p class="text-4xl font-bold text-stone-800 card-content">${totalExpenses.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                        <p class="text-xs text-stone-600 mt-1">Aguardando pagamento</p>
                    </div>
                    <div class="bg-gradient-to-br from-stone-50 to-stone-100 p-6 rounded-lg border border-stone-200" id="expense-card-lucro">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-stone-700 uppercase tracking-wide">Lucro</h3>
                            <div class="flex gap-2 items-center">
                                <button onclick="toggleCardVisibility('expense-card-lucro')" class="text-stone-400 hover:text-stone-600 transition-colors p-1" title="Ocultar/Mostrar informa√ß√µes">
                                    <svg class="w-4 h-4 eye-icon-open" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                    <svg class="w-4 h-4 eye-icon-closed hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                                    </svg>
                                </button>
                                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                        </div>
                        <p class="text-4xl font-bold text-stone-800 card-content">${profit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                        <p class="text-xs text-stone-600 mt-1">Resultado l√≠quido</p>
                    </div>
                    
                    <!-- Card Ticket M√©dio Mensal -->
                    <div class="bg-gradient-to-br from-stone-50 to-stone-100 p-6 rounded-lg border border-stone-200" id="expense-card-ticket">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-stone-700 uppercase tracking-wide">Ticket M√©dio Mensal</h3>
                            <div class="flex gap-2 items-center">
                                <button onclick="toggleCardVisibility('expense-card-ticket')" class="text-stone-400 hover:text-stone-600 transition-colors p-1" title="Ocultar/Mostrar informa√ß√µes">
                                    <svg class="w-4 h-4 eye-icon-open" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                    <svg class="w-4 h-4 eye-icon-closed hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                                    </svg>
                                </button>
                                <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                        </div>
                        <p class="text-4xl font-bold text-stone-800 card-content">${ticketMedio.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                        <p class="text-xs text-stone-600 mt-1">Valor m√©dio por aluno ativo</p>
                    </div>
                    
                    <!-- Card Lucro por VIP (Clic√°vel) -->
                    <div class="bg-stone-100 p-6 rounded-lg border border-stone-200 cursor-pointer hover:shadow-lg transition-shadow" id="expense-card-vip-profit" onclick="openVipProfitModal()">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-stone-700 uppercase tracking-wide">Lucro por VIP (Mensal)</h3>
                            <svg class="w-8 h-8 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                            </svg>
                        </div>
                        <p class="text-4xl font-bold text-stone-800 card-content">${vipSchoolProfit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                        <p class="text-xs text-stone-600 mt-1">Escola recebe por VIP (m√©dia)</p>
                        <p class="text-xs text-stone-600 mt-2 italic">Clique para configurar</p>
                    </div>
                    
                    <!-- Card Lucro por Turma (Clic√°vel) -->
                    <div class="bg-stone-100 p-6 rounded-lg border border-stone-200 cursor-pointer hover:shadow-lg transition-shadow" id="expense-card-turma-profit" onclick="openTurmaProfitModal()">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-stone-700 uppercase tracking-wide">Lucro por Turma (Mensal)</h3>
                            <svg class="w-8 h-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <p class="text-4xl font-bold text-stone-800 card-content">${turmaSchoolProfit.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                        <p class="text-xs text-stone-600 mt-1">Escola recebe por Turma (m√©dia 5 alunos)</p>
                        <p class="text-xs text-stone-600 mt-2 italic">Clique para configurar</p>
                    </div>
                </div>

                <section id="folha-pagamento-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
                         <h3 class="text-xl font-bold text-stone-800">Despesas de ${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</h3>
                         <button class="primary-btn w-auto" data-action="add-expense">+ Nova Despesa</button>
                    </div>
                    
                    <div class="flex gap-2 mb-6" id="expenses-filter-buttons">
                        <button class="secondary-btn filter-btn active" data-filter="todos">Todos</button>
                        <button class="secondary-btn filter-btn" data-filter="fixo">Fixos</button>
                        <button class="secondary-btn filter-btn" data-filter="variavel">Vari√°veis</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Pago</th>
                                    <th>Descri√ß√£o</th>
                                    <th>Vencimento</th>
                                    <th class="text-right">Valor Base (R$)</th>
                                    <th class="text-right">Valor Extra (R$)</th>
                                    <th class="text-right">Valor Pago (R$)</th>
                                    <th class="text-center">
                                        <div class="flex items-center justify-center gap-2">
                                            <span>A√ß√µes</span>
                                            <button onclick="toggleAllExpensesVisibility()" class="text-stone-400 hover:text-stone-600 transition-colors p-1" title="Ocultar/Mostrar todas as informa√ß√µes" id="toggle-all-expenses-btn">
                                                <svg class="w-3.5 h-3.5 eye-icon-open" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                </svg>
                                                <svg class="w-3.5 h-3.5 eye-icon-closed hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="expenses-list">
                                ${monthlyExpenses.length > 0 ? monthlyExpenses.map(exp => `
                                    <tr id="expense-row-${exp.id}" class="${exp.isPaid ? 'paid' : ''}" data-expense-type="${exp.tipo || 'variavel'}">
                                        <td class="text-center"><input type="checkbox" data-action="toggle-expense" data-id="${exp.id}" class="h-5 w-5 rounded border-gray-300 text-yellow-500 focus:ring-yellow-400" ${exp.isPaid ? 'checked' : ''}></td>
                                        <td class="font-medium cursor-pointer" data-action="view-expense" data-id="${exp.id}">
                                            <div class="flex items-center justify-between">
                                                <div class="flex-1">
                                                    <span class="row-content">${exp.description}</span> 
                                                    ${exp.isFixedSalary && exp.employeeRole ? `<span class="sector-tag row-content">${exp.employeeRole}</span>` : ''}
                                                    <span class="inline-block ml-2 px-2 py-1 text-xs rounded-full row-content ${exp.tipo === 'fixo' ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800'}">${exp.tipo === 'fixo' ? 'Fixo' : 'Vari√°vel'}</span>
                                                </div>
                                                <button onclick="event.stopPropagation(); toggleRowVisibility('expense-row-${exp.id}')" class="text-stone-400 hover:text-stone-600 transition-colors p-1 ml-2" title="Ocultar/Mostrar informa√ß√µes">
                                                    <svg class="w-3.5 h-3.5 eye-icon-open" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                                    </svg>
                                                    <svg class="w-3.5 h-3.5 eye-icon-closed hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                        <td class="cursor-pointer row-content" data-action="view-expense" data-id="${exp.id}">${formatDateBR(exp.effectiveDueDate)}</td>
                                        <td class="text-right font-mono cursor-pointer row-content" data-action="view-expense" data-id="${exp.id}">${Number(exp.amount).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                                        <td class="text-right font-mono cursor-pointer row-content" data-action="view-expense" data-id="${exp.id}">${Number(exp.extraAmount || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                                        <td class="text-right font-mono cursor-pointer row-content" data-action="view-expense" data-id="${exp.id}">${Number(exp.paidAmount || (exp.isPaid ? exp.amount : 0)).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                                        <td class="text-center">
                                            <button class="task-delete-btn" data-action="delete-item" data-collection="expenses" data-id="${exp.id}">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('') : '<tr><td colspan="7" class="text-center py-8 text-stone-500">Nenhuma despesa para este m√™s.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                    <div class="data-total">
                        <p>Total a Pagar: ${totalToPay.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                    </div>
                </section>
            `;
            
            // Adicionar event listeners para os filtros de despesas
            setTimeout(() => {
                const filterButtons = document.querySelectorAll('#expenses-filter-buttons .filter-btn');
                filterButtons.forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        // Remove active class from all buttons
                        filterButtons.forEach(b => b.classList.remove('active'));
                        // Add active class to clicked button
                        e.target.classList.add('active');
                        
                        const filter = e.target.dataset.filter;
                        filterExpensesByType(filter);
                    });
                });
            }, 100);
        }
        
        // Function to filter expenses by type
        function filterExpensesByType(filter) {
            const rows = document.querySelectorAll('#expenses-list tr[data-expense-type]');
            rows.forEach(row => {
                const expenseType = row.dataset.expenseType;
                if (filter === 'todos') {
                    row.style.display = '';
                } else {
                    row.style.display = expenseType === filter ? '' : 'none';
                }
            });
        }



        function renderColaboradoresSection() {
            document.getElementById('main-title').textContent = 'Gest√£o de Colaboradores';
            document.getElementById('main-description').textContent = 'Adicione, edite e defina as permiss√µes de cada colaborador.';
            
            const roleLabels = {
                'admin': { label: 'Admin', color: 'bg-purple-100 text-purple-800' },
                'teacher': { label: 'Professor', color: 'bg-blue-100 text-blue-800' },
                'pedagogico': { label: 'Pedag√≥gico', color: 'bg-green-100 text-green-800' },
                'ap': { label: 'AP', color: 'bg-yellow-100 text-yellow-800' },
                'financeiro': { label: 'Financeiro', color: 'bg-indigo-100 text-indigo-800' },
                'am': { label: 'AM', color: 'bg-pink-100 text-pink-800' }
            };
            
            // Ordenar colaboradores alfabeticamente por nome
            const sortedCollaborators = [...collaborators].sort((a, b) => 
                a.name.localeCompare(b.name, 'pt-BR', { sensitivity: 'base' })
            );
            
            contentArea.innerHTML = `
                <section id="colaboradores-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="flex justify-end items-center mb-6">
                        <button class="primary-btn w-auto" data-action="add-collaborator">+ Adicionar Colaborador</button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>E-mail</th>
                                    <th>Role</th>
                                    <th>Permiss√µes</th>
                                    <th class="text-center">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedCollaborators.map(c => {
                                    const roleInfo = roleLabels[c.role] || { label: 'N√£o definido', color: 'bg-gray-100 text-gray-800' };
                                    const pagesCount = (c.allowedPages || []).length;
                                    return `
                                    <tr>
                                        <td class="font-medium">${c.name}</td>
                                        <td class="text-sm text-stone-600">${c.email || '<span class="text-stone-400 italic">N√£o informado</span>'}</td>
                                        <td><span class="px-2 py-1 rounded-full text-xs font-semibold ${roleInfo.color}">${roleInfo.label}</span></td>
                                        <td>
                                            ${c.role === 'admin' ? 
                                                '<span class="text-xs text-purple-600 font-semibold">Acesso Total</span>' : 
                                                `<span class="text-xs text-stone-600">${pagesCount} ${pagesCount === 1 ? 'p√°gina' : 'p√°ginas'}</span>`
                                            }
                                        </td>
                                        <td class="text-center">
                                            <div class="flex gap-2 justify-center">
                                                <button class="secondary-btn" data-action="edit-collaborator" data-id="${c.id}">Editar</button>
                                                ${c.firebaseUid ? `
                                                    <button class="secondary-btn !bg-blue-500 !text-white hover:!bg-blue-600" onclick="event.stopPropagation(); openEditFirebaseUserModal('${c.firebaseUid}', '${c.id}', '${c.name}', '${c.email || ''}')">
                                                        <svg class="inline-block w-3 h-3 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                                                        </svg>
                                                        Editar User
                                                    </button>
                                                    <button class="danger-btn" onclick="event.stopPropagation(); deleteFirebaseUser('${c.firebaseUid}', '${c.id}', '${c.name}')">
                                                        <svg class="inline-block w-3 h-3 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <polyline points="3 6 5 6 21 6"/>
                                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                                        </svg>
                                                        Excluir User
                                                    </button>
                                                ` : ''}
                                                <button class="danger-btn" data-action="delete-item" data-collection="collaborators" data-id="${c.id}" onclick="event.stopPropagation()">Excluir</button>
                                            </div>
                                        </td>
                                    </tr>
                                `}).join('') || '<tr><td colspan="4" class="text-center py-10 text-stone-500">Nenhum colaborador encontrado.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </section>
            `;
        }





        function renderDojoSection() {
            document.getElementById('main-title').textContent = 'SLAP Dojo';
            document.getElementById('main-description').textContent = 'Gerencie a pontua√ß√£o dos competidores e as miss√µes ativas.';
            const canAddCompetitor = can('dojo.add_competitor');
            const canEditPoints = can('dojo.edit_points');
            const canDeleteCompetitor = can('dojo.delete_competitor');
            const canAddMission = can('dojo.add_active_mission');
            const canEdit = canAddCompetitor || canEditPoints || canDeleteCompetitor || canAddMission;
            const addCompetitorBtn = canAddCompetitor ? `<button class="primary-btn w-auto" data-action="add-dojo-competitor">+ Adicionar Competidor</button>` : '';
            const addMissionBtn = canAddMission ? `<button class="primary-btn w-auto" data-action="add-dojo-mission">+ Adicionar Miss√£o</button>` : '';

            const sortedRanking = [...dojoRanking].sort((a, b) => b.points - a.points);

            contentArea.innerHTML = `
                <section id="dojo-section" class="bg-white p-6 rounded-xl shadow-sm border border-stone-200">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="text-xl font-bold text-stone-800">Ranking de Competidores</h3>
                        <div class="flex gap-3">
                            ${addCompetitorBtn}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-10 text-center">
                        <div class="p-4 rounded-lg border-2 border-stone-300 bg-stone-50 order-2 md:order-1 flex flex-col items-center justify-center">
                            <h4 class="font-bold text-lg text-amber-500 flex items-center justify-center gap-2 mb-2">
                                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="8" r="6" fill="#C0C0C0" stroke="#A8A8A8" stroke-width="2"/>
                                    <rect x="10" y="14" width="4" height="8" fill="#A8A8A8"/>
                                    <text x="12" y="10" text-anchor="middle" fill="#666666" font-size="8" font-weight="bold">2</text>
                                </svg>
                                2¬∫ Lugar
                            </h4>
                            <p class="text-stone-600 text-center">Alexa Echo Dot</p>
                        </div>
                        <div class="p-4 rounded-lg border-2 border-yellow-400 bg-yellow-50 transform md:scale-110 order-1 md:order-2 flex flex-col items-center justify-center">
                            <h4 class="font-bold text-lg text-yellow-500 flex items-center justify-center gap-2 mb-2">
                                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="8" r="6" fill="#FFD700" stroke="#DAA520" stroke-width="2"/>
                                    <rect x="10" y="14" width="4" height="8" fill="#DAA520"/>
                                    <text x="12" y="10" text-anchor="middle" fill="#DAA520" font-size="8" font-weight="bold">1</text>
                                </svg>
                                1¬∫ Lugar
                            </h4>
                            <p class="text-stone-700 font-semibold text-center">R$1.000,00</p>
                        </div>
                        <div class="p-4 rounded-lg border-2 border-amber-600 bg-stone-50 order-3 md:order-3 flex flex-col items-center justify-center">
                            <h4 class="font-bold text-lg text-amber-700 flex items-center justify-center gap-2 mb-2">
                                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="12" cy="8" r="6" fill="#CD7F32" stroke="#8B4513" stroke-width="2"/>
                                    <rect x="10" y="14" width="4" height="8" fill="#8B4513"/>
                                    <text x="12" y="10" text-anchor="middle" fill="#654321" font-size="8" font-weight="bold">3</text>
                                </svg>
                                3¬∫ Lugar
                            </h4>
                            <p class="text-stone-600 text-center">R$250,00</p>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Pos.</th>
                                    <th>Competidor</th>
                                    <th class="text-right">Pontos</th>
                                    ${canEdit ? '<th class="text-center">A√ß√µes</th>' : ''}
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedRanking.map((c, index) => {
                                    const medals = [
                                        `<svg class="inline-block w-4 h-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <circle cx="12" cy="8" r="6" fill="#FFD700" stroke="#DAA520" stroke-width="2"/>
                                            <rect x="10" y="14" width="4" height="8" fill="#DAA520"/>
                                            <text x="12" y="10" text-anchor="middle" fill="#DAA520" font-size="8" font-weight="bold">1</text>
                                        </svg>`,
                                        `<svg class="inline-block w-4 h-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <circle cx="12" cy="8" r="6" fill="#C0C0C0" stroke="#A8A8A8" stroke-width="2"/>
                                            <rect x="10" y="14" width="4" height="8" fill="#A8A8A8"/>
                                            <text x="12" y="10" text-anchor="middle" fill="#666666" font-size="8" font-weight="bold">2</text>
                                        </svg>`,
                                        `<svg class="inline-block w-4 h-4" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <circle cx="12" cy="8" r="6" fill="#CD7F32" stroke="#8B4513" stroke-width="2"/>
                                            <rect x="10" y="14" width="4" height="8" fill="#8B4513"/>
                                            <text x="12" y="10" text-anchor="middle" fill="#654321" font-size="8" font-weight="bold">3</text>
                                        </svg>`
                                    ];
                                    const medal = index < 3 ? `<span class="text-xl ml-2">${medals[index]}</span>` : '';
                                    return `
                                    <tr>
                                        <td class="font-bold text-stone-500 text-lg">#${index + 1}</td>
                                        <td class="flex items-center gap-3">
                                            <img src="${c.photo}" alt="${c.name}" class="w-10 h-10 rounded-full object-cover">
                                            <span class="font-medium">${c.name}</span>
                                            ${medal}
                                        </td>
                                        <td>
                                        </td>
                                        <td class="text-right font-mono font-semibold">${c.points || 0}</td>
                                        ${canEdit ? `
                                        <td class="text-center">
                                            <button class="secondary-btn" data-action="edit-dojo-competitor" data-id="${c.id}">Editar</button>
                                            <button class="danger-btn ml-2" data-action="delete-item" data-collection="dojo_ranking" data-id="${c.id}">X</button>
                                        </td>
                                        ` : ''}
                                    </tr>
                                `}).join('') || '<tr><td colspan="5" class="text-center py-10 text-stone-500">Nenhum competidor no Dojo.</td></tr>'}
                            </tbody>
                        </table>
                    </div>

                    <!-- Miss√µes Ativas Section -->
                    <div class="mt-12 pt-8 border-t border-stone-200">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-stone-800">Miss√µes Ativas</h3>
                            ${addMissionBtn}
                        </div>
                        <div id="dojo-missions-list" class="space-y-3">
                            ${dojoMissions.length > 0 ? dojoMissions.map(mission => `
                                <div class="base-card !p-4 flex justify-between items-center">
                                    <p class="font-medium text-stone-700 flex-1 pr-4">${mission.description}</p>
                                    <div class="flex items-center gap-4">
                                        <span class="font-bold text-lg text-yellow-500 whitespace-nowrap">${mission.points} pts</span>
                                        ${canEdit ? `<button class="danger-btn !text-xs !py-1 !px-2" data-action="delete-item" data-collection="dojo_missions" data-id="${mission.id}">Excluir</button>` : ''}
                                    </div>
                                </div>
                            `).join('') : '<div class="text-center p-8 bg-stone-50 rounded-lg"><p class="text-stone-500">Nenhuma miss√£o ativa no momento.</p></div>'}
                        </div>
                    </div>
                </section>
            `;
        }

        // --- RECHAMADA SECTION ---
        let currentRechamadaTeacherFilter = 'todos';
        
        // Helper: Verificar se rechamada est√° expirada (>6 meses da data de contato)
        function isRechamadaExpired(contactDate) {
            if (!contactDate) return false;
            
            const contact = new Date(contactDate);
            const today = new Date();
            const sixMonthsAgo = new Date(today);
            sixMonthsAgo.setMonth(today.getMonth() - 6);
            
            // Se a data de contato foi antes de 6 meses atr√°s, est√° expirada
            return contact < sixMonthsAgo;
        }
        
        function renderRechamadaSection() {
            document.getElementById('main-title').textContent = 'Rechamada';
            document.getElementById('main-description').textContent = 'Alunos com faltas consecutivas desde 01/10/2025 - Entre em contato para apoio.';
            
            const contentArea = document.getElementById('content-area');
            const cutoffDate = new Date('2025-10-01');
            
            // Fun√ß√£o para detectar faltas consecutivas
            function findConsecutiveAbsences(attendanceRecord, studentId) {
                const lessons = attendanceRecord?.lessons || {};
                const consecutiveAbsences = [];
                
                // Percorrer todas as aulas (1 a 40)
                for (let lessonNum = 1; lessonNum <= 40; lessonNum++) {
                    const currentLesson = lessons[lessonNum];
                    const nextLesson = lessons[lessonNum + 1];
                    
                    // Verificar se a aula atual tem data e √© >= 01/10/2025
                    if (!currentLesson?.date) continue;
                    const lessonDate = new Date(currentLesson.date);
                    if (lessonDate < cutoffDate) continue;
                    
                    // Verificar se o aluno faltou nesta aula
                    const currentStatus = currentLesson.students?.[studentId];
                    const nextStatus = nextLesson?.students?.[studentId];
                    
                    // Se faltou nesta aula E na pr√≥xima
                    if (currentStatus === 'F' && nextStatus === 'F') {
                        consecutiveAbsences.push({
                            firstLesson: lessonNum,
                            secondLesson: lessonNum + 1,
                            firstDate: currentLesson.date,
                            secondDate: nextLesson?.date || 'N/A'
                        });
                    }
                }
                
                return consecutiveAbsences;
            }
            
            // Coletar todas as rechamadas (uma para cada dupla de faltas consecutivas)
            const studentsWithConsecutiveAbsences = [];
            
            // Verificar VIPs
            vips.forEach(vip => {
                const student = students.find(s => s.id === vip.studentId);
                if (!student) return;
                
                const attendanceRecord = attendance.find(a => a.id === vip.id);
                const absences = findConsecutiveAbsences(attendanceRecord, student.id);
                
                // Tentar buscar professor do VIP, depois da grade
                let teacherName = vip.teacherName;
                if (!teacherName || teacherName.trim() === '') {
                    // Buscar na grade
                    const vipSchedule = schedules.find(s => s.student === student.name);
                    teacherName = vipSchedule?.teacher || 'N√£o especificado';
                }
                
                // Criar uma entrada separada para CADA dupla de faltas consecutivas
                absences.forEach(absence => {
                    studentsWithConsecutiveAbsences.push({
                        studentName: student.name,
                        studentId: student.id,
                        type: 'VIP',
                        typeName: 'VIP',
                        teacher: teacherName,
                        firstLesson: absence.firstLesson,
                        secondLesson: absence.secondLesson,
                        firstDate: absence.firstDate,
                        secondDate: absence.secondDate
                    });
                });
            });
            
            // Verificar Turmas
            turmas.forEach(turma => {
                const attendanceRecord = attendance.find(a => a.id === turma.id);
                
                // Para cada aluno da turma
                turma.studentIds?.forEach(studentId => {
                    const student = students.find(s => s.id === studentId);
                    if (!student) return;
                    
                    const absences = findConsecutiveAbsences(attendanceRecord, studentId);
                    
                    // Tentar buscar professor da Turma, depois da grade
                    let teacherName = turma.teacherName;
                    if (!teacherName || teacherName.trim() === '') {
                        // Buscar na grade usando o nome da turma
                        const turmaSchedule = schedules.find(s => s.turma === turma.name);
                        teacherName = turmaSchedule?.teacher || 'N√£o especificado';
                    }
                    
                    // Criar uma entrada separada para CADA dupla de faltas consecutivas
                    absences.forEach(absence => {
                        studentsWithConsecutiveAbsences.push({
                            studentName: student.name,
                            studentId: studentId,
                            type: 'TURMA',
                            typeName: turma.name || 'Turma sem nome',
                            teacher: teacherName,
                            firstLesson: absence.firstLesson,
                            secondLesson: absence.secondLesson,
                            firstDate: absence.firstDate,
                            secondDate: absence.secondDate
                        });
                    });
                });
            });
            
            // Filtrar por professor se selecionado OU se usu√°rio for professor (ver apenas seus alunos)
            let filteredStudents;
            
            if (currentUserRole === 'teacher') {
                // Professores veem apenas seus pr√≥prios alunos
                // Compara√ß√£o case-insensitive e trim para evitar problemas com espa√ßos
                filteredStudents = studentsWithConsecutiveAbsences.filter(s => {
                    const teacherName = (s.teacher || '').trim().toLowerCase();
                    const userName = (currentUserName || '').trim().toLowerCase();
                    return teacherName === userName;
                });
                
                // Debug: mostrar quantos alunos foram encontrados
                console.log(`Professor ${currentUserName} vendo ${filteredStudents.length} rechamadas de um total de ${studentsWithConsecutiveAbsences.length}`);
                if (filteredStudents.length === 0 && studentsWithConsecutiveAbsences.length > 0) {
                    console.log('Professores dispon√≠veis:', [...new Set(studentsWithConsecutiveAbsences.map(s => s.teacher))]);
                }
            } else {
                // Admin, pedag√≥gico, ap, am podem filtrar
                filteredStudents = currentRechamadaTeacherFilter === 'todos' 
                    ? studentsWithConsecutiveAbsences 
                    : studentsWithConsecutiveAbsences.filter(s => {
                        const teacherName = (s.teacher || '').trim().toLowerCase();
                        const filterName = (currentRechamadaTeacherFilter || '').trim().toLowerCase();
                        return teacherName === filterName;
                    });
            }
            
            // Ordenar por data da primeira falta (mais recente primeiro)
            filteredStudents.sort((a, b) => new Date(b.firstDate) - new Date(a.firstDate));
            
            // Lista √∫nicalha de professores
            const uniqueTeachers = [...new Set(studentsWithConsecutiveAbsences.map(s => s.teacher))].filter(t => t && t !== 'N√£o especificado').sort();
            
            contentArea.innerHTML = `
                <section id="rechamada-section">
                    <div class="mb-6 space-y-3">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <p class="text-sm text-yellow-800">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                <strong>Aten√ß√£o:</strong> Esta lista mostra alunos que faltaram em aulas <strong>consecutivas</strong> (ex: aula 3 e aula 4) desde 01/10/2025.
                            </p>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-sm text-blue-800">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <strong>Informa√ß√£o:</strong> Rechamadas registradas desaparecem automaticamente ap√≥s <strong>6 meses</strong> da data do contato.
                            </p>
                        </div>
                    </div>
                    
                    ${uniqueTeachers.length > 0 && currentUserRole !== 'teacher' ? `
                        <div class="mb-6 flex items-center gap-4">
                            <label class="text-sm font-semibold text-stone-700">Filtrar por professor:</label>
                            <select 
                                id="rechamada-teacher-filter" 
                                class="form-input !w-auto min-w-[200px]"
                                onchange="currentRechamadaTeacherFilter = this.value; renderRechamadaSection();"
                            >
                                <option value="todos" ${currentRechamadaTeacherFilter === 'todos' ? 'selected' : ''}>Todos os professores</option>
                                ${uniqueTeachers.map(teacher => 
                                    `<option value="${teacher}" ${currentRechamadaTeacherFilter === teacher ? 'selected' : ''}>${teacher}</option>`
                                ).join('')}
                            </select>
                            ${currentRechamadaTeacherFilter !== 'todos' ? `
                                <button 
                                    onclick="currentRechamadaTeacherFilter = 'todos'; renderRechamadaSection();"
                                    class="text-sm text-blue-600 hover:text-blue-800 underline"
                                >
                                    Limpar filtro
                                </button>
                            ` : ''}
                        </div>
                    ` : ''}
                    
                    ${currentUserRole === 'teacher' ? `
                        <div class="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-sm text-blue-800">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Voc√™ est√° vendo apenas os alunos sob sua responsabilidade.
                            </p>
                        </div>
                    ` : ''}
                    
                    <div class="mb-4">
                        <h3 class="text-lg font-bold text-stone-800">
                            ${filteredStudents.length} rechamada${filteredStudents.length !== 1 ? 's' : ''} necess√°ria${filteredStudents.length !== 1 ? 's' : ''}
                            ${currentRechamadaTeacherFilter !== 'todos' ? `<span class="text-blue-600"> (filtrado por ${currentRechamadaTeacherFilter})</span>` : ''}
                        </h3>
                        <p class="text-sm text-stone-500 mt-1">Cada linha representa uma dupla de faltas consecutivas que requer contato.</p>
                    </div>
                    
                    ${filteredStudents.length === 0 ? `
                        <div class="text-center p-12 bg-stone-50 rounded-lg">
                            <svg class="w-16 h-16 mx-auto mb-4 text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <p class="text-stone-500 text-lg font-semibold">Nenhuma rechamada necess√°ria${currentRechamadaTeacherFilter !== 'todos' ? ' para este professor' : ''}!</p>
                            <p class="text-stone-400 text-sm mt-2">Todos os alunos est√£o com boa frequ√™ncia.</p>
                        </div>
                    ` : `
                        <div class="overflow-x-auto">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Aluno</th>
                                        <th>Modalidade</th>
                                        <th>Professor</th>
                                        <th>Aulas Faltadas</th>
                                        <th>Datas</th>
                                        <th class="text-center">Status / A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${filteredStudents.map(item => {
                                        // Criar ID √∫nico para esta rechamada espec√≠fica (aluno + aulas)
                                        const rechamadaKey = `${item.studentId}_${item.firstLesson}_${item.secondLesson}`;
                                        
                                        // Buscar rechamada existente que N√ÉO esteja expirada (>6 meses)
                                        const existingRechamada = rechamadas.find(r => 
                                            r.studentId === item.studentId && 
                                            r.lessons === `${item.firstLesson}+${item.secondLesson}` &&
                                            !isRechamadaExpired(r.contactDate)
                                        );
                                        
                                        return `
                                        <tr>
                                            <td class="font-semibold">${item.studentName}</td>
                                            <td>
                                                <span class="inline-block px-2 py-1 text-xs rounded font-semibold ${item.type === 'VIP' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}">
                                                    ${item.typeName}
                                                </span>
                                            </td>
                                            <td>${item.teacher}</td>
                                            <td class="text-center">
                                                <span class="font-semibold text-red-600">
                                                    Aula ${item.firstLesson} + ${item.secondLesson}
                                                </span>
                                            </td>
                                            <td class="text-sm text-stone-600">
                                                ${formatDateBR(item.firstDate)} <span class="text-stone-400">e</span> ${formatDateBR(item.secondDate)}
                                            </td>
                                            <td class="text-center">
                                                ${existingRechamada ? `
                                                    <div class="text-sm">
                                                        <div class="inline-block px-3 py-1 rounded-full bg-green-100 text-green-700 font-semibold mb-2">
                                                            ‚úì Rechamada feita
                                                        </div>
                                                        <div class="text-stone-600">
                                                            <span class="font-semibold">Data:</span> ${formatDateBR(existingRechamada.contactDate)}
                                                        </div>
                                                        <button 
                                                            data-action="ver-detalhes-rechamada"
                                                            data-rechamada-id="${existingRechamada.id}"
                                                            class="text-blue-600 hover:text-blue-800 text-xs underline mt-1"
                                                        >
                                                            Ver/Editar
                                                        </button>
                                                    </div>
                                                ` : `
                                                    <button 
                                                        data-action="fazer-rechamada"
                                                        data-student-id="${item.studentId}"
                                                        data-student-name="${item.studentName}"
                                                        data-teacher-name="${item.teacher}"
                                                        data-lessons="${item.firstLesson}+${item.secondLesson}"
                                                        data-first-date="${item.firstDate}"
                                                        data-second-date="${item.secondDate}"
                                                        class="primary-btn !py-2 !px-4 text-sm w-auto flex items-center gap-2"
                                                    >
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                                                        </svg>
                                                        Fazer Rechamada
                                                    </button>
                                                `}
                                            </td>
                                        </tr>
                                    `}).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </section>
            `;
        }

        // --- Fun√ß√µes auxiliares de Rechamada ---
        function openRechamadaModal(studentId, studentName, teacherName, lessons, firstDate, secondDate) {
            clearModalHeaderButtons();
            
            // Buscar lista de professores
            const teachers = collaborators.filter(c => c.role === 'teacher' || c.role === 'pedagogico' || c.role === 'ap' || c.role === 'am');
            const teacherOptions = teachers.map(t => 
                `<option value="${t.name}" ${t.name === currentUserName ? 'selected' : ''}>${t.name}</option>`
            ).join('');
            
            document.getElementById('form-modal-title').textContent = 'Registrar Rechamada';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="rechamada-form" class="space-y-4">
                    <input type="hidden" id="rechamada-student-id" value="${studentId}">
                    <input type="hidden" id="rechamada-student-name" value="${studentName}">
                    <input type="hidden" id="rechamada-lessons" value="${lessons}">
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <p class="text-sm text-blue-800">
                            <strong>Aluno:</strong> ${studentName}<br>
                            <strong>Professor do aluno:</strong> ${teacherName}<br>
                            <strong>Faltas:</strong> Aulas ${lessons} (${formatDateBR(firstDate)} e ${formatDateBR(secondDate)})
                        </p>
                    </div>
                    
                    <div>
                        <label class="font-medium text-sm">Quem fez a rechamada? *</label>
                        <select id="rechamada-responsible" class="form-input" required>
                            <option value="">-- Selecione --</option>
                            ${teacherOptions}
                        </select>
                    </div>
                    
                    <div>
                        <label class="font-medium text-sm">Data do Contato *</label>
                        <input type="date" id="rechamada-date" class="form-input" value="${new Date().toISOString().split('T')[0]}" required>
                    </div>
                    
                    <div>
                        <label class="font-medium text-sm">O que o aluno disse? *</label>
                        <textarea id="rechamada-notes" rows="6" class="form-input" placeholder="Descreva a conversa com o aluno, motivo das faltas, como est√° se sentindo, se precisa de ajuda, etc..." required></textarea>
                    </div>
                    
                    <div class="flex justify-end gap-2 pt-4 border-t">
                        <button type="button" class="secondary-btn" onclick="closeFormModal()">Cancelar</button>
                        <button type="submit" class="primary-btn w-auto">Salvar Rechamada</button>
                    </div>
                </form>
            `;
            
            document.getElementById('rechamada-form').onsubmit = async (e) => {
                e.preventDefault();
                await saveRechamada();
            };
            
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveRechamada() {
            const studentId = document.getElementById('rechamada-student-id').value;
            const studentName = document.getElementById('rechamada-student-name').value;
            const lessons = document.getElementById('rechamada-lessons').value;
            const contactDate = document.getElementById('rechamada-date').value;
            const notes = document.getElementById('rechamada-notes').value;
            const responsibleTeacher = document.getElementById('rechamada-responsible').value;
            
            if (!contactDate || !notes || !responsibleTeacher) {
                showErrorMessage("Erro", "Preencha todos os campos obrigat√≥rios.");
                return;
            }
            
            const rechamadaData = {
                studentId,
                studentName,
                lessons,
                contactDate,
                notes,
                responsibleTeacher,
                createdBy: currentUserName,
                createdAt: new Date(),
                timestamp: serverTimestamp()
            };
            
            try {
                if (db) {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/rechamadas`), rechamadaData);
                } else {
                    rechamadas.push({ id: Date.now().toString(), ...rechamadaData });
                    localStorage.setItem('rechamadas', JSON.stringify(rechamadas));
                }
                
                // Log activity
                await logActivity('criar', 'rechamada', studentName, { data: contactDate });
                
                closeFormModal();
                showSuccessMessage("Sucesso!", "Rechamada registrada com sucesso.");
                renderRechamadaSection();
            } catch (error) {
                console.error("Erro ao salvar rechamada:", error);
                showErrorMessage("Erro", "Erro ao salvar rechamada: " + error.message);
            }
        }

        function viewRechamadaDetails(rechamadaId) {
            const rechamada = rechamadas.find(r => r.id === rechamadaId);
            if (!rechamada) {
                showErrorMessage("Erro", "Rechamada n√£o encontrada.");
                return;
            }
            
            clearModalHeaderButtons();
            document.getElementById('form-modal-title').textContent = 'Detalhes da Rechamada';
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-4">
                    <div>
                        <p class="text-sm font-semibold text-stone-700">Aluno</p>
                        <p class="text-lg">${rechamada.studentName}</p>
                    </div>
                    
                    ${rechamada.lessons ? `
                        <div class="bg-red-50 border border-red-200 rounded-lg p-3">
                            <p class="text-sm font-semibold text-red-700">Faltas Consecutivas</p>
                            <p class="text-lg text-red-800 font-bold">Aulas ${rechamada.lessons}</p>
                        </div>
                    ` : ''}
                    
                    <div>
                        <p class="text-sm font-semibold text-stone-700">Quem fez a rechamada</p>
                        <p class="text-lg">${rechamada.responsibleTeacher || 'N√£o informado'}</p>
                    </div>
                    
                    <div>
                        <p class="text-sm font-semibold text-stone-700">Data do Contato</p>
                        <p class="text-lg">${formatDateBR(rechamada.contactDate)}</p>
                    </div>
                    
                    <div>
                        <p class="text-sm font-semibold text-stone-700">Observa√ß√µes</p>
                        <p class="text-stone-600">${rechamada.notes}</p>
                    </div>
                    
                    <div class="text-sm text-stone-500 border-t pt-4">
                        <p>Registrado por: <strong>${rechamada.createdBy}</strong></p>
                        <p>Em: ${rechamada.createdAt ? formatDateBR(rechamada.createdAt instanceof Date ? rechamada.createdAt.toISOString().split('T')[0] : rechamada.createdAt.toDate().toISOString().split('T')[0]) : 'N/A'}</p>
                        ${rechamada.updatedAt ? `
                            <p class="mt-2 text-orange-600">
                                <strong>Editado por:</strong> ${rechamada.updatedBy || 'N/A'}<br>
                                <strong>Em:</strong> ${formatDateBR(rechamada.updatedAt instanceof Date ? rechamada.updatedAt.toISOString().split('T')[0] : rechamada.updatedAt.toDate().toISOString().split('T')[0])}
                            </p>
                        ` : ''}
                    </div>
                    
                    <div class="flex justify-end gap-2 pt-4 border-t">
                        <button class="secondary-btn" onclick="closeFormModal()">Fechar</button>
                        <button 
                            data-action="editar-rechamada"
                            data-student-id="${rechamada.studentId}"
                            data-student-name="${rechamada.studentName}"
                            data-rechamada-id="${rechamada.id}"
                            class="primary-btn w-auto"
                        >
                            Editar
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('form-modal').classList.add('visible');
        }

        function editRechamada(studentId, studentName, rechamadaId) {
            const rechamada = rechamadas.find(r => r.id === rechamadaId);
            if (!rechamada) {
                showErrorMessage("Erro", "Rechamada n√£o encontrada.");
                return;
            }
            
            // Buscar lista de professores
            const teachers = collaborators.filter(c => c.role === 'teacher' || c.role === 'pedagogico' || c.role === 'ap' || c.role === 'am');
            const teacherOptions = teachers.map(t => 
                `<option value="${t.name}" ${t.name === rechamada.responsibleTeacher ? 'selected' : ''}>${t.name}</option>`
            ).join('');
            
            clearModalHeaderButtons();
            document.getElementById('form-modal-title').textContent = 'Editar Rechamada';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="edit-rechamada-form" class="space-y-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <p class="text-sm text-blue-800">
                            <strong>Aluno:</strong> ${studentName}
                        </p>
                    </div>
                    
                    <div>
                        <label class="font-medium text-sm">Quem fez a rechamada? *</label>
                        <select id="edit-rechamada-responsible" class="form-input" required>
                            <option value="">-- Selecione --</option>
                            ${teacherOptions}
                        </select>
                    </div>
                    
                    <div>
                        <label class="font-medium text-sm">Data do Contato *</label>
                        <input type="date" id="edit-rechamada-date" class="form-input" value="${rechamada.contactDate}" required>
                    </div>
                    
                    <div>
                        <label class="font-medium text-sm">O que o aluno disse? *</label>
                        <textarea id="edit-rechamada-notes" rows="6" class="form-input" placeholder="Descreva a conversa com o aluno..." required>${rechamada.notes}</textarea>
                    </div>
                    
                    <div class="flex justify-end gap-2 pt-4 border-t">
                        <button type="button" class="secondary-btn" onclick="closeFormModal()">Cancelar</button>
                        <button type="submit" class="primary-btn w-auto">Salvar Altera√ß√µes</button>
                    </div>
                </form>
            `;
            
            document.getElementById('edit-rechamada-form').onsubmit = async (e) => {
                e.preventDefault();
                await updateRechamada(rechamadaId, studentName);
            };
            
            document.getElementById('form-modal').classList.add('visible');
        }

        async function updateRechamada(rechamadaId, studentName) {
            const contactDate = document.getElementById('edit-rechamada-date').value;
            const notes = document.getElementById('edit-rechamada-notes').value;
            const responsibleTeacher = document.getElementById('edit-rechamada-responsible').value;
            
            if (!contactDate || !notes || !responsibleTeacher) {
                showErrorMessage("Erro", "Preencha todos os campos obrigat√≥rios.");
                return;
            }
            
            const updatedData = {
                contactDate,
                notes,
                responsibleTeacher,
                updatedBy: currentUserName,
                updatedAt: new Date()
            };
            
            try {
                if (db) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/rechamadas`, rechamadaId), updatedData);
                } else {
                    const index = rechamadas.findIndex(r => r.id === rechamadaId);
                    if (index !== -1) {
                        rechamadas[index] = { ...rechamadas[index], ...updatedData };
                        localStorage.setItem('rechamadas', JSON.stringify(rechamadas));
                    }
                }
                
                // Log activity
                await logActivity('editar', 'rechamada', studentName, { data: contactDate });
                
                closeFormModal();
                showSuccessMessage("Sucesso!", "Rechamada atualizada com sucesso.");
                renderRechamadaSection();
            } catch (error) {
                console.error("Erro ao atualizar rechamada:", error);
                showErrorMessage("Erro", "Erro ao atualizar rechamada: " + error.message);
            }
        }

        function renderKPIsPedagogicoSection() {
            document.getElementById('main-title').textContent = 'KPIs Pedag√≥gico';
            document.getElementById('main-description').textContent = 'M√©tricas e indicadores pedag√≥gicos para acompanhamento.';

            // C√°lculos dos KPIs
            const activeStudents = students.filter(s => s.status === 'Ativo');
            const maleCount = activeStudents.filter(s => s.gender === 'Masculino').length;
            const femaleCount = activeStudents.filter(s => s.gender === 'Feminino').length;
            const studentsInTurmas = activeStudents.filter(s => s.modalidade === 'TURMA').length;
            const studentsInVIP = activeStudents.filter(s => s.modalidade === 'VIP' || s.modalidade === 'DUPLA').length;
            const totalTurmas = turmas.length;

            // Calcular idade m√©dia dos alunos
            const studentsWithBirthdate = students.filter(s => s.birthDate);
            let averageAge = 0;
            if (studentsWithBirthdate.length > 0) {
                const ages = studentsWithBirthdate.map(s => {
                    const birthDate = new Date(s.birthDate);
                    const today = new Date();
                    let age = today.getFullYear() - birthDate.getFullYear();
                    const monthDiff = today.getMonth() - birthDate.getMonth();
                    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                        age--;
                    }
                    return age;
                });
                averageAge = ages.reduce((sum, age) => sum + age, 0) / ages.length;
            }

            // Contar professores ativos (professores √∫nicos nos schedules da GRADE)
            const uniqueProfessors = [...new Set(schedules.map(s => s.teacher))].filter(p => p && p.trim() !== '');
            const totalProfessors = uniqueProfessors.length;

            // Calcular alunos por professor USANDO A GRADE como fonte da verdade
            const teachersMap = new Map();
            
            // Percorrer todos os hor√°rios da grade (exceto breaks)
            schedules.forEach(schedule => {
                if (schedule.type === 'break' || !schedule.teacher || !schedule.student) return;
                
                if (!teachersMap.has(schedule.teacher)) {
                    teachersMap.set(schedule.teacher, { 
                        vipStudents: new Set(), 
                        turmaStudents: new Set(),
                        vipCount: 0,
                        turmaCount: 0
                    });
                }
                
                const teacherData = teachersMap.get(schedule.teacher);
                
                if (schedule.type === 'vip' || schedule.type === 'dupla') {
                    // Para VIPs e DUPLAS, adicionar o aluno √∫nico ao Set
                    teacherData.vipStudents.add(schedule.student);
                } else if (schedule.type === 'turma') {
                    // Para turmas, encontrar a turma e adicionar seus alunos ao Set
                    const turma = turmas.find(t => t.name === schedule.student);
                    if (turma && turma.studentIds) {
                        turma.studentIds.forEach(studentId => {
                            teacherData.turmaStudents.add(studentId);
                        });
                    }
                }
            });
            
            // Contar VIPs e Turmas √∫nicos por professor
            teachersMap.forEach((data, teacher) => {
                // Contar VIPs √∫nicos (quantidade de alunos VIP distintos)
                data.vipCount = data.vipStudents.size;
                
                // Contar Turmas √∫nicas
                const teacherTurmas = new Set();
                schedules.forEach(schedule => {
                    if (schedule.teacher === teacher && schedule.type === 'turma') {
                        teacherTurmas.add(schedule.student);
                    }
                });
                data.turmaCount = teacherTurmas.size;
            });
            
            // Converter para array e ordenar por total de alunos
            const teacherStats = Array.from(teachersMap.entries())
                .map(([name, data]) => ({
                    name,
                    vipStudents: data.vipStudents.size, // Total de alunos VIP √∫nicos
                    turmaStudents: data.turmaStudents.size, // Total de alunos em turmas √∫nicos
                    vipCount: data.vipCount, // Quantidade de VIPs
                    turmaCount: data.turmaCount, // Quantidade de turmas
                    total: data.vipStudents.size + data.turmaStudents.size
                }))
                .sort((a, b) => b.total - a.total);

            // Calcular assiduidade m√©dia geral (VIPs + Turmas) - m√©dia ponderada
            let totalLessonsGlobal = 0;
            let totalPresentGlobal = 0;
            
            // Incluir VIPs com PEF
            vips.forEach(vip => {
                const student = students.find(s => s.id === vip.studentId);
                // Match attendance by id (VIP attendance records use vip.id as their id)
                const unitAttendance = attendance.find(a => a.id === vip.id);
                if (unitAttendance && unitAttendance.lessons && student) {
                    for (let i = 1; i <= 40; i++) {
                        const lessonData = unitAttendance.lessons[i];
                        if (lessonData && lessonData.date && lessonData.students && lessonData.students[student.id]) {
                            totalLessonsGlobal++;
                            const status = lessonData.students[student.id];
                            if (status === 'P') {
                                totalPresentGlobal++;
                            } else if (status === 'PP') {
                                totalPresentGlobal += 0.5; // Presen√ßa parcial conta como 0.5
                            }
                        }
                    }
                }
            });
            
            // Incluir turmas com PEF
            turmas.forEach(turma => {
                if (turma.studentIds && turma.studentIds.length > 0) {
                    const unitAttendance = attendance.find(a => a.id === turma.id);
                    if (unitAttendance && unitAttendance.lessons) {
                        turma.studentIds.forEach(studentId => {
                            for (let i = 1; i <= 40; i++) {
                                const lessonData = unitAttendance.lessons[i];
                                if (lessonData && lessonData.students && lessonData.students[studentId]) {
                                    totalLessonsGlobal++;
                                    const status = lessonData.students[studentId];
                                    if (status === 'P') {
                                        totalPresentGlobal++;
                                    } else if (status === 'PP') {
                                        totalPresentGlobal += 0.5; // Presen√ßa parcial conta como 0.5
                                    }
                                }
                            }
                        });
                    }
                }
            });
            
            const avgAttendance = totalLessonsGlobal > 0 ? (totalPresentGlobal / totalLessonsGlobal) * 100 : 0;

            // Calcular m√©dias de notas (midterm, listening, grammar, oral) das notas registradas em VIPs e Turmas
            const allGrades = [];
            
            // Coletar notas dos VIPs
            vips.forEach(vip => {
                if (vip.grades) {
                    allGrades.push(vip.grades);
                }
            });
            
            // Coletar notas das Turmas (studentGrades)
            turmas.forEach(turma => {
                if (turma.studentGrades) {
                    Object.values(turma.studentGrades).forEach(grades => {
                        allGrades.push(grades);
                    });
                }
            });
            
            let avgMidterm = 0;
            let avgListening = 0;
            let avgGrammar = 0;
            let avgOral = 0;
            
            if (allGrades.length > 0) {
                const midtermScores = allGrades.filter(g => g.midtermTest > 0).map(g => g.midtermTest);
                const listeningScores = allGrades.filter(g => g.listeningTest > 0).map(g => g.listeningTest);
                const grammarScores = allGrades.filter(g => g.grammarTest > 0).map(g => g.grammarTest);
                const oralScores = allGrades.filter(g => g.oralTest > 0).map(g => g.oralTest);
                
                avgMidterm = midtermScores.length > 0 ? midtermScores.reduce((sum, score) => sum + score, 0) / midtermScores.length : 0;
                avgListening = listeningScores.length > 0 ? listeningScores.reduce((sum, score) => sum + score, 0) / listeningScores.length : 0;
                avgGrammar = grammarScores.length > 0 ? grammarScores.reduce((sum, score) => sum + score, 0) / grammarScores.length : 0;
                avgOral = oralScores.length > 0 ? oralScores.reduce((sum, score) => sum + score, 0) / oralScores.length : 0;
            }

            // Calcular % de presen√ßa e faltas por VIP conectado √†s PEFs
            // Filtrar VIPs ativos e com student v√°lido, removendo duplicatas
            const vipAttendanceData = vips
                .filter(vip => {
                    // Verificar se tem student v√°lido
                    const student = students.find(s => s.id === vip.studentId);
                    return student && student.status === 'Ativo';
                })
                .reduce((uniqueVips, vip) => {
                    // Remover duplicatas baseado em studentId
                    const existingIndex = uniqueVips.findIndex(v => v.studentId === vip.studentId);
                    if (existingIndex === -1) {
                        uniqueVips.push(vip);
                    } else {
                        // Se j√° existe, manter o VIP n√£o finalizado ou o mais recente
                        const existing = uniqueVips[existingIndex];
                        if (vip.status !== 'finalizada' && existing.status === 'finalizada') {
                            uniqueVips[existingIndex] = vip;
                        }
                    }
                    return uniqueVips;
                }, [])
                .map(vip => {
                    const student = students.find(s => s.id === vip.studentId);
                    // Match attendance by id (VIP attendance records use vip.id as their id)
                    const unitAttendance = attendance.find(a => a.id === vip.id);
                    
                    let totalLessons = 0;
                    let presentCount = 0;
                    let absentCount = 0;
                    
                    // Buscar dados de presen√ßa das PEFs do VIP
                    if (unitAttendance && unitAttendance.lessons && student) {
                        for (let i = 1; i <= 40; i++) {
                            const lessonData = unitAttendance.lessons[i];
                            // VIP lessons: verificar se tem data registrada (aula realizada)
                            if (lessonData && lessonData.date && lessonData.students && lessonData.students[student.id]) {
                                totalLessons++;
                                const status = lessonData.students[student.id];
                                if (status === 'P') {
                                    presentCount++;
                                } else if (status === 'PP') {
                                    presentCount += 0.5; // Presen√ßa parcial conta como 0.5
                                } else if (status === 'F') {
                                    absentCount++;
                                }
                            }
                        }
                    }
                    
                    const presencePercentage = totalLessons > 0 ? (presentCount / totalLessons) * 100 : 0;
                    const absencePercentage = totalLessons > 0 ? (absentCount / totalLessons) * 100 : 0;
                    
                    return {
                        name: student.name,
                        teacherName: vip.teacherName || 'Sem professor',
                        level: vip.level || 'N/A',
                        presencePercentage: presencePercentage,
                        absencePercentage: absencePercentage,
                        totalLessons: totalLessons,
                        hasPef: totalLessons > 0
                    };
                })
                .sort((a, b) => {
                    // Ordenar: primeiro os que t√™m PEF (por presen√ßa), depois os sem PEF
                    if (a.hasPef && !b.hasPef) return -1;
                    if (!a.hasPef && b.hasPef) return 1;
                    return b.presencePercentage - a.presencePercentage;
                });

            // Calcular % de presen√ßa e faltas por turma
            const turmaAttendanceData = turmas.map(turma => {
                if (!turma.studentIds || turma.studentIds.length === 0) {
                    return { 
                        name: turma.name, 
                        teacherName: turma.teacherName || 'Sem professor',
                        presencePercentage: 0, 
                        absencePercentage: 0, 
                        totalLessons: 0 
                    };
                }
                
                const unitAttendance = attendance.find(a => a.id === turma.id);
                let totalLessons = 0;
                let totalPresent = 0;
                let totalAbsent = 0;
                
                if (unitAttendance && unitAttendance.lessons) {
                    turma.studentIds.forEach(studentId => {
                        for (let i = 1; i <= 40; i++) {
                            const lessonData = unitAttendance.lessons[i];
                            if (lessonData && lessonData.students && lessonData.students[studentId]) {
                                totalLessons++;
                                const status = lessonData.students[studentId];
                                if (status === 'P' || status === 'PP') {
                                    totalPresent++;
                                } else if (status === 'F') {
                                    totalAbsent++;
                                }
                            }
                        }
                    });
                }
                
                const presencePercentage = totalLessons > 0 ? (totalPresent / totalLessons) * 100 : 0;
                const absencePercentage = totalLessons > 0 ? (totalAbsent / totalLessons) * 100 : 0;
                
                return {
                    name: turma.name,
                    teacherName: turma.teacherName || 'Sem professor',
                    presencePercentage: presencePercentage,
                    absencePercentage: absencePercentage,
                    totalLessons: totalLessons
                };
            }).filter(t => t.totalLessons > 0).sort((a, b) => b.presencePercentage - a.presencePercentage);

            contentArea.innerHTML = `
                <section id="kpis-section" class="base-card">
                    <!-- Cards de Estat√≠sticas R√°pidas -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Alunos em Turmas -->
                        <div class="bg-gradient-to-br from-stone-50 to-stone-100 p-6 rounded-lg border border-stone-200 transition-all hover:border-[#F1D24B]">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-stone-700 uppercase tracking-wide">Alunos em Turmas</h3>
                                <svg class="w-8 h-8 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                </svg>
                            </div>
                            <p class="text-4xl font-bold text-stone-800">${studentsInTurmas}</p>
                            <p class="text-xs text-stone-600 mt-1">Alunos ativos</p>
                        </div>

                        <!-- Alunos VIP -->
                        <div class="bg-gradient-to-br from-stone-50 to-stone-100 p-6 rounded-lg border border-stone-200 transition-all hover:border-[#F1D24B]">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-stone-700 uppercase tracking-wide">Alunos VIP</h3>
                                <svg class="w-8 h-8 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
                                </svg>
                            </div>
                            <p class="text-4xl font-bold text-stone-800">${studentsInVIP}</p>
                            <p class="text-xs text-stone-600 mt-1">Alunos ativos</p>
                        </div>

                        <!-- Total de Turmas -->
                        <div class="bg-gradient-to-br from-stone-50 to-stone-100 p-6 rounded-lg border border-stone-200 transition-all hover:border-[#F1D24B]">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-stone-700 uppercase tracking-wide">Total de Turmas</h3>
                                <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                                </svg>
                            </div>
                            <p class="text-4xl font-bold text-stone-800">${totalTurmas}</p>
                            <p class="text-xs text-stone-600 mt-1">Turmas cadastradas</p>
                        </div>

                        <!-- Idade M√©dia dos Alunos -->
                        <div class="bg-gradient-to-br from-stone-50 to-stone-100 p-6 rounded-lg border border-stone-200 transition-all hover:border-[#F1D24B]">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-stone-700 uppercase tracking-wide">Idade M√©dia</h3>
                                <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <p class="text-4xl font-bold text-stone-800">${averageAge > 0 ? averageAge.toFixed(1) : '0'}</p>
                            <p class="text-xs text-stone-600 mt-1">Anos (m√©dia dos alunos)</p>
                        </div>

                        <!-- Distribui√ß√£o por G√™nero -->
                        <div class="bg-gradient-to-br from-stone-50 to-stone-100 p-6 rounded-lg border border-stone-200 transition-all hover:border-[#F1D24B]">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-stone-700 uppercase tracking-wide">Distribui√ß√£o por G√™nero</h3>
                                <svg class="w-8 h-8 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                </svg>
                            </div>
                            <div class="flex items-center justify-between mt-4">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                                        <span class="text-xs text-stone-600">Masculino</span>
                                    </div>
                                    <p class="text-2xl font-bold text-stone-800">${activeStudents.length > 0 ? (maleCount / activeStudents.length * 100).toFixed(1) : 0}%</p>
                                    <p class="text-xs text-stone-500 mt-1">${maleCount} ${maleCount === 1 ? 'aluno' : 'alunos'}</p>
                                </div>
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <div class="w-3 h-3 rounded-full bg-pink-500"></div>
                                        <span class="text-xs text-stone-600">Feminino</span>
                                    </div>
                                    <p class="text-2xl font-bold text-stone-800">${activeStudents.length > 0 ? (femaleCount / activeStudents.length * 100).toFixed(1) : 0}%</p>
                                    <p class="text-xs text-stone-500 mt-1">${femaleCount} ${femaleCount === 1 ? 'aluna' : 'alunas'}</p>
                                </div>
                            </div>
                            <div class="mt-3 flex gap-2">
                                <div class="flex-1 bg-blue-500 h-2 rounded-full" style="width: ${activeStudents.length > 0 ? (maleCount / activeStudents.length * 100).toFixed(1) : 0}%"></div>
                                <div class="flex-1 bg-pink-500 h-2 rounded-full" style="width: ${activeStudents.length > 0 ? (femaleCount / activeStudents.length * 100).toFixed(1) : 0}%"></div>
                            </div>
                        </div>

                        <!-- Assiduidade M√©dia Geral -->
                        <div class="bg-gradient-to-br from-stone-50 to-stone-100 p-6 rounded-lg border border-stone-200 transition-all hover:border-[#F1D24B]">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-sm font-medium text-stone-700 uppercase tracking-wide">Assiduidade M√©dia Geral</h3>
                                <svg class="w-8 h-8 text-teal-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <p class="text-4xl font-bold text-stone-800">${avgAttendance.toFixed(1)}%</p>
                            <p class="text-xs text-stone-600 mt-1">VIPs + Turmas</p>
                            ${totalLessonsGlobal > 0 ? `<div class="mt-2 w-full bg-stone-200 rounded-full h-2">
                                <div class="bg-teal-500 h-2 rounded-full" style="width: ${Math.min(100, avgAttendance)}%"></div>
                            </div>` : ''}
                        </div>
                    </div>

                    <!-- Tabelas de Assiduidade -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Assiduidade por VIP -->
                        <div class="bg-white p-6 rounded-lg border border-stone-200">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-stone-800">Assiduidade VIP</h3>
                                ${vipAttendanceData.length > 0 ? `
                                <div class="relative w-64">
                                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                    <input 
                                        type="text" 
                                        id="vip-attendance-search" 
                                        placeholder="Buscar VIP ou professor..." 
                                        class="w-full pl-10 pr-4 py-2 text-sm border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#F1D24B] focus:border-transparent"
                                        oninput="filterVipAttendance(this.value)"
                                    >
                                </div>
                                ` : ''}
                            </div>
                            <div id="vip-attendance-container" style="max-height: 300px; overflow-y: auto;">
                                ${vipAttendanceData.length > 0 ? `
                                    <div class="space-y-3">
                                        ${vipAttendanceData.map(vip => `
                                            <div class="p-3 ${vip.hasPef ? 'bg-stone-50' : 'bg-yellow-50'} rounded-lg border ${vip.hasPef ? 'border-stone-200' : 'border-yellow-200'} vip-attendance-card" data-vip-name="${vip.name.toLowerCase()}" data-vip-teacher="${vip.teacherName.toLowerCase()}">
                                                <div class="flex items-start justify-between mb-2">
                                                    <div>
                                                        <p class="text-sm font-medium text-stone-700">${vip.name}</p>
                                                        <div class="flex items-center gap-2 mt-1">
                                                            <div class="flex items-center gap-1">
                                                                <svg class="w-3 h-3 text-stone-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                                                </svg>
                                                                <span class="text-xs text-stone-600">${vip.teacherName}</span>
                                                            </div>
                                                            <span class="text-xs text-stone-600">‚Ä¢ ${vip.level}</span>
                                                        </div>
                                                    </div>
                                                    ${vip.hasPef ? 
                                                        `<span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full font-medium">${vip.totalLessons} aulas</span>` : 
                                                        `<span class="text-xs px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full font-medium">Sem PEF</span>`
                                                    }
                                                </div>
                                                ${vip.hasPef ? `
                                                    <div class="flex items-center gap-4 mt-2">
                                                        <div class="flex-1">
                                                            <div class="flex items-center justify-between text-xs mb-1">
                                                                <span class="text-green-600 font-medium">Presen√ßa</span>
                                                                <span class="text-green-700 font-bold">${vip.presencePercentage.toFixed(1)}%</span>
                                                            </div>
                                                            <div class="w-full bg-stone-200 rounded-full h-2">
                                                                <div class="bg-green-500 h-2 rounded-full" style="width: ${vip.presencePercentage}%"></div>
                                                            </div>
                                                        </div>
                                                        <div class="flex-1">
                                                            <div class="flex items-center justify-between text-xs mb-1">
                                                                <span class="text-red-600 font-medium">Faltas</span>
                                                                <span class="text-red-700 font-bold">${vip.absencePercentage.toFixed(1)}%</span>
                                                            </div>
                                                            <div class="w-full bg-stone-200 rounded-full h-2">
                                                                <div class="bg-red-500 h-2 rounded-full" style="width: ${vip.absencePercentage}%"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ` : '<p class="text-xs text-stone-600 mt-1">Nenhuma aula registrada nas PEFs</p>'}
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div id="vip-attendance-no-results" class="hidden text-center py-8 text-stone-500">Nenhum VIP encontrado</div>
                                ` : '<div class="text-center py-8 text-stone-500">Nenhum VIP cadastrado</div>'}
                            </div>
                        </div>

                        <!-- Assiduidade por Turma -->
                        <div class="bg-white p-6 rounded-lg border border-stone-200">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-semibold text-stone-800">Assiduidade por Turma</h3>
                                ${turmaAttendanceData.length > 0 ? `
                                <div class="relative w-64">
                                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                    <input 
                                        type="text" 
                                        id="turma-attendance-search" 
                                        placeholder="Buscar turma ou professor..." 
                                        class="w-full pl-10 pr-4 py-2 text-sm border border-stone-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#F1D24B] focus:border-transparent"
                                        oninput="filterTurmaAttendance(this.value)"
                                    >
                                </div>
                                ` : ''}
                            </div>
                            <div id="turma-attendance-container" style="max-height: 300px; overflow-y: auto;">
                                ${turmaAttendanceData.length > 0 ? `
                                    <div class="space-y-3">
                                        ${turmaAttendanceData.map(turma => `
                                            <div class="p-3 bg-stone-50 rounded-lg border border-stone-200 turma-attendance-row" data-turma-name="${turma.name.toLowerCase()}" data-turma-teacher="${turma.teacherName.toLowerCase()}">
                                                <div class="flex items-start justify-between mb-2">
                                                    <div>
                                                        <p class="text-sm font-medium text-stone-700">${turma.name}</p>
                                                        <div class="flex items-center gap-1 mt-1">
                                                            <svg class="w-3 h-3 text-stone-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                                            </svg>
                                                            <span class="text-xs text-stone-600">${turma.teacherName}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="flex items-center gap-4 mt-2">
                                                    <div class="flex-1">
                                                        <div class="flex items-center justify-between text-xs mb-1">
                                                            <span class="text-green-600 font-medium">Presen√ßa</span>
                                                            <span class="text-green-700 font-bold">${turma.presencePercentage.toFixed(1)}%</span>
                                                        </div>
                                                        <div class="w-full bg-stone-200 rounded-full h-2">
                                                            <div class="bg-green-500 h-2 rounded-full" style="width: ${turma.presencePercentage}%"></div>
                                                        </div>
                                                    </div>
                                                    <div class="flex-1">
                                                        <div class="flex items-center justify-between text-xs mb-1">
                                                            <span class="text-red-600 font-medium">Faltas</span>
                                                            <span class="text-red-700 font-bold">${turma.absencePercentage.toFixed(1)}%</span>
                                                        </div>
                                                        <div class="w-full bg-stone-200 rounded-full h-2">
                                                            <div class="bg-red-500 h-2 rounded-full" style="width: ${turma.absencePercentage}%"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div id="turma-attendance-no-results" class="hidden text-center py-8 text-stone-500">Nenhuma turma encontrada</div>
                                ` : '<div class="text-center py-8 text-stone-500">Nenhum dado de assiduidade dispon√≠vel</div>'}
                            </div>
                        </div>
                    </div>

                    <!-- Grid com N√≠veis e Hor√°rios -->
                    <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Alunos por N√≠vel -->
                        <div class="bg-white p-6 rounded-lg border border-stone-200">
                            <h3 class="text-lg font-semibold text-stone-800 mb-4">Alunos Cursando por N√≠vel</h3>
                            ${(() => {
                                const levelDistribution = {};
                                let totalStudents = 0;
                                
                                STANDARD_LEVELS.forEach(level => {
                                    levelDistribution[level] = 0;
                                });
                                
                                students.forEach(student => {
                                    if (student.status === 'Ativo' && student.currentLevel) {
                                        if (levelDistribution.hasOwnProperty(student.currentLevel)) {
                                            levelDistribution[student.currentLevel]++;
                                            totalStudents++;
                                        }
                                    }
                                });
                                
                                return `
                                    <div style="max-height: 400px; overflow-y: auto;">
                                        <div class="grid grid-cols-2 gap-2">
                                            ${STANDARD_LEVELS.map(level => {
                                                const count = levelDistribution[level];
                                                const percentage = totalStudents > 0 ? (count / totalStudents) * 100 : 0;
                                                const colors = {
                                                    'Starter 1': 'bg-emerald-500',
                                                    'Starter 2': 'bg-emerald-600',
                                                    'Freshman 1': 'bg-blue-500',
                                                    'Freshman 2': 'bg-blue-600',
                                                    'Sophomore 1': 'bg-indigo-500',
                                                    'Sophomore 2': 'bg-indigo-600',
                                                    'Junior 1': 'bg-purple-500',
                                                    'Junior 2': 'bg-purple-600',
                                                    'Senior 1': 'bg-pink-500',
                                                    'Senior 2': 'bg-pink-600',
                                                    'ACC': 'bg-amber-500'
                                                };
                                                const barColor = colors[level] || 'bg-gray-500';
                                                
                                                return `
                                                    <div class="p-3 bg-gradient-to-br from-stone-50 to-stone-100 rounded-lg border border-stone-200 transition-all hover:border-[#F1D24B]">
                                                        <p class="text-xs font-medium text-stone-700 uppercase tracking-wide mb-1">${level}</p>
                                                        <div class="flex items-baseline gap-2 mb-1">
                                                            <p class="text-2xl font-bold text-stone-800">${count}</p>
                                                            <p class="text-xs font-medium text-stone-600">(${percentage.toFixed(1)}%)</p>
                                                        </div>
                                                        <div class="w-full bg-stone-200 rounded-full h-1.5 overflow-hidden">
                                                            <div class="${barColor} h-1.5 rounded-full transition-all duration-300" style="width: ${Math.min(100, percentage)}%"></div>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                    <div class="mt-4 text-center">
                                        <p class="text-sm font-semibold text-stone-700">Total: <span class="text-xl ${totalStudents === 0 ? 'text-stone-500' : 'text-stone-900'}">${totalStudents}</span> ${totalStudents === 1 ? 'aluno' : 'alunos'}</p>
                                    </div>
                                `;
                            })()}
                        </div>

                        <!-- Hor√°rios Mais Ocupados -->
                        <div class="bg-white p-6 rounded-lg border border-stone-200">
                            <h3 class="text-lg font-semibold text-stone-800 mb-4">Hor√°rios Mais Ocupados</h3>
                            ${(() => {
                                const hourStudents = {}; // Mapeia hora -> Set de IDs √∫nicos de alunos
                                const uniqueVips = new Set(); // Rastreia alunos VIP √∫nicos
                                const uniqueTurmas = new Set(); // Rastreia turmas √∫nicas
                                
                                // Percorrer todos os hor√°rios da GRADE (exceto breaks)
                                schedules.forEach(schedule => {
                                    if (schedule.type === 'break' || !schedule.startTime) return;
                                    
                                    const hour = schedule.startTime.split(':')[0] + 'h';
                                    
                                    if (!hourStudents[hour]) {
                                        hourStudents[hour] = new Set();
                                    }
                                    
                                    if (schedule.type === 'vip' || schedule.type === 'dupla') {
                                        // Para VIPs e DUPLAS, adicionar o aluno √∫nico
                                        hourStudents[hour].add(`vip_${schedule.student}`);
                                        uniqueVips.add(schedule.student);
                                    } else if (schedule.type === 'turma') {
                                        // Para turmas, adicionar todos os alunos da turma
                                        const turma = turmas.find(t => t.name === schedule.student);
                                        if (turma && turma.studentIds && turma.studentIds.length > 0) {
                                            turma.studentIds.forEach(studentId => {
                                                hourStudents[hour].add(`turma_${studentId}`);
                                            });
                                            uniqueTurmas.add(schedule.student);
                                        }
                                    }
                                });
                                
                                // Converter Sets em contagem de alunos √∫nicos
                                const hourCount = {};
                                let totalStudents = 0;
                                
                                Object.keys(hourStudents).forEach(hour => {
                                    const count = hourStudents[hour].size;
                                    hourCount[hour] = count;
                                    totalStudents += count;
                                });
                                
                                const totalVips = uniqueVips.size;
                                const totalTurmasScheduled = uniqueTurmas.size;
                                
                                // Ordenar por quantidade de alunos e pegar top 8
                                const sortedHours = Object.entries(hourCount)
                                    .sort((a, b) => b[1] - a[1])
                                    .slice(0, 8);
                                
                                return sortedHours.length > 0 ? `
                                    <div style="max-height: 400px; overflow-y: auto;">
                                        <div class="grid grid-cols-2 gap-2">
                                            ${sortedHours.map(([hour, count]) => {
                                                const percentage = totalStudents > 0 ? (count / totalStudents) * 100 : 0;
                                                return `
                                                    <div class="p-3 bg-gradient-to-br from-stone-50 to-stone-100 rounded-lg border border-stone-200 transition-all hover:border-[#F1D24B]">
                                                        <p class="text-xs font-medium text-stone-700 uppercase tracking-wide mb-1">${hour}</p>
                                                        <div class="flex items-baseline gap-2 mb-1">
                                                            <p class="text-2xl font-bold text-stone-800">${count}</p>
                                                            <p class="text-xs font-medium text-stone-600">(${percentage.toFixed(1)}%)</p>
                                                        </div>
                                                        <div class="w-full bg-stone-200 rounded-full h-1.5 overflow-hidden">
                                                            <div class="bg-indigo-500 h-1.5 rounded-full transition-all duration-300" style="width: ${Math.min(100, percentage)}%"></div>
                                                        </div>
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                    </div>
                                    <div class="mt-4 text-center">
                                        <p class="text-sm font-semibold text-stone-700">
                                            Total: <span class="text-xl ${totalStudents === 0 ? 'text-stone-500' : 'text-stone-900'}">${totalStudents}</span> ${totalStudents === 1 ? 'aluno' : 'alunos'}
                                        </p>
                                        <p class="text-xs text-stone-500 mt-1">
                                            ${totalVips > 0 ? `<span class="text-amber-600 font-medium">${totalVips} VIP${totalVips > 1 ? 's' : ''}</span>` : ''}
                                            ${totalVips > 0 && totalTurmasScheduled > 0 ? ' + ' : ''}
                                            ${totalTurmasScheduled > 0 ? `<span class="text-purple-600 font-medium">${totalTurmasScheduled} Turma${totalTurmasScheduled > 1 ? 's' : ''}</span>` : ''}
                                        </p>
                                    </div>
                                ` : '<div class="text-center py-8 text-stone-500">Nenhum hor√°rio na grade</div>';
                            })()}
                        </div>
                    </div>

                    <!-- Grid com Alunos por Professor e M√©dias de Testes -->
                    <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Alunos por Professor -->
                        <div class="bg-white p-6 rounded-lg border border-stone-200">
                            <h3 class="text-lg font-semibold text-stone-800 mb-4">Alunos por Professor</h3>
                            ${teacherStats.length > 0 ? `
                                <div style="max-height: 400px; overflow-y: auto;">
                                    <div class="space-y-2">
                                        ${teacherStats.map((teacher, index) => {
                                            const vipPercentage = teacher.total > 0 ? (teacher.vipStudents / teacher.total) * 100 : 0;
                                            const turmaPercentage = teacher.total > 0 ? (teacher.turmaStudents / teacher.total) * 100 : 0;
                                            const isTopTeacher = index < 3;
                                            
                                            return `
                                                <div class="p-3 bg-stone-50 rounded-lg border border-stone-200 transition-all hover:border-[#F1D24B]">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <div class="flex items-center gap-2">
                                                            ${isTopTeacher ? `
                                                                <svg class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                                                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                                                </svg>
                                                            ` : ''}
                                                            <span class="text-sm font-medium text-stone-700">${teacher.name}</span>
                                                        </div>
                                                        <div class="flex items-center gap-2">
                                                            ${teacher.vipCount > 0 ? `<span class="px-2 py-1 bg-amber-100 text-amber-700 rounded text-xs font-bold" title="${teacher.vipStudents} ${teacher.vipStudents === 1 ? 'aluno' : 'alunos'}">${teacher.vipCount} VIP${teacher.vipCount > 1 ? 's' : ''}</span>` : ''}
                                                            ${teacher.turmaCount > 0 ? `<span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs font-bold" title="${teacher.turmaStudents} ${teacher.turmaStudents === 1 ? 'aluno' : 'alunos'}">${teacher.turmaCount} Turma${teacher.turmaCount > 1 ? 's' : ''}</span>` : ''}
                                                            <span class="px-2 py-1 bg-stone-200 text-stone-800 rounded text-xs font-bold" title="Total de alunos">${teacher.total} al.</span>
                                                        </div>
                                                    </div>
                                                    <div class="w-full bg-stone-200 rounded-full h-2 overflow-hidden flex">
                                                        ${teacher.vipStudents > 0 ? `<div class="bg-amber-500 h-2" style="width: ${vipPercentage}%" title="VIPs: ${vipPercentage.toFixed(1)}%"></div>` : ''}
                                                        ${teacher.turmaStudents > 0 ? `<div class="bg-purple-500 h-2" style="width: ${turmaPercentage}%" title="Turmas: ${turmaPercentage.toFixed(1)}%"></div>` : ''}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : '<div class="text-center py-8 text-stone-500">Nenhum professor com alunos cadastrados</div>'}
                        </div>

                        <!-- M√©dias de Notas dos Testes -->
                        <div class="bg-white p-6 rounded-lg border border-stone-200">
                            <h3 class="text-lg font-semibold text-stone-800 mb-6">M√©dias de Desempenho nos Testes</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <!-- Midterm Test -->
                                <div class="p-6 bg-stone-100 rounded-lg border border-stone-200">
                                    <div class="flex items-center justify-between mb-4">
                                        <p class="text-xs font-bold text-stone-700 uppercase tracking-wider">Midterm Test</p>
                                        <svg class="w-6 h-6 text-stone-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                        </svg>
                                    </div>
                                    <p class="text-4xl font-black text-stone-800 mb-1">${avgMidterm.toFixed(1)}</p>
                                    <p class="text-sm font-medium text-stone-600 mb-4">de 20.0 pontos</p>
                                    <div class="w-full bg-stone-200 rounded-full h-3 overflow-hidden">
                                        <div class="bg-indigo-600 h-3 rounded-full transition-all duration-500" style="width: ${Math.min(100, (avgMidterm / 20) * 100)}%"></div>
                                    </div>
                                </div>

                                <!-- Listening Test -->
                                <div class="p-6 bg-stone-100 rounded-lg border border-stone-200">
                                    <div class="flex items-center justify-between mb-4">
                                        <p class="text-xs font-bold text-stone-700 uppercase tracking-wider">Listening Test</p>
                                        <svg class="w-6 h-6 text-stone-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                                        </svg>
                                    </div>
                                    <p class="text-4xl font-black text-stone-800 mb-1">${avgListening.toFixed(1)}</p>
                                    <p class="text-sm font-medium text-stone-600 mb-4">de 20.0 pontos</p>
                                    <div class="w-full bg-stone-200 rounded-full h-3 overflow-hidden">
                                        <div class="bg-sky-600 h-3 rounded-full transition-all duration-500" style="width: ${Math.min(100, (avgListening / 20) * 100)}%"></div>
                                    </div>
                                </div>

                                <!-- Grammar Test -->
                                <div class="p-6 bg-stone-100 rounded-lg border border-stone-200">
                                    <div class="flex items-center justify-between mb-4">
                                        <p class="text-xs font-bold text-stone-700 uppercase tracking-wider">Grammar Test</p>
                                        <svg class="w-6 h-6 text-stone-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                        </svg>
                                    </div>
                                    <p class="text-4xl font-black text-stone-800 mb-1">${avgGrammar.toFixed(1)}</p>
                                    <p class="text-sm font-medium text-stone-600 mb-4">de 20.0 pontos</p>
                                    <div class="w-full bg-stone-200 rounded-full h-3 overflow-hidden">
                                        <div class="bg-teal-600 h-3 rounded-full transition-all duration-500" style="width: ${Math.min(100, (avgGrammar / 20) * 100)}%"></div>
                                    </div>
                                </div>

                                <!-- Oral Test -->
                                <div class="p-6 bg-stone-100 rounded-lg border border-stone-200">
                                    <div class="flex items-center justify-between mb-4">
                                        <p class="text-xs font-bold text-stone-700 uppercase tracking-wider">Oral Test</p>
                                        <svg class="w-6 h-6 text-stone-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                                        </svg>
                                    </div>
                                    <p class="text-4xl font-black text-stone-800 mb-1">${avgOral.toFixed(1)}</p>
                                    <p class="text-sm font-medium text-stone-600 mb-4">de 20.0 pontos</p>
                                    <div class="w-full bg-stone-200 rounded-full h-3 overflow-hidden">
                                        <div class="bg-pink-600 h-3 rounded-full transition-all duration-500" style="width: ${Math.min(100, (avgOral / 20) * 100)}%"></div>
                                    </div>
                                </div>
                            </div>
                            ${allGrades.length === 0 ? '<div class="text-center py-6 mt-6 text-stone-500 text-sm bg-stone-50 rounded-lg">Nenhuma nota registrada ainda</div>' : ''}
                        </div>
                    </div>
                </section>
            `;
        }

        // Filter turma attendance by name or teacher
        window.filterTurmaAttendance = function(searchTerm) {
            const cards = document.querySelectorAll('.turma-attendance-row');
            const noResultsDiv = document.getElementById('turma-attendance-no-results');
            const term = searchTerm.toLowerCase().trim();
            
            let visibleCount = 0;
            
            cards.forEach(card => {
                const turmaName = card.dataset.turmaName;
                const turmaTeacher = card.dataset.turmaTeacher;
                
                if (turmaName.includes(term) || turmaTeacher.includes(term)) {
                    card.style.display = '';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            if (noResultsDiv) {
                if (visibleCount === 0) {
                    noResultsDiv.classList.remove('hidden');
                } else {
                    noResultsDiv.classList.add('hidden');
                }
            }
        };

        // Filter VIP attendance by name or teacher
        window.filterVipAttendance = function(searchTerm) {
            const cards = document.querySelectorAll('.vip-attendance-card');
            const noResultsDiv = document.getElementById('vip-attendance-no-results');
            const term = searchTerm.toLowerCase().trim();
            
            let visibleCount = 0;
            
            cards.forEach(card => {
                const vipName = card.dataset.vipName;
                const vipTeacher = card.dataset.vipTeacher;
                
                if (vipName.includes(term) || vipTeacher.includes(term)) {
                    card.style.display = '';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });
            
            if (noResultsDiv) {
                if (visibleCount === 0) {
                    noResultsDiv.classList.remove('hidden');
                } else {
                    noResultsDiv.classList.add('hidden');
                }
            }
        };


        // --- MODAL & FORM FUNCTIONS ---
        function clearModalHeaderButtons() {
            const header = document.getElementById('modal-header-container');
            if (!header) return;
            
            const title = header.querySelector('#form-modal-title');
            const closeBtn = header.querySelector('.modal-close-btn');
            
            if (title && closeBtn) {
                header.innerHTML = '';
                header.appendChild(title);
                header.appendChild(closeBtn);
            }
        }
        function closeFormModal() { 
            const modal = document.getElementById('form-modal');
            modal.classList.remove('visible'); 
            clearModalHeaderButtons();
            // Clear attributes to prevent listener conflicts
            modal.removeAttribute('data-pef-modal');
            modal.removeAttribute('data-unit-id');
            modal.removeAttribute('data-pef-type');
            modal.removeAttribute('data-student-name');
        }
        function showSuccessMessage(title, message) { 
            playSuccessSound(); // Play success sound
            clearModalHeaderButtons(); 
            const modalTitle = document.getElementById('form-modal-title'); 
            const modalContentArea = document.getElementById('form-modal-content-area'); 
            modalTitle.textContent = title; 
            modalContentArea.innerHTML = `<div class="text-center"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="mt-4 text-stone-600">${message}</p><button data-action="close-modal" class="primary-btn mt-6 w-auto px-8">OK</button></div>`; 
            document.getElementById('form-modal').classList.add('visible'); 
        }
        function showErrorMessage(title, message) { 
            playErrorSound(); // Play error sound
            clearModalHeaderButtons(); 
            const modalTitle = document.getElementById('form-modal-title'); 
            const modalContentArea = document.getElementById('form-modal-content-area'); 
            modalTitle.textContent = title; 
            modalContentArea.innerHTML = `<div class="text-center"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><p class="mt-4 text-stone-600">${message}</p><button data-action="close-modal" class="primary-btn mt-6 w-auto px-8">OK</button></div>`; 
            document.getElementById('form-modal').classList.add('visible'); 
        }
        function showConfirmationModal(title, message, onConfirm) { clearModalHeaderButtons(); const modalTitle = document.getElementById('form-modal-title'); const modalContentArea = document.getElementById('form-modal-content-area'); modalTitle.textContent = title; modalContentArea.innerHTML = `<p class="text-stone-600">${message}</p><div class="mt-6 flex justify-end gap-4"><button class="secondary-btn" data-action="close-modal">Cancelar</button><button id="confirm-action-btn" class="danger-btn w-auto">Confirmar</button></div>`; document.getElementById('form-modal').classList.add('visible'); document.getElementById('confirm-action-btn').onclick = () => { onConfirm(); closeFormModal(); }; }

        // Fun√ß√£o para formata√ß√£o de data consistente no formato brasileiro
        function formatDateBR(date) {
            if (!date) return 'N/A';
            const dateObj = typeof date === 'string' ? new Date(date + 'T00:00:00') : new Date(date);
            
            // Garante formato brasileiro DD/MM/AAAA independente da configura√ß√£o do sistema
            const day = String(dateObj.getDate()).padStart(2, '0');
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const year = dateObj.getFullYear();
            
            return `${day}/${month}/${year}`;
        }

        // Fun√ß√£o para formata√ß√£o de valores monet√°rios no padr√£o brasileiro
        function formatCurrencyBR(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        // Fun√ß√£o para gerar IDs √∫nicos
        function generateId() {
            return Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Fun√ß√£o para gerar datas v√°lidas baseadas nos dias da semana permitidos
        function generateValidDates(allowedWeekdays, monthsAhead = 6, monthsBehind = 6) {
            if (!allowedWeekdays || allowedWeekdays.length === 0) {
                return [];
            }
            
            const validDates = [];
            const today = new Date();
            
            // Data inicial (meses atr√°s)
            const startDate = new Date();
            startDate.setMonth(startDate.getMonth() - monthsBehind);
            
            // Data final (meses √† frente)
            const endDate = new Date();
            endDate.setMonth(endDate.getMonth() + monthsAhead);
            
            let currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                const dayOfWeek = currentDate.getDay();
                if (allowedWeekdays.includes(dayOfWeek)) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    validDates.push(dateStr);
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return validDates;
        }

        // Fun√ß√£o para obter a √∫ltima data de PEF preenchida
        function getLastPefDate(unitId) {
            const unitAttendance = attendance.find(a => a.id === unitId);
            if (!unitAttendance || !unitAttendance.lessons) {
                return null;
            }
            
            const lessons = unitAttendance.lessons;
            const dates = [];
            
            // Coletar todas as datas preenchidas
            for (const lessonKey in lessons) {
                const lesson = lessons[lessonKey];
                if (lesson && lesson.date) {
                    dates.push(lesson.date);
                }
            }
            
            if (dates.length === 0) {
                return null;
            }
            
            // Ordenar datas e pegar a mais recente
            dates.sort((a, b) => new Date(b) - new Date(a));
            return dates[0];
        }

        // Fun√ß√µes para configura√ß√£o de lucro VIP e Turma
        window.openVipProfitModal = function() {
            clearModalHeaderButtons();
            const profitSettings = financialProfitSettings;
            
            document.getElementById('form-modal-title').textContent = 'Configurar Lucro por VIP';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="vip-profit-form" class="space-y-6">
                    <div class="bg-amber-50 p-4 rounded-lg border border-amber-200">
                        <h3 class="font-semibold text-amber-900 mb-4">Valores Mensais - VIP</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="font-medium text-sm text-amber-900">Quanto o VIP paga por m√™s (m√©dia)</label>
                                <div class="relative mt-1">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-stone-500">R$</span>
                                    <input type="number" id="vip-monthly-payment" class="form-input pl-10" step="0.01" min="0" value="${profitSettings.vipMonthlyPayment}" required>
                                </div>
                            </div>
                            
                            <div>
                                <label class="font-medium text-sm text-amber-900">Quanto o professor ganha por VIP (m√©dia)</label>
                                <div class="relative mt-1">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-stone-500">R$</span>
                                    <input type="number" id="vip-teacher-payment" class="form-input pl-10" step="0.01" min="0" value="${profitSettings.vipTeacherPayment}" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 p-4 bg-white rounded border border-amber-300">
                            <h4 class="font-semibold text-sm text-amber-900 mb-2">Resultado:</h4>
                            <div class="space-y-2 text-sm">
                                <p class="flex items-center gap-2 text-amber-800">
                                    <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                    <strong>Professor recebe:</strong> <span id="vip-preview-teacher">R$ 0,00</span>
                                </p>
                                <p class="flex items-center gap-2 text-amber-800">
                                    <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                    </svg>
                                    <strong>Escola recebe:</strong> <span id="vip-preview-school">R$ 0,00</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-right">
                        <button type="button" class="secondary-btn mr-2" onclick="closeFormModal()">Cancelar</button>
                        <button type="submit" class="primary-btn w-auto">Salvar Configura√ß√µes</button>
                    </div>
                </form>
            `;
            
            document.getElementById('form-modal').classList.add('visible');
            
            // Add event listeners for real-time preview
            const vipPaymentInput = document.getElementById('vip-monthly-payment');
            const vipTeacherInput = document.getElementById('vip-teacher-payment');
            
            function updateVipPreview() {
                const payment = parseFloat(vipPaymentInput.value) || 0;
                const teacher = parseFloat(vipTeacherInput.value) || 0;
                const school = payment - teacher;
                
                document.getElementById('vip-preview-teacher').textContent = formatCurrencyBR(teacher);
                document.getElementById('vip-preview-school').textContent = formatCurrencyBR(school);
            }
            
            vipPaymentInput.addEventListener('input', updateVipPreview);
            vipTeacherInput.addEventListener('input', updateVipPreview);
            updateVipPreview();
            
            document.getElementById('vip-profit-form').onsubmit = (e) => {
                e.preventDefault();
                saveProfitSettings('vip');
            };
        }
        
        window.openTurmaProfitModal = function() {
            clearModalHeaderButtons();
            const profitSettings = financialProfitSettings;
            
            document.getElementById('form-modal-title').textContent = 'Configurar Lucro por Turma';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="turma-profit-form" class="space-y-6">
                    <div class="bg-emerald-50 p-4 rounded-lg border border-emerald-200">
                        <h3 class="font-semibold text-emerald-900 mb-4">Valores Mensais - Turma</h3>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="font-medium text-sm text-emerald-900">Quanto cada aluno paga por m√™s (m√©dia)</label>
                                <div class="relative mt-1">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-stone-500">R$</span>
                                    <input type="number" id="turma-student-payment" class="form-input pl-10" step="0.01" min="0" value="${profitSettings.turmaStudentPayment}" required>
                                </div>
                            </div>
                            
                            <div>
                                <label class="font-medium text-sm text-emerald-900">Quanto o professor recebe por turma (m√©dia)</label>
                                <div class="relative mt-1">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-stone-500">R$</span>
                                    <input type="number" id="turma-teacher-payment" class="form-input pl-10" step="0.01" min="0" value="${profitSettings.turmaTeacherPayment}" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 p-4 bg-white rounded border border-emerald-300">
                            <h4 class="font-semibold text-sm text-emerald-900 mb-2">Resultado (por turma com exemplo de 5 alunos):</h4>
                            <div class="space-y-2 text-sm">
                                <p class="flex items-center gap-2 text-emerald-800">
                                    <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                    </svg>
                                    <strong>Receita da turma:</strong> <span id="turma-preview-revenue">R$ 0,00</span>
                                </p>
                                <p class="flex items-center gap-2 text-emerald-800">
                                    <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                    <strong>Professor recebe:</strong> <span id="turma-preview-teacher">R$ 0,00</span>
                                </p>
                                <p class="flex items-center gap-2 text-emerald-800">
                                    <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                    </svg>
                                    <strong>Escola recebe:</strong> <span id="turma-preview-school">R$ 0,00</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-right">
                        <button type="button" class="secondary-btn mr-2" onclick="closeFormModal()">Cancelar</button>
                        <button type="submit" class="primary-btn w-auto">Salvar Configura√ß√µes</button>
                    </div>
                </form>
            `;
            
            document.getElementById('form-modal').classList.add('visible');
            
            // Add event listeners for real-time preview
            const studentPaymentInput = document.getElementById('turma-student-payment');
            const teacherPaymentInput = document.getElementById('turma-teacher-payment');
            
            function updateTurmaPreview() {
                const studentPayment = parseFloat(studentPaymentInput.value) || 0;
                const teacherPayment = parseFloat(teacherPaymentInput.value) || 0;
                const exampleStudents = 5;
                const revenue = studentPayment * exampleStudents;
                const school = revenue - teacherPayment;
                
                document.getElementById('turma-preview-revenue').textContent = formatCurrencyBR(revenue);
                document.getElementById('turma-preview-teacher').textContent = formatCurrencyBR(teacherPayment);
                document.getElementById('turma-preview-school').textContent = formatCurrencyBR(school);
            }
            
            studentPaymentInput.addEventListener('input', updateTurmaPreview);
            teacherPaymentInput.addEventListener('input', updateTurmaPreview);
            updateTurmaPreview();
            
            document.getElementById('turma-profit-form').onsubmit = (e) => {
                e.preventDefault();
                saveProfitSettings('turma');
            };
        }
        
        async function saveProfitSettings(type) {
            const currentSettings = { ...financialProfitSettings };
            
            if (type === 'vip') {
                currentSettings.vipMonthlyPayment = parseFloat(document.getElementById('vip-monthly-payment').value) || 0;
                currentSettings.vipTeacherPayment = parseFloat(document.getElementById('vip-teacher-payment').value) || 0;
            } else if (type === 'turma') {
                currentSettings.turmaStudentPayment = parseFloat(document.getElementById('turma-student-payment').value) || 0;
                currentSettings.turmaTeacherPayment = parseFloat(document.getElementById('turma-teacher-payment').value) || 0;
            }
            
            try {
                if (!db) {
                    localStorage.setItem('financialProfitSettings', JSON.stringify(currentSettings));
                    financialProfitSettings = currentSettings;
                    closeFormModal();
                    showSuccessMessage('Sucesso!', 'Configura√ß√µes de lucro salvas com sucesso.');
                    renderFolhaPagamentoSection();
                } else {
                    await setDoc(doc(db, `artifacts/${appId}/public/data/financial-profit-settings`, 'settings'), currentSettings);
                    financialProfitSettings = currentSettings;
                    closeFormModal();
                    showSuccessMessage('Sucesso!', 'Configura√ß√µes de lucro salvas com sucesso.');
                    renderFolhaPagamentoSection();
                }
            } catch (error) {
                console.error("Error saving profit settings:", error);
                showErrorMessage("Erro", "Erro ao salvar configura√ß√µes: " + error.message);
            }
        }

        // Firebase Admin User Management Functions
        window.openCreateFirebaseUserModal = function() {
            clearModalHeaderButtons();
            document.getElementById('form-modal-title').textContent = 'Criar Usu√°rio Firebase';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="create-firebase-user-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-stone-700 mb-1">Email</label>
                        <input type="email" id="firebase-user-email" class="form-input" placeholder="usuario@exemplo.com" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-stone-700 mb-1">Senha</label>
                        <input type="password" id="firebase-user-password" class="form-input" placeholder="M√≠nimo 6 caracteres" minlength="6" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-stone-700 mb-1">Nome de Exibi√ß√£o (opcional)</label>
                        <input type="text" id="firebase-user-displayname" class="form-input" placeholder="Nome do usu√°rio">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-stone-700 mb-1">Vincular a Colaborador (opcional)</label>
                        <select id="firebase-user-collaborator" class="form-input">
                            <option value="">Nenhum</option>
                            ${collaborators.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" class="secondary-btn" onclick="closeFormModal()">Cancelar</button>
                        <button type="submit" class="primary-btn w-auto">Criar Usu√°rio</button>
                    </div>
                </form>
            `;
            document.getElementById('form-modal').classList.add('visible');
            
            document.getElementById('create-firebase-user-form').onsubmit = async (e) => {
                e.preventDefault();
                const email = document.getElementById('firebase-user-email').value;
                const password = document.getElementById('firebase-user-password').value;
                const displayName = document.getElementById('firebase-user-displayname').value;
                const collaboratorId = document.getElementById('firebase-user-collaborator').value;
                
                try {
                    const response = await fetch('/api/firebase/create-user', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password, displayName })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        if (collaboratorId) {
                            const collab = collaborators.find(c => c.id === collaboratorId);
                            if (collab) {
                                collab.firebaseUid = data.uid;
                                collab.email = email;
                                localStorage.setItem('collaborators', JSON.stringify(collaborators));
                            }
                        }
                        closeFormModal();
                        showSuccessMessage('Sucesso!', `Usu√°rio ${email} criado com sucesso no Firebase!`);
                        renderColaboradoresSection();
                    } else {
                        showErrorMessage('Erro', data.error || 'Erro ao criar usu√°rio');
                    }
                } catch (error) {
                    showErrorMessage('Erro', 'Erro ao conectar com o servidor');
                }
            };
        };

        window.openResetPasswordModal = function(uid, name) {
            clearModalHeaderButtons();
            document.getElementById('form-modal-title').textContent = `Redefinir Senha - ${name}`;
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="reset-password-form" class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
                        <p class="text-sm text-blue-800">Defina uma nova senha para este usu√°rio. A senha ser√° atualizada imediatamente no Firebase.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-stone-700 mb-1">Nova Senha</label>
                        <input type="password" id="new-password" class="form-input" placeholder="M√≠nimo 6 caracteres" minlength="6" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-stone-700 mb-1">Confirmar Nova Senha</label>
                        <input type="password" id="confirm-password" class="form-input" placeholder="Digite a senha novamente" required>
                    </div>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" class="secondary-btn" onclick="closeFormModal()">Cancelar</button>
                        <button type="submit" class="primary-btn w-auto !bg-blue-500 hover:!bg-blue-600">Redefinir Senha</button>
                    </div>
                </form>
            `;
            document.getElementById('form-modal').classList.add('visible');
            
            document.getElementById('reset-password-form').onsubmit = async (e) => {
                e.preventDefault();
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                if (newPassword !== confirmPassword) {
                    showErrorMessage('Erro', 'As senhas n√£o coincidem');
                    return;
                }
                
                try {
                    const response = await fetch('/api/firebase/reset-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ uid, newPassword })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        closeFormModal();
                        showSuccessMessage('Sucesso!', `Senha de ${name} redefinida com sucesso!`);
                    } else {
                        showErrorMessage('Erro', data.error || 'Erro ao redefinir senha');
                    }
                } catch (error) {
                    showErrorMessage('Erro', 'Erro ao conectar com o servidor');
                }
            };
        };

        window.openEditFirebaseUserModal = function(uid, collaboratorId, name, currentEmail) {
            clearModalHeaderButtons();
            document.getElementById('form-modal-title').textContent = `Editar Usu√°rio Firebase - ${name}`;
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="edit-firebase-user-form" class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4">
                        <p class="text-sm text-blue-800">Edite o email e/ou senha do usu√°rio. Deixe a senha em branco se n√£o quiser alter√°-la.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-stone-700 mb-1">Email</label>
                        <input type="email" id="edit-user-email" class="form-input" value="${currentEmail}" placeholder="usuario@exemplo.com" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-stone-700 mb-1">Nova Senha (opcional)</label>
                        <input type="password" id="edit-user-password" class="form-input" placeholder="Deixe em branco para manter a atual" minlength="6">
                    </div>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" class="secondary-btn" onclick="closeFormModal()">Cancelar</button>
                        <button type="submit" class="primary-btn w-auto !bg-blue-500 hover:!bg-blue-600">Salvar Altera√ß√µes</button>
                    </div>
                </form>
            `;
            document.getElementById('form-modal').classList.add('visible');
            
            document.getElementById('edit-firebase-user-form').onsubmit = async (e) => {
                e.preventDefault();
                const email = document.getElementById('edit-user-email').value;
                const password = document.getElementById('edit-user-password').value;
                
                const updateData = { email };
                if (password && password.trim() !== '') {
                    updateData.password = password;
                }
                
                try {
                    const response = await fetch(`/api/firebase/update-user/${uid}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(updateData)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        const collab = collaborators.find(c => c.id === collaboratorId);
                        if (collab && data.email) {
                            collab.email = data.email;
                            localStorage.setItem('collaborators', JSON.stringify(collaborators));
                        }
                        closeFormModal();
                        showSuccessMessage('Sucesso!', `Usu√°rio ${name} atualizado com sucesso!`);
                        renderColaboradoresSection();
                    } else {
                        showErrorMessage('Erro', data.error || 'Erro ao atualizar usu√°rio');
                    }
                } catch (error) {
                    showErrorMessage('Erro', 'Erro ao conectar com o servidor');
                }
            };
        };

        window.deleteFirebaseUser = function(uid, collaboratorId, name) {
            showConfirmationModal(
                'Excluir Usu√°rio Firebase',
                `Tem certeza que deseja excluir o usu√°rio ${name} do Firebase? Esta a√ß√£o n√£o pode ser desfeita.`,
                async () => {
                    try {
                        const response = await fetch(`/api/firebase/delete-user/${uid}`, {
                            method: 'DELETE'
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            const collab = collaborators.find(c => c.id === collaboratorId);
                            if (collab) {
                                delete collab.firebaseUid;
                                delete collab.email;
                                localStorage.setItem('collaborators', JSON.stringify(collaborators));
                            }
                            showSuccessMessage('Sucesso!', `Usu√°rio ${name} exclu√≠do do Firebase!`);
                            renderColaboradoresSection();
                        } else {
                            showErrorMessage('Erro', data.error || 'Erro ao excluir usu√°rio');
                        }
                    } catch (error) {
                        showErrorMessage('Erro', 'Erro ao conectar com o servidor');
                    }
                }
            );
        };

        // Fun√ß√µes globais para ocultar/mostrar informa√ß√µes em cards e linhas
        window.toggleCardVisibility = function(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;
            
            const contentDiv = card.querySelector('.card-content');
            const eyeOpen = card.querySelector('.eye-icon-open');
            const eyeClosed = card.querySelector('.eye-icon-closed');
            
            if (contentDiv.style.filter === 'blur(8px)') {
                contentDiv.style.filter = 'none';
                contentDiv.style.userSelect = 'auto';
                eyeOpen.classList.remove('hidden');
                eyeClosed.classList.add('hidden');
            } else {
                contentDiv.style.filter = 'blur(8px)';
                contentDiv.style.userSelect = 'none';
                eyeOpen.classList.add('hidden');
                eyeClosed.classList.remove('hidden');
            }
        };

        window.toggleRowVisibility = function(rowId) {
            const row = document.getElementById(rowId);
            if (!row) return;
            
            const contentElements = row.querySelectorAll('.row-content');
            const eyeOpen = row.querySelector('.eye-icon-open');
            const eyeClosed = row.querySelector('.eye-icon-closed');
            
            if (contentElements[0] && contentElements[0].style.filter === 'blur(8px)') {
                contentElements.forEach(el => {
                    el.style.filter = 'none';
                    el.style.userSelect = 'auto';
                });
                eyeOpen.classList.remove('hidden');
                eyeClosed.classList.add('hidden');
            } else {
                contentElements.forEach(el => {
                    el.style.filter = 'blur(8px)';
                    el.style.userSelect = 'none';
                });
                eyeOpen.classList.add('hidden');
                eyeClosed.classList.remove('hidden');
            }
        };

        function openSignUpModal() {
            clearModalHeaderButtons();
            const modalTitle = document.getElementById('form-modal-title');
            const modalContentArea = document.getElementById('form-modal-content-area');

            modalTitle.textContent = "Criar Nova Conta";
            modalContentArea.innerHTML = `
                <form id="signup-form" class="space-y-4">
                    <div><label for="signup-name" class="font-medium text-sm">Nome Completo</label><input type="text" id="signup-name" name="name" required class="form-input mt-1"></div>
                    <div><label for="signup-email" class="font-medium text-sm">E-mail</label><input type="email" id="signup-email" name="email" required class="form-input mt-1"></div>
                    <div><label for="signup-password" class="font-medium text-sm">Senha (m√≠n. 6 caracteres)</label><input type="password" id="signup-password" name="password" required class="form-input mt-1"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Cadastrar</button></div>
                </form>
            `;
            document.getElementById('signup-form').addEventListener('submit', handleSignUp);
            document.getElementById('form-modal').classList.add('visible');
        }

        // Mapeamento de n√≠veis antigos para novos
        const levelMapping = {
            'Basic 1': 'Starter 1',
            'Basic 2': 'Starter 2',
            'Pre-intermediate 1': 'Freshman 1',
            'Pre-intermediate 2': 'Freshman 2',
            'Intermediate 1': 'Sophomore 1',
            'Intermediate 2': 'Sophomore 2',
            'Pre-advanced 1': 'Junior 1',
            'Pre-advanced 2': 'Junior 2',
            'Advanced 1': 'Senior 1',
            'Advanced 2': 'Senior 2',
            'ACC': 'ACC'
        };

        function openAlunoForm(alunoId = null) {
            clearModalHeaderButtons();
            const aluno = alunoId ? students.find(s => s.id === alunoId) : null;
            
            // Mapear n√≠veis antigos para novos se existirem
            if (aluno && aluno.completedLevels) {
                aluno.completedLevels = aluno.completedLevels.map(level => levelMapping[level] || level);
            }
            
            const canViewFinancialInfo = canViewStudentFinancials();
            document.getElementById('form-modal-title').textContent = aluno ? "Editar Aluno" : "Adicionar Novo Aluno";

            const statusOptions = ['Ativo', 'Inativo', 'Cancelado', 'Pendente'].map(s => `<option value="${s}" ${aluno?.status === s ? 'selected' : ''}>${s}</option>`).join('');
            const paymentTypeOptions = ['Cart√£o', 'Boleto', 'Permuta', 'Bolsa', 'Assinatura'].map(p => `<option value="${p}" ${aluno?.paymentType === p ? 'selected' : ''}>${p}</option>`).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="aluno-id" value="${alunoId || ''}">

                    <h4 class="text-lg font-semibold text-stone-700 border-b pb-2">Informa√ß√µes B√°sicas</h4>
                    <div><label class="font-medium text-sm">Nome Completo do Aluno</label><input type="text" id="aluno-name" class="form-input" required value="${aluno?.name || ''}"></div>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="font-medium text-sm">Status</label><select id="aluno-status" class="form-input">${statusOptions}</select></div>
                        <div><label class="font-medium text-sm">Modalidade</label><select id="aluno-modalidade" class="form-input" required><option value="VIP" ${aluno?.modalidade === 'VIP' ? 'selected' : ''}>VIP</option><option value="TURMA" ${aluno?.modalidade === 'TURMA' ? 'selected' : ''}>TURMA</option><option value="DUPLA" ${aluno?.modalidade === 'DUPLA' ? 'selected' : ''}>DUPLA</option></select></div>
                        <div><label class="font-medium text-sm">Data de In√≠cio</label><input type="date" id="aluno-startDate" class="form-input" value="${aluno?.startDate || ''}"></div>
                    </div>
                    <div><label class="font-medium text-sm">Indica√ß√£o</label><input type="text" id="aluno-indicacao" class="form-input" placeholder="Pessoa que indicou ou cupom utilizado" value="${aluno?.indicacao || ''}"></div>
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="aluno-fora-brasil" class="h-4 w-4 rounded text-yellow-500 focus:ring-yellow-400" ${aluno?.foraBrasil ? 'checked' : ''} onchange="toggleLocationFields()">
                            <label for="aluno-fora-brasil" class="ml-2 text-sm font-medium text-stone-700">Mora fora do Brasil?</label>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="font-medium text-sm">Local (Cidade/Pa√≠s)</label><input type="text" id="aluno-local" class="form-input" placeholder="Ex: S√£o Paulo ou Toronto, Canad√°" value="${aluno?.local || ''}"></div>
                            <div>
                                <label class="font-medium text-sm" id="location-label">Estado</label>
                                <select id="aluno-estado" class="form-input">
                                    <option value="">Selecione o estado</option>
                                    <option value="AC" ${aluno?.estado === 'AC' ? 'selected' : ''}>Acre</option>
                                    <option value="AL" ${aluno?.estado === 'AL' ? 'selected' : ''}>Alagoas</option>
                                    <option value="AP" ${aluno?.estado === 'AP' ? 'selected' : ''}>Amap√°</option>
                                    <option value="AM" ${aluno?.estado === 'AM' ? 'selected' : ''}>Amazonas</option>
                                    <option value="BA" ${aluno?.estado === 'BA' ? 'selected' : ''}>Bahia</option>
                                    <option value="CE" ${aluno?.estado === 'CE' ? 'selected' : ''}>Cear√°</option>
                                    <option value="DF" ${aluno?.estado === 'DF' ? 'selected' : ''}>Distrito Federal</option>
                                    <option value="ES" ${aluno?.estado === 'ES' ? 'selected' : ''}>Esp√≠rito Santo</option>
                                    <option value="GO" ${aluno?.estado === 'GO' ? 'selected' : ''}>Goi√°s</option>
                                    <option value="MA" ${aluno?.estado === 'MA' ? 'selected' : ''}>Maranh√£o</option>
                                    <option value="MT" ${aluno?.estado === 'MT' ? 'selected' : ''}>Mato Grosso</option>
                                    <option value="MS" ${aluno?.estado === 'MS' ? 'selected' : ''}>Mato Grosso do Sul</option>
                                    <option value="MG" ${aluno?.estado === 'MG' ? 'selected' : ''}>Minas Gerais</option>
                                    <option value="PA" ${aluno?.estado === 'PA' ? 'selected' : ''}>Par√°</option>
                                    <option value="PB" ${aluno?.estado === 'PB' ? 'selected' : ''}>Para√≠ba</option>
                                    <option value="PR" ${aluno?.estado === 'PR' ? 'selected' : ''}>Paran√°</option>
                                    <option value="PE" ${aluno?.estado === 'PE' ? 'selected' : ''}>Pernambuco</option>
                                    <option value="PI" ${aluno?.estado === 'PI' ? 'selected' : ''}>Piau√≠</option>
                                    <option value="RJ" ${aluno?.estado === 'RJ' ? 'selected' : ''}>Rio de Janeiro</option>
                                    <option value="RN" ${aluno?.estado === 'RN' ? 'selected' : ''}>Rio Grande do Norte</option>
                                    <option value="RS" ${aluno?.estado === 'RS' ? 'selected' : ''}>Rio Grande do Sul</option>
                                    <option value="RO" ${aluno?.estado === 'RO' ? 'selected' : ''}>Rond√¥nia</option>
                                    <option value="RR" ${aluno?.estado === 'RR' ? 'selected' : ''}>Roraima</option>
                                    <option value="SC" ${aluno?.estado === 'SC' ? 'selected' : ''}>Santa Catarina</option>
                                    <option value="SP" ${aluno?.estado === 'SP' ? 'selected' : ''}>S√£o Paulo</option>
                                    <option value="SE" ${aluno?.estado === 'SE' ? 'selected' : ''}>Sergipe</option>
                                    <option value="TO" ${aluno?.estado === 'TO' ? 'selected' : ''}>Tocantins</option>
                                </select>
                                <select id="aluno-continente" class="form-input" style="display: none;">
                                    <option value="">Selecione o continente</option>
                                    <option value="Am√©rica do Norte" ${aluno?.continente === 'Am√©rica do Norte' ? 'selected' : ''}>Am√©rica do Norte</option>
                                    <option value="Am√©rica do Sul" ${aluno?.continente === 'Am√©rica do Sul' ? 'selected' : ''}>Am√©rica do Sul</option>
                                    <option value="Europa" ${aluno?.continente === 'Europa' ? 'selected' : ''}>Europa</option>
                                    <option value="√Åsia" ${aluno?.continente === '√Åsia' ? 'selected' : ''}>√Åsia</option>
                                    <option value="√Åfrica" ${aluno?.continente === '√Åfrica' ? 'selected' : ''}>√Åfrica</option>
                                    <option value="Oceania" ${aluno?.continente === 'Oceania' ? 'selected' : ''}>Oceania</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <h4 class="text-lg font-semibold text-stone-700 border-b pb-2 pt-4">Informa√ß√µes Pessoais</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="font-medium text-sm">Data de Nascimento <span class="text-red-500">*</span></label><input type="date" id="aluno-birthDate" class="form-input" required value="${aluno?.birthDate || ''}"></div>
                        <div><label class="font-medium text-sm">G√™nero <span class="text-red-500">*</span></label><select id="aluno-gender" class="form-input" required><option value="">Selecione</option><option value="Masculino" ${aluno?.gender === 'Masculino' ? 'selected' : ''}>Masculino</option><option value="Feminino" ${aluno?.gender === 'Feminino' ? 'selected' : ''}>Feminino</option></select></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="font-medium text-sm">CPF <span class="text-red-500">*</span></label><input type="text" id="aluno-cpf" class="form-input" placeholder="000.000.000-00" required value="${aluno?.cpf || ''}"></div>
                        <div><label class="font-medium text-sm">Estado Civil</label><select id="aluno-estadoCivil" class="form-input"><option value="">Selecione</option><option value="Solteiro(a)" ${aluno?.estadoCivil === 'Solteiro(a)' ? 'selected' : ''}>Solteiro(a)</option><option value="Casado(a)" ${aluno?.estadoCivil === 'Casado(a)' ? 'selected' : ''}>Casado(a)</option><option value="Divorciado(a)" ${aluno?.estadoCivil === 'Divorciado(a)' ? 'selected' : ''}>Divorciado(a)</option><option value="Vi√∫vo(a)" ${aluno?.estadoCivil === 'Vi√∫vo(a)' ? 'selected' : ''}>Vi√∫vo(a)</option><option value="Uni√£o Est√°vel" ${aluno?.estadoCivil === 'Uni√£o Est√°vel' ? 'selected' : ''}>Uni√£o Est√°vel</option></select></div>
                    </div>
                    <div><label class="font-medium text-sm">Profiss√£o</label><input type="text" id="aluno-profissao" class="form-input" placeholder="Ex: Engenheiro, Professor, etc." value="${aluno?.profissao || ''}"></div>
                    <div><label class="font-medium text-sm">Endere√ßo Completo</label><textarea id="aluno-endereco" rows="2" class="form-input" placeholder="Rua, n√∫mero, complemento, bairro, CEP...">${aluno?.endereco || ''}</textarea></div>

                    <h4 class="text-lg font-semibold text-stone-700 border-b pb-2 pt-4">N√≠veis e Hist√≥rico</h4>
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="font-medium text-sm">N√≠veis Cursados</label>
                            <button type="button" onclick="addCompletedLevel()" class="text-xs px-3 py-1 bg-[#F1D24B] hover:bg-yellow-500 rounded-lg font-medium transition-colors">
                                + Adicionar N√≠vel
                            </button>
                        </div>
                        <div id="aluno-levels-list" class="space-y-2 max-h-60 overflow-y-auto p-2 border rounded-md bg-stone-50">
                            ${(() => {
                                const completedLevels = aluno?.completedLevels || [];
                                if (completedLevels.length === 0) {
                                    return '<p class="text-sm text-stone-500 text-center py-4">Nenhum n√≠vel cursado ainda</p>';
                                }
                                return completedLevels.map((item, index) => {
                                    const level = typeof item === 'string' ? item : item.level;
                                    const semester = typeof item === 'string' ? '' : (item.semester || '');
                                    const modalidade = typeof item === 'string' ? '' : (item.modalidade || '');
                                    return `
                                        <div class="flex items-center gap-2 bg-white p-2 rounded border border-stone-200" data-level-index="${index}">
                                            <select class="flex-1 text-sm border border-stone-300 rounded px-2 py-1 level-select" onchange="updateLevelData()">
                                                <option value="">Selecione o n√≠vel</option>
                                                ${STANDARD_LEVELS.map(lv => 
                                                    `<option value="${lv}" ${lv === level ? 'selected' : ''}>${lv}</option>`
                                                ).join('')}
                                            </select>
                                            <input type="text" placeholder="Ex: 2025.1" value="${semester}" 
                                                class="w-24 text-sm border border-stone-300 rounded px-2 py-1 semester-input" 
                                                onchange="updateLevelData()"
                                                pattern="\\d{4}\\.[12]"
                                                title="Formato: YYYY.1 ou YYYY.2">
                                            <select class="w-28 text-sm border border-stone-300 rounded px-2 py-1 modalidade-select" onchange="updateLevelData()">
                                                <option value="">Modalidade</option>
                                                <option value="VIP" ${modalidade === 'VIP' ? 'selected' : ''}>VIP</option>
                                                <option value="TURMA" ${modalidade === 'TURMA' ? 'selected' : ''}>TURMA</option>
                                                <option value="DUPLA" ${modalidade === 'DUPLA' ? 'selected' : ''}>DUPLA</option>
                                            </select>
                                            <button type="button" onclick="removeCompletedLevel(${index})" class="text-red-600 hover:text-red-700 p-1">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                                </svg>
                                            </button>
                                        </div>
                                    `;
                                }).join('');
                            })()}
                        </div>
                        <div class="mt-3 flex items-center gap-2">
                            <input type="checkbox" id="aluno-neverCompletedLevels" class="h-4 w-4 rounded text-yellow-500 focus:ring-yellow-400" ${aluno?.neverCompletedLevels ? 'checked' : ''}>
                            <label for="aluno-neverCompletedLevels" class="text-sm font-medium text-stone-700">Este aluno nunca cursou nenhum n√≠vel (iniciante)</label>
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="font-medium text-sm">N√≠vel Atual (que est√° cursando agora)</label>
                        <select id="aluno-currentLevel" class="form-input mt-2">
                            <option value="">Nenhum (n√£o est√° cursando)</option>
                            ${STANDARD_LEVELS.map(lv => 
                                `<option value="${lv}" ${aluno?.currentLevel === lv ? 'selected' : ''}>${lv}</option>`
                            ).join('')}
                        </select>
                        <p class="text-xs text-stone-500 mt-1">Selecione o n√≠vel que o aluno est√° cursando atualmente</p>
                    </div>

                    ${canViewFinancialInfo ? `
                    <h4 class="text-lg font-semibold text-stone-700 border-b pb-2 pt-4">Informa√ß√µes Financeiras</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="font-medium text-sm">Tipo de Pagamento</label><select id="aluno-paymentType" class="form-input">${paymentTypeOptions}</select></div>
                        <div><label class="font-medium text-sm">Quantidade de Parcelas</label><input type="number" min="1" max="24" id="aluno-parcelas" class="form-input" placeholder="Ex: 12" value="${aluno?.parcelas || ''}"></div>
                    </div>
                    <div id="aluno-amount-fields" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="font-medium text-sm">Valor Pago (R$)</label><input type="number" step="0.01" id="aluno-amountPaid" class="form-input" value="${aluno?.amountPaid || ''}"></div>
                        <div><label class="font-medium text-sm">Valor Recebido (R$)</label><input type="number" step="0.01" id="aluno-amountReceived" class="form-input" value="${aluno?.amountReceived || ''}"></div>
                    </div>
                    ` : ''}

                    <h4 class="text-lg font-semibold text-stone-700 border-b pb-2 pt-4">Respons√°vel</h4>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="aluno-isMinor" class="h-4 w-4 rounded" ${aluno?.isMinor ? 'checked' : ''}>
                        <label for="aluno-isMinor" class="text-sm font-medium">Menor de idade?</label>
                    </div>
                    <div id="responsible-fields" class="${aluno?.isMinor ? '' : 'hidden'} space-y-4">
                        <div><label class="font-medium text-sm">Nome do Respons√°vel</label><input type="text" id="aluno-responsibleName" class="form-input" value="${aluno?.responsibleName || ''}"></div>
                        <div><label class="font-medium text-sm">Telefone do Respons√°vel</label><input type="tel" id="aluno-responsiblePhone" class="form-input" value="${aluno?.responsiblePhone || ''}"></div>
                    </div>

                    <!-- Campos de Cancelamento (aparecem apenas quando status = Cancelado) -->
                    <div id="cancellation-fields" class="${aluno?.status === 'Cancelado' ? '' : 'hidden'} space-y-4">
                        <h4 class="text-lg font-semibold text-stone-700 border-b pb-2 pt-4">Informa√ß√µes do Cancelamento</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label class="font-medium text-sm">Data do Cancelamento</label><input type="date" id="aluno-cancellationDate" class="form-input" value="${aluno?.cancellationDate || ''}"></div>
                            <div><label class="font-medium text-sm">Processado Por</label><input type="text" id="aluno-processedBy" class="form-input" placeholder="Nome do respons√°vel" value="${aluno?.processedBy || currentUserName || ''}"></div>
                        </div>
                        <div><label class="font-medium text-sm">Motivo do Cancelamento</label><textarea id="aluno-cancellationReason" rows="3" class="form-input" placeholder="Descreva o motivo do cancelamento...">${aluno?.cancellationReason || ''}</textarea></div>
                    </div>

                    <h4 class="text-lg font-semibold text-stone-700 border-b pb-2 pt-4">Outras Informa√ß√µes</h4>
                    <div><label class="font-medium text-sm">Observa√ß√µes</label><textarea id="aluno-notes" rows="3" class="form-input">${aluno?.notes || ''}</textarea></div>

                    <div class="text-right pt-4"><button type="submit" class="primary-btn w-auto">Salvar Aluno</button></div>
                </form>
            `;

            document.getElementById('aluno-isMinor').addEventListener('change', (e) => {
                document.getElementById('responsible-fields').classList.toggle('hidden', !e.target.checked);
            });

            // Show/hide cancellation fields based on status
            document.getElementById('aluno-status').addEventListener('change', (e) => {
                const cancellationFields = document.getElementById('cancellation-fields');
                if (e.target.value === 'Cancelado') {
                    cancellationFields.classList.remove('hidden');
                    // Auto-fill cancellation date with today's date if empty
                    const dateField = document.getElementById('aluno-cancellationDate');
                    if (!dateField.value) {
                        dateField.value = new Date().toISOString().split('T')[0];
                    }
                } else {
                    cancellationFields.classList.add('hidden');
                }
            });

            // Show/hide amount fields based on payment type
            const paymentTypeSelect = document.getElementById('aluno-paymentType');
            if (paymentTypeSelect) {
                const toggleAmountFields = () => {
                    const amountFields = document.getElementById('aluno-amount-fields');
                    if (amountFields) {
                        if (paymentTypeSelect.value === 'Bolsa' || paymentTypeSelect.value === 'Permuta') {
                            amountFields.classList.add('hidden');
                        } else {
                            amountFields.classList.remove('hidden');
                        }
                    }
                };
                
                paymentTypeSelect.addEventListener('change', toggleAmountFields);
                // Initialize visibility on form open
                toggleAmountFields();
            }

            const form = document.getElementById('form-modal-content-area');
            if (form) {
                form.onsubmit = saveAluno;
            } else {
                console.error('Form element not found!');
            }
            document.getElementById('form-modal').classList.add('visible');
            
            // Initialize location fields after modal is visible
            setTimeout(() => {
                toggleLocationFields();
            }, 100);
        }

        function addCompletedLevel() {
            const levelsList = document.getElementById('aluno-levels-list');
            const isEmpty = levelsList.querySelector('p.text-stone-500');
            if (isEmpty) {
                levelsList.innerHTML = '';
            }
            
            const index = levelsList.children.length;
            const newLevelHtml = `
                <div class="flex items-center gap-2 bg-white p-2 rounded border border-stone-200" data-level-index="${index}">
                    <select class="flex-1 text-sm border border-stone-300 rounded px-2 py-1 level-select" onchange="updateLevelData()">
                        <option value="">Selecione o n√≠vel</option>
                        ${STANDARD_LEVELS.map(lv => 
                            `<option value="${lv}">${lv}</option>`
                        ).join('')}
                    </select>
                    <input type="text" placeholder="Ex: 2025.1" value="" 
                        class="w-24 text-sm border border-stone-300 rounded px-2 py-1 semester-input" 
                        onchange="updateLevelData()"
                        pattern="\\d{4}\\.[12]"
                        title="Formato: YYYY.1 ou YYYY.2">
                    <select class="w-28 text-sm border border-stone-300 rounded px-2 py-1 modalidade-select" onchange="updateLevelData()">
                        <option value="">Modalidade</option>
                        <option value="VIP">VIP</option>
                        <option value="TURMA">TURMA</option>
                        <option value="DUPLA">DUPLA</option>
                    </select>
                    <button type="button" onclick="removeCompletedLevel(${index})" class="text-red-600 hover:text-red-700 p-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            `;
            levelsList.insertAdjacentHTML('beforeend', newLevelHtml);
        }
        
        window.addCompletedLevel = addCompletedLevel;

        function removeCompletedLevel(index) {
            const levelsList = document.getElementById('aluno-levels-list');
            const levelItem = levelsList.querySelector(`[data-level-index="${index}"]`);
            if (levelItem) {
                levelItem.remove();
                if (levelsList.children.length === 0) {
                    levelsList.innerHTML = '<p class="text-sm text-stone-500 text-center py-4">Nenhum n√≠vel cursado ainda</p>';
                }
            }
        }
        
        window.removeCompletedLevel = removeCompletedLevel;

        function updateLevelData() {
        }
        
        window.updateLevelData = updateLevelData;

        function getCompletedLevelsFromForm() {
            const levelsList = document.getElementById('aluno-levels-list');
            const levelItems = levelsList.querySelectorAll('[data-level-index]');
            
            const levels = [];
            levelItems.forEach(item => {
                const levelSelect = item.querySelector('.level-select');
                const semesterInput = item.querySelector('.semester-input');
                const modalidadeSelect = item.querySelector('.modalidade-select');
                const level = levelSelect.value;
                const semester = semesterInput.value.trim();
                const modalidade = modalidadeSelect ? modalidadeSelect.value : '';
                
                if (level) {
                    levels.push({
                        level: level,
                        semester: semester || '',
                        modalidade: modalidade || ''
                    });
                }
            });
            
            return levels;
        }

        async function saveAluno(event) {
            event.preventDefault();
            const alunoId = document.getElementById('aluno-id').value;
            const isMinor = document.getElementById('aluno-isMinor').checked;
            const canViewFinancialInfo = canViewStudentFinancials();

            const completedLevels = getCompletedLevelsFromForm();

            const status = document.getElementById('aluno-status').value;
            const isCancelled = status === 'Cancelado';

            const data = {
                name: document.getElementById('aluno-name').value,
                status: status,
                modalidade: document.getElementById('aluno-modalidade').value,
                indicacao: document.getElementById('aluno-indicacao').value,
                startDate: document.getElementById('aluno-startDate').value,
                local: document.getElementById('aluno-local').value,
                estado: document.getElementById('aluno-estado').value,
                continente: document.getElementById('aluno-continente').value,
                foraBrasil: document.getElementById('aluno-fora-brasil').checked,
                currentLevel: document.getElementById('aluno-currentLevel').value || '',
                completedLevels: completedLevels,
                neverCompletedLevels: document.getElementById('aluno-neverCompletedLevels').checked,
                notes: document.getElementById('aluno-notes').value,
                isMinor: isMinor,
                responsibleName: isMinor ? document.getElementById('aluno-responsibleName').value : '',
                responsiblePhone: isMinor ? document.getElementById('aluno-responsiblePhone').value : '',
                // Personal information fields
                birthDate: document.getElementById('aluno-birthDate').value,
                gender: document.getElementById('aluno-gender').value,
                cpf: document.getElementById('aluno-cpf').value,
                estadoCivil: document.getElementById('aluno-estadoCivil').value,
                profissao: document.getElementById('aluno-profissao').value,
                endereco: document.getElementById('aluno-endereco').value,
                // Cancellation fields (only saved if status is Cancelado)
                cancellationDate: isCancelled ? document.getElementById('aluno-cancellationDate').value : '',
                cancellationReason: isCancelled ? document.getElementById('aluno-cancellationReason').value : '',
                processedBy: isCancelled ? document.getElementById('aluno-processedBy').value : '',
            };

            // Only add financial fields if user has permission
            if (canViewFinancialInfo) {
                data.paymentType = document.getElementById('aluno-paymentType').value;
                data.parcelas = document.getElementById('aluno-parcelas').value;
                data.amountPaid = document.getElementById('aluno-amountPaid').value;
                data.amountReceived = document.getElementById('aluno-amountReceived').value;
            }
            if (!data.name) { showErrorMessage("Erro", "O nome do aluno √© obrigat√≥rio."); return; }
            if (!data.modalidade) { showErrorMessage("Erro", "A modalidade √© obrigat√≥ria."); return; }
            
            // Validation for cancellation fields
            if (isCancelled) {
                if (!data.cancellationDate) { showErrorMessage("Erro", "A data do cancelamento √© obrigat√≥ria."); return; }
                if (!data.cancellationReason) { showErrorMessage("Erro", "O motivo do cancelamento √© obrigat√≥rio."); return; }
                if (!data.processedBy) { showErrorMessage("Erro", "O respons√°vel pelo processamento √© obrigat√≥rio."); return; }
            }

            try {
                if (window.isDevelopmentMode) {
                    // Development mode - save to localStorage
                    if (alunoId) {
                        const index = students.findIndex(s => s.id === alunoId);
                        if (index !== -1) {
                            students[index] = { ...students[index], ...data, id: alunoId };
                        }
                    } else {
                        data.id = 'student_' + Date.now();
                        data.createdAt = new Date();
                        students.push(data);
                    }
                    localStorage.setItem('students', JSON.stringify(students));
                } else {
                    // Firebase mode
                    if (alunoId) {
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/students`, alunoId), data);
                        await logActivity('editar', 'aluno', data.name, { modalidade: data.modalidade, status: data.status });
                    } else {
                        data.createdAt = serverTimestamp();
                        await addDoc(collection(db, `artifacts/${appId}/public/data/students`), data);
                        await logActivity('criar', 'aluno', data.name, { modalidade: data.modalidade });
                    }
                }
                
                // Show success message and close modal
                const successMsg = alunoId ? "Dados do aluno atualizados." : "Novo aluno cadastrado.";
                showSuccessMessage("Sucesso!", successMsg);
                closeFormModal();
                
                // Re-render the current section if needed
                const activePageId = contentArea.firstElementChild?.id;
                if (activePageId === 'alunos-section') {
                    renderAlunosSection();
                }
            } catch (error) {
                console.error("Error saving student:", error);
                showErrorMessage("Erro", "Falha ao salvar os dados do aluno.");
            }
        }

        function openAlunoModal(alunoId) {
            clearModalHeaderButtons();
            const aluno = students.find(s => s.id === alunoId);
            if (!aluno) return;
            document.getElementById('form-modal-title').textContent = `Perfil de ${aluno.name}`;
            const canEdit = ['admin', 'financeiro', 'pedagogico', 'ap'].includes(currentUserRole);
            const canEditPedagogical = currentUserRole === 'teacher';
            const canViewFinancialInfo = canViewStudentFinancials();

            let responsibleHtml = '';
            if (aluno.isMinor && aluno.responsibleName) {
                responsibleHtml = `
                    <div class="mt-4 pt-4 border-t">
                        <h4 class="font-semibold text-stone-700">Dados do Respons√°vel</h4>
                        <p class="text-sm text-stone-600 mt-1"><strong>Nome:</strong> ${aluno.responsibleName || 'N/A'}</p>
                        <p class="text-sm text-stone-600"><strong>Telefone:</strong> ${aluno.responsiblePhone || 'N/A'}</p>
                    </div>
                `;
            }

            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between items-start">
                        <h3 class="text-xl font-bold text-stone-800">${aluno.name}</h3>
                        <span class="status-tag status-${(aluno.status || 'pendente').toLowerCase()}">${aluno.status || 'Pendente'}</span>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2 text-sm text-stone-600">
                        <p><strong>Modalidade:</strong> <span class="status-tag status-${(aluno.modalidade || 'turma').toLowerCase()}">${aluno.modalidade || 'TURMA'}</span></p>
                        <p><strong>In√≠cio:</strong> ${formatDateBR(aluno.startDate)}</p>
                        ${canViewFinancialInfo ? `<p><strong>Pagamento:</strong> ${aluno.paymentType || 'N/A'}</p>` : ''}
                        ${canViewFinancialInfo ? `<p><strong>Parcelas:</strong> ${aluno.parcelas ? `${aluno.parcelas}x` : 'N√£o informado'}</p>` : ''}
                        <p><strong>Indica√ß√£o:</strong> ${aluno.indicacao || 'N√£o informado'}</p>
                        ${canViewFinancialInfo ? `<p><strong>Valor Pago:</strong> R$ ${parseFloat(aluno.amountPaid || 0).toFixed(2)}</p>` : ''}
                        ${canViewFinancialInfo ? `<p><strong>Valor Recebido:</strong> R$ ${parseFloat(aluno.amountReceived || 0).toFixed(2)}</p>` : ''}
                    </div>

                    <div class="pt-2">
                        <p class="font-semibold text-sm text-stone-700">N√≠vel Atual:</p>
                        <div class="mt-1">
                            ${aluno.currentLevel ? 
                                `<span class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-br from-green-50 to-green-100 border-2 border-green-300 rounded-lg text-sm font-bold text-green-800">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                    </svg>
                                    ${aluno.currentLevel}
                                </span>` : 
                                '<span class="text-sm text-stone-500">N√£o est√° cursando nenhum n√≠vel no momento</span>'
                            }
                        </div>
                    </div>

                    ${aluno.modalidade !== 'VIP' ? `
                    <div class="pt-2">
                        <p class="font-semibold text-sm text-stone-700">Turma Atual:</p>
                        <div class="mt-1">
                            ${(() => {
                                const currentTurma = turmas.find(t => t.studentIds && t.studentIds.includes(alunoId));
                                if (currentTurma) {
                                    return `<span class="inline-flex items-center gap-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-lg text-sm font-medium">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                                        </svg>
                                        ${currentTurma.name}
                                    </span>`;
                                } else {
                                    return '<span class="text-sm text-stone-500">N√£o est√° em nenhuma turma</span>';
                                }
                            })()}
                        </div>
                    </div>
                    ` : ''}

                    <div class="pt-2">
                        <p class="font-semibold text-sm text-stone-700">N√≠veis Cursados (Hist√≥rico):</p>
                        <div class="flex flex-wrap gap-2 mt-1">
                            ${(aluno.completedLevels && aluno.completedLevels.length > 0) ? aluno.completedLevels.map(item => {
                                const level = typeof item === 'string' ? item : item.level;
                                const semester = typeof item === 'string' ? '' : item.semester;
                                const modalidade = typeof item === 'string' ? '' : item.modalidade;
                                const isReprovacao = typeof item === 'object' ? item.isReprovacao : false;
                                const modalidadeChange = typeof item === 'object' ? item.modalidadeChange : null;
                                
                                if (semester) {
                                    const bgColor = isReprovacao ? 'from-red-50 to-red-100' : 'from-yellow-50 to-yellow-100';
                                    const borderColor = isReprovacao ? 'border-red-300' : 'border-yellow-200';
                                    const textColor = isReprovacao ? 'text-red-800' : 'text-stone-800';
                                    const semesterColor = isReprovacao ? 'text-red-600' : 'text-stone-600';
                                    const reprovacaoIcon = isReprovacao ? `
                                        <svg class="w-3 h-3 text-red-600 inline-block ml-1" fill="currentColor" viewBox="0 0 20 20" title="Reprova√ß√£o">
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                        </svg>
                                    ` : '';
                                    
                                    const modalidadeChangeText = modalidadeChange ? `\nMudan√ßa de modalidade: ${modalidadeChange.from} ‚Üí ${modalidadeChange.to}` : '';
                                    const modalidadeChangeIcon = modalidadeChange ? `
                                        <svg class="w-3 h-3 text-blue-600 inline-block ml-1" fill="currentColor" viewBox="0 0 20 20" title="Mudan√ßa de modalidade: ${modalidadeChange.from} ‚Üí ${modalidadeChange.to}">
                                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
                                            <path d="M5 8a1 1 0 011-1h4a1 1 0 110 2H6a1 1 0 01-1-1z"/>
                                        </svg>
                                    ` : '';
                                    
                                    return `<span class="inline-flex flex-col items-start px-3 py-1 bg-gradient-to-br ${bgColor} border ${borderColor} rounded-lg" title="${isReprovacao ? 'Reprova√ß√£o - Aluno repetiu este n√≠vel' : ''}${modalidadeChangeText}">
                                        <span class="text-xs font-semibold ${textColor}">${level}${reprovacaoIcon}${modalidadeChangeIcon}</span>
                                        <span class="text-xs ${semesterColor}">${semester}${modalidade ? ` ¬∑ ${modalidade}` : ''}</span>
                                        ${modalidadeChange ? `<span class="text-xs text-blue-600 mt-0.5">üìã ${modalidadeChange.from} ‚Üí ${modalidadeChange.to}</span>` : ''}
                                    </span>`;
                                } else {
                                    return `<span class="keyword-tag !m-0">${level}</span>`;
                                }
                            }).join('') : '<span class="text-sm text-stone-500">Nenhum</span>'}
                        </div>
                        ${(aluno.reprovacaoHistory && aluno.reprovacaoHistory.length > 0) ? `
                        <div class="mt-3 p-3 bg-red-50 border border-red-200 rounded-lg">
                            <p class="text-xs font-semibold text-red-800 mb-2">‚ö†Ô∏è Hist√≥rico de Reprova√ß√µes:</p>
                            <div class="space-y-1">
                                ${aluno.reprovacaoHistory.map(rep => `
                                    <p class="text-xs text-red-700">‚Ä¢ ${rep.level} - ${rep.semester} (${formatDateBR(rep.date)})</p>
                                `).join('')}
                            </div>
                        </div>
                        ` : ''}
                    </div>

                    ${(aluno.birthDate || aluno.gender || aluno.cpf || aluno.estadoCivil || aluno.profissao || aluno.endereco) ? `
                    <div class="mt-4 pt-4 border-t">
                        <h4 class="font-semibold text-stone-700 mb-2">Informa√ß√µes Pessoais</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-stone-600">
                            ${aluno.birthDate ? `<p><strong>Data de Nascimento:</strong> ${formatDateBR(aluno.birthDate)}</p>` : ''}
                            ${aluno.gender ? `<p><strong>G√™nero:</strong> ${aluno.gender}</p>` : ''}
                            ${aluno.cpf ? `<p><strong>CPF:</strong> ${aluno.cpf}</p>` : ''}
                            ${aluno.estadoCivil ? `<p><strong>Estado Civil:</strong> ${aluno.estadoCivil}</p>` : ''}
                            ${aluno.profissao ? `<p><strong>Profiss√£o:</strong> ${aluno.profissao}</p>` : ''}
                        </div>
                        ${aluno.endereco ? `<p class="text-sm text-stone-600 mt-2"><strong>Endere√ßo:</strong> ${aluno.endereco}</p>` : ''}
                    </div>
                    ` : ''}

                    ${responsibleHtml}

                    ${aluno.status === 'Cancelado' && aluno.cancellationDate ? `
                    <div class="mt-4 pt-4 border-t border-red-200 bg-red-50 p-4 rounded-lg">
                        <h4 class="font-semibold text-red-700 mb-2">Informa√ß√µes do Cancelamento</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-red-700">
                            <p><strong>Data:</strong> ${formatDateBR(aluno.cancellationDate)}</p>
                            <p><strong>Processado por:</strong> ${aluno.processedBy || 'N/A'}</p>
                        </div>
                        ${aluno.cancellationReason ? `<p class="mt-2 text-sm text-red-700"><strong>Motivo:</strong></p><p class="mt-1 p-2 bg-red-100 rounded text-sm text-red-800 whitespace-pre-wrap">${aluno.cancellationReason}</p>` : ''}
                    </div>
                    ` : ''}

                    ${aluno.notes ? `<div class="mt-4 pt-4 border-t"><strong>Observa√ß√µes:</strong><p class="mt-1 p-3 bg-stone-50 rounded-md whitespace-pre-wrap text-sm">${aluno.notes}</p></div>` : ''}

                    <div class="border-t pt-4 flex justify-end gap-2">
                        ${canEdit ? `<button class="primary-btn !bg-[#F1D24B] hover:!bg-[#E5C63F] !text-stone-900" onclick="openRematriculaForm('${aluno.id}'); event.preventDefault();">Rematricular</button>` : ''}
                        ${canEdit ? `<button class="secondary-btn" data-action="edit-aluno" data-id="${aluno.id}">Editar</button>
                        <button class="danger-btn" data-action="delete-item" data-collection="students" data-id="${aluno.id}">Apagar</button>` : ''}
                        ${canEditPedagogical ? `<button class="secondary-btn" onclick="openPedagogicalEditModal('${aluno.id}'); event.preventDefault();">Editar N√≠veis</button>` : ''}
                        <button class="primary-btn" data-action="close-modal">Fechar</button>
                    </div>
                </div>`;
            document.getElementById('form-modal').classList.add('visible');
        }

        // Pedagogical Edit Modal for Teachers
        window.openPedagogicalEditModal = function(alunoId) {
            clearModalHeaderButtons();
            const aluno = students.find(s => s.id === alunoId);
            if (!aluno) return;
            
            // Pre-compute the completed levels HTML to avoid nested template literals
            const completedLevels = aluno?.completedLevels || [];
            let levelsHtml = '';
            
            if (completedLevels.length === 0) {
                levelsHtml = '<p class="text-sm text-stone-500 text-center py-4">Nenhum n√≠vel cursado ainda</p>';
            } else {
                levelsHtml = completedLevels.map((item, index) => {
                    const level = typeof item === 'string' ? item : item.level;
                    const semester = typeof item === 'string' ? '' : (item.semester || '');
                    const modalidade = typeof item === 'string' ? '' : (item.modalidade || '');
                    
                    const levelOptions = STANDARD_LEVELS.map(lv => 
                        '<option value="' + lv + '"' + (lv === level ? ' selected' : '') + '>' + lv + '</option>'
                    ).join('');
                    
                    return '<div class="flex items-center gap-2 bg-white p-2 rounded border border-stone-200" data-level-index="' + index + '">' +
                        '<select class="flex-1 text-sm border border-stone-300 rounded px-2 py-1 level-select" onchange="updateLevelData()">' +
                        '<option value="">Selecione o n√≠vel</option>' + levelOptions +
                        '</select>' +
                        '<input type="text" placeholder="Ex: 2025.1" value="' + semester + '" ' +
                        'class="w-24 text-sm border border-stone-300 rounded px-2 py-1 semester-input" ' +
                        'onchange="updateLevelData()" pattern="\\d{4}\\.[12]" title="Formato: YYYY.1 ou YYYY.2">' +
                        '<select class="w-28 text-sm border border-stone-300 rounded px-2 py-1 modalidade-select" onchange="updateLevelData()">' +
                        '<option value="">Modalidade</option>' +
                        '<option value="VIP"' + (modalidade === 'VIP' ? ' selected' : '') + '>VIP</option>' +
                        '<option value="TURMA"' + (modalidade === 'TURMA' ? ' selected' : '') + '>TURMA</option>' +
                        '<option value="DUPLA"' + (modalidade === 'DUPLA' ? ' selected' : '') + '>DUPLA</option>' +
                        '</select>' +
                        '<button type="button" onclick="removeCompletedLevel(' + index + ')" class="text-red-600 hover:text-red-700 p-1">' +
                        '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>' +
                        '</svg></button>' +
                        '</div>';
                }).join('');
            }
            
            // Pre-compute current level options
            const currentLevelOptions = STANDARD_LEVELS.map(lv => 
                '<option value="' + lv + '"' + (aluno?.currentLevel === lv ? ' selected' : '') + '>' + lv + '</option>'
            ).join('');
            
            document.getElementById('form-modal-title').textContent = 'Editar N√≠veis - ' + aluno.name;
            document.getElementById('form-modal-content-area').innerHTML =
                '<form id="pedagogical-edit-form" class="space-y-4">' +
                    '<input type="hidden" id="ped-aluno-id" value="' + alunoId + '">' +
                    '<div class="bg-blue-50 p-4 rounded-lg border border-blue-200">' +
                        '<p class="text-sm text-blue-800"><strong>Aluno:</strong> ' + aluno.name + '</p>' +
                        '<p class="text-sm text-blue-600 mt-1">Voc√™ pode editar apenas as informa√ß√µes pedag√≥gicas (n√≠veis cursados e n√≠vel atual)</p>' +
                    '</div>' +
                    '<div>' +
                        '<div class="flex justify-between items-center mb-2">' +
                            '<label class="font-medium text-sm">N√≠veis Cursados (Hist√≥rico)</label>' +
                            '<button type="button" onclick="addCompletedLevel()" class="text-sm bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-md flex items-center gap-1">' +
                                '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                                    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>' +
                                '</svg>' +
                                'Adicionar N√≠vel' +
                            '</button>' +
                        '</div>' +
                        '<div id="aluno-levels-list" class="space-y-2 max-h-60 overflow-y-auto p-2 border rounded-md bg-stone-50">' +
                            levelsHtml +
                        '</div>' +
                    '</div>' +
                    '<div>' +
                        '<label class="font-medium text-sm">N√≠vel Atual (que est√° cursando agora)</label>' +
                        '<select id="ped-aluno-currentLevel" class="form-input mt-2">' +
                            '<option value="">Nenhum (n√£o est√° cursando)</option>' +
                            currentLevelOptions +
                        '</select>' +
                        '<p class="text-xs text-stone-500 mt-1">Selecione o n√≠vel que o aluno est√° cursando atualmente</p>' +
                    '</div>' +
                    '<div class="border-t pt-4 flex justify-end gap-2">' +
                        '<button type="submit" class="primary-btn">Salvar Altera√ß√µes</button>' +
                        '<button type="button" class="secondary-btn" data-action="close-modal">Cancelar</button>' +
                    '</div>' +
                '</form>';

            const form = document.getElementById('pedagogical-edit-form');
            if (form) {
                form.onsubmit = savePedagogicalData;
            }
            document.getElementById('form-modal').classList.add('visible');
        };

        async function savePedagogicalData(event) {
            event.preventDefault();
            const alunoId = document.getElementById('ped-aluno-id').value;
            const completedLevels = getCompletedLevelsFromForm();
            const currentLevel = document.getElementById('ped-aluno-currentLevel').value || '';

            try {
                if (window.isDevelopmentMode) {
                    // Development mode - save to localStorage
                    const index = students.findIndex(s => s.id === alunoId);
                    if (index !== -1) {
                        students[index].completedLevels = completedLevels;
                        students[index].currentLevel = currentLevel;
                        localStorage.setItem('students', JSON.stringify(students));
                    }
                } else {
                    // Firebase mode
                    const studentRef = doc(db, `artifacts/${appId}/public/data/students`, alunoId);
                    await updateDoc(studentRef, {
                        completedLevels: completedLevels,
                        currentLevel: currentLevel
                    });
                }

                showSuccessMessage("Sucesso!", "N√≠veis do aluno atualizados com sucesso.");
                closeFormModal();

                // Re-render if in students section
                const activePageId = contentArea.firstElementChild?.id;
                if (activePageId === 'alunos-section') {
                    renderAlunosSection();
                }
            } catch (error) {
                console.error("Error saving pedagogical data:", error);
                showErrorMessage("Erro", "Falha ao salvar os n√≠veis do aluno.");
            }
        }

        // Rematr√≠cula Functions
        window.openRematriculaForm = function(alunoId) {
            const aluno = students.find(s => s.id === alunoId);
            if (!aluno) {
                showErrorMessage("Erro", "Aluno n√£o encontrado.");
                return;
            }

            // Check if student has enrollment (active or expired)
            let hasVip = false;
            let hasTurma = false;
            let currentVip = null;
            let currentTurma = null;

            // Check VIP - find the most recent VIP (active or expired)
            const studentVips = vips.filter(v => String(v.studentId) === String(alunoId));
            if (studentVips.length > 0) {
                // Sort by start date (most recent first) or by creation date if available
                studentVips.sort((a, b) => {
                    const dateA = new Date(a.startDate || a.createdAt || 0);
                    const dateB = new Date(b.startDate || b.createdAt || 0);
                    return dateB - dateA;
                });
                currentVip = studentVips[0];
                hasVip = true;
            }

            // Check Turma (compare as strings to ensure match)
            currentTurma = turmas.find(t => t.studentIds && t.studentIds.some(id => String(id) === String(alunoId)));
            if (currentTurma) hasTurma = true;

            if (!hasVip && !hasTurma) {
                showErrorMessage("Erro", "Este aluno n√£o possui matr√≠cula em VIP ou Turma para rematr√≠cula.\n\nPara fazer rematr√≠cula, o aluno precisa ter hist√≥rico de matr√≠cula em turma ou VIP.");
                return;
            }

            // Check if VIP contract is expired
            const isVipExpired = currentVip && currentVip.endDate && new Date(currentVip.endDate) < new Date();
            const isVipActive = currentVip && (!currentVip.endDate || new Date(currentVip.endDate) >= new Date());
            const enrollmentStatus = isVipExpired ? ' (contrato expirado)' : (isVipActive ? ' (ativo)' : '');
            
            // Define variables for template
            const hasActiveVip = isVipActive;
            const hasActiveTurma = hasTurma;
            
            const enrollmentInfo = hasVip 
                ? `VIP - ${currentVip.level || 'N√≠vel n√£o especificado'}${enrollmentStatus}`
                : `Turma - ${currentTurma.name || 'Nome n√£o especificado'}`;

            // Generate level options for both selects
            const levelOptions = STANDARD_LEVELS.map(level => 
                `<option value="${level}">${level}</option>`
            ).join('');

            const paymentMethods = ['Cart√£o de Cr√©dito', 'Boleto', 'PIX', 'Dinheiro', 'Transfer√™ncia Banc√°ria', 'Outro'];
            const paymentOptions = paymentMethods.map(method => 
                `<option value="${method}" ${aluno.paymentMethod === method ? 'selected' : ''}>${method}</option>`
            ).join('');

            document.getElementById('form-modal-title').textContent = 'Rematr√≠cula de Aluno';
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <p class="text-sm text-blue-800 mb-2"><strong>Aluno:</strong> ${aluno.name}</p>
                        <p class="text-sm text-blue-800"><strong>Matr√≠cula Atual:</strong> ${enrollmentInfo}</p>
                    </div>

                    <!-- Alerta de Reprova√ß√£o (oculto inicialmente) -->
                    <div id="reprovacao-alert" class="hidden bg-red-50 p-4 rounded-lg border border-red-300">
                        <div class="flex items-start gap-3">
                            <svg class="w-6 h-6 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            <div>
                                <p class="text-sm font-bold text-red-800 mb-1">‚ö†Ô∏è ATEN√á√ÉO: Aluno Repetindo N√≠vel (Reprova√ß√£o)</p>
                                <p class="text-sm text-red-700">O aluno est√° sendo rematriculado no mesmo n√≠vel. Esta informa√ß√£o ser√° registrada no hist√≥rico para controle pedag√≥gico.</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-300">
                        <p class="text-sm text-yellow-800 mb-3 font-semibold">Defina os n√≠veis para a rematr√≠cula:</p>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-stone-700 mb-1">
                                    N√≠vel atual do aluno (ser√° movido para hist√≥rico):
                                </label>
                                <select id="rematricula-current-level" class="w-full px-3 py-2 border border-stone-300 rounded-lg" onchange="checkForReprovacao()">
                                    <option value="">-- Selecione o n√≠vel atual --</option>
                                    ${levelOptions}
                                    <option value="${aluno.currentLevel || ''}" ${aluno.currentLevel ? 'selected' : ''}>${aluno.currentLevel || 'N√≠vel n√£o definido'}</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-stone-700 mb-1">
                                    Novo n√≠vel para rematr√≠cula:
                                </label>
                                <select id="rematricula-new-level" class="w-full px-3 py-2 border border-stone-300 rounded-lg" onchange="checkForReprovacao()">
                                    <option value="">-- Limpar n√≠vel (liberar aluno) --</option>
                                    ${levelOptions}
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-stone-700 mb-1">
                                    Nova modalidade:
                                </label>
                                <select id="rematricula-modalidade" class="w-full px-3 py-2 border border-stone-300 rounded-lg">
                                    <option value="">-- Manter modalidade atual (${aluno.modalidade || 'N/A'}) --</option>
                                    <option value="VIP">VIP</option>
                                    <option value="TURMA">TURMA</option>
                                    <option value="DUPLA">DUPLA</option>
                                </select>
                                <p class="text-xs text-stone-500 mt-1">Selecione para alterar de VIP para TURMA/DUPLA ou vice-versa</p>
                            </div>
                        </div>
                    </div>

                    <!-- Informa√ß√µes Financeiras -->
                    <div class="bg-green-50 p-4 rounded-lg border border-green-300">
                        <p class="text-sm text-green-800 mb-3 font-semibold">Atualizar Informa√ß√µes Financeiras:</p>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-stone-700 mb-1">
                                    Valor da Mensalidade (R$):
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-stone-500">R$</span>
                                    <input type="number" id="rematricula-monthly-value" class="w-full pl-10 px-3 py-2 border border-stone-300 rounded-lg" 
                                           step="0.01" min="0" value="${aluno.monthlyValue || 0}" placeholder="0,00">
                                </div>
                                <p class="text-xs text-stone-500 mt-1">Deixe em branco ou zero se n√£o houver altera√ß√£o</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-stone-700 mb-1">
                                    Modalidade de Pagamento:
                                </label>
                                <select id="rematricula-payment-method" class="w-full px-3 py-2 border border-stone-300 rounded-lg">
                                    <option value="">-- Sem altera√ß√£o --</option>
                                    ${paymentOptions}
                                </select>
                            </div>
                        </div>
                    </div>

                    <p class="text-stone-700 text-sm">Esta a√ß√£o ir√°:</p>
                    <ul class="list-disc list-inside text-sm text-stone-600 space-y-1">
                        ${hasActiveVip ? '<li>Finalizar o contrato VIP atual (definir data de t√©rmino como hoje)</li>' : ''}
                        ${hasActiveTurma ? '<li>Manter o aluno vinculado √† turma atual para hist√≥rico de notas e presen√ßa</li>' : ''}
                        <li>Mover o n√≠vel selecionado para n√≠veis cursados</li>
                        <li>Atribuir o novo n√≠vel ao aluno</li>
                        <li>Atualizar informa√ß√µes financeiras (se preenchidas)</li>
                        <li>Liberar o aluno para nova matr√≠cula em VIP ou Turma</li>
                    </ul>

                    <div class="pt-4 border-t flex justify-end gap-2">
                        <button class="secondary-btn" onclick="closeFormModal(); event.preventDefault();">Cancelar</button>
                        <button class="primary-btn !bg-[#F1D24B] hover:!bg-[#E5C63F] !text-stone-900" onclick="finalizeEnrollmentAndRematriculate('${alunoId}'); event.preventDefault();">Confirmar Rematr√≠cula</button>
                    </div>
                </div>
            `;
            document.getElementById('form-modal').classList.add('visible');
            
            // Check for reprovacao on initial load
            setTimeout(checkForReprovacao, 100);
        };

        // Function to check if student is repeating the level (reprovacao)
        window.checkForReprovacao = function() {
            const currentLevel = document.getElementById('rematricula-current-level')?.value || '';
            const newLevel = document.getElementById('rematricula-new-level')?.value || '';
            const alert = document.getElementById('reprovacao-alert');
            
            if (alert && currentLevel && newLevel && currentLevel === newLevel) {
                alert.classList.remove('hidden');
            } else if (alert) {
                alert.classList.add('hidden');
            }
        };

        window.finalizeEnrollmentAndRematriculate = async function(alunoId) {
            const aluno = students.find(s => s.id === alunoId);
            if (!aluno) {
                showErrorMessage("Erro", "Aluno n√£o encontrado.");
                return;
            }

            // Get selected levels from form
            const currentLevelToArchive = document.getElementById('rematricula-current-level')?.value || '';
            const newLevel = document.getElementById('rematricula-new-level')?.value || '';

            // Get financial information from form
            const monthlyValue = parseFloat(document.getElementById('rematricula-monthly-value')?.value) || 0;
            const paymentMethod = document.getElementById('rematricula-payment-method')?.value || '';
            
            // Get new modalidade from form
            const newModalidade = document.getElementById('rematricula-modalidade')?.value || '';

            // Validate that current level was selected
            if (!currentLevelToArchive) {
                showErrorMessage("Erro", "Por favor, selecione o n√≠vel atual do aluno para mover ao hist√≥rico.");
                return;
            }

            // Check if student is repeating level (reprovacao)
            const isReprovacao = currentLevelToArchive === newLevel && newLevel !== '';

            let wasVip = false;
            let wasTurma = false;

            try {
                // Move selected current level to completedLevels and set new level
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth() + 1; // 0-indexed
                const semester = month <= 6 ? `${year}.1` : `${year}.2`;
                
                // Initialize completedLevels if it doesn't exist
                const completedLevels = aluno.completedLevels || [];
                
                // Check if there's a modalidade change
                const oldModalidade = aluno.modalidade || '';
                const hasModalidadeChange = newModalidade && newModalidade !== oldModalidade;
                
                // Add selected current level to completed levels with reprovacao flag and modalidade change
                const levelEntry = {
                    level: currentLevelToArchive,
                    semester: semester,
                    isReprovacao: isReprovacao
                };
                
                // Add modalidade change information if applicable
                if (hasModalidadeChange) {
                    levelEntry.modalidadeChange = {
                        from: oldModalidade,
                        to: newModalidade,
                        date: now.toISOString().split('T')[0]
                    };
                }
                
                completedLevels.push(levelEntry);
                
                // Update student - move selected level to completed and set new level
                const updatedStudentData = {
                    completedLevels: completedLevels,
                    currentLevel: newLevel
                };

                // Add financial information if provided
                if (monthlyValue > 0) {
                    updatedStudentData.monthlyValue = monthlyValue;
                }
                if (paymentMethod) {
                    updatedStudentData.paymentMethod = paymentMethod;
                }
                
                // Add new modalidade if provided
                if (newModalidade) {
                    updatedStudentData.modalidade = newModalidade;
                }

                // Add reprovacao history if applicable
                if (isReprovacao) {
                    const reprovacaoHistory = aluno.reprovacaoHistory || [];
                    reprovacaoHistory.push({
                        level: currentLevelToArchive,
                        semester: semester,
                        date: now.toISOString().split('T')[0]
                    });
                    updatedStudentData.reprovacaoHistory = reprovacaoHistory;
                }
                
                if (window.isDevelopmentMode) {
                    const studentIndex = students.findIndex(s => s.id === alunoId);
                    if (studentIndex !== -1) {
                        students[studentIndex] = { ...students[studentIndex], ...updatedStudentData };
                        localStorage.setItem('students', JSON.stringify(students));
                    }
                } else {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/students`, alunoId), updatedStudentData);
                }
                
                // Find and finalize VIP enrollment
                const activeVip = vips.find(v => v.studentId === alunoId && (!v.endDate || new Date(v.endDate) >= new Date()));
                if (activeVip) {
                    wasVip = true;
                    const today = new Date().toISOString().split('T')[0];
                    
                    if (window.isDevelopmentMode) {
                        const index = vips.findIndex(v => v.id === activeVip.id);
                        if (index !== -1) {
                            vips[index].endDate = today;
                            localStorage.setItem('vips', JSON.stringify(vips));
                        }
                    } else {
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/vips`, activeVip.id), {
                            endDate: today
                        });
                    }
                }

                // Keep student in Turma for historical data (notas, presen√ßa)
                // NO LONGER REMOVING FROM TURMA - student stays linked for grade/attendance history
                const activeTurma = turmas.find(t => t.studentIds && t.studentIds.includes(alunoId));
                if (activeTurma) {
                    wasTurma = true;
                    // Student remains in turma - no removal needed
                }

                // Close modal and show success message
                closeFormModal();
                
                // Small delay to ensure modal closes properly, then show success
                setTimeout(() => {
                    const levelMessage = newLevel 
                        ? `Novo n√≠vel definido: ${newLevel}` 
                        : 'N√≠vel limpo - aluno liberado';
                    
                    const reprovacaoMessage = isReprovacao 
                        ? '\n\n‚ö†Ô∏è REPROVA√á√ÉO REGISTRADA: O aluno est√° repetindo o n√≠vel. Esta informa√ß√£o foi registrada no hist√≥rico para controle pedag√≥gico.' 
                        : '';
                    
                    const financialMessage = (monthlyValue > 0 || paymentMethod) 
                        ? `\n\nInforma√ß√µes financeiras atualizadas:${monthlyValue > 0 ? `\n- Mensalidade: R$ ${monthlyValue.toFixed(2)}` : ''}${paymentMethod ? `\n- Forma de pagamento: ${paymentMethod}` : ''}` 
                        : '';
                    
                    const oldModalidade = aluno.modalidade || '';
                    const hasModalidadeChange = newModalidade && newModalidade !== oldModalidade;
                    
                    const modalidadeMessage = hasModalidadeChange
                        ? `\n\nüìã MUDAN√áA DE MODALIDADE REGISTRADA:\nDe: ${oldModalidade}\nPara: ${newModalidade}\n(Registrado no hist√≥rico do aluno)` 
                        : (newModalidade ? `\n\nModalidade mantida: ${newModalidade}` : '');
                    
                    showSuccessMessage("Sucesso", `Rematr√≠cula conclu√≠da com sucesso!\n\nN√≠vel "${currentLevelToArchive}" movido para hist√≥rico.\n${levelMessage}${reprovacaoMessage}${financialMessage}${modalidadeMessage}\n\n${wasTurma ? 'O aluno permanece vinculado √† turma antiga para manter hist√≥rico de notas e presen√ßa.\n' : ''}O aluno est√° liberado para nova matr√≠cula em VIP ou Turma.`);
                }, 300);

            } catch (error) {
                console.error("Error during rematr√≠cula:", error);
                showErrorMessage("Erro", "Erro ao processar rematr√≠cula: " + error.message);
            }
        };

        // Helper function to get students already allocated to other classes
        function getStudentsAllocatedToOtherTurmas(excludeTurmaId = null) {
            const allocatedStudentIds = new Set();
            
            turmas.forEach(turma => {
                // Skip the current turma being edited
                if (excludeTurmaId && turma.id === excludeTurmaId) return;
                
                if (turma.studentIds && Array.isArray(turma.studentIds)) {
                    turma.studentIds.forEach(studentId => {
                        allocatedStudentIds.add(studentId);
                    });
                }
            });
            
            return allocatedStudentIds;
        }

        function openTurmaForm(turmaId = null) {
            clearModalHeaderButtons();
            const turma = turmaId ? turmas.find(t => t.id === turmaId) : null;
            document.getElementById('form-modal-title').textContent = turma ? "Editar Turma" : "Adicionar Nova Turma";

            const teacherOptions = collaborators.filter(c => c.sectors?.includes('professor')).map(c => `<option value="${c.id}" data-name="${c.name}" ${turma?.teacherId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
            const levelOptions = STANDARD_LEVELS.map(level => `<option value="${level}" ${turma?.level === level ? 'selected' : ''}>${level}</option>`).join('') + `<option value="outro">Outro (especificar)</option>`;

            // Get students already allocated to other classes (excluding current class if editing)
            const allocatedStudentIds = getStudentsAllocatedToOtherTurmas(turmaId);

            const studentCheckboxes = students
                .filter(s => s.status === 'Ativo' && s.modalidade === 'TURMA')
                .sort((a, b) => a.name.localeCompare(b.name))
                .map(s => {
                    const isCurrentlyInThisTurma = (turma?.studentIds || []).includes(s.id);
                    const isAllocatedToOtherTurma = allocatedStudentIds.has(s.id);
                    const otherTurmas = isAllocatedToOtherTurma ? turmas.filter(t => t.id !== turmaId && (t.studentIds || []).includes(s.id)) : [];
                    
                    return `
                    <div class="flex items-center">
                        <input type="checkbox" id="student-${s.id}" value="${s.id}" name="turma-students" 
                               class="h-4 w-4 rounded" 
                               ${isCurrentlyInThisTurma ? 'checked' : ''}>
                        <label for="student-${s.id}" class="ml-2 text-sm cursor-pointer">
                            ${s.name} 
                            <span class="text-xs text-stone-400">(TURMA)</span>
                            ${otherTurmas.length > 0 ? `<span class="text-xs text-blue-500"> - Tamb√©m em: ${otherTurmas.map(t => t.name).join(', ')}</span>` : ''}
                        </label>
                    </div>
                `}).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="turma-id" value="${turmaId || ''}">
                    <input type="hidden" id="turma-name" value="${turma?.name || ''}">
                    
                    ${turma ? `<div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-sm font-medium text-yellow-800">Nome atual da turma:</p>
                        <p class="text-base font-bold text-yellow-900 mt-1">${turma.name}</p>
                    </div>` : ''}
                    
                    <div><label class="font-medium text-sm">Professor <span class="text-red-500">*</span></label><select id="turma-teacher" class="form-input" required>${teacherOptions}</select></div>
                    <div>
                        <label class="font-medium text-sm">N√≠vel <span class="text-red-500">*</span></label>
                        <select id="turma-level" class="form-input" required>
                            ${(() => {
                                // Check if the turma has a custom level (not in STANDARD_LEVELS)
                                const hasCustomLevel = turma && turma.level && !STANDARD_LEVELS.includes(turma.level);
                                const options = STANDARD_LEVELS.map(level => 
                                    `<option value="${level}" ${turma?.level === level ? 'selected' : ''}>${level}</option>`
                                ).join('');
                                const outroOption = `<option value="outro" ${hasCustomLevel ? 'selected' : ''}>Outro (especificar)</option>`;
                                return options + outroOption;
                            })()}
                        </select>
                        <input type="text" id="turma-level-custom" class="form-input mt-2 ${turma && turma.level && !STANDARD_LEVELS.includes(turma.level) ? '' : 'hidden'}" 
                               placeholder="Digite o n√≠vel personalizado" 
                               value="${turma && turma.level && !STANDARD_LEVELS.includes(turma.level) ? turma.level : ''}"
                               ${turma && turma.level && !STANDARD_LEVELS.includes(turma.level) ? 'required' : ''}>
                    </div>
                    <div class="border border-stone-200 rounded-lg p-4 bg-stone-50">
                        <h4 class="font-semibold text-sm text-stone-700 mb-3">Dia 1 <span class="text-red-500">*</span></h4>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="font-medium text-xs">Dia da Semana <span class="text-red-500">*</span></label>
                                <select id="turma-day1" class="form-input" required>
                                    <option value="">Selecione</option>
                                    <option value="Segunda" ${turma?.day1 === 'Segunda' ? 'selected' : ''}>Segunda</option>
                                    <option value="Ter√ßa" ${turma?.day1 === 'Ter√ßa' ? 'selected' : ''}>Ter√ßa</option>
                                    <option value="Quarta" ${turma?.day1 === 'Quarta' ? 'selected' : ''}>Quarta</option>
                                    <option value="Quinta" ${turma?.day1 === 'Quinta' ? 'selected' : ''}>Quinta</option>
                                    <option value="Sexta" ${turma?.day1 === 'Sexta' ? 'selected' : ''}>Sexta</option>
                                    <option value="S√°bado" ${turma?.day1 === 'S√°bado' ? 'selected' : ''}>S√°bado</option>
                                </select>
                            </div>
                            <div>
                                <label class="font-medium text-xs">Hor√°rio In√≠cio <span class="text-red-500">*</span></label>
                                <input type="time" id="turma-startTime1" class="form-input" value="${turma?.startTime1 || ''}" required>
                            </div>
                            <div>
                                <label class="font-medium text-xs">Hor√°rio Fim <span class="text-red-500">*</span></label>
                                <input type="time" id="turma-endTime1" class="form-input" value="${turma?.endTime1 || ''}" required>
                            </div>
                        </div>
                    </div>
                    <div class="border border-stone-200 rounded-lg p-4 bg-stone-50">
                        <h4 class="font-semibold text-sm text-stone-700 mb-3">Dia 2 <span class="text-stone-400 text-xs">(opcional)</span></h4>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="font-medium text-xs">Dia da Semana</label>
                                <select id="turma-day2" class="form-input">
                                    <option value="">Selecione</option>
                                    <option value="Segunda" ${turma?.day2 === 'Segunda' ? 'selected' : ''}>Segunda</option>
                                    <option value="Ter√ßa" ${turma?.day2 === 'Ter√ßa' ? 'selected' : ''}>Ter√ßa</option>
                                    <option value="Quarta" ${turma?.day2 === 'Quarta' ? 'selected' : ''}>Quarta</option>
                                    <option value="Quinta" ${turma?.day2 === 'Quinta' ? 'selected' : ''}>Quinta</option>
                                    <option value="Sexta" ${turma?.day2 === 'Sexta' ? 'selected' : ''}>Sexta</option>
                                    <option value="S√°bado" ${turma?.day2 === 'S√°bado' ? 'selected' : ''}>S√°bado</option>
                                </select>
                            </div>
                            <div>
                                <label class="font-medium text-xs">Hor√°rio In√≠cio</label>
                                <input type="time" id="turma-startTime2" class="form-input" value="${turma?.startTime2 || ''}">
                            </div>
                            <div>
                                <label class="font-medium text-xs">Hor√°rio Fim</label>
                                <input type="time" id="turma-endTime2" class="form-input" value="${turma?.endTime2 || ''}">
                            </div>
                        </div>
                    </div>
                    
                    <div id="turma-day3-container" class="border border-stone-200 rounded-lg p-4 bg-stone-50 hidden">
                        <h4 class="font-semibold text-sm text-stone-700 mb-3">Dia 3 <span class="text-stone-400 text-xs">(opcional)</span></h4>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="font-medium text-xs">Dia da Semana</label>
                                <select id="turma-day3" class="form-input">
                                    <option value="">Selecione</option>
                                    <option value="Segunda" ${turma?.day3 === 'Segunda' ? 'selected' : ''}>Segunda</option>
                                    <option value="Ter√ßa" ${turma?.day3 === 'Ter√ßa' ? 'selected' : ''}>Ter√ßa</option>
                                    <option value="Quarta" ${turma?.day3 === 'Quarta' ? 'selected' : ''}>Quarta</option>
                                    <option value="Quinta" ${turma?.day3 === 'Quinta' ? 'selected' : ''}>Quinta</option>
                                    <option value="Sexta" ${turma?.day3 === 'Sexta' ? 'selected' : ''}>Sexta</option>
                                    <option value="S√°bado" ${turma?.day3 === 'S√°bado' ? 'selected' : ''}>S√°bado</option>
                                </select>
                            </div>
                            <div>
                                <label class="font-medium text-xs">Hor√°rio In√≠cio</label>
                                <input type="time" id="turma-startTime3" class="form-input" value="${turma?.startTime3 || ''}">
                            </div>
                            <div>
                                <label class="font-medium text-xs">Hor√°rio Fim</label>
                                <input type="time" id="turma-endTime3" class="form-input" value="${turma?.endTime3 || ''}">
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" id="turma-add-day-btn" class="w-full py-2 px-4 border-2 border-dashed border-stone-300 rounded-lg text-stone-600 hover:border-[#F1D24B] hover:text-stone-800 transition-colors font-medium text-sm flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Adicionar +1 Dia
                    </button>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div><label class="font-medium text-sm">Semestre <span class="text-red-500">*</span></label><input type="text" id="turma-semestre" class="form-input" placeholder="Ex: 2025.1" value="${turma?.semestre || ''}" required></div>
                        <div><label class="font-medium text-sm">Data de In√≠cio</label><input type="date" id="turma-startDate" class="form-input" value="${turma?.startDate || ''}"></div>
                        <div><label class="font-medium text-sm">Data de Finaliza√ß√£o</label><input type="date" id="turma-endDate" class="form-input" value="${turma?.endDate || ''}"></div>
                    </div>
                    <div>
                        <label class="font-medium text-sm">Alunos</label>
                        <p class="text-xs text-stone-500 mt-1">Alunos j√° alocados em outras turmas aparecem desabilitados</p>
                        <div id="turma-students-checkboxes" class="mt-2 grid grid-cols-1 gap-y-2 max-h-48 overflow-y-auto p-3 border rounded-md bg-stone-50">
                            ${studentCheckboxes}
                        </div>
                    </div>
                    <div class="flex justify-between gap-2">
                        <div class="flex gap-2">
                            ${turmaId && !turma?.finalizada ? `<button type="button" class="secondary-btn" style="background-color: #6B7280; color: white;" onclick="finalizarTurma('${turmaId}')">Finalizar Turma</button>` : ''}
                            ${turmaId && turma?.finalizada ? `<button type="button" class="secondary-btn" style="background-color: #10B981; color: white;" onclick="reativarTurma('${turmaId}')">Reativar Turma</button>` : ''}
                        </div>
                        <div class="flex gap-2">
                            ${turmaId ? `<button type="button" class="danger-btn" data-action="delete-item" data-collection="turmas" data-id="${turmaId}">Excluir</button>` : ''}
                            <button type="submit" class="primary-btn w-auto">Salvar Turma</button>
                        </div>
                    </div>
                </form>
            `;
            const levelSelect = document.getElementById('turma-level');
            const levelCustomInput = document.getElementById('turma-level-custom');
            levelSelect.addEventListener('change', (e) => {
                const isOther = e.target.value === 'outro';
                levelCustomInput.classList.toggle('hidden', !isOther);
                levelCustomInput.required = isOther;
                if (!isOther) {
                    levelCustomInput.value = '';
                }
            });
            
            // Bot√£o "+1 dia" para mostrar Dia 3
            const turmaAddDayBtn = document.getElementById('turma-add-day-btn');
            const turmaDay3Container = document.getElementById('turma-day3-container');
            if (turmaAddDayBtn) {
                turmaAddDayBtn.addEventListener('click', () => {
                    turmaDay3Container.classList.remove('hidden');
                    turmaAddDayBtn.classList.add('hidden');
                });
            }

            // Mostrar Dia 3 se j√° existir (modo edi√ß√£o)
            if (turma?.day3) {
                turmaDay3Container.classList.remove('hidden');
                turmaAddDayBtn.classList.add('hidden');
            }
            
            document.getElementById('form-modal-content-area').onsubmit = saveTurma;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveTurma(event) {
            event.preventDefault();
            const turmaId = document.getElementById('turma-id').value;
            const teacherSelect = document.getElementById('turma-teacher');
            const selectedTeacherOption = teacherSelect.options[teacherSelect.selectedIndex];

            const levelSelect = document.getElementById('turma-level');
            const levelValue = levelSelect.value === 'outro'
                ? document.getElementById('turma-level-custom').value
                : levelSelect.value;

            // Get form values for generating the name
            const day1 = document.getElementById('turma-day1').value;
            const startTime1 = document.getElementById('turma-startTime1').value;
            const endTime1 = document.getElementById('turma-endTime1').value;
            const day2 = document.getElementById('turma-day2').value;
            const startTime2 = document.getElementById('turma-startTime2').value;
            const endTime2 = document.getElementById('turma-endTime2').value;
            const day3 = document.getElementById('turma-day3')?.value || '';
            const startTime3 = document.getElementById('turma-startTime3')?.value || '';
            const endTime3 = document.getElementById('turma-endTime3')?.value || '';
            const semestre = document.getElementById('turma-semestre').value.trim();
            
            // Valida√ß√£o de campos obrigat√≥rios (apenas Dia 1)
            const missingFields = [];
            if (!selectedTeacherOption.value) missingFields.push('Professor');
            if (!levelValue || levelValue.trim() === '') missingFields.push('N√≠vel');
            if (!day1) missingFields.push('Dia 1 - Dia da Semana');
            if (!startTime1) missingFields.push('Dia 1 - Hor√°rio In√≠cio');
            if (!endTime1) missingFields.push('Dia 1 - Hor√°rio Fim');
            if (!semestre) missingFields.push('Semestre');
            
            if (missingFields.length > 0) {
                showErrorMessage("Campos obrigat√≥rios faltando", 
                    `Por favor, preencha o(s) seguinte(s) campo(s):\n‚Ä¢ ${missingFields.join('\n‚Ä¢ ')}`);
                return;
            }
            
            // Format days abbreviation (e.g., "Segunda/Quarta" becomes "S/Q")
            const dayAbbrev = (day) => {
                const abbrevs = { 'Segunda': 'S', 'Ter√ßa': 'T', 'Quarta': 'Q', 'Quinta': 'Q', 'Sexta': 'S', 'S√°bado': 'S√°b' };
                return abbrevs[day] || day;
            };
            const daysCode = `${dayAbbrev(day1)}/${dayAbbrev(day2)}`;
            
            // Format time to just hours (e.g., "19:30" becomes "19h")
            const hours = startTime1 ? startTime1.split(':')[0] + 'h' : '';
            
            // Generate random code starting with SL
            const randomCode = 'SL' + Math.floor(1000 + Math.random() * 9000);
            
            // Generate standardized name: "N√≠vel - S/Q | 19h #SL1234"
            const generatedName = `${levelValue} - ${daysCode} | ${hours} #${randomCode}`;

            // Get current turma to preserve finalizada status
            const currentTurma = turmaId ? turmas.find(t => t.id === turmaId) : null;
            
            const data = {
                name: generatedName,
                teacherId: selectedTeacherOption.value,
                teacherName: selectedTeacherOption.getAttribute('data-name'),
                level: levelValue,
                studentIds: Array.from(document.querySelectorAll('input[name="turma-students"]:checked')).map(cb => cb.value),
                semestre: semestre,
                startDate: document.getElementById('turma-startDate').value,
                endDate: document.getElementById('turma-endDate').value,
                day1: day1,
                startTime1: startTime1,
                endTime1: endTime1,
                day2: day2,
                startTime2: startTime2,
                endTime2: endTime2,
                day3: day3,
                startTime3: startTime3,
                endTime3: endTime3,
                finalizada: currentTurma?.finalizada ?? false // Preserve finalizada status or default to false
            };

            try {
                if (turmaId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/turmas`, turmaId), data);
                    await logActivity('editar', 'turma', generatedName, { nivel: levelValue, professor: data.teacherName });
                    showSuccessMessage("Sucesso", "Turma atualizada.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/turmas`), data);
                    await logActivity('criar', 'turma', generatedName, { nivel: levelValue, professor: data.teacherName });
                    showSuccessMessage("Sucesso", "Nova turma criada.");
                }
            } catch (error) {
                console.error("Error saving turma:", error);
                showErrorMessage("Erro", "N√£o foi poss√≠vel salvar a turma.");
            }
        }

        // Global function to finalize a turma
        async function finalizarTurma(turmaId) {
            if (!confirm('Tem certeza que deseja finalizar esta turma? A turma ficar√° marcada como encerrada, mas continuar√° vis√≠vel para fins de registro.')) {
                return;
            }

            try {
                if (window.isDevelopmentMode) {
                    const turmaIndex = turmas.findIndex(t => t.id === turmaId);
                    if (turmaIndex !== -1) {
                        turmas[turmaIndex].finalizada = true;
                        localStorage.setItem('turmas', JSON.stringify(turmas));
                    }
                    renderTurmasSection();
                } else {
                    const turma = turmas.find(t => t.id === turmaId);
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/turmas`, turmaId), { finalizada: true });
                    if (turma) await logActivity('finalizar', 'turma', turma.name, { nivel: turma.level });
                }
                showSuccessMessage("Sucesso", "Turma finalizada com sucesso!");
                closeFormModal();
                // Change filter to show finalizadas so user can see the result
                currentTurmasFilter = 'finalizadas';
            } catch (error) {
                console.error("Error finalizing turma:", error);
                showErrorMessage("Erro", "N√£o foi poss√≠vel finalizar a turma.");
            }
        }
        window.finalizarTurma = finalizarTurma;

        // Global function to reactivate a turma
        async function reativarTurma(turmaId) {
            if (!confirm('Tem certeza que deseja reativar esta turma? A turma voltar√° ao status ativo.')) {
                return;
            }

            try {
                if (window.isDevelopmentMode) {
                    const turmaIndex = turmas.findIndex(t => t.id === turmaId);
                    if (turmaIndex !== -1) {
                        turmas[turmaIndex].finalizada = false;
                        localStorage.setItem('turmas', JSON.stringify(turmas));
                    }
                    renderTurmasSection();
                } else {
                    const turma = turmas.find(t => t.id === turmaId);
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/turmas`, turmaId), { finalizada: false });
                    if (turma) await logActivity('reativar', 'turma', turma.name, { nivel: turma.level });
                }
                showSuccessMessage("Sucesso", "Turma reativada com sucesso!");
                closeFormModal();
                // Change filter to show ativas so user can see the result
                currentTurmasFilter = 'ativas';
            } catch (error) {
                console.error("Error reactivating turma:", error);
                showErrorMessage("Erro", "N√£o foi poss√≠vel reativar a turma.");
            }
        }
        window.reativarTurma = reativarTurma;

        function openVipForm(vipId = null) {
            clearModalHeaderButtons();
            const vip = vipId ? vips.find(v => v.id === vipId) : null;
            document.getElementById('form-modal-title').textContent = vip ? "Editar VIP" : "Adicionar Novo VIP";

            const teacherOptions = collaborators.filter(c => c.sectors?.includes('professor')).map(c => `<option value="${c.id}" data-name="${c.name}" ${vip?.teacherId === c.id ? 'selected' : ''}>${c.name}</option>`).join('');
            const levelOptions = STANDARD_LEVELS.map(level => `<option value="${level}" ${vip?.level === level ? 'selected' : ''}>${level}</option>`).join('') + `<option value="outro">Outro (especificar)</option>`;
            
            // Available VIP students (modalidade VIP and not already registered as ACTIVE VIP, or current VIP being edited)
            // A student is only considered unavailable if they have an active VIP contract (no endDate or future endDate)
            const availableVipStudents = students.filter(s => {
                const isCurrentlyEditing = vip?.studentId === s.id;
                const hasActiveVip = vips.some(v => v.studentId === s.id && (!v.endDate || new Date(v.endDate) >= new Date()));
                return (s.modalidade === 'VIP' || s.modalidade === 'DUPLA') && (isCurrentlyEditing || !hasActiveVip);
            });

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="vip-id" value="${vipId || ''}">
                    <div>
                        <label class="font-medium text-sm">Aluno VIP <span class="text-red-500">*</span></label>
                        <div class="relative">
                            <input type="text" id="vip-student-search" class="form-input" placeholder="Digite o nome do aluno ou clique na seta para ver a lista..." 
                                   autocomplete="off" value="${vip ? vip.studentName : ''}" required>
                            <input type="hidden" id="vip-student-id" value="${vip ? vip.studentId : ''}">
                            
                            <!-- Dropdown toggle button -->
                            <button type="button" id="vip-student-dropdown-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            
                            <!-- Search results dropdown -->
                            <div id="vip-student-results" class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden">
                                <div class="p-2 text-sm text-gray-500">Digite para pesquisar alunos VIP...</div>
                            </div>
                        </div>
                        <div id="vip-student-error" class="text-red-500 text-sm mt-1 hidden">Selecione um aluno VIP v√°lido</div>
                    </div>
                    <div><label class="font-medium text-sm">Professor (Opcional)</label><select id="vip-teacher" class="form-input"><option value="">Sem professor definido</option>${teacherOptions}</select></div>
                    <div>
                        <label class="font-medium text-sm">N√≠vel (Opcional)</label>
                        <select id="vip-level" class="form-input"><option value="">Sem n√≠vel definido</option>${levelOptions}</select>
                        <input type="text" id="vip-level-custom" class="form-input mt-2 hidden" placeholder="Digite o n√≠vel personalizado">
                    </div>
                    <div class="border border-stone-200 rounded-lg p-4 bg-stone-50">
                        <h4 class="font-semibold text-sm text-stone-700 mb-3">Dia 1 <span class="text-stone-400 text-xs">(opcional)</span></h4>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="font-medium text-xs">Dia da Semana</label>
                                <select id="vip-day1" class="form-input">
                                    <option value="">Selecione</option>
                                    <option value="Segunda" ${vip?.day1 === 'Segunda' ? 'selected' : ''}>Segunda</option>
                                    <option value="Ter√ßa" ${vip?.day1 === 'Ter√ßa' ? 'selected' : ''}>Ter√ßa</option>
                                    <option value="Quarta" ${vip?.day1 === 'Quarta' ? 'selected' : ''}>Quarta</option>
                                    <option value="Quinta" ${vip?.day1 === 'Quinta' ? 'selected' : ''}>Quinta</option>
                                    <option value="Sexta" ${vip?.day1 === 'Sexta' ? 'selected' : ''}>Sexta</option>
                                    <option value="S√°bado" ${vip?.day1 === 'S√°bado' ? 'selected' : ''}>S√°bado</option>
                                </select>
                            </div>
                            <div>
                                <label class="font-medium text-xs">Hor√°rio In√≠cio</label>
                                <input type="time" id="vip-startTime1" class="form-input" value="${vip?.startTime1 || ''}">
                            </div>
                            <div>
                                <label class="font-medium text-xs">Hor√°rio Fim</label>
                                <input type="time" id="vip-endTime1" class="form-input" value="${vip?.endTime1 || ''}">
                            </div>
                        </div>
                    </div>
                    <div class="border border-stone-200 rounded-lg p-4 bg-stone-50">
                        <h4 class="font-semibold text-sm text-stone-700 mb-3">Dia 2 <span class="text-stone-400 text-xs">(opcional)</span></h4>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="font-medium text-xs">Dia da Semana</label>
                                <select id="vip-day2" class="form-input">
                                    <option value="">Selecione</option>
                                    <option value="Segunda" ${vip?.day2 === 'Segunda' ? 'selected' : ''}>Segunda</option>
                                    <option value="Ter√ßa" ${vip?.day2 === 'Ter√ßa' ? 'selected' : ''}>Ter√ßa</option>
                                    <option value="Quarta" ${vip?.day2 === 'Quarta' ? 'selected' : ''}>Quarta</option>
                                    <option value="Quinta" ${vip?.day2 === 'Quinta' ? 'selected' : ''}>Quinta</option>
                                    <option value="Sexta" ${vip?.day2 === 'Sexta' ? 'selected' : ''}>Sexta</option>
                                    <option value="S√°bado" ${vip?.day2 === 'S√°bado' ? 'selected' : ''}>S√°bado</option>
                                </select>
                            </div>
                            <div>
                                <label class="font-medium text-xs">Hor√°rio In√≠cio</label>
                                <input type="time" id="vip-startTime2" class="form-input" value="${vip?.startTime2 || ''}">
                            </div>
                            <div>
                                <label class="font-medium text-xs">Hor√°rio Fim</label>
                                <input type="time" id="vip-endTime2" class="form-input" value="${vip?.endTime2 || ''}">
                            </div>
                        </div>
                    </div>
                    
                    <div id="vip-day3-container" class="border border-stone-200 rounded-lg p-4 bg-stone-50 hidden">
                        <h4 class="font-semibold text-sm text-stone-700 mb-3">Dia 3 <span class="text-stone-400 text-xs">(opcional)</span></h4>
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <label class="font-medium text-xs">Dia da Semana</label>
                                <select id="vip-day3" class="form-input">
                                    <option value="">Selecione</option>
                                    <option value="Segunda" ${vip?.day3 === 'Segunda' ? 'selected' : ''}>Segunda</option>
                                    <option value="Ter√ßa" ${vip?.day3 === 'Ter√ßa' ? 'selected' : ''}>Ter√ßa</option>
                                    <option value="Quarta" ${vip?.day3 === 'Quarta' ? 'selected' : ''}>Quarta</option>
                                    <option value="Quinta" ${vip?.day3 === 'Quinta' ? 'selected' : ''}>Quinta</option>
                                    <option value="Sexta" ${vip?.day3 === 'Sexta' ? 'selected' : ''}>Sexta</option>
                                    <option value="S√°bado" ${vip?.day3 === 'S√°bado' ? 'selected' : ''}>S√°bado</option>
                                </select>
                            </div>
                            <div>
                                <label class="font-medium text-xs">Hor√°rio In√≠cio</label>
                                <input type="time" id="vip-startTime3" class="form-input" value="${vip?.startTime3 || ''}">
                            </div>
                            <div>
                                <label class="font-medium text-xs">Hor√°rio Fim</label>
                                <input type="time" id="vip-endTime3" class="form-input" value="${vip?.endTime3 || ''}">
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" id="vip-add-day-btn" class="w-full py-2 px-4 border-2 border-dashed border-stone-300 rounded-lg text-stone-600 hover:border-[#F1D24B] hover:text-stone-800 transition-colors font-medium text-sm flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        Adicionar +1 Dia
                    </button>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div><label class="font-medium text-sm">Semestre</label><input type="text" id="vip-semestre" class="form-input" placeholder="Ex: 2025.1" value="${vip?.semestre || ''}"></div>
                        <div><label class="font-medium text-sm">Data de In√≠cio <span class="text-red-500">*</span></label><input type="date" id="vip-startDate" class="form-input" value="${vip?.startDate || ''}" required></div>
                        <div><label class="font-medium text-sm">Data de Finaliza√ß√£o <span class="text-red-500">*</span></label><input type="date" id="vip-endDate" class="form-input" value="${vip?.endDate || ''}" required></div>
                    </div>
                    <div>
                        <label class="font-medium text-sm">Observa√ß√µes sobre o aluno</label>
                        <textarea id="vip-observacoes" class="form-input h-24 resize-none" 
                                placeholder="Digite observa√ß√µes relevantes sobre o aluno, perfil de aprendizagem, prefer√™ncias, hist√≥rico, etc."
                                >${vip?.observacoes || ''}</textarea>
                        <p class="text-xs text-gray-500 mt-1">Informa√ß√µes que podem ajudar o professor no acompanhamento do aluno</p>
                    </div>
                    <div class="flex justify-between gap-2">
                        <div class="flex gap-2">
                            ${vipId && !vip?.finalizado ? `<button type="button" class="secondary-btn" style="background-color: #6B7280; color: white;" onclick="finalizarVip('${vipId}')">Finalizar VIP</button>` : ''}
                            ${vipId && vip?.finalizado ? `<button type="button" class="secondary-btn" style="background-color: #10B981; color: white;" onclick="reativarVip('${vipId}')">Reativar VIP</button>` : ''}
                        </div>
                        <div class="flex gap-2">
                            ${vipId ? `<button type="button" class="danger-btn" data-action="delete-vip" data-id="${vipId}">Excluir VIP</button>` : ''}
                            <button type="submit" class="primary-btn w-auto">${vipId ? 'Salvar' : 'Criar VIP'}</button>
                        </div>
                    </div>
                </form>
            `;
            // Level selection functionality
            const levelSelect = document.getElementById('vip-level');
            const levelCustomInput = document.getElementById('vip-level-custom');
            levelSelect.addEventListener('change', (e) => {
                levelCustomInput.classList.toggle('hidden', e.target.value !== 'outro');
            });

            // Bot√£o "+1 dia" para mostrar Dia 3
            const vipAddDayBtn = document.getElementById('vip-add-day-btn');
            const vipDay3Container = document.getElementById('vip-day3-container');
            if (vipAddDayBtn) {
                vipAddDayBtn.addEventListener('click', () => {
                    vipDay3Container.classList.remove('hidden');
                    vipAddDayBtn.classList.add('hidden');
                });
            }

            // Mostrar Dia 3 se j√° existir (modo edi√ß√£o)
            if (vip?.day3) {
                vipDay3Container.classList.remove('hidden');
                vipAddDayBtn.classList.add('hidden');
            }

            // VIP student search functionality
            setupVipStudentSearch(availableVipStudents);

            document.getElementById('form-modal-content-area').onsubmit = saveVip;
            document.getElementById('form-modal').classList.add('visible');
        }

        function setupVipStudentSearch(availableVipStudents) {
            const searchInput = document.getElementById('vip-student-search');
            const studentIdInput = document.getElementById('vip-student-id');
            const resultsContainer = document.getElementById('vip-student-results');
            const dropdownBtn = document.getElementById('vip-student-dropdown-btn');
            const errorDiv = document.getElementById('vip-student-error');

            // Function to filter and display students
            function filterAndDisplayStudents(query = '') {
                const filteredStudents = availableVipStudents.filter(student => 
                    student.name.toLowerCase().includes(query.toLowerCase())
                );

                if (filteredStudents.length === 0) {
                    resultsContainer.innerHTML = `<div class="p-2 text-sm text-gray-500">Nenhum aluno VIP encontrado${query ? ` para "${query}"` : ''}</div>`;
                } else {
                    resultsContainer.innerHTML = filteredStudents.map(student => `
                        <div class="p-2 cursor-pointer hover:bg-gray-100 border-b border-gray-100 last:border-b-0" 
                             data-student-id="${student.id}" data-student-name="${student.name}">
                            <div class="font-medium">${student.name}</div>
                            <div class="text-xs text-gray-500">Status: ${student.status} | Modalidade: ${student.modalidade || 'VIP'}</div>
                        </div>
                    `).join('');
                }

                // Add click listeners to results
                resultsContainer.querySelectorAll('[data-student-id]').forEach(item => {
                    item.addEventListener('click', () => {
                        const studentId = item.getAttribute('data-student-id');
                        const studentName = item.getAttribute('data-student-name');
                        selectStudent(studentId, studentName);
                    });
                });
            }

            // Function to select a student
            function selectStudent(studentId, studentName) {
                searchInput.value = studentName;
                studentIdInput.value = studentId;
                resultsContainer.classList.add('hidden');
                errorDiv.classList.add('hidden');
            }

            // Search input event listener
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                if (query.length === 0) {
                    studentIdInput.value = '';
                    resultsContainer.classList.add('hidden');
                    errorDiv.classList.add('hidden');
                    return;
                }

                // Check if typed name matches exactly an available student
                const exactMatch = availableVipStudents.find(s => 
                    s.name.toLowerCase() === query.toLowerCase()
                );

                if (exactMatch) {
                    studentIdInput.value = exactMatch.id;
                    errorDiv.classList.add('hidden');
                } else {
                    studentIdInput.value = '';
                }

                filterAndDisplayStudents(query);
                resultsContainer.classList.remove('hidden');
            });

            // Dropdown button click to show all students
            dropdownBtn.addEventListener('click', () => {
                if (resultsContainer.classList.contains('hidden')) {
                    filterAndDisplayStudents(); // Show all students
                    resultsContainer.classList.remove('hidden');
                    searchInput.focus();
                } else {
                    resultsContainer.classList.add('hidden');
                }
            });

            // Focus event to show dropdown
            searchInput.addEventListener('focus', () => {
                if (searchInput.value.trim()) {
                    filterAndDisplayStudents(searchInput.value.trim());
                } else {
                    filterAndDisplayStudents(); // Show all students
                }
                resultsContainer.classList.remove('hidden');
            });

            // Validate on blur
            searchInput.addEventListener('blur', (e) => {
                // Small delay to allow clicking on results
                setTimeout(() => {
                    if (!studentIdInput.value && searchInput.value.trim()) {
                        errorDiv.classList.remove('hidden');
                        errorDiv.textContent = 'Selecione um aluno v√°lido da lista';
                    }
                    resultsContainer.classList.add('hidden');
                }, 150);
            });

            // Hide dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#vip-student-search') && 
                    !e.target.closest('#vip-student-results') && 
                    !e.target.closest('#vip-student-dropdown-btn')) {
                    resultsContainer.classList.add('hidden');
                }
            });
        }

        async function saveVip(event) {
            event.preventDefault();
            const vipId = document.getElementById('vip-id').value;
            const teacherSelect = document.getElementById('vip-teacher');
            const selectedTeacherOption = teacherSelect.options[teacherSelect.selectedIndex];
            
            // Get student data from the new search system
            const studentId = document.getElementById('vip-student-id').value;
            const studentName = document.getElementById('vip-student-search').value.trim();
            const startDate = document.getElementById('vip-startDate').value;
            const endDate = document.getElementById('vip-endDate').value;

            const levelSelect = document.getElementById('vip-level');
            const levelValue = levelSelect.value === 'outro'
                ? document.getElementById('vip-level-custom').value
                : levelSelect.value;

            // Valida√ß√£o de campos obrigat√≥rios
            const missingFields = [];
            if (!studentId || !studentName) missingFields.push('Aluno VIP');
            if (!startDate) missingFields.push('Data de In√≠cio');
            if (!endDate) missingFields.push('Data de Finaliza√ß√£o');
            
            if (missingFields.length > 0) {
                const errorDiv = document.getElementById('vip-student-error');
                if (!studentId || !studentName) {
                    errorDiv.classList.remove('hidden');
                    errorDiv.textContent = 'Selecione um aluno VIP v√°lido';
                }
                showErrorMessage("Campos obrigat√≥rios faltando", 
                    `Por favor, preencha o(s) seguinte(s) campo(s):\n‚Ä¢ ${missingFields.join('\n‚Ä¢ ')}`);
                return;
            }
            
            // Validar se data de finaliza√ß√£o √© posterior √† data de in√≠cio
            if (new Date(endDate) <= new Date(startDate)) {
                showErrorMessage("Erro de valida√ß√£o", "A Data de Finaliza√ß√£o deve ser posterior √† Data de In√≠cio.");
                return;
            }

            // Get current VIP to preserve finalizado status
            const currentVip = vipId ? vips.find(v => v.id === vipId) : null;

            const data = {
                studentId: studentId,
                studentName: studentName,
                teacherId: selectedTeacherOption.value || null,
                teacherName: selectedTeacherOption.getAttribute('data-name') || null,
                level: levelValue || null,
                day1: document.getElementById('vip-day1').value || null,
                startTime1: document.getElementById('vip-startTime1').value || null,
                endTime1: document.getElementById('vip-endTime1').value || null,
                day2: document.getElementById('vip-day2').value || null,
                startTime2: document.getElementById('vip-startTime2').value || null,
                endTime2: document.getElementById('vip-endTime2').value || null,
                day3: document.getElementById('vip-day3')?.value || null,
                startTime3: document.getElementById('vip-startTime3')?.value || null,
                endTime3: document.getElementById('vip-endTime3')?.value || null,
                semestre: document.getElementById('vip-semestre').value,
                observacoes: document.getElementById('vip-observacoes').value.trim(),
                startDate: document.getElementById('vip-startDate').value,
                endDate: document.getElementById('vip-endDate').value,
                finalizado: currentVip?.finalizado ?? false // Preserve finalizado status or default to false
            };

            try {
                if (vipId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/vips`, vipId), data);
                    await logActivity('editar', 'vip', studentName, { nivel: levelValue, professor: data.teacherName });
                    showSuccessMessage("Sucesso", "VIP atualizado.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/vips`), data);
                    await logActivity('criar', 'vip', studentName, { nivel: levelValue });
                    showSuccessMessage("Sucesso", "Novo VIP criado.");
                }
            } catch (error) {
                console.error("Error saving VIP:", error);
                showErrorMessage("Erro", "N√£o foi poss√≠vel salvar o VIP.");
            }
        }

        // Global function to finalize a VIP
        async function finalizarVip(vipId) {
            if (!confirm('Tem certeza que deseja finalizar este VIP? O contrato ficar√° marcado como conclu√≠do, mas continuar√° vis√≠vel para fins de registro.')) {
                return;
            }

            try {
                if (window.isDevelopmentMode) {
                    const vipIndex = vips.findIndex(v => v.id === vipId);
                    if (vipIndex !== -1) {
                        vips[vipIndex].finalizado = true;
                        localStorage.setItem('vips', JSON.stringify(vips));
                    }
                } else {
                    const vip = vips.find(v => v.id === vipId);
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/vips`, vipId), { finalizado: true });
                    if (vip) await logActivity('finalizar', 'vip', vip.studentName, { nivel: vip.level });
                }
                showSuccessMessage("Sucesso", "VIP finalizado com sucesso!");
                document.getElementById('form-modal').classList.remove('visible');
                // Change filter to show finalizados so user can see the result
                currentVipsFilter = 'finalizados';
                // Refresh the VIPs list
                await loadDataFromFirebase();
                if (currentSection === 'vips') {
                    renderVipsSection();
                    updateVipsList();
                }
            } catch (error) {
                console.error("Error finalizing VIP:", error);
                showErrorMessage("Erro", "N√£o foi poss√≠vel finalizar o VIP.");
            }
        }
        window.finalizarVip = finalizarVip;

        // Global function to reactivate a VIP
        async function reativarVip(vipId) {
            if (!confirm('Tem certeza que deseja reativar este VIP? O contrato voltar√° ao status ativo.')) {
                return;
            }

            try {
                if (window.isDevelopmentMode) {
                    const vipIndex = vips.findIndex(v => v.id === vipId);
                    if (vipIndex !== -1) {
                        vips[vipIndex].finalizado = false;
                        localStorage.setItem('vips', JSON.stringify(vips));
                    }
                } else {
                    const vip = vips.find(v => v.id === vipId);
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/vips`, vipId), { finalizado: false });
                    if (vip) await logActivity('reativar', 'vip', vip.studentName, { nivel: vip.level });
                }
                showSuccessMessage("Sucesso", "VIP reativado com sucesso!");
                document.getElementById('form-modal').classList.remove('visible');
                // Change filter to show ativos so user can see the result
                currentVipsFilter = 'ativos';
                // Refresh the VIPs list
                await loadDataFromFirebase();
                if (currentSection === 'vips') {
                    renderVipsSection();
                    updateVipsList();
                }
            } catch (error) {
                console.error("Error reactivating VIP:", error);
                showErrorMessage("Erro", "N√£o foi poss√≠vel reativar o VIP.");
            }
        }
        window.reativarVip = reativarVip;

        async function deleteVip(vipId) {
            if (!confirm('Tem certeza que deseja excluir este VIP?')) return;

            try {
                const vip = vips.find(v => v.id === vipId);
                if (window.isDevelopmentMode) {
                    vips = vips.filter(v => v.id !== vipId);
                    localStorage.setItem('vips', JSON.stringify(vips));
                } else {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/vips`, vipId));
                    if (vip) await logActivity('deletar', 'vip', vip.studentName, {});
                }
                showSuccessMessage("Sucesso!", "VIP exclu√≠do com sucesso.");
                closeFormModal();
                renderVipsSection();
            } catch (error) {
                console.error("Error deleting VIP:", error);
                showErrorMessage("Erro", "N√£o foi poss√≠vel excluir o VIP.");
            }
        }

        // Function to delete all VIPs from the VIP section (not affecting students)
        async function deleteAllVips() {
            if (!confirm('Tem certeza que deseja excluir TODOS os VIPs cadastrados? Esta a√ß√£o n√£o pode ser desfeita.')) return;
            if (!confirm('Esta a√ß√£o ir√° excluir todos os registros VIP, mas n√£o afetar√° os dados dos alunos. Continuar?')) return;
            
            try {
                const vipCount = vips.length;
                
                if (window.isDevelopmentMode) {
                    // Clear local storage VIPs
                    vips.length = 0;
                    localStorage.setItem('vips', JSON.stringify(vips));
                } else {
                    // Delete all VIPs from Firebase
                    const vipCollection = collection(db, `artifacts/${appId}/public/data/vips`);
                    const snapshot = await getDocs(vipCollection);
                    const batch = writeBatch(db);
                    
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    
                    await batch.commit();
                }
                
                showSuccessMessage("Sucesso!", `${vipCount} VIPs foram exclu√≠dos com sucesso. Os dados dos alunos n√£o foram afetados.`);
                
                // Refresh the VIPs section if currently viewing it
                if (contentArea.firstElementChild?.id === 'vips-section') {
                    renderVipsSection();
                }
            } catch (error) {
                console.error("Error deleting all VIPs:", error);
                showErrorMessage("Erro", "Falha ao excluir todos os VIPs.");
            }
        }



        function openTurmaPefModal(turmaId) {
            const turma = turmas.find(t => t.id === turmaId);
            if (!turma) { showErrorMessage("Erro", "Turma n√£o encontrada."); return; }

            const modal = document.getElementById('form-modal');
            modal.dataset.pefModal = "true";
            modal.dataset.unitId = turmaId;
            modal.dataset.pefType = "turma";

            clearModalHeaderButtons();
            const modalHeader = document.getElementById('modal-header-container');
            const modalTitle = document.getElementById('form-modal-title');
            const modalContentArea = document.getElementById('form-modal-content-area');

            // Definir turmaStudents primeiro
            const turmaStudents = (turma.studentIds || []).map(id => students.find(s => s.id === id)).filter(Boolean);

            // Bot√£o de exporta√ß√£o da turma completa
            const exportButton = document.createElement('button');
            exportButton.className = 'secondary-btn w-auto';
            exportButton.textContent = 'Exportar PEF';
            exportButton.dataset.action = 'export-turma-pef';
            exportButton.dataset.id = turmaId;
            modalHeader.insertBefore(exportButton, modalHeader.querySelector('.modal-close-btn'));

            // Dropdown de exporta√ß√£o individual por aluno
            const exportStudentDropdown = document.createElement('div');
            exportStudentDropdown.className = 'relative inline-block ml-2';
            exportStudentDropdown.innerHTML = `
                <button type="button" class="secondary-btn w-auto dropdown-toggle" id="export-student-btn-${turmaId}">
                    Exportar Aluno
                    <svg class="w-4 h-4 ml-2 inline" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
                <div class="dropdown-menu absolute left-0 mt-2 w-56 bg-white border border-gray-200 rounded-lg shadow-lg z-50 hidden" id="export-student-menu-${turmaId}">
                    ${turmaStudents.map(student => `
                        <button type="button" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded" 
                                data-action="export-student-pef" 
                                data-turma-id="${turmaId}" 
                                data-student-id="${student.id}">
                            ${student.name}
                        </button>
                    `).join('')}
                </div>
            `;
            modalHeader.insertBefore(exportStudentDropdown, modalHeader.querySelector('.modal-close-btn'));

            // Adicionar JavaScript para o dropdown
            setTimeout(() => {
                const dropdownBtn = document.getElementById(`export-student-btn-${turmaId}`);
                const dropdownMenu = document.getElementById(`export-student-menu-${turmaId}`);
                
                if (dropdownBtn && dropdownMenu) {
                    dropdownBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        dropdownMenu.classList.toggle('hidden');
                    });
                    
                    // Fechar dropdown ao clicar fora
                    document.addEventListener('click', (e) => {
                        if (!exportStudentDropdown.contains(e.target)) {
                            dropdownMenu.classList.add('hidden');
                        }
                    });
                }
            }, 100);

            modalTitle.textContent = `PEF: ${turma.name}`;

            const unitAttendance = attendance.find(a => a.id === turmaId);
            
            // Obter dias da semana permitidos para esta turma
            const allowedWeekdays = [];
            if (turma.day1?.weekday !== undefined && turma.day1?.weekday !== null && turma.day1?.weekday !== '') {
                allowedWeekdays.push(parseInt(turma.day1.weekday));
            }
            if (turma.day2?.weekday !== undefined && turma.day2?.weekday !== null && turma.day2?.weekday !== '') {
                allowedWeekdays.push(parseInt(turma.day2.weekday));
            }
            if (turma.day3?.weekday !== undefined && turma.day3?.weekday !== null && turma.day3?.weekday !== '') {
                allowedWeekdays.push(parseInt(turma.day3.weekday));
            }
            
            // N√£o √© mais necess√°rio gerar lista de datas - usando input type="date"
            
            const dayNames = ['domingo', 'segunda', 'ter√ßa', 'quarta', 'quinta', 'sexta', 's√°bado'];
            const allowedDayNames = allowedWeekdays.length > 0 ? allowedWeekdays.map(d => dayNames[d]).join(', ') : 'todos os dias';

            let lessonsHtml = '';
            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance?.lessons?.[i];
                const lessonDate = lessonData?.date || '';

                const studentsHtml = turmaStudents.map(student => {
                    const studentStatus = lessonData?.students?.[student.id] || '';
                    return `
                        <div class="pef-student-attendance-row flex flex-col items-center gap-2" data-student-id="${student.id}">
                            <span class="text-sm font-medium text-center">${student.name}</span>
                            <div class="pef-status-btn-group flex gap-1">
                                <button data-action="mark-attendance" data-status="P" class="${studentStatus === 'P' ? 'active P' : ''}">P</button>
                                <button data-action="mark-attendance" data-status="F" class="${studentStatus === 'F' ? 'active F' : ''}">F</button>
                                <button data-action="mark-attendance" data-status="PP" class="${studentStatus === 'PP' ? 'active PP' : ''}">PP</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                lessonsHtml += `
                    <div class="border border-stone-200 rounded-lg p-4 mb-4" id="lesson-row-${turmaId}-${i}" data-lesson-number="${i}">
                        <!-- Cabe√ßalho da aula: N√∫mero e Data em linha -->
                        <div class="flex items-center gap-4 mb-3 pb-3 border-b border-stone-200">
                            <span class="font-bold text-stone-700 text-lg">Aula ${i}</span>
                            <div class="flex-1">
                                <input type="date" class="form-input p-2 text-sm lesson-date w-full" value="${lessonDate}" data-allowed-days="${allowedWeekdays.join(',')}">
                                ${allowedWeekdays.length > 0 ? `<p class="text-xs text-stone-500 mt-1">Dias da turma: ${allowedDayNames}</p>` : ''}
                            </div>
                        </div>
                        
                        <!-- Tema e Observa√ß√µes lado a lado -->
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <textarea class="form-input p-2 text-sm lesson-topic" placeholder="Tema da aula" rows="2">${lessonData?.topic || ''}</textarea>
                            <textarea class="form-input p-2 text-sm lesson-notes" placeholder="Observa√ß√µes da aula" rows="2">${lessonData?.notes || ''}</textarea>
                        </div>
                        
                        <!-- Alunos em grid compacto -->
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                            ${studentsHtml}
                        </div>
                    </div>
                `;
            }

            modalContentArea.innerHTML = `
                <div>${lessonsHtml}</div>
                <div class="sticky bottom-0 left-0 right-0 bg-white border-t-2 border-yellow-400 p-4 mt-4 shadow-lg z-10">
                    <button class="primary-btn w-full text-lg" data-action="save-all-pef-lessons" data-unit-id="${turmaId}" data-pef-type="turma">
                        üíæ Salvar Todas as Aulas
                    </button>
                </div>
            `;
            
            modal.classList.add('visible');
        }

        function openVipPefModal(vipId) {
            const vip = vips.find(v => v.id === vipId);
            if (!vip) { showErrorMessage("Erro", "Aluno VIP n√£o encontrado."); return; }
            const student = students.find(s => s.id === vip.studentId);
            if (!student) { showErrorMessage("Erro", "Dados do aluno n√£o encontrados."); return; }

            const modal = document.getElementById('form-modal');
            modal.dataset.pefModal = "true";
            modal.dataset.unitId = vipId;
            modal.dataset.pefType = "vip";

            clearModalHeaderButtons();
            const modalHeader = document.getElementById('modal-header-container');
            const modalTitle = document.getElementById('form-modal-title');
            const modalContentArea = document.getElementById('form-modal-content-area');

            const exportButton = document.createElement('button');
            exportButton.className = 'secondary-btn w-auto';
            exportButton.textContent = 'Exportar PEF';
            exportButton.dataset.action = 'export-vip-pef';
            exportButton.dataset.id = vipId;
            modalHeader.insertBefore(exportButton, modalHeader.querySelector('.modal-close-btn'));

            modalTitle.textContent = `PEF (VIP): ${vip.studentName}`;

            const unitAttendance = attendance.find(a => a.id === vipId);
            
            // Obter dias da semana permitidos para este VIP
            const allowedWeekdays = [];
            if (vip.day1?.weekday) allowedWeekdays.push(parseInt(vip.day1.weekday));
            if (vip.day2?.weekday) allowedWeekdays.push(parseInt(vip.day2.weekday));
            if (vip.day3?.weekday) allowedWeekdays.push(parseInt(vip.day3.weekday));
            
            // N√£o √© mais necess√°rio gerar lista de datas - usando input type="date"
            
            const dayNames = ['domingo', 'segunda', 'ter√ßa', 'quarta', 'quinta', 'sexta', 's√°bado'];
            const allowedDayNames = allowedWeekdays.length > 0 ? allowedWeekdays.map(d => dayNames[d]).join(', ') : 'todos os dias';

            let lessonsHtml = '';
            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance?.lessons?.[i];
                const lessonDate = lessonData?.date || '';
                const lessonNotes = lessonData?.notes || '';
                const lessonTopic = lessonData?.topic || '';
                const studentStatus = lessonData?.students?.[student.id] || '';

                const studentHtml = `
                    <div class="pef-student-attendance-row" data-student-id="${student.id}">
                        <span class="text-sm font-semibold">${student.name}</span>
                        <div class="pef-status-btn-group flex gap-1">
                            <button data-action="mark-attendance" data-status="P" class="${studentStatus === 'P' ? 'active P' : ''}">P</button>
                            <button data-action="mark-attendance" data-status="F" class="${studentStatus === 'F' ? 'active F' : ''}">F</button>
                            <button data-action="mark-attendance" data-status="PP" class="${studentStatus === 'PP' ? 'active PP' : ''}">PP</button>
                        </div>
                    </div>
                `;
                
                lessonsHtml += `
                    <div class="border border-stone-200 rounded-lg p-4 mb-4" id="lesson-row-${vipId}-${i}" data-lesson-number="${i}">
                        <div class="flex items-center gap-4 mb-3 pb-3 border-b border-stone-200">
                            <span class="font-bold text-stone-700 text-lg">Aula ${i}</span>
                            <div class="flex-1">
                                <input type="date" class="form-input p-2 text-sm lesson-date w-full" value="${lessonDate}" data-allowed-days="${allowedWeekdays.join(',')}">
                                ${allowedWeekdays.length > 0 ? `<p class="text-xs text-stone-500 mt-1">Dias do VIP: ${allowedDayNames}</p>` : ''}
                            </div>
                        </div>
                        <div class="space-y-3">
                            <textarea class="form-input p-2 text-sm w-full lesson-topic" placeholder="Tema da aula" rows="2">${lessonTopic}</textarea>
                            <textarea class="form-input p-2 text-sm w-full lesson-notes" placeholder="Observa√ß√µes da aula" rows="2">${lessonNotes}</textarea>
                            ${studentHtml}
                        </div>
                    </div>
                `;
            }

            modalContentArea.innerHTML = `
                <div>${lessonsHtml}</div>
                <div class="sticky bottom-0 left-0 right-0 bg-white border-t-2 border-yellow-400 p-4 mt-4 shadow-lg z-10">
                    <button class="primary-btn w-full text-lg" data-action="save-all-pef-lessons" data-unit-id="${vipId}" data-pef-type="vip">
                        üíæ Salvar Todas as Aulas
                    </button>
                </div>
            `;
            
            modal.classList.add('visible');
        }

        async function saveAllPefLessons(unitId, pefType) {
            const saveButton = document.querySelector('[data-action="save-all-pef-lessons"]');
            const originalButtonText = saveButton ? saveButton.innerHTML : '';
            
            try {
                console.log("saveAllPefLessons called with:", unitId, pefType);
                
                // Show loading state
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.innerHTML = '‚è≥ Salvando...';
                }
                
                let savedCount = 0;
                const totalLessons = 40;
                const lessonsToSave = {};
                
                // Process all lessons and collect data
                for (let lessonNumber = 1; lessonNumber <= totalLessons; lessonNumber++) {
                    const lessonRow = document.getElementById(`lesson-row-${unitId}-${lessonNumber}`);
                    if (!lessonRow) continue;
                    
                    const date = lessonRow.querySelector('.lesson-date').value;
                    if (!date) continue; // Skip lessons without date
                    
                    const topic = lessonRow.querySelector('.lesson-topic').value;
                    const notes = lessonRow.querySelector('.lesson-notes').value;
                    
                    const studentAttendance = {};
                    const studentRows = lessonRow.querySelectorAll('.pef-student-attendance-row');
                    studentRows.forEach(row => {
                        const studentId = row.dataset.studentId;
                        const activeButton = row.querySelector('.pef-status-btn-group button.active');
                        const status = activeButton ? activeButton.dataset.status : '';
                        if (studentId) {
                            studentAttendance[studentId] = status;
                        }
                    });
                    
                    // Collect lesson data
                    lessonsToSave[lessonNumber] = {
                        date: date,
                        topic: topic,
                        notes: notes,
                        students: studentAttendance
                    };
                    savedCount++;
                }
                
                if (savedCount === 0) {
                    showErrorMessage("Nenhuma aula para salvar", "Preencha pelo menos uma aula com data antes de salvar.");
                    if (saveButton) {
                        saveButton.disabled = false;
                        saveButton.innerHTML = originalButtonText;
                    }
                    return;
                }
                
                // Update local data
                let attendanceIndex = attendance.findIndex(a => a.id === unitId);
                if (attendanceIndex === -1) {
                    attendance.push({ id: unitId, lessons: lessonsToSave });
                    attendanceIndex = attendance.length - 1;
                } else {
                    attendance[attendanceIndex].lessons = lessonsToSave;
                }
                
                // Save to storage (Firebase or localStorage)
                if (window.isDevelopmentMode) {
                    localStorage.setItem('attendance', JSON.stringify(attendance));
                    playSuccessSound();
                    showSuccessMessage("Sucesso!", `${savedCount} aulas salvas com sucesso.`);
                } else {
                    // Save to Firebase - single operation with all lessons
                    const attendanceRef = doc(db, `artifacts/${appId}/public/data/attendance`, unitId);
                    await setDoc(attendanceRef, {
                        id: unitId,
                        lessons: lessonsToSave
                    }, { merge: true });
                    
                    // Log activity
                    const turma = turmas.find(t => t.id === unitId);
                    const vipRecord = vips.find(v => v.id === unitId);
                    const targetName = turma ? turma.name : (vipRecord ? students.find(s => s.id === vipRecord.studentId)?.name : 'Desconhecido');
                    const targetType = turma ? 'turma' : 'vip';
                    
                    await logActivity('salvar_pef', targetType, targetName, {
                        quantidadeAulas: savedCount,
                        salvamentoEmLote: true
                    });
                    
                    playSuccessSound();
                    showSuccessMessage("Sucesso!", `${savedCount} aulas salvas com sucesso.`);
                }
                
            } catch (error) {
                console.error("Error saving all lessons:", error);
                showErrorMessage("Erro", "Falha ao salvar as aulas. Tente novamente.");
            } finally {
                // Restore button state
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.innerHTML = originalButtonText;
                }
            }
        }

        async function savePefLesson(unitId, lessonNumber) {
            const lessonRow = document.getElementById(`lesson-row-${unitId}-${lessonNumber}`);
            if (!lessonRow) {
                console.error("Lesson row not found");
                return;
            }

            const date = lessonRow.querySelector('.lesson-date').value;
            const topic = lessonRow.querySelector('.lesson-topic').value;
            const notes = lessonRow.querySelector('.lesson-notes').value;

            const studentAttendance = {};
            const studentRows = lessonRow.querySelectorAll('.pef-student-attendance-row');
            studentRows.forEach(row => {
                const studentId = row.dataset.studentId;
                const activeButton = row.querySelector('.pef-status-btn-group button.active');
                const status = activeButton ? activeButton.dataset.status : '';
                if (studentId) {
                    studentAttendance[studentId] = status;
                }
            });

            if (!date) {
                showErrorMessage("Data Obrigat√≥ria", "Por favor, selecione a data da aula antes de salvar.");
                return;
            }

            const attendanceRef = doc(db, `artifacts/${appId}/public/data/attendance`, unitId);

            const lessonData = {
                date: date,
                students: studentAttendance,
                topic: topic,
                notes: notes,
            };

            try {
                await setDoc(attendanceRef, {
                    id: unitId,
                    lessons: {
                        [lessonNumber]: lessonData
                    }
                }, { merge: true });

                // After saving PEF, recalculate and save assiduidade for VIPs
                const vip = vips.find(v => v.id === unitId);
                if (vip) {
                    // Reload attendance data
                    const attendanceSnap = await getDoc(attendanceRef);
                    if (attendanceSnap.exists()) {
                        const attendanceData = attendanceSnap.data();
                        // Update local attendance array - MUST include id field
                        const attendanceIndex = attendance.findIndex(a => a.id === unitId);
                        const updatedAttendance = { id: unitId, ...attendanceData };
                        
                        if (attendanceIndex >= 0) {
                            attendance[attendanceIndex] = updatedAttendance;
                        } else {
                            attendance.push(updatedAttendance);
                        }
                        
                        // Recalculate attendance score
                        const newAttendanceScore = calculateVipAttendanceScore(unitId);
                        
                        if (newAttendanceScore !== null) {
                            // Update VIP grades with new assiduidade
                            const vipRef = doc(db, `artifacts/${appId}/public/data/vips`, unitId);
                            const currentGrades = vip.grades || {
                                midtermTest: 0,
                                listeningTest: 0,
                                grammarTest: 0,
                                oralTest: 0,
                                participacao: 0,
                                assiduidade: 0
                            };
                            
                            currentGrades.assiduidade = newAttendanceScore;
                            
                            await updateDoc(vipRef, {
                                grades: currentGrades
                            });
                            
                            // Update local VIP data
                            vip.grades = currentGrades;
                            
                            console.log(`Assiduidade atualizada para VIP ${vip.id}: ${newAttendanceScore}`);
                        }
                    }
                }

                // Log activity
                const turma = turmas.find(t => t.id === unitId);
                const vipRecord = vips.find(v => v.id === unitId);
                const targetName = turma ? turma.name : (vipRecord ? students.find(s => s.id === vipRecord.studentId)?.name : 'Desconhecido');
                const targetType = turma ? 'turma' : 'vip';
                
                await logActivity('salvar_pef', targetType, targetName, {
                    aulaNumero: lessonNumber,
                    data: date,
                    topico: topic
                });
                
                showSuccessMessage("Sucesso!", `Presen√ßa da Aula ${lessonNumber} foi salva.`);
            } catch (error) {
                console.error("Error saving attendance: ", error);
                showErrorMessage("Erro", "Falha ao salvar a presen√ßa. Tente novamente.");
            }
        }

        function openCampanhaForm(campanhaId = null) {
            console.log('openCampanhaForm called with campanhaId:', campanhaId);
            clearModalHeaderButtons();
            const campanha = campanhaId ? events.find(c => c.id === campanhaId) : null;
            console.log('Found campanha:', campanha);
            document.getElementById('form-modal-title').textContent = campanha ? "Editar Campanha" : "Adicionar Nova Campanha";

            const colaboradorOptions = collaborators
                .filter(c => c.sectors && (c.sectors.includes('campanhas') || c.sectors.includes('admin')))
                .map(c => `<option value="${c.name}" ${campanha?.responsavel === c.name ? 'selected' : ''}>${c.name}</option>`).join('');
            const setoresOptions = ['Marketing', 'Pedag√≥gico', 'Comercial', 'Financeiro', 'Administrativo'].map(setor => 
                `<div class="flex items-center">
                    <input type="checkbox" id="setor-${setor}" name="setores" value="${setor}" class="h-4 w-4 rounded" ${campanha?.setores?.includes(setor) ? 'checked' : ''}>
                    <label for="setor-${setor}" class="ml-2 text-sm">${setor}</label>
                </div>`
            ).join('');
            
            const plataformaOptions = ['Reels', 'Story', 'Destaque', 'TikTok', 'YouTube', 'YouTube Shorts', 'Presencial'].map(plataforma => 
                `<div class="flex items-center">
                    <input type="checkbox" id="plataforma-${plataforma.replace(/\s+/g, '')}" name="plataforma" value="${plataforma}" class="h-4 w-4 rounded plataforma-checkbox" ${campanha?.plataforma?.includes(plataforma) || campanha?.foco?.includes(plataforma) ? 'checked' : ''}>
                    <label for="plataforma-${plataforma.replace(/\s+/g, '')}" class="ml-2 text-sm">${plataforma}</label>
                </div>`
            ).join('');

            const focoOptions = ['Matr√≠culas', 'Engajamento', 'Capta√ß√£o de Leads', 'Fortalecimento de Marca', 'Gest√£o de Crise', 'Filler'].map(foco => 
                `<div class="flex items-center">
                    <input type="checkbox" id="foco-${foco.replace(/\s+/g, '')}" name="foco" value="${foco}" class="h-4 w-4 rounded foco-checkbox" ${campanha?.focoObjetivo?.includes(foco) ? 'checked' : ''}>
                    <label for="foco-${foco.replace(/\s+/g, '')}" class="ml-2 text-sm">${foco}</label>
                </div>`
            ).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="campanha-id" value="${campanhaId || ''}">
                    
                    <h4 class="text-lg font-semibold text-stone-700 border-b pb-2">Informa√ß√µes B√°sicas</h4>
                    <div><label class="font-medium text-sm">Nome da Campanha</label><input type="text" id="campanha-nome" class="form-input" required value="${campanha?.nome || campanha?.title || ''}"></div>
                    
                    <div><label class="font-medium text-sm">Respons√°vel Principal</label><select id="campanha-responsavel" class="form-input" required><option value="">Selecione um respons√°vel</option>${colaboradorOptions}</select></div>
                    
                    <div>
                        <label class="font-medium text-sm">Setores Envolvidos</label>
                        <div class="mt-2 grid grid-cols-2 gap-2 p-3 border rounded-md">
                            ${setoresOptions}
                        </div>
                    </div>
                    
                    <div><label class="font-medium text-sm">Briefing</label><textarea id="campanha-briefing" rows="3" class="form-input" placeholder="Descreva o objetivo e contexto da campanha...">${campanha?.briefing || ''}</textarea></div>
                    
                    <div><label class="font-medium text-sm">Estrat√©gia</label><textarea id="campanha-estrategia" rows="3" class="form-input" placeholder="Descreva a estrat√©gia de execu√ß√£o...">${campanha?.estrategia || ''}</textarea></div>
                    
                    <div><label class="font-medium text-sm">Link √ötil</label><input type="url" id="campanha-link" class="form-input" placeholder="https://exemplo.com" value="${campanha?.linkUtil || ''}"></div>
                    
                    <div>
                        <label class="font-medium text-sm">Refer√™ncias</label>
                        <div class="space-y-2 mt-2">
                            <input type="url" id="campanha-referencia1" class="form-input" placeholder="https://referencia1.com" value="${campanha?.referencia1 || ''}">
                            <input type="url" id="campanha-referencia2" class="form-input" placeholder="https://referencia2.com" value="${campanha?.referencia2 || ''}">
                        </div>
                    </div>
                    
                    <div>
                        <label class="font-medium text-sm">Plataforma</label>
                        <div class="mt-2 grid grid-cols-2 gap-2 p-3 border rounded-md bg-blue-50">
                            ${plataformaOptions}
                        </div>
                    </div>

                    <div>
                        <label class="font-medium text-sm">Foco da Campanha</label>
                        <div class="mt-2 grid grid-cols-2 gap-2 p-3 border rounded-md bg-yellow-50">
                            ${focoOptions}
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex items-center">
                            <input type="checkbox" id="add-horario" name="add-horario" class="h-4 w-4 rounded" ${campanha?.horario ? 'checked' : ''}>
                            <label for="add-horario" class="ml-2 text-sm font-medium">Adicionar hor√°rio?</label>
                        </div>
                    </div>
                    
                    <div id="horario-field" class="hidden">
                        <label class="font-medium text-sm">Hor√°rio</label>
                        <input type="time" id="campanha-horario" class="form-input" value="${campanha?.horario || ''}">
                    </div>
                    
                    <div id="local-field" class="hidden">
                        <label class="font-medium text-sm">Local do Evento Presencial</label>
                        <input type="text" id="campanha-local" class="form-input" placeholder="Endere√ßo do local" value="${campanha?.local || ''}">
                    </div>
                    
                    <div>
                        <div class="flex items-center">
                            <input type="checkbox" id="campanha-finalizada" name="finalizada" class="h-4 w-4 rounded" ${campanha?.finalizada ? 'checked' : ''}>
                            <label for="campanha-finalizada" class="ml-2 text-sm font-medium">Campanha finalizada</label>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-2">
                        <button type="button" data-action="close-modal" class="secondary-btn">Cancelar</button>
                        <button type="submit" class="primary-btn w-auto">${campanha ? 'Atualizar' : 'Criar'} Campanha</button>
                    </div>
                </form>
            `;
            
            // Add event listeners for conditional fields
            setTimeout(() => {
                const presencialCheckbox = document.getElementById('plataforma-Presencial');
                const horarioCheckbox = document.getElementById('add-horario');
                
                if (presencialCheckbox) {
                    presencialCheckbox.addEventListener('change', function() {
                        const localField = document.getElementById('local-field');
                        if (this.checked) {
                            localField.classList.remove('hidden');
                        } else {
                            localField.classList.add('hidden');
                            document.getElementById('campanha-local').value = '';
                        }
                    });
                    
                    // Check if presencial is already selected
                    if (campanha?.foco?.includes('Presencial')) {
                        document.getElementById('local-field').classList.remove('hidden');
                    }
                }
                
                if (horarioCheckbox) {
                    horarioCheckbox.addEventListener('change', function() {
                        const horarioField = document.getElementById('horario-field');
                        if (this.checked) {
                            horarioField.classList.remove('hidden');
                        } else {
                            horarioField.classList.add('hidden');
                            document.getElementById('campanha-horario').value = '';
                        }
                    });
                    
                    // Check if horario is already set
                    if (campanha?.horario) {
                        document.getElementById('horario-field').classList.remove('hidden');
                    }
                }
            }, 100);
            
            document.getElementById('form-modal-content-area').onsubmit = saveCampanha;
            // Force modal to be visible
            const modal = document.getElementById('form-modal');
            modal.classList.add('visible');
            modal.style.display = 'flex';
            console.log('Modal should be visible now');
        }

        async function saveCampanha(event) {
            event.preventDefault();
            const campanhaId = document.getElementById('campanha-id').value;
            
            const setoresSelecionados = Array.from(document.querySelectorAll('input[name="setores"]:checked')).map(cb => cb.value);
            const plataformaSelecionada = Array.from(document.querySelectorAll('input[name="plataforma"]:checked')).map(cb => cb.value);
            const focoSelecionado = Array.from(document.querySelectorAll('input[name="foco"]:checked')).map(cb => cb.value);
            
            const data = {
                nome: document.getElementById('campanha-nome').value,
                responsavel: document.getElementById('campanha-responsavel').value,
                setores: setoresSelecionados,
                briefing: document.getElementById('campanha-briefing').value,
                estrategia: document.getElementById('campanha-estrategia').value,
                linkUtil: document.getElementById('campanha-link').value,
                referencia1: document.getElementById('campanha-referencia1').value,
                referencia2: document.getElementById('campanha-referencia2').value,
                plataforma: plataformaSelecionada,
                focoObjetivo: focoSelecionado,
                // Keep old foco field for backward compatibility
                foco: plataformaSelecionada,
                local: document.getElementById('campanha-local').value,
                horario: document.getElementById('campanha-horario').value,
                finalizada: document.getElementById('campanha-finalizada').checked,
                updatedAt: serverTimestamp()
            };

            if (!data.nome) { showErrorMessage("Erro", "O nome da campanha √© obrigat√≥rio."); return; }
            if (!data.responsavel) { showErrorMessage("Erro", "O respons√°vel √© obrigat√≥rio."); return; }
            if (setoresSelecionados.length === 0) { showErrorMessage("Erro", "Selecione pelo menos um setor."); return; }
            if (plataformaSelecionada.length === 0) { showErrorMessage("Erro", "Selecione pelo menos uma plataforma."); return; }
            if (focoSelecionado.length === 0) { showErrorMessage("Erro", "Selecione pelo menos um foco da campanha."); return; }

            if (!db) { 
                console.warn("Firebase not available");
                showErrorMessage("Erro", "Sistema offline. Tente novamente quando a conex√£o for restaurada."); 
                return; 
            }
            
            try {
                if (campanhaId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/events`, campanhaId), data);
                    showSuccessMessage("Sucesso!", "Campanha atualizada com sucesso.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/events`), data);
                    showSuccessMessage("Sucesso!", "Nova campanha criada com sucesso.");
                }
                closeFormModal();
            } catch (error) {
                console.error("Error saving campanha:", error);
                showErrorMessage("Erro", "Falha ao salvar a campanha.");
            }
        }

        function openCampanhaModal(campanhaId) {
            clearModalHeaderButtons();
            const campanha = events.find(c => c.id === campanhaId);
            if (!campanha) return;
            
            document.getElementById('form-modal-title').textContent = campanha.nome || campanha.title;
            
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-4">
                    <div class="mb-4">
                        <h3 class="text-2xl font-bold text-stone-800 leading-tight mb-3">${campanha.nome || campanha.title}</h3>
                        ${campanha.setores ? `<div class="flex flex-wrap gap-1">${campanha.setores.map(setor => `<span class="status-tag status-${setor.toLowerCase()} text-xs">${setor}</span>`).join('')}</div>` : ''}
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-stone-600">
                        <p><strong>Respons√°vel:</strong> ${campanha.responsavel || 'N/A'}</p>
                        <p><strong>Foco:</strong> ${campanha.foco ? campanha.foco.join(', ') : 'N/A'}</p>
                        ${campanha.horario ? `<p><strong>Hor√°rio:</strong> ${campanha.horario}</p>` : ''}
                        <p><strong>Status:</strong> <span class="${campanha.finalizada ? 'text-green-600 font-medium' : 'text-orange-600'}">${campanha.finalizada ? 'Finalizada' : 'Em andamento'}</span></p>
                        ${campanha.local ? `<p class="col-span-full"><strong>Local:</strong> ${campanha.local}</p>` : ''}
                        ${campanha.linkUtil ? `<p class="col-span-full"><strong>Link √ötil:</strong> <a href="${campanha.linkUtil}" target="_blank" class="text-blue-600 hover:underline">${campanha.linkUtil}</a></p>` : ''}
                    </div>
                    
                    ${campanha.briefing ? `<div><h4 class="font-semibold text-stone-700">Briefing</h4><p class="mt-1 p-3 bg-stone-50 rounded-md text-sm">${campanha.briefing}</p></div>` : ''}
                    
                    ${campanha.estrategia ? `<div><h4 class="font-semibold text-stone-700">Estrat√©gia</h4><p class="mt-1 p-3 bg-stone-50 rounded-md text-sm">${campanha.estrategia}</p></div>` : ''}
                    
                    <div class="border-t pt-4 flex justify-end gap-2">
                        ${['admin', 'am', 'marketing'].includes(currentUserRole) ? `
                        <button class="secondary-btn" data-action="edit-campanha" data-id="${campanha.id}">Editar</button>
                        <button class="danger-btn" data-action="delete-item" data-collection="events" data-id="${campanha.id}">Apagar</button>
                        ` : ''}
                        <button class="primary-btn" data-action="close-modal">Fechar</button>
                    </div>
                </div>
            `;
            document.getElementById('form-modal').classList.add('visible');
        }




        function openTaskForm(taskId = null) {
            console.log('openTaskForm called', taskId ? `editing task ${taskId}` : 'creating new task');
            clearModalHeaderButtons();
            
            const isEditing = !!taskId;
            const task = isEditing ? tasks.find(t => t.id === taskId) : null;
            
            document.getElementById('form-modal-title').textContent = isEditing ? "Editar Tarefa" : "Adicionar Nova Tarefa";
            
            // Show all collaborators instead of filtering by sectors - more flexible
            const collaboratorOptions = collaborators.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            console.log('Collaborator options:', collaboratorOptions);

            const collaboratorCheckboxes = collaborators.map(c => {
                const isChecked = isEditing && task && task.assignedTo && task.assignedTo.includes(c.name) ? 'checked' : '';
                return `
                    <div class="flex items-center">
                        <input type="checkbox" id="collaborator-${c.id || c.name.replace(/\s+/g, '')}" name="assignedTo" value="${c.name}" class="h-4 w-4 rounded text-yellow-500" ${isChecked}>
                        <label for="collaborator-${c.id || c.name.replace(/\s+/g, '')}" class="ml-2 text-sm">${c.name}</label>
                    </div>
                `;
            }).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="task-id" value="${taskId || ''}">
                    <div><label class="font-medium text-sm">T√≠tulo da Tarefa</label><input type="text" id="task-title" class="form-input" required placeholder="Ex: Revisar material do n√≠vel A1" value="${task?.title || ''}"></div>
                    <div><label class="font-medium text-sm">Descri√ß√£o</label><textarea id="task-description" rows="4" class="form-input" required placeholder="Detalhes sobre a tarefa...">${task?.description || ''}</textarea></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="font-medium text-sm">Prazo Final</label><input type="date" id="task-deadline" class="form-input" required value="${task?.deadline || ''}"></div>
                        <div>
                            <label class="font-medium text-sm">Prioridade/Tag</label>
                            <select id="task-priority" class="form-input">
                                <option value="">Sem tag</option>
                                <option value="urgente" ${task?.priority === 'urgente' ? 'selected' : ''}>Urgente</option>
                                <option value="prioridade" ${task?.priority === 'prioridade' ? 'selected' : ''}>Prioridade</option>
                                <option value="curto-prazo" ${task?.priority === 'curto-prazo' ? 'selected' : ''}>Curto Prazo</option>
                                <option value="longo-prazo" ${task?.priority === 'longo-prazo' ? 'selected' : ''}>Longo Prazo</option>
                                <option value="importante" ${task?.priority === 'importante' ? 'selected' : ''}>Importante</option>
                                <option value="rotina" ${task?.priority === 'rotina' ? 'selected' : ''}>Rotina</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="font-medium text-sm mb-3 block">Atribuir para (selecione um ou mais)</label>
                        <div class="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-3">
                            ${collaboratorCheckboxes}
                        </div>
                    </div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">${isEditing ? 'Atualizar Tarefa' : 'Salvar Tarefa'}</button></div>
                </form>`;
            document.getElementById('form-modal-content-area').onsubmit = saveTask;
            document.getElementById('form-modal').classList.add('visible');
            console.log('Task form modal should be visible now');
        }

        function openTaskModal(taskId) {
            clearModalHeaderButtons();
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const deadlineDate = new Date(task.deadline + 'T00:00:00');
            const isOverdue = !task.completed && deadlineDate < new Date();
            const deadlineClass = isOverdue ? 'text-red-600' : 'text-stone-600';
            const formattedDate = formatDateBR(task.deadline);
            
            document.getElementById('form-modal-title').textContent = task.title || 'Tarefa sem t√≠tulo';
            
            const priorityTagsMap = {
                'urgente': { 
                    text: 'Urgente', 
                    class: 'bg-red-100 text-red-800',
                    icon: '<svg class="w-4 h-4 mr-1.5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L13.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L10.91 8.26L12 2Z"/></svg>'
                },
                'prioridade': { 
                    text: 'Prioridade', 
                    class: 'bg-yellow-100 text-yellow-800',
                    icon: '<svg class="w-4 h-4 mr-1.5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></svg>'
                },
                'curto-prazo': { 
                    text: 'Curto Prazo', 
                    class: 'bg-orange-100 text-orange-800',
                    icon: '<svg class="w-4 h-4 mr-1.5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.5 2 2 6.5 2 12S6.5 22 12 22 22 17.5 22 12 17.5 2 12 2M12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20M12.5 7H11V13L16.25 16.15L17 14.92L12.5 12.25V7Z"/></svg>'
                },
                'longo-prazo': { 
                    text: 'Longo Prazo', 
                    class: 'bg-blue-100 text-blue-800',
                    icon: '<svg class="w-4 h-4 mr-1.5" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H18V1H16V3H8V1H6V3H5C3.89 3 3.01 3.9 3.01 5L3 19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3M19 19H5V8H19V19Z"/></svg>'
                },
                'importante': { 
                    text: 'Importante', 
                    class: 'bg-purple-100 text-purple-800',
                    icon: '<svg class="w-4 h-4 mr-1.5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L13.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L10.91 8.26L12 2Z"/></svg>'
                },
                'rotina': { 
                    text: 'Rotina', 
                    class: 'bg-gray-100 text-gray-800',
                    icon: '<svg class="w-4 h-4 mr-1.5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V2A10 10 0 0 0 2 12H4A8 8 0 0 1 12 4Z"/></svg>'
                }
            };
            const priorityTag = task.priority && priorityTagsMap[task.priority] ? 
                `<span class="inline-flex items-center px-2.5 py-1.5 rounded-full text-sm font-medium ${priorityTagsMap[task.priority].class}">${priorityTagsMap[task.priority].icon}${priorityTagsMap[task.priority].text}</span>` : '';

            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-4">
                    <div class="mb-4">
                        <h3 class="text-2xl font-bold text-stone-800 leading-tight mb-2">${task.title || 'Sem t√≠tulo'}</h3>
                        <div class="flex items-center gap-2 mb-3">
                            <span class="status-tag ${task.completed ? 'status-aprovado' : 'status-pendente'}">${task.completed ? 'Conclu√≠da' : 'Pendente'}</span>
                            ${isOverdue && !task.completed ? '<span class="status-tag status-rejeitado">Atrasada</span>' : ''}
                            ${priorityTag}
                        </div>
                    </div>
                    
                    <div class="bg-stone-50 rounded-lg p-4 mb-4">
                        <h4 class="font-semibold text-stone-700 mb-2">Descri√ß√£o</h4>
                        <p class="text-stone-600 leading-relaxed">${task.description}</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <h4 class="font-semibold text-stone-700 mb-2">Atribu√≠da para</h4>
                            <div class="flex flex-wrap gap-1">
                                ${(task.assignedTo || []).map(name => `<span class="user-tag" style="background-color: #e5e7eb; color: #374151;">${name}</span>`).join('')}
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-stone-700 mb-2">Prazo</h4>
                            <p class="font-medium ${deadlineClass}">${formattedDate}</p>
                        </div>
                    </div>
                    
                    ${task.assignedBy ? `
                    <div class="text-sm">
                        <h4 class="font-semibold text-stone-700 mb-1">Criada por</h4>
                        <span class="user-tag" style="background-color: #F1D24B; color: #44403c;">${task.assignedBy}</span>
                    </div>
                    ` : ''}
                    
                    <div class="border-t pt-4 flex justify-between items-center">
                        <div class="flex items-center gap-6">
                            <label class="flex items-center gap-2 cursor-pointer" title="Marcar como feito (todos podem)">
                                <input type="checkbox" ${task.completedByUser ? 'checked' : ''} 
                                       class="h-4 w-4 rounded"
                                       style="accent-color: #10b981;"
                                       onchange="toggleUserCompletion('${task.id}', this.checked)">
                                <span class="text-sm font-medium text-green-700">Feito</span>
                            </label>
                            ${currentUserRole === 'admin' ? `
                            <label class="flex items-center gap-2 cursor-pointer" title="Aprovar (s√≥ admin)">
                                <input type="checkbox" ${task.approved ? 'checked' : ''} 
                                       class="h-4 w-4 rounded"
                                       style="accent-color: #F1D24B;"
                                       onchange="toggleAdminApproval('${task.id}', this.checked)">
                                <span class="text-sm font-medium" style="color: #F1D24B;">Aprovado</span>
                            </label>
                            ` : ''}
                        </div>
                        <div class="flex gap-2">
                            ${can('tasks-prazos.edit_task') ? `
                            <button class="secondary-btn" data-action="edit-task" data-id="${task.id}">Editar</button>
                            ` : ''}
                            <button class="primary-btn" data-action="close-modal">Fechar</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('form-modal').classList.add('visible');
        }
        async function saveTask(event) {
            event.preventDefault();
            const taskId = document.getElementById('task-id').value;
            const isEditing = !!taskId;
            const assignedToCheckboxes = Array.from(document.querySelectorAll('input[name="assignedTo"]:checked')).map(cb => cb.value);
            
            const data = {
                title: document.getElementById('task-title').value,
                description: document.getElementById('task-description').value,
                deadline: document.getElementById('task-deadline').value,
                priority: document.getElementById('task-priority').value,
                assignedTo: assignedToCheckboxes,
                updatedAt: serverTimestamp()
            };
            
            if (!isEditing) {
                data.assignedBy = currentUserName || 'Admin';
                data.createdAt = serverTimestamp();
                data.completed = false;
            }
            
            if (!data.title || !data.description || !data.deadline || data.assignedTo.length === 0) { 
                showErrorMessage("Erro de Valida√ß√£o", "Por favor, preencha todos os campos obrigat√≥rios."); 
                return; 
            }
            
            if (!db) { 
                console.warn("Offline mode."); 
                closeFormModal(); 
                return; 
            }
            
            try {
                if (isEditing) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, taskId), data);
                    showSuccessMessage("Sucesso!", "Tarefa atualizada com sucesso.");
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), data);
                    showSuccessMessage("Sucesso!", "Tarefa adicionada com sucesso.");
                }
                closeFormModal();
            } catch (error) { 
                console.error("Error saving task:", error); 
                showErrorMessage("Erro", "Falha ao salvar a tarefa."); 
            }
        }

        function openCollaboratorForm(collaboratorId = null) {
            clearModalHeaderButtons();
            const collaborator = collaboratorId ? collaborators.find(c => c.id === collaboratorId) : null;
            document.getElementById('form-modal-title').textContent = collaborator ? "Editar Colaborador" : "Adicionar Novo Colaborador";

            // Roles dispon√≠veis
            const roles = [
                { value: 'admin', label: 'Admin (Acesso Total)' },
                { value: 'teacher', label: 'Professor' },
                { value: 'pedagogico', label: 'Pedag√≥gico' },
                { value: 'ap', label: 'AP (Assistente Pedag√≥gico)' },
                { value: 'financeiro', label: 'Financeiro' },
                { value: 'am', label: 'AM (Assistente de Marketing)' }
            ];

            const roleOptions = roles.map(role => 
                `<option value="${role.value}" ${collaborator?.role === role.value ? 'selected' : ''}>${role.label}</option>`
            ).join('');

            // P√°ginas dispon√≠veis para sele√ß√£o de permiss√µes
            const pages = [
                { key: 'inicio', label: 'Dashboard' },
                { key: 'dojo', label: 'Dojo' },
                { key: 'alunos', label: 'Alunos' },
                { key: 'turmas', label: 'Turmas' },
                { key: 'vips', label: 'VIPs' },
                { key: 'grade', label: 'Grade de Hor√°rios' },
                { key: 'calendario', label: 'Calend√°rio' },
                { key: 'links-uteis', label: 'Links √öteis' },
                { key: 'gestao-tns', label: 'Gest√£o TNs' },
                { key: 'rechamada', label: 'Rechamada' },
                { key: 'kpis-pedagogico', label: 'KPIs Pedag√≥gico' },
                { key: 'logs-atividades', label: 'Logs de Atividades' },
                { key: 'tasks-prazos', label: 'Tasks & Prazos' },
                { key: 'colaboradores', label: 'Colaboradores' },
                { key: 'folha-pagamento', label: 'Financeiro' }
            ];

            const pageCheckboxes = pages.map(page => {
                const isChecked = collaborator?.allowedPages?.includes(page.key) ? 'checked' : '';
                return `
                    <div class="flex items-center">
                        <input type="checkbox" id="page-${page.key}" name="allowedPages" value="${page.key}" class="h-4 w-4 rounded" ${isChecked}>
                        <label for="page-${page.key}" class="ml-2 text-sm cursor-pointer">${page.label}</label>
                    </div>
                `;
            }).join('');

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="collaborator-id" value="${collaboratorId || ''}">
                    
                    <div><label class="font-medium text-sm">Nome Completo <span class="text-red-500">*</span></label><input type="text" id="collaborator-name" class="form-input" required value="${collaborator?.name || ''}"></div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="font-medium text-sm">CPF</label><input type="text" id="collaborator-cpf" class="form-input" placeholder="000.000.000-00" maxlength="14" value="${collaborator?.cpf || ''}"></div>
                        <div><label class="font-medium text-sm">Data de Nascimento</label><input type="date" id="collaborator-birthdate" class="form-input" value="${collaborator?.birthdate || ''}"></div>
                    </div>
                    
                    <div><label class="font-medium text-sm">URL da Foto (Cloudinary)</label><input type="url" id="collaborator-photo-url" class="form-input" placeholder="https://res.cloudinary.com/..." value="${collaborator?.photoUrl || ''}"></div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <label class="font-medium text-sm text-blue-900 mb-2 block">Role de Acesso <span class="text-red-500">*</span></label>
                        <select id="collaborator-role" class="form-input" required>
                            <option value="">-- Selecione o role --</option>
                            ${roleOptions}
                        </select>
                        <p class="text-xs text-blue-700 mt-2">üí° <strong>Template Autom√°tico:</strong> Ao selecionar um role, as permiss√µes t√≠picas ser√£o marcadas automaticamente. Voc√™ pode customizar depois.</p>
                    </div>

                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                        <label class="font-medium text-sm text-yellow-900 mb-3 block">Permiss√µes Granulares por Se√ß√£o</label>
                        <p class="text-xs text-yellow-700 mb-3">Configure as permiss√µes espec√≠ficas para cada se√ß√£o do sistema:</p>
                        <div class="grid grid-cols-2 gap-4 bg-white p-4 rounded border border-yellow-200 max-h-96 overflow-y-auto">
                            
                            <!-- Coluna 1 -->
                            <div class="space-y-4">
                                <!-- In√≠cio -->
                                <div class="border-b pb-3">
                                    <h4 class="font-semibold text-sm mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                                        In√≠cio
                                    </h4>
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" name="perm_inicio_edit_employee_month" class="h-4 w-4 rounded mr-2">
                                        Pode editar funcion√°rio do m√™s
                                    </label>
                                </div>
                                
                                <!-- Dojo -->
                                <div class="border-b pb-3">
                                    <h4 class="font-semibold text-sm mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                                        Dojo
                                    </h4>
                                    <div class="space-y-1">
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_dojo_view_only" class="h-4 w-4 rounded mr-2">
                                            Apenas visualizar (teacher view)
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_dojo_add_competitor" class="h-4 w-4 rounded mr-2">
                                            Pode adicionar competidor
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_dojo_edit_points" class="h-4 w-4 rounded mr-2">
                                            Pode editar pontos
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_dojo_delete_competitor" class="h-4 w-4 rounded mr-2">
                                            Pode excluir competidor
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_dojo_add_active_mission" class="h-4 w-4 rounded mr-2">
                                            Pode adicionar miss√£o ativa
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Alunos -->
                                <div class="border-b pb-3">
                                    <h4 class="font-semibold text-sm mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                                        Alunos
                                    </h4>
                                    <div class="space-y-1">
                                        <label class="flex items-center text-sm">
                                            <input type="radio" name="perm_alunos_access" value="full_access" class="h-4 w-4 mr-2">
                                            Acesso total
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="radio" name="perm_alunos_access" value="access_no_financials" class="h-4 w-4 mr-2">
                                            Acesso total, exceto informa√ß√µes financeiras
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="radio" name="perm_alunos_access" value="none" class="h-4 w-4 mr-2" checked>
                                            Sem acesso
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Turmas -->
                                <div class="border-b pb-3">
                                    <h4 class="font-semibold text-sm mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                                        Turmas
                                    </h4>
                                    <div class="space-y-1">
                                        <label class="flex items-center text-sm">
                                            <input type="radio" name="perm_turmas_access" value="full_access" class="h-4 w-4 mr-2">
                                            Acesso total
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="radio" name="perm_turmas_access" value="teacher_view_only" class="h-4 w-4 mr-2">
                                            Teacher view only (sem editar)
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="radio" name="perm_turmas_access" value="none" class="h-4 w-4 mr-2" checked>
                                            Sem acesso
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- VIPs -->
                                <div class="border-b pb-3">
                                    <h4 class="font-semibold text-sm mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/></svg>
                                        VIPs
                                    </h4>
                                    <div class="space-y-1">
                                        <label class="flex items-center text-sm">
                                            <input type="radio" name="perm_vips_access" value="full_access" class="h-4 w-4 mr-2">
                                            Acesso total
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="radio" name="perm_vips_access" value="teacher_view_only" class="h-4 w-4 mr-2">
                                            Teacher view only (sem configurar)
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="radio" name="perm_vips_access" value="none" class="h-4 w-4 mr-2" checked>
                                            Sem acesso
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Grade -->
                                <div class="border-b pb-3">
                                    <h4 class="font-semibold text-sm mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                        Grade
                                    </h4>
                                    <div class="space-y-1">
                                        <label class="flex items-center text-sm">
                                            <input type="radio" name="perm_grade_access" value="full_access" class="h-4 w-4 mr-2">
                                            Acesso total
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="radio" name="perm_grade_access" value="teacher_own_only" class="h-4 w-4 mr-2">
                                            Teacher own only
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="radio" name="perm_grade_access" value="none" class="h-4 w-4 mr-2" checked>
                                            Sem acesso
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Coluna 2 -->
                            <div class="space-y-4">
                                <!-- Calend√°rio -->
                                <div class="border-b pb-3">
                                    <h4 class="font-semibold text-sm mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                        Calend√°rio
                                    </h4>
                                    <div class="space-y-1">
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_calendario_edit_fixed_periods" class="h-4 w-4 rounded mr-2">
                                            Pode editar per√≠odos fixos
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_calendario_add_event" class="h-4 w-4 rounded mr-2">
                                            Pode adicionar evento
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_calendario_edit_event" class="h-4 w-4 rounded mr-2">
                                            Pode editar eventos
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_calendario_delete_event" class="h-4 w-4 rounded mr-2">
                                            Pode excluir evento
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Links √öteis -->
                                <div class="border-b pb-3">
                                    <h4 class="font-semibold text-sm mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
                                        Links √öteis
                                    </h4>
                                    <div class="space-y-1">
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_links-uteis_view_only" class="h-4 w-4 rounded mr-2">
                                            Apenas visualizar (teacher view)
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_links-uteis_full_access" class="h-4 w-4 rounded mr-2">
                                            Acesso total
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_links-uteis_add_link" class="h-4 w-4 rounded mr-2">
                                            Pode adicionar links
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_links-uteis_edit_link" class="h-4 w-4 rounded mr-2">
                                            Pode editar links
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_links-uteis_delete_link" class="h-4 w-4 rounded mr-2">
                                            Pode excluir links
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Gest√£o TNs -->
                                <div class="border-b pb-3">
                                    <h4 class="font-semibold text-sm mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                        Gest√£o TNs
                                    </h4>
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" name="perm_gestao-tns_full_access" class="h-4 w-4 rounded mr-2">
                                        Acesso total
                                    </label>
                                </div>
                                
                                <!-- Rechamada -->
                                <div class="border-b pb-3">
                                    <h4 class="font-semibold text-sm mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>
                                        Rechamada
                                    </h4>
                                    <div class="space-y-1">
                                        <label class="flex items-center text-sm">
                                            <input type="radio" name="perm_rechamada_access" value="full_access" class="h-4 w-4 mr-2">
                                            Acesso total
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="radio" name="perm_rechamada_access" value="teacher_own_students" class="h-4 w-4 mr-2">
                                            Teacher own students
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="radio" name="perm_rechamada_access" value="none" class="h-4 w-4 mr-2" checked>
                                            Sem acesso
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- KPIs pedag√≥gicos -->
                                <div class="border-b pb-3">
                                    <h4 class="font-semibold text-sm mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                                        KPIs pedag√≥gicos
                                    </h4>
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" name="perm_kpis-pedagogico_full_access" class="h-4 w-4 rounded mr-2">
                                        Acesso total
                                    </label>
                                </div>
                                
                                <!-- Logs de Atividades -->
                                <div class="border-b pb-3">
                                    <h4 class="font-semibold text-sm mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                        Logs de Atividades
                                    </h4>
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" name="perm_logs-atividades_full_access" class="h-4 w-4 rounded mr-2">
                                        Acesso total
                                    </label>
                                </div>
                                
                                <!-- Tasks & Prazos -->
                                <div class="border-b pb-3">
                                    <h4 class="font-semibold text-sm mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                                        Tasks & Prazos
                                    </h4>
                                    <div class="ml-3 space-y-1">
                                        <p class="text-xs font-semibold text-stone-500 mb-1">Visualiza√ß√£o</p>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_tasks-prazos_view_all" class="h-4 w-4 rounded mr-2">
                                            Ver todas as tasks
                                        </label>
                                        
                                        <p class="text-xs font-semibold text-stone-500 mb-1 mt-2">Completar Tasks</p>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_tasks-prazos_complete_own" class="h-4 w-4 rounded mr-2">
                                            Marcar apenas suas tasks como conclu√≠das
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_tasks-prazos_complete_all" class="h-4 w-4 rounded mr-2">
                                            Marcar todas as tasks como conclu√≠das
                                        </label>
                                        
                                        <p class="text-xs font-semibold text-stone-500 mb-1 mt-2">Gerenciar Tasks</p>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_tasks-prazos_add_task" class="h-4 w-4 rounded mr-2">
                                            Adicionar tasks
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_tasks-prazos_edit_task" class="h-4 w-4 rounded mr-2">
                                            Editar tasks
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_tasks-prazos_delete_task" class="h-4 w-4 rounded mr-2">
                                            Excluir tasks
                                        </label>
                                        
                                        <p class="text-xs font-semibold text-stone-500 mb-1 mt-2">Gerenciar Pessoas</p>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_tasks-prazos_add_person" class="h-4 w-4 rounded mr-2">
                                            Adicionar pessoas/colaboradores
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_tasks-prazos_edit_person" class="h-4 w-4 rounded mr-2">
                                            Editar pessoas
                                        </label>
                                        <label class="flex items-center text-sm">
                                            <input type="checkbox" name="perm_tasks-prazos_delete_person" class="h-4 w-4 rounded mr-2">
                                            Excluir pessoas
                                        </label>
                                    </div>
                                </div>
                                
                                <!-- Colaboradores -->
                                <div class="border-b pb-3">
                                    <h4 class="font-semibold text-sm mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                                        Colaboradores
                                    </h4>
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" name="perm_colaboradores_full_access" class="h-4 w-4 rounded mr-2">
                                        Acesso total
                                    </label>
                                </div>
                                
                                <!-- Financeiro -->
                                <div>
                                    <h4 class="font-semibold text-sm mb-2 flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                        Financeiro
                                    </h4>
                                    <label class="flex items-center text-sm">
                                        <input type="checkbox" name="perm_financeiro_full_access" class="h-4 w-4 rounded mr-2">
                                        Acesso total
                                    </label>
                                </div>
                            </div>
                            
                        </div>
                        <p class="text-xs text-yellow-700 mt-2 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                            Admin tem acesso total automaticamente
                        </p>
                    </div>

                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <div class="flex items-center">
                            <input type="checkbox" id="is-evaluator-checkbox" class="h-4 w-4 rounded" ${collaborator?.isEvaluator ? 'checked' : ''}>
                            <label for="is-evaluator-checkbox" class="ml-2 font-medium text-sm text-purple-900">Avaliador de TN</label>
                        </div>
                        <p class="text-xs text-purple-700 mt-2">Se marcado, este colaborador aparecer√° como op√ß√£o de avaliador na Gest√£o de TNs</p>
                    </div>

                    ${!collaboratorId ? `
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <div class="flex items-center mb-3">
                            <input type="checkbox" id="create-firebase-user-checkbox" class="h-4 w-4 rounded" onchange="toggleFirebaseUserFields()">
                            <label for="create-firebase-user-checkbox" class="ml-2 font-medium text-sm text-green-900">Criar usu√°rio Firebase para acesso ao sistema</label>
                        </div>
                        <div id="firebase-user-fields" class="hidden space-y-3">
                            <div>
                                <label class="font-medium text-sm text-green-900">Email para Login</label>
                                <input type="email" id="firebase-email" class="form-input" placeholder="email@exemplo.com">
                            </div>
                            <div>
                                <label class="font-medium text-sm text-green-900">Senha</label>
                                <input type="password" id="firebase-password" class="form-input" placeholder="M√≠nimo 6 caracteres" minlength="6">
                            </div>
                            <p class="text-xs text-green-700">O colaborador poder√° fazer login no sistema com este email e senha</p>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;
            document.getElementById('form-modal-content-area').onsubmit = saveCollaborator;
            document.getElementById('form-modal').classList.add('visible');
            
            // Add CPF mask formatting
            const cpfInput = document.getElementById('collaborator-cpf');
            if (cpfInput) {
                cpfInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length <= 11) {
                        value = value.replace(/(\d{3})(\d)/, '$1.$2');
                        value = value.replace(/(\d{3})(\d)/, '$1.$2');
                        value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                    }
                    e.target.value = value;
                });
            }

            // Fun√ß√£o para aplicar preset de permiss√µes baseado no role
            window.applyRolePermissionPreset = function(roleValue) {
                // Limpar todas as permiss√µes primeiro
                document.querySelectorAll('input[type="checkbox"][name^="perm_"]').forEach(cb => cb.checked = false);
                document.querySelectorAll('input[type="radio"][name^="perm_"]').forEach(radio => {
                    if (radio.value === 'none') radio.checked = true;
                    else radio.checked = false;
                });
                
                // Limpar allowedPages
                document.querySelectorAll('input[name="allowedPages"]').forEach(cb => cb.checked = false);
                
                // Aplicar preset do role selecionado
                const preset = PermissionRegistry.presets[roleValue];
                if (!preset || !preset.permissions) {
                    console.log('Nenhum preset encontrado para role:', roleValue);
                    return;
                }
                
                Object.keys(preset.permissions).forEach(permKey => {
                    if (preset.permissions[permKey] === true) {
                        // Converter permKey para nome do input
                        const inputName = 'perm_' + permKey.replace(/\./g, '_');
                        
                        // Tentar marcar checkbox
                        const checkbox = document.querySelector(`input[type="checkbox"][name="${inputName}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                        
                        // Tentar marcar radio button
                        const parts = permKey.split('.');
                        if (parts.length === 2) {
                            const section = parts[0];
                            const action = parts[1];
                            const radioName = `perm_${section}_access`;
                            const radio = document.querySelector(`input[type="radio"][name="${radioName}"][value="${action}"]`);
                            if (radio) {
                                radio.checked = true;
                            }
                        }
                    }
                });
                
                // Aplicar allowedPages baseado no role
                const allowedPagesByRole = {
                    'professor': ['inicio', 'dojo', 'alunos', 'turmas', 'vips', 'grade', 'calendario', 'links-uteis', 'tasks-prazos', 'rechamada'],
                    'pedagogico': ['inicio', 'dojo', 'alunos', 'turmas', 'vips', 'grade', 'calendario', 'links-uteis', 'tasks-prazos', 'gestao-tns', 'rechamada', 'kpis-pedagogico', 'logs-atividades'],
                    'financeiro': ['alunos', 'turmas', 'vips', 'tasks-prazos', 'kpis-pedagogico', 'logs-atividades', 'folha-pagamento'],
                    'ap': ['alunos', 'turmas', 'vips', 'grade', 'calendario', 'tasks-prazos', 'rechamada', 'kpis-pedagogico'],
                    'am': ['inicio', 'dojo', 'calendario', 'links-uteis', 'tasks-prazos']
                };
                
                const pagesToAllow = allowedPagesByRole[roleValue] || [];
                pagesToAllow.forEach(pageKey => {
                    const checkbox = document.querySelector(`input[name="allowedPages"][value="${pageKey}"]`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
                
                console.log(`‚úÖ Preset de permiss√µes e p√°ginas aplicado para role: ${roleValue}`);
            };
            
            // Adicionar event listener no select de role
            setTimeout(() => {
                const roleSelect = document.getElementById('collaborator-role');
                if (roleSelect) {
                    roleSelect.addEventListener('change', function() {
                        const selectedRole = this.value;
                        if (selectedRole && selectedRole !== '') {
                            applyRolePermissionPreset(selectedRole);
                        }
                    });
                }
            }, 100);
            
            // NOVO: Carregar permiss√µes granulares se estiver editando
            if (collaborator && collaborator.permissions) {
                setTimeout(() => {
                    Object.keys(collaborator.permissions).forEach(permKey => {
                        if (collaborator.permissions[permKey] === true) {
                            // Converter permKey de volta para nome do input
                            const inputName = 'perm_' + permKey.replace(/\./g, '_');
                            
                            // Tentar marcar checkbox
                            const checkbox = document.querySelector(`input[type="checkbox"][name="${inputName}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                            
                            // Tentar marcar radio button
                            // Ex: alunos.full_access -> perm_alunos_access com value=full_access
                            const parts = permKey.split('.');
                            if (parts.length === 2) {
                                const section = parts[0];
                                const action = parts[1];
                                const radioName = `perm_${section}_access`;
                                const radio = document.querySelector(`input[type="radio"][name="${radioName}"][value="${action}"]`);
                                if (radio) {
                                    radio.checked = true;
                                }
                            }
                        }
                    });
                    console.log('‚úÖ Permiss√µes carregadas para colaborador:', collaborator.name);
                }, 150);
            } else if (collaborator && collaborator.role) {
                // Se est√° criando novo colaborador ou editando sem permiss√µes customizadas, aplicar preset do role
                setTimeout(() => {
                    applyRolePermissionPreset(collaborator.role);
                }, 150);
            }
        }

        async function populateEmailField(collaborator) {
            const container = document.getElementById('email-field-container');
            if (!container) return;

            // Fetch Firebase users
            let firebaseUsers = [];
            if (!window.isDevelopmentMode && db) {
                try {
                    const usersSnapshot = await getDocs(collection(db, 'users'));
                    firebaseUsers = usersSnapshot.docs.map(doc => ({
                        uid: doc.id,
                        email: doc.data().email,
                        name: doc.data().name
                    })).filter(u => u.email);
                    console.log('Firebase users loaded:', firebaseUsers.length);
                } catch (error) {
                    console.error('Error fetching Firebase users:', error);
                }
            }

            // Build email select dropdown
            const emailOptions = firebaseUsers.map(u => 
                `<option value="${u.email}" data-uid="${u.uid}" ${collaborator?.email === u.email ? 'selected' : ''}>${u.email} (${u.name || 'Sem nome'})</option>`
            ).join('');

            container.innerHTML = `
                <div>
                    <label class="font-medium text-sm">E-mail Cadastrado</label>
                    <select id="collaborator-email" class="form-input">
                        <option value="">-- Nenhum (sem v√≠nculo Firebase) --</option>
                        ${emailOptions}
                    </select>
                    <p class="text-xs text-stone-500 mt-1">Selecione um e-mail para vincular automaticamente ao usu√°rio Firebase</p>
                </div>
            `;
        }

        window.toggleFirebaseUserFields = function() {
            const checkbox = document.getElementById('create-firebase-user-checkbox');
            const fields = document.getElementById('firebase-user-fields');
            if (checkbox && fields) {
                if (checkbox.checked) {
                    fields.classList.remove('hidden');
                } else {
                    fields.classList.add('hidden');
                }
            }
        };

        async function saveCollaborator(event) {
            event.preventDefault();
            const collaboratorId = document.getElementById('collaborator-id').value;
            const role = document.getElementById('collaborator-role').value;
            const isEvaluator = document.getElementById('is-evaluator-checkbox')?.checked || false;

            // NOVO: Coletar permiss√µes granulares
            const permissions = {};
            
            // Checkboxes simples
            const checkboxes = document.querySelectorAll('input[type="checkbox"][name^="perm_"]:checked');
            checkboxes.forEach(cb => {
                const permKey = cb.name.replace('perm_', '').replace(/_/g, '.');
                permissions[permKey] = true;
            });
            
            // Radio buttons (pegar valores selecionados que n√£o sejam "none")
            const radioGroups = ['perm_alunos_access', 'perm_turmas_access', 'perm_vips_access', 'perm_grade_access', 'perm_rechamada_access'];
            radioGroups.forEach(groupName => {
                const selected = document.querySelector(`input[name="${groupName}"]:checked`);
                if (selected && selected.value !== 'none') {
                    const section = groupName.replace('perm_', '').replace('_access', '');
                    permissions[`${section}.${selected.value}`] = true;
                }
            });

            // Coletar allowedPages (p√°ginas permitidas)
            const allowedPagesCheckboxes = document.querySelectorAll('input[name="allowedPages"]:checked');
            const allowedPages = Array.from(allowedPagesCheckboxes).map(cb => cb.value);

            const data = {
                name: document.getElementById('collaborator-name').value,
                cpf: document.getElementById('collaborator-cpf').value,
                birthdate: document.getElementById('collaborator-birthdate').value,
                photoUrl: document.getElementById('collaborator-photo-url').value,
                role: role,
                permissions: permissions, // NOVO: salvar permiss√µes granulares
                allowedPages: allowedPages, // NOVO: salvar p√°ginas permitidas
                isEvaluator: isEvaluator
            };

            if (!data.name) { showErrorMessage("Erro", "O nome do colaborador √© obrigat√≥rio."); return; }
            if (!data.role) { showErrorMessage("Erro", "O role de acesso √© obrigat√≥rio."); return; }
            
            // Check if creating Firebase user
            const createFirebaseUser = !collaboratorId && document.getElementById('create-firebase-user-checkbox')?.checked;
            const firebaseEmail = document.getElementById('firebase-email')?.value;
            const firebasePassword = document.getElementById('firebase-password')?.value;
            
            if (createFirebaseUser && (!firebaseEmail || !firebasePassword)) {
                showErrorMessage("Erro", "Por favor, preencha o email e senha para criar o usu√°rio Firebase.");
                return;
            }
            
            if (window.isDevelopmentMode) {
                // Modo desenvolvimento (local storage)
                if (collaboratorId) {
                    const index = collaborators.findIndex(c => c.id === collaboratorId);
                    if (index !== -1) {
                        collaborators[index] = { ...collaborators[index], ...data };
                        localStorage.setItem('collaborators', JSON.stringify(collaborators));
                    }
                } else {
                    const newCollaborator = { ...data, id: Date.now().toString() };
                    collaborators.push(newCollaborator);
                    localStorage.setItem('collaborators', JSON.stringify(collaborators));
                }
                closeFormModal();
                renderColaboradoresSection();
                showSuccessMessage("Sucesso!", collaboratorId ? "Colaborador atualizado." : "Colaborador adicionado.");
                return;
            }

            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }

            try {
                let savedCollaboratorId = collaboratorId;
                
                if (collaboratorId) {
                    const collaboratorRef = doc(db, `artifacts/${appId}/public/data/collaborators`, collaboratorId);
                    await updateDoc(collaboratorRef, data);
                    await logActivity('editar', 'colaborador', data.name, { cargo: data.role });
                    
                    // If collaborator has a Firebase UID, also update the user's role
                    const collaboratorDoc = await getDoc(collaboratorRef);
                    const collaboratorData = collaboratorDoc.data();
                    
                    if (collaboratorData.firebaseUid) {
                        try {
                            const userRef = doc(db, `artifacts/${appId}/users`, collaboratorData.firebaseUid);
                            await updateDoc(userRef, { 
                                role: data.role,
                                name: data.name
                            });
                        } catch (error) {
                            console.warn('Could not update user role:', error);
                        }
                    }
                } else {
                    const docRef = await addDoc(collection(db, `artifacts/${appId}/public/data/collaborators`), data);
                    savedCollaboratorId = docRef.id;
                    await logActivity('criar', 'colaborador', data.name, { cargo: data.role });
                }
                
                // Create Firebase user if checkbox is checked
                if (createFirebaseUser && firebaseEmail && firebasePassword) {
                    try {
                        const response = await fetch('/api/firebase/create-user', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                email: firebaseEmail, 
                                password: firebasePassword, 
                                displayName: data.name,
                                role: data.role
                            })
                        });
                        
                        const firebaseData = await response.json();
                        
                        if (response.ok) {
                            // Update collaborator with Firebase UID
                            await updateDoc(doc(db, `artifacts/${appId}/public/data/collaborators`, savedCollaboratorId), {
                                firebaseUid: firebaseData.uid,
                                email: firebaseEmail
                            });
                            showSuccessMessage("Sucesso!", `Colaborador e usu√°rio Firebase criados com sucesso!\n\nO colaborador poder√° fazer login com: ${firebaseEmail}`);
                        } else {
                            showSuccessMessage("Parcial", `Colaborador criado, mas erro ao criar usu√°rio Firebase: ${firebaseData.error}`);
                        }
                    } catch (error) {
                        showSuccessMessage("Parcial", `Colaborador criado, mas erro ao criar usu√°rio Firebase: ${error.message}`);
                    }
                } else {
                    showSuccessMessage("Sucesso!", collaboratorId ? "Colaborador atualizado." : "Colaborador adicionado.");
                }
                
                closeFormModal();
                renderColaboradoresSection();
            } catch (error) { console.error("Error saving collaborator:", error); showErrorMessage("Erro", "Falha ao salvar o colaborador."); }
        }


        function openScheduleForm(scheduleId = null) {
            clearModalHeaderButtons();
            const schedule = scheduleId ? schedules.find(s => s.id === scheduleId) : null;
            
            // If editing, find all related schedules (same teacher, student, type)
            let relatedSchedules = [];
            let day1Schedule = null;
            let day2Schedule = null;
            let day3Schedule = null;
            
            if (schedule) {
                relatedSchedules = schedules.filter(s => 
                    s.teacher === schedule.teacher &&
                    s.student === schedule.student &&
                    s.type === schedule.type
                );
                
                // Sort by day to assign correctly
                relatedSchedules.sort((a, b) => {
                    const dayOrder = ["Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado"];
                    return dayOrder.indexOf(a.day) - dayOrder.indexOf(b.day);
                });
                
                day1Schedule = relatedSchedules[0] || null;
                day2Schedule = relatedSchedules[1] || null;
                day3Schedule = relatedSchedules[2] || null;
            }
            
            document.getElementById('form-modal-title').textContent = schedule ? "Detalhes da Aula" : "Adicionar Nova Aula";
            const isTeacher = currentUserRole === 'teacher';

            const teacherOptions = collaborators.filter(c => c.role === 'teacher').map(c => `<option value="${c.name}" ${schedule?.teacher === c.name ? 'selected' : ''}>${c.name}</option>`).join('');
            const dayOptions = ["Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado"].map(d => `<option value="${d}" ${schedule?.day === d ? 'selected' : ''}>${d}</option>`).join('');
            const typeOptions = ["vip", "turma", "break"].map(t => `<option value="${t}" ${schedule?.type === t ? 'selected' : ''}>${t === 'break' ? 'BREAK' : t.toUpperCase()}</option>`).join('');
            const levelOptions = STANDARD_LEVELS.map(level => `<option value="${level}" ${schedule?.level === level ? 'selected' : ''}>${level}</option>`).join('') + `<option value="outro">Outro (especificar)</option>`;

            // Get VIP students (including DUPLA) and turmas for dropdowns
            const vipStudents = students.filter(s => (s.modalidade === 'VIP' || s.modalidade === 'DUPLA') && s.status === 'Ativo');
            const turmasList = turmas.filter(t => t.name);

            let formHtml = `<form id="form-modal-body" class="space-y-4">
                <input type="hidden" id="schedule-id" value="${scheduleId || ''}">
                
                <div><label class="font-medium text-sm">Tipo</label><select id="schedule-type" class="form-input" required ${isTeacher ? 'disabled' : ''}>${typeOptions}</select></div>
                
                <div class="schedule-student-field">
                    <label class="font-medium text-sm" id="student-field-label">Aluno/Turma</label>
                    
                    <!-- VIP search field (hidden by default) -->
                    <div id="schedule-vip-container" class="hidden relative">
                        <input type="text" id="schedule-vip-search" class="form-input" placeholder="Digite o nome do aluno VIP..." 
                               autocomplete="off" value="${schedule?.student || ''}" ${isTeacher ? 'disabled' : ''}>
                        
                        <button type="button" id="schedule-vip-dropdown-btn" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:outline-none" ${isTeacher ? 'disabled' : ''}>
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="6 9 12 15 18 9"></polyline>
                            </svg>
                        </button>
                        
                        <div id="schedule-vip-results" class="absolute z-50 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden">
                            ${vipStudents.length > 0 ? vipStudents.map(s => `
                                <div class="p-2 hover:bg-gray-100 cursor-pointer border-b" data-student-name="${s.name}">
                                    <p class="font-medium text-sm">${s.name}</p>
                                    <p class="text-xs text-gray-500">Status: ${s.status} | Modalidade: ${s.modalidade}</p>
                                </div>
                            `).join('') : '<div class="p-2 text-sm text-gray-500">Nenhum aluno VIP dispon√≠vel</div>'}
                        </div>
                    </div>
                    
                    <!-- TURMA dropdown (hidden by default) -->
                    <select id="schedule-turma-select" class="form-input hidden" ${isTeacher ? 'disabled' : ''}>
                        <option value="">Selecione uma turma</option>
                        ${turmasList.map(t => `<option value="${t.name}" ${schedule?.student === t.name ? 'selected' : ''}>${t.name}</option>`).join('')}
                    </select>
                    
                    <!-- Hidden input to store the selected value -->
                    <input type="hidden" id="schedule-student" value="${schedule?.student || ''}">
                    
                    <p id="student-duplicate-warning" class="hidden text-sm text-red-600 mt-1">‚ö†Ô∏è Aluno j√° presente na grade deste professor</p>
                </div>
                <div class="schedule-level-field">
                    <label class="font-medium text-sm">N√≠vel</label>
                    <select id="schedule-level" class="form-input" required ${isTeacher ? 'disabled' : ''}>${levelOptions}</select>
                    <input type="text" id="schedule-level-custom" class="form-input mt-2 hidden" placeholder="Digite o n√≠vel personalizado" ${isTeacher ? 'disabled' : ''}>
                </div>
                <div><label class="font-medium text-sm">Professor</label><select id="schedule-teacher" class="form-input" required ${isTeacher ? 'disabled' : ''}>${teacherOptions}</select></div>
                
                <div class="border border-stone-200 rounded-lg p-4 bg-stone-50">
                    <h4 class="font-semibold text-sm text-stone-700 mb-3">Dia 1 <span class="text-red-500">*</span></h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="font-medium text-xs">Dia da Semana</label><select id="schedule-day1" class="form-input" required ${isTeacher ? 'disabled' : ''}>${dayOptions}</select></div>
                        <div><label class="font-medium text-xs">In√≠cio</label><input type="time" id="schedule-start1" class="form-input" required value="${day1Schedule?.startTime || schedule?.startTime || ''}" ${isTeacher ? 'disabled' : ''}></div>
                        <div><label class="font-medium text-xs">Fim</label><input type="time" id="schedule-end1" class="form-input" required value="${day1Schedule?.endTime || schedule?.endTime || ''}" ${isTeacher ? 'disabled' : ''}></div>
                    </div>
                </div>
                
                <div class="border border-stone-200 rounded-lg p-4 bg-stone-50">
                    <h4 class="font-semibold text-sm text-stone-700 mb-3">Dia 2 <span class="text-stone-400 text-xs">(opcional)</span></h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="font-medium text-xs">Dia da Semana</label><select id="schedule-day2" class="form-input" ${isTeacher ? 'disabled' : ''}>${dayOptions}</select></div>
                        <div><label class="font-medium text-xs">In√≠cio</label><input type="time" id="schedule-start2" class="form-input" value="${day2Schedule?.startTime || ''}" ${isTeacher ? 'disabled' : ''}></div>
                        <div><label class="font-medium text-xs">Fim</label><input type="time" id="schedule-end2" class="form-input" value="${day2Schedule?.endTime || ''}" ${isTeacher ? 'disabled' : ''}></div>
                    </div>
                </div>
                
                <div id="day3-container" class="border border-stone-200 rounded-lg p-4 bg-stone-50 hidden">
                    <h4 class="font-semibold text-sm text-stone-700 mb-3">Dia 3 <span class="text-stone-400 text-xs">(opcional)</span></h4>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="font-medium text-xs">Dia da Semana</label><select id="schedule-day3" class="form-input" ${isTeacher ? 'disabled' : ''}>${dayOptions}</select></div>
                        <div><label class="font-medium text-xs">In√≠cio</label><input type="time" id="schedule-start3" class="form-input" value="${day3Schedule?.startTime || ''}" ${isTeacher ? 'disabled' : ''}></div>
                        <div><label class="font-medium text-xs">Fim</label><input type="time" id="schedule-end3" class="form-input" value="${day3Schedule?.endTime || ''}" ${isTeacher ? 'disabled' : ''}></div>
                    </div>
                </div>
                
                ${!isTeacher ? `<button type="button" id="add-day-btn" class="w-full py-2 px-4 border-2 border-dashed border-stone-300 rounded-lg text-stone-600 hover:border-[#F1D24B] hover:text-stone-800 transition-colors font-medium text-sm flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Adicionar +1 Dia
                </button>` : ''}
                <div id="conflict-warning" class="hidden bg-red-50 border border-red-200 rounded-lg p-3 text-red-700">
                    <strong>‚ö†Ô∏è Conflito de hor√°rio detectado!</strong>
                    <p>J√° existe uma aula agendada para este professor neste hor√°rio.</p>
                </div>
                ${!isTeacher ? `<div class="pt-4 flex justify-end gap-2">${scheduleId ? `<button type="button" class="danger-btn" data-action="delete-item" data-collection="schedules" data-id="${scheduleId}">Apagar</button>` : ''}<button type="submit" class="primary-btn w-auto">Salvar</button></div>` : ''}
            </form>`;
            document.getElementById('form-modal-content-area').innerHTML = formHtml;

            const levelSelect = document.getElementById('schedule-level');
            const levelCustomInput = document.getElementById('schedule-level-custom');
            levelSelect.addEventListener('change', (e) => {
                levelCustomInput.classList.toggle('hidden', e.target.value !== 'outro');
            });

            // Hide/show fields based on type selection
            function updateFormFields() {
                const type = document.getElementById('schedule-type').value;
                const studentField = document.querySelector('.schedule-student-field');
                const levelField = document.querySelector('.schedule-level-field');
                const vipContainer = document.getElementById('schedule-vip-container');
                const turmaSelect = document.getElementById('schedule-turma-select');
                const hiddenInput = document.getElementById('schedule-student');
                const levelSelect = document.getElementById('schedule-level');
                const fieldLabel = document.getElementById('student-field-label');

                if (type === 'break') {
                    studentField.style.display = 'none';
                    levelField.style.display = 'none';
                } else if (type === 'vip') {
                    studentField.style.display = 'block';
                    levelField.style.display = 'block';
                    fieldLabel.textContent = 'Aluno VIP';
                    vipContainer.classList.remove('hidden');
                    turmaSelect.classList.add('hidden');
                    // Sync hidden input with VIP search
                    const vipSearchInput = document.getElementById('schedule-vip-search');
                    if (vipSearchInput.value) {
                        hiddenInput.value = vipSearchInput.value;
                    }
                } else if (type === 'turma') {
                    studentField.style.display = 'block';
                    levelField.style.display = 'block';
                    fieldLabel.textContent = 'Turma';
                    vipContainer.classList.add('hidden');
                    turmaSelect.classList.remove('hidden');
                    // Sync hidden input with Turma selection
                    if (turmaSelect.value) {
                        hiddenInput.value = turmaSelect.value;
                    }
                }
            }

            // Check for time conflicts
            function checkConflicts() {
                const teacher = document.getElementById('schedule-teacher').value;
                const day1 = document.getElementById('schedule-day1').value;
                const startTime1 = document.getElementById('schedule-start1').value;
                const endTime1 = document.getElementById('schedule-end1').value;
                const day2 = document.getElementById('schedule-day2').value;
                const startTime2 = document.getElementById('schedule-start2').value;
                const endTime2 = document.getElementById('schedule-end2').value;
                const day3 = document.getElementById('schedule-day3').value;
                const startTime3 = document.getElementById('schedule-start3').value;
                const endTime3 = document.getElementById('schedule-end3').value;
                const scheduleId = document.getElementById('schedule-id').value;
                const warning = document.getElementById('conflict-warning');

                let hasConflict = false;
                
                // Check conflicts for Day 1
                if (teacher && day1 && startTime1 && endTime1) {
                    hasConflict = checkTimeConflict(teacher, day1, startTime1, endTime1, scheduleId);
                }
                
                // Check conflicts for Day 2 if no conflict found yet
                if (!hasConflict && teacher && day2 && startTime2 && endTime2) {
                    hasConflict = checkTimeConflict(teacher, day2, startTime2, endTime2, scheduleId);
                }
                
                // Check conflicts for Day 3 if no conflict found yet
                if (!hasConflict && teacher && day3 && startTime3 && endTime3) {
                    hasConflict = checkTimeConflict(teacher, day3, startTime3, endTime3, scheduleId);
                }
                
                if (hasConflict) {
                    warning.classList.remove('hidden');
                } else {
                    warning.classList.add('hidden');
                }
            }

            // Check for duplicate students
            function checkStudentDuplicate() {
                const student = document.getElementById('schedule-student').value;
                const teacher = document.getElementById('schedule-teacher').value;
                const scheduleId = document.getElementById('schedule-id').value;
                const warning = document.getElementById('student-duplicate-warning');
                const type = document.getElementById('schedule-type').value;

                // Skip check for breaks or if no student/teacher selected
                if (!student || !teacher || type === 'break') {
                    warning.classList.add('hidden');
                    return;
                }

                // Check if this student already exists in ANY teacher's schedule (excluding current edit)
                const existingSchedule = schedules.find(s => 
                    s.student === student && 
                    s.id !== scheduleId &&
                    s.type !== 'break'
                );

                if (existingSchedule) {
                    warning.textContent = `‚ö†Ô∏è Aluno/Turma j√° adicionado na grade do professor ${existingSchedule.teacher}`;
                    warning.classList.remove('hidden');
                } else {
                    warning.classList.add('hidden');
                }
            }

            // VIP search functionality
            const vipSearchInput = document.getElementById('schedule-vip-search');
            const vipResults = document.getElementById('schedule-vip-results');
            const vipDropdownBtn = document.getElementById('schedule-vip-dropdown-btn');
            const allVipItems = vipResults.querySelectorAll('[data-student-name]');

            // Filter VIP list as user types
            vipSearchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                vipResults.classList.remove('hidden');
                
                let hasVisibleResults = false;
                allVipItems.forEach(item => {
                    const studentName = item.getAttribute('data-student-name').toLowerCase();
                    if (studentName.includes(searchTerm)) {
                        item.style.display = 'block';
                        hasVisibleResults = true;
                    } else {
                        item.style.display = 'none';
                    }
                });
                
                if (!hasVisibleResults && searchTerm) {
                    vipResults.innerHTML = '<div class="p-2 text-sm text-gray-500">Nenhum aluno encontrado</div>';
                }
            });

            // Show/hide dropdown on button click
            vipDropdownBtn.addEventListener('click', (e) => {
                e.preventDefault();
                vipResults.classList.toggle('hidden');
                // Reset filter to show all
                allVipItems.forEach(item => item.style.display = 'block');
            });

            // Select VIP from list
            vipResults.addEventListener('click', (e) => {
                const item = e.target.closest('[data-student-name]');
                if (item) {
                    const studentName = item.getAttribute('data-student-name');
                    vipSearchInput.value = studentName;
                    document.getElementById('schedule-student').value = studentName;
                    vipResults.classList.add('hidden');
                    checkStudentDuplicate();
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!vipSearchInput.contains(e.target) && !vipResults.contains(e.target) && !vipDropdownBtn.contains(e.target)) {
                    vipResults.classList.add('hidden');
                }
            });

            // Sync Turma select with hidden input
            document.getElementById('schedule-turma-select').addEventListener('change', (e) => {
                document.getElementById('schedule-student').value = e.target.value;
                checkStudentDuplicate();
            });

            document.getElementById('schedule-type').addEventListener('change', () => {
                updateFormFields();
                checkStudentDuplicate();
            });
            document.getElementById('schedule-teacher').addEventListener('change', () => {
                checkConflicts();
                checkStudentDuplicate();
            });
            document.getElementById('schedule-day1').addEventListener('change', checkConflicts);
            document.getElementById('schedule-start1').addEventListener('change', checkConflicts);
            document.getElementById('schedule-end1').addEventListener('change', checkConflicts);
            document.getElementById('schedule-day2').addEventListener('change', checkConflicts);
            document.getElementById('schedule-start2').addEventListener('change', checkConflicts);
            document.getElementById('schedule-end2').addEventListener('change', checkConflicts);
            document.getElementById('schedule-day3').addEventListener('change', checkConflicts);
            document.getElementById('schedule-start3').addEventListener('change', checkConflicts);
            document.getElementById('schedule-end3').addEventListener('change', checkConflicts);

            // Bot√£o "+1 dia" para mostrar Dia 3
            const addDayBtn = document.getElementById('add-day-btn');
            const day3Container = document.getElementById('day3-container');
            if (addDayBtn) {
                addDayBtn.addEventListener('click', () => {
                    day3Container.classList.remove('hidden');
                    addDayBtn.classList.add('hidden');
                });
            }

            // Preencher valores de Dia 1, Dia 2 e Dia 3 se j√° existirem (modo edi√ß√£o)
            if (day1Schedule) {
                document.getElementById('schedule-day1').value = day1Schedule.day || '';
            }
            
            if (day2Schedule) {
                document.getElementById('schedule-day2').value = day2Schedule.day || '';
            }
            
            if (day3Schedule) {
                document.getElementById('schedule-day3').value = day3Schedule.day || '';
                day3Container.classList.remove('hidden');
                if (addDayBtn) addDayBtn.classList.add('hidden');
            }

            updateFormFields();

            document.getElementById('form-modal-content-area').onsubmit = saveScheduleEntry;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveScheduleEntry(event) {
            event.preventDefault();
            
            const student = document.getElementById('schedule-student').value;
            const teacherName = document.getElementById('schedule-teacher').value;
            const scheduleId = document.getElementById('schedule-id').value;
            const scheduleType = document.getElementById('schedule-type').value;
            
            // Check for duplicate student in ANY teacher's schedule (only for non-break entries)
            if (scheduleType !== 'break') {
                const existingSchedule = schedules.find(s => 
                    s.student === student && 
                    s.id !== scheduleId &&
                    s.type !== 'break'
                );
                
                if (existingSchedule) {
                    showErrorMessage("Erro", `Aluno j√° adicionado na grade do professor ${existingSchedule.teacher}.`);
                    return;
                }
            }
            
            const startTime1 = document.getElementById('schedule-start1').value;
            const teacher = collaborators.find(c => c.name === teacherName);
            if (teacher && teacher.shiftStart && teacher.shiftEnd) {
                if (startTime1 < teacher.shiftStart || startTime1 > teacher.shiftEnd) {
                    showConfirmationModal(
                        "Aviso de Hor√°rio", 
                        `Este hor√°rio (${startTime1}) est√° fora do turno do professor (${teacher.shiftStart} - ${teacher.shiftEnd}). Tem certeza que quer continuar?`,
                        () => proceedWithSaveSchedule()
                    );
                    return;
                }
            }
            proceedWithSaveSchedule();
        }

        async function proceedWithSaveSchedule() {
            const scheduleId = document.getElementById('schedule-id').value;
            
            const day1 = document.getElementById('schedule-day1').value;
            const startTime1 = document.getElementById('schedule-start1').value;
            const endTime1 = document.getElementById('schedule-end1').value;
            
            const day2 = document.getElementById('schedule-day2').value;
            const startTime2 = document.getElementById('schedule-start2').value;
            const endTime2 = document.getElementById('schedule-end2').value;
            
            const day3 = document.getElementById('schedule-day3').value;
            const startTime3 = document.getElementById('schedule-start3').value;
            const endTime3 = document.getElementById('schedule-end3').value;

            const levelSelect = document.getElementById('schedule-level');
            const levelValue = levelSelect.value === 'outro'
                ? document.getElementById('schedule-level-custom').value
                : levelSelect.value;

            const scheduleType = document.getElementById('schedule-type').value;
            const studentValue = scheduleType === 'break' ? 'Break' : document.getElementById('schedule-student').value;
            const teacherValue = document.getElementById('schedule-teacher').value;
            
            // Create data for Day 1 (obrigat√≥rio)
            const data1 = { 
                student: studentValue, 
                level: scheduleType === 'break' ? 'N/A' : levelValue, 
                teacher: teacherValue, 
                type: scheduleType, 
                day: day1,
                startTime: startTime1, 
                endTime: endTime1 
            };
            
            // Create data for Day 2 (opcional)
            const data2 = day2 && startTime2 && endTime2 ? { 
                student: studentValue, 
                level: scheduleType === 'break' ? 'N/A' : levelValue, 
                teacher: teacherValue, 
                type: scheduleType, 
                day: day2,
                startTime: startTime2, 
                endTime: endTime2 
            } : null;
            
            // Create data for Day 3 (opcional)
            const data3 = day3 && startTime3 && endTime3 ? { 
                student: studentValue, 
                level: scheduleType === 'break' ? 'N/A' : levelValue, 
                teacher: teacherValue, 
                type: scheduleType, 
                day: day3,
                startTime: startTime3, 
                endTime: endTime3 
            } : null;

            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            try {
                if (scheduleId) { 
                    // When editing, we need to find and update all related entries
                    const originalSchedule = schedules.find(s => s.id === scheduleId);
                    
                    if (originalSchedule) {
                        // Find all schedules with same teacher, student, type (paired entries)
                        const relatedSchedules = schedules.filter(s => 
                            s.teacher === originalSchedule.teacher &&
                            s.student === originalSchedule.student &&
                            s.type === originalSchedule.type
                        );

                        // Delete all related entries
                        for (const relatedSchedule of relatedSchedules) {
                            await deleteDoc(doc(db, `artifacts/${appId}/public/data/schedules`, relatedSchedule.id));
                        }
                        
                        // Create Day 1 entry
                        const dataWithTimestamp1 = {...data1, createdAt: serverTimestamp() };
                        await addDoc(collection(db, `artifacts/${appId}/public/data/schedules`), dataWithTimestamp1);
                        
                        // Create Day 2 entry (se preenchido)
                        if (data2) {
                            const dataWithTimestamp2 = {...data2, createdAt: serverTimestamp() };
                            await addDoc(collection(db, `artifacts/${appId}/public/data/schedules`), dataWithTimestamp2);
                        }
                        
                        // Create Day 3 entry (se preenchido)
                        if (data3) {
                            const dataWithTimestamp3 = {...data3, createdAt: serverTimestamp() };
                            await addDoc(collection(db, `artifacts/${appId}/public/data/schedules`), dataWithTimestamp3);
                        }
                        
                        // Log activity
                        await logActivity('editar', 'aula_grade', `${studentValue} - ${teacherValue}`, {
                            dias: [day1, day2, day3].filter(Boolean).join(', '),
                            tipo: scheduleType
                        });
                        
                        showSuccessMessage("Sucesso!", "Aula atualizada.");
                    }
                } else { 
                    // Create Day 1 entry
                    const dataWithTimestamp1 = {...data1, createdAt: serverTimestamp() };
                    await addDoc(collection(db, `artifacts/${appId}/public/data/schedules`), dataWithTimestamp1); 
                    
                    // Create Day 2 entry (se preenchido)
                    if (data2) {
                        const dataWithTimestamp2 = {...data2, createdAt: serverTimestamp() };
                        await addDoc(collection(db, `artifacts/${appId}/public/data/schedules`), dataWithTimestamp2);
                    }
                    
                    // Create Day 3 entry (se preenchido)
                    if (data3) {
                        const dataWithTimestamp3 = {...data3, createdAt: serverTimestamp() };
                        await addDoc(collection(db, `artifacts/${appId}/public/data/schedules`), dataWithTimestamp3);
                    }
                    
                    // Log activity
                    const daysCount = 1 + (data2 ? 1 : 0) + (data3 ? 1 : 0);
                    await logActivity('criar', 'aula_grade', `${studentValue} - ${teacherValue}`, {
                        dias: [day1, day2, day3].filter(Boolean).join(', '),
                        quantidadeDias: daysCount,
                        tipo: scheduleType
                    });
                    
                    showSuccessMessage("Sucesso!", `Aula${daysCount > 1 ? 's' : ''} adicionada${daysCount > 1 ? 's' : ''} (${daysCount} ${daysCount === 1 ? 'dia' : 'dias'}).`);
                }
                closeFormModal();
            } catch (error) { console.error("Error saving schedule:", error); showErrorMessage("Erro", "Falha ao salvar a aula."); }
        }

        function openExpenseForm(expenseId = null) {
            clearModalHeaderButtons();
            const expense = expenseId ? expenses.find(e => e.id === expenseId) : null;
            document.getElementById('form-modal-title').textContent = expense ? "Editar Despesa" : "Adicionar Nova Despesa";
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="expense-id" value="${expenseId || ''}">
                    <div><label class="font-medium text-sm">Descri√ß√£o</label><input type="text" id="expense-description" class="form-input" required value="${expense?.description || ''}"></div>
                    
                    <div>
                        <label class="font-medium text-sm">Tipo de Despesa</label>
                        <select id="expense-tipo" class="form-input" required>
                            <option value="variavel" ${!expense?.tipo || expense?.tipo === 'variavel' ? 'selected' : ''}>Vari√°vel</option>
                            <option value="fixo" ${expense?.tipo === 'fixo' ? 'selected' : ''}>Fixo</option>
                        </select>
                    </div>

                    <div id="due-date-container" class="${expense?.isFixedSalary ? 'hidden' : ''}">
                        <label class="font-medium text-sm">Vencimento</label>
                        <input type="date" id="expense-dueDate" class="form-input" value="${expense?.dueDate || ''}">
                    </div>

                    <div id="due-day-container" class="${expense?.isFixedSalary ? '' : 'hidden'}">
                        <label class="font-medium text-sm">Dia do Vencimento</label>
                        <input type="number" min="1" max="31" id="expense-dueDay" class="form-input" value="${expense?.dueDay || ''}">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="font-medium text-sm">Valor Base (R$)</label><input type="number" step="0.01" id="expense-amount" class="form-input" required value="${expense?.amount || ''}"></div>
                        <div><label class="font-medium text-sm">Valor Extra (R$)</label><input type="number" step="0.01" id="expense-extraAmount" class="form-input" value="${expense?.extraAmount || ''}"></div>
                        <div><label class="font-medium text-sm">Valor Pago (R$)</label><input type="number" step="0.01" id="expense-paidAmount" class="form-input" value="${expense?.paidAmount || ''}"></div>
                    </div>

                    <div id="parcelas-container" class="${expense?.tipo === 'fixo' || expense?.isFixedSalary ? 'hidden' : ''}">
                        <label class="font-medium text-sm">Quantidade de Parcelas</label>
                        <input type="number" min="1" max="60" id="expense-parcelas" class="form-input" placeholder="Ex: 12" value="${expense?.parcelas || ''}">
                    </div>

                    <div class="flex items-center gap-2"><input type="checkbox" id="expense-isFixedSalary" class="h-4 w-4 rounded" ${expense?.isFixedSalary ? 'checked' : ''}><label for="expense-isFixedSalary" class="text-sm">√â sal√°rio fixo?</label></div>
                    <div id="employee-role-container" class="${expense?.isFixedSalary ? '' : 'hidden'}"><label class="font-medium text-sm">Cargo</label><input type="text" id="expense-employeeRole" class="form-input" value="${expense?.employeeRole || ''}"></div>
                    <div class="pt-4 flex justify-end gap-2">${expenseId ? `<button type="button" class="danger-btn" data-action="delete-item" data-collection="expenses" data-id="${expenseId}">Apagar</button>` : ''}<button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;

            const isFixedSalaryCheckbox = document.getElementById('expense-isFixedSalary');
            const tipoSelect = document.getElementById('expense-tipo');
            
            const updateFieldVisibility = () => {
                const isChecked = isFixedSalaryCheckbox.checked;
                const isVariavel = tipoSelect.value === 'variavel';
                
                document.getElementById('employee-role-container').classList.toggle('hidden', !isChecked);
                document.getElementById('due-date-container').classList.toggle('hidden', isChecked);
                document.getElementById('due-day-container').classList.toggle('hidden', !isChecked);
                document.getElementById('parcelas-container').classList.toggle('hidden', !isVariavel || isChecked);
            };
            
            isFixedSalaryCheckbox.onchange = updateFieldVisibility;
            tipoSelect.onchange = updateFieldVisibility;

            document.getElementById('form-modal-content-area').onsubmit = saveExpense;
            document.getElementById('form-modal').classList.add('visible');
        }
        async function saveExpense(event) {
            event.preventDefault();
            const expenseId = document.getElementById('expense-id').value;
            const isFixedSalary = document.getElementById('expense-isFixedSalary').checked;
            const tipo = document.getElementById('expense-tipo').value;
            const data = {
                description: document.getElementById('expense-description').value,
                tipo: tipo,
                amount: document.getElementById('expense-amount').value,
                extraAmount: document.getElementById('expense-extraAmount').value || 0,
                paidAmount: document.getElementById('expense-paidAmount').value || 0,
                isPaid: false,
                isFixedSalary: isFixedSalary,
                employeeRole: isFixedSalary ? document.getElementById('expense-employeeRole').value : ''
            };

            if (isFixedSalary) {
                data.dueDay = document.getElementById('expense-dueDay').value;
                data.dueDate = null;
                data.parcelas = '';
            } else {
                data.dueDate = document.getElementById('expense-dueDate').value;
                data.dueDay = null;
                if (tipo === 'variavel') {
                    data.parcelas = document.getElementById('expense-parcelas').value || '';
                } else {
                    data.parcelas = '';
                }
            }

            if (!db) { console.warn("Offline mode."); closeFormModal(); return; }
            try {
                if (expenseId) {
                    const existingExpense = expenses.find(e => e.id === expenseId);
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/expenses`, expenseId), {...existingExpense, ...data});
                    showSuccessMessage("Sucesso!", "Despesa atualizada.");
                } else {
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, `artifacts/${appId}/public/data/expenses`), data);
                    showSuccessMessage("Sucesso!", "Nova despesa adicionada.");
                }
            } catch (error) { console.error("Error saving expense:", error); showErrorMessage("Erro", "Falha ao salvar despesa."); }
        }
        async function toggleExpensePaid(expenseId, isPaid) {
            const expense = expenses.find(e => e.id === expenseId);
            if (!expense) return;

            if (isPaid) {
                // Quando marcado como pago, abrir modal para inserir valor pago
                const totalExpenseValue = Number(expense.amount) + Number(expense.extraAmount || 0);
                clearModalHeaderButtons();
                const modalTitle = document.getElementById('form-modal-title');
                const modalContentArea = document.getElementById('form-modal-content-area');

                modalTitle.textContent = "Registrar Pagamento";
                modalContentArea.innerHTML = `
                    <form id="payment-form" class="space-y-4">
                        <p class="text-stone-600">Despesa: <strong>${expense.description}</strong></p>
                        <p class="text-stone-600">Valor Total: <strong>${totalExpenseValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</strong></p>
                        <div>
                            <label class="font-medium text-sm">Valor Pago (R$)</label>
                            <input type="number" step="0.01" id="paid-amount" class="form-input" placeholder="0,00" value="${totalExpenseValue}" required>
                        </div>
                        <div class="text-right">
                            <button type="button" class="secondary-btn mr-2" data-action="close-modal">Cancelar</button>
                            <button type="submit" class="primary-btn w-auto">Confirmar Pagamento</button>
                        </div>
                    </form>
                `;

                document.getElementById('form-modal').classList.add('visible');
                document.getElementById('payment-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const paidAmount = document.getElementById('paid-amount').value;
                    
                    if (!db) {
                        // Modo desenvolvimento - atualizar localmente
                        const expenseIndex = expenses.findIndex(e => e.id === expenseId);
                        if (expenseIndex !== -1) {
                            expenses[expenseIndex].isPaid = true;
                            expenses[expenseIndex].paidAmount = Number(paidAmount);
                        }
                        renderFolhaPagamentoSection();
                        document.getElementById('form-modal').classList.remove('visible');
                        return;
                    }

                    try {
                        const expenseRef = doc(db, `artifacts/${appId}/public/data/expenses`, expenseId);
                        await updateDoc(expenseRef, { 
                            isPaid: true,
                            paidAmount: Number(paidAmount),
                            paidAt: new Date().toISOString()
                        });
                        document.getElementById('form-modal').classList.remove('visible');
                        showSuccessMessage("Pagamento Registrado", "Valor pago registrado com sucesso!");
                    } catch (error) {
                        console.error("Error updating expense payment:", error);
                        showErrorMessage("Erro", "Erro ao registrar pagamento: " + error.message);
                    }
                });
            } else {
                // Quando desmarcado, remover pagamento
                if (!db) {
                    // Modo desenvolvimento - atualizar localmente
                    const expenseIndex = expenses.findIndex(e => e.id === expenseId);
                    if (expenseIndex !== -1) {
                        expenses[expenseIndex].isPaid = false;
                        delete expenses[expenseIndex].paidAmount;
                        delete expenses[expenseIndex].paidAt;
                    }
                    renderFolhaPagamentoSection();
                    return;
                }

                try {
                    const expenseRef = doc(db, `artifacts/${appId}/public/data/expenses`, expenseId);
                    await updateDoc(expenseRef, { 
                        isPaid: false,
                        paidAmount: 0,
                        paidAt: null
                    });
                } catch (error) {
                    console.error("Error updating expense status:", error);
                }
            }
        }

        function openCancelamentoForm(cancelamentoId = null) {
            clearModalHeaderButtons();
            const cancelamento = cancelamentoId ? cancellations.find(c => c.id === cancelamentoId) : null;
            const collaboratorOptions = collaborators.filter(c => c.sectors && c.sectors.includes('cancelamentos')).map(c => `<option value="${c.name}" ${cancelamento?.processedBy === c.name ? 'selected' : ''}>${c.name}</option>`).join('');

            let studentFieldHtml = '';
            if (cancelamentoId) {
                studentFieldHtml = `<div><label class="font-medium text-sm">Aluno</label><p class="form-input bg-stone-100">${cancelamento.studentName}</p></div>`;
            } else {
                const activeStudents = students.filter(s => s.status === 'Ativo');
                const studentOptions = activeStudents.map(s => `<option value="${s.id}" data-name="${s.name}">${s.name}</option>`).join('');
                studentFieldHtml = `<div><label class="font-medium text-sm">Aluno a Cancelar</label><select id="cancelamento-studentId" class="form-input" required><option value="">Selecione um aluno...</option>${studentOptions}</select></div>`;
            }

            document.getElementById('form-modal-title').textContent = cancelamento ? "Editar Cancelamento" : "Registrar Novo Cancelamento";
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="cancelamento-id" value="${cancelamentoId || ''}">
                    ${studentFieldHtml}
                    <div><label class="font-medium text-sm">Data do Cancelamento</label><input type="date" id="cancelamento-date" class="form-input" required value="${cancelamento?.cancellationDate || ''}"></div>
                    <div><label class="font-medium text-sm">Motivo</label><textarea id="cancelamento-reason" rows="3" class="form-input" required>${cancelamento?.reason || ''}</textarea></div>
                    <div><label class="font-medium text-sm">Processado por</label><select id="cancelamento-processedBy" class="form-input" required>${collaboratorOptions}</select></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>`;
            document.getElementById('form-modal-content-area').onsubmit = saveCancelamento;
            document.getElementById('form-modal').classList.add('visible');
        }
        async function saveCancelamento(event) {
            event.preventDefault();
            const cancelamentoId = document.getElementById('cancelamento-id').value;
            if (!db) { console.warn("Offline mode."); return; }

            try {
                if (cancelamentoId) {
                    // Logic to update an existing cancellation record
                    const data = {
                        cancellationDate: document.getElementById('cancelamento-date').value,
                        reason: document.getElementById('cancelamento-reason').value,
                        processedBy: document.getElementById('cancelamento-processedBy').value,
                    };
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/cancellations`, cancelamentoId), data);
                    showSuccessMessage("Sucesso!", "Registro de cancelamento atualizado.");
                } else {
                    // Logic to create a new cancellation and update student status
                    const studentSelect = document.getElementById('cancelamento-studentId');
                    if (!studentSelect.value) {
                        showErrorMessage("Erro", "Por favor, selecione um aluno.");
                        return;
                    }
                    const selectedOption = studentSelect.options[studentSelect.selectedIndex];
                    const studentId = selectedOption.value;
                    const studentName = selectedOption.getAttribute('data-name');

                    const data = {
                        studentId: studentId,
                        studentName: studentName,
                        cancellationDate: document.getElementById('cancelamento-date').value,
                        reason: document.getElementById('cancelamento-reason').value,
                        processedBy: document.getElementById('cancelamento-processedBy').value,
                        createdAt: serverTimestamp()
                    };

                    // 1. Add cancellation record
                    await addDoc(collection(db, `artifacts/${appId}/public/data/cancellations`), data);

                    // 2. Update student status
                    const studentRef = doc(db, `artifacts/${appId}/public/data/students`, studentId);
                    await updateDoc(studentRef, { status: 'Cancelado' });

                    showSuccessMessage("Sucesso!", `Cancelamento registrado e status do aluno ${studentName} atualizado.`);
                }
            } catch (error) {
                console.error("Error saving cancellation:", error);
                showErrorMessage("Erro", "Falha ao salvar o cancelamento.");
            }
        }
        function openCancelamentoModal(cancelamentoId) {
            clearModalHeaderButtons();
            const cancelamento = cancellations.find(c => c.id === cancelamentoId);
            if (!cancelamento) return;
            const canEdit = ['admin', 'financeiro'].includes(currentUserRole);
            document.getElementById('form-modal-title').textContent = `Cancelamento de ${cancelamento.studentName}`;
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-4">
                    <p><strong>Aluno:</strong> ${cancelamento.studentName}</p>
                    <p><strong>Data:</strong> ${formatDateBR(cancelamento.cancellationDate)}</p>
                    <p><strong>Processado por:</strong> ${cancelamento.processedBy}</p>
                    <div><strong>Motivo:</strong><p class="mt-1 p-3 bg-stone-50 rounded-md">${cancelamento.reason}</p></div>
                    <div class="border-t pt-4 flex justify-end gap-2">
                        ${canEdit ? `<button class="secondary-btn" data-action="edit-cancelamento" data-id="${cancelamento.id}">Editar</button>
                        <button class="danger-btn" data-action="delete-item" data-collection="cancellations" data-id="${cancelamento.id}">Apagar</button>` : ''}
                    </div>
                </div>`;
            document.getElementById('form-modal').classList.add('visible');
        }






        // Dojo Functions


        function openDojoCompetitorForm(competitorId = null) {
            clearModalHeaderButtons();
            const competitor = competitorId ? dojoRanking.find(c => c.id === competitorId) : null;
            document.getElementById('form-modal-title').textContent = competitor ? 'Editar Competidor' : 'Adicionar Competidor';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="dojo-id" value="${competitorId || ''}">
                    <div><label class="font-medium text-sm">Nome do Competidor</label><input type="text" id="dojo-name" class="form-input" required value="${competitor?.name || ''}"></div>
                    <div><label class="font-medium text-sm">URL da Foto</label><input type="url" id="dojo-photo" class="form-input" required value="${competitor?.photo || ''}"></div>
                    <div><label class="font-medium text-sm">Pontos</label><input type="number" id="dojo-points" class="form-input" required value="${competitor?.points || 0}"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar</button></div>
                </form>
            `;
            document.getElementById('form-modal-content-area').onsubmit = saveDojoCompetitor;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveDojoCompetitor(event) {
            event.preventDefault();
            const competitorId = document.getElementById('dojo-id').value;
            const data = {
                name: document.getElementById('dojo-name').value,
                photo: document.getElementById('dojo-photo').value,
                points: Number(document.getElementById('dojo-points').value)
            };
            if (!data.name || !data.photo) { showErrorMessage("Erro", "Nome e foto s√£o obrigat√≥rios."); return; }
            try {
                if (competitorId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/dojo_ranking`, competitorId), data);
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/dojo_ranking`), data);
                }
                document.getElementById('form-modal').classList.remove('visible');
                showSuccessMessage("Sucesso", "Competidor do Dojo salvo.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "N√£o foi poss√≠vel salvar o competidor."); }
        }

        function openDojoPointsForm(competitorId) {
            clearModalHeaderButtons();
            const competitor = dojoRanking.find(c => c.id === competitorId);
            if (!competitor) return;
            document.getElementById('form-modal-title').textContent = `Editar Pontos de ${competitor.name}`;
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <input type="hidden" id="dojo-id" value="${competitorId}">
                    <div><label class="font-medium text-sm">Pontos</label><input type="number" id="dojo-points" class="form-input" required value="${competitor.points || 0}"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar Pontos</button></div>
                </form>
            `;
            document.getElementById('form-modal-content-area').onsubmit = saveDojoPoints;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveDojoPoints(event) {
            event.preventDefault();
            const competitorId = document.getElementById('dojo-id').value;
            const points = Number(document.getElementById('dojo-points').value);
            const competitor = dojoRanking.find(c => c.id === competitorId);
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/dojo_ranking`, competitorId), { points });
                
                // Log activity
                if (competitor) {
                    await logActivity('editar', 'dojo', competitor.name, { points });
                }
                
                showSuccessMessage("Sucesso", "Pontua√ß√£o atualizada.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "N√£o foi poss√≠vel atualizar a pontua√ß√£o."); }
        }

        function openDojoMissionForm() {
            clearModalHeaderButtons();
            document.getElementById('form-modal-title').textContent = 'Adicionar Nova Miss√£o';
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="form-modal-body" class="space-y-4">
                    <div><label class="font-medium text-sm">Descri√ß√£o da Miss√£o</label><input type="text" id="mission-description" class="form-input" required></div>
                    <div><label class="font-medium text-sm">Pontos</label><input type="number" id="mission-points" class="form-input" required value="0"></div>
                    <div class="text-right"><button type="submit" class="primary-btn w-auto">Salvar Miss√£o</button></div>
                </form>
            `;
            document.getElementById('form-modal-content-area').onsubmit = saveDojoMission;
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveDojoMission(event) {
            event.preventDefault();
            const data = {
                description: document.getElementById('mission-description').value,
                points: Number(document.getElementById('mission-points').value)
            };
            if (!data.description) { showErrorMessage("Erro", "A descri√ß√£o √© obrigat√≥ria."); return; }
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/dojo_missions`), data);
                showSuccessMessage("Sucesso", "Nova miss√£o do Dojo adicionada.");
            } catch (e) { console.error(e); showErrorMessage("Erro", "N√£o foi poss√≠vel salvar a miss√£o."); }
        }


        // Fun√ß√£o para usu√°rio marcar task como feita (todos podem usar)
        async function toggleUserCompletion(taskId, isCompleted) {
            if (!db) return;
            const taskRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskId);
            try {
                await updateDoc(taskRef, { completedByUser: isCompleted });
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    await logActivity(isCompleted ? 'Marcou task como feita' : 'Desmarcou task como feita', 'task', task.title);
                }
            } catch (error) {
                console.error("Error updating user completion:", error);
            }
        }

        // Fun√ß√£o para admin aprovar task (s√≥ admin)
        async function toggleAdminApproval(taskId, isApproved) {
            if (!db) return;
            if (currentUserRole !== 'admin') {
                showErrorMessage('Erro', 'Apenas administradores podem aprovar tasks.');
                return;
            }
            const taskRef = doc(db, `artifacts/${appId}/public/data/tasks`, taskId);
            try {
                await updateDoc(taskRef, { 
                    approved: isApproved,
                    status: isApproved ? 'completed' : 'pending'
                });
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    await logActivity(isApproved ? 'Aprovou task' : 'Removeu aprova√ß√£o de task', 'task', task.title);
                }
            } catch (error) {
                console.error("Error updating admin approval:", error);
            }
        }

        async function deleteItem(collectionName, itemId) {
            if (!db) { console.warn("Offline mode."); return; }
            showConfirmationModal(
                "Confirmar Exclus√£o",
                "Tem certeza que deseja apagar este item? Esta a√ß√£o n√£o pode ser desfeita.",
                async () => {
                    try {
                        // Get item data before deleting for logging
                        let itemName = 'Desconhecido';
                        let logAction = 'deletar';
                        let logType = collectionName;
                        
                        if (collectionName === 'schedules') {
                            const schedule = schedules.find(s => s.id === itemId);
                            if (schedule) {
                                itemName = `${schedule.student} - ${schedule.teacher}`;
                                logType = 'aula_grade';
                            }
                        } else if (collectionName === 'students') {
                            const student = students.find(s => s.id === itemId);
                            if (student) itemName = student.name;
                        } else if (collectionName === 'turmas') {
                            const turma = turmas.find(t => t.id === itemId);
                            if (turma) itemName = turma.name;
                        } else if (collectionName === 'vips') {
                            const vip = vips.find(v => v.id === itemId);
                            if (vip) {
                                const student = students.find(s => s.id === vip.studentId);
                                itemName = student ? student.name : 'VIP';
                            }
                        }
                        
                        await deleteDoc(doc(db, `artifacts/${appId}/public/data/${collectionName}`, itemId));
                        
                        // Log activity
                        await logActivity(logAction, logType, itemName);
                        
                        showSuccessMessage("Sucesso", "Item apagado com sucesso.");
                        closeFormModal();
                    } catch (error) { 
                        console.error(`Error deleting item from ${collectionName}:`, error); 
                        showErrorMessage("Erro", "Falha ao apagar o item.");
                    }
                }
            );
        }

        // --- EXPORT FUNCTIONS ---
        function openHtmlInNewWindow(title, htmlContent) {
            const newWindow = window.open();
            newWindow.document.write(htmlContent);
            newWindow.document.title = title;
            newWindow.document.close();
        }



        function exportVipPef(vipId) {
            const vip = vips.find(v => v.id === vipId);
            const student = students.find(s => s.id === vip.studentId);
            const unitAttendance = attendance.find(a => a.id === vipId);
            if (!vip || !student) {
                showErrorMessage("Erro", "N√£o foi poss√≠vel encontrar os dados para exporta√ß√£o.");
                return;
            }

            const statusMap = { 'P': 'Presente', 'F': 'Falta', 'PP': 'Presen√ßa Parcial', '': 'N√£o Registrado' };
            let lessonsHtml = '';

            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance?.lessons?.[i] || {};
                const studentStatus = lessonData.students?.[student.id] || '';
                
                const statusBadgeClass = studentStatus === 'P' ? 'status-presente' : 
                                       studentStatus === 'F' ? 'status-falta' : 
                                       studentStatus === 'PP' ? 'status-parcial' : 'status-nao-registrado';
                const statusText = statusMap[studentStatus];

                lessonsHtml += `
                    <div class="lesson-card">
                        <div class="lesson-header">
                            <div class="lesson-number">Aula ${i}</div>
                            <div class="lesson-date">${lessonData.date ? formatDateBR(lessonData.date) : 'Data n√£o informada'}</div>
                        </div>
                        <div class="lesson-content">
                            <div class="topic-section">
                                <strong>Tema:</strong> ${lessonData.topic || 'N√£o informado'}
                            </div>
                            <div class="status-section">
                                <span class="status-badge ${statusBadgeClass}">${statusText}</span>
                            </div>
                            ${lessonData.notes ? `<div class="notes-section"><strong>Observa√ß√µes:</strong> ${lessonData.notes}</div>` : ''}
                        </div>
                    </div>
                `;
            }

            const docHtml = `
                <!DOCTYPE html>
                <html lang="pt-br">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>PEF - ${student.name}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { 
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                            line-height: 1.6; 
                            color: #333; 
                            background-color: #f8f9fa;
                        }
                        .container {
                            max-width: 800px;
                            margin: 0 auto;
                            background: white;
                            min-height: 100vh;
                        }
                        .header {
                            background: linear-gradient(135deg, #F1D24B 0%, #E8C547 100%);
                            color: #333;
                            padding: 2rem;
                            text-align: center;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        }
                        .header h1 {
                            font-size: 2rem;
                            font-weight: 700;
                            margin-bottom: 0.5rem;
                        }
                        .header p {
                            font-size: 1.1rem;
                            opacity: 0.8;
                        }
                        .info-card {
                            background: white;
                            margin: 2rem;
                            padding: 2rem;
                            border-radius: 12px;
                            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
                            border-left: 4px solid #F1D24B;
                        }
                        .info-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                            gap: 1rem;
                        }
                        .info-item {
                            padding: 0.5rem 0;
                        }
                        .info-item strong {
                            color: #2c3e50;
                            display: block;
                            margin-bottom: 0.25rem;
                            font-weight: 600;
                        }
                        .info-value {
                            color: #555;
                            font-size: 1.1rem;
                        }
                        .content {
                            padding: 0 2rem 2rem;
                        }
                        .lesson-card {
                            background: white;
                            border: 1px solid #e9ecef;
                            border-radius: 10px;
                            margin-bottom: 1rem;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                            transition: all 0.3s ease;
                        }
                        .lesson-card:hover {
                            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                            transform: translateY(-2px);
                        }
                        .lesson-header {
                            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                            padding: 1rem;
                            border-bottom: 1px solid #dee2e6;
                            border-radius: 10px 10px 0 0;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        }
                        .lesson-number {
                            font-weight: 700;
                            color: #495057;
                            font-size: 1.1rem;
                        }
                        .lesson-date {
                            color: #6c757d;
                            font-size: 0.95rem;
                        }
                        .lesson-content {
                            padding: 1rem;
                        }
                        .topic-section, .notes-section {
                            margin-bottom: 0.75rem;
                        }
                        .topic-section strong, .notes-section strong {
                            color: #2c3e50;
                            margin-right: 0.5rem;
                        }
                        .status-section {
                            margin-top: 1rem;
                        }
                        .status-badge {
                            display: inline-block;
                            padding: 0.4rem 1rem;
                            border-radius: 25px;
                            font-size: 0.85rem;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        .status-presente {
                            background-color: #d4edda;
                            color: #155724;
                            border: 1px solid #c3e6cb;
                        }
                        .status-falta {
                            background-color: #f8d7da;
                            color: #721c24;
                            border: 1px solid #f5c6cb;
                        }
                        .status-parcial {
                            background-color: #fff3cd;
                            color: #856404;
                            border: 1px solid #ffeaa7;
                        }
                        .status-nao-registrado {
                            background-color: #e2e3e5;
                            color: #383d41;
                            border: 1px solid #d6d8db;
                        }
                        .footer {
                            text-align: center;
                            padding: 2rem;
                            color: #6c757d;
                            border-top: 1px solid #e9ecef;
                            margin-top: 2rem;
                        }
                        @media print {
                            body { background-color: white; }
                            .lesson-card { break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>PEF - Relat√≥rio Individual</h1>
                            <p>Sistema de Presen√ßa e Frequ√™ncia</p>
                        </div>
                        
                        <div class="info-card">
                            <div class="info-grid">
                                <div class="info-item">
                                    <strong>Aluno</strong>
                                    <div class="info-value">${student.name}</div>
                                </div>
                                <div class="info-item">
                                    <strong>Professor</strong>
                                    <div class="info-value">${vip.teacherName}</div>
                                </div>
                                <div class="info-item">
                                    <strong>N√≠vel</strong>
                                    <div class="info-value">${vip.level}</div>
                                </div>
                                <div class="info-item">
                                    <strong>Modalidade</strong>
                                    <div class="info-value">VIP</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="content">
                            ${lessonsHtml}
                        </div>
                        
                        <div class="footer">
                            <p>Relat√≥rio gerado automaticamente pelo SLAP Hub</p>
                            <p>${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</p>
                        </div>
                    </div>
                </body>
                </html>
            `;

            openHtmlInNewWindow(`PEF - ${student.name}`, docHtml);
        }

        function exportTurmaPef(turmaId) {
            const turma = turmas.find(t => t.id === turmaId);
            if (!turma) { showErrorMessage("Erro", "Turma n√£o encontrada."); return; }

            const turmaStudents = (turma.studentIds || []).map(id => students.find(s => s.id === id)).filter(Boolean);
            const unitAttendance = attendance.find(a => a.id === turmaId);
            if (!turmaStudents.length) { showErrorMessage("Erro", "Nenhum aluno na turma para exportar."); return; }

            const statusMap = { 'P': 'Presente', 'F': 'Falta', 'PP': 'Presen√ßa Parcial', '': 'N√£o Registrado' };
            let lessonsHtml = '';

            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance?.lessons?.[i] || {};


                const attendanceItemsHtml = turmaStudents.map(s => {
                    const status = lessonData?.students?.[s.id] || '';
                    const statusClass = status === 'P' ? 'presente' : 
                                       status === 'F' ? 'falta' : 
                                       status === 'PP' ? 'parcial' : 'nao-registrado';
                    const statusText = statusMap[status];
                    const statusBadgeClass = status === 'P' ? 'status-presente' : 
                                           status === 'F' ? 'status-falta' : 
                                           status === 'PP' ? 'status-parcial' : 'status-nao-registrado';
                    
                    return `
                        <li class="attendance-item ${statusClass}">
                            <span class="student-name">${s.name}</span>
                            <span class="status-badge ${statusBadgeClass}">${statusText}</span>
                        </li>
                    `;
                }).join('');

                lessonsHtml += `
                    <div class="lesson-block">
                        <div class="lesson-header">Aula ${i}</div>
                        <div class="lesson-info">
                            <div class="lesson-detail">
                                <span class="lesson-detail-label">Data da Aula</span>
                                <span class="lesson-detail-value">${lessonData.date ? formatDateBR(lessonData.date) : 'N√£o definida'}</span>
                            </div>
                            <div class="lesson-detail">
                                <span class="lesson-detail-label">Status</span>
                                <span class="lesson-detail-value">${lessonData.date ? 'Realizada' : 'Pendente'}</span>
                            </div>
                        </div>
                        <div class="lesson-detail" style="margin-bottom: 15px;">
                            <span class="lesson-detail-label">Tema da Aula</span>
                            <span class="lesson-detail-value">${lessonData.topic || 'N√£o especificado'}</span>
                        </div>
                        <div class="lesson-detail" style="margin-bottom: 20px;">
                            <span class="lesson-detail-label">Observa√ß√µes</span>
                            <span class="lesson-detail-value">${lessonData.notes || 'Nenhuma observa√ß√£o registrada'}</span>
                        </div>
                        <div class="attendance-section">
                            <div class="attendance-title">
                                <div class="attendance-icon">‚úì</div>
                                Registro de Presen√ßa
                            </div>
                            <ul class="attendance-list">${attendanceItemsHtml}</ul>
                        </div>
                    </div>
                `;
            }

            const docHtml = `
                <!DOCTYPE html>
                <html lang="pt-br">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>PEF - ${turma.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        
                        body { 
                            font-family: 'DM Sans', Arial, sans-serif; 
                            line-height: 1.6; 
                            color: #2d3748; 
                            background: #f7fafc;
                            padding: 40px 20px;
                        }
                        
                        .container {
                            max-width: 1000px;
                            margin: 0 auto;
                            background: white;
                            border-radius: 12px;
                            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                            overflow: hidden;
                        }
                        
                        .header {
                            background: #F1D24B;
                            color: #1a202c;
                            padding: 40px;
                            text-align: center;
                            position: relative;
                        }
                        
                        .header::after {
                            content: '';
                            position: absolute;
                            bottom: -10px;
                            left: 0;
                            right: 0;
                            height: 20px;
                            background: #F1D24B;
                            clip-path: polygon(0 0, 100% 0, 95% 100%, 5% 100%);
                        }
                        
                        .logo-section {
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-bottom: 20px;
                        }
                        
                        .logo {
                            width: 60px;
                            height: 60px;
                            background: white;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-right: 15px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        }
                        
                        .logo-text {
                            font-size: 24px;
                            font-weight: 700;
                            color: #F1D24B;
                            letter-spacing: 1px;
                        }
                        
                        .school-name {
                            font-size: 2.5em;
                            font-weight: 700;
                            margin-bottom: 10px;
                            letter-spacing: -0.02em;
                        }
                        
                        .document-title {
                            font-size: 1.5em;
                            font-weight: 600;
                            opacity: 0.9;
                            letter-spacing: 0.05em;
                        }
                        
                        .content {
                            padding: 40px;
                        }
                        
                        .info-section {
                            background: #f8f9fa;
                            border-left: 4px solid #F1D24B;
                            padding: 25px;
                            margin-bottom: 30px;
                            border-radius: 8px;
                        }
                        
                        .info-section h2 {
                            color: #1a202c;
                            font-size: 1.4em;
                            margin-bottom: 15px;
                            font-weight: 600;
                        }
                        
                        .info-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                        }
                        
                        .info-item {
                            display: flex;
                            flex-direction: column;
                            gap: 5px;
                        }
                        
                        .info-label {
                            color: #4a5568;
                            font-weight: 500;
                            font-size: 0.9em;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        
                        .info-value {
                            color: #1a202c;
                            font-weight: 600;
                            font-size: 1.1em;
                        }
                        
                        .lessons-container {
                            margin-top: 30px;
                        }
                        
                        .lessons-title {
                            font-size: 1.8em;
                            font-weight: 700;
                            color: #1a202c;
                            margin-bottom: 25px;
                            text-align: center;
                            position: relative;
                        }
                        
                        .lessons-title::after {
                            content: '';
                            position: absolute;
                            bottom: -5px;
                            left: 50%;
                            transform: translateX(-50%);
                            width: 60px;
                            height: 3px;
                            background: #F1D24B;
                            border-radius: 2px;
                        }
                        
                        .lesson-block {
                            background: white;
                            border: 1px solid #e2e8f0;
                            border-radius: 12px;
                            padding: 25px;
                            margin-bottom: 20px;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                            transition: box-shadow 0.3s ease;
                        }
                        
                        .lesson-block:hover {
                            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
                        }
                        
                        .lesson-header {
                            background: #F1D24B;
                            color: #1a202c;
                            padding: 15px 20px;
                            border-radius: 8px;
                            margin: -10px -10px 20px -10px;
                            font-weight: 700;
                            font-size: 1.2em;
                        }
                        
                        .lesson-info {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                            margin-bottom: 20px;
                        }
                        
                        .lesson-detail {
                            display: flex;
                            flex-direction: column;
                            gap: 5px;
                        }
                        
                        .lesson-detail-label {
                            color: #4a5568;
                            font-weight: 500;
                            font-size: 0.9em;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        
                        .lesson-detail-value {
                            color: #1a202c;
                            font-weight: 600;
                            background: #f8f9fa;
                            padding: 8px 12px;
                            border-radius: 6px;
                            border-left: 3px solid #F1D24B;
                        }
                        
                        .attendance-section {
                            margin-top: 20px;
                        }
                        
                        .attendance-title {
                            color: #1a202c;
                            font-weight: 600;
                            margin-bottom: 15px;
                            font-size: 1.1em;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                        }
                        
                        .attendance-icon {
                            width: 20px;
                            height: 20px;
                            background: #F1D24B;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: #1a202c;
                            font-weight: 700;
                            font-size: 0.8em;
                        }
                        
                        .attendance-list {
                            list-style: none;
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                            gap: 10px;
                            padding: 0;
                        }
                        
                        .attendance-item {
                            background: #f8f9fa;
                            padding: 12px 16px;
                            border-radius: 8px;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            border-left: 3px solid transparent;
                        }
                        
                        .attendance-item.presente {
                            border-left-color: #38a169;
                            background: #f0fff4;
                        }
                        
                        .attendance-item.falta {
                            border-left-color: #e53e3e;
                            background: #fff5f5;
                        }
                        
                        .attendance-item.parcial {
                            border-left-color: #dd6b20;
                            background: #fffaf0;
                        }
                        
                        .attendance-item.nao-registrado {
                            border-left-color: #a0aec0;
                            background: #f7fafc;
                        }
                        
                        .student-name {
                            font-weight: 600;
                            color: #1a202c;
                        }
                        
                        .status-badge {
                            padding: 4px 12px;
                            border-radius: 20px;
                            font-size: 0.8em;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        
                        .status-presente {
                            background: #c6f6d5;
                            color: #22543d;
                        }
                        
                        .status-falta {
                            background: #fed7d7;
                            color: #742a2a;
                        }
                        
                        .status-parcial {
                            background: #feebc8;
                            color: #7b341e;
                        }
                        
                        .status-nao-registrado {
                            background: #e2e8f0;
                            color: #2d3748;
                        }
                        
                        .footer {
                            background: #1a202c;
                            color: white;
                            text-align: center;
                            padding: 25px;
                            margin-top: 40px;
                        }
                        
                        .footer-title {
                            font-size: 1.2em;
                            font-weight: 600;
                            margin-bottom: 5px;
                        }
                        
                        .footer-date {
                            color: #a0aec0;
                            font-size: 0.9em;
                        }
                        
                        .print-btn {
                            background: #F1D24B;
                            color: #1a202c;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            font-size: 1em;
                            margin: 20px auto;
                            display: block;
                            transition: all 0.3s ease;
                        }
                        
                        .print-btn:hover {
                            background: #eab308;
                            transform: translateY(-2px);
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                        }
                        
                        @media print {
                            body { background: white; padding: 0; }
                            .container { box-shadow: none; }
                            .print-btn { display: none; }
                        }
                        
                        @media (max-width: 768px) {
                            .info-grid { grid-template-columns: 1fr; }
                            .lesson-info { grid-template-columns: 1fr; }
                            .attendance-list { grid-template-columns: 1fr; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <div class="logo-section">
                                <div class="logo">
                                    <div class="logo-text">S</div>
                                </div>
                                <div class="school-info">
                                    <div class="school-name">SLAP</div>
                                </div>
                            </div>
                            <div class="document-title">Relat√≥rio de Presen√ßa e Frequ√™ncia (PEF)</div>
                        </div>
                        
                        <div class="content">
                            <div class="info-section">
                                <h2>Informa√ß√µes da Turma</h2>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <span class="info-label">Turma</span>
                                        <span class="info-value">${turma.name}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Professor</span>
                                        <span class="info-value">${turma.teacherName || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">N√≠vel</span>
                                        <span class="info-value">${turma.level || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Semestre</span>
                                        <span class="info-value">${turma.semestre || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Data do Relat√≥rio</span>
                                        <span class="info-value">${new Date().toLocaleDateString('pt-BR')}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Total de Alunos</span>
                                        <span class="info-value">${turmaStudents.length}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="lessons-container">
                                <h2 class="lessons-title">Registro de Aulas</h2>
                                ${lessonsHtml}
                            </div>
                            
                            <button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir Relat√≥rio</button>
                        </div>
                        
                        <div class="footer">
                            <div class="footer-title">SLAP English School</div>
                            <div class="footer-date">Relat√≥rio gerado em ${new Date().toLocaleString('pt-BR')}</div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            openHtmlInNewWindow(`PEF - Turma ${turma.name}`, docHtml);
        }

        function exportStudentPef(turmaId, studentId) {
            const turma = turmas.find(t => t.id === turmaId);
            const student = students.find(s => s.id === studentId);
            if (!turma || !student) { 
                showErrorMessage("Erro", "Turma ou aluno n√£o encontrado."); 
                return; 
            }

            const unitAttendance = attendance.find(a => a.id === turmaId);
            const statusMap = { 'P': 'Presente', 'F': 'Falta', 'PP': 'Presen√ßa Parcial', '': 'N√£o Registrado' };
            
            let lessonsHtml = '';
            let totalLessons = 0;
            let presentLessons = 0;
            let partialLessons = 0;
            let absentLessons = 0;

            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance?.lessons?.[i] || {};
                const studentStatus = lessonData?.students?.[studentId] || '';
                
                // Contar presen√ßas apenas se a aula foi realizada
                if (lessonData.date) {
                    totalLessons++;
                    if (studentStatus === 'P') presentLessons++;
                    else if (studentStatus === 'PP') partialLessons++;
                    else if (studentStatus === 'F') absentLessons++;
                }

                const statusClass = studentStatus === 'P' ? 'presente' : 
                                   studentStatus === 'F' ? 'falta' : 
                                   studentStatus === 'PP' ? 'parcial' : 'nao-registrado';
                const statusText = statusMap[studentStatus];
                const statusBadgeClass = studentStatus === 'P' ? 'status-presente' : 
                                       studentStatus === 'F' ? 'status-falta' : 
                                       studentStatus === 'PP' ? 'status-parcial' : 'status-nao-registrado';

                lessonsHtml += `
                    <div class="lesson-block">
                        <div class="lesson-header">Aula ${i}</div>
                        <div class="lesson-info">
                            <div class="lesson-detail">
                                <span class="lesson-detail-label">Data da Aula</span>
                                <span class="lesson-detail-value">${lessonData.date ? formatDateBR(lessonData.date) : 'N√£o realizada'}</span>
                            </div>
                            <div class="lesson-detail">
                                <span class="lesson-detail-label">Status do Aluno</span>
                                <span class="lesson-detail-value">
                                    <span class="status-badge ${statusBadgeClass}">${statusText}</span>
                                </span>
                            </div>
                        </div>
                        <div class="lesson-detail" style="margin-bottom: 15px;">
                            <span class="lesson-detail-label">Tema da Aula</span>
                            <span class="lesson-detail-value">${lessonData.topic || 'N√£o especificado'}</span>
                        </div>
                        <div class="lesson-detail">
                            <span class="lesson-detail-label">Observa√ß√µes da Aula</span>
                            <span class="lesson-detail-value">${lessonData.notes || 'Nenhuma observa√ß√£o registrada'}</span>
                        </div>
                    </div>
                `;
            }

            const attendancePercentage = totalLessons > 0 ? ((presentLessons + partialLessons * 0.5) / totalLessons * 100).toFixed(1) : 0;

            const docHtml = `
                <!DOCTYPE html>
                <html lang="pt-br">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>PEF Individual - ${student.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        
                        body { 
                            font-family: 'DM Sans', Arial, sans-serif; 
                            line-height: 1.6; 
                            color: #2d3748; 
                            background: #f7fafc;
                            padding: 40px 20px;
                        }
                        
                        .container {
                            max-width: 1000px;
                            margin: 0 auto;
                            background: white;
                            border-radius: 12px;
                            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                            overflow: hidden;
                        }
                        
                        .header {
                            background: #F1D24B;
                            color: #1a202c;
                            padding: 40px;
                            text-align: center;
                            position: relative;
                        }
                        
                        .header::after {
                            content: '';
                            position: absolute;
                            bottom: -10px;
                            left: 0;
                            right: 0;
                            height: 20px;
                            background: #F1D24B;
                            clip-path: polygon(0 0, 100% 0, 95% 100%, 5% 100%);
                        }
                        
                        .logo-section {
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-bottom: 20px;
                        }
                        
                        .logo {
                            width: 60px;
                            height: 60px;
                            background: white;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin-right: 15px;
                            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        }
                        
                        .logo-text {
                            font-size: 24px;
                            font-weight: 700;
                            color: #F1D24B;
                            letter-spacing: 1px;
                        }
                        
                        .school-name {
                            font-size: 2.5em;
                            font-weight: 700;
                            margin-bottom: 10px;
                            letter-spacing: -0.02em;
                        }
                        
                        .document-title {
                            font-size: 1.5em;
                            font-weight: 600;
                            opacity: 0.9;
                            letter-spacing: 0.05em;
                        }
                        
                        .student-title {
                            font-size: 1.8em;
                            font-weight: 700;
                            margin-top: 15px;
                            color: #1a202c;
                        }
                        
                        .content {
                            padding: 40px;
                        }
                        
                        .info-section {
                            background: #f8f9fa;
                            border-left: 4px solid #F1D24B;
                            padding: 25px;
                            margin-bottom: 30px;
                            border-radius: 8px;
                        }
                        
                        .info-section h2 {
                            color: #1a202c;
                            font-size: 1.4em;
                            margin-bottom: 15px;
                            font-weight: 600;
                        }
                        
                        .info-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                        }
                        
                        .info-item {
                            display: flex;
                            flex-direction: column;
                            gap: 5px;
                        }
                        
                        .info-label {
                            color: #4a5568;
                            font-weight: 500;
                            font-size: 0.9em;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        
                        .info-value {
                            color: #1a202c;
                            font-weight: 600;
                            font-size: 1.1em;
                        }
                        
                        .attendance-summary {
                            background: #e6fffa;
                            border-left: 4px solid #38a169;
                            padding: 25px;
                            margin-bottom: 30px;
                            border-radius: 8px;
                        }
                        
                        .attendance-summary h2 {
                            color: #1a202c;
                            font-size: 1.4em;
                            margin-bottom: 15px;
                            font-weight: 600;
                        }
                        
                        .attendance-stats {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                            gap: 15px;
                        }
                        
                        .stat-item {
                            text-align: center;
                            background: white;
                            padding: 15px;
                            border-radius: 8px;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                        }
                        
                        .stat-number {
                            font-size: 2em;
                            font-weight: 700;
                            display: block;
                        }
                        
                        .stat-number.presente { color: #38a169; }
                        .stat-number.parcial { color: #dd6b20; }
                        .stat-number.falta { color: #e53e3e; }
                        .stat-number.percentage { color: #1a202c; }
                        
                        .stat-label {
                            color: #4a5568;
                            font-size: 0.9em;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            margin-top: 5px;
                        }
                        
                        .lessons-container {
                            margin-top: 30px;
                        }
                        
                        .lessons-title {
                            font-size: 1.8em;
                            font-weight: 700;
                            color: #1a202c;
                            margin-bottom: 25px;
                            text-align: center;
                            position: relative;
                        }
                        
                        .lessons-title::after {
                            content: '';
                            position: absolute;
                            bottom: -5px;
                            left: 50%;
                            transform: translateX(-50%);
                            width: 60px;
                            height: 3px;
                            background: #F1D24B;
                            border-radius: 2px;
                        }
                        
                        .lesson-block {
                            background: white;
                            border: 1px solid #e2e8f0;
                            border-radius: 12px;
                            padding: 25px;
                            margin-bottom: 20px;
                            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                            transition: box-shadow 0.3s ease;
                        }
                        
                        .lesson-block:hover {
                            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
                        }
                        
                        .lesson-header {
                            background: #F1D24B;
                            color: #1a202c;
                            padding: 15px 20px;
                            border-radius: 8px;
                            margin: -10px -10px 20px -10px;
                            font-weight: 700;
                            font-size: 1.2em;
                        }
                        
                        .lesson-info {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                            margin-bottom: 20px;
                        }
                        
                        .lesson-detail {
                            display: flex;
                            flex-direction: column;
                            gap: 5px;
                        }
                        
                        .lesson-detail-label {
                            color: #4a5568;
                            font-weight: 500;
                            font-size: 0.9em;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        
                        .lesson-detail-value {
                            color: #1a202c;
                            font-weight: 600;
                            background: #f8f9fa;
                            padding: 8px 12px;
                            border-radius: 6px;
                            border-left: 3px solid #F1D24B;
                        }
                        
                        .status-badge {
                            padding: 4px 12px;
                            border-radius: 20px;
                            font-size: 0.8em;
                            font-weight: 600;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                            display: inline-block;
                        }
                        
                        .status-presente {
                            background: #c6f6d5;
                            color: #22543d;
                        }
                        
                        .status-falta {
                            background: #fed7d7;
                            color: #742a2a;
                        }
                        
                        .status-parcial {
                            background: #feebc8;
                            color: #7b341e;
                        }
                        
                        .status-nao-registrado {
                            background: #e2e8f0;
                            color: #2d3748;
                        }
                        
                        .footer {
                            background: #1a202c;
                            color: white;
                            text-align: center;
                            padding: 25px;
                            margin-top: 40px;
                        }
                        
                        .footer-title {
                            font-size: 1.2em;
                            font-weight: 600;
                            margin-bottom: 5px;
                        }
                        
                        .footer-date {
                            color: #a0aec0;
                            font-size: 0.9em;
                        }
                        
                        .print-btn {
                            background: #F1D24B;
                            color: #1a202c;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            font-size: 1em;
                            margin: 20px auto;
                            display: block;
                            transition: all 0.3s ease;
                        }
                        
                        .print-btn:hover {
                            background: #eab308;
                            transform: translateY(-2px);
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                        }
                        
                        @media print {
                            body { background: white; padding: 0; }
                            .container { box-shadow: none; }
                            .print-btn { display: none; }
                        }
                        
                        @media (max-width: 768px) {
                            .info-grid { grid-template-columns: 1fr; }
                            .lesson-info { grid-template-columns: 1fr; }
                            .attendance-stats { grid-template-columns: repeat(2, 1fr); }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <div class="logo-section">
                                <div class="logo">
                                    <div class="logo-text">S</div>
                                </div>
                                <div class="school-info">
                                    <div class="school-name">SLAP</div>
                                </div>
                            </div>
                            <div class="document-title">Relat√≥rio de Presen√ßa e Frequ√™ncia (PEF)</div>
                            <div class="student-title">${student.name}</div>
                        </div>
                        
                        <div class="content">
                            <div class="info-section">
                                <h2>Informa√ß√µes do Aluno</h2>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <span class="info-label">Nome do Aluno</span>
                                        <span class="info-value">${student.name}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Turma</span>
                                        <span class="info-value">${turma.name}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Professor</span>
                                        <span class="info-value">${turma.teacherName || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">N√≠vel</span>
                                        <span class="info-value">${turma.level || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Modalidade</span>
                                        <span class="info-value">${student.modalidade || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Data do Relat√≥rio</span>
                                        <span class="info-value">${new Date().toLocaleDateString('pt-BR')}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="attendance-summary">
                                <h2>Resumo de Frequ√™ncia</h2>
                                <div class="attendance-stats">
                                    <div class="stat-item">
                                        <span class="stat-number presente">${presentLessons}</span>
                                        <span class="stat-label">Presen√ßas</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-number parcial">${partialLessons}</span>
                                        <span class="stat-label">Presen√ßas Parciais</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-number falta">${absentLessons}</span>
                                        <span class="stat-label">Faltas</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-number percentage">${attendancePercentage}%</span>
                                        <span class="stat-label">Taxa de Frequ√™ncia</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="lessons-container">
                                <h2 class="lessons-title">Registro Detalhado de Aulas</h2>
                                ${lessonsHtml}
                            </div>
                            
                            <button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir Relat√≥rio Individual</button>
                        </div>
                        
                        <div class="footer">
                            <div class="footer-title">SLAP English School</div>
                            <div class="footer-date">Relat√≥rio individual gerado em ${new Date().toLocaleString('pt-BR')}</div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            openHtmlInNewWindow(`PEF Individual - ${student.name}`, docHtml);
        }

        function exportTasksPdf(personId) {
            const person = taskPeople.find(p => p.id === personId);
            if (!person) {
                showErrorMessage("Erro", "Colaborador n√£o encontrado.");
                return;
            }

            const personTasks = tasks.filter(t => t.personId === personId);
            
            // Separate pending and completed tasks
            const pendingTasks = personTasks.filter(t => t.status === 'pending');
            const completedTasks = personTasks.filter(t => t.status === 'completed');
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Function to render task card
            const renderTaskCard = (task) => {
                const dueDate = new Date(task.dueDate + 'T00:00:00');
                dueDate.setHours(0, 0, 0, 0);
                const isOverdue = task.status === 'pending' && dueDate < today;
                const isToday = dueDate.getTime() === today.getTime();

                if (task.type === 'checklist' && task.checklistItems) {
                    const completedCount = task.checklistItems.filter(item => item.completed).length;
                    const totalCount = task.checklistItems.length;
                    const allCompleted = completedCount === totalCount;

                    const checklistItemsHtml = task.checklistItems.map(item => {
                        const itemDate = new Date(item.dueDate + 'T00:00:00');
                        itemDate.setHours(0, 0, 0, 0);
                        const itemOverdue = !item.completed && itemDate < today;
                        const itemToday = itemDate.getTime() === today.getTime();

                        return `
                            <div class="checklist-item ${item.completed ? 'completed' : itemOverdue ? 'overdue' : itemToday ? 'today' : ''}">
                                <div class="checklist-checkbox">${item.completed ? '‚úì' : '‚òê'}</div>
                                <div class="checklist-item-content">
                                    <div class="checklist-item-title ${item.completed ? 'line-through' : ''}">${item.title}</div>
                                    <div class="checklist-item-date">
                                        üìÖ ${formatDateBR(item.dueDate)}
                                        ${itemOverdue && !item.completed ? '<span class="badge-overdue">ATRASADO</span>' : ''}
                                        ${itemToday && !item.completed ? '<span class="badge-today">HOJE</span>' : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    return `
                        <div class="task-card ${allCompleted ? 'completed-task' : isOverdue ? 'overdue-task' : isToday ? 'today-task' : ''}">
                            <div class="task-header">
                                <div>
                                    <span class="task-type-badge checklist-badge">CHECKLIST</span>
                                    <h3 class="task-title ${allCompleted ? 'line-through' : ''}">${task.title}</h3>
                                </div>
                                <div class="task-progress">${completedCount}/${totalCount}</div>
                            </div>
                            ${task.description ? `<p class="task-description">${task.description}</p>` : ''}
                            ${task.link ? `<div class="task-link">üîó <a href="${task.link}" target="_blank">${task.link}</a></div>` : ''}
                            <div class="task-meta">
                                <span>üìÖ Prazo Geral: ${formatDateBR(task.dueDate)}</span>
                                ${isOverdue && !allCompleted ? '<span class="badge-overdue">ATRASADA</span>' : ''}
                                ${isToday && !allCompleted ? '<span class="badge-today">HOJE</span>' : ''}
                            </div>
                            <div class="checklist-items">
                                ${checklistItemsHtml}
                            </div>
                        </div>
                    `;
                } else {
                    // Normal task
                    return `
                        <div class="task-card ${task.status === 'completed' ? 'completed-task' : isOverdue ? 'overdue-task' : isToday ? 'today-task' : ''}">
                            <div class="task-header">
                                <div>
                                    <span class="task-type-badge normal-badge">TASK</span>
                                    <h3 class="task-title ${task.status === 'completed' ? 'line-through' : ''}">${task.title}</h3>
                                </div>
                                ${task.status === 'completed' ? '<span class="completion-mark">‚úì</span>' : ''}
                            </div>
                            ${task.description ? `<p class="task-description">${task.description}</p>` : ''}
                            ${task.link ? `<div class="task-link">üîó <a href="${task.link}" target="_blank">${task.link}</a></div>` : ''}
                            <div class="task-meta">
                                <span>üìÖ ${formatDateBR(task.dueDate)}</span>
                                ${isOverdue && task.status === 'pending' ? '<span class="badge-overdue">ATRASADA</span>' : ''}
                                ${isToday && task.status === 'pending' ? '<span class="badge-today">HOJE</span>' : ''}
                            </div>
                        </div>
                    `;
                }
            };

            const pendingTasksHtml = pendingTasks.length > 0 
                ? pendingTasks.map(renderTaskCard).join('') 
                : '<p class="no-tasks">Nenhuma task pendente.</p>';

            const completedTasksHtml = completedTasks.length > 0 
                ? completedTasks.map(renderTaskCard).join('') 
                : '<p class="no-tasks">Nenhuma task conclu√≠da.</p>';

            const docHtml = `
                <!DOCTYPE html>
                <html lang="pt-br">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Tasks - ${person.name}</title>
                    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        
                        body { 
                            font-family: 'DM Sans', Arial, sans-serif; 
                            line-height: 1.6; 
                            color: #2d3748; 
                            background: #f7fafc;
                            padding: 40px 20px;
                        }
                        
                        .container {
                            max-width: 1000px;
                            margin: 0 auto;
                            background: white;
                            border-radius: 12px;
                            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                            overflow: hidden;
                        }
                        
                        .header {
                            background: #F1D24B;
                            color: #1a202c;
                            padding: 40px;
                            text-align: center;
                        }
                        
                        .school-name {
                            font-size: 2.5em;
                            font-weight: 700;
                            margin-bottom: 10px;
                        }
                        
                        .document-title {
                            font-size: 1.5em;
                            font-weight: 600;
                            opacity: 0.9;
                        }
                        
                        .person-name {
                            font-size: 1.8em;
                            font-weight: 700;
                            margin-top: 15px;
                        }
                        
                        .person-role {
                            font-size: 1.1em;
                            opacity: 0.8;
                            text-transform: uppercase;
                            letter-spacing: 0.05em;
                        }
                        
                        .content {
                            padding: 40px;
                        }
                        
                        .stats-section {
                            background: #f8f9fa;
                            border-left: 4px solid #F1D24B;
                            padding: 25px;
                            margin-bottom: 30px;
                            border-radius: 8px;
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                            gap: 20px;
                        }
                        
                        .stat-item {
                            text-align: center;
                        }
                        
                        .stat-number {
                            display: block;
                            font-size: 2.5em;
                            font-weight: 700;
                            color: #F1D24B;
                        }
                        
                        .stat-label {
                            display: block;
                            font-size: 0.9em;
                            color: #6c757d;
                            margin-top: 5px;
                        }
                        
                        .section-title {
                            font-size: 1.8em;
                            font-weight: 700;
                            margin: 30px 0 20px;
                            color: #1a202c;
                            border-bottom: 3px solid #F1D24B;
                            padding-bottom: 10px;
                        }
                        
                        .task-card {
                            background: white;
                            border: 2px solid #e9ecef;
                            border-radius: 10px;
                            padding: 20px;
                            margin-bottom: 20px;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                            break-inside: avoid;
                        }
                        
                        .task-card.overdue-task {
                            background: #fff5f5;
                            border-color: #feb2b2;
                        }
                        
                        .task-card.today-task {
                            background: #fefce8;
                            border-color: #fde047;
                        }
                        
                        .task-card.completed-task {
                            background: #f5f5f4;
                            border-color: #e7e5e4;
                            opacity: 0.8;
                        }
                        
                        .task-header {
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                            margin-bottom: 15px;
                        }
                        
                        .task-type-badge {
                            display: inline-block;
                            padding: 4px 10px;
                            border-radius: 4px;
                            font-size: 0.75em;
                            font-weight: 700;
                            margin-right: 10px;
                            color: white;
                        }
                        
                        .normal-badge {
                            background: #F1D24B;
                            color: #1a202c;
                        }
                        
                        .checklist-badge {
                            background: #8671D1;
                        }
                        
                        .task-title {
                            display: inline;
                            font-size: 1.3em;
                            font-weight: 600;
                            color: #1a202c;
                        }
                        
                        .line-through {
                            text-decoration: line-through;
                            opacity: 0.6;
                        }
                        
                        .task-progress {
                            font-size: 1.2em;
                            font-weight: 700;
                            color: #8671D1;
                        }
                        
                        .completion-mark {
                            font-size: 1.5em;
                            color: #10b981;
                        }
                        
                        .task-description {
                            color: #6c757d;
                            margin: 10px 0;
                            line-height: 1.6;
                        }
                        
                        .task-link {
                            color: #2563eb;
                            margin: 10px 0;
                            font-size: 0.9em;
                        }
                        
                        .task-link a {
                            color: #2563eb;
                            text-decoration: none;
                            word-break: break-all;
                        }
                        
                        .task-meta {
                            display: flex;
                            gap: 15px;
                            align-items: center;
                            margin-top: 15px;
                            font-size: 0.9em;
                            color: #6c757d;
                        }
                        
                        .badge-overdue {
                            background: #ef4444;
                            color: white;
                            padding: 2px 8px;
                            border-radius: 4px;
                            font-size: 0.85em;
                            font-weight: 700;
                        }
                        
                        .badge-today {
                            background: #eab308;
                            color: #1a202c;
                            padding: 2px 8px;
                            border-radius: 4px;
                            font-size: 0.85em;
                            font-weight: 700;
                        }
                        
                        .checklist-items {
                            margin-top: 20px;
                            border-top: 2px solid #e9ecef;
                            padding-top: 15px;
                        }
                        
                        .checklist-item {
                            display: flex;
                            gap: 10px;
                            padding: 10px;
                            margin-bottom: 10px;
                            border-radius: 6px;
                            background: white;
                        }
                        
                        .checklist-item.completed {
                            background: #d1fae5;
                        }
                        
                        .checklist-item.overdue {
                            background: #fee2e2;
                        }
                        
                        .checklist-item.today {
                            background: #fef9c3;
                        }
                        
                        .checklist-checkbox {
                            font-size: 1.3em;
                            color: #8671D1;
                        }
                        
                        .checklist-item-content {
                            flex: 1;
                        }
                        
                        .checklist-item-title {
                            font-weight: 500;
                            margin-bottom: 5px;
                        }
                        
                        .checklist-item-date {
                            font-size: 0.85em;
                            color: #6c757d;
                        }
                        
                        .no-tasks {
                            text-align: center;
                            padding: 40px;
                            color: #6c757d;
                            font-style: italic;
                        }
                        
                        .print-btn {
                            background: #F1D24B;
                            color: #1a202c;
                            border: none;
                            padding: 15px 40px;
                            font-size: 1.1em;
                            font-weight: 700;
                            border-radius: 8px;
                            cursor: pointer;
                            display: block;
                            margin: 40px auto 20px;
                            box-shadow: 0 4px 12px rgba(241, 210, 75, 0.3);
                        }
                        
                        .print-btn:hover {
                            background: #E0C03D;
                            transform: translateY(-2px);
                            box-shadow: 0 6px 16px rgba(241, 210, 75, 0.4);
                        }
                        
                        .footer {
                            background: #f8f9fa;
                            padding: 20px;
                            text-align: center;
                            border-top: 3px solid #F1D24B;
                        }
                        
                        .footer-title {
                            font-weight: 700;
                            font-size: 1.2em;
                            color: #1a202c;
                        }
                        
                        .footer-date {
                            color: #6c757d;
                            margin-top: 5px;
                            font-size: 0.9em;
                        }
                        
                        @media print {
                            body { 
                                background: white; 
                                padding: 0; 
                            }
                            .container {
                                box-shadow: none;
                            }
                            .print-btn {
                                display: none;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <div class="school-name">SLAP</div>
                            <div class="document-title">RELAT√ìRIO DE TASKS</div>
                            <div class="person-name">${person.name}</div>
                            ${person.role ? `<div class="person-role">${person.role}</div>` : ''}
                        </div>
                        
                        <div class="content">
                            <div class="stats-section">
                                <div class="stat-item">
                                    <span class="stat-number">${personTasks.length}</span>
                                    <span class="stat-label">Total de Tasks</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number" style="color: #ef4444;">${pendingTasks.length}</span>
                                    <span class="stat-label">Pendentes</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number" style="color: #10b981;">${completedTasks.length}</span>
                                    <span class="stat-label">Conclu√≠das</span>
                                </div>
                            </div>
                            
                            <h2 class="section-title">üìã Tasks Pendentes</h2>
                            ${pendingTasksHtml}
                            
                            <h2 class="section-title">‚úÖ Tasks Conclu√≠das</h2>
                            ${completedTasksHtml}
                            
                            <button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir Relat√≥rio</button>
                        </div>
                        
                        <div class="footer">
                            <div class="footer-title">SLAP English School</div>
                            <div class="footer-date">Relat√≥rio gerado em ${new Date().toLocaleString('pt-BR')}</div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            openHtmlInNewWindow(`Tasks - ${person.name}`, docHtml);
        }


        // --- Debug Functions ---
        function debugSyncStatus() {
            if (currentUserRole !== 'admin') return;

            const syncInfo = {
                isDevelopmentMode: window.isDevelopmentMode,
                hasFirebase: !!db,
                currentUser: currentUserName,
                currentRole: currentUserRole,
                timestamp: new Date().toISOString()
            };

            document.getElementById('form-modal-title').textContent = 'Debug: Status de Sincroniza√ß√£o';
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-semibold text-blue-800 mb-2">Modo de Execu√ß√£o</h4>
                            <div class="text-sm">
                                <div class="flex justify-between">
                                    <span>Modo:</span>
                                    <span class="font-medium ${window.isDevelopmentMode ? 'text-orange-600' : 'text-green-600'}">
                                        ${window.isDevelopmentMode ? 'Desenvolvimento (Local)' : 'Produ√ß√£o (Firebase)'}
                                    </span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Firebase:</span>
                                    <span class="font-medium ${db ? 'text-green-600' : 'text-red-600'}">
                                        ${db ? 'Conectado' : 'Desconectado'}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-semibold text-green-800 mb-2">Usu√°rio Atual</h4>
                            <div class="text-sm">
                                <div class="flex justify-between">
                                    <span>Nome:</span>
                                    <span class="font-medium">${currentUserName}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Papel:</span>
                                    <span class="font-medium">${currentUserRole}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <h5 class="font-medium text-yellow-800 mb-2">Diagn√≥stico:</h5>
                        <div class="text-sm text-yellow-700 space-y-1">
                            ${window.isDevelopmentMode ? 
                                '<p>‚ö†Ô∏è <strong>Modo Desenvolvimento:</strong> Mudan√ßas s√£o salvas apenas localmente (localStorage). Para testar sincroniza√ß√£o, use o modo produ√ß√£o com Firebase.</p>' :
                                '<p>‚úÖ <strong>Modo Produ√ß√£o:</strong> Mudan√ßas s√£o compartilhadas entre todos os usu√°rios via Firebase em tempo real.</p>'
                            }
                            ${!db && !window.isDevelopmentMode ? 
                                '<p>‚ùå <strong>Firebase desconectado:</strong> Sistema est√° usando localStorage como fallback.</p>' : ''
                            }
                            <p>üîÑ <strong>Sincroniza√ß√£o:</strong> ${window.isDevelopmentMode ? 'Desabilitada (modo local)' : 'Ativa para todos os usu√°rios'}</p>
                        </div>
                    </div>

                    <div class="text-right">
                        <button type="button" data-action="close-form-modal" class="secondary-btn">Fechar</button>
                    </div>
                </div>
            `;
            document.getElementById('form-modal').classList.add('visible');

            console.log('SYNC DEBUG INFO:', syncInfo);
        }



        // --- Calendar Functions ---
        async function deleteCalendarEvent(eventId) {
            // Check if user has permission to delete events
            if (currentUserRole === 'teacher') {
                showErrorMessage("Acesso Negado", "Usu√°rios com role 'teacher' n√£o podem apagar esta item.");
                return;
            }

            if (!confirm('Tem certeza que deseja excluir este evento?')) {
                return;
            }

            if (!db) {
                // Development mode - update localStorage
                calendarEvents = calendarEvents.filter(e => e.id !== eventId);
                localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
                renderCalendar();
                document.getElementById('form-modal').classList.remove('visible');
                showSuccessMessage("Sucesso!", "Evento exclu√≠do com sucesso.");
                return;
            }

            try {
                // Get event data before deleting for logging
                const event = calendarEvents.find(e => e.id === eventId);
                const eventTitle = event ? event.title : 'Evento';
                
                const eventDoc = doc(db, `artifacts/${appId}/public/data/calendar-events`, eventId);
                await deleteDoc(eventDoc);
                
                // Log activity
                await logActivity('deletar', 'evento_calendario', eventTitle, { date: event?.date });
                
                // Close modal and show success message
                document.getElementById('form-modal').classList.remove('visible');
                showSuccessMessage("Sucesso!", "Evento exclu√≠do com sucesso.");
            } catch (error) {
                console.error("Error deleting calendar event:", error);
                showErrorMessage("Erro", "Erro ao excluir evento: " + error.message);
            }
        }

        // --- LOGS DE ATIVIDADES SECTION ---
        let currentLogsPage = 1;
        const logsPerPage = 20;
        let currentLogsCollaboratorFilter = 'todos'; // Filtro por colaborador
        
        function changeLogsCollaboratorFilter(value) {
            currentLogsCollaboratorFilter = value;
            currentLogsPage = 1;
            renderLogsAtividadesSection();
        }
        
        function renderLogsAtividadesSection() {
            document.getElementById('main-title').textContent = 'Logs de Atividades';
            document.getElementById('main-description').textContent = 'Acompanhe todas as a√ß√µes realizadas no Hub nos √∫ltimos 5 dias.';

            const contentArea = document.getElementById('content-area');
            
            // Ordenar logs por timestamp decrescente
            const sortedLogs = [...activityLogs].sort((a, b) => {
                const timeA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                const timeB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                return timeB - timeA;
            });
            
            // Filtrar por colaborador se necess√°rio
            const filteredLogs = currentLogsCollaboratorFilter === 'todos' 
                ? sortedLogs 
                : sortedLogs.filter(log => log.userName === currentLogsCollaboratorFilter);
            
            // Extrair lista √∫nica de colaboradores dos logs para o filtro
            const uniqueCollaborators = [...new Set(sortedLogs.map(log => log.userName))].sort();
            
            // Calcular pagina√ß√£o
            const totalLogs = filteredLogs.length;
            const totalPages = Math.ceil(totalLogs / logsPerPage);
            const startIndex = (currentLogsPage - 1) * logsPerPage;
            const endIndex = startIndex + logsPerPage;
            const currentPageLogs = filteredLogs.slice(startIndex, endIndex);
            
            // Fun√ß√£o para formatar data/hora
            function formatTimestamp(timestamp) {
                if (!timestamp) return 'Data indispon√≠vel';
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                const day = date.getDate().toString().padStart(2, '0');
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const hours = date.getHours().toString().padStart(2, '0');
                const minutes = date.getMinutes().toString().padStart(2, '0');
                return `${day}/${month} √†s ${hours}:${minutes}`;
            }
            
            // Fun√ß√£o para obter cor da a√ß√£o
            function getActionColor(action) {
                const colors = {
                    'criar': 'green',
                    'editar': 'blue',
                    'deletar': 'red',
                    'finalizar': 'purple',
                    'reativar': 'yellow'
                };
                return colors[action] || 'gray';
            }
            
            // Fun√ß√£o para obter √≠cone da a√ß√£o
            function getActionIcon(action) {
                const icons = {
                    'criar': '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>',
                    'editar': '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>',
                    'deletar': '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>',
                    'finalizar': '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
                    'reativar': '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>'
                };
                return icons[action] || '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/></svg>';
            }
            
            // Renderizar logs
            const logsHTML = currentPageLogs.length > 0 ? currentPageLogs.map(log => {
                const actionColor = getActionColor(log.action);
                const actionIcon = getActionIcon(log.action);
                const detailsText = log.details && Object.keys(log.details).length > 0 
                    ? Object.entries(log.details).map(([key, value]) => `${key}: ${value}`).join(', ')
                    : '';
                
                return `
                    <div class="base-card !p-4 flex items-start gap-4 hover:shadow-md transition-shadow">
                        <div class="status-tag status-${actionColor} !py-2 !px-2 flex-shrink-0">
                            ${actionIcon}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-start justify-between gap-2 mb-1">
                                <div class="flex-1">
                                    <p class="font-bold text-stone-800">
                                        ${log.userName} 
                                        <span class="font-normal">${log.action} ${log.targetType}</span>
                                    </p>
                                    <p class="text-stone-600 mt-1">
                                        <span class="font-semibold">${log.targetName}</span>
                                    </p>
                                </div>
                                <div class="text-right flex-shrink-0">
                                    <p class="text-sm text-stone-500">${formatTimestamp(log.timestamp)}</p>
                                    <p class="text-xs text-stone-400 mt-1">${log.userRole}</p>
                                </div>
                            </div>
                            ${detailsText ? `<p class="text-sm text-stone-500 mt-2">${detailsText}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('') : `
                <div class="text-center p-12 bg-stone-50 rounded-lg">
                    <svg class="w-16 h-16 mx-auto mb-4 text-stone-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <p class="text-stone-500 text-lg">Nenhuma atividade registrada nos √∫ltimos 5 dias.</p>
                </div>
            `;
            
            // Renderizar controles de pagina√ß√£o
            let paginationHTML = '';
            if (totalPages > 1) {
                const pageNumbers = [];
                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= currentLogsPage - 1 && i <= currentLogsPage + 1)) {
                        pageNumbers.push(i);
                    } else if (pageNumbers[pageNumbers.length - 1] !== '...') {
                        pageNumbers.push('...');
                    }
                }
                
                paginationHTML = `
                    <div class="flex items-center justify-between mt-6 pt-6 border-t border-stone-200">
                        <div class="text-sm text-stone-600">
                            Mostrando ${startIndex + 1}-${Math.min(endIndex, totalLogs)} de ${totalLogs} registros
                        </div>
                        <div class="flex items-center gap-2">
                            <button 
                                onclick="currentLogsPage = Math.max(1, currentLogsPage - 1); renderLogsAtividadesSection();"
                                ${currentLogsPage === 1 ? 'disabled' : ''}
                                class="px-3 py-1 rounded border border-stone-300 bg-white hover:bg-stone-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                            >
                                Anterior
                            </button>
                            ${pageNumbers.map(page => {
                                if (page === '...') {
                                    return '<span class="px-3 py-1">...</span>';
                                }
                                return `
                                    <button 
                                        onclick="currentLogsPage = ${page}; renderLogsAtividadesSection();"
                                        class="px-3 py-1 rounded border ${page === currentLogsPage 
                                            ? 'bg-blue-500 text-white border-blue-500' 
                                            : 'border-stone-300 bg-white hover:bg-stone-50'} transition-colors"
                                    >
                                        ${page}
                                    </button>
                                `;
                            }).join('')}
                            <button 
                                onclick="currentLogsPage = Math.min(${totalPages}, currentLogsPage + 1); renderLogsAtividadesSection();"
                                ${currentLogsPage === totalPages ? 'disabled' : ''}
                                class="px-3 py-1 rounded border border-stone-300 bg-white hover:bg-stone-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                            >
                                Pr√≥xima
                            </button>
                        </div>
                    </div>
                `;
            }
            
            contentArea.innerHTML = `
                <section id="logs-atividades-section">
                    <div class="mb-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <p class="text-sm text-blue-800">
                                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <strong>Sistema de Auditoria:</strong> Todas as a√ß√µes s√£o registradas automaticamente. 
                                Os logs s√£o mantidos por 5 dias e depois automaticamente removidos.
                            </p>
                        </div>
                    </div>
                    
                    <div class="mb-6 flex items-center gap-4">
                        <label class="text-sm font-semibold text-stone-700">Filtrar por colaborador:</label>
                        <select 
                            id="logs-collaborator-filter" 
                            class="form-input !w-auto min-w-[200px]"
                            onchange="changeLogsCollaboratorFilter(this.value);"
                        >
                            <option value="todos" ${currentLogsCollaboratorFilter === 'todos' ? 'selected' : ''}>Todos os colaboradores</option>
                            ${uniqueCollaborators.map(collab => 
                                `<option value="${collab}" ${currentLogsCollaboratorFilter === collab ? 'selected' : ''}>${collab}</option>`
                            ).join('')}
                        </select>
                        ${currentLogsCollaboratorFilter !== 'todos' ? `
                            <button 
                                onclick="changeLogsCollaboratorFilter('todos');"
                                class="text-sm text-blue-600 hover:text-blue-800 underline"
                            >
                                Limpar filtro
                            </button>
                        ` : ''}
                    </div>
                    
                    <div class="mb-4 flex items-center justify-between">
                        <h3 class="text-lg font-bold text-stone-800">
                            ${totalLogs} atividade${totalLogs !== 1 ? 's' : ''} registrada${totalLogs !== 1 ? 's' : ''}
                            ${currentLogsCollaboratorFilter !== 'todos' ? `<span class="text-blue-600"> (filtrado por ${currentLogsCollaboratorFilter})</span>` : ''}
                        </h3>
                        ${totalPages > 1 ? `<span class="text-sm text-stone-500">P√°gina ${currentLogsPage} de ${totalPages}</span>` : ''}
                    </div>
                    
                    <div class="space-y-3">
                        ${logsHTML}
                    </div>
                    
                    ${paginationHTML}
                </section>
            `;
        }
        
        window.changeLogsCollaboratorFilter = changeLogsCollaboratorFilter;

        // --- GEST√ÉO TNs SECTION ---
        let testesNivel = [];

        function renderGestaoTNsSection() {
            document.getElementById('main-title').textContent = 'Gest√£o TNs';
            document.getElementById('main-description').textContent = 'Gerencie os Testes de N√≠vel realizados na escola.';
            
            const contentArea = document.getElementById('content-area');
            
            // Preparar lista de avaliadores
            const evaluators = collaborators.filter(c => c.isEvaluator === true);
            const evaluatorOptions = evaluators.map(e => 
                `<option value="${e.id}">${e.name}</option>`
            ).join('');
            
            contentArea.innerHTML = `
                <div id="gestao-tns-section">
                    <div class="mb-6 flex justify-between items-center gap-4">
                        <div class="flex gap-4 flex-grow">
                            <input type="text" id="tn-search" class="form-input !w-auto flex-grow" placeholder="Buscar por nome do prospect...">
                            <select id="tn-evaluator-filter" class="form-input !w-auto">
                                <option value="">Todos os avaliadores</option>
                                ${evaluatorOptions}
                            </select>
                        </div>
                        <button class="primary-btn w-auto" data-action="add-tn">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            Adicionar TN
                        </button>
                    </div>
                    
                    <div id="tns-list-container">
                        <!-- Lista ser√° renderizada aqui -->
                    </div>
                </div>
            `;
            
            // Load TNs only in localStorage mode (Firebase uses listener)
            if (!db) {
                const saved = localStorage.getItem('testes-nivel');
                testesNivel = saved ? JSON.parse(saved) : [];
            }
            renderTNsList();
            
            // Adicionar event listeners para busca e filtro
            setTimeout(() => {
                document.getElementById('tn-search')?.addEventListener('input', renderTNsList);
                document.getElementById('tn-evaluator-filter')?.addEventListener('change', renderTNsList);
            }, 100);
        }

        function renderTNsList() {
            const container = document.getElementById('tns-list-container');
            const searchTerm = document.getElementById('tn-search')?.value.toLowerCase() || '';
            const evaluatorFilter = document.getElementById('tn-evaluator-filter')?.value || '';
            
            // Filtrar por nome do candidato e avaliador
            let filteredTNs = testesNivel;
            
            if (searchTerm) {
                filteredTNs = filteredTNs.filter(tn => 
                    tn.candidateName.toLowerCase().includes(searchTerm)
                );
            }
            
            if (evaluatorFilter) {
                filteredTNs = filteredTNs.filter(tn => tn.evaluatorId === evaluatorFilter);
            }
            
            if (filteredTNs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-stone-500">
                        <svg class="w-16 h-16 mx-auto mb-4 text-stone-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p class="text-lg font-semibold">${testesNivel.length === 0 ? 'Nenhum teste de n√≠vel registrado' : 'Nenhum resultado encontrado'}</p>
                        <p class="text-sm">${testesNivel.length === 0 ? 'Clique em "Adicionar TN" para registrar um novo teste' : 'Tente ajustar sua busca'}</p>
                    </div>
                `;
                return;
            }
            
            // Ordenar alfabeticamente por nome do candidato
            const sortedTNs = [...filteredTNs].sort((a, b) => {
                return a.candidateName.localeCompare(b.candidateName, 'pt-BR', { sensitivity: 'base' });
            });
            
            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Data</th>
                                <th>Hor√°rio</th>
                                <th>Avaliador</th>
                                <th>N√≠vel</th>
                                <th>Observa√ß√µes</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sortedTNs.map(tn => {
                                const avaliador = collaborators.find(c => c.id === tn.evaluatorId);
                                return `
                                    <tr>
                                        <td class="font-semibold">${tn.candidateName}</td>
                                        <td>${formatDateBR(tn.date)}</td>
                                        <td>${tn.time || '-'}</td>
                                        <td>${avaliador?.name || 'N√£o especificado'}</td>
                                        <td>
                                            <span class="inline-block px-2 py-1 text-xs rounded bg-blue-100 text-blue-700 font-semibold">
                                                ${tn.level}
                                            </span>
                                        </td>
                                        <td class="max-w-xs truncate">${tn.observations || '-'}</td>
                                        <td class="whitespace-nowrap">
                                            <button class="secondary-btn w-auto text-sm" onclick='viewTN("${tn.id}")'>Ver</button>
                                            <button class="secondary-btn w-auto text-sm ml-2" onclick='editTN("${tn.id}")'>Editar</button>
                                            <button class="danger-btn w-auto text-sm ml-2" onclick='deleteTN("${tn.id}")'>Excluir</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function openTNModal(tnId = null) {
            clearModalHeaderButtons();
            const isEdit = tnId !== null;
            const tn = isEdit ? testesNivel.find(t => t.id === tnId) : null;
            
            document.getElementById('form-modal-title').textContent = `${isEdit ? 'Editar' : 'Adicionar'} Teste de N√≠vel`;
            
            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="tn-form" class="space-y-4">
                    <div>
                        <label class="font-medium text-sm">Nome do Candidato *</label>
                        <input type="text" id="tn-name" class="form-input" value="${tn?.candidateName || ''}" required>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="font-medium text-sm">Data *</label>
                            <input type="date" id="tn-date" class="form-input" value="${tn?.date || new Date().toISOString().split('T')[0]}" required>
                        </div>
                        <div>
                            <label class="font-medium text-sm">Hor√°rio</label>
                            <input type="time" id="tn-time" class="form-input" value="${tn?.time || ''}">
                        </div>
                    </div>
                    
                    <div>
                        <label class="font-medium text-sm">Avaliador *</label>
                        <select id="tn-evaluator" class="form-input" required>
                            <option value="">Selecione quem avaliou</option>
                            ${collaborators.filter(c => c.isEvaluator === true).map(c => 
                                `<option value="${c.id}" ${tn?.evaluatorId === c.id ? 'selected' : ''}>${c.name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div>
                        <label class="font-medium text-sm">N√≠vel Atribu√≠do *</label>
                        <select id="tn-level" class="form-input" required>
                            <option value="">Selecione o n√≠vel</option>
                            ${STANDARD_LEVELS.map(level => 
                                `<option value="${level}" ${tn?.level === level ? 'selected' : ''}>${level}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div>
                        <label class="font-medium text-sm">Observa√ß√µes</label>
                        <textarea id="tn-observations" rows="4" class="form-input" placeholder="Anota√ß√µes sobre o teste, observa√ß√µes importantes, etc...">${tn?.observations || ''}</textarea>
                    </div>
                    
                    <div class="flex justify-end gap-2 pt-4 border-t">
                        <button type="button" class="secondary-btn" onclick="closeFormModal()">Cancelar</button>
                        <button type="submit" class="primary-btn w-auto">Salvar</button>
                    </div>
                </form>
            `;
            
            document.getElementById('tn-form').onsubmit = async (e) => {
                e.preventDefault();
                await saveTN(tnId);
            };
            
            document.getElementById('form-modal').classList.add('visible');
        }

        async function saveTN(tnId = null) {
            const candidateName = document.getElementById('tn-name').value;
            const date = document.getElementById('tn-date').value;
            const time = document.getElementById('tn-time').value;
            const evaluatorId = document.getElementById('tn-evaluator').value;
            const level = document.getElementById('tn-level').value;
            const observations = document.getElementById('tn-observations').value;
            
            if (!candidateName || !date || !evaluatorId || !level) {
                showErrorMessage("Erro", "Preencha todos os campos obrigat√≥rios.");
                return;
            }
            
            const tnData = {
                candidateName,
                date,
                time,
                evaluatorId,
                level,
                observations,
                createdBy: currentUserName,
                createdAt: tnId ? testesNivel.find(t => t.id === tnId)?.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            try {
                if (!db) {
                    // localStorage mode
                    if (tnId) {
                        const index = testesNivel.findIndex(t => t.id === tnId);
                        if (index !== -1) {
                            testesNivel[index] = { ...testesNivel[index], ...tnData };
                        }
                    } else {
                        tnData.id = generateId();
                        testesNivel.push(tnData);
                    }
                    localStorage.setItem('testes-nivel', JSON.stringify(testesNivel));
                    renderTNsList();
                } else {
                    // Firebase mode - listener will update automatically
                    const id = tnId || generateId();
                    const docRef = doc(db, `artifacts/${appId}/public/data/testes-nivel`, id);
                    await setDoc(docRef, tnData);
                }
                
                document.getElementById('form-modal').classList.remove('visible');
                showSuccessMessage("Sucesso!", "Teste de n√≠vel salvo com sucesso.");
                playSuccessSound();
            } catch (error) {
                console.error('Error saving TN:', error);
                showErrorMessage("Erro", "Erro ao salvar teste de n√≠vel: " + error.message);
                playErrorSound();
            }
        }

        function viewTN(tnId) {
            const tn = testesNivel.find(t => t.id === tnId);
            if (!tn) return;
            
            clearModalHeaderButtons();
            const avaliador = collaborators.find(c => c.id === tn.evaluatorId);
            
            document.getElementById('form-modal-title').textContent = 'Detalhes do Teste de N√≠vel';
            
            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><strong>Candidato:</strong> ${tn.candidateName}</div>
                        <div><strong>Data:</strong> ${formatDateBR(tn.date)}</div>
                        <div><strong>Hor√°rio:</strong> ${tn.time || 'N√£o especificado'}</div>
                        <div><strong>Avaliador:</strong> ${avaliador?.name || 'N√£o especificado'}</div>
                        <div class="col-span-2">
                            <strong>N√≠vel Atribu√≠do:</strong> 
                            <span class="inline-block px-3 py-1 text-sm rounded bg-blue-100 text-blue-700 font-semibold ml-2">
                                ${tn.level}
                            </span>
                        </div>
                    </div>
                    
                    ${tn.observations ? `
                        <div class="pt-4 border-t">
                            <h5 class="font-semibold mb-2">Observa√ß√µes</h5>
                            <p class="text-sm text-stone-600">${tn.observations}</p>
                        </div>
                    ` : ''}
                    
                    <div class="flex justify-end gap-2 pt-4 border-t">
                        <button class="secondary-btn" onclick='closeFormModal(); setTimeout(() => openTNModal("${tn.id}"), 100);'>Editar</button>
                        <button class="secondary-btn" onclick="closeFormModal()">Fechar</button>
                    </div>
                </div>
            `;
            
            document.getElementById('form-modal').classList.add('visible');
        }

        function editTN(tnId) {
            document.getElementById('form-modal').classList.remove('visible');
            setTimeout(() => openTNModal(tnId), 300);
        }

        async function deleteTN(tnId) {
            if (!confirm('Tem certeza que deseja excluir este teste de n√≠vel?')) return;
            
            try {
                if (!db) {
                    // localStorage mode
                    testesNivel = testesNivel.filter(t => t.id !== tnId);
                    localStorage.setItem('testes-nivel', JSON.stringify(testesNivel));
                    renderTNsList();
                } else {
                    // Firebase mode - listener will update automatically
                    const docRef = doc(db, `artifacts/${appId}/public/data/testes-nivel`, tnId);
                    await deleteDoc(docRef);
                }
                
                showSuccessMessage("Sucesso!", "Teste de n√≠vel exclu√≠do com sucesso.");
            } catch (error) {
                console.error('Error deleting TN:', error);
                showErrorMessage("Erro", "Erro ao excluir teste de n√≠vel: " + error.message);
            }
        }

        window.openTNModal = openTNModal;
        window.viewTN = viewTN;
        window.editTN = editTN;
        window.deleteTN = deleteTN;

        function renderCalendarioSection() {
            document.getElementById('main-title').textContent = 'Calend√°rio';
            const contentArea = document.getElementById('content-area');

            contentArea.innerHTML = `
                <!-- Fixed Date Cards Section -->
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-stone-800 mb-4">Per√≠odos Fixos</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="fixed-date-cards-container">
                        <!-- Cards will be rendered here -->
                    </div>
                </div>

                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="flex items-center gap-4">
                            <button class="calendar-nav-btn" onclick="changeMonth(-1)">¬´ Anterior</button>
                            <h2 id="calendar-month-year" class="text-2xl font-bold text-stone-800"></h2>
                            <button class="calendar-nav-btn" onclick="changeMonth(1)">Pr√≥ximo ¬ª</button>
                        </div>
                        <div class="flex items-center gap-3">
                            <select id="calendar-filter-collaborator" class="form-input !w-auto" onchange="renderCalendar()">
                                <option value="">Todos os eventos</option>
                                ${collaborators.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                            </select>
                            <button class="primary-btn w-auto" data-action="add-calendar-event">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                </svg>
                                Adicionar Evento
                            </button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendar-grid">
                        <!-- Calendar will be rendered here -->
                    </div>
                </div>

                <!-- Fixed Date Card Edit Modal -->
                <div id="fixed-date-card-modal" class="modal-overlay">
                    <div class="modal-content max-w-md">
                        <div class="modal-header">
                            <h4>Editar Per√≠odo Fixo</h4>
                            <button data-action="close-fixed-date-modal" class="modal-close-btn">&times;</button>
                        </div>
                        <form id="fixed-date-card-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="font-medium text-sm">T√≠tulo</label>
                                    <input type="text" id="fixed-card-title" class="form-input" required>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Data de In√≠cio</label>
                                    <input type="date" id="fixed-card-start-date" class="form-input" required>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Data de Finaliza√ß√£o</label>
                                    <input type="date" id="fixed-card-end-date" class="form-input" required>
                                </div>
                            </div>
                            <div class="mt-6 flex justify-end gap-3">
                                <button type="button" class="secondary-btn" data-action="close-fixed-date-modal">Cancelar</button>
                                <button type="submit" class="primary-btn">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Event Modal -->
                <div id="calendar-event-modal" class="modal-overlay">
                    <div class="modal-content max-w-md">
                        <div class="modal-header">
                            <h4 id="event-modal-title">Evento</h4>
                            <button data-action="close-calendar-modal" class="modal-close-btn">&times;</button>
                        </div>
                        <form id="calendar-event-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="font-medium text-sm">T√≠tulo</label>
                                    <input type="text" id="event-title" class="form-input" required>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Data</label>
                                    <input type="date" id="event-date" class="form-input" required>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Hor√°rio</label>
                                    <input type="time" id="event-time" class="form-input">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Tipo</label>
                                    <select id="event-type" class="form-input" required>
                                        <option value="evento">Evento Geral</option>
                                        <option value="gravacao">Grava√ß√£o</option>
                                        <option value="lembrete">Lembrete</option>
                                        <option value="aula-extra">Aula Extra</option>
                                        <option value="data-comemorativa">Data Comemorativa</option>
                                        <option value="reuniao">Reuni√£o</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Criado por</label>
                                    <select id="event-creator" class="form-input" required>
                                        <option value="">Selecione quem est√° criando</option>
                                        ${collaborators.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Diz respeito a</label>
                                    <div id="event-concerns" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto border border-stone-200 rounded-lg p-3">
                                        ${collaborators.map(c => `
                                            <label class="flex items-center gap-2 cursor-pointer hover:bg-stone-50 p-1 rounded">
                                                <input type="checkbox" value="${c.id}" class="concern-checkbox" />
                                                <span class="text-sm">${c.name}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                    <p class="text-xs text-stone-500 mt-1">Selecione os colaboradores envolvidos neste evento</p>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Descri√ß√£o</label>
                                    <textarea id="event-description" rows="3" class="form-input"></textarea>
                                </div>
                                <div class="flex justify-end gap-2">
                                    <button type="button" data-action="close-calendar-modal" class="secondary-btn">Cancelar</button>
                                    <button type="submit" class="primary-btn w-auto">Salvar</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            initializeCalendar();
        }

        // --- LINKS √öTEIS SECTION ---
        function renderLinksUteisSection() {
            document.getElementById('main-title').textContent = 'Links √öteis';
            document.getElementById('main-description').textContent = 'Recursos e links compartilhados pela equipe.';
            const contentArea = document.getElementById('content-area');

            const canAddLink = can('links-uteis.full_access') || can('links-uteis.add_link');

            contentArea.innerHTML = `
                <div id="links-uteis-section" class="max-w-7xl mx-auto">
                    ${canAddLink ? `
                    <div class="mb-6 flex justify-end">
                        <button class="primary-btn" onclick="openLinkUtilModal()">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            Adicionar Link
                        </button>
                    </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="links-container">
                        <!-- Links will be rendered here -->
                    </div>
                </div>

                <!-- Link Modal -->
                <div id="link-util-modal" class="modal-overlay">
                    <div class="modal-content max-w-md">
                        <div class="modal-header">
                            <h4 id="link-modal-title">Adicionar Link</h4>
                            <button onclick="closeLinkUtilModal()" class="modal-close-btn">&times;</button>
                        </div>
                        <form id="link-util-form" onsubmit="saveLinkUtil(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="font-medium text-sm">T√≠tulo</label>
                                    <input type="text" id="link-title" class="form-input" required placeholder="Ex: Drive da SLAP">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Descri√ß√£o</label>
                                    <input type="text" id="link-description" class="form-input" placeholder="Breve descri√ß√£o do link (opcional)">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">URL</label>
                                    <input type="url" id="link-url" class="form-input" required placeholder="https://...">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">√çcone</label>
                                    <div class="grid grid-cols-4 gap-2 mt-2" id="icon-selector">
                                        <!-- Icons will be rendered here -->
                                    </div>
                                    <input type="hidden" id="link-icon" required>
                                </div>
                            </div>
                            <div class="mt-6 flex justify-end gap-3">
                                <button type="button" class="secondary-btn" onclick="closeLinkUtilModal()">Cancelar</button>
                                <button type="submit" class="primary-btn">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            renderLinksUteis();
            renderIconSelector();
        }

        const availableIcons = {
            'drive': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 15v4c0 1.1.9 2 2 2h14a2 2 0 0 0 2-2v-4M17 9l-5 5-5-5M12 12.8V2.5"/></svg>',
            'link': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>',
            'folder': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>',
            'book': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>',
            'video': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>',
            'music': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>',
            'calendar': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>',
            'mail': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>',
            'chat': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>',
            'file': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
            'image': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>',
            'globe': '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>'
        };

        function renderIconSelector() {
            const container = document.getElementById('icon-selector');
            if (!container) return;

            container.innerHTML = Object.keys(availableIcons).map(iconKey => `
                <button type="button" 
                        class="icon-option p-3 border-2 border-stone-200 rounded-lg hover:border-yellow-500 transition-colors"
                        data-icon="${iconKey}"
                        onclick="selectIcon('${iconKey}')">
                    <div class="w-6 h-6 mx-auto text-stone-700">
                        ${availableIcons[iconKey]}
                    </div>
                </button>
            `).join('');
        }

        function selectIcon(iconKey) {
            document.querySelectorAll('.icon-option').forEach(btn => {
                btn.classList.remove('border-yellow-500', 'bg-yellow-50');
                btn.classList.add('border-stone-200');
            });
            
            const selectedBtn = document.querySelector(`[data-icon="${iconKey}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('border-yellow-500', 'bg-yellow-50');
                selectedBtn.classList.remove('border-stone-200');
            }
            
            document.getElementById('link-icon').value = iconKey;
        }

        function renderLinksUteis() {
            const container = document.getElementById('links-container');
            if (!container) return;

            if (linksUteis.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                        </svg>
                        <p class="mt-2 text-stone-600">Nenhum link adicionado ainda.</p>
                    </div>
                `;
                return;
            }

            const canEditLink = can('links-uteis.full_access') || can('links-uteis.edit_link');
            const canDeleteLink = can('links-uteis.full_access') || can('links-uteis.delete_link');

            container.innerHTML = linksUteis.map(link => `
                <a href="${link.url}" target="_blank" rel="noopener noreferrer" 
                   class="block bg-white rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow border border-stone-200 group">
                    <div class="flex items-start justify-between">
                        <div class="flex items-start gap-4 flex-1">
                            <div class="w-12 h-12 flex-shrink-0 text-yellow-600 group-hover:text-yellow-700 transition-colors">
                                ${availableIcons[link.icon] || availableIcons['link']}
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-semibold text-stone-800 group-hover:text-yellow-600 transition-colors">
                                    ${link.title}
                                </h3>
                                ${link.description ? `<p class="text-sm text-stone-600 mt-1">${link.description}</p>` : ''}
                                <p class="text-xs text-stone-400 truncate mt-1">${link.url}</p>
                            </div>
                        </div>
                        ${canEditLink || canDeleteLink ? `
                        <div class="flex gap-1 ml-2" onclick="event.preventDefault(); event.stopPropagation();">
                            ${canEditLink ? `
                            <button onclick="editLinkUtil('${link.id}')" 
                                    class="p-2 text-stone-400 hover:text-stone-600 transition-colors"
                                    title="Editar">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                            </button>
                            ` : ''}
                            ${canDeleteLink ? `
                            <button onclick="deleteLinkUtil('${link.id}')" 
                                    class="p-2 text-stone-400 hover:text-red-600 transition-colors"
                                    title="Excluir">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                            ` : ''}
                        </div>
                        ` : ''}
                    </div>
                </a>
            `).join('');
        }

        let editingLinkId = null;

        function openLinkUtilModal(linkId = null) {
            const modal = document.getElementById('link-util-modal');
            const modalTitle = document.getElementById('link-modal-title');
            const form = document.getElementById('link-util-form');
            
            editingLinkId = linkId;
            
            if (linkId) {
                const link = linksUteis.find(l => l.id === linkId);
                if (link) {
                    modalTitle.textContent = 'Editar Link';
                    document.getElementById('link-title').value = link.title;
                    document.getElementById('link-description').value = link.description || '';
                    document.getElementById('link-url').value = link.url;
                    document.getElementById('link-icon').value = link.icon;
                    setTimeout(() => selectIcon(link.icon), 100);
                }
            } else {
                modalTitle.textContent = 'Adicionar Link';
                form.reset();
                document.querySelectorAll('.icon-option').forEach(btn => {
                    btn.classList.remove('border-yellow-500', 'bg-yellow-50');
                    btn.classList.add('border-stone-200');
                });
            }
            
            modal.classList.add('visible');
        }

        function closeLinkUtilModal() {
            const modal = document.getElementById('link-util-modal');
            modal.classList.remove('visible');
            editingLinkId = null;
        }

        async function saveLinkUtil(event) {
            event.preventDefault();
            
            const title = document.getElementById('link-title').value;
            const description = document.getElementById('link-description').value;
            const url = document.getElementById('link-url').value;
            const icon = document.getElementById('link-icon').value;
            
            if (!title || !url || !icon) {
                showErrorMessage('Erro', 'Preencha todos os campos obrigat√≥rios.');
                return;
            }
            
            try {
                const linkData = { title, description: description || '', url, icon };
                
                if (editingLinkId) {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/links-uteis`, editingLinkId), linkData);
                    await logActivity('Editou link √∫til', 'link', title);
                    showSuccessMessage('Sucesso!', 'Link atualizado com sucesso.');
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/links-uteis`), linkData);
                    await logActivity('Adicionou link √∫til', 'link', title);
                    showSuccessMessage('Sucesso!', 'Link adicionado com sucesso.');
                }
                
                closeLinkUtilModal();
            } catch (error) {
                console.error('Error saving link:', error);
                showErrorMessage('Erro', 'Erro ao salvar link: ' + error.message);
            }
        }

        async function editLinkUtil(linkId) {
            openLinkUtilModal(linkId);
        }

        async function deleteLinkUtil(linkId) {
            const link = linksUteis.find(l => l.id === linkId);
            if (!link) return;
            
            if (!confirm(`Tem certeza que deseja excluir o link "${link.title}"?`)) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/links-uteis`, linkId));
                await logActivity('Excluiu link √∫til', 'link', link.title);
                showSuccessMessage('Sucesso!', 'Link exclu√≠do com sucesso.');
            } catch (error) {
                console.error('Error deleting link:', error);
                showErrorMessage('Erro', 'Erro ao excluir link: ' + error.message);
            }
        }

        window.openLinkUtilModal = openLinkUtilModal;
        window.closeLinkUtilModal = closeLinkUtilModal;
        window.saveLinkUtil = saveLinkUtil;
        window.editLinkUtil = editLinkUtil;
        window.deleteLinkUtil = deleteLinkUtil;
        window.selectIcon = selectIcon;

        // --- TASKS & PRAZOS SECTION ---
        let taskPeople = [];
        
        function renderTasksPrazosSection() {
            document.getElementById('main-title').textContent = 'Tasks & Prazos';
            document.getElementById('main-description').textContent = 'Gerencie tarefas e prazos da equipe de forma independente.';
            const contentArea = document.getElementById('content-area');

            contentArea.innerHTML = `
                <div id="tasks-prazos-section" class="max-w-7xl mx-auto">
                    ${can('tasks-prazos.add_person') ? `
                    <div class="mb-6 flex justify-between">
                        <button class="primary-btn" style="background-color: #84C7DF;" onmouseover="this.style.backgroundColor='#6DB5CD'" onmouseout="this.style.backgroundColor='#84C7DF'" onclick="openMultipleTaskModal()">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            Task para M√∫ltiplos
                        </button>
                        <button class="primary-btn" onclick="openAddPersonModal()">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                            </svg>
                            Adicionar Colaborador
                        </button>
                    </div>
                    ` : ''}
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="people-tasks-container">
                        <!-- People cards will be rendered here -->
                    </div>
                </div>
                
                <!-- Add/Edit Person Modal -->
                <div id="person-modal" class="modal-overlay">
                    <div class="modal-content max-w-md">
                        <div class="modal-header">
                            <h4 id="person-modal-title">Adicionar Colaborador</h4>
                            <button onclick="closePersonModal()" class="modal-close-btn">&times;</button>
                        </div>
                        <form id="person-form" onsubmit="savePerson(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="font-medium text-sm">Nome <span class="text-red-500">*</span></label>
                                    <input type="text" id="person-name" class="form-input" required placeholder="Ex: Jo√£o Silva">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Cargo/Fun√ß√£o</label>
                                    <input type="text" id="person-role" class="form-input" placeholder="Ex: Professor, Pedag√≥gico, etc.">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">URL da Foto (Cloudinary)</label>
                                    <input type="url" id="person-photo-url" class="form-input" placeholder="https://res.cloudinary.com/...">
                                    <p class="text-xs text-stone-500 mt-1">Opcional: Cole o link da foto hospedada no Cloudinary</p>
                                </div>
                            </div>
                            <div class="mt-6 flex justify-end gap-3">
                                <button type="button" class="secondary-btn" onclick="closePersonModal()">Cancelar</button>
                                <button type="submit" class="primary-btn">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Task Management Modal -->
                <div id="task-management-modal" class="modal-overlay">
                    <div class="modal-content max-w-4xl">
                        <div class="modal-header">
                            <div>
                                <h4 id="task-modal-collaborator-name">Tasks</h4>
                                <p id="task-modal-collaborator-role" class="text-sm text-stone-600 mt-1"></p>
                            </div>
                            <div class="flex items-center gap-3">
                                <div id="task-modal-export-container"></div>
                                <button onclick="closeTaskManagementModal()" class="modal-close-btn">&times;</button>
                            </div>
                        </div>
                        <div class="p-6">
                            ${can('tasks-prazos.add_task') ? `
                            <div class="mb-6 flex justify-end gap-3">
                                <button class="primary-btn" style="background-color: #F1D24B;" onmouseover="this.style.backgroundColor='#E0C03D'" onmouseout="this.style.backgroundColor='#F1D24B'" onclick="openAddTaskForm()">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                                    </svg>
                                    Task Normal
                                </button>
                                <button class="primary-btn" style="background-color: #F1D24B;" onmouseover="this.style.backgroundColor='#E0C03D'" onmouseout="this.style.backgroundColor='#F1D24B'" onclick="openAddChecklistForm()">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                                    </svg>
                                    Checklist
                                </button>
                            </div>
                            ` : ''}
                            
                            <div id="tasks-list-container">
                                <!-- Tasks will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add/Edit Task Modal -->
                <div id="task-form-modal" class="modal-overlay">
                    <div class="modal-content max-w-md">
                        <div class="modal-header">
                            <h4 id="task-form-title">Nova Task</h4>
                            <button onclick="closeTaskFormModal()" class="modal-close-btn">&times;</button>
                        </div>
                        <form id="task-form" onsubmit="saveTaskPrazo(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="font-medium text-sm">T√≠tulo <span class="text-red-500">*</span></label>
                                    <input type="text" id="task-title" class="form-input" required placeholder="Ex: Revisar documenta√ß√£o">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Descri√ß√£o</label>
                                    <textarea id="task-description" rows="3" class="form-input" placeholder="Detalhes da task (opcional)"></textarea>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Prazo <span class="text-red-500">*</span></label>
                                    <input type="date" id="task-due-date" class="form-input" required>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Link do Documento <span class="text-stone-400 text-xs">(opcional)</span></label>
                                    <input type="url" id="task-link" class="form-input" placeholder="https://drive.google.com/...">
                                    <p class="text-xs text-stone-500 mt-1">Adicione um link para Drive, Notion, etc.</p>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Urg√™ncia</label>
                                    <select id="task-urgency" class="form-input">
                                        <option value="normal">Sem Urg√™ncia</option>
                                        <option value="urgent">Urgente</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-6 flex justify-end gap-3">
                                <button type="button" class="secondary-btn" onclick="closeTaskFormModal()">Cancelar</button>
                                <button type="submit" class="primary-btn">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Add/Edit Checklist Modal -->
                <div id="checklist-form-modal" class="modal-overlay">
                    <div class="modal-content max-w-2xl">
                        <div class="modal-header">
                            <h4 id="checklist-form-title">Nova Checklist</h4>
                            <button onclick="closeChecklistFormModal()" class="modal-close-btn">&times;</button>
                        </div>
                        <form id="checklist-form" onsubmit="saveChecklist(event)">
                            <div class="space-y-4">
                                <div>
                                    <label class="font-medium text-sm">T√≠tulo da Checklist <span class="text-red-500">*</span></label>
                                    <input type="text" id="checklist-title" class="form-input" required placeholder="Ex: Criar slides do curso de viagem">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Descri√ß√£o</label>
                                    <textarea id="checklist-description" rows="2" class="form-input" placeholder="Descri√ß√£o geral (opcional)"></textarea>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Prazo Geral <span class="text-red-500">*</span></label>
                                    <input type="date" id="checklist-due-date" class="form-input" required>
                                    <p class="text-xs text-stone-500 mt-1">Prazo final para toda a checklist</p>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Link do Documento <span class="text-stone-400 text-xs">(opcional)</span></label>
                                    <input type="url" id="checklist-link" class="form-input" placeholder="https://drive.google.com/...">
                                    <p class="text-xs text-stone-500 mt-1">Adicione um link para Drive, Notion, etc.</p>
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Urg√™ncia</label>
                                    <select id="checklist-urgency" class="form-input">
                                        <option value="normal">Sem Urg√™ncia</option>
                                        <option value="urgent">Urgente</option>
                                    </select>
                                </div>

                                <div class="border-t border-stone-200 pt-4">
                                    <div class="flex justify-between items-center mb-3">
                                        <label class="font-medium text-sm">Itens da Checklist</label>
                                        <button type="button" class="text-sm font-medium" style="color: #8671D1;" onmouseover="this.style.color='#7561BD'" onmouseout="this.style.color='#8671D1'" onclick="addChecklistItem()">
                                            + Adicionar Item
                                        </button>
                                    </div>
                                    <div id="checklist-items-container" class="space-y-3">
                                        <!-- Checklist items will be added here -->
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6 flex justify-end gap-3">
                                <button type="button" class="secondary-btn" onclick="closeChecklistFormModal()">Cancelar</button>
                                <button type="submit" class="primary-btn" style="background-color: #8671D1;" onmouseover="this.style.backgroundColor='#7561BD'" onmouseout="this.style.backgroundColor='#8671D1'">Salvar Checklist</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Multiple Task Modal -->
                <div id="multiple-task-modal" class="modal-overlay">
                    <div class="modal-content max-w-3xl">
                        <div class="modal-header">
                            <h4>Criar Task para M√∫ltiplos Colaboradores</h4>
                            <button onclick="closeMultipleTaskModal()" class="modal-close-btn">&times;</button>
                        </div>
                        <form id="multiple-task-form" onsubmit="saveMultipleTask(event)">
                            <div class="space-y-6">
                                <!-- People Selection -->
                                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                    <label class="font-medium text-sm text-blue-900 mb-3 block">
                                        Selecione os Colaboradores <span class="text-red-500">*</span>
                                    </label>
                                    <div id="multiple-people-checkboxes" class="grid grid-cols-2 md:grid-cols-3 gap-3 max-h-60 overflow-y-auto">
                                        <!-- Checkboxes will be populated here -->
                                    </div>
                                    <p class="text-xs text-blue-700 mt-2">Selecione um ou mais colaboradores para receber a mesma task</p>
                                </div>

                                <!-- Task Type Selection -->
                                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-300">
                                    <label class="font-medium text-sm text-yellow-900 mb-3 block">
                                        Tipo de Task <span class="text-red-500">*</span>
                                    </label>
                                    <div class="flex gap-4">
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="multiple-task-type" value="normal" checked class="mr-2">
                                            <span class="text-sm font-medium">Task Normal</span>
                                        </label>
                                        <label class="flex items-center cursor-pointer">
                                            <input type="radio" name="multiple-task-type" value="checklist" class="mr-2">
                                            <span class="text-sm font-medium" style="color: #8671D1;">Checklist</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Task Details -->
                                <div class="space-y-4">
                                    <div>
                                        <label class="font-medium text-sm">T√≠tulo da Task <span class="text-red-500">*</span></label>
                                        <input type="text" id="multiple-task-title" class="form-input" required placeholder="Ex: Revisar documenta√ß√£o">
                                    </div>
                                    <div>
                                        <label class="font-medium text-sm">Descri√ß√£o</label>
                                        <textarea id="multiple-task-description" rows="3" class="form-input" placeholder="Detalhes da task (opcional)"></textarea>
                                    </div>
                                    <div>
                                        <label class="font-medium text-sm">Prazo <span class="text-red-500">*</span></label>
                                        <input type="date" id="multiple-task-due-date" class="form-input" required>
                                    </div>
                                    <div>
                                        <label class="font-medium text-sm">Link do Documento <span class="text-stone-400 text-xs">(opcional)</span></label>
                                        <input type="url" id="multiple-task-link" class="form-input" placeholder="https://drive.google.com/...">
                                        <p class="text-xs text-stone-500 mt-1">Adicione um link para Drive, Notion, etc.</p>
                                    </div>
                                </div>

                                <!-- Checklist Items (only for checklist type) -->
                                <div id="multiple-checklist-section" class="hidden border-t border-stone-200 pt-4">
                                    <div class="flex justify-between items-center mb-3">
                                        <label class="font-medium text-sm">Itens da Checklist</label>
                                        <button type="button" class="text-sm font-medium" style="color: #8671D1;" onclick="addMultipleChecklistItem()">
                                            + Adicionar Item
                                        </button>
                                    </div>
                                    <div id="multiple-checklist-items-container" class="space-y-3">
                                        <!-- Checklist items will be added here -->
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6 flex justify-end gap-3">
                                <button type="button" class="secondary-btn" onclick="closeMultipleTaskModal()">Cancelar</button>
                                <button type="submit" class="primary-btn" style="background-color: #84C7DF;" onmouseover="this.style.backgroundColor='#6DB5CD'" onmouseout="this.style.backgroundColor='#84C7DF'">
                                    Criar para Todos
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            renderPeopleTasksCards();
            
            // Toggle checklist section based on task type
            document.addEventListener('change', function(e) {
                if (e.target.name === 'multiple-task-type') {
                    const checklistSection = document.getElementById('multiple-checklist-section');
                    if (checklistSection) {
                        if (e.target.value === 'checklist') {
                            checklistSection.classList.remove('hidden');
                            // Add initial checklist item if empty
                            const container = document.getElementById('multiple-checklist-items-container');
                            if (container && container.children.length === 0) {
                                addMultipleChecklistItem();
                            }
                        } else {
                            checklistSection.classList.add('hidden');
                        }
                    }
                }
            });
        }

        let selectedPersonForTasks = null;
        let editingTaskId = null;
        let editingPersonId = null;

        function renderPeopleTasksCards() {
            const container = document.getElementById('people-tasks-container');
            if (!container) return;

            if (taskPeople.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
                        </svg>
                        <p class="mt-2 text-stone-600 font-semibold">Nenhuma pessoa cadastrada ainda.</p>
                        ${can('tasks-prazos.add_person') ? `<button class="mt-4 primary-btn" onclick="openAddPersonModal()">+ Adicionar Primeira Pessoa</button>` : ''}
                    </div>
                `;
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            container.innerHTML = taskPeople.map(person => {
                const personTasks = tasks.filter(t => t.personId === person.id);
                const pendingTasks = personTasks.filter(t => !t.approved); // S√≥ aprovadas contam como conclu√≠das
                
                // Count completed tasks and items
                let completedCount = 0;
                personTasks.forEach(t => {
                    if (t.type === 'checklist' && t.checklistItems) {
                        // For checklists, count each approved item
                        t.checklistItems.forEach(item => {
                            if (item.approved) {
                                completedCount++;
                            }
                        });
                    } else if (t.approved) {
                        // For normal tasks, count if approved
                        completedCount++;
                    }
                });
                
                // Count tasks awaiting approval (completed by user but not approved yet)
                let awaitingApprovalCount = 0;
                personTasks.forEach(t => {
                    if (t.type === 'checklist' && t.checklistItems) {
                        // For checklists, count items completed by user but not approved
                        t.checklistItems.forEach(item => {
                            if (item.completedByUser && !item.approved) {
                                awaitingApprovalCount++;
                            }
                        });
                    } else if (t.completedByUser && !t.approved) {
                        // For normal tasks
                        awaitingApprovalCount++;
                    }
                });
                
                // Count overdue items (each checklist item counts as 1)
                let overdueCount = 0;
                pendingTasks.forEach(t => {
                    if (t.type === 'checklist' && t.checklistItems) {
                        // For checklists, count each overdue item individually
                        t.checklistItems.forEach(item => {
                            if (!item.approved) { // Mudar de completed para approved
                                const itemDueDate = new Date(item.dueDate + 'T00:00:00');
                                itemDueDate.setHours(0, 0, 0, 0);
                                if (itemDueDate < today) {
                                    overdueCount++;
                                }
                            }
                        });
                    } else {
                        // For normal tasks, check if the entire task is overdue
                        const dueDate = new Date(t.dueDate + 'T00:00:00');
                        dueDate.setHours(0, 0, 0, 0);
                        if (dueDate < today) {
                            overdueCount++;
                        }
                    }
                });

                const photoUrl = person.photoUrl || 'https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg';

                return `
                    <div class="bg-white rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow border border-stone-200 cursor-pointer relative"
                         onclick="openTaskManagementModal('${person.id}')">
                        ${awaitingApprovalCount > 0 && currentUserRole === 'admin' ? `
                        <div class="absolute top-2 left-2 flex items-center gap-1.5 px-2.5 py-1 rounded-full" style="background-color: #F1D24B;">
                            <svg class="w-4 h-4" style="color: #8B6914;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span class="text-xs font-bold" style="color: #8B6914;">${awaitingApprovalCount}</span>
                        </div>
                        ` : ''}
                        ${(can('tasks-prazos.edit_person') || can('tasks-prazos.delete_person')) ? `
                        <div class="absolute top-2 right-2 flex gap-1">
                            ${can('tasks-prazos.edit_person') ? `
                            <button onclick="event.stopPropagation(); editPerson('${person.id}')" class="p-1.5 text-stone-400 hover:text-blue-600 transition-colors" title="Editar pessoa">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                </svg>
                            </button>
                            ` : ''}
                            ${can('tasks-prazos.delete_person') ? `
                            <button onclick="event.stopPropagation(); deletePerson('${person.id}')" class="p-1.5 text-stone-400 hover:text-red-600 transition-colors" title="Excluir pessoa">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                            ` : ''}
                        </div>
                        ` : ''}
                        <div class="flex flex-col items-center text-center">
                            <img src="${photoUrl}" 
                                 alt="${person.name}" 
                                 class="w-24 h-24 rounded-full object-cover border-4 border-stone-200 mb-4"
                                 onerror="this.src='https://res.cloudinary.com/dqfi22uz0/image/upload/v1749349751/DBB440C2-684E-4DCF-9CD3-B2DDC18F1E53_3_vgocga.jpg'">
                            
                            <h3 class="font-bold text-lg text-stone-800">${person.name}</h3>
                            <p class="text-sm text-stone-600 capitalize">${person.role || 'Sem cargo'}</p>
                            
                            <div class="mt-4 w-full pt-4 border-t border-stone-200">
                                <div class="grid grid-cols-3 gap-3">
                                    <div>
                                        <p class="text-2xl font-bold text-stone-800">${pendingTasks.length}</p>
                                        <p class="text-xs text-stone-600">Ativas</p>
                                    </div>
                                    <div>
                                        <p class="text-2xl font-bold ${overdueCount > 0 ? 'text-red-600' : 'text-green-600'}">
                                            ${overdueCount}
                                        </p>
                                        <p class="text-xs text-stone-600">Atrasadas</p>
                                    </div>
                                    <div>
                                        <p class="text-2xl font-bold" style="color: #8671D1;">
                                            ${completedCount}
                                        </p>
                                        <p class="text-xs text-stone-600">Conclu√≠das</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function openAddPersonModal() {
            editingPersonId = null;
            document.getElementById('person-modal-title').textContent = 'Adicionar Colaborador';
            document.getElementById('person-form').reset();
            document.getElementById('person-modal').classList.add('visible');
        }
        
        function editPerson(personId) {
            const person = taskPeople.find(p => p.id === personId);
            if (!person) return;
            
            editingPersonId = personId;
            document.getElementById('person-modal-title').textContent = 'Editar Colaborador';
            document.getElementById('person-name').value = person.name;
            document.getElementById('person-role').value = person.role || '';
            document.getElementById('person-photo-url').value = person.photoUrl || '';
            document.getElementById('person-modal').classList.add('visible');
        }
        
        function closePersonModal() {
            document.getElementById('person-modal').classList.remove('visible');
            editingPersonId = null;
        }
        
        async function savePerson(event) {
            event.preventDefault();
            
            const name = document.getElementById('person-name').value;
            const role = document.getElementById('person-role').value;
            const photoUrl = document.getElementById('person-photo-url').value;
            
            if (!name) {
                showErrorMessage('Erro', 'O nome √© obrigat√≥rio.');
                return;
            }
            
            const personData = {
                name,
                role,
                photoUrl,
                createdAt: editingPersonId ? (taskPeople.find(p => p.id === editingPersonId)?.createdAt || new Date().toISOString()) : new Date().toISOString()
            };
            
            try {
                if (editingPersonId) {
                    await setDoc(doc(db, `artifacts/${appId}/public/data/task-people`, editingPersonId), personData);
                    await logActivity('Editou pessoa em Tasks & Prazos', 'task-person', name);
                    showSuccessMessage('Sucesso!', 'Pessoa atualizada com sucesso.');
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/task-people`), personData);
                    await logActivity('Adicionou pessoa em Tasks & Prazos', 'task-person', name);
                    showSuccessMessage('Sucesso!', 'Pessoa adicionada com sucesso.');
                }
                closePersonModal();
            } catch (error) {
                console.error('Error saving person:', error);
                showErrorMessage('Erro', 'Erro ao salvar pessoa: ' + error.message);
            }
        }
        
        async function deletePerson(personId) {
            const person = taskPeople.find(p => p.id === personId);
            if (!person) return;
            
            const personTasks = tasks.filter(t => t.personId === personId);
            if (personTasks.length > 0) {
                if (!confirm(`${person.name} tem ${personTasks.length} task(s). Excluir a pessoa ir√° excluir todas as suas tasks. Deseja continuar?`)) {
                    return;
                }
            } else {
                if (!confirm(`Tem certeza que deseja excluir ${person.name}?`)) {
                    return;
                }
            }
            
            try {
                // Delete all tasks first
                for (const task of personTasks) {
                    await deleteDoc(doc(db, `artifacts/${appId}/public/data/tasks`, task.id));
                }
                
                // Then delete the person
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/task-people`, personId));
                await logActivity('Excluiu pessoa de Tasks & Prazos', 'task-person', person.name);
                showSuccessMessage('Sucesso!', 'Pessoa exclu√≠da com sucesso.');
            } catch (error) {
                console.error('Error deleting person:', error);
                showErrorMessage('Erro', 'Erro ao excluir pessoa.');
            }
        }

        function openTaskManagementModal(personId) {
            const person = taskPeople.find(p => p.id === personId);
            if (!person) return;

            selectedPersonForTasks = personId;

            document.getElementById('task-modal-collaborator-name').textContent = `Tasks - ${person.name}`;
            document.getElementById('task-modal-collaborator-role').textContent = (person.role || 'Sem cargo').toUpperCase();

            // Add export button
            const exportContainer = document.getElementById('task-modal-export-container');
            exportContainer.innerHTML = `
                <button class="secondary-btn flex items-center" 
                        data-action="export-tasks-pdf" 
                        data-id="${personId}"
                        title="Exportar tasks para PDF">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    Exportar PDF
                </button>
            `;

            renderTasksList();

            document.getElementById('task-management-modal').classList.add('visible');
        }

        function closeTaskManagementModal() {
            document.getElementById('task-management-modal').classList.remove('visible');
            selectedPersonForTasks = null;
        }

        function renderTasksList() {
            const container = document.getElementById('tasks-list-container');
            if (!container || !selectedPersonForTasks) return;

            const collaboratorTasks = tasks.filter(t => t.personId === selectedPersonForTasks);

            if (collaboratorTasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-stone-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        <p class="mt-2 text-stone-600">Nenhuma task cadastrada ainda.</p>
                    </div>
                `;
                return;
            }

            // Sort: N√£o aprovadas primeiro (mais atrasadas primeiro), depois aprovadas
            const sortedTasks = [...collaboratorTasks].sort((a, b) => {
                if (a.approved !== b.approved) {
                    return a.approved ? 1 : -1; // N√£o aprovadas primeiro
                }
                if (!a.approved) {
                    return new Date(a.dueDate) - new Date(b.dueDate); // Mais antigas primeiro
                }
                return new Date(b.dueDate) - new Date(a.dueDate); // Aprovadas: mais recentes primeiro
            });

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const selectedPerson = taskPeople.find(p => p.id === selectedPersonForTasks);
            
            // Secure permission check: use firebaseUid if available, fallback to name comparison
            let canManage = can('tasks-prazos.complete_all');
            if (!canManage && can('tasks-prazos.complete_own') && selectedPerson && currentCollaborator) {
                if (selectedPerson.firebaseUid && currentCollaborator.firebaseUid) {
                    // Secure comparison by Firebase UID
                    canManage = selectedPerson.firebaseUid === currentCollaborator.firebaseUid;
                } else {
                    // Fallback to name comparison (less secure, but necessary for manually added people)
                    canManage = currentCollaborator.name === selectedPerson.name;
                    if (canManage) {
                        console.warn('‚ö†Ô∏è Using name-based permission check for complete_own. Consider linking person to collaborator via firebaseUid for better security.');
                    }
                }
            }

            container.innerHTML = sortedTasks.map(task => {
                const dueDate = new Date(task.dueDate + 'T00:00:00');
                dueDate.setHours(0, 0, 0, 0);
                const isOverdue = !task.approved && dueDate < today;
                const isToday = dueDate.getTime() === today.getTime();

                // For checklists, render differently
                if (task.type === 'checklist' && task.checklistItems && task.checklistItems.length > 0) {
                    const approvedCount = task.checklistItems.filter(item => item.approved).length;
                    const completedByUserCount = task.checklistItems.filter(item => item.completedByUser).length;
                    const totalCount = task.checklistItems.length;
                    const allApproved = approvedCount === totalCount;
                    
                    return `
                        <div class="mb-4 p-4 rounded-lg border-2" style="${allApproved ? 'background-color: #d6d3d1; border-color: #a8a29e; opacity: 0.7;' : isOverdue ? 'background-color: #fef2f2; border-color: #fca5a5;' : isToday ? 'background-color: #fefce8; border-color: #fde047;' : 'background-color: #faf5ff; border-color: #8671D1;'}">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 flex-wrap">
                                        <span class="text-white text-xs px-2 py-1 rounded font-semibold" style="background-color: #8671D1;">CHECKLIST</span>
                                        ${task.urgency === 'urgent' ? '<span class="px-2 py-0.5 text-xs font-semibold rounded" style="background-color: #fecaca; color: #991b1b;">URGENTE</span>' : '<span class="px-2 py-0.5 text-xs font-semibold rounded" style="background-color: #d1fae5; color: #065f46;">SEM URG√äNCIA</span>'}
                                        <h4 class="font-semibold text-stone-800 ${allApproved ? 'line-through text-stone-500' : ''}">
                                            ${task.title}
                                        </h4>
                                    </div>
                                    ${task.description ? `<p class="text-sm text-stone-600 mt-2">${task.description}</p>` : ''}
                                    ${task.link ? `
                                    <a href="${task.link}" target="_blank" rel="noopener noreferrer" 
                                       class="inline-flex items-center gap-1 mt-2 text-xs font-medium text-blue-600 hover:text-blue-800 hover:underline">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                                        </svg>
                                        Abrir documento
                                    </a>
                                    ` : ''}
                                    <div class="flex items-center gap-4 mt-2 text-xs text-stone-500">
                                        <span class="flex items-center gap-1">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                            </svg>
                                            Prazo Geral: ${formatDateBR(task.dueDate)}
                                        </span>
                                        <span class="font-semibold text-green-600">${completedByUserCount}/${totalCount} feitos</span>
                                        <span class="font-semibold" style="color: #8671D1;">${approvedCount}/${totalCount} aprovados</span>
                                        ${isOverdue && !allApproved ? '<span class="text-red-600 font-semibold">ATRASADA</span>' : ''}
                                        ${isToday && !allApproved ? '<span class="text-yellow-600 font-semibold">HOJE</span>' : ''}
                                    </div>
                                </div>
                                ${canManage ? `
                                <div class="flex gap-2 ml-4">
                                    <button onclick="event.stopPropagation(); editTask('${task.id}')" 
                                            class="p-2 text-stone-400 hover:text-stone-600 transition-colors"
                                            title="Editar">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                    </button>
                                    <button onclick="event.stopPropagation(); deleteTask('${task.id}')" 
                                            class="p-2 text-stone-400 hover:text-red-600 transition-colors"
                                            title="Excluir">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                </div>
                                ` : ''}
                            </div>
                            <div class="mt-3 space-y-2 pl-4 border-l-2" style="border-color: #8671D1;">
                                ${task.checklistItems.map((item, index) => {
                                    const itemDate = new Date(item.dueDate + 'T00:00:00');
                                    itemDate.setHours(0, 0, 0, 0);
                                    const itemOverdue = !item.approved && itemDate < today;
                                    const itemToday = itemDate.getTime() === today.getTime();
                                    
                                    return `
                                        <div class="flex items-start gap-3 p-3 rounded border" style="${item.approved ? 'background-color: #f5f5f4; border-color: #e7e5e4;' : itemOverdue ? 'background-color: #fef2f2; border-color: #fca5a5;' : itemToday ? 'background-color: #fefce8; border-color: #fde047;' : 'background-color: white; border-color: #e7e5e4;'}">
                                            <div class="flex flex-col gap-2">
                                                <label class="flex items-center gap-2 cursor-pointer" title="Marcar como feito (todos podem)">
                                                    <input type="checkbox" 
                                                           ${item.completedByUser ? 'checked' : ''}
                                                           onchange="toggleChecklistUserCompletion('${task.id}', ${index})"
                                                           class="h-4 w-4 rounded border-gray-300"
                                                           style="accent-color: #10b981;">
                                                    <span class="text-xs font-medium text-green-700">Feito</span>
                                                </label>
                                                ${currentUserRole === 'admin' ? `
                                                <label class="flex items-center gap-2 cursor-pointer" title="Aprovar (s√≥ admin)">
                                                    <input type="checkbox" 
                                                           ${item.approved ? 'checked' : ''}
                                                           onchange="toggleChecklistAdminApproval('${task.id}', ${index})"
                                                           class="h-4 w-4 rounded border-gray-300"
                                                           style="accent-color: #F1D24B;">
                                                    <span class="text-xs font-medium" style="color: #F1D24B;">Aprovado</span>
                                                </label>
                                                ` : ''}
                                            </div>
                                            <div class="flex-1">
                                                <span class="text-sm font-medium ${item.approved ? 'line-through text-stone-500' : 'text-stone-800'}">${item.title}</span>
                                                <div class="flex items-center gap-2 mt-1 text-xs text-stone-500">
                                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                                    </svg>
                                                    ${formatDateBR(item.dueDate)}
                                                    ${item.completedByUser && !item.approved ? '<span class="text-green-600 font-semibold ml-2">AGUARDANDO APROVA√á√ÉO</span>' : ''}
                                                    ${itemOverdue ? '<span class="text-red-600 font-semibold ml-2">ATRASADO</span>' : ''}
                                                    ${itemToday ? '<span class="text-yellow-600 font-semibold ml-2">HOJE</span>' : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }

                // Normal task rendering
                return `
                    <div class="mb-4 p-4 rounded-lg border-2 ${task.approved ? 'bg-stone-200 border-stone-300 opacity-70' : isOverdue ? 'bg-red-50 border-red-300' : isToday ? 'bg-yellow-50 border-yellow-300' : 'bg-white border-stone-200'}">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <h4 class="font-semibold text-stone-800 ${task.approved ? 'line-through text-stone-500' : ''}">
                                        ${task.title}
                                    </h4>
                                    ${task.urgency === 'urgent' ? '<span class="px-2 py-0.5 text-xs font-semibold rounded" style="background-color: #fecaca; color: #991b1b;">URGENTE</span>' : '<span class="px-2 py-0.5 text-xs font-semibold rounded" style="background-color: #d1fae5; color: #065f46;">SEM URG√äNCIA</span>'}
                                </div>
                                ${task.completedByUser && !task.approved ? '<span class="text-xs text-green-600 font-semibold mt-1 block">AGUARDANDO APROVA√á√ÉO</span>' : ''}
                                ${task.description ? `<p class="text-sm text-stone-600 mt-2">${task.description}</p>` : ''}
                                ${task.link ? `
                                <a href="${task.link}" target="_blank" rel="noopener noreferrer" 
                                   class="inline-flex items-center gap-1 mt-2 text-xs font-medium text-blue-600 hover:text-blue-800 hover:underline">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
                                    </svg>
                                    Abrir documento
                                </a>
                                ` : ''}
                                <div class="flex items-center gap-4 mt-3 text-xs text-stone-500 border-t border-stone-200 pt-3">
                                    <span class="flex items-center gap-1">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                        </svg>
                                        ${formatDateBR(task.dueDate)}
                                    </span>
                                    ${isOverdue && !task.approved ? '<span class="text-red-600 font-semibold">ATRASADA</span>' : ''}
                                    ${isToday && !task.approved ? '<span class="text-yellow-600 font-semibold">HOJE</span>' : ''}
                                    <div class="flex items-center gap-3 ml-auto">
                                        <label class="flex items-center gap-1.5 cursor-pointer" title="Marcar como feito (todos podem)">
                                            <input type="checkbox" 
                                                   ${task.completedByUser ? 'checked' : ''}
                                                   onchange="toggleUserCompletion('${task.id}', this.checked)"
                                                   class="h-4 w-4 rounded border-gray-300"
                                                   style="accent-color: #10b981;">
                                            <span class="text-xs font-medium text-green-700">Feito</span>
                                        </label>
                                        ${currentUserRole === 'admin' ? `
                                        <label class="flex items-center gap-1.5 cursor-pointer" title="Aprovar (s√≥ admin)">
                                            <input type="checkbox" 
                                                   ${task.approved ? 'checked' : ''}
                                                   onchange="toggleAdminApproval('${task.id}', this.checked)"
                                                   class="h-4 w-4 rounded border-gray-300"
                                                   style="accent-color: #F1D24B;">
                                            <span class="text-xs font-medium" style="color: #F1D24B;">Aprovado</span>
                                        </label>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            ${canManage ? `
                            <div class="flex gap-2 ml-4">
                                <button onclick="event.stopPropagation(); editTask('${task.id}')" 
                                        class="p-2 text-stone-400 hover:text-stone-600 transition-colors"
                                        title="Editar">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                    </svg>
                                </button>
                                <button onclick="event.stopPropagation(); deleteTask('${task.id}')" 
                                        class="p-2 text-stone-400 hover:text-red-600 transition-colors"
                                        title="Excluir">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openAddTaskForm() {
            editingTaskId = null;
            document.getElementById('task-form-title').textContent = 'Nova Task';
            document.getElementById('task-form').reset();
            document.getElementById('task-form-modal').classList.add('visible');
        }

        function editTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            editingTaskId = taskId;
            
            // Se for checklist, abre o modal de checklist
            if (task.type === 'checklist') {
                document.getElementById('checklist-form-title').textContent = 'Editar Checklist';
                document.getElementById('checklist-title').value = task.title;
                document.getElementById('checklist-description').value = task.description || '';
                document.getElementById('checklist-due-date').value = task.dueDate;
                document.getElementById('checklist-link').value = task.link || '';
                document.getElementById('checklist-urgency').value = task.urgency || 'normal';
                
                // Preenche os itens da checklist
                const itemsContainer = document.getElementById('checklist-items-container');
                itemsContainer.innerHTML = '';
                checklistItemCounter = 0;
                
                task.checklistItems.forEach(item => {
                    addChecklistItem(item.title, item.dueDate);
                });
                
                document.getElementById('checklist-form-modal').classList.add('visible');
            } else {
                // Task normal
                document.getElementById('task-form-title').textContent = 'Editar Task';
                document.getElementById('task-title').value = task.title;
                document.getElementById('task-description').value = task.description || '';
                document.getElementById('task-due-date').value = task.dueDate;
                document.getElementById('task-link').value = task.link || '';
                document.getElementById('task-urgency').value = task.urgency || 'normal';
                
                document.getElementById('task-form-modal').classList.add('visible');
            }
        }

        function closeTaskFormModal() {
            document.getElementById('task-form-modal').classList.remove('visible');
            editingTaskId = null;
        }

        async function saveTaskPrazo(event) {
            event.preventDefault();

            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const dueDate = document.getElementById('task-due-date').value;
            const link = document.getElementById('task-link').value;
            const urgency = document.getElementById('task-urgency').value;

            if (!title || !dueDate) {
                showErrorMessage('Erro', 'Preencha todos os campos obrigat√≥rios.');
                return;
            }

            const taskData = {
                title,
                description,
                dueDate,
                link: link || null,
                urgency: urgency || 'normal',
                personId: selectedPersonForTasks,
                type: 'normal',
                status: editingTaskId ? (tasks.find(t => t.id === editingTaskId)?.status || 'pending') : 'pending',
                completedByUser: editingTaskId ? (tasks.find(t => t.id === editingTaskId)?.completedByUser || false) : false,
                approved: editingTaskId ? (tasks.find(t => t.id === editingTaskId)?.approved || false) : false,
                createdAt: editingTaskId ? (tasks.find(t => t.id === editingTaskId)?.createdAt || new Date().toISOString()) : new Date().toISOString()
            };

            try {
                if (editingTaskId) {
                    await setDoc(doc(db, `artifacts/${appId}/public/data/tasks`, editingTaskId), taskData);
                    await logActivity('Editou task', 'task', title);
                    showSuccessMessage('Sucesso!', 'Task atualizada com sucesso.');
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), taskData);
                    await logActivity('Adicionou task', 'task', title);
                    showSuccessMessage('Sucesso!', 'Task criada com sucesso.');
                }
                
                closeTaskFormModal();
                renderTasksList();
            } catch (error) {
                console.error('Error saving task:', error);
                showErrorMessage('Erro', 'Erro ao salvar task: ' + error.message);
            }
        }

        async function toggleTaskStatus(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            const newStatus = task.status === 'completed' ? 'pending' : 'completed';

            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, taskId), {
                    status: newStatus
                });
                await logActivity(newStatus === 'completed' ? 'Concluiu task' : 'Reativou task', 'task', task.title);
                renderTasksList();
            } catch (error) {
                console.error('Error toggling task status:', error);
                showErrorMessage('Erro', 'Erro ao atualizar status da task.');
            }
        }

        async function deleteTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            if (!confirm(`Tem certeza que deseja excluir a task "${task.title}"?`)) {
                return;
            }

            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/tasks`, taskId));
                await logActivity('Excluiu task', 'task', task.title);
                showSuccessMessage('Sucesso!', 'Task exclu√≠da com sucesso.');
                renderTasksList();
            } catch (error) {
                console.error('Error deleting task:', error);
                showErrorMessage('Erro', 'Erro ao excluir task.');
            }
        }

        // --- CHECKLIST FUNCTIONS ---
        let checklistItemCounter = 0;

        function openAddChecklistForm() {
            editingTaskId = null;
            document.getElementById('checklist-form-title').textContent = 'Nova Checklist';
            document.getElementById('checklist-form').reset();
            document.getElementById('checklist-items-container').innerHTML = '';
            checklistItemCounter = 0;
            
            // Add one initial item
            addChecklistItem();
            
            document.getElementById('checklist-form-modal').classList.add('visible');
        }

        function closeChecklistFormModal() {
            document.getElementById('checklist-form-modal').classList.remove('visible');
            editingTaskId = null;
            checklistItemCounter = 0;
        }

        function addChecklistItem(title = '', dueDate = '', completed = false) {
            const itemId = checklistItemCounter++;
            const container = document.getElementById('checklist-items-container');
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex gap-2 items-start p-3 bg-stone-50 rounded-lg';
            itemDiv.id = `checklist-item-${itemId}`;
            itemDiv.innerHTML = `
                <div class="flex-1 grid grid-cols-2 gap-2">
                    <input type="text" 
                           class="form-input checklist-item-title" 
                           placeholder="Nome do item (ex: Aula 1)" 
                           value="${title}"
                           required>
                    <input type="date" 
                           class="form-input checklist-item-due-date" 
                           value="${dueDate}"
                           required>
                </div>
                <button type="button" 
                        class="p-2 text-red-500 hover:text-red-700" 
                        onclick="removeChecklistItem(${itemId})"
                        title="Remover item">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            `;
            
            container.appendChild(itemDiv);
        }

        function removeChecklistItem(itemId) {
            const item = document.getElementById(`checklist-item-${itemId}`);
            if (item) {
                item.remove();
            }
        }

        async function saveChecklist(event) {
            event.preventDefault();

            const title = document.getElementById('checklist-title').value;
            const description = document.getElementById('checklist-description').value;
            const dueDate = document.getElementById('checklist-due-date').value;
            const link = document.getElementById('checklist-link').value;
            const urgency = document.getElementById('checklist-urgency').value;

            // Get original task if editing (to preserve item statuses)
            const originalTask = editingTaskId ? tasks.find(t => t.id === editingTaskId) : null;

            // Collect all checklist items
            const itemElements = document.querySelectorAll('#checklist-items-container > div');
            const checklistItems = [];
            
            let itemIndex = 0;
            for (let elem of itemElements) {
                const itemTitle = elem.querySelector('.checklist-item-title').value;
                const itemDueDate = elem.querySelector('.checklist-item-due-date').value;
                
                if (itemTitle && itemDueDate) {
                    // Se estamos editando, tenta preservar os status do item original na mesma posi√ß√£o
                    const originalItem = originalTask?.checklistItems?.[itemIndex];
                    
                    checklistItems.push({
                        title: itemTitle,
                        dueDate: itemDueDate,
                        completedByUser: originalItem?.completedByUser || false,
                        approved: originalItem?.approved || false
                    });
                    itemIndex++;
                }
            }

            if (!title || !dueDate) {
                showErrorMessage('Erro', 'Preencha t√≠tulo e prazo geral.');
                return;
            }

            if (checklistItems.length === 0) {
                showErrorMessage('Erro', 'Adicione pelo menos um item √† checklist.');
                return;
            }

            const checklistData = {
                title,
                description,
                dueDate,
                link: link || null,
                urgency: urgency || 'normal',
                personId: selectedPersonForTasks,
                type: 'checklist',
                checklistItems: checklistItems,
                status: editingTaskId ? (originalTask?.status || 'pending') : 'pending',
                createdAt: editingTaskId ? (originalTask?.createdAt || new Date().toISOString()) : new Date().toISOString()
            };

            try {
                if (editingTaskId) {
                    await setDoc(doc(db, `artifacts/${appId}/public/data/tasks`, editingTaskId), checklistData);
                    await logActivity('Editou checklist', 'task', title);
                    showSuccessMessage('Sucesso!', 'Checklist atualizada com sucesso.');
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), checklistData);
                    await logActivity('Adicionou checklist', 'task', title);
                    showSuccessMessage('Sucesso!', 'Checklist criada com sucesso.');
                }
                
                closeChecklistFormModal();
                renderTasksList();
            } catch (error) {
                console.error('Error saving checklist:', error);
                showErrorMessage('Erro', 'Erro ao salvar checklist: ' + error.message);
            }
        }

        // Fun√ß√£o para usu√°rio marcar checklist item como feito
        async function toggleChecklistUserCompletion(taskId, itemIndex) {
            const task = tasks.find(t => t.id === taskId);
            if (!task || task.type !== 'checklist') return;

            const items = [...task.checklistItems];
            items[itemIndex].completedByUser = !items[itemIndex].completedByUser;

            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, taskId), {
                    checklistItems: items
                });
                await logActivity(
                    items[itemIndex].completedByUser ? 'Marcou item como feito' : 'Desmarcou item como feito', 
                    'checklist-item', 
                    `${task.title} - ${items[itemIndex].title}`
                );
            } catch (error) {
                console.error('Error toggling checklist item user completion:', error);
                showErrorMessage('Erro', 'Erro ao atualizar item da checklist.');
            }
        }

        // Fun√ß√£o para admin aprovar checklist item
        async function toggleChecklistAdminApproval(taskId, itemIndex) {
            if (currentUserRole !== 'admin') {
                showErrorMessage('Erro', 'Apenas administradores podem aprovar checklist items.');
                return;
            }

            const task = tasks.find(t => t.id === taskId);
            if (!task || task.type !== 'checklist') return;

            const items = [...task.checklistItems];
            items[itemIndex].approved = !items[itemIndex].approved;

            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, taskId), {
                    checklistItems: items
                });
                
                // Check if all items are approved
                const allApproved = items.every(item => item.approved);
                if (allApproved && task.status !== 'completed') {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, taskId), {
                        status: 'completed',
                        approved: true
                    });
                    await logActivity('Aprovou checklist completa', 'task', task.title);
                } else if (!allApproved && task.status === 'completed') {
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/tasks`, taskId), {
                        status: 'pending',
                        approved: false
                    });
                }
                
                await logActivity(
                    items[itemIndex].approved ? 'Aprovou item' : 'Removeu aprova√ß√£o de item', 
                    'checklist-item', 
                    `${task.title} - ${items[itemIndex].title}`
                );
            } catch (error) {
                console.error('Error toggling checklist item approval:', error);
                showErrorMessage('Erro', 'Erro ao aprovar item da checklist.');
            }
        }

        // --- MULTIPLE TASK FUNCTIONS ---
        let multipleChecklistItemCounter = 0;
        
        window.openMultipleTaskModal = function() {
            // Populate people checkboxes
            const container = document.getElementById('multiple-people-checkboxes');
            if (!container) return;
            
            if (taskPeople.length === 0) {
                container.innerHTML = '<p class="text-sm text-stone-600 col-span-full text-center">Nenhum colaborador cadastrado ainda.</p>';
                return;
            }
            
            container.innerHTML = taskPeople.map(person => `
                <label class="flex items-center gap-2 p-2 hover:bg-blue-100 rounded cursor-pointer">
                    <input type="checkbox" name="selected-people" value="${person.id}" class="rounded">
                    <span class="text-sm">${person.name}</span>
                </label>
            `).join('');
            
            // Reset form
            document.getElementById('multiple-task-form').reset();
            document.getElementById('multiple-checklist-items-container').innerHTML = '';
            document.getElementById('multiple-checklist-section').classList.add('hidden');
            multipleChecklistItemCounter = 0;
            
            // Show modal
            document.getElementById('multiple-task-modal').classList.add('visible');
        };
        
        window.closeMultipleTaskModal = function() {
            document.getElementById('multiple-task-modal').classList.remove('visible');
            multipleChecklistItemCounter = 0;
        };
        
        window.addMultipleChecklistItem = function(title = '', dueDate = '') {
            const itemId = multipleChecklistItemCounter++;
            const container = document.getElementById('multiple-checklist-items-container');
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'flex gap-2 items-start p-3 bg-stone-50 rounded-lg';
            itemDiv.id = `multiple-checklist-item-${itemId}`;
            itemDiv.innerHTML = `
                <div class="flex-1 space-y-2">
                    <input type="text" 
                           placeholder="T√≠tulo do item (Ex: Aula 1)" 
                           value="${title}"
                           class="form-input multiple-checklist-item-title" 
                           required>
                    <input type="date" 
                           value="${dueDate}"
                           class="form-input multiple-checklist-item-due-date" 
                           required>
                </div>
                <button type="button" 
                        class="text-red-600 hover:text-red-800 mt-2" 
                        onclick="removeMultipleChecklistItem(${itemId})"
                        title="Remover item">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            `;
            
            container.appendChild(itemDiv);
        };
        
        window.removeMultipleChecklistItem = function(itemId) {
            const item = document.getElementById(`multiple-checklist-item-${itemId}`);
            if (item) item.remove();
        };
        
        window.saveMultipleTask = async function(event) {
            event.preventDefault();
            
            // Get selected people
            const selectedCheckboxes = document.querySelectorAll('input[name="selected-people"]:checked');
            if (selectedCheckboxes.length === 0) {
                showErrorMessage('Erro', 'Selecione pelo menos um colaborador.');
                return;
            }
            
            const selectedPeopleIds = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            // Get task type
            const taskType = document.querySelector('input[name="multiple-task-type"]:checked').value;
            
            // Get task data
            const title = document.getElementById('multiple-task-title').value;
            const description = document.getElementById('multiple-task-description').value;
            const dueDate = document.getElementById('multiple-task-due-date').value;
            const link = document.getElementById('multiple-task-link').value;
            
            if (!title || !dueDate) {
                showErrorMessage('Erro', 'Preencha todos os campos obrigat√≥rios.');
                return;
            }
            
            try {
                let tasksCreated = 0;
                
                if (taskType === 'normal') {
                    // Create normal task for each selected person
                    for (const personId of selectedPeopleIds) {
                        const taskData = {
                            title,
                            description,
                            dueDate,
                            link: link || null,
                            personId: personId,
                            type: 'normal',
                            status: 'pending',
                            createdAt: new Date().toISOString()
                        };
                        
                        await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), taskData);
                        tasksCreated++;
                    }
                    
                    await logActivity('Criou task para m√∫ltiplos colaboradores', 'task', `${title} (${tasksCreated} pessoas)`);
                    showSuccessMessage('Sucesso!', `Task criada para ${tasksCreated} colaborador(es).`);
                    
                } else if (taskType === 'checklist') {
                    // Collect checklist items
                    const itemElements = document.querySelectorAll('#multiple-checklist-items-container > div');
                    const checklistItems = [];
                    
                    itemElements.forEach(elem => {
                        const itemTitle = elem.querySelector('.multiple-checklist-item-title').value;
                        const itemDueDate = elem.querySelector('.multiple-checklist-item-due-date').value;
                        
                        if (itemTitle && itemDueDate) {
                            checklistItems.push({
                                title: itemTitle,
                                dueDate: itemDueDate,
                                completed: false
                            });
                        }
                    });
                    
                    if (checklistItems.length === 0) {
                        showErrorMessage('Erro', 'Adicione pelo menos um item √† checklist.');
                        return;
                    }
                    
                    // Create checklist for each selected person
                    for (const personId of selectedPeopleIds) {
                        const checklistData = {
                            title,
                            description,
                            dueDate,
                            link: link || null,
                            personId: personId,
                            type: 'checklist',
                            checklistItems: checklistItems,
                            status: 'pending',
                            createdAt: new Date().toISOString()
                        };
                        
                        await addDoc(collection(db, `artifacts/${appId}/public/data/tasks`), checklistData);
                        tasksCreated++;
                    }
                    
                    await logActivity('Criou checklist para m√∫ltiplos colaboradores', 'task', `${title} (${tasksCreated} pessoas)`);
                    showSuccessMessage('Sucesso!', `Checklist criada para ${tasksCreated} colaborador(es).`);
                }
                
                closeMultipleTaskModal();
                renderPeopleTasksCards();
                
            } catch (error) {
                console.error('Error saving multiple tasks:', error);
                showErrorMessage('Erro', 'Erro ao criar tasks: ' + error.message);
            }
        };

        window.openTaskManagementModal = openTaskManagementModal;
        window.closeTaskManagementModal = closeTaskManagementModal;
        window.openAddTaskForm = openAddTaskForm;
        window.closeTaskFormModal = closeTaskFormModal;
        window.saveTaskPrazo = saveTaskPrazo;
        window.editTask = editTask;
        window.deleteTask = deleteTask;
        window.toggleTaskStatus = toggleTaskStatus;
        window.toggleUserCompletion = toggleUserCompletion;
        window.toggleAdminApproval = toggleAdminApproval;
        window.openAddPersonModal = openAddPersonModal;
        window.editPerson = editPerson;
        window.closePersonModal = closePersonModal;
        window.savePerson = savePerson;
        window.deletePerson = deletePerson;
        window.openAddChecklistForm = openAddChecklistForm;
        window.closeChecklistFormModal = closeChecklistFormModal;
        window.addChecklistItem = addChecklistItem;
        window.removeChecklistItem = removeChecklistItem;
        window.saveChecklist = saveChecklist;
        window.toggleChecklistUserCompletion = toggleChecklistUserCompletion;
        window.toggleChecklistAdminApproval = toggleChecklistAdminApproval;

        let currentCalendarDate = new Date();
        let calendarEvents = [];
        let fixedDateCards = [];
        let financialProfitSettings = {
            vipMonthlyPayment: 0,
            vipTeacherPayment: 0,
            turmaStudentPayment: 0,
            turmaTeacherPayment: 0
        };


        // Brazilian national holidays only for pedagogical calendar
        function getBrazilianHolidays(year) {
            return [
                { date: `${year}-01-01`, title: "Ano Novo", type: "holiday", country: "BR" },
                { date: `${year}-02-12`, title: "Carnaval", type: "holiday", country: "BR" },
                { date: `${year}-04-21`, title: "Tiradentes", type: "holiday", country: "BR" },
                { date: `${year}-05-01`, title: "Dia do Trabalhador", type: "holiday", country: "BR" },
                { date: `${year}-09-07`, title: "Independ√™ncia do Brasil", type: "holiday", country: "BR" },
                { date: `${year}-10-12`, title: "Nossa Senhora Aparecida", type: "holiday", country: "BR" },
                { date: `${year}-11-02`, title: "Finados", type: "holiday", country: "BR" },
                { date: `${year}-11-15`, title: "Proclama√ß√£o da Rep√∫blica", type: "holiday", country: "BR" },
                { date: `${year}-12-25`, title: "Natal", type: "holiday", country: "BR" },
                { date: `${year}-05-12`, title: "Dia das M√£es", type: "holiday", country: "BR" },
                { date: `${year}-08-11`, title: "Dia dos Pais", type: "holiday", country: "BR" },
                { date: `${year}-10-15`, title: "Dia do Professor", type: "holiday", country: "BR" },
                { date: `${year}-06-12`, title: "Dia dos Namorados", type: "holiday", country: "BR" },
                { date: `${year}-12-31`, title: "Ano Novo (V√©spera)", type: "holiday", country: "BR" }
            ];
        }

        function initializeCalendar() {
            renderCalendar();
            loadCalendarEvents();
            loadFixedDateCards();
            loadFinancialProfitSettings();
        }

        function changeMonth(direction) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
            renderCalendar();
        }

        function renderCalendar() {
            const monthYear = document.getElementById('calendar-month-year');
            const calendarGrid = document.getElementById('calendar-grid');

            const months = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const days = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];

            monthYear.textContent = `${months[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;

            const firstDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth(), 1);
            const lastDay = new Date(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            let html = days.map(day => `<div class="calendar-day-header">${day}</div>`).join('');

            for (let i = 0; i < 42; i++) {
                const currentDay = new Date(startDate);
                currentDay.setDate(startDate.getDate() + i);

                const isCurrentMonth = currentDay.getMonth() === currentCalendarDate.getMonth();
                const isToday = currentDay.toDateString() === new Date().toDateString();
                const dayEvents = getEventsForDate(currentDay);

                html += `
                    <div class="calendar-day ${!isCurrentMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}" 
                         data-date="${currentDay.toISOString().split('T')[0]}">
                        <div class="calendar-day-number">${currentDay.getDate()}</div>
                        ${dayEvents.map(event => 
                            `<div class="calendar-event ${event.type === 'holiday' ? 'holiday-event' : event.type}" 
                                  ${event.type === 'holiday' ? '' : `onclick="viewCalendarEvent('${event.id}')"`}>
                                ${event.type === 'holiday' ? `<svg class="inline-block w-3 h-3 mr-1" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>${event.title}` : event.title}
                            </div>`
                        ).join('')}
                    </div>
                `;
            }

            calendarGrid.innerHTML = html;
        }

        function getEventsForDate(date) {
            const dateString = date.toISOString().split('T')[0];
            let events = calendarEvents.filter(event => event.date === dateString);
            
            const filterCollaborator = document.getElementById('calendar-filter-collaborator')?.value;
            if (filterCollaborator) {
                events = events.filter(event => {
                    return event.createdBy === filterCollaborator || 
                           (event.concerns && event.concerns.includes(filterCollaborator));
                });
            }
            
            const holidays = getBrazilianHolidays(date.getFullYear()).filter(holiday => holiday.date === dateString);
            
            return [...events, ...holidays];
        }

        async function loadFixedDateCards() {
            if (!db) {
                const localCards = JSON.parse(localStorage.getItem('fixedDateCards') || '[]');
                
                // Clean up: keep only first 4 cards
                if (localCards.length > 4) {
                    fixedDateCards = localCards.slice(0, 4);
                    localStorage.setItem('fixedDateCards', JSON.stringify(fixedDateCards));
                } else if (localCards.length === 0) {
                    // Initialize 4 empty cards
                    fixedDateCards = Array.from({ length: 4 }, (_, i) => ({
                        id: `fixed-${i + 1}`,
                        title: `Per√≠odo ${i + 1}`,
                        startDate: '',
                        endDate: ''
                    }));
                    localStorage.setItem('fixedDateCards', JSON.stringify(fixedDateCards));
                } else {
                    fixedDateCards = localCards;
                }
                renderFixedDateCards();
                return;
            }

            try {
                const cardsCollection = collection(db, `artifacts/${appId}/public/data/fixed-date-cards`);
                const cardsSnapshot = await getDocs(cardsCollection);
                
                // Delete cards 5-8 if they exist
                const cardsToDelete = ['fixed-5', 'fixed-6', 'fixed-7', 'fixed-8'];
                for (const cardId of cardsToDelete) {
                    const cardDoc = doc(db, `artifacts/${appId}/public/data/fixed-date-cards`, cardId);
                    const cardSnapshot = await getDoc(cardDoc);
                    if (cardSnapshot.exists()) {
                        await deleteDoc(cardDoc);
                        console.log(`Deleted old card: ${cardId}`);
                    }
                }
                
                // Reload after deletion
                const updatedSnapshot = await getDocs(cardsCollection);
                
                if (updatedSnapshot.empty) {
                    // Initialize 4 empty cards in Firebase
                    fixedDateCards = Array.from({ length: 4 }, (_, i) => ({
                        id: `fixed-${i + 1}`,
                        title: `Per√≠odo ${i + 1}`,
                        startDate: '',
                        endDate: ''
                    }));
                    for (const card of fixedDateCards) {
                        await setDoc(doc(db, `artifacts/${appId}/public/data/fixed-date-cards`, card.id), card);
                    }
                } else {
                    fixedDateCards = updatedSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
                
                // Set up real-time listener
                onSnapshot(cardsCollection, (snapshot) => {
                    fixedDateCards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderFixedDateCards();
                });
                
                renderFixedDateCards();
            } catch (error) {
                console.error("Error loading fixed date cards:", error);
                fixedDateCards = [];
                renderFixedDateCards();
            }
        }

        async function loadFinancialProfitSettings() {
            if (!db) {
                const localSettings = JSON.parse(localStorage.getItem('financialProfitSettings') || '{"vipMonthlyPayment": 0, "vipTeacherPayment": 0, "turmaStudentPayment": 0, "turmaTeacherPayment": 0}');
                financialProfitSettings = localSettings;
                return;
            }

            try {
                const settingsDoc = doc(db, `artifacts/${appId}/public/data/financial-profit-settings`, 'settings');
                const settingsSnapshot = await getDoc(settingsDoc);
                
                if (settingsSnapshot.exists()) {
                    financialProfitSettings = settingsSnapshot.data();
                } else {
                    // Initialize with default values in Firebase
                    await setDoc(settingsDoc, financialProfitSettings);
                }
                
                // Set up real-time listener
                onSnapshot(settingsDoc, (snapshot) => {
                    if (snapshot.exists()) {
                        financialProfitSettings = snapshot.data();
                        // Re-render financial section if visible
                        if (currentSection === 'folha-pagamento') {
                            renderFolhaPagamentoSection();
                        }
                    }
                });
            } catch (error) {
                console.error("Error loading financial profit settings:", error);
                financialProfitSettings = {
                    vipMonthlyPayment: 0,
                    vipTeacherPayment: 0,
                    turmaStudentPayment: 0,
                    turmaTeacherPayment: 0
                };
            }
        }

        async function loadCalendarEvents() {
            if (!db) {
                console.warn("Firebase not available, loading from localStorage");
                const localEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
                if (localEvents.length === 0) {
                    // Add sample data if no events exist
                    calendarEvents = [
                        { id: '1', title: 'Reuni√£o Pedag√≥gica', date: '2025-01-15', time: '09:00', type: 'reuniao', description: 'Reuni√£o mensal da equipe pedag√≥gica' },
                        { id: '2', title: 'Grava√ß√£o Aula', date: '2025-01-20', time: '14:00', type: 'gravacao', description: 'Grava√ß√£o da aula de pronuncia√ß√£o avan√ßada' }
                    ];
                    localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
                } else {
                    calendarEvents = localEvents;
                }
                renderCalendar();
                return;
            }

            try {
                const eventsCollection = collection(db, `artifacts/${appId}/public/data/calendar-events`);
                const eventsSnapshot = await getDocs(eventsCollection);
                calendarEvents = eventsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Set up real-time listener
                onSnapshot(eventsCollection, (snapshot) => {
                    calendarEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCalendar();
                });
                
                renderCalendar();
            } catch (error) {
                console.error("Error loading calendar events:", error);
                calendarEvents = [];
                renderCalendar();
            }
        }

        async function saveCalendarEvents() {
            // No longer needed - events are saved individually via saveCalendarEvent
        }

        function renderFixedDateCards() {
            const container = document.getElementById('fixed-date-cards-container');
            if (!container) return;

            const canEdit = currentUserRole !== 'teacher';

            container.innerHTML = fixedDateCards.map(card => {
                const hasData = card.startDate && card.endDate;
                const hoverClass = canEdit ? 'hover:shadow-lg cursor-pointer' : 'cursor-default';
                const clickAction = canEdit ? `data-action="edit-fixed-card" data-card-id="${card.id}"` : '';
                
                return `
                    <div class="bg-gradient-to-br from-stone-50 to-stone-100 p-6 rounded-lg border border-stone-200 ${hoverClass} transition-shadow" ${clickAction}>
                        <div class="flex items-center gap-3 mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-orange-500" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z"/>
                                <circle cx="12" cy="14" r="1.5"/>
                            </svg>
                            <h3 class="text-sm font-medium text-stone-700 uppercase tracking-wide">${card.title || 'Per√≠odo'}</h3>
                        </div>
                        ${hasData ? `
                            <div class="space-y-1">
                                <p class="text-2xl font-bold text-stone-800">${formatDateBR(card.startDate)}</p>
                                <p class="text-xs text-stone-600 mt-1">In√≠cio</p>
                                <p class="text-2xl font-bold text-stone-800 mt-3">${formatDateBR(card.endDate)}</p>
                                <p class="text-xs text-stone-600 mt-1">Finaliza√ß√£o</p>
                            </div>
                        ` : `
                            <p class="text-lg text-stone-400 italic mt-2">Clique para configurar</p>
                        `}
                    </div>
                `;
            }).join('');
        }

        function openFixedDateCardModal(cardId) {
            if (currentUserRole === 'teacher') {
                return; // Teachers cannot edit
            }

            const card = fixedDateCards.find(c => c.id === cardId);
            if (!card) return;

            const modal = document.getElementById('fixed-date-card-modal');
            const form = document.getElementById('fixed-date-card-form');

            document.getElementById('fixed-card-title').value = card.title || '';
            document.getElementById('fixed-card-start-date').value = card.startDate || '';
            document.getElementById('fixed-card-end-date').value = card.endDate || '';

            modal.classList.add('visible');

            form.onsubmit = async (e) => {
                e.preventDefault();
                await saveFixedDateCard(cardId);
                modal.classList.remove('visible');
            };
        }

        async function saveFixedDateCard(cardId) {
            const title = document.getElementById('fixed-card-title').value;
            const startDate = document.getElementById('fixed-card-start-date').value;
            const endDate = document.getElementById('fixed-card-end-date').value;

            if (!title || !startDate || !endDate) {
                showErrorMessage("Erro", "Todos os campos s√£o obrigat√≥rios.");
                return;
            }

            const updatedCard = {
                id: cardId,
                title: title,
                startDate: startDate,
                endDate: endDate
            };

            const cardIndex = fixedDateCards.findIndex(c => c.id === cardId);
            if (cardIndex !== -1) {
                fixedDateCards[cardIndex] = updatedCard;
            }

            try {
                if (!db) {
                    localStorage.setItem('fixedDateCards', JSON.stringify(fixedDateCards));
                    renderFixedDateCards();
                    showSuccessMessage("Sucesso!", "Per√≠odo salvo com sucesso.");
                } else {
                    await setDoc(doc(db, `artifacts/${appId}/public/data/fixed-date-cards`, cardId), updatedCard);
                    showSuccessMessage("Sucesso!", "Per√≠odo salvo com sucesso.");
                }
            } catch (error) {
                console.error("Error saving fixed date card:", error);
                showErrorMessage("Erro", "Erro ao salvar per√≠odo: " + error.message);
            }
        }

        function closeFixedDateModal() {
            const modal = document.getElementById('fixed-date-card-modal');
            modal.classList.remove('visible');
        }


        // Expose function globally for onclick handlers
        window.deleteCalendarEvent = deleteCalendarEvent;
        window.updateTurmasList = updateTurmasList;
        window.updateVipsList = updateVipsList;
        window.openVipForm = openVipForm;
        window.openTurmaPefModal = openTurmaPefModal;
        window.openVipPefModal = openVipPefModal;
        window.openVipNotasModal = openVipNotasModal;
        window.openTurmaNotasModal = openTurmaNotasModal;
        window.openAlunoForm = openAlunoForm;
        window.openAlunoModal = openAlunoModal;
        window.openTurmaForm = openTurmaForm;
        window.savePefLesson = savePefLesson;
        window.openCampanhaForm = openCampanhaForm;
        window.openCampanhaModal = openCampanhaModal;
        window.addPasso = addPasso;
        window.addDocumento = addDocumento;
        window.openTaskForm = openTaskForm;
        window.openCollaboratorForm = openCollaboratorForm;
        window.openMonthlyHighlightForm = openMonthlyHighlightForm;
        window.openScheduleForm = openScheduleForm;
        window.openExpenseForm = openExpenseForm;
        window.safeDeleteItem = safeDeleteItem;
        window.closeFormModal = closeFormModal;
        window.openDojoCompetitorForm = openDojoCompetitorForm;
        window.openDojoPointsForm = openDojoPointsForm;
        window.openDojoMissionForm = openDojoMissionForm;
        window.exportVipPef = exportVipPef;
        window.exportTurmaPef = exportTurmaPef;
        window.exportStudentPef = exportStudentPef;
        window.exportStudentReportCardFromTurma = exportStudentReportCardFromTurma;
        window.deleteVip = deleteVip;
        window.deleteAllVips = deleteAllVips;

        // --- Guidelines Functions ---
        
        // Bulk import function for guidelines
        async function bulkImportGuidelines(guidelinesArray) {
            if (!Array.isArray(guidelinesArray)) {
                showErrorMessage("Erro", "Dados inv√°lidos para importa√ß√£o.");
                return;
            }

            let successCount = 0;
            let errorCount = 0;

            for (const guidelineData of guidelinesArray) {
                try {
                    const guideline = {
                        id: generateId(),
                        title: guidelineData.title || 'Sem t√≠tulo',
                        content: guidelineData.content || '',
                        category: guidelineData.category || 'geral',
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser
                    };

                    if (!db) {
                        // Local storage mode
                        let guidelines = JSON.parse(localStorage.getItem('guidelines') || '[]');
                        guidelines.push(guideline);
                        localStorage.setItem('guidelines', JSON.stringify(guidelines));
                    } else {
                        // Firebase mode
                        const docRef = doc(db, `artifacts/${appId}/public/data/guidelines`, guideline.id);
                        await setDoc(docRef, guideline);
                    }
                    
                    successCount++;
                } catch (error) {
                    console.error('Error importing guideline:', guidelineData.title, error);
                    errorCount++;
                }
            }

            // Reload guidelines after import
            
            // Show results
            if (errorCount === 0) {
                showSuccessMessage("Importa√ß√£o Conclu√≠da", `${successCount} itens importados com sucesso!`);
            } else {
                showErrorMessage("Importa√ß√£o Parcial", `${successCount} itens importados. ${errorCount} falharam.`);
            }
        }

        // Make it globally accessible for console usage
        window.bulkImportGuidelines = bulkImportGuidelines;

        // Migration function to move guidelines from localStorage to Firebase
        async function migrateGuidelinesToFirebase() {
            try {
                console.log('Starting guidelines migration to Firebase...');
                
                if (!db) {
                    console.error('Firebase not available for migration');
                    return false;
                }

                // Check if there are guidelines in localStorage
                const localGuidelines = localStorage.getItem('slap-guidelines');
                if (!localGuidelines) {
                    console.log('No guidelines found in localStorage to migrate');
                    return false;
                }

                const parsedGuidelines = JSON.parse(localGuidelines);
                console.log('Found guidelines in localStorage:', parsedGuidelines);

                // Save to Firebase
                const docRef = doc(db, `artifacts/${appId}/public/data`, 'guidelines');
                await setDoc(docRef, parsedGuidelines);
                console.log('Guidelines successfully migrated to Firebase');

                // Remove from localStorage after successful migration
                localStorage.removeItem('slap-guidelines');
                console.log('Guidelines removed from localStorage');

                return true;
            } catch (error) {
                console.error('Error migrating guidelines to Firebase:', error);
                return false;
            }
        }

        // Make migration function globally accessible
        window.migrateGuidelinesToFirebase = migrateGuidelinesToFirebase;





        function addPasso() {
            const container = document.getElementById('passos-container');
            const index = container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2';
            div.innerHTML = `
                <span class="text-sm text-stone-500 w-6">${index}.</span>
                <input type="text" class="form-input flex-1 passo-input" placeholder="Descreva este passo do processo">
                <button type="button" data-action="remove-passo" class="text-red-600 hover:text-red-800 p-1">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            `;
            container.appendChild(div);
            updatePassoNumbers();
        }

        function removePasso(button) {
            button.parentElement.remove();
            updatePassoNumbers();
        }

        function updatePassoNumbers() {
            const container = document.getElementById('passos-container');
            Array.from(container.children).forEach((child, index) => {
                const span = child.querySelector('span');
                if (span) span.textContent = `${index + 1}.`;
            });
        }

        function addDocumento() {
            const container = document.getElementById('documentos-container');
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2';
            div.innerHTML = `
                <input type="text" class="form-input flex-1 documento-input" placeholder="Nome do documento ou link do Cloudinary">
                <button type="button" data-action="remove-documento" class="text-red-600 hover:text-red-800 p-1">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            `;
            container.appendChild(div);
        }

        function removeDocumento(button) {
            button.parentElement.remove();
        }








        function renderGuidelineSection(type, items, container, paginationContainer, cardClass, iconColorClass) {
            const pagination = guidelinesPagination[type];
            const startIndex = (pagination.currentPage - 1) * pagination.itemsPerPage;
            const endIndex = startIndex + pagination.itemsPerPage;
            const itemsToShow = items.slice(startIndex, endIndex);
            const totalPages = Math.ceil(items.length / pagination.itemsPerPage);

            // Render items
            container.innerHTML = itemsToShow.map((item, index) => {
                const realIndex = startIndex + index;
                const iconPath = type === 'goodPractices' ? 'M5 13l4 4L19 7' : 'M6 18L18 6M6 6l12 12';

                return `
                    <div class="guideline-card ${cardClass}">
                        <div class="guideline-header">
                            <svg class="guideline-icon w-6 h-6 ${iconColorClass}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"></path>
                            </svg>
                            <div class="flex-1">
                                <h3 class="guideline-title">${item.title}</h3>
                            </div>
                            ${['admin', 'pedagogico', 'ap'].includes(currentUserRole) ? `
                            <button class="secondary-btn !text-xs !py-1 !px-2 ml-2" onclick="editGuidelineItem('${type}', ${realIndex})">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button class="danger-btn !text-xs !py-1 !px-2 ml-1" onclick="deleteGuidelineItem('${type}', ${realIndex})">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                            ` : ''}
                        </div>
                        <p class="guideline-description">${item.description}</p>
                    </div>
                `;
            }).join('');

            // Render pagination controls
            if (totalPages > 1) {
                paginationContainer.innerHTML = `
                    <div class="flex justify-center items-center gap-2">
                        <button 
                            class="pagination-btn ${pagination.currentPage === 1 ? 'disabled' : ''}" 
                            onclick="changeGuidelinePage('${type}', ${pagination.currentPage - 1})"
                            ${pagination.currentPage === 1 ? 'disabled' : ''}>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                            </svg>
                        </button>

                        <div class="flex gap-1">
                            ${Array.from({length: totalPages}, (_, i) => i + 1).map(page => `
                                <button 
                                    class="pagination-number ${page === pagination.currentPage ? 'active' : ''}"
                                    onclick="changeGuidelinePage('${type}', ${page})">
                                    ${page}
                                </button>
                            `).join('')}
                        </div>

                        <button 
                            class="pagination-btn ${pagination.currentPage === totalPages ? 'disabled' : ''}" 
                            onclick="changeGuidelinePage('${type}', ${pagination.currentPage + 1})"
                            ${pagination.currentPage === totalPages ? 'disabled' : ''}>
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="text-center text-sm text-stone-500 mt-2">
                        Mostrando ${Math.min(startIndex + 1, items.length)}-${Math.min(endIndex, items.length)} de ${items.length} itens
                    </div>
                `;
            } else {
                paginationContainer.innerHTML = '';
            }
        }

        function changeGuidelinePage(type, newPage) {
            const pagination = guidelinesPagination[type];
            const filteredItems = type === 'goodPractices' ? 
                guidelines.goodPractices.filter(item => 
                    item.title.toLowerCase().includes(document.getElementById('guidelines-search').value.toLowerCase()) || 
                    item.description.toLowerCase().includes(document.getElementById('guidelines-search').value.toLowerCase())
                ) :
                guidelines.prohibitedItems.filter(item => 
                    item.title.toLowerCase().includes(document.getElementById('guidelines-search').value.toLowerCase()) || 
                    item.description.toLowerCase().includes(document.getElementById('guidelines-search').value.toLowerCase())
                );

            const totalPages = Math.ceil(filteredItems.length / pagination.itemsPerPage);

            if (newPage >= 1 && newPage <= totalPages) {
                pagination.currentPage = newPage;
                renderGuidelines(document.getElementById('guidelines-search').value);
            }
        }




        function openGuidelineForm(type = null, index = null) {
            const modal = document.getElementById('guideline-modal');
            const form = document.getElementById('guideline-form');
            const title = document.getElementById('guideline-modal-title');
            
            // Reset form
            form.reset();
            
            if (type !== null && index !== null) {
                // Edit mode
                title.textContent = 'Editar Diretriz';
                const guidelineType = type === 'goodPractices' ? 'good-practice' : 'prohibited';
                const item = guidelines[type][index];
                
                document.getElementById('guideline-type').value = guidelineType;
                document.getElementById('guideline-title').value = item.title;
                document.getElementById('guideline-description').value = item.description;
                
                // Store edit info for saving
                form.dataset.editType = type;
                form.dataset.editIndex = index;
            } else {
                // Add mode
                title.textContent = 'Nova Diretriz';
                delete form.dataset.editType;
                delete form.dataset.editIndex;
            }

            // Add submit event listener
            form.onsubmit = (e) => {
                e.preventDefault();
                saveGuideline(e);
            };

            modal.classList.add('visible');
        }

        // Legacy function kept for compatibility - redirects to new function





        // --- BRAINFLIP GAME SECTION ---
        const flashcardsData = [
            { front: "Teacher Talking Time (TTT)", back: "O tempo que o professor fala durante a aula. O ideal √© minimiz√°-lo para maximizar o STT." },
            { front: "Student Talking Time (STT)", back: "O tempo que os alunos falam durante a aula. Um indicador chave de engajamento e pr√°tica." },
            { front: "Lexical Approach", back: "Metodologia que foca no ensino de 'chunks' de linguagem (collocations, fixed expressions) em vez de palavras isoladas." },
            { front: "Comprehensible Input", back: "Linguagem que os alunos conseguem entender, mesmo que contenha estruturas novas (i + 1, segundo Krashen)." },
            { front: "Teoria de Krashen", back: "Cinco hip√≥teses sobre a aquisi√ß√£o de segunda l√≠ngua: Aquisi√ß√£o-Aprendizagem, Monitor, Ordem Natural, Input e Filtro Afetivo." },
            { front: "Scaffolding", back: "Suporte tempor√°rio dado pelo professor para ajudar o aluno a realizar uma tarefa que ele n√£o faria sozinho, removido gradualmente." },
            { front: "Error Correction", back: "Estrat√©gias para corrigir erros dos alunos, que podem ser diretas, indiretas, recasts, elicitation, etc., dependendo do est√°gio do erro." },
            { front: "CEFR (Common European Framework of Reference)", back: "Padr√£o internacional para descrever habilidades lingu√≠sticas, com n√≠veis de A1 a C2 (B√°sico, Independente, Proficiente)." },
            { front: "PPP vs. TBL", back: "PPP √© uma abordagem linear (apresenta, pratica, produz). TBL √© mais comunicativa, focando em tarefas com um objetivo real." },
            { front: "Task-Based Learning (TBL)", back: "Abordagem onde a aprendizagem ocorre atrav√©s da realiza√ß√£o de tarefas significativas que envolvem a comunica√ß√£o real da l√≠ngua." },
            { front: "Dogme", back: "Abordagem de ensino 'unplugged', que minimiza materiais pr√©-fabricados e foca na linguagem emergente dos alunos." },
            { front: "Formative Assessment", back: "Avalia√ß√£o cont√≠nua realizada durante o processo de aprendizagem para monitorar o progresso e fornecer feedback." },
            { front: "Andragogia", back: "Princ√≠pios da educa√ß√£o de adultos, que se diferenciam da pedagogia (educa√ß√£o de crian√ßas) pela autonomia e experi√™ncia do aprendiz." },
            { front: "Metodologia ativa", back: "Abordagens de ensino que colocam o aluno no centro do processo, tornando-o protagonista da sua aprendizagem (ex: Aprendizagem Baseada em Projetos)." },
            { front: "Ensino h√≠brido (Blended Learning)", back: "Combina√ß√£o de ensino presencial e online, utilizando diferentes modalidades para otimizar a aprendizagem." },
            { front: "CLIL (Content and Language Integrated Learning)", back: "Ensino de uma disciplina (ex: hist√≥ria, ci√™ncias) atrav√©s de uma l√≠ngua estrangeira, desenvolvendo conte√∫do e habilidades lingu√≠sticas simultaneamente." },
            { front: "Warm-ups", back: "Atividades curtas no in√≠cio da aula para engajar os alunos, ativar conhecimentos pr√©vios e prepar√°-los para o tema." },
            { front: "Cool downs", back: "Atividades no final da aula para revisar o conte√∫do, consolidar a aprendizagem ou relaxar e refletir." },
            { front: "ICQs / CCQs", back: "Perguntas curtas para verificar se os alunos entenderam as instru√ß√µes (ICQs) ou o conceito (CCQs) apresentado." },
            { front: "Autonomy in Learning", back: "Capacidade do aluno de tomar controle de sua pr√≥pria aprendizagem, definindo metas e escolhendo m√©todos." }
        ];

        let currentCardIndex = 0;
        let isFlipped = false;

        function renderBrainFlipSection() {
            document.getElementById('main-title').textContent = 'BrainFlip';
            document.getElementById('main-description').textContent = 'Flashcards pedag√≥gicos para professores de ingl√™s. Clique nas cartas para virar e aprender!';

            contentArea.innerHTML = `
                <section class="bg-white p-6 rounded-xl shadow-sm border border-stone-200 flex flex-col items-center justify-center min-h-[70vh]">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-blue-700 mb-8 mt-4 text-center">BrainFlip</h1>
                    <p class="text-lg text-stone-700 mb-8 text-center max-w-2xl">
                        Um jogo interativo de flashcards pedag√≥gicos para professores de ingl√™s. Clique nas cartas para virar e aprender!
                    </p>

                    <div class="flashcard-container mb-8">
                        <div id="flashcard" class="flashcard cursor-pointer" onclick="flipCard()">
                            <div id="flashcard-front" class="flashcard-face flashcard-front"></div>
                            <div id="flashcard-back" class="flashcard-face flashcard-back"></div>
                        </div>
                    </div>

                    <div class="flex items-center justify-center space-x-4 mb-8">
                        <button id="prev-btn" class="navigation-button-game" onclick="previousCard()">
                            Anterior
                        </button>
                        <span id="card-counter" class="text-xl font-semibold text-stone-800">1 / ${flashcardsData.length}</span>
                        <button id="next-btn" class="navigation-button-game" onclick="nextCard()">
                            Pr√≥ximo
                        </button>
                    </div>
                </section>
            `;

            loadCard(0);
        }

        function loadCard(index) {
            currentCardIndex = index;
            isFlipped = false;

            const flashcard = document.getElementById('flashcard');
            const front = document.getElementById('flashcard-front');
            const back = document.getElementById('flashcard-back');
            const counter = document.getElementById('card-counter');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');

            // Reset flip state
            flashcard.classList.remove('flipped');

            // Load content
            front.textContent = flashcardsData[index].front;
            back.textContent = flashcardsData[index].back;

            // Update counter
            counter.textContent = `${index + 1} / ${flashcardsData.length}`;

            // Update button states
            prevBtn.disabled = index === 0;
            nextBtn.disabled = index === flashcardsData.length - 1;
        }

        function flipCard() {
            const flashcard = document.getElementById('flashcard');
            flashcard.classList.toggle('flipped');
            isFlipped = !isFlipped;
        }

        function nextCard() {
            if (currentCardIndex < flashcardsData.length - 1) {
                loadCard(currentCardIndex + 1);
            }
        }

        function previousCard() {
            if (currentCardIndex > 0) {
                loadCard(currentCardIndex - 1);
            }
        }

        async function saveGuideline(event) {
            event.preventDefault();
            
            const form = event.target;
            const type = document.getElementById('guideline-type').value;
            const title = document.getElementById('guideline-title').value;
            const description = document.getElementById('guideline-description').value;

            const guidelineData = {
                title: title,
                description: description
            };
            
            if (form.dataset.editType && form.dataset.editIndex !== undefined) {
                // Edit mode
                const editIndex = parseInt(form.dataset.editIndex);
                guidelines[form.dataset.editType][editIndex] = {
                    ...guidelines[form.dataset.editType][editIndex],
                    ...guidelineData
                };
                showSuccessMessage("Sucesso!", "Diretriz atualizada com sucesso.");
            } else {
                // Add mode
                const newGuideline = {
                    id: Date.now().toString(),
                    ...guidelineData
                };
                
                if (type === 'good-practice') {
                    guidelines.goodPractices.push(newGuideline);
                } else {
                    guidelines.prohibitedItems.push(newGuideline);
                }
                showSuccessMessage("Sucesso!", "Diretriz adicionada com sucesso.");
            }

            await saveGuidelines();
            renderGuidelines(document.getElementById('guidelines-search').value);

            // Close modal and reset form
            document.getElementById('guideline-modal').classList.remove('visible');
            document.getElementById('guideline-form').reset();
        }

        function exportAlunosDoc() {
            const canViewFinancialInfo = canViewStudentFinancials();
            const allStudents = students.sort((a, b) => a.name.localeCompare(b.name));
            
            const activeCount = allStudents.filter(s => s.status === 'Ativo').length;
            const vipCount = allStudents.filter(s => s.modalidade === 'VIP').length;
            const turmaCount = allStudents.filter(s => s.modalidade === 'TURMA').length;
            
            // Calculate age from birthDate
            function calculateAge(birthDate) {
                if (!birthDate) return '-';
                const birth = new Date(birthDate);
                const today = new Date();
                let age = today.getFullYear() - birth.getFullYear();
                const monthDiff = today.getMonth() - birth.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                    age--;
                }
                return age;
            }
            
            let studentsList = '';
            if (canViewFinancialInfo) {
                studentsList = allStudents.map((s, index) => `
                    <tr>
                        <td class="number">${index + 1}</td>
                        <td class="student-name">${s.name}</td>
                        <td>${s.status || '-'}</td>
                        <td>${s.modalidade || 'TURMA'}</td>
                        <td>${s.level || '-'}</td>
                        <td>R$ ${parseFloat(s.amountPaid || 0).toFixed(2)}</td>
                        <td>${s.responsibleName || '-'}</td>
                        <td>${s.responsiblePhone || '-'}</td>
                        <td>${s.responsibleEmail || '-'}</td>
                        <td>${calculateAge(s.birthDate)}</td>
                        <td>${s.birthDate ? formatDateBR(s.birthDate) : '-'}</td>
                        <td>${s.endereco || '-'}</td>
                    </tr>
                `).join('');
            } else {
                studentsList = allStudents.map((s, index) => `
                    <tr>
                        <td class="number">${index + 1}</td>
                        <td class="student-name">${s.name}</td>
                        <td>${s.status || '-'}</td>
                        <td>${s.modalidade || 'TURMA'}</td>
                        <td>${s.level || '-'}</td>
                        <td>${s.responsibleName || '-'}</td>
                        <td>${s.responsiblePhone || '-'}</td>
                        <td>${s.responsibleEmail || '-'}</td>
                        <td>${calculateAge(s.birthDate)}</td>
                        <td>${s.birthDate ? formatDateBR(s.birthDate) : '-'}</td>
                        <td>${s.endereco || '-'}</td>
                    </tr>
                `).join('');
            }
            
            if (!studentsList) { 
                studentsList = `<tr><td colspan="${canViewFinancialInfo ? '12' : '11'}" style="text-align: center; color: #999;">Nenhum aluno encontrado.</td></tr>`; 
            }

            const docHtml = `
                <!DOCTYPE html>
                <html lang="pt-br">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Lista de Alunos - SLAP</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { 
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                            line-height: 1.6; 
                            color: #333; 
                            background-color: #f8f9fa;
                        }
                        .container {
                            max-width: 1400px;
                            margin: 0 auto;
                            background: white;
                            min-height: 100vh;
                        }
                        .header {
                            background: linear-gradient(135deg, #F1D24B 0%, #E8C547 100%);
                            color: #333;
                            padding: 2rem;
                            text-align: center;
                            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                        }
                        .header h1 {
                            font-size: 2rem;
                            font-weight: 700;
                            margin-bottom: 0.5rem;
                        }
                        .header p {
                            font-size: 1rem;
                            color: #555;
                        }
                        .summary {
                            padding: 1.5rem 2rem;
                            background-color: #fff;
                            border-bottom: 3px solid #F1D24B;
                            display: flex;
                            justify-content: center;
                            gap: 3rem;
                            flex-wrap: wrap;
                        }
                        .summary-item {
                            text-align: center;
                        }
                        .summary-item .number {
                            font-size: 1.8rem;
                            font-weight: 700;
                            color: #F1D24B;
                        }
                        .summary-item .label {
                            font-size: 0.9rem;
                            color: #666;
                        }
                        .content {
                            padding: 2rem;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            font-size: 0.85rem;
                        }
                        thead {
                            background-color: #333;
                            color: white;
                        }
                        th { 
                            padding: 12px 8px;
                            text-align: left;
                            font-weight: 600;
                            border: 1px solid #ddd;
                        }
                        td { 
                            padding: 10px 8px;
                            border: 1px solid #ddd;
                            text-align: left;
                        }
                        tbody tr:nth-child(even) {
                            background-color: #f8f9fa;
                        }
                        tbody tr:hover {
                            background-color: #fff8e1;
                        }
                        .number {
                            font-weight: 700;
                            color: #666;
                            text-align: center;
                        }
                        .student-name { 
                            font-weight: 600;
                            color: #333;
                        }
                        .footer {
                            text-align: center;
                            padding: 1.5rem;
                            background-color: #f8f9fa;
                            color: #666;
                            font-size: 0.85rem;
                            border-top: 2px solid #ddd;
                        }
                        @media print {
                            body { margin: 0; padding: 0; background: white; }
                            .container { box-shadow: none; }
                            table { font-size: 0.75rem; page-break-inside: auto; }
                            tr { page-break-inside: avoid; page-break-after: auto; }
                            thead { display: table-header-group; }
                            th, td { padding: 6px 4px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>Lista de Alunos - SLAP</h1>
                            <p>Speaking Like a Pro ‚Ä¢ Exportado em ${formatDateBR(new Date())}</p>
                        </div>
                        
                        <div class="summary">
                            <div class="summary-item">
                                <div class="number">${allStudents.length}</div>
                                <div class="label">Total de Alunos</div>
                            </div>
                            <div class="summary-item">
                                <div class="number">${activeCount}</div>
                                <div class="label">Alunos Ativos</div>
                            </div>
                            <div class="summary-item">
                                <div class="number">${vipCount}</div>
                                <div class="label">VIPs</div>
                            </div>
                            <div class="summary-item">
                                <div class="number">${turmaCount}</div>
                                <div class="label">Turmas</div>
                            </div>
                        </div>
                        
                        <div class="content">
                            <table>
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">#</th>
                                        <th>Nome Completo</th>
                                        <th>Status</th>
                                        <th>Modalidade</th>
                                        <th>N√≠vel</th>
                                        ${canViewFinancialInfo ? '<th>Valor Pago</th>' : ''}
                                        <th>Respons√°vel</th>
                                        <th>Telefone</th>
                                        <th>Email</th>
                                        <th>Idade</th>
                                        <th>Data Nasc.</th>
                                        <th>Endere√ßo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${studentsList}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="footer">
                            Documento gerado automaticamente pelo Hub SLAP
                        </div>
                    </div>
                </body>
                </html>
            `;

            openHtmlInNewWindow("Lista de Alunos - SLAP", docHtml);
        }

        function exportGuidelinesDoc() {
            // Get all guidelines data
            let allGuidelines = [];
            
            // Add good practices
            if (guidelines.goodPractices && guidelines.goodPractices.length > 0) {
                allGuidelines = allGuidelines.concat(
                    guidelines.goodPractices.map(g => ({...g, type: 'Boa Pr√°tica', typeClass: 'good-practice'}))
                );
            }
            
            // Add prohibited items
            if (guidelines.prohibitedItems && guidelines.prohibitedItems.length > 0) {
                allGuidelines = allGuidelines.concat(
                    guidelines.prohibitedItems.map(g => ({...g, type: 'Item Proibido', typeClass: 'prohibited'}))
                );
            }

            // Sort alphabetically by title
            allGuidelines.sort((a, b) => a.title.localeCompare(b.title));

            let guidelinesList = '';
            if (allGuidelines.length > 0) {
                guidelinesList = allGuidelines.map(g => `
                    <tr class="${g.typeClass}">
                        <td class="guideline-type">${g.type}</td>
                        <td class="guideline-title">${g.title}</td>
                        <td class="guideline-description">${g.description}</td>
                    </tr>
                `).join('');
            } else {
                guidelinesList = '<tr><td colspan="3">Nenhuma diretriz encontrada.</td></tr>';
            }

            const docHtml = `
                <!DOCTYPE html>
                <html lang="pt-br">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Documento SLAP</title>
                    <style>
                        body { font-family: 'Arial', sans-serif; margin: 20px; line-height: 1.6; }
                        h1 { color: #333; text-align: center; margin-bottom: 30px; }
                        .header-info { text-align: center; margin-bottom: 30px; color: #666; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ccc; padding: 12px; text-align: left; vertical-align: top; }
                        th { background-color: #f2f2f2; font-weight: bold; }
                        .guideline-type { font-weight: bold; text-align: center; width: 120px; }
                        .guideline-title { font-weight: bold; width: 200px; }
                        .guideline-description { line-height: 1.5; }
                        .good-practice .guideline-type { color: #10B981; }
                        .prohibited .guideline-type { color: #EF4444; }
                        .good-practice { border-left: 4px solid #10B981; }
                        .prohibited { border-left: 4px solid #EF4444; }
                        .section-break { margin: 40px 0; text-align: center; color: #666; }
                        @media print {
                            body { margin: 10px; }
                            table { font-size: 12px; }
                            th, td { padding: 8px; }
                        }
                    </style>
                </head>
                <body>
                    <h1>Documento SLAP</h1>
                    <div class="header-info">
                        <p>Data de Exporta√ß√£o: ${formatDateBR(new Date())}</p>
                        <p>Total de Itens: ${allGuidelines.length}</p>
                        <p>Itens: ${guidelines.goodPractices ? guidelines.goodPractices.length : 0}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>T√≠tulo</th>
                                <th>Descri√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${guidelinesList}
                        </tbody>
                    </table>
                    <div style="margin-top: 30px; text-align: center; color: #666; font-size: 12px;">
                        <p>Documento gerado pelo Hub SLAP - Speaking Like a Pro</p>
                        <p>Este documento cont√©m informa√ß√µes oficiais da escola.</p>
                    </div>
                </body>
                </html>
            `;

            openHtmlInNewWindow("Documento SLAP", docHtml);
        }

        function openVipNotasModal(vipId) {
            const vip = vips.find(v => v.id === vipId);
            if (!vip) { showErrorMessage("Erro", "Aluno VIP n√£o encontrado."); return; }
            const student = students.find(s => s.id === vip.studentId);
            if (!student) { showErrorMessage("Erro", "Dados do aluno n√£o encontrados."); return; }

            clearModalHeaderButtons();
            const modalTitle = document.getElementById('form-modal-title');
            modalTitle.textContent = `Notas: ${student.name}`;
            
            // Load existing grades or set defaults
            const grades = vip.grades || {
                midtermTest: 0,
                listeningTest: 0,
                grammarTest: 0,
                oralTest: 0,
                participacao: 0,
                assiduidade: 0
            };
            
            // Auto-calculate attendance for VIP - calculate and display, but only auto-fill if no manual value exists
            const autoAttendance = calculateVipAttendanceScore(vip.id);
            // Only auto-fill if assiduidade is 0 or empty (not manually set) - normalize to number for proper comparison
            const currentAttendance = Number(grades.assiduidade) || 0;
            if (autoAttendance !== null && currentAttendance === 0) {
                grades.assiduidade = autoAttendance;
            }

            document.getElementById('form-modal-content-area').innerHTML = `
                <form id="notas-form" class="space-y-4">
                    <input type="hidden" id="vip-id" value="${vipId}">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="font-medium text-sm">Midterm Test (0-20)</label>
                            <input type="number" id="midterm-test" class="form-input" min="0" max="20" step="any" value="${grades.midtermTest}">
                        </div>
                        <div>
                            <label class="font-medium text-sm">Listening Test (0-20)</label>
                            <input type="number" id="listening-test" class="form-input" min="0" max="20" step="any" value="${grades.listeningTest}">
                        </div>
                        <div>
                            <label class="font-medium text-sm">Grammar Test (0-20)</label>
                            <input type="number" id="grammar-test" class="form-input" min="0" max="20" step="any" value="${grades.grammarTest}">
                        </div>
                        <div>
                            <label class="font-medium text-sm">Oral Test (0-20)</label>
                            <input type="number" id="oral-test" class="form-input" min="0" max="20" step="any" value="${grades.oralTest}">
                        </div>
                        <div>
                            <label class="font-medium text-sm">Participa√ß√£o (0-10)</label>
                            <input type="number" id="participacao" class="form-input" min="0" max="10" step="any" value="${grades.participacao}">
                        </div>
                        <div>
                            <label class="font-medium text-sm">Assiduidade (0-10) - Autom√°tico</label>
                            <input type="number" id="assiduidade" class="form-input bg-gray-100" min="0" max="10" step="any" value="${grades.assiduidade}" readonly
                                   title="Calculado automaticamente baseado nas presen√ßas registradas no PEF. N√£o pode ser editado manualmente.">
                        </div>
                    </div>
                    
                    <div class="mt-6 p-4 bg-stone-50 rounded-lg">
                        <div class="flex justify-between items-center">
                            <span class="font-semibold">Total:</span>
                            <span id="total-score" class="text-xl font-bold">0</span>
                        </div>
                        <div class="mt-2">
                            <span id="approval-status" class="font-medium"></span>
                        </div>
                        <div class="text-sm text-stone-600 mt-1">
                            Necess√°rio 70 pontos para aprova√ß√£o
                        </div>
                        ${autoAttendance !== null ? `
                        <div class="mt-3 p-2 bg-blue-50 border border-blue-200 rounded text-sm">
                            <div class="flex items-center gap-2 text-blue-800">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="font-medium">Assiduidade Calculada Automaticamente: ${autoAttendance.toFixed(1)}</span>
                            </div>
                            <div class="text-blue-700 mt-1">
                                Baseado no registro de presen√ßas no PEF. Valor somente leitura.
                            </div>
                        </div>` : ''}
                    </div>
                    
                    <div class="flex justify-between gap-2">
                        <button type="button" id="export-vip-btn" data-vip-id="${vipId}" class="secondary-btn">Exportar Report Card</button>
                        <div class="flex gap-2">
                            <button type="button" data-action="close-modal" class="secondary-btn">Cancelar</button>
                            <button type="submit" class="primary-btn">Salvar Notas</button>
                        </div>
                    </div>
                </form>
            `;
            
            // Add event listeners to calculate total in real time
            setTimeout(() => {
                const inputs = ['midterm-test', 'listening-test', 'grammar-test', 'oral-test', 'participacao', 'assiduidade'];
                inputs.forEach(inputId => {
                    document.getElementById(inputId).addEventListener('input', calculateTotal);
                });
                calculateTotal(); // Initial calculation
            }, 100);

            document.getElementById('notas-form').onsubmit = saveVipGrades;
            
            // Add export button event listener
            setTimeout(() => {
                const exportBtn = document.getElementById('export-vip-btn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => {
                        exportVipReportCard(exportBtn.dataset.vipId);
                    });
                }
            }, 100);
            
            document.getElementById('form-modal').classList.add('visible');
        }

        function openTurmaNotasModal(turmaId) {
            const turma = turmas.find(t => t.id === turmaId);
            if (!turma) { showErrorMessage("Erro", "Turma n√£o encontrada."); return; }

            clearModalHeaderButtons();
            const modalHeader = document.getElementById('modal-header-container');
            const modalTitle = document.getElementById('form-modal-title');
            modalTitle.textContent = `Notas: ${turma.name}`;
            
            // Get students in this class (only TURMA modality)
            const turmaStudents = students.filter(s => 
                (turma.studentIds || []).includes(s.id) && s.modalidade === 'TURMA'
            );

            // Add export buttons to modal header
            const exportButton = document.createElement('button');
            exportButton.className = 'secondary-btn w-auto';
            exportButton.textContent = 'Exportar RC Completo';
            exportButton.id = 'export-turma-btn';
            exportButton.dataset.turmaId = turmaId;
            modalHeader.insertBefore(exportButton, modalHeader.querySelector('.modal-close-btn'));

            // Dropdown de exporta√ß√£o individual por aluno
            const exportStudentDropdown = document.createElement('div');
            exportStudentDropdown.className = 'relative inline-block ml-2';
            exportStudentDropdown.innerHTML = `
                <button type="button" class="secondary-btn w-auto dropdown-toggle" id="export-student-btn-${turmaId}">
                    Exportar Aluno
                    <svg class="w-4 h-4 ml-2 inline" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
                <div class="dropdown-menu absolute left-0 mt-2 w-56 bg-white border border-gray-200 rounded-lg shadow-lg z-50 hidden" id="export-student-menu-${turmaId}">
                    ${turmaStudents.map(student => `
                        <button type="button" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded" 
                                data-action="export-student-report-card" 
                                data-turma-id="${turmaId}" 
                                data-student-id="${student.id}">
                            ${student.name}
                        </button>
                    `).join('')}
                </div>
            `;
            modalHeader.insertBefore(exportStudentDropdown, modalHeader.querySelector('.modal-close-btn'));

            // Add JavaScript for dropdown
            setTimeout(() => {
                const dropdownBtn = document.getElementById(`export-student-btn-${turmaId}`);
                const dropdownMenu = document.getElementById(`export-student-menu-${turmaId}`);
                
                if (dropdownBtn && dropdownMenu) {
                    dropdownBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        dropdownMenu.classList.toggle('hidden');
                    });
                    
                    // Close dropdown when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!exportStudentDropdown.contains(e.target)) {
                            dropdownMenu.classList.add('hidden');
                        }
                    });
                }
            }, 100);

            document.getElementById('form-modal-content-area').innerHTML = `
                <div class="space-y-6 max-h-96 overflow-y-auto">
                    <input type="hidden" id="turma-id" value="${turmaId}">
                    
                    ${turmaStudents.length === 0 ? `
                        <div class="text-center py-8 text-stone-500">
                            Nenhum aluno encontrado nesta turma.
                        </div>
                    ` : turmaStudents.map(student => {
                        const grades = (turma.studentGrades && turma.studentGrades[student.id]) || {
                            midtermTest: 0,
                            listeningTest: 0,
                            grammarTest: 0,
                            oralTest: 0,
                            participacao: 0,
                            assiduidade: 0
                        };
                        
                        // Auto-calculate attendance score - calculate and display, but only auto-fill if no manual value exists
                        const autoAttendance = calculateAttendanceScore(student.id, turmaId);
                        // Only auto-fill if assiduidade is 0 or empty (not manually set) - normalize to number for proper comparison
                        const currentAttendance = Number(grades.assiduidade) || 0;
                        if (autoAttendance !== null && currentAttendance === 0) {
                            grades.assiduidade = autoAttendance;
                        }
                        
                        return `
                        <div class="border border-stone-200 rounded-lg p-4">
                            <h4 class="font-semibold text-lg mb-4">${student.name}</h4>
                            
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="font-medium text-sm">Midterm Test (0-20)</label>
                                    <input type="number" id="midterm-${student.id}" class="form-input student-grade" min="0" max="20" step="any" value="${grades.midtermTest}" data-student="${student.id}">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Listening Test (0-20)</label>
                                    <input type="number" id="listening-${student.id}" class="form-input student-grade" min="0" max="20" step="any" value="${grades.listeningTest}" data-student="${student.id}">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Grammar Test (0-20)</label>
                                    <input type="number" id="grammar-${student.id}" class="form-input student-grade" min="0" max="20" step="any" value="${grades.grammarTest}" data-student="${student.id}">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Oral Test (0-20)</label>
                                    <input type="number" id="oral-${student.id}" class="form-input student-grade" min="0" max="20" step="any" value="${grades.oralTest}" data-student="${student.id}">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Participa√ß√£o (0-10)</label>
                                    <input type="number" id="participacao-${student.id}" class="form-input student-grade" min="0" max="10" step="any" value="${grades.participacao}" data-student="${student.id}">
                                </div>
                                <div>
                                    <label class="font-medium text-sm">Assiduidade (0-10) - Autom√°tico</label>
                                    <input type="number" id="assiduidade-${student.id}" class="form-input student-grade bg-gray-100" min="0" max="10" step="any" value="${grades.assiduidade}" data-student="${student.id}" readonly
                                           title="Calculado automaticamente baseado nas presen√ßas registradas no PEF. N√£o pode ser editado manualmente.">
                                </div>
                            </div>
                            
                            <div class="p-3 bg-stone-50 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <span class="font-semibold">Total:</span>
                                    <span id="total-${student.id}" class="text-xl font-bold">0</span>
                                </div>
                                <div class="mt-1">
                                    <span id="status-${student.id}" class="font-medium"></span>
                                </div>

                            </div>
                        </div>
                        `;
                    }).join('')}
                    
                    ${turmaStudents.some(s => {
                        const autoAttendance = calculateAttendanceScore(s.id, turmaId);
                        return autoAttendance !== null;
                    }) ? `
                    <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-center gap-2 text-blue-800">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="font-medium">Sistema de Assiduidade Autom√°tica Ativo</span>
                        </div>
                        <div class="text-blue-700 mt-1">
                            As notas de assiduidade s√£o calculadas automaticamente baseadas no registro de presen√ßas no PEF. 
                            Valores somente leitura.
                        </div>
                    </div>` : ''}
                    
                    <div class="flex justify-end gap-2 pt-4 border-t">
                        <button type="button" data-action="close-modal" class="secondary-btn">Cancelar</button>
                        <button type="button" onclick="saveTurmaGrades()" class="primary-btn">Salvar Todas as Notas</button>
                    </div>
                </div>
            `;
            
            // Add event listeners to calculate totals in real time
            setTimeout(() => {
                document.querySelectorAll('.student-grade').forEach(input => {
                    input.addEventListener('input', (e) => {
                        const studentId = e.target.dataset.student;
                        calculateStudentTotal(studentId);
                    });
                });
                
                // Initial calculations for all students
                turmaStudents.forEach(student => {
                    calculateStudentTotal(student.id);
                });
                
                // Add export button event listener
                const exportBtn = document.getElementById('export-turma-btn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => {
                        exportTurmaReportCard(exportBtn.dataset.turmaId);
                    });
                }
            }, 100);

            document.getElementById('form-modal').classList.add('visible');
        }

        function calculateTotal() {
            const midtermEl = document.getElementById('midterm-test');
            const listeningEl = document.getElementById('listening-test');
            const grammarEl = document.getElementById('grammar-test');
            const oralEl = document.getElementById('oral-test');
            const participacaoEl = document.getElementById('participacao');
            const assiduidadeEl = document.getElementById('assiduidade');

            const midterm = parseFloat(midtermEl.value) || 0;
            const listening = parseFloat(listeningEl.value) || 0;
            const grammar = parseFloat(grammarEl.value) || 0;
            const oral = parseFloat(oralEl.value) || 0;
            const participacao = parseFloat(participacaoEl.value) || 0;
            const assiduidade = parseFloat(assiduidadeEl.value) || 0;

            // Check if any field is empty or zero
            const hasEmptyFields = !midtermEl.value || !listeningEl.value || !grammarEl.value || 
                                 !oralEl.value || !participacaoEl.value || !assiduidadeEl.value;

            const total = midterm + listening + grammar + oral + participacao + assiduidade;
            
            document.getElementById('total-score').textContent = total.toFixed(1);
            
            const statusElement = document.getElementById('approval-status');
            if (hasEmptyFields) {
                statusElement.textContent = '‚è≥ PENDENTE';
                statusElement.className = 'font-medium text-yellow-600';
            } else if (total >= 70) {
                statusElement.textContent = '‚úì APROVADO';
                statusElement.className = 'font-medium text-green-600';
            } else {
                statusElement.textContent = '‚úó REPROVADO';
                statusElement.className = 'font-medium text-red-600';
            }
        }

        function calculateAttendanceScore(studentId, turmaId) {
            // Find attendance record for this turma
            const unitAttendance = attendance.find(a => a.id === turmaId);
            if (!unitAttendance || !unitAttendance.lessons) {
                return null; // No attendance data available
            }
            
            let totalLessons = 0;
            let presentLessons = 0;
            
            // Count all lessons that have been registered
            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance.lessons[i];
                if (lessonData && lessonData.students && lessonData.students[studentId]) {
                    totalLessons++;
                    const status = lessonData.students[studentId];
                    // Count P (Presente) and PP (Presen√ßa Parcial) as attendance
                    if (status === 'P' || status === 'PP') {
                        presentLessons++;
                    }
                    // PP counts as 0.5 attendance
                    if (status === 'PP') {
                        presentLessons -= 0.5;
                    }
                }
            }
            
            if (totalLessons === 0) {
                return null; // No lessons registered yet
            }
            
            // Calculate attendance percentage and convert to 0-10 scale
            const attendancePercentage = presentLessons / totalLessons;
            const attendanceScore = Math.round(attendancePercentage * 10 * 10) / 10; // Round to 1 decimal
            
            return Math.min(10, Math.max(0, attendanceScore)); // Ensure within 0-10 range
        }

        function calculateVipAttendanceScore(vipId) {
            // Find attendance record for this VIP
            const unitAttendance = attendance.find(a => a.id === vipId);
            if (!unitAttendance || !unitAttendance.lessons) {
                return null; // No attendance data available
            }
            
            let totalLessons = 0;
            let presentLessons = 0;
            
            // Count all lessons that have been registered for VIP
            for (let i = 1; i <= 40; i++) {
                const lessonData = unitAttendance.lessons[i];
                if (lessonData && lessonData.date) { // VIP lessons with date are considered registered
                    totalLessons++;
                    
                    // Check the actual status - VIPs use same structure as turmas but simpler
                    const status = lessonData.status;
                    if (status === 'P') {
                        presentLessons++;
                    } else if (status === 'PP') {
                        presentLessons += 0.5; // Partial presence counts as 0.5
                    }
                    // 'F' or undefined counts as 0 (absent)
                }
            }
            
            if (totalLessons === 0) {
                return null; // No lessons registered yet
            }
            
            // Calculate attendance percentage and convert to 0-10 scale
            const attendancePercentage = presentLessons / totalLessons;
            const attendanceScore = Math.round(attendancePercentage * 10 * 10) / 10; // Round to 1 decimal
            
            console.log(`VIP ${vipId}: ${presentLessons}/${totalLessons} = ${attendancePercentage.toFixed(2)} = ${attendanceScore}`);
            
            return Math.min(10, Math.max(0, attendanceScore)); // Ensure within 0-10 range
        }

        function calculateStudentTotal(studentId) {
            const midtermEl = document.getElementById(`midterm-${studentId}`);
            const listeningEl = document.getElementById(`listening-${studentId}`);
            const grammarEl = document.getElementById(`grammar-${studentId}`);
            const oralEl = document.getElementById(`oral-${studentId}`);
            const participacaoEl = document.getElementById(`participacao-${studentId}`);
            const assiduidadeEl = document.getElementById(`assiduidade-${studentId}`);

            const midterm = parseFloat(midtermEl.value) || 0;
            const listening = parseFloat(listeningEl.value) || 0;
            const grammar = parseFloat(grammarEl.value) || 0;
            const oral = parseFloat(oralEl.value) || 0;
            const participacao = parseFloat(participacaoEl.value) || 0;
            const assiduidade = parseFloat(assiduidadeEl.value) || 0;
            
            // Check if any field is empty
            const hasEmptyFields = !midtermEl.value || !listeningEl.value || !grammarEl.value || 
                                 !oralEl.value || !participacaoEl.value || !assiduidadeEl.value;
            
            const total = midterm + listening + grammar + oral + participacao + assiduidade;
            
            document.getElementById(`total-${studentId}`).textContent = total.toFixed(1);
            
            const statusElement = document.getElementById(`status-${studentId}`);
            if (hasEmptyFields) {
                statusElement.textContent = '‚è≥ PENDENTE';
                statusElement.className = 'font-medium text-yellow-600';
            } else if (total >= 70) {
                statusElement.textContent = '‚úì APROVADO';
                statusElement.className = 'font-medium text-green-600';
            } else {
                statusElement.textContent = '‚úó REPROVADO';
                statusElement.className = 'font-medium text-red-600';
            }
        }

        async function saveVipGrades(event) {
            if (event) event.preventDefault();
            console.log('saveVipGrades called');
            
            const vipIdInput = document.getElementById('vip-id');
            if (!vipIdInput) {
                console.error('vip-id input not found');
                showErrorMessage("Erro", "ID do VIP n√£o encontrado.");
                return;
            }
            
            const vipId = vipIdInput.value;
            console.log('Saving grades for VIP:', vipId);
            
            const gradeElements = {
                midtermTest: document.getElementById('midterm-test'),
                listeningTest: document.getElementById('listening-test'),
                grammarTest: document.getElementById('grammar-test'),
                oralTest: document.getElementById('oral-test'),
                participacao: document.getElementById('participacao'),
                assiduidade: document.getElementById('assiduidade')
            };
            
            // Check if all grade elements exist
            const missingElements = Object.keys(gradeElements).filter(key => !gradeElements[key]);
            if (missingElements.length > 0) {
                console.error('Missing grade elements:', missingElements);
                showErrorMessage("Erro", "Alguns campos de nota n√£o foram encontrados.");
                return;
            }
            
            const grades = {
                midtermTest: parseFloat(gradeElements.midtermTest.value) || 0,
                listeningTest: parseFloat(gradeElements.listeningTest.value) || 0,
                grammarTest: parseFloat(gradeElements.grammarTest.value) || 0,
                oralTest: parseFloat(gradeElements.oralTest.value) || 0,
                participacao: parseFloat(gradeElements.participacao.value) || 0,
                assiduidade: parseFloat(gradeElements.assiduidade.value) || 0
            };
            
            console.log('Collected VIP grades:', grades);
            
            try {
                if (!db) {
                    // Local storage mode
                    console.log('Using localStorage mode for VIP');
                    const vipIndex = vips.findIndex(v => v.id === vipId);
                    console.log('Found VIP at index:', vipIndex);
                    if (vipIndex !== -1) {
                        vips[vipIndex].grades = grades;
                        localStorage.setItem('demo-vips', JSON.stringify(vips));
                        console.log('VIP grades saved to localStorage');
                    } else {
                        throw new Error('VIP n√£o encontrado');
                    }
                } else {
                    // Firebase mode
                    console.log('Using Firebase mode for VIP');
                    const docRef = doc(db, `artifacts/${appId}/public/data/vips`, vipId);
                    await updateDoc(docRef, { grades });
                    console.log('VIP grades saved to Firebase');
                    
                    // Log activity
                    const vip = vips.find(v => v.id === vipId);
                    const student = vip ? students.find(s => s.id === vip.studentId) : null;
                    const studentName = student ? student.name : 'VIP Desconhecido';
                    await logActivity('salvar_notas', 'vip', studentName);
                }
                
                document.getElementById('form-modal').classList.remove('visible');
                showSuccessMessage("Sucesso", "Notas salvas com sucesso!");
                console.log('VIP save completed successfully');
                
            } catch (error) {
                console.error('Error saving VIP grades:', error);
                showErrorMessage("Erro", `Erro ao salvar as notas: ${error.message}`);
            }
        }

        async function saveTurmaGrades() {
            console.log('saveTurmaGrades called');
            const turmaIdInput = document.getElementById('turma-id');
            if (!turmaIdInput) {
                console.error('turma-id input not found');
                showErrorMessage("Erro", "ID da turma n√£o encontrado.");
                return;
            }
            
            const turmaId = turmaIdInput.value;
            console.log('Saving grades for turma:', turmaId);
            
            const studentGrades = {};
            
            // Collect all student grades
            const gradeInputs = document.querySelectorAll('.student-grade');
            console.log('Found grade inputs:', gradeInputs.length);
            
            gradeInputs.forEach(input => {
                const studentId = input.dataset.student;
                const fieldType = input.id.split('-')[0];
                const value = parseFloat(input.value) || 0;
                
                console.log(`Processing ${fieldType} for student ${studentId}: ${value}`);
                console.log(`Input ID: ${input.id}, Input value: ${input.value}, Dataset student: ${input.dataset.student}`);
                
                if (!studentGrades[studentId]) {
                    studentGrades[studentId] = {};
                }
                
                if (fieldType === 'participacao' || fieldType === 'assiduidade') {
                    studentGrades[studentId][fieldType] = value;
                    console.log(`Saved ${fieldType} = ${value} for student ${studentId}`);
                } else {
                    studentGrades[studentId][fieldType + 'Test'] = value;
                    console.log(`Saved ${fieldType}Test = ${value} for student ${studentId}`);
                }
            });
            
            console.log('Collected student grades:', studentGrades);
            
            try {
                if (!db) {
                    // Local storage mode
                    console.log('Using localStorage mode');
                    const turmaIndex = turmas.findIndex(t => t.id === turmaId);
                    console.log('Found turma at index:', turmaIndex);
                    if (turmaIndex !== -1) {
                        turmas[turmaIndex].studentGrades = studentGrades;
                        localStorage.setItem('demo-turmas', JSON.stringify(turmas));
                        console.log('Saved to localStorage');
                    } else {
                        throw new Error('Turma n√£o encontrada');
                    }
                } else {
                    // Firebase mode
                    console.log('Using Firebase mode');
                    const docRef = doc(db, `artifacts/${appId}/public/data/turmas`, turmaId);
                    await updateDoc(docRef, { studentGrades });
                    console.log('Saved to Firebase');
                    
                    // Log activity
                    const turma = turmas.find(t => t.id === turmaId);
                    const turmaName = turma ? turma.name : 'Turma Desconhecida';
                    const studentCount = Object.keys(studentGrades).length;
                    await logActivity('salvar_notas', 'turma', turmaName, {
                        quantidadeAlunos: studentCount
                    });
                }
                
                document.getElementById('form-modal').classList.remove('visible');
                showSuccessMessage("Sucesso", "Notas da turma salvas com sucesso!");
                console.log('Save completed successfully');
                
            } catch (error) {
                console.error('Error saving turma grades:', error);
                showErrorMessage("Erro", `Erro ao salvar as notas: ${error.message}`);
            }
        }

        function exportVipReportCard(vipId) {
            const vip = vips.find(v => v.id === vipId);
            if (!vip) { showErrorMessage("Erro", "Aluno VIP n√£o encontrado."); return; }
            const student = students.find(s => s.id === vip.studentId);
            if (!student) { showErrorMessage("Erro", "Dados do aluno n√£o encontrados."); return; }

            // Get current grades from form or stored data
            const grades = vip.grades || {
                midtermTest: 0,
                listeningTest: 0,
                grammarTest: 0,
                oralTest: 0,
                participacao: 0,
                assiduidade: 0
            };

            // Try to get current values from form if open
            const formElements = {
                midtermTest: document.getElementById('midterm-test'),
                listeningTest: document.getElementById('listening-test'),
                grammarTest: document.getElementById('grammar-test'),
                oralTest: document.getElementById('oral-test'),
                participacao: document.getElementById('participacao'),
                assiduidade: document.getElementById('assiduidade')
            };

            // Update grades with current form values if available
            Object.keys(formElements).forEach(key => {
                if (formElements[key]) {
                    grades[key] = parseFloat(formElements[key].value) || 0;
                }
            });

            const total = grades.midtermTest + grades.listeningTest + grades.grammarTest + grades.oralTest + grades.participacao + grades.assiduidade;
            
            // Check if any grade is missing or zero (indicating incomplete assessment)
            const hasIncompleteGrades = grades.midtermTest === 0 || grades.listeningTest === 0 || grades.grammarTest === 0 || 
                                       grades.oralTest === 0 || grades.participacao === 0 || grades.assiduidade === 0;
            
            const status = hasIncompleteGrades ? 'PENDENTE' : (total >= 70 ? 'APROVADO' : 'REPROVADO');
            const teacher = collaborators.find(c => c.id === vip.teacherId);

            const reportHtml = `
                <!DOCTYPE html>
                <html lang="pt-br">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Report Card - ${student.name}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'DM Sans', 'Arial', sans-serif; line-height: 1.5; color: #2d3748; background: #ffffff; }
                        .container { max-width: 800px; margin: 0 auto; background: white; }
                        .header { background: #F1D24B; padding: 40px 40px 30px 40px; position: relative; }
                        .logo-section { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
                        .logo { width: 80px; height: 80px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                        .logo svg { width: 50px; height: 50px; fill: #F1D24B; }
                        .school-info { text-align: left; }
                        .school-name { font-size: 2.2em; font-weight: 700; color: #1a202c; letter-spacing: -0.02em; }
                        .school-subtitle { font-size: 1.1em; color: #4a5568; font-weight: 400; margin-top: 5px; }
                        .report-title { text-align: center; font-size: 1.4em; font-weight: 600; color: #1a202c; margin-top: 25px; letter-spacing: 0.05em; }
                        .content { padding: 40px; }
                        .student-info { border: 2px solid #F1D24B; padding: 25px; margin-bottom: 30px; }
                        .student-info h3 { color: #1a202c; font-size: 1.2em; margin-bottom: 20px; font-weight: 600; }
                        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
                        .info-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
                        .info-label { color: #4a5568; font-weight: 500; }
                        .info-value { color: #1a202c; font-weight: 600; }
                        .grades-section { margin-bottom: 30px; }
                        .grades-section h3 { color: #1a202c; font-size: 1.2em; margin-bottom: 20px; font-weight: 600; }
                        .grades-table { width: 100%; border-collapse: collapse; }
                        .grades-table th { background: #F1D24B; color: #1a202c; font-weight: 600; padding: 15px 12px; text-align: left; font-size: 0.95em; }
                        .grades-table td { padding: 15px 12px; border-bottom: 1px solid #e2e8f0; }
                        .grades-table tr:last-child td { border-bottom: none; }
                        .score { font-weight: 600; color: #1a202c; }
                        .percentage { color: #4a5568; font-size: 0.9em; }
                        .total-section { border: 2px solid #F1D24B; padding: 30px; text-align: center; margin: 30px 0; background: #fffdf0; }
                        .total-label { font-size: 1.1em; color: #4a5568; margin-bottom: 10px; }
                        .total-score { font-size: 3em; font-weight: 700; color: #1a202c; margin-bottom: 15px; }
                        .status { font-size: 1.3em; font-weight: 600; margin-bottom: 15px; }
                        .status.aprovado { color: #38a169; }
                        .status.reprovado { color: #e53e3e; }
                        .status-description { color: #4a5568; font-size: 0.95em; line-height: 1.4; }
                        .footer { border-top: 1px solid #e2e8f0; padding: 30px; text-align: center; color: #4a5568; }
                        .footer-title { font-weight: 600; font-size: 1em; margin-bottom: 5px; }
                        .footer-date { font-size: 0.9em; }
                        .print-btn { background: #F1D24B; color: #1a202c; border: none; padding: 12px 24px; font-weight: 600; cursor: pointer; margin: 20px 0; transition: all 0.2s; }
                        .print-btn:hover { background: #ecc94b; }
                        @media print { .print-btn { display: none; } }
                        .divider { height: 2px; background: #F1D24B; margin: 30px 0; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <div class="logo-section">
                                <div class="logo">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M12 2L13.09 6.26L18 4L15.74 8.74L21 9L16.74 12L21 15L15.74 15.26L18 20L13.09 17.74L12 22L10.91 17.74L6 20L8.26 15.26L3 15L7.26 12L3 9L8.26 8.74L6 4L10.91 6.26L12 2Z"/>
                                    </svg>
                                </div>
                                <div class="school-info">
                                    <div class="school-name">SLAP</div>
                                    <div class="school-subtitle">English School</div>
                                </div>
                            </div>
                            <div class="report-title">STUDENT REPORT CARD</div>
                        </div>
                        
                        <div class="content">
                            <div class="student-info">
                                <h3>Student Information</h3>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <span class="info-label">Name:</span>
                                        <span class="info-value">${student.name}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Course Type:</span>
                                        <span class="info-value">VIP Private Lessons</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Teacher:</span>
                                        <span class="info-value">${teacher?.name || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Level:</span>
                                        <span class="info-value">${vip.level || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Report Date:</span>
                                        <span class="info-value">${new Date().toLocaleDateString('pt-BR')}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="divider"></div>

                            <div class="grades-section">
                                <h3>Assessment Details</h3>
                                <table class="grades-table">
                                    <thead>
                                        <tr>
                                            <th>Assessment</th>
                                            <th>Max Score</th>
                                            <th>Score Obtained</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Midterm Test</td>
                                            <td>20.0</td>
                                            <td class="score">${grades.midtermTest.toFixed(1)}</td>
                                            <td class="percentage">${(grades.midtermTest / 20 * 100).toFixed(1)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Listening Test</td>
                                            <td>20.0</td>
                                            <td class="score">${grades.listeningTest.toFixed(1)}</td>
                                            <td class="percentage">${(grades.listeningTest / 20 * 100).toFixed(1)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Grammar Test</td>
                                            <td>20.0</td>
                                            <td class="score">${grades.grammarTest.toFixed(1)}</td>
                                            <td class="percentage">${(grades.grammarTest / 20 * 100).toFixed(1)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Oral Test</td>
                                            <td>20.0</td>
                                            <td class="score">${grades.oralTest.toFixed(1)}</td>
                                            <td class="percentage">${(grades.oralTest / 20 * 100).toFixed(1)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Class Participation</td>
                                            <td>10.0</td>
                                            <td class="score">${grades.participacao.toFixed(1)}</td>
                                            <td class="percentage">${(grades.participacao / 10 * 100).toFixed(1)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Attendance</td>
                                            <td>10.0</td>
                                            <td class="score">${grades.assiduidade.toFixed(1)}</td>
                                            <td class="percentage">${(grades.assiduidade / 10 * 100).toFixed(1)}%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="total-section">
                                <div class="total-label">Final Score</div>
                                <div class="total-score">${total.toFixed(1)}</div>
                                <div class="status ${status.toLowerCase()}">${status === 'APROVADO' ? 'APPROVED' : 'NOT APPROVED'}</div>
                                <div class="status-description">
                                    ${status === 'APROVADO' ? 
                                        'Congratulations! The student has achieved the minimum score for approval.' : 
                                        'The student has not achieved the minimum score of 70 points required for approval.'}
                                </div>
                            </div>

                            <div style="text-align: center; margin-top: 30px;">
                                <button class="print-btn" onclick="window.print()">Print Report Card</button>
                            </div>
                        </div>

                        <div class="footer">
                            <div class="footer-title">SLAP English School</div>
                            <div class="footer-date">Generated on ${new Date().toLocaleString('pt-BR')}</div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            openHtmlInNewWindow(`Report Card - ${student.name}`, reportHtml);
        }

        function exportStudentReportCardFromTurma(studentId, turmaId) {
            const turma = turmas.find(t => t.id === turmaId);
            const student = students.find(s => s.id === studentId);
            
            if (!turma || !student) {
                showErrorMessage("Erro", "Dados n√£o encontrados.");
                return;
            }

            // Get student grades from turma
            const grades = (turma.studentGrades && turma.studentGrades[studentId]) || {
                midtermTest: 0,
                listeningTest: 0,
                grammarTest: 0,
                oralTest: 0,
                participacao: 0,
                assiduidade: 0
            };

            const total = grades.midtermTest + grades.listeningTest + grades.grammarTest + grades.oralTest + grades.participacao + grades.assiduidade;
            
            // Check if any grade is missing or zero (indicating incomplete assessment)
            const hasIncompleteGrades = grades.midtermTest === 0 || grades.listeningTest === 0 || grades.grammarTest === 0 || 
                                       grades.oralTest === 0 || grades.participacao === 0 || grades.assiduidade === 0;
            
            const status = hasIncompleteGrades ? 'PENDENTE' : (total >= 70 ? 'APROVADO' : 'REPROVADO');

            const reportHtml = `
                <!DOCTYPE html>
                <html lang="pt-br">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Report Card - ${student.name}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'DM Sans', 'Arial', sans-serif; line-height: 1.5; color: #2d3748; background: #ffffff; }
                        .container { max-width: 800px; margin: 0 auto; background: white; }
                        .header { background: #F1D24B; padding: 40px 40px 30px 40px; position: relative; }
                        .logo-section { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
                        .logo { width: 80px; height: 80px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                        .school-info { text-align: left; }
                        .school-name { font-size: 2.2em; font-weight: 700; color: #1a202c; letter-spacing: -0.02em; }
                        .school-subtitle { font-size: 1.1em; color: #4a5568; font-weight: 400; margin-top: 5px; }
                        .report-title { text-align: center; font-size: 1.4em; font-weight: 600; color: #1a202c; margin-top: 25px; letter-spacing: 0.05em; }
                        .content { padding: 40px; }
                        .student-info { border: 2px solid #F1D24B; padding: 25px; margin-bottom: 30px; }
                        .student-info h3 { color: #1a202c; font-size: 1.2em; margin-bottom: 20px; font-weight: 600; }
                        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
                        .info-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
                        .info-label { color: #4a5568; font-weight: 500; }
                        .info-value { color: #1a202c; font-weight: 600; }
                        .grades-section { margin-bottom: 30px; }
                        .grades-section h3 { color: #1a202c; font-size: 1.2em; margin-bottom: 20px; font-weight: 600; }
                        .grades-table { width: 100%; border-collapse: collapse; }
                        .grades-table th { background: #F1D24B; color: #1a202c; font-weight: 600; padding: 15px 12px; text-align: left; font-size: 0.95em; }
                        .grades-table td { padding: 15px 12px; border-bottom: 1px solid #e2e8f0; }
                        .grades-table tr:last-child td { border-bottom: none; }
                        .status-badge { display: inline-block; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px; }
                        .status-aprovado { background: #c6f6d5; color: #276749; }
                        .status-reprovado { background: #fed7d7; color: #c53030; }
                        .status-pendente { background: #fef5e7; color: #b7791f; }
                        .footer { text-align: center; padding: 30px; color: #718096; border-top: 1px solid #e2e8f0; margin-top: 30px; }
                        @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <div class="logo-section">
                                <div class="logo">
                                    <div style="font-size: 2em; font-weight: bold; color: #F1D24B;">S</div>
                                </div>
                                <div class="school-info">
                                    <div class="school-name">SLAP English</div>
                                    <div class="school-subtitle">School of Language and Professional Skills</div>
                                </div>
                            </div>
                            <div class="report-title">BOLETIM INDIVIDUAL</div>
                        </div>
                        
                        <div class="content">
                            <div class="student-info">
                                <h3>Informa√ß√µes do Aluno</h3>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <span class="info-label">Nome:</span>
                                        <span class="info-value">${student.name}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Turma:</span>
                                        <span class="info-value">${turma.name}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Professor:</span>
                                        <span class="info-value">${turma.teacherName}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">N√≠vel:</span>
                                        <span class="info-value">${turma.level}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grades-section">
                                <h3>Avalia√ß√µes</h3>
                                <table class="grades-table">
                                    <thead>
                                        <tr>
                                            <th>Componente</th>
                                            <th>Nota</th>
                                            <th>Peso</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Midterm Test</td>
                                            <td>${grades.midtermTest}</td>
                                            <td>/20</td>
                                        </tr>
                                        <tr>
                                            <td>Listening Test</td>
                                            <td>${grades.listeningTest}</td>
                                            <td>/20</td>
                                        </tr>
                                        <tr>
                                            <td>Grammar Test</td>
                                            <td>${grades.grammarTest}</td>
                                            <td>/20</td>
                                        </tr>
                                        <tr>
                                            <td>Oral Test</td>
                                            <td>${grades.oralTest}</td>
                                            <td>/20</td>
                                        </tr>
                                        <tr>
                                            <td>Participa√ß√£o</td>
                                            <td>${grades.participacao}</td>
                                            <td>/10</td>
                                        </tr>
                                        <tr>
                                            <td>Assiduidade</td>
                                            <td>${grades.assiduidade}</td>
                                            <td>/10</td>
                                        </tr>
                                        <tr style="background: #f7fafc; font-weight: 600;">
                                            <td><strong>TOTAL</strong></td>
                                            <td><strong>${total.toFixed(1)}</strong></td>
                                            <td><strong>/100</strong></td>
                                        </tr>
                                    </tbody>
                                </table>
                                
                                <div style="margin-top: 25px; text-align: center;">
                                    <span class="status-badge status-${status.toLowerCase()}">${status}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="footer">
                            <p>SLAP English - Sistema de Avalia√ß√£o Acad√™mica</p>
                            <p>Relat√≥rio gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</p>
                        </div>
                    </div>
                </body>
                </html>
            `;

            openHtmlInNewWindow(`Report Card - ${student.name}`, reportHtml);
        }

        function exportTurmaReportCard(turmaId) {
            const turma = turmas.find(t => t.id === turmaId);
            if (!turma) { showErrorMessage("Erro", "Turma n√£o encontrada."); return; }

            const turmaStudents = students.filter(s => 
                (turma.studentIds || []).includes(s.id) && s.modalidade === 'TURMA'
            );

            if (turmaStudents.length === 0) {
                showErrorMessage("Erro", "Nenhum aluno encontrado nesta turma.");
                return;
            }

            // Collect current grades from form or stored data
            const studentsWithGrades = turmaStudents.map(student => {
                const storedGrades = (turma.studentGrades && turma.studentGrades[student.id]) || {
                    midtermTest: 0,
                    listeningTest: 0,
                    grammarTest: 0,
                    oralTest: 0,
                    participacao: 0,
                    assiduidade: 0
                };

                // Try to get current values from form if open
                const formElements = {
                    midtermTest: document.getElementById(`midterm-${student.id}`),
                    listeningTest: document.getElementById(`listening-${student.id}`),
                    grammarTest: document.getElementById(`grammar-${student.id}`),
                    oralTest: document.getElementById(`oral-${student.id}`),
                    participacao: document.getElementById(`participacao-${student.id}`),
                    assiduidade: document.getElementById(`assiduidade-${student.id}`)
                };

                const grades = { ...storedGrades };
                Object.keys(formElements).forEach(key => {
                    if (formElements[key]) {
                        grades[key] = parseFloat(formElements[key].value) || 0;
                    }
                });

                const total = grades.midtermTest + grades.listeningTest + grades.grammarTest + grades.oralTest + grades.participacao + grades.assiduidade;
                
                // Check if any grade is missing or zero
                const hasIncompleteGrades = grades.midtermTest === 0 || grades.listeningTest === 0 || grades.grammarTest === 0 || 
                                           grades.oralTest === 0 || grades.participacao === 0 || grades.assiduidade === 0;
                
                const status = hasIncompleteGrades ? 'PENDENTE' : (total >= 70 ? 'APROVADO' : 'REPROVADO');

                return { student, grades, total, status };
            });

            const reportHtml = `
                <!DOCTYPE html>
                <html lang="pt-br">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Report Card - ${turma.name}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'DM Sans', 'Arial', sans-serif; line-height: 1.5; color: #2d3748; background: #ffffff; }
                        .container { max-width: 1200px; margin: 0 auto; background: white; }
                        .header { background: #F1D24B; padding: 40px 40px 30px 40px; position: relative; }
                        .logo-section { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
                        .logo { width: 80px; height: 80px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                        .logo svg { width: 50px; height: 50px; fill: #F1D24B; }
                        .school-info { text-align: left; }
                        .school-name { font-size: 2.2em; font-weight: 700; color: #1a202c; letter-spacing: -0.02em; }
                        .school-subtitle { font-size: 1.1em; color: #4a5568; font-weight: 400; margin-top: 5px; }
                        .report-title { text-align: center; font-size: 1.4em; font-weight: 600; color: #1a202c; margin-top: 25px; letter-spacing: 0.05em; }
                        .content { padding: 40px; }
                        .turma-info { border: 2px solid #F1D24B; padding: 25px; margin-bottom: 30px; }
                        .turma-info h3 { color: #1a202c; font-size: 1.2em; margin-bottom: 20px; font-weight: 600; }
                        .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
                        .info-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
                        .info-label { color: #4a5568; font-weight: 500; }
                        .info-value { color: #1a202c; font-weight: 600; }
                        .grades-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.85em; }
                        .grades-table th { background: #F1D24B; color: #1a202c; font-weight: 600; padding: 12px 8px; text-align: center; }
                        .grades-table td { padding: 12px 8px; text-align: center; border-bottom: 1px solid #e2e8f0; }
                        .grades-table tr:last-child td { border-bottom: none; }
                        .student-name { text-align: left !important; font-weight: 600; color: #1a202c; }
                        .score { font-weight: 600; color: #1a202c; }
                        .total-column { background: #fffdf0 !important; font-weight: 700; color: #1a202c; }
                        .status { font-weight: 600; }
                        .status.aprovado { color: #38a169; }
                        .status.reprovado { color: #e53e3e; }
                        .summary { border: 2px solid #F1D24B; padding: 25px; margin: 30px 0; background: #fffdf0; }
                        .summary h3 { color: #1a202c; font-size: 1.2em; margin-bottom: 20px; font-weight: 600; }
                        .summary-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; text-align: center; }
                        .stat-item { background: white; padding: 20px; border: 1px solid #e2e8f0; }
                        .stat-number { font-size: 2.5em; font-weight: 700; color: #1a202c; margin-bottom: 5px; }
                        .stat-label { color: #4a5568; font-weight: 500; }
                        .footer { border-top: 1px solid #e2e8f0; padding: 30px; text-align: center; color: #4a5568; }
                        .footer-title { font-weight: 600; font-size: 1em; margin-bottom: 5px; }
                        .footer-date { font-size: 0.9em; }
                        .print-btn { background: #F1D24B; color: #1a202c; border: none; padding: 12px 24px; font-weight: 600; cursor: pointer; margin: 20px 0; transition: all 0.2s; }
                        .print-btn:hover { background: #ecc94b; }
                        @media print { .print-btn { display: none; } }
                        .divider { height: 2px; background: #F1D24B; margin: 30px 0; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <div class="logo-section">
                                <div class="logo">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M12 2L13.09 6.26L18 4L15.74 8.74L21 9L16.74 12L21 15L15.74 15.26L18 20L13.09 17.74L12 22L10.91 17.74L6 20L8.26 15.26L3 15L7.26 12L3 9L8.26 8.74L6 4L10.91 6.26L12 2Z"/>
                                    </svg>
                                </div>
                                <div class="school-info">
                                    <div class="school-name">SLAP</div>
                                    <div class="school-subtitle">English School</div>
                                </div>
                            </div>
                            <div class="report-title">CLASS REPORT CARD</div>
                        </div>
                        
                        <div class="content">
                            <div class="turma-info">
                                <h3>Class Information</h3>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <span class="info-label">Class Name:</span>
                                        <span class="info-value">${turma.name}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Teacher:</span>
                                        <span class="info-value">${turma.teacherName}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Level:</span>
                                        <span class="info-value">${turma.level}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Semester:</span>
                                        <span class="info-value">${turma.semestre || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Total Students:</span>
                                        <span class="info-value">${studentsWithGrades.length}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Report Date:</span>
                                        <span class="info-value">${new Date().toLocaleDateString('pt-BR')}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="divider"></div>

                            <div class="grades-section">
                                <h3>Detailed Grades by Student</h3>
                                <table class="grades-table">
                                    <thead>
                                        <tr>
                                            <th>Student</th>
                                            <th>Midterm<br>(0-20)</th>
                                            <th>Listening<br>(0-20)</th>
                                            <th>Grammar<br>(0-20)</th>
                                            <th>Oral<br>(0-20)</th>
                                            <th>Participation<br>(0-10)</th>
                                            <th>Attendance<br>(0-10)</th>
                                            <th>Final Score<br>(0-100)</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${studentsWithGrades.map(({ student, grades, total, status }) => `
                                            <tr>
                                                <td class="student-name">${student.name}</td>
                                                <td class="score">${grades.midtermTest.toFixed(1)}</td>
                                                <td class="score">${grades.listeningTest.toFixed(1)}</td>
                                                <td class="score">${grades.grammarTest.toFixed(1)}</td>
                                                <td class="score">${grades.oralTest.toFixed(1)}</td>
                                                <td class="score">${grades.participacao.toFixed(1)}</td>
                                                <td class="score">${grades.assiduidade.toFixed(1)}</td>
                                                <td class="total-column">${total.toFixed(1)}</td>
                                                <td class="status ${status.toLowerCase()}">${status === 'APROVADO' ? 'APPROVED' : 'NOT APPROVED'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>

                            <div class="summary">
                                <h3>Class Summary</h3>
                                <div class="summary-stats">
                                    <div class="stat-item">
                                        <div class="stat-number">${studentsWithGrades.filter(s => s.status === 'APROVADO').length}</div>
                                        <div class="stat-label">Approved</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number">${studentsWithGrades.filter(s => s.status === 'REPROVADO').length}</div>
                                        <div class="stat-label">Not Approved</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number">${(studentsWithGrades.reduce((sum, s) => sum + s.total, 0) / studentsWithGrades.length).toFixed(1)}</div>
                                        <div class="stat-label">Class Average</div>
                                    </div>
                                    <div class="stat-item">
                                        <div class="stat-number">${((studentsWithGrades.filter(s => s.status === 'APROVADO').length / studentsWithGrades.length) * 100).toFixed(1)}%</div>
                                        <div class="stat-label">Approval Rate</div>
                                    </div>
                                </div>
                            </div>

                            <div style="text-align: center; margin-top: 30px;">
                                <button class="print-btn" onclick="window.print()">Print Report Card</button>
                            </div>
                        </div>

                        <div class="footer">
                            <div class="footer-title">SLAP English School</div>
                            <div class="footer-date">Generated on ${new Date().toLocaleString('pt-BR')}</div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            openHtmlInNewWindow(`Report Card - ${turma.name}`, reportHtml);
        }
        
        function exportIndividualStudentFromTurma(studentId, turmaId) {
            const turma = turmas.find(t => t.id === turmaId);
            const student = students.find(s => s.id === studentId);
            
            if (!turma || !student) {
                showErrorMessage("Erro", "Dados n√£o encontrados.");
                return;
            }
            
            // Get student grades from turma data
            const grades = (turma.studentGrades && turma.studentGrades[studentId]) || {
                midtermTest: 0,
                listeningTest: 0,
                grammarTest: 0,
                oralTest: 0,
                participacao: 0,
                assiduidade: 0
            };
            
            const total = grades.midtermTest + grades.listeningTest + grades.grammarTest + grades.oralTest + grades.participacao + grades.assiduidade;
            
            // Check if any grade is missing or zero
            const hasIncompleteGrades = grades.midtermTest === 0 || grades.listeningTest === 0 || grades.grammarTest === 0 || 
                                       grades.oralTest === 0 || grades.participacao === 0 || grades.assiduidade === 0;
            
            const status = hasIncompleteGrades ? 'PENDENTE' : (total >= 70 ? 'APROVADO' : 'REPROVADO');
            
            const teacher = employees.find(emp => emp.name === turma.teacherName);
            
            const reportHtml = `
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Report Card - ${student.name}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: 'DM Sans', 'Arial', sans-serif; line-height: 1.5; color: #2d3748; background: #ffffff; }
                        .container { max-width: 800px; margin: 0 auto; background: white; }
                        .header { background: #F1D24B; padding: 40px 40px 30px 40px; position: relative; }
                        .logo-section { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
                        .logo { width: 80px; height: 80px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                        .logo svg { width: 50px; height: 50px; fill: #F1D24B; }
                        .school-info { text-align: left; }
                        .school-name { font-size: 2.2em; font-weight: 700; color: #1a202c; letter-spacing: -0.02em; }
                        .school-subtitle { font-size: 1.1em; color: #4a5568; font-weight: 400; margin-top: 5px; }
                        .report-title { text-align: center; font-size: 1.4em; font-weight: 600; color: #1a202c; margin-top: 25px; letter-spacing: 0.05em; }
                        .content { padding: 40px; }
                        .student-info { border: 2px solid #F1D24B; padding: 25px; margin-bottom: 30px; }
                        .student-info h3 { color: #1a202c; font-size: 1.2em; margin-bottom: 20px; font-weight: 600; }
                        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
                        .info-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
                        .info-label { color: #4a5568; font-weight: 500; }
                        .info-value { color: #1a202c; font-weight: 600; }
                        .grades-section { margin-bottom: 30px; }
                        .grades-section h3 { color: #1a202c; font-size: 1.2em; margin-bottom: 20px; font-weight: 600; }
                        .grades-table { width: 100%; border-collapse: collapse; }
                        .grades-table th { background: #F1D24B; color: #1a202c; font-weight: 600; padding: 15px 12px; text-align: left; font-size: 0.95em; }
                        .grades-table td { padding: 15px 12px; border-bottom: 1px solid #e2e8f0; }
                        .grades-table tr:last-child td { border-bottom: none; }
                        .score { font-weight: 600; color: #1a202c; }
                        .percentage { color: #4a5568; font-size: 0.9em; }
                        .total-section { border: 2px solid #F1D24B; padding: 30px; text-align: center; margin: 30px 0; background: #fffdf0; }
                        .total-label { font-size: 1.1em; color: #4a5568; margin-bottom: 10px; }
                        .total-score { font-size: 3em; font-weight: 700; color: #1a202c; margin-bottom: 15px; }
                        .status { font-size: 1.3em; font-weight: 600; margin-bottom: 15px; }
                        .status.aprovado { color: #38a169; }
                        .status.reprovado { color: #e53e3e; }
                        .status-description { color: #4a5568; font-size: 0.95em; line-height: 1.4; }
                        .footer { border-top: 1px solid #e2e8f0; padding: 30px; text-align: center; color: #4a5568; }
                        .footer-title { font-weight: 600; font-size: 1em; margin-bottom: 5px; }
                        .footer-date { font-size: 0.9em; }
                        .print-btn { background: #F1D24B; color: #1a202c; border: none; padding: 12px 24px; font-weight: 600; cursor: pointer; margin: 20px 0; transition: all 0.2s; }
                        .print-btn:hover { background: #ecc94b; }
                        @media print { .print-btn { display: none; } }
                        .divider { height: 2px; background: #F1D24B; margin: 30px 0; }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <div class="logo-section">
                                <div class="logo">
                                    <svg viewBox="0 0 24 24">
                                        <path d="M12 2L13.09 6.26L18 4L15.74 8.74L21 9L16.74 12L21 15L15.74 15.26L18 20L13.09 17.74L12 22L10.91 17.74L6 20L8.26 15.26L3 15L7.26 12L3 9L8.26 8.74L6 4L10.91 6.26L12 2Z"/>
                                    </svg>
                                </div>
                                <div class="school-info">
                                    <div class="school-name">SLAP</div>
                                    <div class="school-subtitle">English School</div>
                                </div>
                            </div>
                            <div class="report-title">STUDENT REPORT CARD</div>
                        </div>
                        
                        <div class="content">
                            <div class="student-info">
                                <h3>Student Information</h3>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <span class="info-label">Name:</span>
                                        <span class="info-value">${student.name}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Course Type:</span>
                                        <span class="info-value">Group Classes</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Class:</span>
                                        <span class="info-value">${turma.name}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Teacher:</span>
                                        <span class="info-value">${teacher?.name || turma.teacherName}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Level:</span>
                                        <span class="info-value">${turma.level || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">Report Date:</span>
                                        <span class="info-value">${new Date().toLocaleDateString('pt-BR')}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="divider"></div>

                            <div class="grades-section">
                                <h3>Assessment Details</h3>
                                <table class="grades-table">
                                    <thead>
                                        <tr>
                                            <th>Assessment</th>
                                            <th>Max Score</th>
                                            <th>Score Obtained</th>
                                            <th>Percentage</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Midterm Test</td>
                                            <td>20.0</td>
                                            <td class="score">${grades.midtermTest.toFixed(1)}</td>
                                            <td class="percentage">${(grades.midtermTest / 20 * 100).toFixed(1)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Listening Test</td>
                                            <td>20.0</td>
                                            <td class="score">${grades.listeningTest.toFixed(1)}</td>
                                            <td class="percentage">${(grades.listeningTest / 20 * 100).toFixed(1)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Grammar Test</td>
                                            <td>20.0</td>
                                            <td class="score">${grades.grammarTest.toFixed(1)}</td>
                                            <td class="percentage">${(grades.grammarTest / 20 * 100).toFixed(1)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Oral Test</td>
                                            <td>20.0</td>
                                            <td class="score">${grades.oralTest.toFixed(1)}</td>
                                            <td class="percentage">${(grades.oralTest / 20 * 100).toFixed(1)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Class Participation</td>
                                            <td>10.0</td>
                                            <td class="score">${grades.participacao.toFixed(1)}</td>
                                            <td class="percentage">${(grades.participacao / 10 * 100).toFixed(1)}%</td>
                                        </tr>
                                        <tr>
                                            <td>Attendance</td>
                                            <td>10.0</td>
                                            <td class="score">${grades.assiduidade.toFixed(1)}</td>
                                            <td class="percentage">${(grades.assiduidade / 10 * 100).toFixed(1)}%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="total-section">
                                <div class="total-label">Final Score</div>
                                <div class="total-score">${total.toFixed(1)}</div>
                                <div class="status ${status.toLowerCase()}">${status === 'APROVADO' ? 'APPROVED' : 'NOT APPROVED'}</div>
                                <div class="status-description">
                                    ${status === 'APROVADO' ? 
                                        'Congratulations! The student has achieved the minimum score for approval.' : 
                                        'The student has not achieved the minimum score of 70 points required for approval.'}
                                </div>
                            </div>

                            <div style="text-align: center; margin-top: 30px;">
                                <button class="print-btn" onclick="window.print()">Print Report Card</button>
                            </div>
                        </div>

                        <div class="footer">
                            <div class="footer-title">SLAP English School</div>
                            <div class="footer-date">Generated on ${new Date().toLocaleString('pt-BR')}</div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            openHtmlInNewWindow(`Report Card - ${student.name}`, reportHtml);
        }

        // Make functions globally accessible
        window.changeMonth = changeMonth;
        window.viewCalendarEvent = viewCalendarEvent;
        window.openCalendarEventForm = openCalendarEventForm;
        window.openGuidelineForm = openGuidelineForm;
        window.saveGuideline = saveGuideline;
        window.changeGuidelinePage = changeGuidelinePage;
        window.exportAlunosDoc = exportAlunosDoc;
        window.exportGuidelinesDoc = exportGuidelinesDoc;
        window.checkTimeConflict = checkTimeConflict;
        window.saveTurmaGrades = saveTurmaGrades;

        window.switchTaskTab = switchTaskTab;
        window.openTaskModal = openTaskModal;
        window.showSection = function(sectionName) {
            const navItem = document.querySelector(`[data-target="${sectionName}"]`);
            if (navItem) navItem.click();
        };


        // --- Fortune Cookie Functions ---
        // Fortune cookie phrases - 60 phrases for daily rotation
        const fortuneCookiePhrases = [
            "O sucesso √© a soma de pequenos esfor√ßos repetidos dia ap√≥s dia.",
            "Acredite em si mesmo e tudo ser√° poss√≠vel.",
            "Cada novo dia √© uma oportunidade de crescer e aprender.",
            "A persist√™ncia √© o caminho do √™xito.",
            "Grandes conquistas exigem grandes sonhos.",
            "O otimismo √© a f√© em a√ß√£o.",
            "Seja a mudan√ßa que voc√™ quer ver no mundo.",
            "O conhecimento √© o √∫nico bem que cresce quando compartilhado.",
            "A educa√ß√£o √© a arma mais poderosa para mudar o mundo.",
            "Ensinar √© tocar vidas para sempre.",
            "A paci√™ncia √© amarga, mas seus frutos s√£o doces.",
            "O futuro pertence √†queles que acreditam na beleza de seus sonhos.",
            "Nunca deixe que ningu√©m diga que voc√™ n√£o pode fazer algo.",
            "A √∫nica forma de fazer um excelente trabalho √© amar o que voc√™ faz.",
            "O imposs√≠vel √© apenas uma opini√£o.",
            "Cada estudante que voc√™ inspira pode mudar o mundo.",
            "A motiva√ß√£o te leva ao in√≠cio, o h√°bito te leva ao fim.",
            "Seja grato pelo que voc√™ tem enquanto trabalha pelo que voc√™ quer.",
            "O fracasso √© apenas o primeiro passo para o sucesso.",
            "Acreditar em si mesmo √© o primeiro segredo do sucesso.",
            "A diferen√ßa entre o poss√≠vel e o imposs√≠vel est√° na determina√ß√£o.",
            "Um professor afeta a eternidade; nunca se sabe onde sua influ√™ncia termina.",
            "A educa√ß√£o n√£o √© prepara√ß√£o para a vida; a educa√ß√£o √© a pr√≥pria vida.",
            "Seja voc√™ mesmo, todos os outros j√° existem.",
            "O que n√£o nos mata, nos fortalece.",
            "A criatividade √© a intelig√™ncia se divertindo.",
            "Grandes mentes discutem ideias, mentes pequenas discutem pessoas.",
            "O aprendizado nunca esgota a mente.",
            "A √∫nica constante na vida √© a mudan√ßa.",
            "Seja a pessoa que voc√™ precisava quando era mais jovem.",
            "O sucesso √© ir de fracasso em fracasso sem perder o entusiasmo.",
            "A educa√ß√£o √© o passaporte para o futuro.",
            "Investir em conhecimento rende sempre os melhores juros.",
            "A mente que se abre a uma nova ideia jamais volta ao tamanho original.",
            "N√£o espere por oportunidades, crie-as.",
            "A coragem n√£o √© a aus√™ncia do medo, mas agir apesar dele.",
            "Cada erro √© uma oportunidade de aprendizado.",
            "O professor med√≠ocre conta, o bom professor explica, o professor superior demonstra, o grande professor inspira.",
            "Seja gentil, pois cada pessoa est√° enfrentando uma batalha dif√≠cil.",
            "A √∫nica competi√ß√£o real √© com a pessoa que voc√™ foi ontem.",
            "Sonhe grande e ouse falhar.",
            "A gratid√£o transforma o que temos em suficiente.",
            "O conhecimento √© poder, mas o conhecimento compartilhado √© poder multiplicado.",
            "Seja curioso, n√£o julgador.",
            "A perfei√ß√£o n√£o existe, mas a excel√™ncia sim.",
            "Cada dia √© uma p√°gina em branco, escreva uma hist√≥ria bonita.",
            "A bondade √© um idioma que os surdos podem ouvir e os cegos podem ver.",
            "O sucesso √© medido n√£o pelo que voc√™ conquista, mas pelo que voc√™ supera.",
            "Seja a luz que voc√™ quer ver no mundo.",
            "A vida recompensa a a√ß√£o, n√£o a inten√ß√£o.",
            "Transforme obst√°culos em oportunidades.",
            "A felicidade n√£o √© destino, √© jornada.",
            "Seja paciente com seu progresso e gentil com seus erros.",
            "A educa√ß√£o √© a chave que abre todas as portas.",
            "Inspire-se para inspirar outros.",
            "O hoje √© resultado das escolhas de ontem, o amanh√£ ser√° resultado das de hoje.",
            "Celebre pequenas vit√≥rias, elas levam a grandes conquistas.",
            "A humildade √© a base de toda verdadeira grandeza.",
            "Seja algu√©m que faz a diferen√ßa na vida dos outros.",
            "O sucesso n√£o √© sobre perfei√ß√£o, √© sobre progresso."
        ];

        // Get daily fortune cookie phrase based on current date
        function getDailyFortune() {
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 86400000);
            const phraseIndex = dayOfYear % fortuneCookiePhrases.length;
            return fortuneCookiePhrases[phraseIndex];
        }



        function renderFortuneCookie() {
            const container = document.getElementById('fortune-cookie-content');
            if (!container) return;

            const dailyFortune = getDailyFortune();
            
            container.innerHTML = `
                <div class="fortune-card">
                    <div class="fortune-cookie-icon mb-3 text-center">
                        <svg class="w-12 h-12 mx-auto text-yellow-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                    </div>
                    <div class="fortune-text">
                        <p class="text-center text-white font-medium leading-relaxed italic text-base">
                            "${dailyFortune}"
                        </p>
                    </div>
                    <div class="fortune-footer mt-3 text-center">
                        <span class="text-xs text-gray-300">
                            Frase do dia ${formatDateBR(new Date())}
                        </span>
                    </div>
                </div>
            `;
        }





        // --- Welcome Message Functions ---
        function extractNameFromEmail(email) {
            if (!email) return 'Usu√°rio';
            const name = email.split('@')[0];
            return name.split('.').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join(' ');
        }

        function updateWelcomeMessages(name) {
            // Wait for DOM to be fully ready
            function tryUpdate() {
                const firstName = (name || '').split(' ')[0];
                const welcomeMsg = document.getElementById('welcome-message');
                if (welcomeMsg) {
                    welcomeMsg.textContent = `Bem-vindo(a), ${firstName}`;
                }
                const headerWelcome = document.getElementById('header-welcome-message');
                if (headerWelcome) {
                    headerWelcome.innerHTML = `
                        <div class="text-sm font-medium">Bem-vindo(a),</div>
                        <div class="text-lg font-bold">${firstName}</div>
                    `;
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', tryUpdate);
            } else {
                tryUpdate();
            }
        }

        // --- Calendar Event Functions ---
        function openCalendarEventForm(eventId = null) {
            const modal = document.getElementById('calendar-event-modal');
            const form = document.getElementById('calendar-event-form');
            const title = document.getElementById('event-modal-title');

            title.textContent = eventId ? 'Editar Evento' : 'Novo Evento';

            if (eventId) {
                const event = calendarEvents.find(e => e.id === eventId);
                if (event) {
                    document.getElementById('event-title').value = event.title;
                    document.getElementById('event-date').value = event.date;
                    document.getElementById('event-time').value = event.time || '';
                    document.getElementById('event-type').value = event.type;
                    document.getElementById('event-description').value = event.description || '';
                    document.getElementById('event-creator').value = event.createdBy || '';
                    
                    const concernCheckboxes = document.querySelectorAll('.concern-checkbox');
                    concernCheckboxes.forEach(cb => {
                        cb.checked = event.concerns && event.concerns.includes(cb.value);
                    });
                }
            } else {
                form.reset();
            }

            modal.classList.add('visible');

            form.onsubmit = (e) => {
                e.preventDefault();
                saveCalendarEvent(eventId);
                modal.classList.remove('visible');
            };
        }

        async function saveCalendarEvent(eventId = null) {
            const title = document.getElementById('event-title').value;
            const date = document.getElementById('event-date').value;
            const time = document.getElementById('event-time').value;
            const type = document.getElementById('event-type').value;
            const description = document.getElementById('event-description').value;
            const createdBy = document.getElementById('event-creator').value;
            const concernsCheckboxes = document.querySelectorAll('.concern-checkbox:checked');
            const concerns = Array.from(concernsCheckboxes).map(cb => cb.value);

            if (!title || !date) {
                showErrorMessage("Erro", "T√≠tulo e data s√£o obrigat√≥rios.");
                return;
            }

            if (!createdBy) {
                showErrorMessage("Erro", "Selecione quem est√° criando o evento.");
                return;
            }

            const eventData = { title, date, time, type, description, createdBy, concerns };

            try {
                if (!db) {
                    // Development mode - save to localStorage
                    let localEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
                    
                    if (eventId) {
                        const eventIndex = localEvents.findIndex(e => e.id === eventId);
                        if (eventIndex !== -1) {
                            localEvents[eventIndex] = { id: eventId, ...eventData };
                        }
                    } else {
                        const newEvent = {
                            id: Date.now().toString(),
                            ...eventData
                        };
                        localEvents.push(newEvent);
                    }
                    
                    localStorage.setItem('calendarEvents', JSON.stringify(localEvents));
                    calendarEvents = localEvents;
                    showSuccessMessage("Sucesso", "Evento salvo com sucesso.");
                } else {
                    // Firebase mode - save to database
                    if (eventId) {
                        await updateDoc(doc(db, `artifacts/${appId}/public/data/calendar-events`, eventId), eventData);
                        
                        // Log activity
                        await logActivity('editar', 'evento_calendario', title, { date, type });
                        
                        showSuccessMessage("Sucesso", "Evento atualizado com sucesso.");
                    } else {
                        eventData.createdAt = serverTimestamp();
                        await addDoc(collection(db, `artifacts/${appId}/public/data/calendar-events`), eventData);
                        
                        // Log activity
                        await logActivity('criar', 'evento_calendario', title, { date, type });
                        
                        showSuccessMessage("Sucesso", "Evento criado com sucesso.");
                    }
                }
                
                closeFormModal();
                renderCalendar();
            } catch (error) {
                console.error("Error saving calendar event:", error);
                showErrorMessage("Erro", "Falha ao salvar o evento. Tente novamente.");
            }
        }

        function viewCalendarEvent(eventId) {
            const event = calendarEvents.find(e => e.id === eventId);
            if (!event) return;

            const timeText = event.time ? `<strong>Hor√°rio:</strong> ${event.time}` : '';
            const descriptionText = event.description ? `<strong>Descri√ß√£o:</strong> ${event.description}` : 'Nenhuma descri√ß√£o dispon√≠vel';
            const typeText = getEventTypeLabel(event.type);
            
            const creator = collaborators.find(c => c.id === event.createdBy);
            const creatorText = creator ? `<strong>Criado por:</strong> ${creator.name}` : '';
            
            let concernsText = '';
            if (event.concerns && event.concerns.length > 0) {
                const concernNames = event.concerns
                    .map(id => collaborators.find(c => c.id === id)?.name)
                    .filter(name => name);
                concernsText = concernNames.length > 0 
                    ? `<strong>Diz respeito a:</strong> ${concernNames.join(', ')}` 
                    : '';
            }

            const modal = document.getElementById('form-modal');
            modal.innerHTML = `
                <div class="modal-content max-w-lg">
                    <div class="modal-header">
                        <h4>Detalhes do Evento</h4>
                        <button class="modal-close-btn" data-action="close-modal">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="p-6 space-y-4">
                        <div>
                            <h3 class="text-xl font-semibold text-stone-800 mb-4">${event.title}</h3>
                        </div>
                        <div class="grid grid-cols-1 gap-3 text-sm">
                            <div><strong>Data:</strong> ${formatDateBR(event.date)}</div>
                            ${timeText ? `<div>${timeText}</div>` : ''}
                            <div><strong>Tipo:</strong> <span class="inline-block px-2 py-1 rounded text-xs bg-${getEventTypeColor(event.type)}-100 text-${getEventTypeColor(event.type)}-700">${typeText}</span></div>
                            ${creatorText ? `<div>${creatorText}</div>` : ''}
                            ${concernsText ? `<div>${concernsText}</div>` : ''}
                            <div class="mt-4">
                                <div>${descriptionText}</div>
                            </div>
                        </div>
                        <div class="flex justify-end gap-2 pt-4 border-t">
                            <button class="danger-btn" data-action="delete-calendar-event" data-id="${event.id}">Excluir</button>
                            <button class="secondary-btn" data-action="edit-calendar-event" data-id="${event.id}">Editar</button>
                            <button class="primary-btn w-auto" data-action="close-modal">Fechar</button>
                        </div>
                    </div>
                </div>
            `;
            modal.classList.add('visible');
        }

        function getEventTypeLabel(type) {
            const types = {
                'evento': 'Evento Geral',
                'gravacao': 'Grava√ß√£o',
                'lembrete': 'Lembrete',
                'aula-extra': 'Aula Extra',
                'data-comemorativa': 'Data Comemorativa',
                'reuniao': 'Reuni√£o'
            };
            return types[type] || type;
        }

        function getEventTypeColor(type) {
            const colors = {
                'evento': 'purple',
                'gravacao': 'green',
                'lembrete': 'yellow',
                'aula-extra': 'red',
                'data-comemorativa': 'blue',
                'reuniao': 'gray'
            };
            return colors[type] || 'gray';
        }

        function renderMenu() {
            const mainNav = document.getElementById('main-navigation');
            const menuItems = [
                { key: 'inicio', label: 'In√≠cio', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>', roles: ['admin', 'pedagogico', 'ap', 'financeiro', 'teacher', 'am'] },
                { key: 'dojo', label: 'Dojo', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>', roles: ['admin', 'pedagogico', 'ap', 'teacher', 'am'] },
                
                { key: 'alunos', label: 'Alunos', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>', roles: ['admin', 'pedagogico', 'ap', 'financeiro', 'am', 'teacher'] },
                { key: 'turmas', label: 'Turmas', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>', roles: ['admin', 'pedagogico', 'ap', 'teacher', 'am', 'financeiro'] },
                { key: 'vips', label: 'VIPs', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 20a6 6 0 0 0-12 0"/><circle cx="12" cy="10" r="4"/><circle cx="12" cy="12" r="10"/></svg>', roles: ['admin', 'pedagogico', 'ap', 'teacher', 'am', 'financeiro'] },
                { key: 'grade', label: 'Grade', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg>', roles: ['admin', 'pedagogico', 'ap', 'teacher', 'am', 'financeiro'] },
                { key: 'calendario', label: 'Calend√°rio', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>', roles: ['admin', 'pedagogico', 'ap', 'teacher', 'am', 'financeiro'] },
                { key: 'links-uteis', label: 'Links √öteis', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>', roles: ['admin', 'pedagogico', 'ap', 'teacher', 'am', 'financeiro'] },
                { key: 'tasks-prazos', label: 'Tasks & Prazos', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 2v4M8 2v4M3 10h18"/><path d="M20 6H4a1 1 0 0 0-1 1v14a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1z"/><path d="m9 16 2 2 4-4"/></svg>', roles: ['admin', 'pedagogico', 'ap', 'teacher', 'am', 'financeiro'] },
                { key: 'gestao-tns', label: 'Gest√£o TNs', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>', roles: ['admin', 'pedagogico', 'ap', 'am'] },
                { key: 'rechamada', label: 'Rechamada', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>', roles: ['admin', 'pedagogico', 'ap', 'am', 'teacher'] },
                
                { key: 'kpis-pedagogico', label: 'KPIs Pedag√≥gico', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/></svg>', roles: ['admin', 'pedagogico', 'ap'] },
                
                { key: 'logs-atividades', label: 'Logs de Atividades', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="12" y1="18" x2="12" y2="12"/><line x1="9" y1="15" x2="15" y2="15"/></svg>', roles: ['admin'] },
                
                { key: 'colaboradores', label: 'Colaboradores', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>', roles: ['admin'] },
                
                { key: 'folha-pagamento', label: 'Financeiro', icon: '<svg class="mr-3" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>', roles: ['admin', 'financeiro'] }
            ];

            const filteredItems = menuItems.filter(item => hasAccessToPage(item.key, currentUserRole));
            
            const menuItemsHTML = filteredItems
                .map(item => `<button data-target="${item.key}" class="nav-item w-full text-left px-4 py-2.5 rounded-lg flex items-center font-semibold">${item.icon}${item.label}</button>`)
                .join('');

            mainNav.innerHTML = menuItemsHTML;
        }








        

        // --- SUBTLE MOUSE CLICK SOUND SYSTEM ---
        let audioContext;
        let clickSoundEnabled = true;

        // Initialize audio context
        function initializeClickSound() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (error) {
                console.log('Web Audio API not supported');
                clickSoundEnabled = false;
            }
        }

        // Generate subtle mouse click sound using Web Audio API
        function playClickSound() {
            if (!clickSoundEnabled || !audioContext) return;

            try {
                // Resume audio context if it's suspended (required for some browsers)
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                // Create a very short, subtle click sound like a mouse click
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                // Connect nodes
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // Configure sound - very short, low volume mouse-like click
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.02);
                
                // Very low volume and very short duration
                gainNode.gain.setValueAtTime(0.03, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.02);

                // Play very short sound (20ms)
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.02);
            } catch (error) {
                console.log('Error playing click sound:', error);
            }
        }

        // Generate error sound - low frequency, descending tone
        function playErrorSound() {
            if (!clickSoundEnabled || !audioContext) return;

            try {
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // Error sound - descending low tone
                oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(200, audioContext.currentTime + 0.3);
                
                gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (error) {
                console.log('Error playing error sound:', error);
            }
        }

        // Generate success sound - ascending tone, pleasant
        function playSuccessSound() {
            if (!clickSoundEnabled || !audioContext) return;

            try {
                if (audioContext.state === 'suspended') {
                    audioContext.resume();
                }

                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                // Success sound - ascending pleasant tone
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(900, audioContext.currentTime + 0.2);
                
                gainNode.gain.setValueAtTime(0.04, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.2);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (error) {
                console.log('Error playing success sound:', error);
            }
        }

        // Add click sound to interactive elements
        function addClickSoundToElement(element) {
            if (element && !element.hasClickSound) {
                element.addEventListener('click', playClickSound);
                element.hasClickSound = true;
            }
        }

        // Add click sounds only to specific button elements (more selective)
        function initializeClickSounds() {
            const selectors = [
                'button:not(input)',  // Buttons but not input buttons
                '.nav-item',          // Navigation items
                '.primary-btn',       // Primary buttons
                '.secondary-btn',     // Secondary buttons
                '.danger-btn'         // Danger buttons
            ];

            selectors.forEach(selector => {
                document.querySelectorAll(selector).forEach(addClickSoundToElement);
            });
        }

        // Observer to add click sounds to dynamically created elements
        function observeNewElements() {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) { // Element node
                            // Check if the added node itself is interactive
                            const selectors = ['button', '.nav-item', '[data-action]', 'input[type="checkbox"]', 'input[type="radio"]', '.clickable', 'a[href]'];
                            selectors.forEach(selector => {
                                if (node.matches && node.matches(selector)) {
                                    addClickSoundToElement(node);
                                }
                                // Also check children
                                node.querySelectorAll && node.querySelectorAll(selector).forEach(addClickSoundToElement);
                            });
                        }
                    });
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }

        // Toggle visibility for all expenses rows
        function toggleAllExpensesVisibility() {
            const button = document.getElementById('toggle-all-expenses-btn');
            const openIcon = button.querySelector('.eye-icon-open');
            const closedIcon = button.querySelector('.eye-icon-closed');
            
            // Check current state (if open icon is visible, we need to hide all)
            const shouldHide = !openIcon.classList.contains('hidden');
            
            // Toggle all expense rows
            document.querySelectorAll('[id^="expense-row-"]').forEach(row => {
                const rowContents = row.querySelectorAll('.row-content');
                const rowButton = row.querySelector('button[onclick*="toggleRowVisibility"]');
                
                if (shouldHide) {
                    // Hide all
                    rowContents.forEach(content => content.classList.add('blurred'));
                    if (rowButton) {
                        rowButton.querySelector('.eye-icon-open')?.classList.add('hidden');
                        rowButton.querySelector('.eye-icon-closed')?.classList.remove('hidden');
                    }
                } else {
                    // Show all
                    rowContents.forEach(content => content.classList.remove('blurred'));
                    if (rowButton) {
                        rowButton.querySelector('.eye-icon-open')?.classList.remove('hidden');
                        rowButton.querySelector('.eye-icon-closed')?.classList.add('hidden');
                    }
                }
            });
            
            // Toggle the header button icons
            if (shouldHide) {
                openIcon.classList.add('hidden');
                closedIcon.classList.remove('hidden');
            } else {
                openIcon.classList.remove('hidden');
                closedIcon.classList.add('hidden');
            }
        }

        // Role-based access control with custom permissions
        function hasAccessToPage(pageKey, userRole) {
            // Admin sempre tem acesso total
            if (userRole === 'admin') return true;
            
            // Verifica√ß√£o especial para Logs de Atividades
            if (pageKey === 'logs-atividades') {
                // Admin sempre tem acesso
                if (userRole === 'admin') return true;
                // Verificar se o colaborador tem permiss√£o espec√≠fica
                return window.currentCollaborator && window.currentCollaborator.canViewLogs === true;
            }
            
            // Usar window.currentCollaborator carregado no login (n√£o buscar no array colaborators)
            if (window.currentCollaborator && window.currentCollaborator.allowedPages && Array.isArray(window.currentCollaborator.allowedPages)) {
                // Se o colaborador tem role admin configurado, acesso total
                if (window.currentCollaborator.role === 'admin') return true;
                
                console.log(`üîç Verificando acesso para p√°gina "${pageKey}":`, {
                    colaborador: window.currentCollaborator.name,
                    paginasPermitidas: window.currentCollaborator.allowedPages,
                    temAcesso: window.currentCollaborator.allowedPages.includes(pageKey)
                });
                
                // Verificar se a p√°gina est√° na lista de permiss√µes customizadas
                return window.currentCollaborator.allowedPages.includes(pageKey);
            }
            
            // Fallback: usar sistema antigo baseado apenas em roles
            const pagePermissions = {
                'inicio': ['admin', 'pedagogico', 'ap', 'financeiro', 'teacher', 'am'], // Dashboard - everyone
                'alunos': ['admin', 'pedagogico', 'ap', 'financeiro', 'am'], // Students - no teacher access
                'turmas': ['admin', 'pedagogico', 'ap', 'teacher', 'am', 'financeiro'], // Classes - no financeiro
                'vips': ['admin', 'pedagogico', 'ap', 'teacher', 'am', 'financeiro'], // VIPs - accessible to teachers
                'grade': ['admin', 'pedagogico', 'ap', 'teacher', 'am', 'financeiro'], // Schedule - no financeiro
                'folha-pagamento': ['admin', 'financeiro'], // Payroll/Expenses - FINANCIAL ONLY
                'colaboradores': ['admin'], // Collaborators - admin only
                'dojo': ['admin', 'pedagogico', 'ap', 'teacher', 'am'], // Dojo - everyone except financeiro
                'calendario': ['admin', 'pedagogico', 'ap', 'teacher', 'am', 'financeiro'], // Shared calendar
                'links-uteis': ['admin', 'pedagogico', 'ap', 'teacher', 'am', 'financeiro'], // Useful links - everyone
                'tasks-prazos': ['admin', 'pedagogico', 'ap', 'teacher', 'am', 'financeiro'], // Tasks & Prazos - everyone
                'gestao-tns': ['admin', 'pedagogico', 'ap', 'am'], // Gest√£o de Testes de N√≠vel
                'rechamada': ['admin', 'pedagogico', 'ap', 'am', 'teacher'], // Rechamada - teachers, admin, pedagogico, ap, am
                'kpis-pedagogico': ['admin', 'pedagogico', 'ap'], // KPIs Pedag√≥gico
                'logs-atividades': ['admin'], // Activity logs - admin only
            };
            
            return pagePermissions[pageKey]?.includes(userRole) || false;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const pageRenderers = { 'inicio': renderInicioSection, 'alunos': renderAlunosSection, 'turmas': renderTurmasSection, 'vips': renderVipsSection, 'grade': renderGradeSection, 'folha-pagamento': renderFolhaPagamentoSection, 'colaboradores': renderColaboradoresSection, 'dojo': renderDojoSection, 'calendario': renderCalendarioSection, 'links-uteis': renderLinksUteisSection, 'tasks-prazos': renderTasksPrazosSection, 'gestao-tns': renderGestaoTNsSection, 'rechamada': renderRechamadaSection, 'kpis-pedagogico': renderKPIsPedagogicoSection, 'logs-atividades': renderLogsAtividadesSection  };

            document.body.addEventListener('click', (event) => {
                // Close modals when clicking overlay or close button
                if (event.target.matches('.modal-overlay') || event.target.matches('[data-action="close-calendar-modal"]')) {
                    document.getElementById('calendar-event-modal').classList.remove('visible');
                }
                if (event.target.matches('.modal-overlay') || event.target.matches('[data-action="close-guideline-modal"]')) {
                    document.getElementById('guideline-modal').classList.remove('visible');
                }
                if (event.target.matches('.modal-overlay') || event.target.matches('[data-action="close-highlight-modal"]')) {
                    document.getElementById('monthly-highlight-modal').classList.remove('visible');
                }
                if (event.target.matches('.modal-overlay') || event.target.matches('[data-action="close-fluxo-modal"]')) {
                    const fluxoModal = document.getElementById('fluxo-modal');
                    if (fluxoModal) fluxoModal.classList.remove('visible');
                }

                const navTarget = event.target.closest('.nav-item');
                if (navTarget && !navTarget.disabled && !event.target.closest('[data-action]')) {
                    const pageKey = navTarget.dataset.target;
                    
                    if (pageKey && pageRenderers[pageKey]) {
                        // CRITICAL SECURITY: Check role-based access before allowing navigation
                        if (!hasAccessToPage(pageKey, currentUserRole)) {
                            console.warn(`Access denied: User role '${currentUserRole}' cannot access page '${pageKey}'`);
                            showErrorMessage("Acesso Negado", `Voc√™ n√£o tem permiss√£o para acessar esta se√ß√£o.`);
                            return;
                        }
                        
                        // Clear any existing timeouts or intervals that might interfere
                        clearTimeout(window.navigationTimeout);
                        
                        // Reset pagination and render the new section
                        resetPagination();
                        pageRenderers[pageKey]();
                        setActiveNavItem(navTarget);
                        
                        // Prevent any further event bubbling
                        event.stopPropagation();
                        event.preventDefault();
                    }
                }

                const actionTarget = event.target.closest('[data-action]');
                if (actionTarget) {
                    // Prevent navigation interference with action buttons
                    event.stopPropagation();
                    
                    if(actionTarget.closest('.modal-content') && !['close-modal', 'export-vip-pef', 'export-turma-pef'].includes(actionTarget.dataset.action)) event.stopPropagation();

                    const { action, id, collection, nivelId, aulaIndex, direction, unitId, lessonNumber, status } = actionTarget.dataset;
                    console.log('Action triggered:', action, 'ID:', id);
                    const actionHandlers = {
                        'open-signup': openSignUpModal,
                        'add-aluno': () => openAlunoForm(),
                        'view-aluno': () => openAlunoModal(id),
                        'edit-aluno': () => openAlunoForm(id),
                        'add-turma': () => openTurmaForm(),
                        'open-turma-pef': () => openTurmaPefModal(id),
                        'edit-turma': () => openTurmaForm(id),

                        'add-vip': () => openVipForm(),
                        'edit-vip': () => openVipForm(id),
                        'open-vip-pef': () => openVipPefModal(id),
                        'open-vip-notas': () => openVipNotasModal(id),
                        'open-turma-notas': () => openTurmaNotasModal(id),
                        'mark-attendance': () => {
                            const button = actionTarget;
                            const group = button.closest('.pef-status-btn-group');
                            if (!group) return;

                            if (button.classList.contains('active')) {
                                button.classList.remove('active', 'P', 'F', 'PP');
                            } else {
                                group.querySelectorAll('button').forEach(btn => btn.classList.remove('active', 'P', 'F', 'PP'));
                                button.classList.add('active', status);
                            }
                        },
                        'save-pef-lesson': () => savePefLesson(unitId, lessonNumber),
                        'save-all-pef-lessons': () => {
                            console.log("save-all-pef-lessons handler triggered");
                            console.log("actionTarget:", actionTarget);
                            const unitId = actionTarget.getAttribute('data-unit-id');
                            const pefType = actionTarget.getAttribute('data-pef-type');
                            console.log("unitId:", unitId, "pefType:", pefType);
                            saveAllPefLessons(unitId, pefType);
                        },
                        'add-campanha': () => {
                            console.log('add-campanha action triggered');
                            openCampanhaForm();
                        },
                        'view-campanha': () => openCampanhaModal(id),
                        'edit-campanha': () => openCampanhaForm(id),


                        // Fluxo modal handler removed
                        'add-passo': () => addPasso(),
                        'add-documento': () => addDocumento(),
                        'remove-passo': () => {
                            event.target.closest('.flex.items-center.space-x-2').remove();
                            updatePassoNumbers();
                        },
                        'remove-documento': () => {
                            event.target.closest('.flex.items-center.space-x-2').remove();
                        },

                        'add-collaborator': () => openCollaboratorForm(),
                        'edit-collaborator': () => openCollaboratorForm(id),
                        'edit-monthly-highlight': openMonthlyHighlightForm,


                        'add-schedule': openScheduleForm,
                        'view-schedule': () => openScheduleForm(id),
                        'add-expense': openExpenseForm,
                        'view-expense': () => openExpenseForm(id),

                        'delete-item': () => safeDeleteItem(collection, id),
                        'close-modal': closeFormModal,


                        'add-dojo-competitor': () => openDojoCompetitorForm(),
                        'edit-dojo-points': () => openDojoPointsForm(id),
                        'edit-dojo-competitor': () => openDojoCompetitorForm(id),
                        'add-dojo-mission': openDojoMissionForm,
                        'export-alunos-doc': exportAlunosDoc,
                        'export-vip-pef': () => exportVipPef(id),
                        'export-turma-pef': () => exportTurmaPef(id),
                        'export-student-pef': () => {
                            const turmaId = actionTarget.dataset.turmaId;
                            const studentId = actionTarget.dataset.studentId;
                            exportStudentPef(turmaId, studentId);
                        },
                        'export-tasks-pdf': () => exportTasksPdf(id),
                        'export-student-report-card': () => {
                            const turmaId = actionTarget.dataset.turmaId;
                            const studentId = actionTarget.dataset.studentId;
                            exportStudentReportCardFromTurma(studentId, turmaId);
                        },

                        'add-calendar-event': openCalendarEventForm,
                        'view-calendar-event': () => viewCalendarEvent(id),
                        'edit-calendar-event': () => openCalendarEventForm(id),
                        'edit-fixed-card': () => {
                            const cardId = actionTarget.dataset.cardId;
                            openFixedDateCardModal(cardId);
                        },
                        'close-fixed-date-modal': closeFixedDateModal,
                        'close-calendar-modal': () => {
                            const modal = document.getElementById('calendar-event-modal');
                            if (modal) modal.classList.remove('visible');
                        },
                        'add-tn': () => openTNModal(),
                        'add-guideline': openGuidelineForm,
                        'export-guidelines': exportGuidelinesDoc,
                        'edit-monthly-highlight': openMonthlyHighlightForm,
                        'delete-calendar-event': () => {
                            if (id) {
                                deleteCalendarEvent(id);
                            } else {
                                console.error('Event ID not found for deletion');
                                showErrorMessage("Erro", "ID do evento n√£o encontrado.");
                            }
                        },
                        'delete-vip': () => deleteVip(id),
                        'delete-all-vips': deleteAllVips,

                        'debug-sync-status': debugSyncStatus,
                        
                        // Handlers para turmas/VIPs finalizados
                        'turma-finalizada': () => showErrorMessage("Turma Finalizada", "Esta turma est√° finalizada. Reative a turma para poder edit√°-la ou registrar presen√ßas."),
                        'vip-finalizado': () => showErrorMessage("VIP Finalizado", "Este VIP est√° finalizado. Reative o VIP para poder edit√°-lo ou registrar presen√ßas."),
                        'reativar-turma': () => reativarTurma(id),
                        'reativar-vip': () => reativarVip(id),
                        
                        // Handlers para rechamada
                        'fazer-rechamada': () => {
                            const studentId = actionTarget.dataset.studentId;
                            const studentName = actionTarget.dataset.studentName;
                            const teacherName = actionTarget.dataset.teacherName;
                            const lessons = actionTarget.dataset.lessons;
                            const firstDate = actionTarget.dataset.firstDate;
                            const secondDate = actionTarget.dataset.secondDate;
                            openRechamadaModal(studentId, studentName, teacherName, lessons, firstDate, secondDate);
                        },
                        'ver-detalhes-rechamada': () => {
                            const rechamadaId = actionTarget.dataset.rechamadaId;
                            viewRechamadaDetails(rechamadaId);
                        },
                        'editar-rechamada': () => {
                            const studentId = actionTarget.dataset.studentId;
                            const studentName = actionTarget.dataset.studentName;
                            const rechamadaId = actionTarget.dataset.rechamadaId;
                            editRechamada(studentId, studentName, rechamadaId);
                        },
                    };
                    if (actionHandlers[action]) {
                        console.log('Executing action:', action);
                        actionHandlers[action]();
                    } else {
                        console.warn('No handler found for action:', action);
                    }
                }

                 if(event.target.matches('input[type="checkbox"][data-action="toggle-expense"]')) {
                    const expenseId = event.target.dataset.id;
                    const isPaid = event.target.checked;
                    toggleExpensePaid(expenseId, isPaid);
                }
            });

            document.getElementById('logout-button').addEventListener('click', handleLogout);
            document.getElementById('pending-logout').addEventListener('click', handleLogout);
            
            // Always load dashboard on startup - FORCE INICIO SECTION
            window.navigationTimeout = setTimeout(() => {
                // Force dashboard render regardless of other listeners
                renderInicioSection(); 
                setActiveNavItem(document.querySelector('[data-target="inicio"]'));
                console.log('Dashboard forced to load on startup');
            }, 200);
            
            // Initialize click sound system
            initializeClickSound();
            initializeClickSounds();
            observeNewElements();
            
            initializeFirebase();
        });
    </script>
</body>
</html>
